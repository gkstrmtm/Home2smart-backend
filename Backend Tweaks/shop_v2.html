<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Smart Home Packages â€¢ Home2Smart</title>
<meta name="description" content="TV mounting and security camera packages. Pick a package, we handle the rest. Done right, done once.">
<meta name="theme-color" content="#0a2a5a">

<!-- Performance -->
<link rel="preconnect" href="https://h2s-backend-5o9147lik-tabari-ropers-projects-6f2e090b.vercel.app">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://connect.facebook.net">
<link rel="preconnect" href="https://script.google.com">
<link rel="dns-prefetch" href="https://js.stripe.com">
<link rel="prefetch" href="https://h2s-backend-5o9147lik-tabari-ropers-projects-6f2e090b.vercel.app/api/shop?action=catalog" as="fetch" crossorigin>
<link rel="prefetch" href="https://h2s-backend-5o9147lik-tabari-ropers-projects-6f2e090b.vercel.app/api/reviews?limit=5" as="fetch" crossorigin>
<link rel="prefetch" href="https://h2s-backend-5o9147lik-tabari-ropers-projects-6f2e090b.vercel.app/api/stats" as="fetch" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;800;900&display=swap" rel="stylesheet">

<style>
@font-face {
  font-family: 'Archivo-fallback';
  src: local('Arial');
  size-adjust: 105%;
  ascent-override: 95%;
  descent-override: 25%;
}
</style>

<!-- Security -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://connect.facebook.net https://script.google.com https://js.stripe.com https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' https: data:; connect-src 'self' https://script.google.com https://script.googleusercontent.com https://*.google.com https://connect.facebook.net https://www.facebook.com https://api.stripe.com https://h2s-backend-5o9147lik-tabari-ropers-projects-6f2e090b.vercel.app;">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="referrer" content="strict-origin-when-cross-origin">

<style>
/* === CRITICAL CSS (INLINE) === */
:root {
  --cobalt: #0a2a5a;
  --azure: #1493ff;
  --ink: #0b1420;
  --bg: #ffffff;
  --border: #e1e6ed;
  --muted: #6b778c;
  --shadow-sm: 0 2px 8px rgba(11,20,32,.06);
  --shadow-md: 0 4px 16px rgba(11,20,32,.08);
  --shadow-lg: 0 8px 24px rgba(11,20,32,.12);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  scroll-behavior: smooth;
  background: var(--cobalt); /* Prevent white flash / overscroll raw area */
  overscroll-behavior-y: none; /* Clamp bounce */
}

body {
  font-family: Archivo, 'Archivo-fallback', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--bg);
  color: var(--ink);
  line-height: 1.6;
  overflow-x: hidden;
  margin: 0;
  padding: 0;
  min-height: 100vh;
}

#pageShell {
  background: #fff;
  min-height: 100vh;
  position: relative;
}

/* === URGENCY BANNER === */
.urgency-banner {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  /* Raised so it's always tappable above header and most overlays */
  z-index: 1200;
  background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
  color: #fff;
  padding: 10px 16px;
  text-align: center;
  font-size: 14px;
  font-weight: 600;
  line-height: 1.3;
  box-shadow: none; /* Remove shadow to sit flush with header */
  border-bottom: 1px solid rgba(0,0,0,.1); /* Subtle divider */
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transform: translateY(-100%);
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  height: 44px; /* Fixed height for consistent spacing */
}

.urgency-banner.visible {
  transform: translateY(0);
}

.urgency-banner.dismissed {
  display: none;
}

.urgency-text {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
}

.urgency-text strong {
  font-weight: 800;
}

.urgency-separator {
  opacity: 0.6;
}

.urgency-close {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255,255,255,.2);
  border: none;
  color: #fff;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  line-height: 1;
  transition: background 0.2s ease, transform 0.12s ease;
  padding: 0;
  z-index: 1201; /* ensure the close control is reachable */
}

.urgency-close:hover {
  background: rgba(255,255,255,.3);
}

@media (max-width: 768px) {
  .urgency-banner {
    padding: 8px 44px 8px 16px;
    font-size: 13px;
  }
  
  .urgency-text {
    gap: 8px;
  }
  
  .urgency-close {
    width: 32px;
    height: 32px;
    right: 8px;
    font-size: 20px;
    background: rgba(255,255,255,.25);
    z-index: 1201;
  }
  
  .urgency-close:active {
    background: rgba(255,255,255,.4);
    transform: translateY(-50%) scale(0.95);
  }

  /* Mobile form improvements */
  .form {
    margin: 40px 16px;
    padding: 24px;
    max-width: 100%;
  }

  .form h2 {
    font-size: 24px;
  }

  .inp {
    font-size: 16px; /* Prevents iOS zoom */
  }

  .btn {
    min-height: 48px; /* Better touch targets */
  }

  .link-btn {
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
}


/* === HEADER (FULL BLEED) === */
.header {
  position: fixed; /* Clamp header */
  inset: 0 0 auto 0;
  height: 56px;
  z-index: 200;
  background: var(--cobalt);
  border-bottom: 1px solid rgba(255,255,255,.12);
  box-shadow: var(--shadow-md);
  width: 100%;
  will-change: transform;
  transition: top 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  top: 0; /* Default position when no banner */
}

.header.with-banner {
  top: 44px; /* Push down exactly by banner height - no gap */
}

.header-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 56px;
  padding: 0 16px;
  max-width: 1400px;
  margin: 0 auto;
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
  color: #fff;
  font-weight: 900;
  font-size: 18px;
  letter-spacing: -0.02em;
}

.logo-img {
  width: 36px;
  height: 36px;
  display: block;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.menu-btn,
.cart-btn,
#accountBtn {
  appearance: none;
  border: none;
  background: transparent;
  color: #fff;
  cursor: pointer;
  padding: 8px;
  border-radius: 6px;
  transition: background 0.15s ease;
  position: relative;
}

.menu-btn:hover,
.cart-btn:hover,
#accountBtn:hover {
  background: rgba(255,255,255,.1);
}

.menu-btn:focus-visible,
.cart-btn:focus-visible,
#accountBtn:focus-visible {
  outline: 2px solid rgba(255,255,255,.4);
  outline-offset: 2px;
}

.icon {
  width: 24px;
  height: 24px;
  stroke: currentColor;
  stroke-width: 2;
  fill: none;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.cart-badge {
  position: absolute;
  top: 4px;
  right: 4px;
  background: var(--azure);
  color: var(--cobalt);
  font-size: 11px;
  font-weight: 900;
  padding: 2px 5px;
  border-radius: 10px;
  line-height: 1;
  min-width: 18px;
  text-align: center;
}

/* === HERO === */
.hero {
  background-color: var(--cobalt);
  background-image: linear-gradient(160deg, var(--cobalt) 0%, #0b1420 100%);
  color: #fff;
  padding: 72px 16px 56px;
  text-align: center;
  position: relative;
  width: 100vw;
  margin-left: calc(50% - 50vw);
  margin-right: calc(50% - 50vw);
  box-sizing: border-box;
  transition: padding-top 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.hero.with-banner {
  padding-top: 116px; /* 72px + 44px banner height */
}

.hero-inner {
  max-width: 640px;
  margin: 0 auto;
}

.hero h1 {
  font-size: 32px;
  font-weight: 900;
  line-height: 1.1;
  letter-spacing: -0.03em;
  margin-bottom: 12px;
}

.hero p {
  font-size: 17px;
  opacity: 1; /* Remove faded look on initial paint */
  margin-bottom: 28px;
  line-height: 1.5;
}

.hero-ctas {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  max-width: 480px;
  margin: 0 auto 24px;
}

/* Ghost buttons on hero (dark background) need light styling */
.hero .btn-ghost {
  background: transparent;
  color: #fff;
  border: 2px solid rgba(255,255,255,0.5);
  font-weight: 600;
}

.hero .btn-ghost:hover {
  background: rgba(255,255,255,0.15);
  border-color: #fff;
  color: #fff;
  box-shadow: 0 2px 12px rgba(255,255,255,0.2);
}

.hero .btn-ghost:active {
  background: rgba(255,255,255,0.25);
}

/* === HERO REVIEW CAROUSEL === */
.hero-reviews {
  max-width: 500px;
  margin: 0 auto;
  padding: 16px 20px;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(12px);
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(10,42,90,0.12);
  border: 1px solid rgba(255,255,255,0.6);
  position: relative;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.2s ease;
}

.hero-reviews:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(10,42,90,0.18);
  border-color: rgba(20,147,255,0.3);
}

.hero-review-slide {
  display: none;
  animation: hero-review-fade 0.5s ease;
}

.hero-review-slide.active {
  display: block;
}

@keyframes hero-review-fade {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.hero-review-stars {
  display: flex;
  gap: 4px;
  justify-content: center;
  margin-bottom: 8px;
  font-size: 16px;
  color: #fbbf24;
}

.hero-review-text {
  font-size: 14px;
  line-height: 1.5;
  color: var(--ink);
  text-align: center;
  margin-bottom: 8px;
  font-style: italic;
  
  /* Clamp to 2 lines with ellipsis */
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  min-height: 42px; /* 14px * 1.5 * 2 lines = prevent layout shift */
  max-height: 42px;
}

.hero-review-text:empty {
  display: none; /* Hide if no text */
}

.hero-review-author {
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  text-align: center;
}

.hero-review-dots {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-top: 12px;
  padding-bottom: 4px;
}

.hero-review-dots::after {
  content: 'See all reviews â†’';
  position: absolute;
  bottom: 4px;
  right: 12px;
  font-size: 10px;
  color: var(--azure);
  font-weight: 600;
  opacity: 0;
  transition: opacity 0.2s ease;
  pointer-events: none;
}

.hero-reviews:hover .hero-review-dots::after {
  opacity: 0.7;
}

.hero-review-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--border);
  cursor: pointer;
  transition: all 0.3s ease;
}

.hero-review-dot.active {
  background: var(--azure);
  width: 20px;
  border-radius: 3px;
}

/* === BUTTONS === */
.btn {
  appearance: none;
  border: none;
  background: var(--azure);
  color: var(--cobalt);
  font-family: inherit;
  font-size: 16px;
  font-weight: 800;
  padding: 14px 20px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.18s cubic-bezier(0.4, 0, 0.2, 1);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  line-height: 1;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(20,147,255,.25);
}

.btn:active {
  transform: translateY(0);
}

.btn:focus-visible {
  outline: 3px solid rgba(20,147,255,.3);
  outline-offset: 2px;
}

.btn-ghost {
  background: transparent;
  color: var(--cobalt);
  border: 2px solid var(--azure);
  font-weight: 600;
}

.btn-ghost:hover {
  background: var(--azure);
  color: #fff;
  border-color: var(--azure);
  box-shadow: 0 2px 8px rgba(20,147,255,0.2);
}

.btn-ghost:active {
  background: #0c7fd9;
}

.btn-primary {
  background: var(--azure);
  color: #fff;
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(20,147,255,0.25);
  transition: all 0.2s ease;
}

.btn-primary:hover {
  background: #0c7fd9;
  box-shadow: 0 4px 12px rgba(20,147,255,0.35);
  transform: translateY(-1px);
}

.btn-primary:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(20,147,255,0.3);
}

.btn-secondary {
  background: var(--cobalt);
  color: #fff;
}

.btn-subtle {
  background: transparent;
  color: var(--muted);
  border: 1px solid var(--border);
  font-weight: 700;
  font-size: 14px;
  padding: 10px 16px;
}

.btn-subtle:hover {
  background: #f5f7fa;
  color: var(--cobalt);
  box-shadow: none;
}

/* === SECTION === */
.section {
  padding: 64px 16px;
  max-width: 1200px;
  margin: 0 auto;
  content-visibility: auto;
  contain-intrinsic-size: auto 500px;
  background: #fff;
  position: relative;
}

.section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 32px;
  background: linear-gradient(180deg, #f8f9fb 0%, transparent 100%);
  pointer-events: none;
}

.section-header {
  text-align: center;
  margin-bottom: 40px;
}

.section-header h2 {
  font-size: 28px;
  font-weight: 900;
  color: var(--cobalt);
  margin-bottom: 8px;
  letter-spacing: -0.02em;
}

.section-header p {
  font-size: 16px;
  color: var(--muted);
  max-width: 560px;
  margin: 0 auto;
}

/* === TRUST BAR === */
.trust-bar {
  background-color: var(--cobalt);
  background-image: linear-gradient(135deg, var(--cobalt) 0%, #0d3568 100%);
  padding: 24px 16px;
  position: relative;
  width: 100vw;
  margin-left: calc(50% - 50vw);
  margin-right: calc(50% - 50vw);
  box-sizing: border-box;
}

.trust-bar::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, rgba(20, 147, 255, 0.3) 50%, transparent 100%);
}

.trust-bar::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, rgba(20, 147, 255, 0.3) 50%, transparent 100%);
}

.trust-inner {
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}

@media (min-width: 768px) {
  .trust-inner {
    grid-template-columns: repeat(4, 1fr);
  }
}

.trust-item {
  text-align: center;
  color: #fff;
}

.trust-item strong {
  display: block;
  font-size: 24px;
  font-weight: 900;
  margin-bottom: 4px;
  color: var(--azure);
  letter-spacing: -0.02em;
}

.trust-item span {
  font-size: 13px;
  opacity: 0.9;
  font-weight: 500;
}

/* === REVIEW CAROUSEL === */
.review-carousel {
  position: relative;
  overflow: hidden;
  padding: 96px 0 104px; /* Increased vertical padding for breathability */
  background-color: #fafbfc;
  background-image: linear-gradient(180deg, #fafbfc 0%, #f5f7fa 50%, #ffffff 100%);
}

/* Track container to handle overflow properly */
.review-track-container {
  overflow: hidden;
  max-width: 1280px; /* Slightly wider to let cards breathe */
  margin: 0 auto;
  padding: 0 24px; /* Balanced outer padding */
}

/* Softer, subtle top fade instead of hard line */
.review-carousel::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 64px;
  background: linear-gradient(180deg, rgba(248, 249, 251, 1) 0%, rgba(248, 249, 251, 0) 100%);
  pointer-events: none;
  z-index: 10;
}

/* Softer bottom fade */
.review-carousel::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 64px;
  background: linear-gradient(0deg, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0) 100%);
  pointer-events: none;
  z-index: 10;
}

.review-carousel-header {
  text-align: center;
  margin-bottom: 56px; /* More space between header and cards */
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  padding: 0 16px;
  position: relative;
  z-index: 20;
}

.review-carousel-header h2 {
  font-size: 36px; /* Larger headline */
  font-weight: 900;
  color: var(--cobalt);
  margin-bottom: 16px;
  letter-spacing: -0.03em;
}

.review-carousel-header p {
  font-size: 18px;
  color: var(--muted);
  line-height: 1.6;
}

.review-track {
  display: flex;
  transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); /* Smoother ease-out */
  gap: 0;
  will-change: transform;
  width: 100%;
  padding-bottom: 40px; /* Space for shadows */
}

.review-card {
  flex: 0 0 calc(100% - 24px); /* Mobile: 1 card */
  background: #fff;
  border-radius: 24px; /* Softer corners */
  padding: 32px;
  box-shadow: 0 4px 20px rgba(10, 42, 90, 0.06); /* Cleaner shadow */
  border: 1px solid rgba(10, 42, 90, 0.06);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  display: flex;
  flex-direction: column;
  margin: 0 12px; /* 24px gap total */
  height: auto; /* Allow stretch */
  position: relative;
}

.review-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 32px rgba(10, 42, 90, 0.12);
  border-color: rgba(20, 147, 255, 0.3);
}

@media (min-width: 768px) {
  .review-card {
    flex: 0 0 calc(50% - 24px); /* Tablet: 2 cards */
  }
}

@media (min-width: 1024px) {
  .review-card {
    flex: 0 0 calc(33.333% - 24px); /* Desktop: 3 cards */
  }
}

.review-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.review-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--azure), var(--cobalt));
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-weight: 700;
  font-size: 18px;
}

.review-meta {
  flex: 1;
}

.review-name {
  font-weight: 700;
  color: var(--cobalt);
  margin-bottom: 2px;
  font-size: 15px;
}

.review-stars {
  color: #fbbf24;
  font-size: 14px;
  letter-spacing: 2px;
}

.review-time {
  font-size: 12px;
  color: #9ca3af;
  margin-top: 2px;
  font-weight: 500;
}

.review-text {
  color: #4b5563;
  line-height: 1.65;
  font-size: 15px;
  margin-bottom: 16px;
  flex-grow: 1;
  max-height: none; /* Allow natural height */
  position: relative;
}

/* Quote marks for authenticity */
.review-text::before {
  content: '"';
  position: absolute;
  top: -8px;
  left: -12px;
  font-size: 48px;
  font-weight: 900;
  color: rgba(20, 147, 255, 0.1);
  line-height: 1;
  font-family: Georgia, serif;
}

.review-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-top: auto;
  padding-top: 16px;
  border-top: 1px solid rgba(10, 42, 90, 0.06);
}

.review-service {
  font-size: 13px;
  color: var(--azure);
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.review-service::before {
  content: 'â†’';
  font-weight: 900;
}

.review-verified {
  font-size: 11px;
  color: #10b981;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: rgba(16, 185, 129, 0.08);
  padding: 4px 8px;
  border-radius: 6px;
  white-space: nowrap;
}

.review-verified::before {
  content: 'âœ“';
  font-size: 13px;
  font-weight: 900;
}

.review-nav {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 24px;
}

.review-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #d1d5db;
  cursor: pointer;
  transition: all 0.3s ease;
}

.review-dot.active {
  background: var(--azure);
  width: 24px;
  border-radius: 4px;
}

/* === PACKAGE GRID === */
.package-grid {
  display: grid;
  gap: 16px;
  grid-template-columns: 1fr;
}

@media (min-width: 640px) {
  .package-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 1024px) {
  .package-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

/* === PACKAGE CARD === */
.package {
  background: #fff;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 24px 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  transition: all 0.2s ease;
  position: relative;
}

.package:hover {
  border-color: var(--azure);
  box-shadow: var(--shadow-lg);
  transform: translateY(-2px);
}

.package.featured {
  border-color: var(--azure);
  border-width: 2px;
  box-shadow: var(--shadow-md);
}

.package.featured::before {
  content: 'Recommended';
  position: absolute;
  top: -10px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--azure);
  color: var(--cobalt);
  font-size: 11px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  padding: 4px 12px;
  border-radius: 12px;
}

.package-header {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.package-name {
  font-size: 19px;
  font-weight: 900;
  color: var(--cobalt);
  line-height: 1.2;
}

.package-price {
  font-size: 15px;
  font-weight: 800;
  color: var(--azure);
}

.package-promise {
  font-size: 14px;
  color: var(--ink);
  opacity: 0.88;
  line-height: 1.5;
  flex-grow: 1;
}

.package-includes {
  background: #f8f9fb;
  border-radius: 8px;
  padding: 12px;
  font-size: 13px;
  line-height: 1.5;
  color: var(--cobalt);
}

.package-includes strong {
  display: block;
  font-weight: 800;
  margin-bottom: 6px;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  opacity: 0.7;
}

.package-includes ul {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.package-includes li::before {
  content: 'âœ“';
  color: var(--azure);
  font-weight: 900;
  margin-right: 6px;
}

.package .btn {
  width: 100%;
}

/* === MENU DRAWER === */
.menu-drawer {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  width: min(320px, 85vw);
  background: #fff;
  z-index: 200;
  transform: translateX(-100%);
  transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 4px 0 16px rgba(0,0,0,.1);
  display: flex;
  flex-direction: column;
}

.menu-drawer.open {
  transform: translateX(0);
}

.menu-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.menu-header h3 {
  font-size: 16px;
  font-weight: 900;
  color: var(--cobalt);
}

.menu-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

.menu-nav {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.menu-link {
  appearance: none;
  border: none;
  background: transparent;
  font-family: inherit;
  text-align: left;
  padding: 12px;
  font-size: 15px;
  font-weight: 600;
  color: var(--cobalt);
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.15s ease;
  text-decoration: none;
}

.menu-link:hover {
  background: #f5f7fa;
}

/* === CART DRAWER === */
.cart-drawer {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  width: min(420px, 92vw);
  background: #fff;
  z-index: 1001; /* Above backdrop (1000) so it's not dimmed */
  transform: translateX(100%);
  transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: -4px 0 16px rgba(0,0,0,.1);
  display: flex;
  flex-direction: column;
}

.cart-drawer.open {
  transform: translateX(0);
}

.cart-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.cart-title {
  font-size: 18px;
  font-weight: 900;
  color: var(--cobalt);
}

.cart-body {
  flex: 1;
  overflow-y: auto;
  padding: 0 20px;
  padding-bottom: 16px;
}

.cart-empty {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.cart-empty::before {
  content: "ðŸ›’";
  display: block;
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.cart-empty p {
  font-size: 15px;
  color: var(--muted);
  margin: 0;
}

/* Bundle recommendations panel */
.bundle-panel {
  margin-bottom: 16px;
  padding: 12px;
  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
  border: 1px solid #ffd97d;
  border-radius: 12px;
}

.bundle-card {
  background: #fff;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
}

.bundle-card:last-child {
  margin-bottom: 0;
}

.b-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.b-name {
  font-weight: 800;
  color: var(--cobalt);
  font-size: 15px;
}

.b-save {
  font-weight: 800;
  color: #28a745;
  font-size: 14px;
}

.b-list {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 10px;
}

.b-actions button {
  width: 100%;
}

/* Sign-in banner */
.signin-banner {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border: 1px solid #90caf9;
  border-radius: 12px;
  margin-bottom: 16px;
  font-size: 13px;
  color: var(--cobalt);
}

.signin-banner strong {
  display: block;
  font-size: 14px;
  margin-bottom: 4px;
}

/* AI Recommendations Panel */
.ai-recs-panel {
  margin-bottom: 16px;
  padding: 14px;
  background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
  border: 1px solid #ce93d8;
  border-radius: 12px;
}

.ai-recs-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.ai-icon {
  font-size: 20px;
}

.ai-title {
  font-weight: 800;
  font-size: 15px;
  color: #6a1b9a;
}

.ai-recs-list {
  display: grid;
  gap: 10px;
}

.ai-rec-card {
  padding: 12px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.ai-rec-name {
  font-weight: 700;
  font-size: 14px;
  color: var(--ink);
  margin-bottom: 4px;
}

.ai-rec-reason {
  font-size: 12px;
  color: var(--muted);
  font-style: italic;
  line-height: 1.4;
}

.ai-rec-price {
  font-weight: 600;
  font-size: 13px;
  color: var(--cobalt);
}

/* Bundle Panel (smart swap suggestions) */
.bundle-panel {
  margin-bottom: 16px;
  display: grid;
  gap: 10px;
}

.bundle-card {
  padding: 14px;
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  border: 1px solid #ffb74d;
  border-radius: 12px;
}

.b-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.b-name {
  font-weight: 800;
  font-size: 15px;
  color: #e65100;
}

.b-save {
  font-weight: 700;
  font-size: 13px;
  color: #ff6f00;
  background: white;
  padding: 4px 8px;
  border-radius: 6px;
}

.b-list {
  font-size: 12px;
  color: #6d4c41;
  margin-bottom: 10px;
  line-height: 1.4;
}

.b-actions {
  display: flex;
  gap: 8px;
}

.b-actions .btn {
  flex: 1;
  padding: 8px 12px;
  font-size: 13px;
}

/* Rule-based Recommendations */
.recs-panel {
  margin-bottom: 16px;
  display: grid;
  gap: 10px;
}

.rec-card {
  display: grid;
  grid-template-columns: 60px 1fr auto;
  gap: 12px;
  padding: 12px;
  background: white;
  border: 1px solid var(--border);
  border-radius: 10px;
  align-items: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

.rec-card img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
}

.r-text {
  flex: 1;
}

.r-title {
  font-weight: 700;
  font-size: 14px;
  color: var(--ink);
  margin-bottom: 3px;
}

.r-msg {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
  line-height: 1.3;
}

.rec-dismiss {
  font-size: 11px;
  color: #999;
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  text-decoration: underline;
}

.rec-dismiss:hover {
  color: #666;
}

.r-price {
  font-weight: 800;
  font-size: 14px;
  color: var(--cobalt);
  margin-bottom: 6px;
  text-align: right;
}

.rec-card .btn {
  padding: 6px 12px;
  font-size: 12px;
  white-space: nowrap;
}

/* Cart lines */
.cart-lines {
  display: flex;
  flex-direction: column;
  gap: 0;
  padding-top: 16px;
}

.cart-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 20px 0;
  border-bottom: 1px solid var(--border);
  gap: 16px;
}

.cart-item:last-child {
  border-bottom: none;
}

.cart-item-info {
  flex: 1;
  min-width: 0;
}

.cart-item-name {
  font-weight: 800;
  font-size: 16px;
  color: var(--ink);
  margin-bottom: 6px;
  line-height: 1.3;
}

.cart-item-price {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 14px;
  font-weight: 500;
}

.cart-qty-controls {
  display: flex;
  align-items: center;
  gap: 10px;
}

.cart-qty-btn {
  width: 32px;
  height: 32px;
  border: 2px solid var(--cobalt);
  background: white;
  color: var(--cobalt);
  border-radius: 6px;
  cursor: pointer;
  font-size: 18px;
  font-weight: 800;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s ease;
  padding: 0;
  line-height: 1;
}

.cart-qty-btn:hover {
  background: var(--cobalt);
  color: white;
}

.cart-qty-btn:active {
  transform: scale(0.92);
}

.cart-qty-value {
  font-weight: 700;
  color: var(--cobalt);
  min-width: 20px;
  text-align: center;
  font-size: 14px;
}

.cart-item-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
}

.cart-item-total {
  font-weight: 900;
  font-size: 19px;
  color: var(--ink);
  white-space: nowrap;
  letter-spacing: -0.5px;
}

.cart-remove-btn {
  font-size: 13px;
  font-weight: 700;
  color: #dc3545;
  background: none;
  border: none;
  cursor: pointer;
  padding: 6px 0;
  text-decoration: none;
  transition: all 0.15s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.cart-remove-btn:hover {
  color: #c82333;
  text-decoration: underline;
}

.cart-foot {
  border-top: 1px solid var(--border);
  padding: 16px;
  background: #f8f9fb;
}

/* Error display */
.checkout-error {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  background: #fee;
  border: 1px solid #fcc;
  border-radius: 8px;
  margin-bottom: 12px;
  font-size: 13px;
  color: #c33;
}

.checkout-error[hidden] {
  display: none !important;
}

.error-dismiss {
  appearance: none;
  border: none;
  background: none;
  font-size: 20px;
  line-height: 1;
  color: #c33;
  cursor: pointer;
  padding: 0;
  width: 20px;
  height: 20px;
}

/* Totals */
.totals {
  margin-bottom: 16px;
  padding-top: 12px;
}

.kv {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  font-size: 15px;
  font-weight: 600;
  color: var(--ink);
}

.kv strong {
  font-weight: 900;
  color: var(--ink);
  font-size: 20px;
  letter-spacing: -0.5px;
}

.note {
  font-size: 12px;
  color: var(--muted);
  margin-top: 6px;
}

/* Footer actions */
.foot-actions {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}

.foot-actions .btn {
  font-weight: 700;
  padding: 14px 20px;
  font-size: 15px;
  border-radius: 8px;
}

.foot-actions .btn-ghost {
  flex: 0 0 auto;
  background: white;
  border: 2px solid var(--border);
  color: var(--cobalt);
}

.foot-actions .btn-ghost:hover {
  border-color: var(--cobalt);
  background: white;
}

.foot-actions .btn-primary {
  flex: 1;
  font-weight: 800;
  letter-spacing: 0.5px;
}

.cart-empty {
  text-align: center;
  color: var(--muted);
  padding: 40px 20px;
  font-size: 14px;
}

/* === BACKDROP === */
.backdrop {
  position: fixed;
  inset: 0;
  background: rgba(11,20,32,.4);
  /* raised so modals/backdrops sit under banner but above content */
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.28s ease;
}

.backdrop.show {
  opacity: 1;
  pointer-events: auto;
}

/* === MODAL === */
.modal {
  position: fixed;
  inset: 0;
  /* modal should sit under the urgency banner but above the dim backdrop */
  z-index: 1100;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.28s ease;
}

.modal.show {
  opacity: 1;
  pointer-events: auto;
}

.modal-content {
  background: #fff;
  border-radius: 16px 16px 0 0;
  width: 100%;
  max-width: 520px;
  max-height: 85vh;
  overflow-y: auto;
  transform: translateY(100%);
  transition: transform 0.32s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 -4px 24px rgba(0,0,0,.15);
}

/* modal input styling to match form styles */
.modal .inp,
.modal-content .inp,
.modal-content textarea {
  padding: 12px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 15px;
  width: 100%;
  box-sizing: border-box;
}
.modal .inp:focus,
.modal-content .inp:focus,
.modal-content textarea:focus {
  outline: none;
  border-color: var(--azure);
  box-shadow: 0 0 0 4px rgba(20,147,255,0.06);
}

/* Scrollbar styling (WebKit + modern) - Dark gunmetal theme */
::-webkit-scrollbar {
  width: 12px;
  height: 12px;
}
::-webkit-scrollbar-track {
  background: #1a1d23;
  border-radius: 10px;
}
::-webkit-scrollbar-thumb {
  background: #3a3f47;
  border-radius: 10px;
  border: 3px solid #1a1d23;
}
::-webkit-scrollbar-thumb:hover {
  background: #4a505a;
}
/* Firefox */
* { scrollbar-width: thin; scrollbar-color: #3a3f47 #1a1d23; }

.modal.show .modal-content {
  transform: translateY(0);
}

.modal-header {
  padding: 24px 20px 16px;
  border-bottom: 1px solid var(--border);
}

.modal-header h3 {
  font-size: 22px;
  font-weight: 900;
  color: var(--cobalt);
  margin-bottom: 6px;
}

.modal-header p {
  font-size: 14px;
  color: var(--muted);
  line-height: 1.5;
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* === UTILITIES === */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0,0,0,0);
  white-space: nowrap;
  border: 0;
}

.hidden {
  display: none !important;
}

/* === LOADER === */
.h2s-loader {
  position: fixed;
  inset: 0;
  z-index: 99999;
  display: grid;
  place-items: center;
  background: rgba(255,255,255,0.98);
  backdrop-filter: blur(8px);
  pointer-events: auto;
  opacity: 1;
  transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.h2s-loader.hidden {
  opacity: 0;
  pointer-events: none;
}
.h2s-loader-stage {
  position: relative;
  width: min(72vw, 520px);
  aspect-ratio: 5/2;
}
.h2s-loader-slices {
  position: absolute;
  inset: 0;
}
.h2s-loader-slice {
  position: absolute;
  top: 0;
  bottom: 0;
  overflow: hidden;
  opacity: 0;
  transform: translateY(24px);
  will-change: transform, opacity;
  animation: h2s-split 2.2s cubic-bezier(.22,.8,.32,1) infinite;
  animation-delay: calc(var(--i) * 0.06s);
}
.h2s-loader-slice img {
  position: absolute;
  inset: 0 auto 0 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
}
@keyframes h2s-split {
  0% { opacity: 0; transform: translateY(24px); }
  36% { opacity: 1; transform: translateY(0); }
  68% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(-12px); }
}

/* === SKELETON LOADING STATES === */
.skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: skeleton-shimmer 1.5s ease-in-out infinite;
  border-radius: 8px;
}
@keyframes skeleton-shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
.skeleton-hero {
  height: 280px;
  margin-bottom: 24px;
}
.skeleton-trust {
  height: 80px;
  margin-bottom: 32px;
}
.skeleton-card {
  height: 420px;
  border-radius: 16px;
  margin-bottom: 16px;
}
.skeleton-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  padding: 0 16px;
  max-width: 1200px;
  margin: 0 auto;
}

/* === SMOOTH CONTENT REVEAL === */
.content-reveal {
  opacity: 0;
  transform: translateY(16px);
  animation: reveal-fade-in 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}
@keyframes reveal-fade-in {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.reveal-delay-1 { animation-delay: 0.05s; }
.reveal-delay-2 { animation-delay: 0.1s; }
.reveal-delay-3 { animation-delay: 0.15s; }
.reveal-delay-4 { animation-delay: 0.2s; }

/* Prevent layout shift */
#outlet {
  min-height: calc(100vh - 56px);
  contain: layout;
}

/* Initial page load - hide content until ready */
body:not(.app-ready) #outlet > * {
  opacity: 0;
}

body.app-ready #outlet > * {
  animation: initial-reveal 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

@keyframes initial-reveal {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (prefers-reduced-motion: reduce) {
  .h2s-loader-slice,
  .content-reveal,
  .skeleton {
    animation: none !important;
  }
  .content-reveal {
    opacity: 1;
    transform: none;
  }
  .h2s-loader {
    transition: none;
  }
}

/* === DESKTOP TWEAKS === */
@media (min-width: 768px) {
  .hero {
    padding: 88px 32px 72px;
  }

  .hero h1 {
    font-size: 42px;
  }

  .hero p {
    font-size: 19px;
  }

  .trust-bar {
    padding: 32px 24px;
  }

  .section {
    padding: 80px 24px;
  }

  .section-header h2 {
    font-size: 36px;
  }

  .section-header p {
    font-size: 18px;
  }

  .review-carousel {
    padding: 64px 24px;
  }

  .modal-content {
    border-radius: 16px;
    max-height: 90vh;
  }
}

/* === AUTH FORMS & ACCOUNT === */
.form {
  max-width: 480px;
  margin: 80px auto 40px;
  padding: 32px;
  background: white;
  border-radius: 16px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-md);
}

.form h2 {
  text-align: center;
  color: var(--cobalt);
  margin: 0 0 24px 0;
  font-weight: 900;
  font-size: 28px;
}

.inp {
  display: block;
  width: 100%;
  padding: 14px 16px;
  margin-bottom: 14px;
  font-size: 16px;
  font-family: inherit;
  border: 2px solid var(--border);
  border-radius: 10px;
  background: white;
  color: var(--ink);
  transition: all 0.2s ease;
}

.inp:focus {
  outline: none;
  border-color: var(--azure);
  box-shadow: 0 0 0 3px rgba(20, 147, 255, 0.1);
}

.inp:disabled {
  background: #f5f5f5;
  color: var(--muted);
  cursor: not-allowed;
  border-color: #e0e0e0;
}

.form .help {
  font-size: 13px;
  color: var(--muted);
  margin: -6px 0 16px 0;
  text-align: center;
}

.form > div[style*="display:flex"] {
  justify-content: center;
  margin-top: 20px;
}

.pd-box {
  padding: 16px;
  background: #fafcff;
  border: 1px solid #e7eaf0;
  border-radius: 10px;
  margin-bottom: 16px;
}

.details-grid {
  display: grid;
  gap: 8px;
}

.details-grid .row {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 12px;
  padding: 8px 0;
  border-bottom: 1px solid #e7eaf0;
}

.details-grid .row:last-child {
  border-bottom: none;
}

.details-grid .k {
  font-weight: 600;
  color: var(--muted);
  font-size: 13px;
}

.details-grid .v {
  font-weight: 700;
  color: var(--cobalt);
  font-size: 14px;
}

.cal-embed {
  width: 100%;
  height: 680px;
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  margin: 20px 0;
}

.cal-embed iframe {
  width: 100%;
  height: 100%;
  border: none;
}

@media (max-width: 768px) {
  .form {
    margin: 20px;
    padding: 20px;
  }

  .details-grid .row {
    grid-template-columns: 1fr;
    gap: 4px;
  }

  .cal-embed {
    height: 600px;
  }
}
</style>
</head>
<body>

<!-- URGENCY BANNER -->
<div class="urgency-banner" id="urgencyBanner">
  <div class="urgency-text">
    <span><strong id="urgencyMessage">Loading...</strong></span>
    <span class="urgency-separator">|</span>
    <span>We're available 7 days/week</span>
  </div>
  <button class="urgency-close" onclick="dismissUrgencyBanner()" aria-label="Dismiss banner">Ã—</button>
</div>

<!-- HEADER -->
<header class="header">
  <div class="header-inner">
    <a href="#" class="logo" aria-label="Home2Smart home" onclick="navSet({view:'shop'}); return false;">
      <img src="https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68da0ce6f00445991d64a63f.png" alt="Home2Smart" class="logo-img" width="36" height="36" fetchpriority="high" decoding="async">
    </a>

    <div class="header-actions">
      <button class="menu-btn" onclick="toggleMenu()" aria-label="Open menu">
        <svg class="icon" viewBox="0 0 24 24">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>

      <button id="accountBtn" class="header-btn" aria-label="Account">
        <svg class="icon" viewBox="0 0 24 24">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </button>

      <button class="cart-btn" onclick="toggleCart()" aria-label="Open cart">
        <svg class="icon" viewBox="0 0 24 24">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        <span class="cart-badge" id="cartCount">0</span>
      </button>
    </div>
  </div>
</header>

<!-- Main Outlet for Dynamic Views -->
<main id="pageShell">
<div id="outlet">
  
<!-- HERO -->
<section class="hero">
  <div class="hero-inner">
    <h1>Expert Installation.<br>Done Right.</h1>
    <p>TV Mounting & Security Cameras. Pick a package, we handle the rest. Simple pricing, instant booking.</p>
    <div class="hero-ctas">
      <button class="btn btn-primary" onclick="scrollToSection('tv')">
        Shop TV Packages
      </button>
      <button class="btn btn-ghost" onclick="scrollToSection('security')">
        Shop Security
      </button>
    </div>
    
    <!-- Hero Review Carousel -->
    <div class="hero-reviews" id="heroReviews">
      <!-- Reviews will be injected here by JavaScript -->
    </div>
  </div>
</section>

<!-- TRUST BAR -->
<section class="trust-bar">
  <div class="trust-inner">
    <div class="trust-item">
      <strong>500+</strong>
      <span>Homes Served</span>
    </div>
    <div class="trust-item">
      <strong>4.9â˜…</strong>
      <span>Average Rating</span>
    </div>
    <div class="trust-item">
      <strong>Licensed</strong>
      <span>& Insured</span>
    </div>
    <div class="trust-item">
      <strong>Same-Day</strong>
      <span>Service Available</span>
    </div>
  </div>
</section>

<!-- TV MOUNTING SECTION -->
<section class="section" id="tv">
  <div class="section-header">
    <h2>How many TVs?</h2>
    <p>Clean installs, same-day setup. First TV $249, each additional discounted. Perfect for homes, offices, or retail spaces.</p>
  </div>

  <div class="package-grid">
    <!-- Single TV -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Single TV Mount</h3>
        <div class="package-price">$249</div>
      </div>
      <p class="package-promise">One TV mounted clean and ready to watch tonight.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>TV securely mounted</li>
          <li>All wires hidden</li>
          <li>Streaming setup</li>
          <li>Ready to go</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('tv_single', 'Single TV Mount', 249)">
        Add to Cart
      </button>
    </article>

    <!-- 2-TV Package (FEATURED) -->
    <article class="package featured">
      <div class="package-header">
        <h3 class="package-name">2-TV Package</h3>
        <div class="package-price">$428 <small style="opacity:.6">(save $70)</small></div>
      </div>
      <p class="package-promise">Two rooms, theater-ready. Same visit, better deal.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>Both TVs mounted</li>
          <li>All wiring concealed</li>
          <li>Streaming on both</li>
          <li>One appointment</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('tv_2pack', '2-TV Package', 428)">
        Add to Cart
      </button>
    </article>

    <!-- Multi-Room -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Multi-Room (3-4 TVs)</h3>
        <div class="package-price">$749-$899</div>
      </div>
      <p class="package-promise">Whole-home entertainment in one visit.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>3-4 TVs mounted</li>
          <li>All wiring concealed</li>
          <li>Streaming + soundbar</li>
          <li>Universal remote</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('tv_multi', 'Multi-Room Package', 749)">
        Add to Cart
      </button>
    </article>

    <!-- Custom -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">5+ TVs (Custom)</h3>
        <div class="package-price">Request Quote</div>
      </div>
      <p class="package-promise">Large properties or commercial setupsâ€”we'll design a plan.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>Site consultation</li>
          <li>Custom wiring plan</li>
          <li>Volume pricing</li>
          <li>Project manager</li>
        </ul>
      </div>
      <button class="btn btn-secondary" onclick="requestQuote('tv_custom')">
        Request Quote
      </button>
    </article>
  </div>
</section>

<!-- SECURITY CAMERAS SECTION -->
<section class="section" id="security">
  <div class="section-header">
    <h2>How many cameras do you need?</h2>
    <p>Front door only, full perimeter, or something in betweenwe'll cover what matters. Great for homes, storefronts, warehouses, and offices.</p>
  </div>

  <div class="package-grid">
    <!-- Basic Coverage -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Basic Coverage</h3>
        <div class="package-price">$599</div>
      </div>
      <p class="package-promise">Front door secure. See who's there, every time.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>2 cameras + doorbell</li>
          <li>Mobile alerts</li>
          <li>7-day cloud storage</li>
          <li>App setup</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('cam_basic', 'Basic Coverage', 599)">
        Add to Cart
      </button>
    </article>

    <!-- Standard Coverage (FEATURED) -->
    <article class="package featured">
      <div class="package-header">
        <h3 class="package-name">Standard Coverage</h3>
        <div class="package-price">$1,199</div>
      </div>
      <p class="package-promise">Front, driveway, and backyard-full visibility where it matters.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>4-5 cameras + doorbell</li>
          <li>Motion flood lights</li>
          <li>30-day cloud storage</li>
          <li>Smart home integration</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('cam_standard', 'Standard Coverage', 1199)">
        Add to Cart
      </button>
    </article>

    <!-- Full Coverage -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Full Coverage</h3>
        <div class="package-price">$2,199</div>
      </div>
      <p class="package-promise">Every angle, every entry. Complete perimeter security.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>6-8 cameras + doorbell</li>
          <li>2 security lights</li>
          <li>60-day cloud storage</li>
          <li>Smart lock integration</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('cam_full', 'Full Coverage', 2199)">
        Add to Cart
      </button>
    </article>

    <!-- Custom -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Custom Coverage</h3>
        <div class="package-price">Request Quote</div>
      </div>
      <p class="package-promise">Large properties or commercial security-let's design it.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>Site survey</li>
          <li>Security assessment</li>
          <li>Custom wiring plan</li>
          <li>Scalable storage</li>
        </ul>
      </div>
      <button class="btn btn-secondary" onclick="requestQuote('cam_custom')">
        Request Quote
      </button>
    </article>
  </div>
</section>

</div>
<!-- End Outlet -->
</main>

<!-- Global Loader Overlay -->
<div id="h2s-loader" class="h2s-loader" aria-hidden="true" style="display:none">
  <div class="h2s-loader-stage">
    <div id="h2sLoaderSlices" class="h2s-loader-slices"></div>
  </div>
</div>

<!-- MENU DRAWER -->
<aside class="menu-drawer" id="menuDrawer">
  <div class="menu-header">
    <h3>Menu</h3>
    <button class="btn-subtle" onclick="toggleMenu()" style="padding: 6px 10px; font-size: 13px;">Close</button>
  </div>
  <nav class="menu-body">
    <div class="menu-nav">
      <a href="/" class="menu-link">Home</a>
      <button class="menu-link" onclick="scrollToSection('tv'); toggleMenu();">TV Mounting</button>
      <button class="menu-link" onclick="scrollToSection('security'); toggleMenu();">Security Cameras</button>
      <a href="tel:864-528-1475" class="menu-link">Call: 864-528-1475</a>
    </div>
  </nav>
</aside>

<!-- CART DRAWER -->
<aside class="cart-drawer" id="cartDrawer" onclick="event.stopPropagation()">
  <div class="cart-header">
    <h3 class="cart-title">Your Cart</h3>
    <button class="btn-subtle" onclick="toggleCart()" style="padding: 6px 10px; font-size: 13px;">Close</button>
  </div>
  
  <!-- Scrollable body -->
  <div class="cart-body">
    <!-- AI Recommendations Panel -->
    <div id="aiRecommendationsPanel" class="ai-recs-panel" style="display:none;min-height:80px">
      <div class="ai-recs-header">
        <div class="ai-icon">âœ¨</div>
        <div class="ai-title">Recommended for you</div>
      </div>
      <div id="aiRecommendations" class="ai-recs-list"></div>
    </div>
    
    <!-- Bundle recommendations (smart swap suggestions) -->
    <div id="bundlePanel" class="bundle-panel" style="display:none;min-height:60px"></div>
    
    <!-- Rule-based Recommendations -->
    <div id="recsPanel" class="recs-panel" style="display:none;min-height:60px"></div>
    
    <!-- Sign-in banner -->
    <div id="signinBanner" class="signin-banner" style="display:none;min-height:80px">
      <div>
        <strong>Save time at checkout.</strong>
        <div>Sign in so we can prefill your info.</div>
      </div>
      <button class="btn btn-primary" id="bannerSignIn" style="padding:8px 16px;font-size:13px;">Sign in</button>
    </div>
    
    <!-- Empty state -->
    <div id="cartEmpty" class="cart-empty" hidden>
      <p>Your cart is empty</p>
      <p style="font-size: 13px; margin-top: 8px;">Pick a package to get started</p>
    </div>
    
    <!-- Cart items -->
    <div id="cartItems" class="cart-lines">
      <!-- Items rendered by paintCart() -->
    </div>
  </div>
  
  <!-- Footer -->
  <div class="cart-foot">
    <!-- Error display -->
    <div id="checkoutError" class="checkout-error" role="alert" aria-live="polite" hidden>
      <span id="checkoutErrorMsg"></span>
      <button id="dismissError" class="error-dismiss" aria-label="Dismiss error">Ã—</button>
    </div>

    <!-- Promo Code -->
    <div class="promo-section" style="margin-bottom: 16px;">
      <div style="display: flex; gap: 8px;">
        <input type="text" id="promoCode" class="inp" placeholder="Promo code" style="padding: 8px 12px; font-size: 14px; flex: 1;">
        <button id="applyPromo" class="btn ghost" style="padding: 8px 14px; font-size: 13px; white-space: nowrap;">Apply</button>
      </div>
      <div id="promoMsg" class="help" style="margin-top: 6px; font-size: 12px;"></div>
    </div>
    
    <!-- Totals -->
    <div class="totals">
      <div class="kv" style="font-size: 14px; color: var(--muted);">
        <span id="cartItemCount">0 items</span>
        <span></span>
      </div>
      <div class="kv" style="padding-top: 8px; border-top: 1px solid var(--border);">
        <span>Subtotal</span>
        <strong id="cartSubtotal">$0.00</strong>
      </div>
      <div class="note">Final tax and fees shown at checkout.</div>
    </div>
    
    <!-- Actions -->
    <div class="foot-actions">
      <button class="btn btn-ghost" onclick="window.location.href='tel:864-528-1475'">
        Need Help?
      </button>
      <button id="checkoutBtn" class="btn btn-primary" onclick="checkout()">
        Checkout
      </button>
    </div>
  </div>
</aside>

<!-- BACKDROP -->
<div class="backdrop" id="backdrop" onclick="if(event.target === this) closeAll()"></div>

<!-- QUOTE REQUEST MODAL -->
<div class="modal" id="quoteModal">
  <div class="modal-content" style="max-width: 520px;">
    <div class="modal-header">
      <h3 id="quoteModalTitle">Request Custom Quote</h3>
      <p id="quoteModalSubtitle">Tell us what you need and we'll get back to you fast</p>
    </div>
    <div class="modal-body" style="padding: 24px;">
      <div style="background: #f5f9ff; border: 1px solid #d7eafc; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
        <div style="font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">ðŸ“‹ What to include:</div>
        <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #6b778c; line-height: 1.6;">
          <li>Number of TVs or cameras</li>
          <li>Room locations</li>
          <li>Any special requirements</li>
          <li>Preferred installation date</li>
        </ul>
      </div>
      
      <div style="display: grid; gap: 16px;">
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">Your Name *</label>
          <input type="text" id="quoteName" class="inp" placeholder="John Smith" style="width: 100%;" required>
        </div>
        
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">Email *</label>
          <input type="email" id="quoteEmail" class="inp" placeholder="john@example.com" style="width: 100%;" required>
        </div>
        
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">Phone *</label>
          <input type="tel" id="quotePhone" class="inp" placeholder="(864) 528-1475" style="width: 100%;" required>
        </div>
        
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">Project Details</label>
          <textarea id="quoteDetails" class="inp" placeholder="Tell us about your project..." style="width: 100%; min-height: 100px; resize: vertical; font-family: inherit;"></textarea>
        </div>
        
        <div id="quoteMessage" class="help" style="margin-top: 4px;"></div>
      </div>
      
      <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
        <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 12px;">ðŸ“ž Prefer to call?</div>
        <a href="tel:864-528-1475" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: #f5f9ff; border: 1px solid #d7eafc; border-radius: 8px; text-decoration: none; color: var(--cobalt); font-weight: 600; transition: all 0.2s;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
          </svg>
          <span>(864) 528-1475</span>
        </a>
      </div>
    </div>
    <div class="modal-footer" style="gap: 8px;">
      <button class="btn btn-primary" id="submitQuoteBtn" onclick="submitQuoteRequest()" style="flex: 1;">
        Send Request
      </button>
      <button class="btn btn-subtle" id="cancelQuoteBtn" onclick="closeQuoteModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Package Selected</h3>
      <p id="modalSubtitle">We'll finalize the details during your free consultation.</p>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Dynamic content -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="modalPrimaryCTA" onclick="addPackageToCart()">Add to Cart</button>
      <button class="btn btn-subtle" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
(()=>{
'use strict';

// === API CONFIG ===
const API = 'https://h2s-backend-5o9147lik-tabari-ropers-projects-6f2e090b.vercel.app/api/shop';
const APIV1 = 'https://script.google.com/macros/s/AKfycbzN7912CA8vCLEGRhnOqz6tA2KOAhlHDqZxEgxOh_n3_aDvDRfYvgqyW4LUxQNqnEgu/exec'; // Shopbackend.js for appointments
const DASH_URL = 'https://script.google.com/macros/s/AKfycbxVsGP8EeAZmfRcW9LjY3fm1F9iWvXMO7RlT4VP7Tj1BV0BOkeBi6GAkASQhEZJ7h9Y/exec';
const CAL_FORM_URL = 'https://api.leadconnectorhq.com/widget/booking/RjwOQacM3FAjRNCfm6uU';
const PIXEL_ID = '2384221445259822';

// Session ID for tracking
let SESSION_ID = sessionStorage.getItem('h2s_session_id');
if(!SESSION_ID){
  SESSION_ID = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
  sessionStorage.setItem('h2s_session_id', SESSION_ID);
}

// === STATE ===
let catalog = { services:[], serviceOptions:[], priceTiers:[], bundles:[], bundleItems:[], recommendations:[], memberships:[], membershipPrices:[] };
let cart = loadCart();
let user = loadUser();
let lastSearch = '';
let lastCat = '';

// === LOADER ===
function buildLoader(){
  const slices = byId('h2sLoaderSlices');
  if(!slices) return;
  const c1 = '#1493ff', c2 = '#0a2a5a', c3 = '#6b778c';
  const colors = [c1, c2, c3, c1, c2, c3, c1, c2];
  slices.innerHTML = colors.map((col, i)=>`<div class="h2s-loader-slice" style="background:${col};animation-delay:${i*0.05}s"></div>`).join('');
}
function showLoader(){ 
  const el=byId('h2s-loader'); 
  if(el){ 
    el.classList.remove('hidden');
    el.style.display=''; 
  } 
}
function hideLoader(){ 
  const el=byId('h2s-loader'); 
  if(el){ 
    el.classList.add('hidden');
    // Remove from DOM after transition
    setTimeout(() => { if(el.classList.contains('hidden')) el.style.display='none'; }, 400);
  } 
}

// Show skeleton loading state while content loads
function showSkeleton(){
  byId('outlet').innerHTML = `
    <div class="skeleton skeleton-hero"></div>
    <div class="skeleton skeleton-trust"></div>
    <div class="skeleton-grid">
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
    </div>
  `;
}

// === META PIXEL + TRACKING ===
function h2sTrack(event, data={}){
  const payload = {
    event,
    timestamp: new Date().toISOString(),
    session_id: SESSION_ID,
    user_email: user?.email||'',
    url: location.href,
    ...data
  };
  
  // Send to Meta Pixel if loaded
  if(typeof fbq !== 'undefined'){
    const params = buildAdvancedParams();
    fbq('track', event, data, params);
  }
  
  // Send to dashboard webhook
  fetch(DASH_URL, {
    method:'POST',
    body: JSON.stringify(payload)
  }).catch(err => console.warn('Dashboard track failed:', err));
}

async function sha256(text){
  if(!crypto || !crypto.subtle) return '';
  try{
    const encoder = new TextEncoder();
    const data = encoder.encode(text);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }catch(_){ return ''; }
}

function buildAdvancedParams(){
  const params = {};
  if(user && user.email){
    sha256(user.email.trim().toLowerCase()).then(h => { if(h) params.em = h; });
    if(user.phone){
      const digits = user.phone.replace(/\D/g,'');
      sha256(digits).then(h => { if(h) params.ph = h; });
    }
    if(user.name){
      const parts = user.name.trim().toLowerCase().split(' ');
      if(parts[0]) sha256(parts[0]).then(h => { if(h) params.fn = h; });
      if(parts[parts.length-1]) sha256(parts[parts.length-1]).then(h => { if(h) params.ln = h; });
    }
  }
  return params;
}

// === INIT ===
async function init(){
  console.log('App initializing...');
  
  try {
    // PHASE 1: INSTANT - Critical UI setup (0ms)
    // Prevent browser from auto-scrolling to hash on page load
    const hash = window.location.hash;
    if (hash) {
      history.replaceState(null, '', window.location.pathname + window.location.search);
    }
    
    buildLoader();
    
    // Wire UI immediately (cart drawer, buttons, etc.)
    wireCart();
    
    // Restore cart from localStorage instantly (no flash)
    updateCartBadge();
    paintCart();
    
    // PHASE 2: FAST - Determine what content to show
    const view = getParam('view');
    const isSpecialView = view && view !== 'shop';
    
    // If it's a special view (signin, account, etc.), show skeleton for that
    if (isSpecialView) {
      showSkeleton();
    } else {
      // For shop view, the static HTML is already visible
      // Just mark it as ready to animate in
      document.body.classList.add('app-ready');
    }
    
    // PHASE 3: PARALLEL - Load catalog + handle URL state
    const catalogPromise = fetch(API + '?action=catalog', { 
      cache: 'default', // Use CDN cache for instant response
      headers: { 'Accept': 'application/json' }
    }).then(res => res.json()).then(data => {
      if(data.ok){
        catalog = data.catalog || catalog;
        console.log('âœ“ Catalog loaded:', catalog.bundles?.length || 0, 'bundles');
      }
    }).catch(err => {
      console.error('Catalog fetch failed:', err);
    });
    
    // Handle cart from URL (parallel with catalog load)
    const urlCart = getParam('cart');
    if(urlCart){
      const decoded = decodeCartFromUrl(urlCart);
      if(decoded.length){
        cart = decoded;
        saveCart();
        updateCartBadge();
        paintCart();
      }
    }
    
    // Clean URL - remove cart parameter
    const url = new URL(location.href);
    if(url.searchParams.has('cart')){
      url.searchParams.delete('cart');
      history.replaceState({}, '', url.toString());
    }
    
    // PHASE 4: WAIT - Ensure catalog is loaded before routing to special views
    await catalogPromise;
    
    // PHASE 5: RENDER - Route to appropriate view (ALWAYS call route to handle all cases)
    route(); // This will render shop, signin, account, etc. based on view param
    
    // PHASE 6: BACKGROUND - Load non-critical features
    // AI recommendations (only if signed in)
    if(user && user.email){
      requestIdleCallback(() => loadAIRecommendations(), { timeout: 2000 });
    }
    
    // Meta Pixel (deferred, low priority)
    if('requestIdleCallback' in window){
      requestIdleCallback(() => {
        try {
          const script = document.createElement('script');
          script.innerHTML = `
            !function(f,b,e,v,n,t,s)
            {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
            n.callMethod.apply(n,arguments):n.queue.push(arguments)};
            if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
            n.queue=[];t=b.createElement(e);t.async=!0;
            t.src=v;s=b.getElementsByTagName(e)[0];
            s.parentNode.insertBefore(t,s)}(window, document,'script',
            'https://connect.facebook.net/en_US/fbevents.js');
            fbq('init', '${PIXEL_ID}');
            fbq('track', 'PageView');
          `;
          document.head.appendChild(script);
          
          const noscript = document.createElement('noscript');
          noscript.innerHTML = `<img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=${PIXEL_ID}&ev=PageView&noscript=1"/>`;
          document.body.appendChild(noscript);
        } catch(e) { console.warn('Pixel init failed', e); }
      }, { timeout: 3000 });
    }
    
    // PHASE 7: ANALYTICS - Track page view (lowest priority)
    requestAnimationFrame(() => {
      h2sTrack('PageView');
    });
    
    console.log('âœ“ App ready');
  } catch (err) {
    console.error('Critical initialization error:', err);
    // Fallback: show content anyway
    document.body.classList.add('app-ready');
  }
}

// Fetch latest catalog from backend. If cacheBust is true, append a timestamp to force bypass.
async function fetchCatalogFromAPI(cacheBust = false){
  try{
    const url = API + '?action=catalog' + (cacheBust ? '&cb=' + Date.now() : '');
    console.log('[Catalog] Fetching catalog from API', cacheBust ? '(cache-bust)' : '');
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok){
      console.warn('[Catalog] HTTP', res.status);
      return false;
    }
    const data = await res.json();
    if(data && data.ok && data.catalog){
      catalog = data.catalog;
      console.log('[Catalog] Updated local catalog. Bundles:', catalog.bundles?.length || 0);
      return true;
    }
    console.warn('[Catalog] Unexpected response while fetching catalog', data);
    return false;
  }catch(err){
    console.warn('[Catalog] Fetch failed:', err);
    return false;
  }
}

// === ROUTING ===
function route(){
  const view = getParam('view');
  
  console.log('[Route] Routing to view:', view || 'shop');
  
  // Close any open modals/drawers when navigating
  closeAll();
  
  if(view === 'signin'){ renderSignIn(); return; }
  if(view === 'signup'){ renderSignUp(); return; }
  if(view === 'account'){ renderAccount(); return; }
  if(view === 'forgot'){ renderForgot(); return; }
  if(view === 'reset'){ renderReset(getParam('token')); return; }
  if(view === 'shopsuccess'){ renderShopSuccess(); return; }
  if(view === 'calreturn' || view === 'apptreturn'){ handleCalReturn(); return; }
  
  // Default: show shop
  const outlet = byId('outlet');
  if (!outlet) {
    console.error('[Route] Outlet element not found!');
    return;
  }
  
  const hasShopContent = outlet.querySelector('.hero');
  
  if (!hasShopContent) {
    console.log('[Route] No shop content found, rendering shop');
    renderShop();
  } else {
    // Static shop content already loaded, ensure it's visible
    console.log('[Route] Shop content exists, making visible');
    outlet.style.opacity = '1';
    outlet.style.transition = '';
    document.body.classList.add('app-ready');
    
    // Re-initialize hero reviews if they haven't loaded
    const heroReviews = document.getElementById('heroReviews');
    if (heroReviews && !heroReviews.querySelector('.review-card')) {
      console.log('[Route] Initializing hero reviews');
      initHeroReviews();
    }
  }
}

function renderShop(){
  // Mark as transitioning
  const outlet = byId('outlet');
  outlet.style.opacity = '0';
  outlet.style.transition = 'opacity 0.3s ease';
  
  // Small delay for smooth transition
  setTimeout(() => {
    outlet.innerHTML = `
<!-- HERO -->
<section class="hero content-reveal">
  <div class="hero-inner">
    <h1>Expert Installation.<br>Done Right.</h1>
    <p>TV Mounting & Security Cameras. Pick a package, we handle the rest. Simple pricing, instant booking.</p>
    <div class="hero-ctas">
      <button class="btn btn-primary" onclick="scrollToSection('tv')">
        Shop TV Packages
      </button>
      <button class="btn btn-ghost" onclick="scrollToSection('security')">
        Shop Security
      </button>
    </div>
    
    <!-- Hero Review Carousel -->
    <div class="hero-reviews" id="heroReviews">
      <!-- Reviews will be injected here by JavaScript -->
    </div>
  </div>
</section>

<!-- TRUST BAR -->
<section class="trust-bar content-reveal reveal-delay-1">
  <div class="trust-inner">
    <div class="trust-item">
      <strong>500+</strong>
      <span>Homes Served</span>
    </div>
    <div class="trust-item">
      <strong>4.9â˜…</strong>
      <span>Average Rating</span>
    </div>
    <div class="trust-item">
      <strong>Licensed</strong>
      <span>& Insured</span>
    </div>
    <div class="trust-item">
      <strong>Same-Day</strong>
      <span>Service Available</span>
    </div>
  </div>
</section>

<!-- TV MOUNTING SECTION -->
<section class="section content-reveal reveal-delay-2" id="tv">
  <div class="section-header">
    <h2>How many TVs?</h2>
    <p>Clean installs, same-day setup. First TV $249, each additional discounted.</p>
  </div>

  <div class="package-grid">
    <!-- Single TV -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Single TV Mount</h3>
        <div class="package-price">$249</div>
      </div>
      <p class="package-promise">One TV mounted clean and ready to watch tonight.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>TV securely mounted</li>
          <li>All wires hidden</li>
          <li>Streaming setup</li>
          <li>Ready to go</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('tv_single', 'Single TV Mount', 249)">
        Add to Cart
      </button>
    </article>

    <!-- 2-TV Package (FEATURED) -->
    <article class="package featured">
      <div class="package-header">
        <h3 class="package-name">2-TV Package</h3>
        <div class="package-price">$428 <small style="opacity:.6">(save $70)</small></div>
      </div>
      <p class="package-promise">Two rooms, theater-ready. Same visit, better deal.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>Both TVs mounted</li>
          <li>All wiring concealed</li>
          <li>Streaming on both</li>
          <li>One appointment</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('tv_2pack', '2-TV Package', 428)">
        Add to Cart
      </button>
    </article>

    <!-- Multi-Room -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Multi-Room (3-4 TVs)</h3>
        <div class="package-price">$749-$899</div>
      </div>
      <p class="package-promise">Whole-home entertainment in one visit.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>3-4 TVs mounted</li>
          <li>All wiring concealed</li>
          <li>Streaming + soundbar</li>
          <li>Universal remote</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('tv_multi', 'Multi-Room Package', 749)">
        Add to Cart
      </button>
    </article>

    <!-- Custom -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">5+ TVs (Custom)</h3>
        <div class="package-price">Request Quote</div>
      </div>
      <p class="package-promise">Large properties or commercial setupsâ€”we'll design a plan.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>Site consultation</li>
          <li>Custom wiring plan</li>
          <li>Volume pricing</li>
          <li>Project manager</li>
        </ul>
      </div>
      <button class="btn btn-secondary" onclick="requestQuote('tv_custom')">
        Request Quote
      </button>
    </article>
  </div>
</section>

<!-- SECURITY CAMERAS SECTION -->
<section class="section" id="security">
  <div class="section-header">
    <h2>How many cameras do you need?</h2>
    <p>Front door only, full perimeter, or something in betweenwe'll cover what matters. Great for homes, storefronts, warehouses, and offices.</p>
  </div>

  <div class="package-grid">
    <!-- Basic Coverage -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Basic Coverage</h3>
        <div class="package-price">$599</div>
      </div>
      <p class="package-promise">Front door secure. See who's there, every time.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>2 cameras + doorbell</li>
          <li>Mobile alerts</li>
          <li>7-day cloud storage</li>
          <li>App setup</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('cam_basic', 'Basic Coverage', 599)">
        Add to Cart
      </button>
    </article>

    <!-- Standard Coverage (FEATURED) -->
    <article class="package featured">
      <div class="package-header">
        <h3 class="package-name">Standard Coverage</h3>
        <div class="package-price">$1,199</div>
      </div>
      <p class="package-promise">Front, driveway, and backyard-full visibility where it matters.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>4 cameras + doorbell</li>
          <li>Mobile alerts</li>
          <li>30-day cloud storage</li>
          <li>App + pro setup</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('cam_standard', 'Standard Coverage', 1199)">
        Add to Cart
      </button>
    </article>

    <!-- Premium Coverage -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Premium Coverage</h3>
        <div class="package-price">$2,199</div>
      </div>
      <p class="package-promise">Full perimeter + NVR recording. Total property protection.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>8 cameras + doorbell</li>
          <li>Local NVR recording</li>
          <li>60-day cloud storage</li>
          <li>Dedicated support</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('cam_premium', 'Premium Coverage', 2199)">
        Add to Cart
      </button>
    </article>

    <!-- Custom -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Custom Security</h3>
        <div class="package-price">Request Quote</div>
      </div>
      <p class="package-promise">Businesses, estates, unique needs-custom designs available.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>Site survey</li>
          <li>Custom camera plan</li>
          <li>Volume pricing</li>
          <li>Ongoing support</li>
        </ul>
      </div>
      <button class="btn btn-secondary" onclick="requestQuote('cam_custom')">
        Request Quote
      </button>
    </article>
  </div>
</section>
  `;
    
    // Fade back in
    requestAnimationFrame(() => {
      outlet.style.opacity = '1';
      document.body.classList.add('app-ready');
    });
  }, 50);
  
  // Re-init hero reviews
  initHeroReviews();
  
  // Update signin state
  renderSigninState();
  
  // Scroll to top
  window.scrollTo(0, 0);
}

function navSet(params){
  const u = new URL(location.href);
  Object.entries(params||{}).forEach(([k,v])=>{
    if(v==null) u.searchParams.delete(k); else u.searchParams.set(k,v);
  });
  history.pushState({}, '', u.toString());
  route();
}

function getParam(k){
  const u = new URL(location.href);
  return u.searchParams.get(k);
}

// === MENU / CART / MODAL TOGGLES ===
function toggleMenu(){
  const menu = byId('menuDrawer');
  const backdrop = byId('backdrop');
  if(!menu || !backdrop) return;
  
  const isOpen = menu.classList.contains('open');
  
  if(isOpen){
    menu.classList.remove('open');
    backdrop.classList.remove('show');
  }else{
    closeAll();
    menu.classList.add('open');
    backdrop.classList.add('show');
  }
}

function toggleCart(){
  const drawer = byId('cartDrawer');
  const backdrop = byId('backdrop');
  const isOpen = drawer.classList.contains('open');
  
  if(isOpen){
    drawer.classList.remove('open');
    backdrop.classList.remove('show');
  }else{
    closeAll();
    drawer.classList.add('open');
    backdrop.classList.add('show');
    paintCart();
  }
}

function closeAll(){
  byId('menuDrawer').classList.remove('open');
  byId('cartDrawer').classList.remove('open');
  byId('backdrop').classList.remove('show');
  closeModal();
  closeQuoteModal();
}

function showModal(){
  closeAll();
  byId('modal').classList.add('show');
  byId('backdrop').classList.add('show');
}

function closeModal(){
  byId('modal').classList.remove('show');
  if(!byId('menuDrawer').classList.contains('open') && !byId('cartDrawer').classList.contains('open')){
    byId('backdrop').classList.remove('show');
  }
}

// === PACKAGE SELECTION ===
let currentPackage = null;

function selectPackage(id, name, price){
  // OPTIMIZATION: Direct Add-to-Cart (Fast Path)
  // Ensure price is a number
  const numPrice = Number(price);
  
  console.log('Adding to cart:', { id, name, price, numPrice });
  
  const existing = cart.find(item => item.type === 'package' && item.id === id);
  if(existing){
    existing.qty++;
    console.log('Increased qty for existing item:', existing);
  }else{
    const newItem = { type:'package', id, name, price: numPrice, qty:1 };
    cart.push(newItem);
    console.log('Added new item to cart:', newItem);
  }
  
  console.log('Full cart:', cart);
  
  // Track add to cart
  h2sTrack('AddToCart', {
    product_id: id,
    product_name: name,
    quantity: 1,
    price: numPrice,
    currency: 'USD'
  });
  
  saveCart();
  
  // Open cart to show success
  const drawer = byId('cartDrawer');
  if(drawer && !drawer.classList.contains('open')) toggleCart();
}

function addPackageToCart(){
  if(!currentPackage) return;
  
  const existing = cart.find(item => item.type === 'package' && item.id === currentPackage.id);
  if(existing){
    existing.qty++;
  }else{
    cart.push({ type:'package', ...currentPackage, qty:1 });
  }
  
  // Track add to cart
  h2sTrack('AddToCart', {
    product_id: currentPackage.id,
    product_name: currentPackage.name,
    quantity: 1,
    price: currentPackage.price,
    currency: 'USD'
  });
  
  saveCart();
  closeModal();
  toggleCart();
}

// === CART MODEL ===
function saveCart(){
  try {
    localStorage.setItem('h2s_cart', JSON.stringify(cart));
  } catch(err) {
    console.warn('Failed to save cart to localStorage (may be in private mode):', err);
    // Cart still works in memory, just won't persist across page reloads
  }
  updateCartBadge();
  paintCart();
  syncCartToUrl();
}

function loadCart(){
  try{ 
    const loaded = JSON.parse(localStorage.getItem('h2s_cart')||'[]');
    
    // Clean up any stale/invalid items on load
    // NOTE: Be tolerant of missing price values â€” price is authoritative from server catalog.
    const cleaned = loaded.filter(item => {
      const hasValidQty = Number(item.qty || 0) > 0;
      const hasId = !!(item.id || item.service_id || item.bundle_id);
      if(!hasValidQty || !hasId){
        console.warn('[Cart] Removing invalid item on load (bad qty or missing id):', item);
        return false;
      }
      return true;
    });
    
    // If we cleaned anything, save the cleaned cart
    if(cleaned.length !== loaded.length){
      localStorage.setItem('h2s_cart', JSON.stringify(cleaned));
    }
    
    return cleaned;
  }catch(_){ 
    return []; 
  }
}

function updateQuantity(idx, delta){
  if(!cart[idx]) return;
  
  const newQty = (Number(cart[idx].qty)||1) + delta;
  
  if(newQty <= 0){
    cart.splice(idx, 1);
  }else{
    cart[idx].qty = newQty;
  }
  
  saveCart();
}

// === HERO REVIEW CAROUSEL ===
let heroReviewInterval;
let currentHeroReviewIndex = 0;
let heroReviews = [];

// Fetch real reviews from Vercel endpoint
async function loadHeroReviews() {
  try {
    const reviewsUrl = API.replace('/shop', '/reviews') + '?limit=5&onlyVerified=true';
    console.log('[Hero Reviews] Fetching from:', reviewsUrl);
    
    const res = await fetch(reviewsUrl, {
      cache: 'default' // Use CDN cache
    });
    const data = await res.json();
    
    console.log('[Hero Reviews] Response:', data);
    
    if (data.ok && data.reviews && data.reviews.length > 0) {
      heroReviews = data.reviews.slice(0, 5).map(r => ({
        text: r.text && r.text.trim() ? r.text.trim() : '', // Empty if no text
        author: r.name || 'Customer',
        stars: r.rating || 5
      }))
      // Filter out reviews with no text (show only if they have content)
      .filter(r => r.text.length > 0);
      
      console.log('âœ“ Loaded', heroReviews.length, 'REAL hero reviews from API');
      console.log('[Hero Reviews] First review:', heroReviews[0]);
      return true;
    } else {
      console.warn('[Hero Reviews] Invalid response, using fallback');
    }
  } catch (err) {
    console.error('[Hero Reviews] Fetch failed, using fallback:', err);
  }
  
  // Fallback reviews if API fails (all have content)
  heroReviews = [
    {
      text: "Best TV mounting service! They were on time, professional, and my living room looks amazing.",
      author: "Sarah M.",
      stars: 5
    },
    {
      text: "Had 4 cameras installed. The app setup was seamless and now I have total peace of mind.",
      author: "Mike T.",
      stars: 5
    },
    {
      text: "Quick, clean, professional. They hid all the wires perfectly. Looks like it came with the house!",
      author: "Jennifer L.",
      stars: 5
    },
    {
      text: "Same-day service saved me! TV mounted and streaming setup done in under an hour.",
      author: "David R.",
      stars: 5
    },
    {
      text: "The whole-home security package was a game changer. Professional install, great support.",
      author: "Amanda K.",
      stars: 5
    }
  ];
  return false;
}

async function initHeroReviews() {
  // Load reviews first
  await loadHeroReviews();
  
  const container = byId('heroReviews');
  if (!container || heroReviews.length === 0) return;
  
  // Build review slides HTML (no quotes if text is empty)
  const reviewsHTML = heroReviews.map((review, index) => {
    const hasText = review.text && review.text.trim().length > 0;
    return `
    <div class="hero-review-slide ${index === 0 ? 'active' : ''}" data-index="${index}">
      <div class="hero-review-stars">${'â˜…'.repeat(review.stars)}</div>
      ${hasText ? `<div class="hero-review-text">"${review.text}"</div>` : ''}
      <div class="hero-review-author">â€” ${review.author}</div>
    </div>
  `;
  }).join('');
  
  const dotsHTML = heroReviews.map((_, index) => `
    <div class="hero-review-dot ${index === 0 ? 'active' : ''}" data-index="${index}" onclick="goToHeroReview(${index})"></div>
  `).join('');
  
  container.innerHTML = reviewsHTML + `<div class="hero-review-dots">${dotsHTML}</div>`;
  
  // Click to view all reviews
  container.onclick = () => {
    window.location.href = 'https://home2smart.com/reviews';
  };
  
  // Auto-rotate every 5 seconds
  if (heroReviewInterval) clearInterval(heroReviewInterval);
  heroReviewInterval = setInterval(nextHeroReview, 5000);
}

function nextHeroReview() {
  currentHeroReviewIndex = (currentHeroReviewIndex + 1) % heroReviews.length;
  showHeroReview(currentHeroReviewIndex);
}

function goToHeroReview(index) {
  // Stop propagation so clicking dots doesn't navigate away
  event?.stopPropagation();
  
  currentHeroReviewIndex = index;
  showHeroReview(index);
  
  // Reset auto-rotate timer
  if (heroReviewInterval) clearInterval(heroReviewInterval);
  heroReviewInterval = setInterval(nextHeroReview, 5000);
}

function showHeroReview(index) {
  const slides = document.querySelectorAll('.hero-review-slide');
  const dots = document.querySelectorAll('.hero-review-dot');
  
  slides.forEach((slide, i) => {
    slide.classList.toggle('active', i === index);
  });
  
  dots.forEach((dot, i) => {
    dot.classList.toggle('active', i === index);
  });
}

// === OLD REVIEW CAROUSEL (DEPRECATED - KEEPING FOR REFERENCE) ===
let reviewIndex = 0;
let reviewInterval = null;
let allReviews = [];
let reviewsLoadedFromAPI = false;

async function loadReviews() {
  try {
    console.log('[Reviews] Fetching real reviews from API...');
    const reviews = await fetchReviewsJSONP();
    
    if (reviews && reviews.ok && reviews.items && reviews.items.length > 0) {
      // Take actual reviews from API, filter for quality (rating 4+)
      allReviews = reviews.items
        .filter(r => r.rating >= 4)
        .slice(0, 12);
      
      reviewsLoadedFromAPI = true;
      console.log(`[Reviews] âœ“ Loaded ${allReviews.length} reviews from API (real customer data)`);
      console.log('[Reviews] Sample review:', allReviews[0]);
    } else {
      console.warn('[Reviews] API returned empty or invalid data:', reviews);
      allReviews = [];
    }
  } catch (err) {
    console.error('[Reviews] API fetch failed:', err.message);
    console.error('[Reviews] Full error:', err);
    allReviews = [];
  }
  
  // IMPORTANT: Only show reviews if we have real data, no fake fallbacks
  if (allReviews.length === 0) {
    console.warn('[Reviews] âš  No reviews available, hiding carousel');
    const carousel = document.querySelector('.review-carousel');
    if (carousel) carousel.style.display = 'none';
    return;
  }
  
  console.log('[Reviews] Rendering', allReviews.length, 'reviews');
  renderReviews();
  startCarousel();
  
  // Add indicator in carousel header if using live data
  if (reviewsLoadedFromAPI) {
    const carouselHeader = document.querySelector('.review-carousel-header p');
    if (carouselHeader) {
      carouselHeader.innerHTML = `<span style="color: var(--azure); font-weight: 600;">Live verified reviews</span> from real customers`;
    }
  }
}

function fetchReviewsJSONP() {
  return new Promise((resolve, reject) => {
    const callback = 'reviewsCallback_' + Date.now();
    const timeout = setTimeout(() => {
      if (window[callback]) {
        delete window[callback];
        if (script && script.parentNode) {
          document.body.removeChild(script);
        }
        console.error('[Reviews] âŒ Request timeout after 5s');
        reject(new Error('Reviews API timeout after 5s'));
      }
    }, 5000);
    
    // EXACT SAME AS REVIEWS PAGE: action=public_list, onlyVerified=false, limit=12
    const url = `https://script.google.com/macros/s/AKfycbwJzG7HNL1B53i6_Ryqvb5zEccD-CREbiVR01MRUEnhoaXSZusT8wVj9uJfDaqqMt3D/exec?action=public_list&limit=12&offset=0&onlyVerified=false&callback=${callback}`;
    
    console.log('[Reviews] Making JSONP request to:', url.substring(0, 100) + '...');
    
    window[callback] = (data) => {
      clearTimeout(timeout);
      delete window[callback];
      if (script && script.parentNode) {
        document.body.removeChild(script);
      }
      console.log('[Reviews] âœ“ API response received');
      console.log('[Reviews] Response ok:', data?.ok);
      console.log('[Reviews] Items count:', data?.items?.length || 0);
      if(data?.items?.length > 0){
        console.log('[Reviews] First item:', data.items[0]);
      }
      resolve(data);
    };
    
    const script = document.createElement('script');
    script.src = url;
    script.onerror = (err) => {
      clearTimeout(timeout);
      delete window[callback];
      if (script && script.parentNode) {
        document.body.removeChild(script);
      }
      console.error('[Reviews] âŒ Script load failed:', err);
      reject(new Error('Reviews API script load failed'));
    };
    document.body.appendChild(script);
  });
}

function renderReviews() {
  const track = byId('reviewTrack');
  const nav = byId('reviewNav');
  
  if (!track || !nav) {
    console.error('[Reviews] Carousel DOM elements not found');
    return;
  }
  
  if (allReviews.length === 0) {
    track.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 40px;">No reviews available</p>';
    return;
  }
  
  track.innerHTML = allReviews.map((review, index) => {
    // ACTUAL API FIELD NAMES: display_name, review_text, services_selected, rating, timestamp_iso
    const displayName = review.display_name || 'Customer';
    const initials = displayName
      .split(' ')
      .map(n => n[0])
      .join('')
      .toUpperCase()
      .slice(0, 2);
    
    const rating = Number(review.rating || 5);
    const stars = 'â˜…'.repeat(rating);
    const greyStars = 'â˜†'.repeat(5 - rating);
    
    // Escape HTML to prevent XSS
    const escapedName = displayName.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const escapedText = (review.review_text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // services_selected is comma-separated string
    const services = review.services_selected ? review.services_selected.split(',')[0].trim() : 'Smart Home Service';
    const escapedService = services.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // Format date EXACTLY like reviews page: "Jan 15, 2025" format
    let formattedDate = '';
    if (review.timestamp_iso) {
      try {
        const date = new Date(review.timestamp_iso);
        formattedDate = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
      } catch(e) {
        formattedDate = '';
      }
    }
    
    return `
      <div class="review-card" data-index="${index}">
        <div class="review-header">
          <div class="review-avatar">${initials}</div>
          <div class="review-meta">
            <div class="review-name">${escapedName}</div>
            <div class="review-stars">${stars}${greyStars}</div>
            ${formattedDate ? `<div class="review-time">${formattedDate}</div>` : ''}
          </div>
        </div>
        <p class="review-text">${escapedText}</p>
        <div class="review-footer">
          <div class="review-service">${escapedService}</div>
          ${review.verified ? '<div class="review-verified">Verified Customer</div>' : ''}
        </div>
      </div>
    `;
  }).join('');
  
  // Create dots for pages, not individual reviews
  const slidesPerView = window.innerWidth >= 1024 ? 3 : window.innerWidth >= 768 ? 2 : 1;
  const totalPages = Math.ceil(allReviews.length / slidesPerView);
  
  nav.innerHTML = Array.from({length: totalPages}, (_, i) => 
    `<div class="review-dot ${i === 0 ? 'active' : ''}" onclick="goToReview(${i})" aria-label="Go to page ${i + 1}"></div>`
  ).join('');
  
  console.log(`[Reviews] Rendered ${allReviews.length} review cards (${totalPages} pages, ${slidesPerView} per page)`);
}

function startCarousel() {
  if (reviewInterval) clearInterval(reviewInterval);
  
  // Only auto-rotate if we have multiple pages of reviews
  const slidesPerView = window.innerWidth >= 1024 ? 3 : window.innerWidth >= 768 ? 2 : 1;
  const totalPages = Math.ceil(allReviews.length / slidesPerView);
  
  if (totalPages <= 1) return;
  
  reviewInterval = setInterval(() => {
    // Move to next page (group of 3)
    reviewIndex++;
    if (reviewIndex >= totalPages) {
      reviewIndex = 0;
    }
    updateCarousel();
  }, 5000);
  
  // Pause on hover
  const carousel = document.querySelector('.review-carousel');
  if (carousel) {
    carousel.addEventListener('mouseenter', () => {
      if (reviewInterval) clearInterval(reviewInterval);
    });
    carousel.addEventListener('mouseleave', () => {
      startCarousel();
    });
  }
}

function goToReview(pageIndex) {
  reviewIndex = pageIndex;
  updateCarousel();
  startCarousel(); // Reset timer
}

function updateCarousel() {
  const track = byId('reviewTrack');
  const dots = document.querySelectorAll('.review-dot');
  
  if (!track || allReviews.length === 0) return;
  
  // FIXED: Always 3 per view on desktop, 2 on tablet, 1 on mobile
  const slidesPerView = window.innerWidth >= 1024 ? 3 : window.innerWidth >= 768 ? 2 : 1;
  const totalPages = Math.ceil(allReviews.length / slidesPerView);
  const safeIndex = Math.min(reviewIndex, totalPages - 1);
  
  // Move by full page width (showing 3 cards at a time, no bleed)
  const offset = -safeIndex * 100;
  track.style.transform = `translateX(${offset}%)`;
  
  // Update active dot
  dots.forEach((dot, i) => {
    dot.classList.toggle('active', i === safeIndex);
  });
  
  console.log(`[Reviews] Showing page ${safeIndex + 1}/${totalPages} (${slidesPerView} reviews per page)`);
}

// Debounced resize handler for carousel
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    if (allReviews.length > 0) updateCarousel();
  }, 150);
});

// Load reviews on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadReviews);
} else {
  loadReviews();
}

function encodeCartToUrl(cartItems = cart){
  if(!cartItems || !cartItems.length) return '';
  return cartItems.map(item => {
    if(item.type === 'package') return `pkg:${item.id}*${item.qty}`;
   
    const svc = item.service_id || '';
    const opt = item.option_id ? `:${item.option_id}` : '';
    return `${svc}${opt}*${item.qty}`;
  }).join(',');
}

function decodeCartFromUrl(cartParam){
  if(!cartParam) return [];
  const items = String(cartParam).split(',');
  return items.map(item => {
    const parts = item.split('*');
    const qty = Number(parts[1]) || 1;
    const servicePart = parts[0];
    
    if(servicePart.startsWith('pkg:')){
      const bundle_id = servicePart.replace('pkg:', '');
      
      // Look up actual bundle from catalog to get real price
      const bundle = catalog.bundles?.find(b => b.bundle_id === bundle_id);
      
      if(!bundle){
        console.warn('[Cart] Bundle not found in catalog:', bundle_id);
        return null;
      }
      
      return { 
        type: 'package', 
        id: bundle_id, 
        name: bundle.name || bundle_id,
        price: Number(bundle.bundle_price || 0),
        qty 
      };
    }
    
    const [service_id, option_id] = servicePart.split(':');
    return { service_id, qty, option_id: option_id || null };
  }).filter(item => item !== null && (item.service_id || item.id));
}

function syncCartToUrl(){
  // DISABLED: Cart persistence via URL causes issues on refresh
  // Cart is saved to localStorage which is more reliable
  // If you need shareable cart links, use a different approach
  return;
  
  /* OLD CODE:
  const url = new URL(location.href);
  if(cart.length){
    url.searchParams.set('cart', encodeCartToUrl());
  }else{
    url.searchParams.delete('cart');
  }
  history.replaceState({}, '', url.toString());
  */
}

function saveUser(){
  try {
    localStorage.setItem('h2s_user', JSON.stringify(user||{}));
  } catch(err) {
    console.warn('Failed to save user to localStorage:', err);
  }
  renderSigninState();
}

function loadUser(){
  try{ return JSON.parse(localStorage.getItem('h2s_user')||'{}'); }catch(_){ return {}; }
}

function updateCartBadge(){
  const count = cart.reduce((n,l)=> n + Number(l.qty||0), 0);
  byId('cartCount').textContent = count;
}

function cartSubtotal(lines=cart){
  return lines.reduce((sum, ln)=>{
    if(ln.type === 'package'){
      return sum + (Number(ln.price||0) * Number(ln.qty||1));
    }
    // For future service items
    return sum;
  }, 0);
}

// === CART PAINT ===
function paintCart(){
  const items = byId('cartItems');
  const emptyState = byId('cartEmpty');
  const subtotal = byId('cartSubtotal');
  const itemCount = byId('cartItemCount');
  const signinBanner = byId('signinBanner');
  
  console.log('paintCart called, cart:', cart);
  
  if(!items || !emptyState || !subtotal) return;
  
  // Show/hide sign-in banner
  if(signinBanner){
    if(!user || !user.email){
      signinBanner.style.display = 'flex';
      const btn = byId('bannerSignIn');
      if(btn) btn.onclick = ()=> { closeAll(); navSet({view:'signin'}); };
    }else{
      signinBanner.style.display = 'none';
    }
  }
  
  if(!cart.length){
    emptyState.hidden = false;
    items.innerHTML = '';
    subtotal.textContent = '$0.00';
    if(itemCount) itemCount.textContent = '0 items';
    return;
  }
  
  emptyState.hidden = true;
  
  let cartSubtotalVal = 0;
  let totalQty = 0;
  
  items.innerHTML = cart.map((item, idx) => {
    const qty = Number(item.qty||1);
    // Prefer server catalog price for packages; fallback to stored item.price
    let itemPrice = Number(item.price||0);
    if(item.type === 'package'){
      const bundle = catalog.bundles?.find(b => b.bundle_id === item.id);
      if(bundle && bundle.bundle_price !== undefined && bundle.bundle_price !== null){
        itemPrice = Number(bundle.bundle_price || itemPrice || 0);
      }
    }
    const itemTotal = itemPrice * qty;
    
    console.log(`Item ${idx}:`, { item, qty, itemPrice, itemTotal });
    
    cartSubtotalVal += itemTotal;
    totalQty += qty;
    
    return `
      <div class="cart-item">
        <div class="cart-item-info">
          <div class="cart-item-name">${escapeHtml(item.name||item.id||'Item')}</div>
          <div class="cart-item-price">${money(itemPrice)} each</div>
          
          <div class="cart-qty-controls">
            <button 
              class="cart-qty-btn"
              onclick="updateQuantity(${idx}, -1)"
              aria-label="Decrease quantity"
            >âˆ’</button>
            
            <span class="cart-qty-value">${qty}</span>
            
            <button 
              class="cart-qty-btn"
              onclick="updateQuantity(${idx}, 1)"
              aria-label="Increase quantity"
            >+</button>
          </div>
        </div>
        
        <div class="cart-item-right">
          <div class="cart-item-total">${money(itemTotal)}</div>
          <button 
            class="cart-remove-btn"
            onclick="removeFromCart(${idx})"
          >Remove</button>
        </div>
      </div>
    `;
  }).join('');
  
  console.log('Cart subtotal:', cartSubtotalVal);
  
  subtotal.textContent = money(cartSubtotalVal);
  if(itemCount) itemCount.textContent = `${totalQty} item${totalQty === 1 ? '' : 's'}`;
  
  renderSigninState();
  
  // Update recommendation panels
  renderBundlePanel();
  renderRecsPanel();
}

function removeFromCart(idx){
  cart.splice(idx, 1);
  saveCart();
}

// === AI RECOMMENDATIONS ===
async function loadAIRecommendations(){
  if(!user || !user.email) return;
  
  try{
    const res = await fetch(`${API}?action=ai_sales&email=${encodeURIComponent(user.email)}&mode=recommendations`);
    const data = await res.json();
    
    if(!data.success || !data.ai_analysis || !data.ai_analysis.recommendations) return;
    
    const recs = data.ai_analysis.recommendations.slice(0, 3);
    if(recs.length === 0) return;
    
    renderAIRecommendations(recs);
  }catch(err){
    console.error('Failed to load AI recommendations:', err);
  }
}

function renderAIRecommendations(recs){
  const panel = byId('aiRecommendationsPanel');
  const container = byId('aiRecommendations');
  if(!panel || !container) return;
  
  const html = recs.map(rec => {
    const service = rec.service || rec.title || 'Recommended Service';
    const reason = rec.thought_spark || rec.reason || '';
    const price = rec.price || 0;
    
    return `
      <div class="ai-rec-card">
        <div class="ai-rec-name">${escapeHtml(service)}</div>
        <div class="ai-rec-reason">"${escapeHtml(reason)}"</div>
        ${price > 0 ? `<div class="ai-rec-price" style="margin-top:8px;font-size:14px;color:var(--muted);">Starting at ${money(price)}</div>` : ''}
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
  panel.style.display = 'block';
}

// === BUNDLE RECOMMENDATIONS (Smart Swap) ===
function bundlesMatchingCart(){
  const rec = [];
  const bundles = (catalog.bundles||[]).filter(b => b.active!==false);
  
  for(const b of bundles){
    const plan = calcBundlePlan(b);
    if(plan && plan.savings > 0) rec.push(plan);
  }
  
  rec.sort((a,b)=> b.savings - a.savings);
  return rec;
}

function calcBundlePlan(bundle){
  const recipe = (catalog.bundleItems||[]).filter(it => String(it.bundle_id)===String(bundle.bundle_id));
  if(!recipe.length) return null;

  const use = {};
  for(const item of recipe){
    const need = Number(item.required_qty||0);
    const have = cart.find(l => !l.type && String(l.service_id)===String(item.service_id));
    if(!have || Number(have.qty||0) < need) return null;
    use[item.service_id] = need;
  }

  let requiredCost = 0;
  for(const item of recipe){
    const tier = pickTier(item.service_id, Number(item.required_qty||0), null) || pickTier(item.service_id, 1, null);
    const unit = tier ? Number(tier.unit||0) : 0;
    requiredCost += unit * Number(item.required_qty||0);
  }

  const bundlePrice = Number(bundle.bundle_price||0);
  const savings = Math.max(0, requiredCost - bundlePrice);

  const serviceMap = indexBy((catalog.services||[]), 'service_id');
  const lineList = recipe.map(r=>{
    const s = serviceMap[r.service_id];
    return `${Number(r.required_qty||0)} Ã— ${(s && s.name) ? s.name : r.service_id}`;
  });

  return {
    bundle_id: bundle.bundle_id,
    name: bundle.name || bundle.bundle_id,
    image_url: bundle.image_url || '',
    savings,
    requiredCost,
    bundlePrice,
    use,
    recipeList: lineList
  };
}

function applyBundleSwap(bundle_id){
  const plan = bundlesMatchingCart().find(p=> p.bundle_id===bundle_id);
  if(!plan) return;
  
  Object.entries(plan.use).forEach(([sid, reqQty])=>{
    const ln = cart.find(l=> !l.type && l.service_id===sid);
    if(!ln) return;
    ln.qty = Math.max(0, Number(ln.qty||0) - Number(reqQty||0));
  });
  
  cart = cart.filter(l=> !( !l.type && Number(l.qty||0)===0 ));
  const existing = cart.find(l=> l.type==='bundle' && l.bundle_id===bundle_id);
  if(existing) existing.qty += 1;
  else cart.push({ type:'bundle', bundle_id, qty:1 });
  
  saveCart();
}

function renderBundlePanel(){
  const panel = byId('bundlePanel');
  if(!panel) return;
  
  const suggestions = bundlesMatchingCart();
  if(!suggestions.length){ 
    panel.style.display='none'; 
    panel.innerHTML=''; 
    return; 
  }

  panel.style.display='';
  panel.innerHTML = suggestions.map(p=>`
    <div class="bundle-card">
      <div class="b-head">
        <div class="b-name">${escapeHtml(p.name)}</div>
        <div class="b-save">Save ${money(p.savings)}</div>
      </div>
      <div class="b-list">${p.recipeList.map(escapeHtml).join(' â€¢ ')}</div>
      <div class="b-actions">
        <button class="btn btn-primary" data-apply="${p.bundle_id}">Swap & Save</button>
      </div>
    </div>
  `).join('');

  panel.querySelectorAll('[data-apply]').forEach(btn=>{
    btn.onclick = ()=> applyBundleSwap(btn.getAttribute('data-apply'));
  });
}

// === RULE-BASED RECOMMENDATIONS ===
const REC_DISMISS_PREFIX = 'h2s_rec_dismiss_';

function cartSignature(){
  const qtyByService = {};
  (cart||[]).forEach(l=>{
    if(l.type==='bundle') return;
    qtyByService[l.service_id] = (qtyByService[l.service_id]||0) + Number(l.qty||0);
  });
  const ids = Object.keys(qtyByService).sort();
  return ids.map(id=>id+':'+qtyByService[id]).join('|');
}

function getDismissedRecsForSig(sig){
  try{
    const raw = localStorage.getItem(REC_DISMISS_PREFIX + sig);
    return raw ? JSON.parse(raw) : [];
  }catch(_){ return []; }
}

function setDismissedRecsForSig(sig, list){
  try{ 
    localStorage.setItem(REC_DISMISS_PREFIX + sig, JSON.stringify(Array.from(new Set(list)))); 
  }catch(_){}
}

function dismissRec(service_id){
  const sig = cartSignature();
  const cur = getDismissedRecsForSig(sig);
  if(!cur.includes(service_id)){
    cur.push(service_id);
    setDismissedRecsForSig(sig, cur);
  }
  renderRecsPanel();
}

function recommendationsMatchingCart(){
  const rules = (catalog.recommendations||[]).filter(r => r.active!==false);
  if(!rules.length) return [];

  const qtyByService = {};
  (cart||[]).forEach(l=>{
    if(l.type==='bundle') return;
    qtyByService[l.service_id] = (qtyByService[l.service_id]||0) + Number(l.qty||0);
  });

  const hits = [];
  const seen = new Set();

  rules.forEach(r=>{
    const trig = String(r.trigger_type||'').toLowerCase().replace('_','-');
    if(trig==='service-qty'){
      const sid = String(r.trigger_service_id||'').trim();
      const need = Number(r.min_qty||0);
      const have = Number(qtyByService[sid]||0);
      if(have >= need){
        const recSid = String(r.recommended_service_id||'').trim();
        if(!recSid) return;
        if(seen.has(recSid)) return;
        const already = Number(qtyByService[recSid]||0) > 0;
        if(already) return;

        seen.add(recSid);
        hits.push({ rule: r, service_id: recSid });
      }
    }
  });

  hits.sort((a,b)=>{
    const sa = Number(a.rule.sort||9999), sb = Number(b.rule.sort||9999);
    if(sa!==sb) return sa - sb;
    return String(a.rule.message||'').localeCompare(String(b.rule.message||''));
  });

  return hits;
}

function renderRecsPanel(){
  const panel = byId('recsPanel');
  if(!panel) return;

  const sig = cartSignature();
  const dismissed = new Set(getDismissedRecsForSig(sig));

  const recs = recommendationsMatchingCart()
    .filter(({service_id})=> !dismissed.has(service_id));

  if(!recs.length){ 
    panel.style.display='none'; 
    panel.innerHTML=''; 
    return; 
  }

  const svcMap = indexBy(catalog.services||[], 'service_id');
  const visible = recs.slice(0, 4);

  panel.style.display='';
  panel.innerHTML = visible.map(({rule, service_id})=>{
    const svc = svcMap[service_id] || {};
    const external = String(svc.checkout_type||'cart')==='external';
    const unit = external ? null : (pickTier(service_id, Math.max(1, Number(svc.min_qty||1)), null)?.unit || 0);
    const pricePart = external ? '' : `<div class="r-price">${money(unit)}</div>`;
    const img = rule.image_url || svc.image_url || '';
    const title = svc.name || service_id;
    const msg = rule.message || '';
    const cta = external
      ? `<a class="btn btn-primary" href="${svc.external_url||'#'}" target="_blank" rel="noopener">Open</a>`
      : `<button class="btn btn-primary" data-rec-add="${service_id}">Add</button>`;
    const dismiss = `<button class="rec-dismiss" data-rec-dismiss="${service_id}" aria-label="Dismiss ${escapeAttr(title)}">Dismiss</button>`;
    
    return `
      <div class="rec-card">
        <img src="${img}" alt="${escapeHtml(title)}" width="800" height="800" loading="lazy" decoding="async">
        <div class="r-text">
          <div class="r-title">${escapeHtml(title)}</div>
          <div class="r-msg">${escapeHtml(msg)}</div>
          ${dismiss}
        </div>
        <div style="display:grid; gap:6px; justify-items:end">
          ${pricePart}
          ${cta}
        </div>
      </div>
    `;
  }).join('');

  panel.querySelectorAll('[data-rec-add]').forEach(btn=>{
    btn.onclick = ()=> {
      const service_id = btn.getAttribute('data-rec-add');
      addToCart(service_id, 1, null);
    };
  });
  
  panel.querySelectorAll('[data-rec-dismiss]').forEach(btn=>{
    btn.onclick = ()=> dismissRec(btn.getAttribute('data-rec-dismiss'));
  });
}

// === CHECKOUT ===
function showCheckoutError(msg){
  const errorDiv = byId('checkoutError');
  const errorMsg = byId('checkoutErrorMsg');
  const dismissBtn = byId('dismissError');
  
  if(errorDiv && errorMsg){
    errorMsg.textContent = msg;
    errorDiv.hidden = false;
    
    if(dismissBtn){
      dismissBtn.onclick = ()=> errorDiv.hidden = true;
    }
    
    // Auto-hide after 8 seconds
    setTimeout(()=> errorDiv.hidden = true, 8000);
  }
}

async function checkout(){
  if(!cart.length){
    showCheckoutError('Your cart is empty. Add packages before checking out.');
    return;
  }
  
  // Validate bundles have stripe_price_id
  const invalidBundles = cart.filter(item => {
    if(item.type !== 'package') return false;
    const bundle = catalog.bundles.find(b => b.bundle_id === item.id);
    return !bundle || !bundle.stripe_price_id;
  });
  
  if(invalidBundles.length > 0){
    // Try a forced catalog reload (cache-bust) to avoid requiring a browser cache clear
    console.warn('Bundles appear to be missing stripe_price_id on client. Attempting to refresh catalog from server...');
    const reloaded = await fetchCatalogFromAPI(true);
    if(reloaded){
      // Re-evaluate
      const stillInvalid = cart.filter(item => {
        if(item.type !== 'package') return false;
        const bundle = catalog.bundles.find(b => b.bundle_id === item.id);
        return !bundle || !bundle.stripe_price_id;
      });
      if(stillInvalid.length === 0){
        console.log('Catalog refresh fixed missing stripe_price_id issues. Continuing checkout.');
      } else {
        console.warn('After refresh, some bundles still missing stripe_price_id:', stillInvalid.map(b=>b.id));
        // Do not block the user â€” proceed and let backend perform authoritative lookup and session creation
        showCheckoutError('Some package metadata is stale locally. Proceeding with server-side validation â€” you should be redirected shortly.');
      }
    } else {
      console.warn('Catalog refresh failed. Proceeding with server-side validation to avoid blocking user.');
      showCheckoutError('Unable to refresh product catalog. Proceeding to checkout and attempting server-side validation.');
    }
  }
  
  if(!user || !user.email){
    showGuestCheckoutForm();
    return;
  }
  
  proceedToStripeCheckout(user);
}

function showGuestCheckoutForm(){
  const cartFoot = document.querySelector('.cart-foot');
  if(!cartFoot) return;
  
  const existingForm = byId('guestCheckoutForm');
  if(existingForm) existingForm.remove();
  
  const form = document.createElement('div');
  form.id = 'guestCheckoutForm';
  form.style.cssText = 'padding:16px;border:1px solid #e7eaf0;border-radius:12px;background:#fafcff;margin-bottom:16px;';
  
  const itemCount = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
  const subtotal = cartSubtotal();
  
  form.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div style="font-weight:800;font-size:16px;color:var(--cobalt);">Continue as guest</div>
      <button id="hideGuestForm" class="link-btn" style="font-size:13px;color:#6b778c;">â† Back</button>
    </div>
    <div style="margin-bottom:10px;padding:10px;background:#f5f9ff;border:1px solid #d7eafc;border-radius:8px;font-size:13px;color:#0a2a5a;">
      <strong>${itemCount} item${itemCount !== 1 ? 's' : ''} â€¢ $${subtotal.toFixed(2)}</strong>
    </div>
    <div style="margin-bottom:10px;font-size:13px;color:#6b778c;">We'll email your receipt. <a href="#" id="switchToSignIn" style="color:var(--azure);text-decoration:underline;">Sign in instead</a></div>
    <input type="email" id="guestEmail" class="inp" placeholder="Email address" style="margin-bottom:8px;width:100%;" required>
    <input type="text" id="guestName" class="inp" placeholder="Full name" style="margin-bottom:8px;width:100%;">
    <input type="tel" id="guestPhone" class="inp" placeholder="Phone (optional)" style="margin-bottom:12px;width:100%;">
    <button class="btn btn-primary" id="continueAsGuest" style="width:100%;">Continue to payment</button>
    <div id="guestMsg" class="help" style="margin-top:8px;color:#d32f2f;"></div>
  `;
  
  // Insert before totals
  const totals = cartFoot.querySelector('.totals');
  if(totals){
    cartFoot.insertBefore(form, totals);
  }else{
    cartFoot.insertBefore(form, cartFoot.firstChild);
  }
  
  byId('hideGuestForm').onclick = (e) => {
    e.preventDefault();
    form.remove();
  };
  
  byId('switchToSignIn').onclick = (e) => {
    e.preventDefault();
    closeAll();
    navSet({view:'signin'});
  };
  
  byId('continueAsGuest').onclick = async () => {
    const email = byId('guestEmail').value.trim().toLowerCase();
    const name = byId('guestName').value.trim();
    const phone = byId('guestPhone').value.trim();
    const msg = byId('guestMsg');
    const btn = byId('continueAsGuest');
    
    if(!email || !email.includes('@')){
      msg.textContent = 'Please enter a valid email address.';
      return;
    }
    
    msg.textContent = '';
    btn.disabled = true;
    btn.textContent = 'Creating checkout session...';
    
    try {
      const guestUser = { email, name, phone };
      await proceedToStripeCheckout(guestUser);
    } catch(err) {
      btn.disabled = false;
      btn.textContent = 'Continue to payment';
      msg.textContent = 'Checkout failed. Please try again.';
      showCheckoutError('Checkout failed: ' + err.message);
    }
  };
}

async function proceedToStripeCheckout(customer){
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘              CHECKOUT STARTING                                 â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('Customer:', customer);
  console.log('Cart items:', cart.length);
  console.table(cart);
  
  // CRITICAL: Check catalog is loaded
  if(!catalog || !catalog.bundles || catalog.bundles.length === 0){
    console.error('âŒ Catalog not loaded! Attempting to reload...');
    showLoader();
    try{
      const res = await fetch(API + '?action=catalog');
      const data = await res.json();
      if(data.ok && data.catalog){
        catalog = data.catalog;
        console.log('âœ… Catalog reloaded:', catalog.bundles?.length || 0, 'bundles');
      } else {
        throw new Error('Failed to load catalog');
      }
    } catch(err) {
      hideLoader();
      console.error('âŒ Catalog reload failed:', err);
      showCheckoutError('Unable to load product catalog. Please refresh the page and try again.');
      return;
    } finally {
      hideLoader();
    }
  }
  
  console.log('âœ… Catalog ready:', catalog.bundles?.length || 0, 'bundles\n');
  
  // CRITICAL: Validate cart items against catalog BEFORE sending to backend
  const validationErrors = [];
  cart.forEach((item, idx) => {
    if(item.type === 'package'){
      const bundle = catalog.bundles?.find(b => b.bundle_id === item.id);
      if(!bundle){
        validationErrors.push(`Cart item ${idx}: Bundle "${item.id}" not found in catalog`);
      } else if(!bundle.stripe_price_id){
        validationErrors.push(`Cart item ${idx}: Bundle "${item.id}" missing stripe_price_id`);
      } else {
        console.log(`âœ… Bundle validated: ${item.id} â†’ ${bundle.stripe_price_id}`);
      }
    }
  });

  let clientCatalogOk = true;
  if(validationErrors.length > 0){
    console.error('âŒ CART VALIDATION FAILED:');
    validationErrors.forEach(err => console.error('  - ' + err));

    // Attempt a forced refresh from the server to avoid requiring a hard browser cache clear
    console.warn('Attempting forced catalog refresh (cache-bust) to resolve missing bundle metadata...');
    const reloaded = await fetchCatalogFromAPI(true);
    if(reloaded){
      // Re-run validation once
      const rerunErrors = [];
      cart.forEach((item, idx) => {
        if(item.type === 'package'){
          const bundle = catalog.bundles?.find(b => b.bundle_id === item.id);
          if(!bundle) rerunErrors.push(`Cart item ${idx}: Bundle "${item.id}" not found in catalog`);
          else if(!bundle.stripe_price_id) rerunErrors.push(`Cart item ${idx}: Bundle "${item.id}" missing stripe_price_id`);
        }
      });
      if(rerunErrors.length === 0){
        console.log('Catalog refresh resolved validation errors. Proceeding.');
      } else {
        console.warn('After refresh, validation still reports issues:', rerunErrors);
        clientCatalogOk = false;
        showCheckoutError('Local product data appears stale. Proceeding and letting server perform authoritative pricing checks.');
      }
    } else {
      console.warn('Forced catalog refresh failed; will proceed and let server validate to avoid blocking users.');
      clientCatalogOk = false;
      showCheckoutError('Unable to refresh product catalog locally. Proceeding and using server-side catalog for pricing.');
    }
  }

  console.log('âœ… Cart validation (client-side) complete â€” clientCatalogOk=', clientCatalogOk, '\n');
  
  localStorage.setItem('h2s_checkout_snapshot', JSON.stringify({
    cart: cart.slice(),
    user: { ...customer },
    subtotal: cartSubtotal(),
    currency: 'USD',
    source: '/shop',
    created_at: new Date().toISOString()
  }));

  const payload = {
    __action: 'create_session',
    customer: { name:customer.name||'', email:customer.email||'', phone:customer.phone||'' },
    client_catalog_ok: clientCatalogOk,
    cart: cart.map(l => l.type==='package'
      ? ({type:'bundle', bundle_id:l.id, qty:l.qty})
      : ({service_id:l.service_id, qty:l.qty, option_id: l.option_id||null})),
    source: '/shop'
  };
  
  console.log('\nðŸ“¤ PAYLOAD BEING SENT TO BACKEND:');
  console.log(JSON.stringify(payload, null, 2));

  // Add promo code if present
  const promoCode = localStorage.getItem('h2s_promo_code');
  if(promoCode){
    payload.promo_code_string = promoCode;
  }

  // Log package bundle IDs for backend setup verification
  const packageIds = cart.filter(l => l.type==='package').map(l => l.id);
  if(packageIds.length > 0){
    console.log('ðŸ“¦ [Packages] Bundle IDs being sent:', packageIds);
    console.log('âš ï¸ [Backend Setup] Ensure these bundle_ids exist in your Google Sheets "Bundles" tab with stripe_price_id values');
  }

  h2sTrack('InitiateCheckout', {
    cart_total: cartSubtotal(),
    currency: 'USD',
    num_items: cart.reduce((n,l)=> n + Number(l.qty||0), 0)
  });

  showLoader();
  try{
    console.log('\nðŸ›’ Sending request to backend...');
    console.log('API endpoint:', API);
    
    const resp = await fetch(API, { 
      method:'POST', 
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'application/json' }
    });
    
    const txt = await resp.text();
    
    console.log('\nðŸ“¥ BACKEND RESPONSE:');
    console.log('Status:', resp.status, resp.ok ? 'âœ…' : 'âŒ');
    console.log('Headers:', Object.fromEntries(resp.headers.entries()));
    console.log('Body (first 500 chars):', txt.substring(0, 500));
    
    if(!resp.ok){ 
      console.error('âŒ HTTP error:', resp.status);
      console.error('Full response:', txt);
      showCheckoutError(`Backend error (${resp.status}): ${txt.substring(0, 150)}`);
      return;
    }
    
    let data = {}; 
    try{ 
      data = JSON.parse(txt); 
      console.log('\nâœ… Parsed JSON response:');
      console.log(JSON.stringify(data, null, 2));
    }catch(parseErr){
      console.error('âŒ JSON parse failed:', parseErr);
      console.error('Raw response:', txt);
      showCheckoutError('Invalid response from server. Please try again.');
      return;
    }
    
    // Check for backend error response
    if(data.error || !data.ok){
      console.error('âŒ Backend error:', data.error || 'Unknown');
      console.error('Full error data:', data);
      showCheckoutError(data.error || 'Checkout failed. Please contact support.');
      return;
    }
    
    const url = data?.pay?.session_url;
    if(!url){
      console.error('âŒ No checkout URL in response');
      console.error('Response structure:', {
        hasPayProp: !!data.pay,
        payKeys: data.pay ? Object.keys(data.pay) : 'N/A',
        fullData: data
      });
      showCheckoutError('Could not create checkout session. Missing Stripe URL.');
      return;
    }
    
    console.log('\nâœ… CHECKOUT SESSION CREATED SUCCESSFULLY!');
    console.log('Session URL:', url);
    console.log('Redirecting to Stripe checkout...\n');
    
    // Track checkout before redirect
    h2sTrack('BeginCheckout', {
      cart_total: cartSubtotal(),
      session_url: url
    });
    
    // Redirect immediately - no delay, keep loader visible
    window.location.href = url;
    
  }catch(err){
    console.error('âŒ Network error during checkout:', err);
    showCheckoutError('Network error: ' + err.message);
    hideLoader();
  }
}

// === SUCCESS PAGE ===
async function renderShopSuccess(){
  const params = new URL(location.href).searchParams;
  const sessionId = params.get('session_id') || params.get('stripe_session_id') || '';

  let order = {
    order_id:           params.get('order_id') || '',
    stripe_session_id:  sessionId,
    order_created_at:   params.get('order_created_at') || new Date().toISOString(),
    order_source:       params.get('order_source') || '/shop',
    order_total:        params.get('order_total') || '',
    order_subtotal:     params.get('order_subtotal') || '',
    order_tax:          params.get('order_tax') || '',
    order_fees:         params.get('order_fees') || '',
    order_currency:     params.get('order_currency') || 'USD',
    order_discount_code:   params.get('order_discount_code') || '',
    order_discount_amount: params.get('order_discount_amount') || '',
    order_item_count:   params.get('order_item_count') || '',
    order_summary:      params.get('order_summary') || '',
    order_lines_json:   params.get('order_lines_json') || '',
    bundle_applied:     params.get('bundle_applied') || '',
    membership_plan:    params.get('membership_plan') || '',
    utm_source:   params.get('utm_source') || '',
    utm_medium:   params.get('utm_medium') || '',
    utm_campaign: params.get('utm_campaign') || '',
    utm_term:     params.get('utm_term') || '',
    utm_content:  params.get('utm_content') || ''
  };

  // PRIORITY 1: Mark session as success_redirect in backend
  if(sessionId){
    try{
      await fetch(API, {
        method: 'POST',
        body: JSON.stringify({
          __action: 'mark_session',
          session_id: sessionId,
          status: 'success_redirect',
          note: 'User returned from Stripe at ' + new Date().toISOString()
        })
      });
      console.log('âœ“ Marked session as success_redirect:', sessionId);
    }catch(err){
      console.error('Failed to mark session:', err);
    }
  }

  // PRIORITY 2: Fetch authoritative order data from backend (includes promo codes, discounts)
  if(sessionId){
    try{
      const res = await fetch(`${API}?action=orderpack&session_id=${sessionId}`);
      const data = await res.json();
      if(data.ok && data.summary){
        console.log('âœ“ Fetched order pack from backend:', data.summary.order_id);
        order.order_id = data.summary.order_id || sessionId;
        order.order_total = typeof data.summary.total === 'number' ? String(data.summary.total.toFixed(2)) : (data.summary.total || '');
        order.order_subtotal = typeof data.summary.subtotal === 'number' ? String(data.summary.subtotal.toFixed(2)) : (data.summary.subtotal || '');
        order.order_currency = data.summary.currency || 'USD';
        order.order_item_count = String(data.lines?.length || 0);
        order.order_created_at = data.summary.created_at || order.order_created_at;
        order.order_discount_code = data.summary.discount_code || '';
        order.order_discount_amount = data.summary.discount_amount || '';
        
        // Build summary from line items
        const parts = [];
        (data.lines||[]).forEach(l => {
          if(String(l.line_type||'') === 'bundle'){
            const bundleName = l.bundle_id || 'Bundle';
            parts.push(`${Number(l.qty||1)}Ã— ${bundleName}`);
          }else{
            const serviceName = l.service_id || 'Service';
            parts.push(`${Number(l.qty||0)}Ã— ${serviceName}`);
          }
        });
        order.order_summary = parts.join(' | ');
      }else{
        console.warn('Backend orderpack returned no data, falling back to localStorage');
      }
    }catch(err){
      console.error('Failed to fetch order pack:', err);
    }
  }

  // Fallback to snapshot if backend fetch failed
  if(!order.order_id || !order.order_summary){
    try{
      const snap = JSON.parse(localStorage.getItem('h2s_checkout_snapshot') || '{}');
      if(Array.isArray(snap.cart)){
        console.log('âš  Using localStorage fallback for order data');
        if(!order.order_item_count) order.order_item_count = String(snap.cart.reduce((n,l)=> n + Number(l.qty||0), 0));
        if(!order.order_subtotal) order.order_subtotal = typeof snap.subtotal === 'number' ? String(snap.subtotal.toFixed(2)) : '';
        if(!order.order_currency) order.order_currency = snap.currency || 'USD';
        
        if(!order.order_summary){
          const parts = [];
          snap.cart.forEach(l=>{
            if(l.type==='package'){
              parts.push(`${Number(l.qty||1)}Ã— ${l.name||'Package'}`);
            }else{
              parts.push(`${Number(l.qty||0)}Ã— ${l.service_id||'Service'}`);
            }
          });
          order.order_summary = parts.join(' | ');
        }
        
        if(!order.order_lines_json) order.order_lines_json = encodeURIComponent(JSON.stringify(snap.cart||[]));
        if(!order.order_created_at) order.order_created_at = snap.created_at || new Date().toISOString();
        if(!order.order_source) order.order_source = snap.source || '/shop';
        
        // If we never got an explicit order_id, at least set to session id
        if(!order.order_id){
          order.order_id = sessionId || '';
        }
      }
    }catch(err){
      console.error('Failed to parse localStorage snapshot:', err);
    }
  }

  // Prefill contact from local user or params
  const name = (user?.name||params.get('name')||'').trim();
  const [first_name, ...rest] = name.split(' ');
  const last_name = rest.join(' ');
  const email = (user?.email||params.get('email')||'').trim();
  const phone = (user?.phone||params.get('phone')||'').trim();

  // Hidden fields for calendar form
  const q = new URLSearchParams();
  if(first_name) q.set('first_name', first_name);
  if(last_name) q.set('last_name', last_name);
  if(email) q.set('email', email);
  if(phone) q.set('phone', phone);

  // Always pass a stable order id to the calendar
  const stableOrderId = order.order_id || order.stripe_session_id || '';
  if(stableOrderId) q.set('order_id', stableOrderId);

  // Pass all order details to calendar (critical for promo codes, discounts, full order tracking)
  [
    'stripe_session_id','order_created_at','order_source',
    'order_total','order_subtotal','order_tax','order_fees','order_currency',
    'order_discount_code','order_discount_amount',
    'order_item_count','order_summary','order_lines_json',
    'bundle_applied','membership_plan',
    'utm_source','utm_medium','utm_campaign','utm_term','utm_content'
  ].forEach(k=>{
    if(order[k]!==undefined && order[k]!==null && String(order[k]).length){
      q.set(k, String(order[k]));
    }
  });

  q.set('redirect_url', 'https://home2smart.com/shop?view=apptreturn');

  const calSrc = CAL_FORM_URL + (CAL_FORM_URL.includes('?') ? '&' : '?') + q.toString();
  console.log('ðŸ“… Calendar URL built with full order details');

  // Define display variables BEFORE using them
  const prettyTotal = order.order_total ? money(Number(order.order_total)) : 'â€”';
  const displayOrderId = order.order_id || order.stripe_session_id || 'â€”';

  // Clear cart & snapshot
  cart = [];
  saveCart();
  localStorage.removeItem('h2s_checkout_snapshot');

  // Track successful purchase
  h2sTrack('Purchase', {
    order_id: displayOrderId,
    value: order.order_total || order.order_subtotal || '0',
    currency: order.order_currency || 'USD',
    num_items: order.order_item_count || '0'
  });

  byId('outlet').innerHTML = `
    <section class="form">
      <h2 style="margin:0 0 10px 0;font-weight:900">Thanks! Your order is confirmed.</h2>
      <div class="pd-box details-grid">
        <div class="row"><div class="k">Order ID</div><div class="v">${escapeHtml(String(displayOrderId))}</div></div>
        <div class="row"><div class="k">Total</div><div class="v">${escapeHtml(prettyTotal + (order.order_currency ? ` ${order.order_currency}` : ''))}</div></div>
        <div class="row"><div class="k">Items</div><div class="v">${escapeHtml(order.order_summary || (order.order_item_count ? `${order.order_item_count} items` : 'â€”'))}</div></div>
        ${order.order_discount_code ? `<div class="row"><div class="k">Promo code</div><div class="v">${escapeHtml(order.order_discount_code)}</div></div>`:''}
      </div>
      <p class="help">Next step: pick a date & time for your service (embedded below).</p>
      <div class="cal-embed">
        <iframe src="${calSrc}" title="Scheduler"></iframe>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn ghost" id="backToShop">Back to shop</button>
      </div>
    </section>
  `;

  byId('backToShop').onclick = ()=> navSet({view:null});
}

async function handleCalReturn(){
  const order_id = getParam('order_id') || '';
  const startIso = getParam('start') || '';

  byId('outlet').innerHTML = `
    <section class="form">
      <h2 style="margin:0 0 10px 0;font-weight:900">Saving your appointmentâ€¦</h2>
      <div class="help">Just a moment.</div>
    </section>
  `;

  try{
    if(!user || !user.email) throw new Error('You must be signed in.');
    if(!startIso) throw new Error('Missing appointment time.');
    
    // Use APIV1 (Shopbackend.js) for appointment booking
    // This triggers job creation webhook to Operations
    const res = await fetch(APIV1, {
      method:'POST',
      body: JSON.stringify({
        __action: 'record_install_slot',
        email: user.email,
        order_id: order_id || '',
        install_at: startIso || '',
        install_end_at: getParam('end') || '',
        timezone: getParam('tz') || ''
      })
    });
    
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || 'Failed to save appointment');
    
    console.log('âœ… Appointment saved, job creation triggered');
  }catch(err){
    console.error('âŒ Appointment save failed:', err);
    alert(err.message);
  }

  navSet({view:'account'});
}

// === AUTH VIEWS ===
function renderSignIn(){
  const outlet = byId('outlet');
  outlet.innerHTML = `
    <section class="form">
      <div style="text-align:center; margin-bottom:24px;">
        <a href="#" onclick="navSet({view:'shop'}); return false;" class="link-btn" style="font-size:14px; color:var(--azure); font-weight:600;">
          â† Back to shop
        </a>
      </div>
      <h2>Sign in to your account</h2>
      <p class="help" style="text-align:center; color:var(--text-muted); margin-bottom:20px;">Access your dashboard, track orders, and manage your account.</p>
      <input class="inp" id="siEmail" type="email" placeholder="Email address" value="${escapeAttr(user?.email||'')}" autocomplete="email">
      <input class="inp" id="siPass"  type="password" placeholder="Password" autocomplete="current-password">
      <div style="display:flex; gap:12px; margin-top:24px; flex-direction:column;">
        <button class="btn btn-primary" id="signin" style="width:100%;">Sign in</button>
        <button class="btn btn-ghost" id="toSignup" style="width:100%;">Create account</button>
        <button class="btn btn-subtle" id="toForgot" style="padding:10px; margin-top:8px;">Forgot password?</button>
      </div>
      <div id="siMsg" class="help" style="margin-top:16px; color:#d32f2f;"></div>
    </section>
  `;
  
  // Ensure content is visible
  outlet.style.opacity = '1';
  outlet.style.transition = '';
  document.body.classList.add('app-ready');
  
  byId('toSignup').onclick = ()=> navSet({view:'signup'});
  byId('toForgot').onclick = ()=> navSet({view:'forgot'});
  byId('signin').onclick = async ()=>{
    const email = byId('siEmail').value.trim();
    const pass  = byId('siPass').value;
    if(!email){ return showMsg('siMsg','Enter your email.'); }
    if(!pass){ return showMsg('siMsg','Enter your password.'); }
    showLoader();
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'signin', email, password:pass })});
      const text = await resp.text();
      if(!resp.ok){ showMsg('siMsg', text || ('Error ' + resp.status)); return; }
      const data = JSON.parse(text);
      if(!data.ok){ showMsg('siMsg', data.error||'Sign in failed'); return; }
      user = { name:data.user.name||'', email:data.user.email, phone:data.user.phone||'' };
      saveUser();
      loadAIRecommendations(); // Load personalized recommendations
      h2sTrack('Login', { user_email: user.email });
      navSet({view:'account'});
    }catch(err){ showMsg('siMsg', String(err)); }
    finally{ hideLoader(); }
  };
}

function renderSignUp(){
  const seed = user||{};
  const outlet = byId('outlet');
  outlet.innerHTML = `
    <section class="form">
      <div style="text-align:center; margin-bottom:24px;">
        <a href="#" onclick="navSet({view:'shop'}); return false;" class="link-btn" style="font-size:14px; color:var(--azure); font-weight:600;">
          â† Back to shop
        </a>
      </div>
      <h2>Create your account</h2>
      <p class="help" style="text-align:center; color:var(--text-muted); margin-bottom:20px;">Get exclusive discounts, earn credits, and track your installations.</p>
      <input class="inp" id="suName"  type="text"  placeholder="Full name" value="${escapeAttr(seed.name||'')}" autocomplete="name">
      <input class="inp" id="suEmail" type="email" placeholder="Email address" value="${escapeAttr(seed.email||'')}" autocomplete="email">
      <input class="inp" id="suPhone" type="tel"   placeholder="Phone number" value="${escapeAttr(seed.phone||'')}" autocomplete="tel">
      <input class="inp" id="suPass"  type="password" placeholder="Password (min 8 characters)" autocomplete="new-password">
      <input class="inp" id="suPass2" type="password" placeholder="Confirm password" autocomplete="new-password">
      <div class="help" style="text-align:center; color:var(--text-muted); margin-top:8px;">Secure checkout, order tracking, and rewards</div>
      <div style="display:flex; gap:12px; margin-top:24px; flex-direction:column;">
        <button class="btn btn-primary" id="createAcct" style="width:100%;">Create account</button>
        <button class="btn btn-ghost" id="toSignin" style="width:100%;">Already have an account? Sign in</button>
      </div>
      <div id="suMsg" class="help" style="margin-top:16px;"></div>
    </section>
  `;
  
  // Ensure content is visible
  outlet.style.opacity = '1';
  outlet.style.transition = '';
  document.body.classList.add('app-ready');
  
  byId('toSignin').onclick = ()=> navSet({view:'signin'});
  byId('createAcct').onclick = async ()=>{
    const name  = byId('suName').value.trim();
    const email = byId('suEmail').value.trim();
    const phone = byId('suPhone').value.trim();
    const pw1   = byId('suPass').value;
    const pw2   = byId('suPass2').value;
    const msg   = byId('suMsg');
    const btn   = byId('createAcct');
    
    if(!email){ return showMsg('suMsg','Enter your email.'); }
    if(pw1.length < 8){ return showMsg('suMsg','Password must be at least 8 characters.'); }
    if(pw1 !== pw2){ return showMsg('suMsg','Passwords do not match.'); }
    showLoader();
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'create_user', user:{name,email,phone,password:pw1}})});
      const text = await resp.text();
      if(!resp.ok){ showMsg('suMsg', text || ('Error ' + resp.status)); return; }
      const data = JSON.parse(text);
      if(!data.ok){ showMsg('suMsg', data.error||'Create failed'); return; }
      user = {name:data.user.name||'', email:data.user.email, phone:data.user.phone||''};
      saveUser();
      loadAIRecommendations(); // Load personalized recommendations
      h2sTrack('CompleteRegistration', { user_email: user.email, user_name: user.name });
      
      // Show success message before redirecting
      if(msg && btn){
        msg.style.color = '#2e7d32';
        msg.textContent = 'âœ“ Account created! Welcome to Home2Smart.';
        btn.textContent = 'Success!';
        btn.disabled = true;
      }
      
      // Redirect to account after 1 second
      setTimeout(() => {
        navSet({view:'account'});
      }, 1200);
    }catch(err){ showMsg('suMsg', String(err)); }
    finally{ hideLoader(); }
  };
}

function renderForgot(){
  const outlet = byId('outlet');
  outlet.innerHTML = `
    <section class="form">
      <div style="text-align:center; margin-bottom:24px;">
        <a href="#" onclick="navSet({view:'shop'}); return false;" class="link-btn" style="font-size:14px; color:var(--azure); font-weight:600;">
          â† Back to shop
        </a>
      </div>
      <h2>Forgot password</h2>
      <p class="help" style="text-align:center; color:var(--text-muted); margin-bottom:20px;">Enter your email and we'll send you a reset link.</p>
      <input class="inp" id="fpEmail" type="email" placeholder="Email address" autocomplete="email">
      <div style="display:flex; gap:12px; margin-top:24px; flex-direction:column;">
        <button class="btn btn-primary" id="fpSend" style="width:100%;">Send reset link</button>
        <button class="btn btn-ghost" id="fpBack" style="width:100%;">Back to sign in</button>
      </div>
      <div id="fpMsg" class="help" style="margin-top:16px; color:#d32f2f;"></div>
    </section>
  `;
  
  // Ensure content is visible
  outlet.style.opacity = '1';
  outlet.style.transition = '';
  document.body.classList.add('app-ready');
  
  byId('fpBack').onclick = ()=> navSet({view:'signin'});
  byId('fpSend').onclick = async ()=>{
    const email = byId('fpEmail').value.trim();
    if(!email){ return showMsg('fpMsg','Enter your email.'); }
    showLoader();
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'request_password_reset', email})});
      const txt  = await resp.text();
      if(!resp.ok){ showMsg('fpMsg', txt || ('Error ' + resp.status)); return; }
      showMsg('fpMsg','If that email has an account, a reset link has been sent. Check your inbox.');
    }catch(err){ showMsg('fpMsg', String(err)); }
    finally{ hideLoader(); }
  };
}

function renderReset(token){
  const outlet = byId('outlet');
  outlet.innerHTML = `
    <section class="form">
      <h2 style="margin:0 0 10px 0;font-weight:900">Reset password</h2>
      <input class="inp" id="rpToken" type="text" placeholder="Reset token" value="${escapeAttr(token||'')}">
      <input class="inp" id="rpNew1" type="password" placeholder="New password (min 8)">
      <input class="inp" id="rpNew2" type="password" placeholder="Confirm new password">
      <div style="display:flex; gap:10px; margin-top:6px; flex-wrap:wrap">
        <button class="btn azure" id="rpDo">Set new password</button>
        <button class="btn ghost" id="rpBack">Back to sign in</button>
      </div>
      <div id="rpMsg" class="help"></div>
    </section>
  `;
  
  // Ensure content is visible
  outlet.style.opacity = '1';
  outlet.style.transition = '';
  document.body.classList.add('app-ready');
  
  byId('rpBack').onclick = ()=> navSet({view:'signin'});
  byId('rpDo').onclick = async ()=>{
    const tok = byId('rpToken').value.trim();
    const p1   = byId('rpNew1').value;
    const p2   = byId('rpNew2').value;
    if(!tok){ return showMsg('rpMsg','Missing reset token.'); }
    if(p1.length<8){ return showMsg('rpMsg','Password must be at least 8 characters.'); }
    if(p1!==p2){ return showMsg('rpMsg','Passwords do not match.'); }
    showLoader();
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'reset_password', token:tok, new_password:p1})});
      const txt  = await resp.text();
      if(!resp.ok){ showMsg('rpMsg', txt || ('Error ' + resp.status)); return; }
      const data = JSON.parse(txt);
      if(!data.ok){ showMsg('rpMsg', data.error||'Could not reset password'); return; }
      showMsg('rpMsg','Password updated. You can now sign in.');
      setTimeout(()=> navSet({view:'signin'}), 800);
    }catch(err){ showMsg('rpMsg', String(err)); }
    finally{ hideLoader(); }
  };
}

function renderAccount(){
  if(!user || !user.email){ navSet({view:'signin'}); return; }

  // Auto-refresh user data if missing referral code
  if(!user.referral_code && !window._userRefreshing){
    window._userRefreshing = true;
    fetch(API + '?action=user&email=' + encodeURIComponent(user.email))
      .then(r=>r.json())
      .then(d=>{
        window._userRefreshing = false;
        if(d.ok && d.user){
          user = { ...user, ...d.user };
          saveUser();
          renderAccount();
        }
      }).catch(()=> window._userRefreshing = false);
  }

  const outlet = byId('outlet');
  outlet.innerHTML = `
    <section class="form">
      <div style="text-align:center; margin-bottom:24px;">
        <a href="#" onclick="navSet({view:null}); return false;" class="link-btn" style="font-size:14px; color:var(--azure); font-weight:600;">
          â† Back to shop
        </a>
      </div>
      <h2 style="margin:0 0 10px 0;font-weight:900">Your account</h2>
      <p class="help" style="text-align:center; color:var(--text-muted); margin-bottom:20px;">Manage your profile, view orders, and track your rewards.</p>
      <input class="inp" id="acName"  type="text"  placeholder="Full name" value="${escapeAttr(user.name||'')}">
      <input class="inp" id="acEmail" type="email" placeholder="Email" value="${escapeAttr(user.email||'')}" disabled>
      <input class="inp" id="acPhone" type="tel"   placeholder="Phone" value="${escapeAttr(user.phone||'')}">
      <div style="display:flex; gap:12px; margin-top:24px; flex-direction:column;">
        <button class="btn btn-primary" id="saveAcct" style="width:100%;">Save changes</button>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-ghost" id="signOut" style="flex:1;">Sign out</button>
        </div>
      </div>
      <div id="acMsg" class="help" style="margin-top:16px;"></div>
    </section>

    <section class="form" style="margin-top:24px">
      <h3 style="margin:0 0 10px 0;font-weight:900">Rewards & Credits</h3>
      <div class="pd-box" style="background:#f0f9ff; border-color:#bae6fd;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
          <div style="font-weight:800; color:#0284c7;">Available Credits</div>
          <div style="font-weight:900; font-size:18px; color:#0284c7;">${money(user.credits||0)}</div>
        </div>
        <div style="margin-top:12px; padding-top:12px; border-top:1px solid #bae6fd;">
          <div style="font-weight:800; color:#0284c7; margin-bottom:4px;">Your Referral Code</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <div style="font-family:monospace; font-weight:900; font-size:18px; letter-spacing:1px; background:#fff; padding:8px 12px; border-radius:6px; border:1px dashed #0284c7; color:#0284c7;">
              ${escapeHtml(user.referral_code || 'Loading...')}
            </div>
            <button class="btn btn-primary" style="padding:8px 16px; font-size:13px;" onclick="navigator.clipboard.writeText('${escapeHtml(user.referral_code||'')}').then(()=>this.textContent='Copied!')">Copy Code</button>
          </div>
          <div style="font-size:13px; color:#0369a1; margin-top:8px;">Share this code. Friends get discount, you get credit.</div>
        </div>
      </div>
    </section>

    <section class="form" style="margin-top:24px">
      <button class="btn ghost" id="cpToggle" aria-expanded="false">Change password</button>
      <div id="cpPanel" class="pd-box" style="display:none; margin-top:10px">
        <h3 style="margin:0 0 10px 0;font-weight:900">Change password</h3>
        <input class="inp" id="cpOld" type="password" placeholder="Current password">
        <input class="inp" id="cpNew1" type="password" placeholder="New password (min 8)">
        <input class="inp" id="cpNew2" type="password" placeholder="Confirm new password">
        <div style="display:flex; gap:10px; margin-top:6px; flex-wrap:wrap">
          <button class="btn azure" id="cpDo">Update password</button>
        </div>
        <div id="cpMsg" class="help"></div>
      </div>
    </section>

    <section class="form" style="margin-top:24px">
      <h3 style="margin:0 0 10px 0;font-weight:900">Previous orders</h3>
      <div id="ordersBox" class="pd-box"><div class="help">Loadingâ€¦</div></div>
    </section>
  `;

  byId('saveAcct').onclick = async ()=>{
    const name  = byId('acName').value.trim();
    const phone = byId('acPhone').value.trim();
    showLoader();
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'upsert_user', user:{name,phone,email:user.email}})});
      const text = await resp.text();
      if(!resp.ok){ showMsg('acMsg', text || ('Error ' + resp.status)); return; }
      const data = JSON.parse(text);
      if(!data.ok){ showMsg('acMsg', data.error||'Save failed'); return; }
      user = { ...user, name:data.user.name||'', phone:data.user.phone||'' };
      saveUser();
      showMsg('acMsg','âœ“ Saved successfully.');
    }catch(err){ showMsg('acMsg', String(err)); }
    finally{ hideLoader(); }
  };
  byId('signOut').onclick = ()=>{ user = {}; saveUser(); navSet({view:null}); };

  // Ensure content is visible
  outlet.style.opacity = '1';
  outlet.style.transition = '';
  document.body.classList.add('app-ready');

  // Toggle password panel
  const cpToggle = byId('cpToggle');
  const cpPanel  = byId('cpPanel');
  if(cpToggle && cpPanel){
    cpToggle.onclick = ()=>{
      const open = cpPanel.style.display !== 'none';
      cpPanel.style.display = open ? 'none' : '';
      cpToggle.setAttribute('aria-expanded', String(!open));
    };
  }

  const cpDo = byId('cpDo');
  if(cpDo){
    cpDo.onclick = async ()=>{
      const oldp = byId('cpOld').value;
      const p1   = byId('cpNew1').value;
      const p2   = byId('cpNew2').value;
      if(!oldp){ return showMsg('cpMsg','Enter your current password.'); }
      if(p1.length<8){ return showMsg('cpMsg','New password must be at least 8 characters.'); }
      if(p1!==p2){ return showMsg('cpMsg','Passwords do not match.'); }
      showLoader();
      try{
        const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'change_password', email:user.email, old_password:oldp, new_password:p1})});
        const txt  = await resp.text();
        if(!resp.ok){ showMsg('cpMsg', txt || ('Error ' + resp.status)); return; }
        const data = JSON.parse(txt);
        if(!data.ok){ showMsg('cpMsg', data.error||'Could not change password'); return; }
        showMsg('cpMsg','Password updated.');
        byId('cpOld').value = byId('cpNew1').value = byId('cpNew2').value = '';
      }catch(err){ showMsg('cpMsg', String(err)); }
      finally{ hideLoader(); }
    };
  }

  loadOrders();
}

async function loadOrders(){
  const box = byId('ordersBox');
  if(!box) return;
  try{
    const res = await fetch(API + '?action=orders&email=' + encodeURIComponent(user.email));
    const data = await res.json();
    const orders = Array.isArray(data.orders) ? data.orders : [];
    if(!orders.length){
      box.innerHTML = `<div class="help">No orders yet.</div>`;
      return;
    }
    // newest first
    orders.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
    box.innerHTML = orders.map(o=>{
      const oid = o.order_id || o.stripe_session_id || 'â€”';
      const when = o.install_at ? new Date(o.install_at).toLocaleString() : (o.service_date||'');
      const summary = o.order_summary || '';
      const total = (Number(o.order_total)||0);
      return `
        <div class="pd-box" style="margin-bottom:10px">
          <div class="details-grid">
            <div class="row"><div class="k">Order ID</div><div class="v">${escapeHtml(String(oid))}</div></div>
            <div class="row"><div class="k">Total</div><div class="v">${money(total)}</div></div>
            <div class="row"><div class="k">Items</div><div class="v">${escapeHtml(summary||'')}</div></div>
            <div class="row"><div class="k">Service date</div><div class="v">${escapeHtml(when||'â€”')}</div></div>
          </div>
        </div>
      `;
    }).join('');
  }catch(e){
    box.innerHTML = `<div class="help">Could not load orders.</div>`;
  }
}

async function loadSubscriptionsAndUpsell(){
  // Placeholder for subscription logic if needed in future
  // Currently shop-v2 focuses on one-time service packages
}

function wireCart(){
  const btn = byId('accountBtn');
  if(btn){
    btn.onclick = ()=>{
      if(user && user.email) navSet({view:'account'});
      else navSet({view:'signin'});
    };
  }
  
  const applyPromoBtn = byId('applyPromo');
  if(applyPromoBtn){
    applyPromoBtn.onclick = ()=>{
      const code = byId('promoCode').value.trim();
      const msg = byId('promoMsg');
      if(!code){
        msg.textContent = 'Please enter a code.';
        msg.style.color = '#c33';
        return;
      }
      
      // Store for checkout
      localStorage.setItem('h2s_promo_code', code);
      msg.textContent = 'Code applied! It will be verified at checkout.';
      msg.style.color = '#28a745';
    };
  }
}

// === SIGNIN STATE ===
function renderSigninState(){
  const btn = byId('accountBtn');
  if(!btn) return;
  
  if(user && user.email){
    // User is signed in
    btn.innerHTML = `
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
    `;
    btn.onclick = () => navSet({view:'account'});
    btn.title = "My Account";
  } else {
    // User is signed out
    btn.innerHTML = `
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
        <polyline points="10 17 15 12 10 7"></polyline>
        <line x1="15" y1="12" x2="3" y2="12"></line>
      </svg>
    `;
    btn.onclick = () => navSet({view:'signin'});
    btn.title = "Sign In";
  }
}

// === UTILS ===
function byId(id){ return document.getElementById(id); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
function showMsg(id, msg){ const el = byId(id); if(el) el.textContent = String(msg); }
function money(n){ return (Number(n)||0).toLocaleString('en-US',{style:'currency',currency:'USD'}); }

function indexBy(arr, key){
  const map = {};
  arr.forEach(item => {
    const val = item[key];
    if(val !== undefined) map[val] = item;
  });
  return map;
}

function parseMoneyCell(v){ 
  const m = String(v||'').match(/-?\d+(\.\d+)?/); 
  return m ? Number(m[0]) : 0; 
}

function pickTier(service_id, qty, optionId){
  const q = Number(qty||0);
  const tiers = (catalog.priceTiers||[])
    .filter(t => String(t.service_id)===String(service_id))
    .filter(t => optionId==null ? true : String(t.option_id||'').trim()===String(optionId).trim())
    .map(t=>({
      min: Number(t.min_qty||0),
      max: (t.max_qty===''||t.max_qty==null)? Infinity : Number(t.max_qty),
      unit: Number(parseMoneyCell(t.unit_price)||0),
      price_id: t.stripe_price_id
    }));
  const fits = tiers.filter(t=> q>=t.min && q<=t.max);
  fits.sort((a,b)=>(a.max-a.min)-(b.max-b.min));
  return fits[0] || null;
}

function scrollToSection(id){
  const el = byId(id);
  if(el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function requestQuote(packageId){
  // Open styled quote modal instead of phone dialer
  const modal = document.getElementById('quoteModal');
  const backdrop = document.getElementById('backdrop');
  const titleEl = document.getElementById('quoteModalTitle');
  
  if (!modal || !backdrop) {
    console.error('[Quote] Modal or backdrop not found');
    return;
  }
  
  // Set context-specific title
  if (packageId === 'tv_custom') {
    titleEl.textContent = 'Custom TV Mounting Quote';
  } else if (packageId === 'cam_custom') {
    titleEl.textContent = 'Custom Security Camera Quote';
  } else {
    titleEl.textContent = 'Request Custom Quote';
  }
  
  // Pre-fill project type in details
  const detailsField = document.getElementById('quoteDetails');
  if (detailsField) {
    const projectType = packageId === 'tv_custom' ? 'TV mounting' : 'security camera installation';
    detailsField.placeholder = `I need a custom ${projectType} package for...`;
  }
  
  // Store package context
  modal.dataset.packageId = packageId;

  // remember what element had focus before opening so we can restore it on close
  try{
    modal.dataset.prevFocus = document.activeElement?.id || '';
  }catch(e){ modal.dataset.prevFocus = ''; }
  
  // Show modal with correct classes
  modal.classList.add('show');
  backdrop.classList.add('show');
  document.body.style.overflow = 'hidden';
  
  console.log('[Quote] Modal opened for:', packageId);
  
  // Focus first input
  setTimeout(() => {
    const nameInput = document.getElementById('quoteName');
    if (nameInput) nameInput.focus();
  }, 100);
}

function closeQuoteModal(){
  const modal = document.getElementById('quoteModal');
  const backdrop = document.getElementById('backdrop');
  
  if (modal) modal.classList.remove('show');
  
  // Only hide backdrop if no other modals/drawers are open
  const menuOpen = document.getElementById('menuDrawer')?.classList.contains('open');
  const cartOpen = document.getElementById('cartDrawer')?.classList.contains('open');
  const mainModalOpen = document.getElementById('modal')?.classList.contains('show');
  
  if (!menuOpen && !cartOpen && !mainModalOpen && backdrop) {
    backdrop.classList.remove('show');
  }
  
  document.body.style.overflow = '';
  
  // Clear form
  ['quoteName', 'quoteEmail', 'quotePhone', 'quoteDetails'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  
  const msg = document.getElementById('quoteMessage');
  if (msg) msg.textContent = '';

  // Restore focus to the previously-focused element if present
  try{
    const prevId = modal?.dataset?.prevFocus;
    if(prevId){
      const prevEl = document.getElementById(prevId);
      if(prevEl && typeof prevEl.focus === 'function') prevEl.focus();
    } else {
      // fallback: focus the main outlet so keyboard users aren't lost
      const outlet = document.getElementById('outlet');
      if(outlet && typeof outlet.focus === 'function') outlet.focus();
    }
    if(modal && modal.dataset) modal.dataset.prevFocus = '';
  }catch(e){ /* ignore */ }
  
  console.log('[Quote] Modal closed');
}

async function submitQuoteRequest(){
  const name = document.getElementById('quoteName')?.value.trim() || '';
  const email = document.getElementById('quoteEmail')?.value.trim() || '';
  const phone = document.getElementById('quotePhone')?.value.trim() || '';
  const details = document.getElementById('quoteDetails')?.value.trim() || '';
  const msg = document.getElementById('quoteMessage');
  const btn = document.getElementById('submitQuoteBtn');
  const modal = document.getElementById('quoteModal');
  const packageId = modal?.dataset.packageId || 'unknown';
  
  if (!msg || !btn) return;
  
  // Validation
  if (!name) {
    msg.style.color = '#d32f2f';
    msg.textContent = 'Please enter your name';
    return;
  }
  
  if (!email || !email.includes('@')) {
    msg.style.color = '#d32f2f';
    msg.textContent = 'Please enter a valid email address';
    return;
  }
  
  if (!phone) {
    msg.style.color = '#d32f2f';
    msg.textContent = 'Please enter your phone number';
    return;
  }
  
  // Disable button
  btn.disabled = true;
  btn.textContent = 'Sending...';
  msg.textContent = '';
  
  try {
    // Send to Vercel backend (saves to Supabase + sends notifications)
    const quoteEndpoint = API.replace('/api/shop', '/api/quote');
    
    const response = await fetch(quoteEndpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name,
        email,
        phone,
        details,
        package_type: packageId,
        source: '/shop',
        timestamp: new Date().toISOString()
      })
    });
    
    const data = await response.json();
    
    if (response.ok && data.ok) {
      // Success
      msg.style.color = '#2e7d32';
      msg.textContent = 'âœ“ Request sent! We\'ll contact you within 1 hour.';
      
      // Track event
      h2sTrack('QuoteRequested', {
        package_type: packageId,
        customer_email: email,
        quote_id: data.quote_id
      });
      
      console.log('[Quote] Successfully submitted:', data.quote_id);
      
      // Close after 2 seconds
      setTimeout(() => {
        closeQuoteModal();
      }, 2000);
    } else {
      throw new Error(data.error || 'Server error');
    }
  } catch (error) {
    console.error('Quote request failed:', error);
    msg.style.color = '#d32f2f';
    msg.textContent = 'Failed to send. Please call us at (864) 528-1475';
    btn.disabled = false;
    btn.textContent = 'Send Request';
  }
}

// === INIT ON LOAD ===
document.addEventListener('DOMContentLoaded', init);

document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape') closeAll();
});

// Handle browser back/forward - ensure view param is respected
window.addEventListener('popstate', () => {
  console.log('[Nav] Popstate event - routing to current URL state');
  route();
});

// Expose functions to global scope for HTML event handlers
window.toggleMenu = toggleMenu;
window.toggleCart = toggleCart;
window.checkout = checkout;
window.selectPackage = selectPackage;
window.requestQuote = requestQuote;
window.addPackageToCart = addPackageToCart;
window.closeModal = closeModal;
window.closeAll = closeAll;
window.removeFromCart = removeFromCart;
window.updateQuantity = updateQuantity;
window.scrollToSection = scrollToSection;
window.goToReview = goToReview;
window.dismissUrgencyBanner = dismissUrgencyBanner;
window.closeQuoteModal = closeQuoteModal;
window.submitQuoteRequest = submitQuoteRequest;
window.navSet = navSet;

// ===== COMPREHENSIVE DIAGNOSTIC TOOL =====
// Run in console: diagnoseCheckout()
window.diagnoseCheckout = function(){
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘    COMPREHENSIVE CHECKOUT & CACHE DIAGNOSTIC                   â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  const issues = [];
  const warnings = [];
  
  // Test 1: Browser Storage Health
  console.log('[1] Browser Storage Health:');
  try {
    localStorage.setItem('h2s_test', '1');
    localStorage.removeItem('h2s_test');
    console.log('   âœ… localStorage: Working');
  } catch(e) {
    issues.push('localStorage BLOCKED (private mode?)');
    console.error('   âŒ localStorage: BLOCKED -', e.message);
  }
  
  try {
    sessionStorage.setItem('h2s_test', '1');
    sessionStorage.removeItem('h2s_test');
    console.log('   âœ… sessionStorage: Working');
  } catch(e) {
    warnings.push('sessionStorage blocked');
    console.warn('   âš ï¸  sessionStorage: BLOCKED -', e.message);
  }
  
  // Test 2: Cache Status
  console.log('\n[2] Cache Status:');
  const cartLS = localStorage.getItem('h2s_cart');
  const userLS = localStorage.getItem('h2s_user');
  console.log('   Cart in localStorage:', cartLS ? `${cartLS.length} bytes` : '(empty)');
  console.log('   User in localStorage:', userLS ? `${userLS.length} bytes` : '(empty)');
  console.log('   Session ID:', SESSION_ID);
  
  // Test 3: Cart State
  console.log('\n[3] Cart State:');
  console.log('   Items:', cart.length);
  if(cart.length > 0) {
    console.table(cart.map(item => ({
      name: item.name,
      type: item.type,
      price: '$' + item.price,
      qty: item.qty
    })));
  }
  
  if(cart.length === 0){
    warnings.push('Cart is empty (add items to test checkout)');
    console.warn('   âš ï¸  Cart is empty');
  } else {
    cart.forEach((item, idx) => {
      if(!item.price || item.price === 0) issues.push(`Cart item ${idx}: missing price`);
      if(!item.qty || item.qty === 0) issues.push(`Cart item ${idx}: missing quantity`);
    });
  }
  
  // Test 4: Catalog Health
  console.log('\n[4] Catalog Health:');
  console.log('   Services loaded:', catalog.services?.length || 0);
  console.log('   Bundles loaded:', catalog.bundles?.length || 0);
  console.log('   Price Tiers loaded:', catalog.priceTiers?.length || 0);
  
  if(!catalog.bundles || catalog.bundles.length === 0){
    issues.push('CRITICAL: Catalog not loaded - bundles missing');
    console.error('   âŒ CRITICAL: No bundles loaded');
  } else {
    console.log('\n   Bundle Details:');
    console.table(catalog.bundles?.map(b => ({
      id: b.bundle_id,
      name: b.name,
      price: '$' + b.bundle_price,
      stripe_id: b.stripe_price_id || 'âŒ MISSING',
      active: b.active ? 'âœ“' : 'âœ—'
    })));
    
    let missingPriceIds = 0;
    catalog.bundles?.forEach(b => {
      if(!b.stripe_price_id) {
        missingPriceIds++;
        issues.push(`Bundle ${b.bundle_id}: missing stripe_price_id`);
      }
    });
    if(missingPriceIds > 0){
      console.error(`   âŒ ${missingPriceIds} bundles missing stripe_price_id`);
    } else {
      console.log('   âœ… All bundles have stripe_price_id');
    }
  }
  
  // Test 5: Cart-Catalog Validation
  console.log('\n[5] Cart-Catalog Cross-Check:');
  if(cart.length > 0){
    cart.forEach((item, idx) => {
      if(item.type === 'package'){
        const bundle = catalog.bundles?.find(b => b.bundle_id === item.id);
        if(!bundle){
          issues.push(`Cart item "${item.id}": NOT FOUND in catalog`);
          console.error(`   âŒ ${item.id}: NOT IN CATALOG`);
        } else if(!bundle.stripe_price_id){
          issues.push(`Cart item "${item.id}": missing stripe_price_id`);
          console.error(`   âŒ ${item.id}: NO stripe_price_id`);
        } else {
          console.log(`   âœ… ${item.name}: Valid (${bundle.stripe_price_id})`);
        }
      }
    });
  } else {
    console.log('   (No items to validate)');
  }
  
  // Test 6: User State
  console.log('\n[6] User Authentication:');
  console.log('   Signed in:', !!(user && user.email));
  if(user && user.email) {
    console.log('   Email:', user.email);
    console.log('   User data:', user);
  } else {
    console.log('   Guest checkout will be required');
  }
  
  // Test 7: API Configuration
  console.log('\n[7] API Configuration:');
  console.log('   Backend URL:', API);
  console.log('   Calendar URL:', CAL_FORM_URL);
  console.log('   Pixel ID:', PIXEL_ID);
  
  // Test 8: Network Test
  console.log('\n[8] Testing Network Connection...');
  const startTime = Date.now();
  
  return fetch(API + '?action=catalog&cb=' + Date.now(), { cache: 'no-store' })
    .then(r => {
      const latency = Date.now() - startTime;
      console.log(`   âœ… API Response: ${r.status} (${latency}ms)`);
      if(!r.ok) {
        issues.push(`API returned HTTP ${r.status}`);
      }
      return r.json();
    })
    .then(d => {
      console.log('   Server says:', d.ok ? 'OK' : 'ERROR');
      if(d.catalog){
        console.log('   Server catalog:', d.catalog.bundles?.length || 0, 'bundles');
        
        // Compare local vs server catalog
        if(d.catalog.bundles?.length !== catalog.bundles?.length){
          warnings.push(`Catalog mismatch: Local has ${catalog.bundles?.length}, server has ${d.catalog.bundles?.length}`);
          console.warn(`   âš ï¸  CATALOG MISMATCH: Local=${catalog.bundles?.length}, Server=${d.catalog.bundles?.length}`);
        }
      }
      
      // Test 9: Browser Compatibility
      console.log('\n[9] Browser Compatibility:');
      console.log('   User Agent:', navigator.userAgent);
      console.log('   Cookies Enabled:', navigator.cookieEnabled);
      console.log('   Online:', navigator.onLine);
      
      if(!navigator.cookieEnabled){
        warnings.push('Cookies disabled (may affect checkout)');
      }
      if(!navigator.onLine){
        issues.push('OFFLINE - no internet connection');
      }
      
      // SUMMARY
      console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
      console.log('â•‘                      DIAGNOSTIC SUMMARY                        â•‘');
      console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      
      if(issues.length === 0 && warnings.length === 0){
        console.log('\nðŸŽ‰ PERFECT! No issues found - checkout ready!\n');
      } else {
        if(issues.length > 0){
          console.log('\nâŒ CRITICAL ISSUES FOUND:', issues.length);
          issues.forEach((iss, i) => console.log(`   ${i+1}. ${iss}`));
        }
        if(warnings.length > 0){
          console.log('\nâš ï¸  WARNINGS:', warnings.length);
          warnings.forEach((warn, i) => console.log(`   ${i+1}. ${warn}`));
        }
        console.log('');
      }
      
      // Recommendations
      if(issues.length > 0){
        console.log('ðŸ’¡ RECOMMENDED ACTIONS:');
        if(issues.some(i => i.includes('stripe_price_id'))){
          console.log('   â€¢ Refresh page to reload catalog from server');
          console.log('   â€¢ Clear browser cache and reload');
          console.log('   â€¢ Check backend deployment is latest version');
        }
        if(issues.some(i => i.includes('localStorage'))){
          console.log('   â€¢ Exit private/incognito mode');
          console.log('   â€¢ Check browser settings allow storage');
        }
        if(issues.some(i => i.includes('OFFLINE'))){
          console.log('   â€¢ Check internet connection');
        }
        console.log('');
      }
      
      return {
        ok: issues.length === 0,
        ready: issues.length === 0 && cart.length > 0,
        issues,
        warnings,
        catalog: {
          local: catalog.bundles?.length || 0,
          server: d.catalog?.bundles?.length || 0
        }
      };
    })
    .catch(e => {
      console.error('\nâŒ NETWORK ERROR:', e.message);
      issues.push('API connection failed: ' + e.message);
      
      console.log('\nðŸ’¡ TROUBLESHOOTING:');
      console.log('   â€¢ Check internet connection');
      console.log('   â€¢ Check backend deployment URL is correct');
      console.log('   â€¢ Check browser console for CORS or CSP errors');
      console.log('   â€¢ Try reloading the page');
      
      return {ok: false, ready: false, issues, warnings, error: e.message};
    });
};

// === URGENCY BANNER ===
async function loadUrgencyStats() {
  console.log('[Urgency] Loading booking stats...');
  
  // Check if user dismissed banner (expires after 24 hours)
  const dismissedData = localStorage.getItem('h2s_urgency_dismissed');
  if (dismissedData) {
    try {
      const dismissedTime = parseInt(dismissedData, 10);
      const now = Date.now();
      const hoursSinceDismiss = (now - dismissedTime) / (1000 * 60 * 60);
      
      if (hoursSinceDismiss < 24) {
        console.log('[Urgency] Banner was dismissed', Math.round(hoursSinceDismiss), 'hours ago - still hidden');
        return;
      } else {
        console.log('[Urgency] Banner dismissal expired (24 hours) - showing again');
        localStorage.removeItem('h2s_urgency_dismissed');
      }
    } catch (e) {
      // Invalid data, clear it
      localStorage.removeItem('h2s_urgency_dismissed');
    }
  }
  
  try {
    const response = await fetch(API.replace('/api/shop', '/api/stats'), {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    console.log('[Urgency] Stats loaded:', data);
    
    if (data.ok && data.stats) {
      const { stats } = data;
      const banner = document.getElementById('urgencyBanner');
      const messageEl = document.getElementById('urgencyMessage');
      const header = document.querySelector('.header');
      
      if (!banner || !messageEl) {
        console.warn('[Urgency] Banner elements not found');
        return;
      }
      
      // Set message text
      if (stats.bookings_this_week > 0) {
        const plural = stats.bookings_this_week === 1 ? '' : 's';
        messageEl.textContent = `High demand: ${stats.bookings_this_week} installation${plural} booked this week`;
      } else {
        messageEl.textContent = 'Professional installation available';
      }
      
      // Show banner with animation
      setTimeout(() => {
        banner.classList.add('visible');
        if (header) {
          header.classList.add('with-banner');
        }
        
        // Adjust hero section padding
        const hero = document.querySelector('.hero');
        if (hero) {
          hero.classList.add('with-banner');
        }
      }, 500);
      
      console.log('[Urgency] Banner displayed');
    }
  } catch (error) {
    console.error('[Urgency] Failed to load stats:', error);
    // Fail silently - urgency is optional enhancement
  }
}

function dismissUrgencyBanner() {
  const banner = document.getElementById('urgencyBanner');
  const header = document.querySelector('.header');
  const hero = document.querySelector('.hero');
  
  if (banner) {
    banner.classList.remove('visible');
    banner.classList.add('dismissed');
  }
  
  if (header) {
    header.classList.remove('with-banner');
  }
  
  if (hero) {
    hero.classList.remove('with-banner');
  }
  
  // Save dismissal preference with timestamp
  try {
    const timestamp = Date.now();
    localStorage.setItem('h2s_urgency_dismissed', timestamp.toString());
    console.log('[Urgency] Banner dismissed - will reappear in 24 hours');
  } catch (err) {
    console.warn('[Urgency] Could not save dismissal:', err);
  }
}

// Initialize urgency banner on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadUrgencyStats);
} else {
  loadUrgencyStats();
}

})();

/* ===== H2S TRACKING SYSTEM (Unified for all pages) ===== */
window.H2S_DASH_URL = 'https://script.google.com/macros/s/AKfycbxVsGP8EeAZmfRcW9LjY3fm1F9iWvXMO7RlT4VP7Tj1BV0BOkeBi6GAkASQhEZJ7h9Y/exec';

(function(){
  function generateId(prefix){
    return prefix + '_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
  }
  
  let sessionId = sessionStorage.getItem('h2s_session_id');
  if (!sessionId) {
    sessionId = generateId('sess');
    sessionStorage.setItem('h2s_session_id', sessionId);
  }
  
  let userId = localStorage.getItem('h2s_user_id');
  if (!userId) {
    userId = generateId('user');
    localStorage.setItem('h2s_user_id', userId);
  }
  
  window.H2S_TRACKING = {
    enabled: true,
    sessionId: sessionId,
    userId: userId,
    pageStartTime: Date.now()
  };
  
  console.log('âœ… H2S Tracking Active - Session:', sessionId.substring(0, 20) + '...');
  
  function getTrackingURL(){
    return window.H2S_DASH_URL || 'https://script.google.com/macros/s/AKfycbxVsGP8EeAZmfRcW9LjY3fm1F9iWvXMO7RlT4VP7Tj1BV0BOkeBi6GAkASQhEZJ7h9Y/exec';
  }
  
  function getUTMParams(){
    var params = new URLSearchParams(window.location.search);
    return {
      utm_source: params.get('utm_source') || '',
      utm_medium: params.get('utm_medium') || '',
      utm_campaign: params.get('utm_campaign') || '',
      utm_term: params.get('utm_term') || '',
      utm_content: params.get('utm_content') || ''
    };
  }
  
  window.sendTrackingEvent = function(eventData){
    if (!window.H2S_TRACKING || !window.H2S_TRACKING.enabled) return;
    
    eventData.session_id = window.H2S_TRACKING.sessionId;
    eventData.user_id = window.H2S_TRACKING.userId;
    eventData.timestamp = new Date().toISOString();
    eventData.page_path = window.location.pathname;
    eventData.page_title = document.title;
    eventData.referrer = document.referrer || '';
    eventData.user_agent = navigator.userAgent;
    eventData.screen_resolution = screen.width + 'x' + screen.height;
    eventData.viewport_size = window.innerWidth + 'x' + window.innerHeight;
    
    var utm = getUTMParams();
    Object.keys(utm).forEach(function(k){ eventData[k] = utm[k]; });
    
    var url = getTrackingURL() + '?action=tracking_event';
    try {
      var payloadStr = JSON.stringify(eventData);
      if (navigator.sendBeacon) {
        var blob = new Blob([payloadStr], { type: 'text/plain' });
        var sent = navigator.sendBeacon(url, blob);
        if(!sent){
          fetch(url, { method:'POST', keepalive:true, body: payloadStr })
            .catch(function(err){ console.warn('Tracking fetch fallback error:', err); });
        }
      } else {
        fetch(url, { method:'POST', keepalive:true, body: payloadStr })
          .catch(function(err){ console.warn('Tracking fetch error:', err); });
      }
    } catch(err){ console.warn('Tracking beacon error:', err); }
  };
  
  window.sendMetaPixelEvent = function(eventName, eventParams, eventId){
    if (!window.H2S_TRACKING || !window.H2S_TRACKING.enabled) return;
    
    var payload = {
      event_name: eventName,
      event_time: Math.floor(Date.now() / 1000),
      event_id: eventId || generateId('evt'),
      event_source_url: window.location.href,
      action_source: 'website',
      user_data: {
        client_user_agent: navigator.userAgent,
        fbc: getCookie('_fbc') || '',
        fbp: getCookie('_fbp') || ''
      },
      custom_data: eventParams || {},
      session_id: window.H2S_TRACKING.sessionId,
      user_id: window.H2S_TRACKING.userId
    };
    
    var url = getTrackingURL() + '?action=meta_pixel_event';
    try {
      var mpStr = JSON.stringify(payload);
      if (navigator.sendBeacon) {
        var blob2 = new Blob([mpStr], { type: 'text/plain' });
        var sent2 = navigator.sendBeacon(url, blob2);
        if(!sent2){
          fetch(url, { method:'POST', keepalive:true, body: mpStr })
            .catch(function(err){ console.warn('Meta pixel fetch fallback error:', err); });
        }
      } else {
        fetch(url, { method:'POST', keepalive:true, body: mpStr })
          .catch(function(err){ console.warn('Meta pixel fetch error:', err); });
      }
    } catch(mpErr){ console.warn('Meta pixel beacon error:', mpErr); }
  };
  
  function getCookie(name){
    var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? match[2] : '';
  }
  
  // Auto page view tracking
  sendTrackingEvent({
    event_type: 'page_view',
    event_name: 'PageView',
    page_category: 'shop'
  });
  
  // Scroll depth tracking
  var scrollMarks = { '25': false, '50': false, '75': false, '100': false };
  window.addEventListener('scroll', function(){
    var scrollPercent = Math.round((window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100);
    ['25','50','75','100'].forEach(function(mark){
      if (scrollPercent >= parseInt(mark) && !scrollMarks[mark]) {
        scrollMarks[mark] = true;
        sendTrackingEvent({
          event_type: 'scroll',
          event_name: 'Scroll' + mark,
          scroll_depth: mark + '%'
        });
      }
    });
  }, { passive: true });
  
  // Time on page tracking
  window.addEventListener('beforeunload', function(){
    var timeOnPage = Math.round((Date.now() - window.H2S_TRACKING.pageStartTime) / 1000);
    sendTrackingEvent({
      event_type: 'engagement',
      event_name: 'TimeOnPage',
      time_seconds: timeOnPage
    });
  });
  
  // Meta Pixel intercept (loads after idle)
  setTimeout(function(){
    if (typeof fbq !== 'undefined') {
      var originalFbq = fbq;
      window.fbq = function(){
        originalFbq.apply(this, arguments);
        if (arguments[0] === 'track') {
          var eventName = arguments[1];
          var eventParams = arguments[2] || {};
          var eventId = eventParams.event_id || eventParams.eventID;
          sendMetaPixelEvent(eventName, eventParams, eventId);
        }
      };
    }
  }, 6000);
})();

// Product card tracking
document.addEventListener('DOMContentLoaded', function(){
  // Track "Add to Cart" button clicks
  document.addEventListener('click', function(e){
    var addButton = e.target.closest('button[data-product-id], .add-to-cart-btn, .bundle-cta');
    if (addButton) {
      var productId = addButton.getAttribute('data-product-id') || 'unknown';
      var productName = addButton.getAttribute('data-product-name') || 
                        (addButton.closest('.bundle-card') ? 
                         addButton.closest('.bundle-card').querySelector('h3, .bundle-title') : null);
      
      sendTrackingEvent({
        event_type: 'product_interaction',
        event_name: 'AddToCart',
        product_id: productId,
        product_name: productName ? productName.textContent.trim() : 'Bundle',
        cta_label: addButton.textContent.trim()
      });
    }
  });
  
  // Track navigation clicks
  document.querySelectorAll('nav a, .h2s-mainnav a').forEach(function(link){
    link.addEventListener('click', function(){
      sendTrackingEvent({
        event_type: 'navigation',
        event_name: 'NavClick',
        nav_label: link.textContent.trim(),
        nav_href: link.href
      });
    });
  });
  
  // Track phone clicks
  document.querySelectorAll('a[href^="tel:"]').forEach(function(link){
    link.addEventListener('click', function(){
      sendTrackingEvent({
        event_type: 'click',
        event_name: 'PhoneClick',
        cta_href: link.href
      });
    });
  });
  
  // Track checkout initiation
  var checkoutButtons = document.querySelectorAll('.checkout-btn, [data-action="checkout"], button[type="submit"][form*="checkout"]');
  checkoutButtons.forEach(function(btn){
    btn.addEventListener('click', function(){
      sendTrackingEvent({
        event_type: 'checkout',
        event_name: 'InitiateCheckout',
        cta_label: btn.textContent.trim()
      });
    });
  });
});
</script>

</body>
</html>


