<!-- Home2Smart ‚Ä¢ /shop SPA with bundle+rule recommendations, password accounts, membership pages, service options, and global loader -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://connect.facebook.net https://js.stripe.com https://script.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' https: data:; connect-src 'self' https://script.google.com https://www.facebook.com https://api.stripe.com https://storage.googleapis.com;">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="referrer" content="strict-origin-when-cross-origin">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" href="https://fonts.gstatic.com/s/archivo/v19/k3kQo8UDI-1M0wlSV9XAw6lQkqWY8Q82sLydOQ.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preconnect" href="https://storage.googleapis.com" crossorigin>
<link rel="preconnect" href="https://connect.facebook.net" crossorigin>
<link rel="preconnect" href="https://script.google.com" crossorigin>
<link rel="dns-prefetch" href="https://script.google.com">
<link rel="preconnect" href="https://js.stripe.com" crossorigin>
<link rel="dns-prefetch" href="https://www.facebook.com">
<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;800;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;800;900&display=swap" rel="stylesheet"></noscript>

<!-- Meta Pixel - Deferred for performance -->
<script>
(function() {
  function loadFBPixel() {
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}
    (window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init','2384221445259822');
    fbq('track','PageView');
  }
  if ('requestIdleCallback' in window) {
    requestIdleCallback(loadFBPixel, { timeout: 2000 });
  } else {
    setTimeout(loadFBPixel, 1500);
  }
})();
</script>
<noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=2384221445259822&ev=PageView&noscript=1" alt=""/></noscript>

<div id="shop-app" class="h2s-shop">
  <!-- Header -->
  <header class="h2s-header">
    <div class="header-inner">
      <a class="brand" href="/home" aria-label="Home2Smart">
        <img src="https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68da0ce6f00445991d64a63f.png" alt="Home2Smart" width="96" height="96" fetchpriority="high" decoding="async">
      </a>
      <div class="title"><a class="title-link" href="/shop">Shop</a></div>
      <div class="tools">
        <label for="search" class="sr-only">Search services</label>
        <input id="search" class="search" type="search" placeholder="Search services" aria-label="Search services">
        <label for="catFilter" class="sr-only">Filter by category</label>
        <select id="catFilter" class="select" aria-label="Filter by category">
          <option value="">All categories</option>
        </select>
        <button id="accountBtn" class="btn ghost small">Sign in</button>
        <button id="cartBtn" class="cart-btn" aria-label="Open cart">Cart <span id="cartCount">0</span></button>
      </div>
    </div>
  </header>

  <!-- Main router outlet -->
  <main id="outlet" class="h2s-main">
    <!-- Skeleton loader (removed by JS once content loads) -->
    <div id="skeleton" style="padding:1rem;">
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;">
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>
    </div>
  </main>

  <!-- Cart Drawer -->
  <aside id="cartDrawer" class="cart">
    <div class="cart-head">
      <div class="cart-title">Your cart</div>
      <button id="closeCart" class="icon-btn" aria-label="Close">‚úï</button>
    </div>

    <!-- Scrollable body container -->
    <div class="cart-body">
      <!-- Bundles panel (recommendations) -->
      <div id="bundlePanel" class="bundle-panel" style="display:none;min-height:60px"></div>

      <!-- Rule-based Recommendations panel (new) -->
      <div id="recsPanel" class="recs-panel" style="display:none;min-height:60px"></div>

      <!-- Legacy banner (unused) -->
      <div id="bundleBanner" class="bundle-banner" style="display:none">
        <div class="bundle-text">
          <strong id="bundleName">Bundle</strong>
          <span id="bundleSavings"></span>
        </div>
        <div class="bundle-actions">
          <button id="bundleApply" class="btn azure">Swap & Save</button>
          <button id="bundleDismiss" class="btn ghost">No thanks</button>
        </div>
      </div>

      <div id="signinBanner" class="signin-banner" style="display:none;min-height:80px">
        <div>
          <strong>Save time at checkout.</strong>
          <div>Sign in so we can prefill your info.</div>
        </div>
        <button class="btn azure" id="bannerSignIn">Sign in</button>
      </div>
      
      <!-- Referral Promotion Banner (shows user their own code) -->
      <div id="myReferralBanner" class="my-referral-banner" style="display:none">
        <div class="referral-banner-content">
          <div class="referral-icon">üéÅ</div>
          <div class="referral-info">
            <div class="referral-title">Share & Earn!</div>
            <div class="referral-subtitle">Give friends <strong id="myReferralDiscount">10% off</strong>, get rewards</div>
          </div>
        </div>
        <div class="referral-code-display">
          <div class="code-label">Your code:</div>
          <div class="code-value" id="myReferralCode">---</div>
          <button class="btn-copy" id="copyReferralCode" title="Copy to clipboard">
            <span id="copyIcon">üìã</span>
          </button>
        </div>
        <button class="btn-share" id="shareReferralBtn">Share</button>
      </div>

      <div id="cartLines" class="cart-lines"></div>
    </div>
    <div class="cart-foot">
      <!-- Error display container -->
      <div id="checkoutError" class="checkout-error" role="alert" aria-live="polite" hidden>
        <span id="checkoutErrorMsg"></span>
        <button id="dismissError" class="error-dismiss" aria-label="Dismiss error">√ó</button>
      </div>
      
      <!-- Points Redemption Section -->
      <div id="pointsRedemptionSection" class="points-section" style="display:none;">
        <div class="points-header">
          <div class="points-label">
            <span class="label-icon">üéÅ</span>
            <span>Use Your Rewards Points</span>
          </div>
          <div class="points-balance" id="pointsBalanceDisplay">0 pts available</div>
        </div>
        <div class="points-value" id="pointsValueDisplay">Worth $0.00 credit</div>
        <div class="points-actions">
          <button id="applyPointsBtn" class="btn ghost small" style="width:100%;">Apply Points to Order</button>
        </div>
        <div id="pointsMessage" class="points-message" hidden></div>
        <div id="pointsApplied" class="points-applied" hidden>
          <div class="applied-info">
            <span class="applied-icon">‚úì</span>
            <span id="appliedPointsText">Using 0 points</span>
          </div>
          <div class="applied-discount" id="appliedDiscountText">-$0.00</div>
          <button id="removePointsBtn" class="btn-remove" title="Remove points">√ó</button>
        </div>
      </div>
      
      <!-- Referral Code Input -->
      <div id="referralCodeSection" class="referral-section">
        <div class="referral-header">
          <label for="referralCodeInput" class="referral-label">
            <span class="label-icon">‚ú®</span>
            Have a referral code?
          </label>
          <div class="referral-benefit">Save up to 20% off!</div>
        </div>
        <div class="referral-input-group">
          <input 
            type="text" 
            id="referralCodeInput" 
            class="referral-input" 
            placeholder="Enter code (e.g. JOHN2024)"
            maxlength="12"
            autocomplete="off"
            autocapitalize="characters"
          >
          <button id="applyReferralBtn" class="btn ghost small">Apply</button>
        </div>
        <div id="referralMessage" class="referral-message" hidden></div>
        <div id="referralDiscount" class="referral-discount" hidden>
          <div class="discount-details">
            <span class="discount-label">
              <span class="check-icon">‚úì</span>
              Referral discount applied
            </span>
            <span class="discount-tier" id="referralDiscountAmount">-</span>
          </div>
          <div class="discount-savings" id="referralSavingsAmount" hidden>
            You're saving: <strong id="savingsValue">$0</strong>
          </div>
        </div>
      </div>
      
      <div class="totals">
        <div class="kv"><span>Subtotal</span><strong id="subTotal">$0.00</strong></div>
        <div class="kv" id="pointsDiscountLine" style="display:none;color:var(--azure);font-weight:600;">
          <span>Points discount</span><strong id="pointsDiscountAmount">-$0.00</strong>
        </div>
        <div class="note">Final tax and fees shown at checkout.</div>
      </div>

      <div class="foot-actions">
        <a class="btn ghost" href="/support">Need help?</a>
        <button id="checkout" class="btn azure">Checkout</button>
      </div>
    </div>
  </aside>

  <!-- Backdrop -->
  <div id="backdrop" class="backdrop" hidden></div>
</div>

<!-- Global Loader Overlay -->
<div id="h2s-loader" class="h2s-loader" aria-hidden="true" style="display:none">
  <div class="h2s-loader-stage">
    <div class="h2s-loader-slices" id="h2sLoaderSlices"></div>
  </div>
</div>

<style>
:root{
  --ink:#0b1420; --cobalt:#0a2a5a; --azure:#1493ff; --bg:#ffffff;
  --ring:rgba(20,147,255,.25); --card:#ffffff; --muted:#6b778c;
  --elev:0 10px 26px rgba(0,0,0,.10);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--cobalt);font-family:Archivo,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif}

/* Accessibility */
.sr-only{
  position:absolute; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border-width:0
}

/* Focus styles for accessibility and Best Practices */
*:focus-visible{
  outline: 2px solid var(--azure);
  outline-offset: 2px;
}
button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible{
  outline: 2px solid var(--azure);
  outline-offset: 2px;
}

/* Header */
.h2s-header{
  position:sticky; top:0; z-index:40; background:var(--cobalt); color:#fff;
  width:100vw; margin-left:calc(50% - 50vw); box-shadow:0 6px 18px rgba(0,0,0,.18)
}
.header-inner{
  display:grid; grid-template-columns:auto 1fr auto; align-items:center;
  gap:12px; padding:12px clamp(14px,4vw,32px);
}
.h2s-header .brand img{height:60px; width:auto; display:block}
.h2s-header .title{font-weight:900; font-size:clamp(24px,3.2vw,38px); text-align:center}
.title-link{color:#fff; text-decoration:none}
.h2s-header .tools{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
.search{
  width:min(38vw,520px); 
  max-width:72vw; 
  border:2px solid rgba(255,255,255,.25); 
  background:rgba(255,255,255,.12);
  color:#fff; 
  border-radius:14px; 
  padding:11px 16px; 
  font-size:15px; 
  outline:none;
  transition:all 0.2s ease;
  font-weight:500;
}
.search:focus{
  background:rgba(255,255,255,.18);
  border-color:rgba(255,255,255,.5);
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
}
.search::placeholder{ color:rgba(255,255,255,.75) }
.select{ 
  border:2px solid rgba(255,255,255,.25); 
  background:rgba(255,255,255,.12); 
  color:#fff; 
  border-radius:14px; 
  padding:11px 16px; 
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s ease;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23fff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 12px center;
  padding-right:36px;
}
.select:hover{
  background:rgba(255,255,255,.18);
  border-color:rgba(255,255,255,.4);
}
.select:focus{
  outline:none;
  background:rgba(255,255,255,.18);
  border-color:rgba(255,255,255,.5);
}
.select option{
  background:#1e293b;
  color:#fff;
  padding:10px;
  font-size:15px;
}

/* Header buttons - better contrast on dark background */
.h2s-header .btn.ghost{ 
  background:rgba(255,255,255,0.95); 
  color:var(--cobalt); 
  border-color:rgba(255,255,255,0.4);
  box-shadow:0 2px 8px rgba(0,0,0,0.15);
  font-weight:800;
}
.h2s-header .btn.ghost:hover{ 
  background:#fff; 
  border-color:#fff;
  box-shadow:0 4px 12px rgba(255,255,255,0.3);
  transform:translateY(-2px);
}

.cart-btn{
  position:relative; 
  border:2px solid #fff; 
  color:var(--cobalt); 
  background:#fff; 
  border-radius:12px; 
  padding:11px 16px;
  font-weight:900; 
  cursor:pointer;
  transition:all 0.2s ease;
  box-shadow:0 2px 8px rgba(255,255,255,0.2);
  font-size:15px;
}
.cart-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(255,255,255,0.3);
}
.cart-btn:active{
  transform:translateY(0);
}
.cart-btn #cartCount{ 
  background:var(--azure); 
  color:#fff; 
  font-weight:900; 
  padding:4px 10px; 
  border-radius:12px; 
  margin-left:8px;
  box-shadow:0 2px 6px rgba(20,147,255,0.3);
}
.points-badge{ 
  position:absolute; top:-6px; right:-6px; 
  background:linear-gradient(135deg,#0066FF 0%,#00D9FF 100%); 
  color:#fff; font-size:11px; font-weight:900; 
  padding:3px 7px; border-radius:12px; 
  box-shadow:0 2px 8px rgba(0,102,255,0.4), 0 0 20px rgba(0,217,255,0.3);
  white-space:nowrap;
  animation:badgePulse 2s ease-in-out infinite;
}
@keyframes badgePulse {
  0%, 100% { transform:scale(1); box-shadow:0 2px 8px rgba(0,102,255,0.4), 0 0 20px rgba(0,217,255,0.3); }
  50% { transform:scale(1.05); box-shadow:0 4px 12px rgba(0,102,255,0.6), 0 0 30px rgba(0,217,255,0.5); }
}

/* Outlet */
.h2s-main{ padding:24px clamp(14px,4vw,36px) }

/* Grid */
.grid{ display:grid; gap:18px; grid-template-columns:repeat(1,minmax(0,1fr)) }
@media (min-width:680px){ .grid{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
@media (min-width:1040px){ .grid{ grid-template-columns:repeat(3,minmax(0,1fr)) } }
@media (min-width:1400px){ .grid{ grid-template-columns:repeat(4,minmax(0,1fr)) } }

.card{
  background:var(--card); 
  border:1px solid #e7eaf0; 
  border-radius:20px; 
  overflow:hidden;
  box-shadow:var(--elev); 
  display:flex; 
  flex-direction:column; 
  contain: layout style paint;
  content-visibility: auto; 
  contain-intrinsic-size: 0 450px;
  transition:all 0.3s ease;
}
.card:hover{
  transform:translateY(-6px);
  box-shadow:0 12px 32px rgba(0,0,0,0.15);
  border-color:rgba(20,147,255,0.3);
}
.card .img{ 
  width:100%; 
  height:auto; 
  max-height:190px; 
  object-fit:cover; 
  display:block; 
  background:linear-gradient(135deg,#f5f7fb 0%,#e3f2fd 100%); 
  cursor:pointer; 
  aspect-ratio: 1/1;
  transition:transform 0.3s ease;
}
.card:hover .img{
  transform:scale(1.05);
}
.card .body{ padding:18px }
.card .name{ 
  font-weight:900; 
  font-size:19px; 
  color:var(--cobalt); 
  cursor:pointer;
  transition:color 0.2s ease;
  line-height:1.3;
}
.card:hover .name{
  color:var(--azure);
}
.card .blurb{ 
  margin-top:6px; 
  color:var(--muted); 
  font-size:14px;
  line-height:1.5;
}
.badge{ 
  display:inline-block; 
  font-size:12px; 
  padding:6px 14px; 
  border-radius:24px; 
  background:linear-gradient(135deg,#e3f2fd 0%,#f3e5f5 100%); 
  color:var(--cobalt); 
  font-weight:800; 
  margin-top:10px;
  border:2px solid rgba(20,147,255,0.15);
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  transition:all 0.2s ease;
}
.badge:hover{
  transform:translateY(-1px);
  box-shadow:0 3px 8px rgba(0,0,0,0.12);
  border-color:rgba(20,147,255,0.3);
}

.qty-row{ display:flex; gap:12px; align-items:center; margin-top:14px; flex-wrap:wrap }
.stepper{ 
  display:flex; 
  align-items:center; 
  border:2px solid #d7dce6; 
  border-radius:14px; 
  overflow:hidden; 
  background:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
  transition:all 0.2s ease;
}
.stepper:hover{
  border-color:var(--azure);
  box-shadow:0 3px 8px rgba(20,147,255,0.15);
}
.stepper button{ 
  border:none; 
  background:linear-gradient(135deg,#f5f7fb 0%,#e8edf5 100%); 
  padding:12px 16px; 
  font-weight:900; 
  cursor:pointer; 
  font-size:18px; 
  color:var(--cobalt); 
  transition:all 0.2s ease;
  min-width:44px;
}
.stepper button:hover{ 
  background:linear-gradient(135deg,#e3f2fd 0%,#d1e7f7 100%);
  color:var(--azure);
}
.stepper button:active{ 
  background:#d1e7f7;
  transform:scale(0.95);
}
.stepper input{ 
  width:60px; 
  border:none; 
  text-align:center; 
  padding:12px 0; 
  font-weight:900; 
  font-size:16px;
  color:var(--cobalt);
  background:transparent;
}
.price{ 
  margin-left:auto; 
  font-weight:900; 
  color:var(--cobalt); 
  white-space:nowrap;
  font-size:18px;
}
.lineTotal{ 
  font-weight:900; 
  color:var(--cobalt);
  font-size:17px;
}

/* Trust row & savings */
.trust-row{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
  margin-top:12px;
  padding-top:12px;
  border-top:1px solid #e7eaf0;
  font-size:13px;
}
.trust-item{
  display:flex;
  align-items:center;
  gap:4px;
  color:#059669;
  font-weight:600;
}
.rating{
  display:flex;
  align-items:center;
  gap:4px;
  color:#f59e0b;
}
.rating .count{
  color:var(--muted);
  font-weight:500;
}
.savings-tip{
  background:#fef3c7;
  border-left:4px solid #f59e0b;
  color:#78350f;
  padding:10px 12px;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
  margin-top:10px;
  transition:all 0.3s ease;
}
.savings-tip.active{
  background:#d1fae5;
  border-color:#059669;
  color:#065f46;
}

/* Price display */
.price-group{
  margin-left:auto;
  text-align:right;
}
.price-main{
  font-weight:900;
  color:var(--cobalt);
  font-size:22px;
  line-height:1;
}
.price-sub{
  font-size:11px;
  color:var(--muted);
  margin-top:2px;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.total-group{
  text-align:right;
  margin-left:auto;
}
.total-label{
  font-size:11px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:2px;
}

.actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap }
.btn{ 
  appearance:none; 
  border:2px solid var(--cobalt); 
  background:var(--cobalt); 
  color:#fff; 
  border-radius:12px; 
  padding:12px 20px; 
  font-weight:800; 
  cursor:pointer; 
  transition:all 0.2s ease;
  font-family:inherit;
  font-size:15px;
  box-shadow:0 2px 8px rgba(10,42,90,0.15);
}
.btn:hover{ 
  background:#0d3575; 
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(10,42,90,0.25);
}
.btn:active{ 
  transform:translateY(0);
  box-shadow:0 2px 6px rgba(10,42,90,0.2);
}
.btn.ghost{ 
  background:#fff; 
  color:var(--cobalt); 
  border-color:#d7dce6;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
}
.btn.ghost:hover{ 
  background:#f5f7fb; 
  border-color:var(--azure);
  box-shadow:0 4px 10px rgba(0,0,0,0.12);
}
.btn.azure{ 
  background:linear-gradient(135deg,var(--azure) 0%,#0d7de8 100%); 
  border-color:transparent;
  color:#fff;
  box-shadow:0 4px 12px rgba(20,147,255,0.3);
}
.btn.azure:hover{
  box-shadow:0 6px 16px rgba(20,147,255,0.45);
  transform:translateY(-2px);
}
.btn.small{ 
  padding:10px 16px; 
  font-size:14px;
  font-weight:700;
}
.btn:disabled{
  opacity:0.5;
  cursor:not-allowed;
  transform:none !important;
}

.empty{ 
  text-align:center; 
  color:#6b778c; 
  padding:60px 24px;
  font-size:15px;
  font-weight:600;
  line-height:1.6;
}
.empty::before{
  content:'üõí';
  display:block;
  font-size:64px;
  margin-bottom:16px;
  opacity:0.3;
}

/* Drawer + Modal */
.backdrop{ 
  position:fixed; 
  inset:0; 
  background:rgba(10,42,90,.25); 
  backdrop-filter:blur(2px);
  z-index:49;
  transition:opacity 0.3s ease;
}
.cart{
  position:fixed; 
  right:0; 
  top:0; 
  bottom:0; 
  width:min(540px,92vw); 
  background:#fff; 
  z-index:50;
  box-shadow:-12px 0 36px rgba(0,0,0,.18), -2px 0 12px rgba(0,0,0,.08); 
  transform:translateX(100%); 
  transition:transform .3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex; 
  flex-direction: column; 
  will-change: transform;
}
.cart.open{ transform:none }
.cart-head{ 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  padding:20px 24px; 
  border-bottom:2px solid #e7eaf0; 
  flex-shrink: 0;
  background:linear-gradient(to bottom, #ffffff, #fafbfc);
}
.cart-title{ 
  font-weight:900; 
  font-size:24px; 
  color:var(--cobalt);
  letter-spacing:-0.02em;
}
.icon-btn{ 
  border:2px solid #e7eaf0; 
  border-radius:10px; 
  padding:8px 12px; 
  background:#f5f7fb; 
  cursor:pointer;
  font-weight:900;
  font-size:20px;
  color:var(--cobalt);
  transition:all 0.2s ease;
}
.icon-btn:hover{
  background:#e3f2fd;
  border-color:var(--azure);
  color:var(--azure);
  transform:scale(1.1);
}
.icon-btn:active{
  transform:scale(0.95);
}

/* Cart body - scrollable container for ALL cart content */
.cart-body{ 
  flex: 1 1 auto; 
  overflow-y: auto; 
  overflow-x: hidden;
  min-height: 0;
  -webkit-overflow-scrolling: touch; /* iOS momentum scrolling */
}

.cart-lines{ padding:20px; display:grid; gap:16px; }
.line{ 
  border:2px solid #e7eaf0; 
  border-radius:16px; 
  padding:16px; 
  display:grid; 
  grid-template-columns:1fr auto; 
  gap:16px; 
  align-items: start; 
  contain: layout style;
  background:#fff;
  transition:all 0.2s ease;
}
.line:hover{
  border-color:#d0dae6;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
}
.line .ln-title{ 
  font-weight:900; 
  color:var(--cobalt); 
  line-height: 1.3;
  font-size:16px;
}
.line .ln-sub{ 
  font-size:13px; 
  color:#6b778c; 
  margin-top:6px; 
  line-height: 1.4; 
}
.line .ln-qty{ 
  display:flex; 
  align-items:center; 
  gap:12px; 
  flex-wrap: wrap; 
  margin-top: 10px; 
}
.line .ln-qty .stepper input{ width:56px; font-size: 15px; }
.line .ln-total{ 
  font-weight:900; 
  color:var(--cobalt); 
  font-size: 18px; 
  white-space: nowrap; 
}
.remove{ 
  border:none; 
  background:transparent; 
  color:#9aa5b5; 
  cursor:pointer; 
  font-weight:700; 
  font-size: 13px; 
  text-decoration: none;
  transition:all 0.2s ease;
}
.remove:hover{
  color:#ff4757;
  text-decoration:underline;
}
.link-btn{
  background:transparent;
  border:none;
  color:#1493ff;
  font-weight:700;
  padding:0;
  cursor:pointer;
  text-decoration:underline;
  font-size: 13px;
}
.link-btn:focus{ outline:2px solid rgba(20,147,255,.35); outline-offset:2px }
.cart-foot{ 
  border-top:2px solid #e7eaf0; 
  padding:20px 24px; 
  flex-shrink: 0; 
  background:linear-gradient(to bottom, #fafcff, #ffffff);
  box-shadow:0 -4px 12px rgba(0,0,0,0.04);
}
.totals .kv{ 
  display:flex; 
  justify-content:space-between; 
  padding:10px 0; 
  font-size: 16px;
  color:var(--cobalt);
  font-weight:700;
}
.totals .kv strong{ 
  font-size: 20px;
  font-weight:900;
}
.note{ 
  font-size:13px; 
  color:#6b778c; 
  margin-top: 6px; 
  line-height: 1.5; 
}
.foot-actions{ 
  display:flex; 
  gap:12px; 
  margin-top:16px; 
  flex-wrap:wrap;
}

/* Checkout error display */
/* My Referral Banner (show user their own code) */
.my-referral-banner{
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius:12px;
  padding:14px 16px;
  margin:12px 18px;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  box-shadow:0 4px 12px rgba(102,126,234,0.3);
  animation:slideIn 0.3s ease-out;
}
@keyframes slideIn{
  from{opacity:0;transform:translateY(-10px)}
  to{opacity:1;transform:translateY(0)}
}
.referral-banner-content{
  display:flex;
  align-items:center;
  gap:12px;
  flex:1;
}
.referral-icon{
  font-size:28px;
  line-height:1;
}
.referral-info{
  flex:1;
}
.referral-title{
  font-size:15px;
  font-weight:800;
  margin-bottom:2px;
}
.referral-subtitle{
  font-size:12px;
  opacity:0.9;
}
.referral-code-display{
  display:flex;
  align-items:center;
  gap:6px;
  background:rgba(255,255,255,0.2);
  padding:6px 10px;
  border-radius:8px;
  backdrop-filter:blur(10px);
}
.code-label{
  font-size:11px;
  opacity:0.8;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.code-value{
  font-size:16px;
  font-weight:900;
  letter-spacing:1px;
}
.btn-copy{
  background:transparent;
  border:none;
  cursor:pointer;
  font-size:18px;
  padding:4px;
  opacity:0.8;
  transition:opacity 0.2s;
}
.btn-copy:hover{
  opacity:1;
}
.btn-share{
  background:#fff;
  color:#667eea;
  border:none;
  padding:8px 16px;
  border-radius:8px;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  transition:transform 0.2s;
}
.btn-share:hover{
  transform:scale(1.05);
}

/* Referral code section */
.referral-section{
  padding:16px 0;
  border-top:1px solid #e7eaf0;
  margin-bottom:8px;
}
.referral-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.referral-label{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:14px;
  font-weight:700;
  color:var(--cobalt);
}
.label-icon{
  font-size:16px;
}
.referral-benefit{
  font-size:12px;
  font-weight:700;
  color:#00c853;
  background:#e8f5e9;
  padding:4px 8px;
  border-radius:6px;
}
.referral-input-group{
  display:flex;
  gap:8px;
  margin-bottom:8px;
}
.referral-input{
  flex:1;
  padding:11px 14px;
  border:2px solid #c5cfd9;
  border-radius:10px;
  font-size:14px;
  text-transform:uppercase;
  font-weight:700;
  letter-spacing:1px;
  transition:all 0.2s;
}
.referral-input:focus{
  outline:none;
  border-color:var(--azure);
  box-shadow:0 0 0 4px var(--ring);
  transform:translateY(-1px);
}
.referral-message{
  font-size:13px;
  padding:10px 14px;
  border-radius:10px;
  margin-top:8px;
  display:flex;
  align-items:center;
  gap:8px;
  animation:fadeIn 0.3s ease;
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(-5px)}
  to{opacity:1;transform:translateY(0)}
}
.referral-message.success{
  background:#e8f5e9;
  color:#2e7d32;
  border:1px solid #a5d6a7;
}
.referral-message.error{
  background:#ffebee;
  color:#c62828;
  border:1px solid #ef9a9a;
}
.referral-discount{
  background:linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
  border:2px solid #90caf9;
  border-radius:12px;
  padding:12px 14px;
  margin-top:10px;
  animation:scaleIn 0.3s ease;
}
@keyframes scaleIn{
  from{opacity:0;transform:scale(0.95)}
  to{opacity:1;transform:scale(1)}
}
.discount-details{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}
.discount-label{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:14px;
  color:#0d47a1;
  font-weight:700;
}
.check-icon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:20px;
  height:20px;
  background:#00c853;
  color:#fff;
  border-radius:50%;
  font-size:12px;
  font-weight:900;
}
.discount-tier{
  font-size:15px;
  color:#0d47a1;
  font-weight:900;
  background:rgba(255,255,255,0.7);
  padding:4px 10px;
  border-radius:8px;
}
.discount-savings{
  font-size:13px;
  color:#5e35b1;
  text-align:center;
  padding-top:6px;
  border-top:1px solid rgba(13,71,161,0.1);
}

/* Points Redemption Section */
.points-section{
  background:linear-gradient(135deg, #f8f9fb 0%, #e8eef5 100%);
  border:2px solid var(--azure);
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
}
.points-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}
.points-label{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:14px;
  font-weight:700;
  color:var(--cobalt);
}
.points-balance{
  font-size:13px;
  font-weight:700;
  color:var(--azure);
  background:white;
  padding:4px 10px;
  border-radius:8px;
}
.points-value{
  font-size:12px;
  color:#6b778c;
  margin-bottom:10px;
}
.points-message{
  font-size:12px;
  padding:8px;
  border-radius:6px;
  margin-top:8px;
  text-align:center;
}
.points-message.success{
  background:#e8f5e9;
  color:#2e7d32;
  border:1px solid #c8e6c9;
}
.points-message.error{
  background:#ffebee;
  color:#c62828;
  border:1px solid #ffcdd2;
}
.points-applied{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:white;
  border:2px solid #4caf50;
  border-radius:8px;
  padding:10px 12px;
  margin-top:8px;
}
.applied-info{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
  font-weight:600;
  color:#2e7d32;
}
.applied-icon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:20px;
  height:20px;
  background:#4caf50;
  color:#fff;
  border-radius:50%;
  font-size:12px;
  font-weight:900;
}
.applied-discount{
  font-size:16px;
  font-weight:900;
  color:#2e7d32;
}
.btn-remove{
  background:transparent;
  border:none;
  color:#999;
  font-size:24px;
  line-height:1;
  cursor:pointer;
  padding:0;
  width:24px;
  height:24px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:50%;
  transition:background 0.2s, color 0.2s;
}
.btn-remove:hover{
  background:#ffebee;
  color:#c62828;
}

.checkout-error{
  background:#fee;
  border:1px solid #fcc;
  border-radius:12px;
  padding:12px 14px;
  margin-bottom:14px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  color:#c00;
  font-size:14px;
  line-height:1.4;
}
.checkout-error[hidden]{ display:none; }
.error-dismiss{
  background:transparent;
  border:none;
  color:#c00;
  font-size:20px;
  font-weight:700;
  cursor:pointer;
  padding:0;
  width:24px;
  height:24px;
  flex-shrink:0;
  line-height:1;
}
.error-dismiss:hover{ color:#900; }

/* Sign-in banner (subtle nudge, not blocker) */
.signin-banner{
  background:linear-gradient(135deg, #eef5ff 0%, #e0f0ff 100%);
  border:1px solid #c2ddfa;
  border-radius:12px;
  padding:12px 14px;
  margin:14px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap: wrap;
  flex-shrink: 0;
}
.signin-banner > div{ flex: 1 1 180px; }
.signin-banner strong{ display:block; font-weight:800; color:#0a2a5a; margin-bottom:4px; }
.signin-banner > div > div{ font-size:13px; color:#5d6a7e; line-height: 1.4; }
.signin-banner .btn{ flex-shrink: 0; }

/* Bundles UI */
.bundle-panel{ margin:12px 16px; display:grid; gap:10px; flex-shrink: 0; }
.bundle-card{
  border:1px solid #d7eafc; background:#f6fbff; border-radius:12px; padding:10px 12px; display:grid; gap:6px
}
.bundle-card .b-head{ display:flex; align-items:center; justify-content:space-between; gap:10px }
.bundle-card .b-name{ font-weight:900 }
.bundle-card .b-save{ font-weight:800; color:#0a2a5a }
.bundle-card .b-list{ font-size:13px; color:#0b1420; opacity:.85 }
.bundle-card .b-actions{ display:flex; gap:10px; flex-wrap:wrap }
.bundle-banner{ display:none }

/* Recs UI (new) */
.recs-panel{ 
  margin:0 20px 16px 20px; 
  display:grid; 
  gap:12px; 
  flex-shrink: 0; 
}
.rec-card{
  border:2px solid #e7eaf0; 
  background:#fff; 
  border-radius:14px; 
  padding:14px 16px; 
  display:grid; 
  grid-template-columns:64px 1fr auto; 
  gap:12px; 
  align-items:center;
  transition:all 0.2s ease;
  cursor:pointer;
}
.rec-card:hover{
  border-color:#c8d5e3;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  transform:translateY(-2px);
}
.rec-card img{ 
  width:64px; 
  height:64px; 
  aspect-ratio: 1/1; 
  object-fit:cover; 
  border-radius:12px; 
  background:#f2f6ff;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
}
.rec-card .r-text{ display:grid; gap:5px }
.rec-card .r-title{ 
  font-weight:900;
  font-size:15px;
  color:var(--cobalt);
}
.rec-card .r-msg{ 
  font-size:13px; 
  color:#6b778c; 
  line-height:1.4;
}
/* small dismiss link */
.rec-dismiss{ 
  border:none;
  background:transparent;
  color:#9aa5b5;
  cursor:pointer;
  font-size:12px;
  text-decoration:none;
  padding:0;
  transition:all 0.2s ease;
}
.rec-dismiss:hover{
  color:#ff4757;
  text-decoration:underline;
}

/* Skeleton loader */
.skeleton-card{ background:#f2f6ff; border-radius:18px; height:320px; animation:pulse 1.5s ease-in-out infinite; will-change: opacity; }
@keyframes pulse { 0%, 100% { opacity:1 } 50% { opacity:.6 } }

/* Product/Membership Page */
.pd-wrap{ display:grid; gap:24px; grid-template-columns:1fr }
@media (min-width:980px){ .pd-wrap{ grid-template-columns:1.1fr .9fr } }
.pd-hero{ border:1px solid #e7eaf0; border-radius:18px; overflow:hidden; background:#f5f7fb }
.pd-hero img{ width:100%; height:auto; object-fit:cover; max-height:520px; display:block }
.pd-info .title{ font-weight:900; font-size:clamp(22px,3vw,34px) }
.pd-info .blurb{ margin-top:6px; opacity:.95 }
.pd-info .long{ margin-top:12px; color:#374151; line-height:1.45 }
.pd-info .long ul{ margin:8px 0 0 18px }
.pd-box{ border:1px solid #e7eaf0; border-radius:16px; padding:14px; background:#fff; box-shadow:var(--elev) }
.pd-qty{ display:flex; align-items:center; gap:10px }
.pd-unit{ margin-left:auto; font-weight:900 }
.pd-total{ font-weight:900; color:#0a2a5a }
.pd-actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap }
.pd-back{ margin-bottom:18px }
.pd-breadcrumb a{ color:#1493ff; text-decoration:none }

/* === ENHANCED FORM STYLING === */
.form{ 
  display:grid; 
  gap:16px; 
  max-width:520px; 
  margin:0 auto;
  padding:2rem;
  background:#fff;
  border-radius:20px;
  box-shadow:0 10px 40px rgba(0,0,0,0.08);
}
.form h2{
  text-align:center;
  background:linear-gradient(135deg,#0066FF 0%,#00D9FF 100%);
  -webkit-background-clip:text;
  background-clip:text;
  -webkit-text-fill-color:transparent;
  font-size:clamp(24px,4vw,32px);
  margin-bottom:0.5rem;
}
.inp{ 
  border:2px solid #e7eaf0; 
  border-radius:12px; 
  padding:14px 16px; 
  font-size:15px; 
  outline:none;
  transition:all 0.2s ease;
  background:#fff;
  font-family:inherit;
}
.inp:focus{
  border-color:#0066FF;
  box-shadow:0 0 0 3px rgba(0,102,255,0.1);
}
.inp:disabled{
  background:#f5f7fb;
  cursor:not-allowed;
  opacity:0.6;
}
.help{ 
  color:#6b778c; 
  font-size:13px; 
  margin-top:4px;
  line-height:1.4;
}
.help strong{
  color:#0066FF;
  font-weight:700;
}

/* Button Enhancements */
.btn.azure{
  background:linear-gradient(135deg,#0066FF 0%,#00D9FF 100%);
  box-shadow:0 4px 16px rgba(0,102,255,0.25);
  transition:all 0.2s ease;
}
.btn.azure:hover{
  box-shadow:0 6px 24px rgba(0,102,255,0.4);
  transform:translateY(-1px);
}
.btn.ghost{
  transition:all 0.2s ease;
}
.btn.ghost:hover{
  background:rgba(0,102,255,0.05);
  color:#0066FF;
}

/* Global Loader */
.h2s-loader{ position:fixed; inset:0; z-index:99999; display:grid; place-items:center; background:transparent; pointer-events:auto }
.h2s-loader.hidden{ pointer-events:none; }
.h2s-loader-stage{ position:relative; width:min(72vw,520px); aspect-ratio:5/2 }
.h2s-loader-slices{ position:absolute; inset:0 }
.h2s-loader-slice{
  position:absolute; top:0; bottom:0; overflow:hidden; opacity:0; transform:translateY(24px);
  will-change:transform,opacity; animation:h2s-split 2.2s cubic-bezier(.22,.8,.32,1) infinite;
  animation-delay:calc(var(--i)*0.06s)
}
.h2s-loader-slice img{ position:absolute; inset:0 auto 0 0; width:100%; height:100%; object-fit:contain }
@keyframes h2s-split{
  0%{opacity:0;transform:translateY(24px)}
  36%{opacity:1;transform:translateY(0)}
  68%{opacity:1;transform:translateY(0)}
  100%{opacity:0;transform:translateY(-12px)}
}
@media (prefers-reduced-motion: reduce){
  .h2s-loader-slice{ animation:none; opacity:1; transform:none }
}

/* (Promo CSS left harmlessly; UI removed) */
.promo-row{ margin:10px 0; }
.promo-applied{
  margin-top:8px; font-size:13px; color:#0a2a5a; background:#eef5ff; border:1px solid #d7eafc;
  padding:8px 10px; border-radius:10px; display:inline-flex; align-items:center; gap:10px
}
.promo-applied .remove{ color:#6b778c; text-decoration:underline }

/* Calendar embed box */
.cal-embed{ margin-top:14px; border:1px solid #e7eaf0; border-radius:16px; overflow:hidden; background:#fff; box-shadow:var(--elev) }
.cal-embed iframe{ width:100%; height:860px; border:0; display:block }

.details-grid{ display:grid; gap:8px }
.details-grid .row{ display:flex; justify-content:space-between; gap:12px }
.details-grid .k{ font-weight:800; color:#6b778c }
.details-grid .v{ text-align:right }

/* ===== MOBILE-ONLY ENHANCEMENTS (no desktop changes) ===== */
@media (max-width: 640px){
  /* eliminate horizontal scroll induced by 100vw on mobile */
  .h2s-header{ width:100%; margin-left:0; }

  .header-inner{
    grid-template-columns:1fr;
    grid-template-rows:auto auto;
    gap:10px;
    padding:10px 12px;
  }
  .h2s-header .brand{ display:flex; justify-content:center }
  .h2s-header .brand img{ height:44px }
  .h2s-header .title{ font-size:24px }
  .h2s-header .tools{
    gap:8px;
    flex-wrap:wrap;
    justify-content:space-between;
  }
  .search{
    width:100%;
    max-width:none;
    font-size:16px; /* prevent iOS zoom */
  }
  .select, .btn.small, .cart-btn{
    flex:1 1 calc(50% - 6px);
    min-width:0;
    font-size:16px; /* prevent iOS zoom */
  }
  .btn, .inp{ font-size:16px } /* prevent iOS zoom */

  .h2s-main{ padding:16px 12px }

  .card .img{ height:160px }

  /* fix color typos only on mobile so desktop remains visually identical */
  .price{ color:var(--cobalt) }
  .line .ln-title{ color:var(--cobalt) }

  /* cart drawer + scrollers fit better on small viewports */
  .cart{ width:100vw; }
  .cart-body{ 
    /* No max-height restriction - let it fill available space and scroll naturally */
    padding-bottom: 20px; /* breathing room at bottom */
  }
  .cart-lines{ 
    /* Remove max-height - now part of unified scroll container */
    padding-bottom: 0; /* reduce extra padding at bottom */
  }
  .foot-actions{ 
    justify-content: space-between;
    flex-wrap: nowrap; /* keep buttons on same row on mobile */
  }
  .foot-actions .btn{
    flex: 1 1 auto; /* buttons flex to fill space */
    min-width: 0; /* allow shrinking */
  }

  /* Make panels more compact on mobile */
  .signin-banner{
    margin: 12px 12px;
    padding: 10px 12px;
    font-size: 14px;
  }
  .signin-banner strong{ font-size: 15px; margin-bottom: 2px; }
  .signin-banner > div > div{ font-size: 12px; }

  .bundle-panel{ 
    margin: 12px 12px; 
    gap: 8px;
  }
  .bundle-card{
    padding: 8px 10px;
  }
  .bundle-card .b-name{ font-size: 15px; }
  .bundle-card .b-list{ font-size: 12px; }

  .recs-panel{ 
    margin: 0 12px 12px 12px; 
    gap: 8px;
  }
  .rec-card{
    padding: 8px 10px;
    grid-template-columns: 52px 1fr auto;
  }
  .rec-card img{ width: 52px; }
  .rec-card .r-title{ font-size: 14px; }
  .rec-card .r-msg{ font-size: 12px; }

  .cart-lines{ padding: 12px; gap: 12px; }
  .line{ padding: 10px; }

  /* Guest checkout form styling on mobile */
  #guestCheckoutForm{
    border-radius: 12px 12px 0 0;
    box-shadow: 0 -4px 12px rgba(0,0,0,.08);
  }
  
  /* Ensure cart footer doesn't get too tall */
  .cart-foot{
    max-height: 60vh; /* Don't let footer consume more than 60% of viewport */
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* product page media */
  .pd-hero img{ max-height:48vh }
  .pd-actions{ gap:8px }
  .pd-qty .stepper input{ width:52px }

  /* calendar embed height on mobile */
  .cal-embed iframe{ height:78vh }

  /* account details rows wrap nicely */
  .details-grid .row{ flex-wrap:wrap }
  .details-grid .v{ width:100%; text-align:left; word-break:break-word }
}

/* ===== AUTH SYSTEM STYLES ===== */
.auth-container{
  min-height:70vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:24px;
  animation:fadeIn 0.4s ease;
}
.auth-card{
  background:#fff;
  border-radius:20px;
  box-shadow:0 12px 40px rgba(0,0,0,0.12);
  padding:40px;
  max-width:520px;
  width:100%;
  animation:slideUp 0.4s ease;
}
@keyframes slideUp{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}
.auth-header{
  text-align:center;
  margin-bottom:32px;
}
.auth-icon{
  font-size:52px;
  line-height:1;
  margin-bottom:16px;
  animation:bounce 0.6s ease;
}
@keyframes bounce{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-10px)}
}
.auth-title{
  font-size:28px;
  font-weight:900;
  color:var(--cobalt);
  margin:0 0 8px 0;
}
.auth-subtitle{
  font-size:15px;
  color:var(--muted);
  margin:0;
  line-height:1.5;
}
.auth-benefits{
  display:grid;
  gap:12px;
  margin-bottom:28px;
  padding:20px;
  background:linear-gradient(135deg, rgba(20,147,255,0.05) 0%, rgba(103,58,183,0.05) 100%);
  border-radius:12px;
  border:1px solid rgba(20,147,255,0.1);
}
.benefit-item{
  display:flex;
  align-items:center;
  gap:12px;
  font-size:14px;
  color:var(--cobalt);
}
.benefit-icon{
  font-size:24px;
  line-height:1;
}
.benefit-text{
  font-weight:600;
}
.auth-actions{
  display:grid;
  gap:12px;
  margin-bottom:20px;
}
.btn-auth{
  appearance:none;
  border:none;
  border-radius:12px;
  padding:16px 24px;
  font-size:16px;
  font-weight:800;
  font-family:inherit;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  transition:all 0.2s ease;
  position:relative;
}
.btn-auth:disabled{
  opacity:0.6;
  cursor:not-allowed;
}
.btn-auth:focus-visible{
  outline:3px solid var(--ring);
  outline-offset:2px;
}
.btn-primary{
  background:linear-gradient(135deg, var(--azure) 0%, #673ab7 100%);
  color:#fff;
  box-shadow:0 4px 12px rgba(20,147,255,0.3);
}
.btn-primary:hover:not(:disabled){
  transform:translateY(-2px);
  box-shadow:0 6px 16px rgba(20,147,255,0.4);
}
.btn-primary:active:not(:disabled){
  transform:translateY(0);
}
.btn-arrow{
  font-size:20px;
  transition:transform 0.2s;
}
.btn-primary:hover .btn-arrow{
  transform:translateX(4px);
}
.btn-secondary{
  background:#fff;
  color:var(--cobalt);
  border:2px solid #e7eaf0;
}
.btn-secondary:hover:not(:disabled){
  background:#f5f7fb;
  border-color:var(--azure);
}
.link-back{
  background:transparent;
  border:none;
  color:var(--muted);
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  text-align:center;
  padding:12px;
  margin-top:12px;
  transition:color 0.2s;
}
.link-back:hover{
  color:var(--azure);
}
.auth-form{
  display:grid;
  gap:20px;
}
.form-group{
  display:grid;
  gap:8px;
}
.form-label{
  font-size:14px;
  font-weight:700;
  color:var(--cobalt);
}
.label-optional{
  font-weight:400;
  color:var(--muted);
  font-size:13px;
}
.form-label-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.link-text-small{
  background:transparent;
  border:none;
  color:var(--azure);
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  text-decoration:none;
  transition:color 0.2s;
}
.link-text-small:hover{
  color:#673ab7;
  text-decoration:underline;
}
.input-wrapper{
  position:relative;
  display:flex;
  align-items:center;
}
.input-wrapper.input-highlighted{
  animation:highlight 0.5s ease;
}
@keyframes highlight{
  0%,100%{transform:scale(1)}
  50%{transform:scale(1.02)}
}
.input-icon{
  position:absolute;
  left:14px;
  font-size:18px;
  pointer-events:none;
}
.form-input{
  width:100%;
  padding:14px 14px 14px 46px;
  border:2px solid #d7dce6;
  border-radius:12px;
  font-size:15px;
  font-family:inherit;
  color:var(--cobalt);
  transition:all 0.2s;
  background:#fff;
}
.form-input:focus{
  outline:none;
  border-color:var(--azure);
  box-shadow:0 0 0 4px var(--ring);
}
.form-input::placeholder{
  color:var(--muted);
}
.input-highlighted .form-input{
  border-color:var(--azure);
  background:rgba(20,147,255,0.03);
}
.toggle-password{
  position:absolute;
  right:12px;
  background:transparent;
  border:none;
  cursor:pointer;
  font-size:11px;
  padding:4px 6px;
  opacity:0.5;
  transition:opacity 0.2s;
  color:#6b778c;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.toggle-password:hover{
  opacity:1;
}
.password-strength{
  display:grid;
  gap:6px;
}
.strength-bar{
  height:4px;
  background:#e7eaf0;
  border-radius:2px;
  overflow:hidden;
}
.strength-fill{
  height:100%;
  width:0%;
  transition:all 0.3s ease;
  border-radius:2px;
}
.strength-text{
  font-size:12px;
  font-weight:600;
  text-align:right;
}
.form-hint{
  font-size:13px;
  color:var(--muted);
  line-height:1.4;
}
.form-checkbox{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:14px;
  color:var(--cobalt);
}
.form-checkbox input[type="checkbox"]{
  width:18px;
  height:18px;
  cursor:pointer;
}
.form-checkbox label{
  cursor:pointer;
  user-select:none;
}
.form-message{
  font-size:14px;
  padding:12px 16px;
  border-radius:10px;
  font-weight:600;
  display:none;
  align-items:center;
  gap:8px;
  animation:fadeIn 0.3s ease;
}
.form-message:not(:empty){
  display:flex;
}
.form-message.success{
  background:#e8f5e9;
  color:#2e7d32;
  border:1px solid #a5d6a7;
}
.form-message.error{
  background:#ffebee;
  color:#c62828;
  border:1px solid #ef9a9a;
}
.btn-loading{
  position:relative;
}
.btn-loader{
  display:flex;
  align-items:center;
  gap:10px;
}
.spinner{
  width:16px;
  height:16px;
  border:2px solid rgba(255,255,255,0.3);
  border-top-color:#fff;
  border-radius:50%;
  animation:spin 0.6s linear infinite;
}
@keyframes spin{
  to{transform:rotate(360deg)}
}
.auth-divider{
  text-align:center;
  position:relative;
  margin:24px 0;
}
.auth-divider span{
  background:#fff;
  padding:0 16px;
  color:var(--muted);
  font-size:13px;
  font-weight:600;
  position:relative;
  z-index:1;
}
.auth-divider::before{
  content:'';
  position:absolute;
  left:0;
  right:0;
  top:50%;
  height:1px;
  background:#e7eaf0;
}
.auth-social{
  display:grid;
  gap:10px;
}
.btn-social{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:12px 20px;
  border:2px solid #e7eaf0;
  border-radius:12px;
  background:#fff;
  color:var(--cobalt);
  font-size:14px;
  font-weight:700;
  font-family:inherit;
  cursor:pointer;
  transition:all 0.2s;
}
.btn-social:hover:not(:disabled){
  background:#f5f7fb;
  border-color:var(--azure);
}
.btn-social:disabled{
  opacity:0.5;
  cursor:not-allowed;
}
.social-icon{
  font-size:20px;
}
.auth-footer{
  text-align:center;
  margin-top:24px;
  font-size:14px;
  color:var(--muted);
}
.link-text{
  background:transparent;
  border:none;
  color:var(--azure);
  font-weight:700;
  cursor:pointer;
  text-decoration:none;
  transition:color 0.2s;
  font-family:inherit;
  padding:0;
}
.link-text:hover{
  color:#673ab7;
  text-decoration:underline;
}
.referral-promo-card{
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius:14px;
  padding:16px 20px;
  color:#fff;
  display:flex;
  align-items:center;
  gap:14px;
  margin-bottom:24px;
  box-shadow:0 6px 20px rgba(102,126,234,0.3);
  animation:slideDown 0.4s ease;
}
@keyframes slideDown{
  from{opacity:0;transform:translateY(-10px)}
  to{opacity:1;transform:translateY(0)}
}
.promo-icon{
  font-size:40px;
  line-height:1;
}
.promo-content{
  flex:1;
}
.promo-title{
  font-size:15px;
  font-weight:800;
  margin-bottom:4px;
}
.promo-text{
  font-size:13px;
  opacity:0.9;
  margin-bottom:4px;
}
.promo-bonus{
  font-size:14px;
  font-weight:700;
  background:rgba(255,255,255,0.2);
  padding:6px 12px;
  border-radius:8px;
  display:inline-block;
  backdrop-filter:blur(10px);
}

@media (max-width:680px){
  .auth-container{
    padding:16px;
    align-items:flex-start;
  }
  .auth-card{
    padding:28px 24px;
    border-radius:16px;
  }
  .auth-icon{
    font-size:42px;
  }
  .auth-title{
    font-size:24px;
  }
  .btn-auth{
    padding:14px 20px;
    font-size:15px;
  }
}
</style>

<!-- Critical inline script: Show skeleton immediately, start API fetch -->
<script>
// Minimal critical-path code - executes immediately
(function(){
  // Show loader instantly
  const loader = document.getElementById('h2s-loader');
  if(loader) loader.classList.remove('hidden');
  
  // Start prefetching catalog in background (don't wait for DOMContentLoaded)
  const API = 'https://script.google.com/macros/s/AKfycbzN7912CA8vCLEGRhnOqz6tA2KOAhlHDqZxEgxOh_n3_aDvDRfYvgqyW4LUxQNqnEgu/exec';
  const CACHE_KEY = 'h2s_catalog_v2'; // Changed from v1 to bust cache
  const CACHE_TTL = 10 * 60 * 1000; // 10 minutes - balance between performance and freshness
  
  // Check cache
  let catalogPromise;
  try {
    const cached = localStorage.getItem(CACHE_KEY);
    if(cached){
      const data = JSON.parse(cached);
      if(Date.now() - data.timestamp < CACHE_TTL){
        catalogPromise = Promise.resolve(data.catalog);
      }
    }
  } catch(_){}
  
  // Start fetch if no cache
  if(!catalogPromise){
    // Load full catalog (homepage view was causing empty results)
    catalogPromise = fetch(API + "?action=catalog")
      .then(res => res.json())
      .then(catalog => {
        try {
          localStorage.setItem(CACHE_KEY, JSON.stringify({
            catalog,
            timestamp: Date.now()
          }));
        } catch(_){}
        return catalog;
      });
  }
  
  // Make available to main app
  window.__catalogPromise = catalogPromise;
})();
</script>

<!-- Main application script - deferred to not block rendering -->
<script>
(()=>{
// === CONFIG ===
const API = "https://script.google.com/macros/s/AKfycbzN7912CA8vCLEGRhnOqz6tA2KOAhlHDqZxEgxOh_n3_aDvDRfYvgqyW4LUxQNqnEgu/exec";
const LOADER_SVG = "https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68e164b2554f6a7ab7e50837.svg";

// Your GHL Calendar widget URL
const CAL_FORM_URL = "https://api.leadconnectorhq.com/widget/booking/RjwOQacM3FAjRNCfm6uU";

// === TRACKING CONFIG ===
const DASH_URL = "https://script.google.com/macros/s/AKfycbxVsGP8EeAZmfRcW9LjY3fm1F9iWvXMO7RlT4VP7Tj1BV0BOkeBi6GAkASQhEZJ7h9Y/exec";
const STORE_KEY = 'h2s_session_id';
let sessionId = sessionStorage.getItem(STORE_KEY);
if (!sessionId) {
  sessionId = crypto.randomUUID();
  sessionStorage.setItem(STORE_KEY, sessionId);
}

// Tracking helper (executes async, doesn't block main thread)
// ENHANCED: Now includes SHA-256 hashing for privacy compliance + advanced matching
async function sha256(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

function normalizePhone(phone) {
  const digits = String(phone || '').replace(/\D/g, '');
  if (digits.length === 10) return '+1' + digits;
  if (digits.length === 11 && digits[0] === '1') return '+' + digits;
  return digits.length > 0 ? '+' + digits : '';
}

async function buildAdvancedParams() {
  const params = {};
  
  // Get user data from session (if logged in)
  const userData = user || {};
  const email = userData.email || '';
  const phone = userData.phone || '';
  const name = userData.name || '';
  
  // Hash PII (Privacy Compliance)
  if (email) params.em = await sha256(email.toLowerCase().trim());
  if (phone) {
    const normalized = normalizePhone(phone);
    if (normalized) params.ph = await sha256(normalized);
  }
  if (name) {
    const parts = name.trim().split(/\s+/);
    if (parts[0]) params.fn = await sha256(parts[0].toLowerCase());
    if (parts[parts.length - 1] && parts.length > 1) {
      params.ln = await sha256(parts[parts.length - 1].toLowerCase());
    }
  }
  
  // External ID (session-based user identifier)
  if (email) params.external_id = await sha256(email.toLowerCase().trim());
  else if (sessionId) params.external_id = sessionId;
  
  // Facebook cookies (fbp = browser ID, fbc = click ID from ad)
  const getCookie = (name) => {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? match[2] : null;
  };
  params.fbp = getCookie('_fbp') || null;
  params.fbc = getCookie('_fbc') || null;
  
  // User agent
  params.client_user_agent = navigator.userAgent;
  
  return params;
}

async function h2sTrack(eventName, metadata = {}) {
  // Use setTimeout to avoid blocking critical path
  setTimeout(async () => {
    const eventId = crypto.randomUUID();
    const payload = {
      event: eventName,
      event_id: eventId,
      page: '/shop',
      timestamp: new Date().toISOString(),
      sessionId,
      userAgent: navigator.userAgent,
      referrer: document.referrer,
      ...metadata
    };
    
    // Meta Pixel tracking with ADVANCED MATCHING
    if (window.fbq) {
      const fbData = {};
      
      // E-commerce standard parameters
      if (metadata.product_id) fbData.content_ids = [metadata.product_id];
      if (metadata.product_name) fbData.content_name = metadata.product_name;
      if (metadata.price) fbData.value = metadata.price;
      if (metadata.currency) fbData.currency = metadata.currency;
      if (metadata.cart_total) fbData.value = metadata.cart_total;
      if (metadata.value) fbData.value = metadata.value;
      if (metadata.num_items) fbData.num_items = metadata.num_items;
      
      // Purchase event specific
      if (eventName === 'Purchase' && metadata.order_id) {
        fbData.transaction_id = metadata.order_id; // Critical for deduplication
      }
      
      // InitiateCheckout specific
      if (eventName === 'InitiateCheckout') {
        fbData.content_type = 'product';
        // Add all cart items to content_ids
        if (cart && cart.length) {
          fbData.content_ids = cart.map(item => 
            item.type === 'bundle' ? item.bundle_id : item.service_id
          );
        }
      }
      
      // ViewContent specific
      if (eventName === 'ViewContent' && metadata.content_type) {
        fbData.content_type = metadata.content_type;
      }
      
      // AddToCart specific
      if (eventName === 'AddToCart') {
        fbData.content_type = 'product';
      }
      
      // ADVANCED MATCHING (hashed PII for better attribution)
      const advancedParams = await buildAdvancedParams();
      
      fbq('track', eventName, fbData, { 
        eventID: eventId,
        ...advancedParams
      });
    }
  
  // Dashboard webhook - use sendBeacon for better performance (Best Practices)
  if (navigator.sendBeacon) {
    try {
      const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
      navigator.sendBeacon(DASH_URL, blob);
    } catch(_) {
      // Fallback to fetch if sendBeacon fails
      fetch(DASH_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).catch(() => {});
    }
  } else {
    // Fallback for browsers without sendBeacon
    fetch(DASH_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).catch(() => {});
  }
  }, 0); // End setTimeout - tracking happens async
}

// === STATE ===
let catalog = { services:[], serviceOptions:[], priceTiers:[], bundles:[], bundleItems:[], recommendations:[], memberships:[], membershipPrices:[] };
let cart = loadCart();
let lastSearch = "", lastCat = "";
let user = loadUser();

// DEBUG: Log initial user state
console.log('[Init] Loaded user from localStorage:', user);
console.log('[Init] user.points value:', user.points, 'Type:', typeof user.points);

// CRITICAL FIX: If user has points property set to null, delete it so API fetch will trigger
if(user && user.email && user.points === null){
  console.log('[Init] Removing null points property to trigger fresh fetch');
  delete user.points;
}

let referralCode = loadReferralCode(); // Load from cookie/localStorage
let referralData = null; // Store validated code data
let appliedPoints = 0; // Track points being used for this order
let pointsDiscount = 0; // Dollar amount of discount from points

// === LOADER ===
const loader = document.getElementById('h2s-loader');
const loaderTray = document.getElementById('h2sLoaderSlices');
let loaderBuilt = false;

function buildLoader(svgSrc, slices=8){
  if(!loaderTray || loaderBuilt) return;
  loaderTray.innerHTML = "";
  for (let i = 0; i < slices; i++) {
    const w = 100/slices;
    const s = document.createElement('div');
    s.className = 'h2s-loader-slice';
    s.style.left = (i*w) + '%';
    s.style.width = w + '%';
    s.style.setProperty('--i', i);
    const img = document.createElement('img');
    img.alt = 'Home2Smart'; img.src = svgSrc;
    img.style.width = (slices*100) + '%';
    img.style.height = '100%';
    img.style.left = (-i*100) + '%';
    s.appendChild(img);
    loaderTray.appendChild(s);
  }
  loaderBuilt = true;
}
function showLoader(){ 
  if(loader){ 
    if(!loaderBuilt) buildLoader(LOADER_SVG, 8); 
    loader.style.display = "grid"; 
  } 
}
function hideLoader(){ if(loader){ loader.classList.add('hidden'); setTimeout(()=>{ loader.style.display="none"; loader.classList.remove('hidden'); }, 200); } }

// === REVIEW DATA ENRICHMENT ===
async function enrichCatalogWithReviews(){
  if(!catalog || !catalog.services) return;
  
  // Batch fetch review stats for all services
  const promises = catalog.services.map(async (s) => {
    try{
      const res = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'get_service_reviews', service_id: s.service_id })
      });
      const data = await res.json();
      
      if(data.ok && data.has_reviews){
        s.avg_rating = data.avg_rating;
        s.review_count = data.review_count;
        s.install_time_minutes = data.install_time_minutes;
      } else {
        // No reviews - don't set any data (trust row won't render)
        s.avg_rating = 0;
        s.review_count = 0;
      }
    } catch(err){
      console.warn(`Failed to fetch reviews for ${s.service_id}:`, err);
    }
  });
  
  await Promise.all(promises);
  
  // Re-render shop with enriched data if currently on shop view
  const view = getParam('view') || 'shop';
  if(view === 'shop') renderShop();
}

// === INIT ===
document.addEventListener('DOMContentLoaded', init);

async function init(){
  wireHeader();
  wireCart();
  showLoader();
  
  try{
    // Use prefetched catalog if available
    if(window.__catalogPromise){
      catalog = await window.__catalogPromise;
      delete window.__catalogPromise; // Clean up
    } else {
      // Fallback if prefetch didn't work
      const res = await fetch(API + "?action=catalog");
      catalog = await res.json();
    }
    
    if(!catalog.ok) throw new Error(catalog.error||"Failed to load catalog");
    
    // Fetch real review data for all services (async, don't block rendering)
    enrichCatalogWithReviews().catch(err => console.warn('Review fetch failed:', err));
    
    paintFilters();
    
    // Hydrate cart from URL if present
    try{
      const u = new URL(location.href);
      const cartParam = u.searchParams.get('cart');
      if(cartParam){
        const urlCart = decodeCartFromUrl(cartParam);
        if(urlCart.length){
          cart = urlCart;
          saveCart(); // This will sync to localStorage and URL
          openCart(); // Auto-open cart to show loaded items
        }
      }
    }catch(_){}

    route();
    updateCartBadge();
    renderSigninState();
    paintCart();
    // If Stripe sent us back with ?back, open the cart once, then clean the URL
    try{
      const u = new URL(location.href);
      if (u.searchParams.has('back')) {
        openCart();
        u.searchParams.delete('back');
        history.replaceState({}, '', u.toString());
      }
    }catch(_){}
    window.addEventListener('popstate', route);
    
    // Add passive listeners for scroll/touch to prevent blocking (Best Practices)
    const passiveOpts = { passive: true };
    ['touchstart', 'touchmove', 'wheel'].forEach(eventType => {
      window.addEventListener(eventType, () => {}, passiveOpts);
    });
    
    // Track page view and engagement (deferred to idle time)
    if('requestIdleCallback' in window){
      requestIdleCallback(() => {
        h2sTrack('PageView', { page: '/shop', view: getParam('view') || 'grid' });
        setTimeout(() => h2sTrack('ViewContent', { page: '/shop' }), 3000);
      });
    } else {
      setTimeout(() => {
        h2sTrack('PageView', { page: '/shop', view: getParam('view') || 'grid' });
        setTimeout(() => h2sTrack('ViewContent', { page: '/shop' }), 3000);
      }, 1);
    }
  }catch(e){
    byId('outlet').innerHTML = `<div class="empty">Couldn‚Äôt load catalog. ${String(e)}</div>`;
  }finally{
    hideLoader();
  }
}

// === ROUTER ===
function route(){
  // sync category from URL
  const catParam = getParam('cat') || "";
  lastCat = catParam;
  const catSel = byId('catFilter');
  if (catSel && catSel.value !== lastCat) catSel.value = lastCat;

  const view = getParam('view');
  const p = getParam('p');
  const m = getParam('m');
  const token = getParam('token');

  if(view === 'auth'){ renderAuthGate(); return; }
  if(view === 'signin'){ renderSignIn(); return; }
  if(view === 'signup'){ renderSignUp(); return; }
  if(view === 'account'){ renderAccount(); return; }
  if(view === 'rewards'){ renderRewards(); return; }

  if(view === 'forgot'){ renderForgot(); return; }
  if(view === 'reset'){ renderReset(token); return; }

  if(view === 'shopsuccess'){ renderShopSuccess(); return; }
  // Support both legacy (?view=calreturn&date&time) and GHL default (?view=apptreturn&start&end&tz)
  if(view === 'calreturn' || view === 'apptreturn'){ handleCalReturn(); return; }

  if(m){ renderMembershipPage(m); return; }

  if(p){ renderProductPage(p); return; }
  renderGrid();
}

function renderRewards() {
  if(!user || !user.email) {
    navSet({view:'auth'});
    return;
  }
  
  outlet.innerHTML = `
    <div class="rewards-page">
      <!-- Full Bleed Hero -->
      <div style="background:linear-gradient(135deg, var(--cobalt) 0%, var(--azure) 100%); color:white; padding:3rem clamp(14px,4vw,32px); margin:0 calc(50% - 50vw); width:100vw;">
        <div style="max-width:1200px; margin:0 auto;">
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:2rem;">
            <div style="flex:1; min-width:300px;">
              <h1 style="margin:0 0 0.5rem 0; font-size:2.5rem; font-weight:900; color:white;">Referral Rewards</h1>
              <p style="margin:0 0 1.5rem 0; font-size:1.125rem; opacity:0.95;">Share Home2Smart and earn points worth real money off your next service.</p>
              
              <div style="display:flex; align-items:baseline; gap:1rem; margin-bottom:1rem;">
                <div>
                  <div style="font-size:0.875rem; font-weight:600; text-transform:uppercase; letter-spacing:1px; opacity:0.9; margin-bottom:0.25rem;">Your Balance</div>
                  <div style="font-size:3.5rem; font-weight:900; line-height:1;" id="heroPoints">0</div>
                </div>
                <div style="font-size:1.5rem; font-weight:700; color:#FFD700;" id="heroWorth">= $0.00</div>
              </div>
              
              <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                <button id="heroShareBtn" class="btn" style="background:white; color:var(--cobalt); font-weight:700; padding:0.75rem 1.5rem; border:none;">
                  üì§ Share Your Code
                </button>
                <a href="#how-it-works" class="btn" style="background:rgba(255,255,255,0.15); color:white; font-weight:600; padding:0.75rem 1.5rem; text-decoration:none; border:2px solid white;">
                  Learn How It Works
                </a>
              </div>
            </div>
            
            <div style="flex:1; min-width:280px; background:rgba(255,255,255,0.1); backdrop-filter:blur(10px); border-radius:12px; padding:1.5rem; border:1px solid rgba(255,255,255,0.2);">
              <div style="font-size:0.875rem; font-weight:600; text-transform:uppercase; letter-spacing:1px; opacity:0.9; margin-bottom:1rem;">Your Referral Code</div>
              <div style="display:flex; gap:0.75rem; margin-bottom:1rem;">
                <input id="heroRefCode" type="text" readonly value="" style="flex:1; background:rgba(255,255,255,0.9); border:none; border-radius:6px; padding:0.75rem; font-weight:700; font-size:1.5rem; letter-spacing:3px; text-align:center; color:var(--cobalt); font-family:Archivo,monospace;">
                <button id="heroCopyBtn" class="btn" style="background:white; color:var(--cobalt); font-weight:700; padding:0.75rem 1.25rem; border:none; white-space:nowrap;">Copy</button>
              </div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; text-align:center;">
                <div>
                  <div style="font-size:1.75rem; font-weight:900;" id="heroReferrals">0</div>
                  <div style="font-size:0.75rem; opacity:0.9;">Referrals</div>
                </div>
                <div>
                  <div style="font-size:1.75rem; font-weight:900;" id="heroEarned">0</div>
                  <div style="font-size:0.75rem; opacity:0.9;">Total Earned</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Main Content -->
      <div style="max-width:1200px; margin:3rem auto; padding:0 clamp(14px,4vw,32px);">
        
        <!-- What You Can Earn Section -->
        <section style="margin-bottom:4rem;">
          <h2 style="margin:0 0 0.5rem 0; font-size:2rem; font-weight:900; color:var(--cobalt); text-align:center;">What Can You Get With Points?</h2>
          <p style="margin:0 0 2.5rem 0; text-align:center; color:#6b778c; font-size:1.125rem;">Every 10 points = $1.00 off any service. Use them however you want.</p>
          
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:2rem;">
            <div style="background:#fff; border:2px solid #e3e8ef; border-radius:12px; padding:2rem; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.05);">
              <div style="font-size:3rem; margin-bottom:1rem;">üí∞</div>
              <div style="font-size:2.5rem; font-weight:900; color:var(--cobalt); margin-bottom:0.5rem;">100 pts</div>
              <div style="font-size:1.25rem; font-weight:700; color:var(--azure); margin-bottom:0.75rem;">= $10 OFF</div>
              <p style="margin:0; color:#6b778c; font-size:0.9rem;">Perfect for accessories or small upgrades</p>
            </div>
            
            <div style="background:#fff; border:2px solid var(--azure); border-radius:12px; padding:2rem; text-align:center; box-shadow:0 4px 12px rgba(20,147,255,0.15);">
              <div style="font-size:3rem; margin-bottom:1rem;">üéØ</div>
              <div style="font-size:2.5rem; font-weight:900; color:var(--cobalt); margin-bottom:0.5rem;">500 pts</div>
              <div style="font-size:1.25rem; font-weight:700; color:var(--azure); margin-bottom:0.75rem;">= $50 OFF</div>
              <p style="margin:0; color:#6b778c; font-size:0.9rem;">Great discount on smart home installations</p>
            </div>
            
            <div style="background:#fff; border:2px solid #FFD700; border-radius:12px; padding:2rem; text-align:center; box-shadow:0 4px 12px rgba(255,215,0,0.2);">
              <div style="font-size:3rem; margin-bottom:1rem;">‚≠ê</div>
              <div style="font-size:2.5rem; font-weight:900; color:var(--cobalt); margin-bottom:0.5rem;">1000 pts</div>
              <div style="font-size:1.25rem; font-weight:700; color:#FFD700; margin-bottom:0.75rem;">= $100 OFF</div>
              <p style="margin:0; color:#6b778c; font-size:0.9rem;">Major savings on complete system upgrades</p>
            </div>
          </div>
          
          <div style="text-align:center; margin-top:2rem; padding:1.5rem; background:#f8f9fb; border-radius:8px;">
            <p style="margin:0; font-size:1rem; color:var(--cobalt);"><strong>No limits.</strong> Save up points for big purchases or use them right away. Points never expire.</p>
          </div>
        </section>
        
        <!-- How It Works -->
        <section id="how-it-works" style="margin-bottom:4rem; scroll-margin-top:2rem;">
          <h2 style="margin:0 0 2.5rem 0; font-size:2rem; font-weight:900; color:var(--cobalt); text-align:center;">How It Works</h2>
          
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:2rem;">
            <div style="text-align:center;">
              <div style="width:80px; height:80px; background:var(--azure); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1.5rem; font-size:2.5rem;">üì§</div>
              <h3 style="margin:0 0 0.75rem 0; font-size:1.25rem; font-weight:700; color:var(--cobalt);">1. Share Your Code</h3>
              <p style="margin:0; color:#6b778c; line-height:1.6;">Send your unique referral code to friends, family, neighbors‚Äîanyone who needs smart home help.</p>
            </div>
            
            <div style="text-align:center;">
              <div style="width:80px; height:80px; background:var(--azure); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1.5rem; font-size:2.5rem;">üõí</div>
              <h3 style="margin:0 0 0.75rem 0; font-size:1.25rem; font-weight:700; color:var(--cobalt);">2. They Book a Service</h3>
              <p style="margin:0; color:#6b778c; line-height:1.6;">When they use your code to purchase any service, you both benefit from the referral program.</p>
            </div>
            
            <div style="text-align:center;">
              <div style="width:80px; height:80px; background:var(--azure); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1.5rem; font-size:2.5rem;">üéÅ</div>
              <h3 style="margin:0 0 0.75rem 0; font-size:1.25rem; font-weight:700; color:var(--cobalt);">3. You Get 100 Points</h3>
              <p style="margin:0; color:#6b778c; line-height:1.6;">Instantly earn 100 points ($10) for each successful referral. No caps, no limits.</p>
            </div>
          </div>
        </section>
        
        <!-- Tier Progress (if applicable) -->
        <div id="tierProgressContainer" style="display:none; margin-bottom:4rem;">
          <!-- Dynamic tier progress inserted here -->
        </div>
        
        <!-- Back to Account -->
        <div style="text-align:center; padding-top:2rem; border-top:2px solid #e3e8ef;">
          <button id="backToAccount" class="btn ghost" style="color:var(--cobalt);">‚Üê Back to Account</button>
        </div>
      </div>
    </div>
  `;
  
  // Load rewards data
  loadFullRewardsData();
  
  // Wire up buttons
  byId('backToAccount').onclick = () => navSet({view:'account', tab:'rewards'});
  
  byId('heroCopyBtn').onclick = () => {
    const code = byId('heroRefCode').value;
    navigator.clipboard.writeText(code).then(() => {
      const btn = byId('heroCopyBtn');
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 2000);
    });
  };
  
  byId('heroShareBtn').onclick = () => {
    const code = byId('heroRefCode').value;
    const shareUrl = `${window.location.origin}/shop?ref=${code}`;
    const shareText = `I've been using Home2Smart for my smart home needs and they're awesome! Use my code ${code} when you book and we'll both get rewarded! ${shareUrl}`;
    
    if(navigator.share) {
      navigator.share({ title: 'Home2Smart Referral', text: shareText }).catch(() => {});
    } else {
      navigator.clipboard.writeText(shareText).then(() => {
        const btn = byId('heroShareBtn');
        btn.innerHTML = '‚úì Message Copied!';
        setTimeout(() => btn.innerHTML = 'üì§ Share Your Code', 2500);
      });
    }
  };
}

async function loadFullRewardsData() {
  try {
    const resp = await fetch(API + '?action=referral_ensure&email=' + encodeURIComponent(user.email));
    const data = await resp.json();
    
    if(data.ok) {
      const points = data.points_available || 0;
      const totalReferrals = data.total_referrals || 0;
      const totalEarned = data.total_points_earned || points;
      const tier = data.tier || 1;
      const refCode = data.refCode || '';
      
      byId('heroPoints').textContent = points.toLocaleString();
      byId('heroWorth').textContent = `= $${(points / 10).toFixed(2)}`;
      byId('heroRefCode').value = refCode;
      byId('heroReferrals').textContent = totalReferrals;
      byId('heroEarned').textContent = totalEarned;
      
      // Show tier progress if tier 1
      if(tier === 1 && totalReferrals < 5) {
        const remaining = 5 - totalReferrals;
        const progress = (totalReferrals / 5) * 100;
        const container = byId('tierProgressContainer');
        container.style.display = 'block';
        container.innerHTML = `
          <div style="background:#fff; border:2px solid var(--azure); border-radius:12px; padding:2rem;">
            <h3 style="margin:0 0 1.5rem 0; font-size:1.5rem; font-weight:700; color:var(--cobalt); text-align:center;">üåü Unlock Power Referrer Status</h3>
            <div style="max-width:600px; margin:0 auto;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
                <span style="font-size:1rem; font-weight:600; color:#6b778c;">Progress to Tier 2</span>
                <span style="font-size:1rem; font-weight:700; color:var(--cobalt);">${totalReferrals}/5 Referrals</span>
              </div>
              <div style="background:#e3e8ef; height:12px; border-radius:6px; overflow:hidden; margin-bottom:1rem;">
                <div style="background:linear-gradient(90deg, var(--azure) 0%, var(--cobalt) 100%); height:100%; width:${progress}%; transition:width 0.5s ease-out;"></div>
              </div>
              <p style="margin:0; text-align:center; color:#6b778c;">
                Just <strong style="color:var(--cobalt);">${remaining} more referral${remaining !== 1 ? 's' : ''}</strong> to unlock exclusive perks and bonus rewards!
              </p>
            </div>
          </div>
        `;
      } else if(tier === 2) {
        const container = byId('tierProgressContainer');
        container.style.display = 'block';
        container.innerHTML = `
          <div style="background:linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border-radius:12px; padding:2rem; text-align:center;">
            <div style="font-size:2rem; margin-bottom:0.5rem;">‚≠ê ‚≠ê ‚≠ê</div>
            <h3 style="margin:0 0 0.5rem 0; font-size:1.75rem; font-weight:900; color:#fff; text-shadow:0 2px 4px rgba(0,0,0,0.2);">POWER REFERRER STATUS</h3>
            <p style="margin:0; font-size:1.125rem; color:#fff;">You're crushing it! Keep sharing to maximize your rewards.</p>
          </div>
        `;
      }
    }
  } catch(err) {
    console.error('Failed to load rewards:', err);
  }
}

function navSet(params){
  const u = new URL(location.href);
  Object.entries(params||{}).forEach(([k,v])=>{
    if(v==null) u.searchParams.delete(k); else u.searchParams.set(k,v);
  });
  history.pushState({}, '', u.toString());
  route();
}
function getParam(k){
  const u = new URL(location.href);
  return u.searchParams.get(k);
}

// === HEADER / FILTERS ===
function wireHeader(){
  byId('search').oninput = (e)=>{ 
    lastSearch = e.target.value.trim().toLowerCase(); 
    if(!getParam('p') && !getParam('m')) renderGrid(); 
    if(lastSearch) h2sTrack('Search', { search_string: lastSearch });
  };
  byId('accountBtn').onclick = ()=>{
    if(user && user.email) navSet({view:'account'});
    else navSet({view:'auth'});
  };
}
function paintFilters(){
  const sel = byId('catFilter');
  const cats = categories();
  sel.innerHTML = `<option value="">All categories</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  sel.value = getParam('cat') || "";
  sel.onchange = ()=>{
    lastCat = sel.value;
    navSet({ cat: lastCat || null, p: null, m: null, view: null });
    h2sTrack('FilterCategory', { category: lastCat || 'all' });
  };
}
// build category list from comma-separated cells
function categories(){
  const set = new Set();
  (catalog.services||[])
    .filter(s=> s.active!==false)
    .forEach(s=>{
      String(s.category||'')
        .split(',')
        .map(t=>t.trim())
        .filter(Boolean)
        .forEach(t=> {
          // Normalize category names
          let normalized = t.trim();
          
          // Fix common issues
          if(normalized.toLowerCase() === 'add ons') normalized = 'Add-ons';
          
          // Standardize capitalization (Title Case)
          normalized = normalized
            .split(/[\s-]/)
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(normalized.includes('-') ? '-' : ' ');
          
          set.add(normalized);
        });
    });
  return Array.from(set).sort();
}

// === GRID LIST ===
function renderGrid(){
  const outlet = byId('outlet');
  
  // Remove skeleton on first render
  const skeleton = byId('skeleton');
  if(skeleton) skeleton.remove();

  const filtered = (catalog.services||[]).filter(s=>{
    if(s.active===false) return false;

    // service matches if any of its categories equals lastCat
    if(lastCat){
      const cats = String(s.category||'').split(',').map(t=>t.trim()).filter(Boolean);
      if(!cats.includes(lastCat)) return false;
    }

    if(lastSearch){
      const hay = (s.name||'')+' '+(s.blurb||'')+' '+(s.tags||'');
      if(!hay.toLowerCase().includes(lastSearch)) return false;
    }
    return true;
  });

  const items = filtered.slice().sort((a,b)=>{
    const as = Number(a.sort); const bs = Number(b.sort);
    const aHas = Number.isFinite(as); const bHas = Number.isFinite(bs);
    if (aHas && bHas && as !== bs) return as - bs;
    if (aHas && !bHas) return -1;
    if (!aHas && bHas) return 1;
    return String(a.name||'').localeCompare(String(b.name||''));
  });

  if(!items.length){
    // If no services match and we have a category filter, clear it and retry
    if(lastCat){
      lastCat = "";
      const catSel = byId('catFilter');
      if(catSel) catSel.value = "";
      navSet({ cat: null });
      renderShop();
      return;
    }
    // If still no services after clearing filter, show empty state
    outlet.innerHTML = `<section class="grid"><div class="empty">No services match.</div></section>`;
    return;
  }

  // Lazy render: Show first 12 cards immediately, rest after idle
  const batchSize = 12;
  const firstBatch = items.slice(0, batchSize);
  const restBatches = items.slice(batchSize);

  const grid = `
    <section class="grid" id="grid">
      ${firstBatch.map((s, idx) => cardHTML(s, idx < 4)).join('')}
    </section>`;
  outlet.innerHTML = grid;
  firstBatch.forEach(s => wireCard(s));

  // Render remaining cards in idle time
  if(restBatches.length){
    const renderNext = (batch) => {
      if(!batch.length) return;
      const gridEl = byId('grid');
      if(!gridEl) return;
      
      const nextChunk = batch.slice(0, batchSize);
      const remaining = batch.slice(batchSize);
      
      const html = nextChunk.map(s => cardHTML(s, false)).join('');
      gridEl.insertAdjacentHTML('beforeend', html);
      nextChunk.forEach(s => wireCard(s));
      
      if(remaining.length){
        if('requestIdleCallback' in window){
          requestIdleCallback(() => renderNext(remaining), { timeout: 500 });
        } else {
          setTimeout(() => renderNext(remaining), 50);
        }
      }
    };
    
    if('requestIdleCallback' in window){
      requestIdleCallback(() => renderNext(restBatches), { timeout: 500 });
    } else {
      setTimeout(() => renderNext(restBatches), 100);
    }
  }
}
function cardHTML(s, eagerLoad = false){
  const external = String(s.checkout_type||'cart')==='external';
  const qtyMin = Number(s.min_qty||1), qtyMax = Number(s.max_qty||99);
  const q = Math.max(qtyMin, 1);
  const tier = pickTier(s.service_id, q, null);
  const unit = tier ? tier.unit : 0;
  const line = unit * q;
  const loadingAttr = eagerLoad ? 'fetchpriority="high"' : 'loading="lazy"';
  
  // Smart messaging for minimum quantity
  const minQtyBadge = qtyMin > 1 ? `<span class="badge" style="background:#fff3cd;color:#856404;">Min ${qtyMin} units</span>` : '';
  
  // Real review data (fetched from backend, cached in service object)
  const hasReviews = s.review_count && Number(s.review_count) > 0;
  const rating = Number(s.avg_rating || 0);
  const reviewCount = Number(s.review_count || 0);
  
  // Trust row - only show if we have actual reviews
  let trustRow = '';
  if(hasReviews){
    const stars = '‚≠ê'.repeat(Math.floor(rating));
    const installTime = s.install_time_minutes 
      ? (s.install_time_minutes < 60 ? `${s.install_time_minutes} min` : `${Math.round(s.install_time_minutes/60)} hrs`)
      : null;
    
    trustRow = `
      <div class="trust-row">
        <span class="trust-item rating">${stars} <span class="count">(${reviewCount})</span></span>
        <span class="trust-item">‚úì Licensed Pro</span>
        ${installTime ? `<span class="trust-item">‚è±Ô∏è ${installTime}</span>` : ''}
      </div>`;
  }
  
  // Quantity discount messaging
  const tier6 = pickTier(s.service_id, 6, null);
  const hasTierDiscount = tier6 && tier6.unit < unit && qtyMin < 6;
  const savingsMsg = hasTierDiscount 
    ? `<div class="savings-tip" data-role="savings">üí∞ Save $${Math.round((unit - tier6.unit) * 6)} when you buy 6+ (${money(tier6.unit)} each)</div>`
    : '';
  
  // Smart pricing: Show "per unit" only when qty matters (min > 1 or max > 1)
  const showPerUnit = qtyMin > 1 || qtyMax > 1;
  const priceDisplay = showPerUnit 
    ? `<div class="price-main"><span data-role="unit">${money(unit)}</span></div><div class="price-sub">per unit</div>`
    : `<div class="price-main"><span data-role="unit">${money(unit)}</span></div>`;

  return `
  <article class="card" data-sid="${s.service_id}">
    <img class="img" src="${s.image_url||''}" alt="${s.name||''}" width="800" height="800" ${loadingAttr} decoding="async">
    <div class="body">
      <div class="name">${s.name||''}</div>
      <div class="blurb">${s.blurb||''}</div>
      ${trustRow}
      
      ${external ? `<span class="badge">Opens separate checkout</span>`:''}
      ${minQtyBadge}
      ${savingsMsg}
      ${!external ? `
      <div class="qty-row">
        <div class="stepper">
          <button data-act="dec" aria-label="decrease">‚àí</button>
          <input data-role="qty" type="number" value="${q}" min="${qtyMin}" max="${qtyMax}">
          <button data-act="inc" aria-label="increase">+</button>
        </div>
        <div class="price-group">
          ${priceDisplay}
        </div>
        <div class="total-group">
          <div class="total-label">Total</div>
          <div class="lineTotal" data-role="line">${money(line)}</div>
        </div>
      </div>
      ${qtyMin > 1 ? `<div class="help" style="margin-top:4px;color:#856404;">Sold in sets of ${qtyMin}+</div>` : ''}`:''}
      <div class="actions">
        ${external
          ? `<a class="btn azure" href="${s.external_url||'#'}" target="_blank" rel="noopener" aria-label="Open ${s.name||'service'} checkout">Open checkout</a>`
          : `<button class="btn azure" data-act="add">Get Installed ‚Äì ${money(line)}</button>`
        }
        <button class="btn ghost" data-act="open" aria-label="View ${s.name||'service'} details">Quick View</button>
      </div>
    </div>
  </article>`;
}
function wireCard(s){
  const el = document.querySelector(`.card[data-sid="${CSS.escape(s.service_id)}"]`);
  if(!el) return;
  el.querySelector('[data-act="open"]').onclick = ()=> navigateToProduct(s.service_id, null);
  el.querySelector('.name').onclick = ()=> navigateToProduct(s.service_id, null);
  el.querySelector('.img').onclick  = ()=> navigateToProduct(s.service_id, null);
  if(String(s.checkout_type||'cart')==='external') return;

  const qtyInp = el.querySelector('[data-role="qty"]');
  const unitEl = el.querySelector('[data-role="unit"]');
  const lineEl = el.querySelector('[data-role="line"]');
  const savingsEl = el.querySelector('[data-role="savings"]');
  const addBtn = el.querySelector('[data-act="add"]');
  const minQ = Number(s.min_qty||1), maxQ = Number(s.max_qty||99);

  const repaint = ()=>{
    const q = clamp(Number(qtyInp.value||minQ), minQ, maxQ);
    qtyInp.value = q;
    const t = pickTier(s.service_id, q, null);
    const u = t ? t.unit : 0;
    const total = u * q;
    
    unitEl.textContent = money(u);
    lineEl.textContent = money(total);
    addBtn.textContent = `Get Installed ‚Äì ${money(total)}`;
    
    // Update savings message dynamically
    if(savingsEl){
      const tier1 = pickTier(s.service_id, 1, null);
      const tier6 = pickTier(s.service_id, 6, null);
      
      if(q >= 6 && tier6 && tier1 && tier6.unit < tier1.unit){
        const savings = Math.round((tier1.unit - u) * q);
        savingsEl.innerHTML = `‚úì You're saving $${savings}! (${q} √ó ${money(u)} vs ${money(tier1.unit)} each)`;
        savingsEl.style.background = '#d1fae5';
        savingsEl.style.borderColor = '#059669';
        savingsEl.style.color = '#065f46';
      } else if(tier6 && tier1 && tier6.unit < tier1.unit && q < 6){
        const potentialSavings = Math.round((tier1.unit - tier6.unit) * 6);
        savingsEl.innerHTML = `üí∞ Save $${potentialSavings} when you buy 6+ (${money(tier6.unit)} each)`;
        savingsEl.style.background = '#fef3c7';
        savingsEl.style.borderColor = '#f59e0b';
        savingsEl.style.color = '#78350f';
      }
    }
  };
  
  el.querySelector('[data-act="dec"]').onclick = ()=>{ qtyInp.value = Math.max(minQ, Number(qtyInp.value||minQ)-1); repaint(); };
  el.querySelector('[data-act="inc"]').onclick = ()=>{ qtyInp.value = Math.min(maxQ, Number(qtyInp.value||minQ)+1); repaint(); };
  qtyInp.onchange = repaint;
  addBtn.onclick = ()=> addToCart(s.service_id, Number(qtyInp.value||minQ), null);
  repaint();
}
function navigateToProduct(service_id, opt=null){ navSet({p:service_id, m:null, view:null, opt: opt||null}); }
function navigateToMembership(membership_id){ navSet({m:membership_id, p:null, view:null}); }

// === PRODUCT PAGE (option-aware + URL-bound) ===
function renderProductPage(service_id){
  const s = (catalog.services||[]).find(x=> String(x.service_id)===String(service_id));
  if(!s){ byId('outlet').innerHTML = `<div class="empty">Product not found.</div>`; return; }

  // Track ViewContent (critical for retargeting)
  const viewTier = pickTier(s.service_id, 1, null);
  h2sTrack('ViewContent', {
    content_type: 'product',
    content_ids: [s.service_id],
    product_id: s.service_id,
    product_name: s.name,
    value: viewTier ? viewTier.unit : 0,
    currency: 'USD'
  });

  const external = String(s.checkout_type||'cart')==='external';
  const qtyMin = Number(s.min_qty||1), qtyMax = Number(s.max_qty||99);
  const q0 = Math.max(qtyMin, 1);

  const options = getOptionsForService(s.service_id);
  const optFromUrl = getParam('opt');
  let selectedOpt = options.length ? String(options[0].option_id) : null;

  if(options.length && optFromUrl){
    const exists = options.some(o => String(o.option_id)===String(optFromUrl));
    if(exists) selectedOpt = String(optFromUrl);
    else {
      selectedOpt = String(options[0].option_id);
      navSet({ p: s.service_id, opt: selectedOpt });
      return;
    }
  } else if(options.length && selectedOpt && !optFromUrl){
    // If there's a default option but URL doesn't have it, sync to URL
    navSet({ p: s.service_id, opt: selectedOpt });
    return;
  }

  const initialTier = pickTier(s.service_id, q0, selectedOpt);
  const initialUnit = initialTier ? initialTier.unit : 0;
  const longBase = s.description_md ? mdHtml(s.description_md) : '';

  const optionsUI = options.length ? `
    <div style="display:grid; gap:8px; margin:10px 0">
      <div style="font-weight:900">Choose an option</div>
      <div style="display:grid; gap:8px">
        ${options.map(o=>`
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer">
            <input type="radio" name="opt" value="${escapeAttr(o.option_id)}" ${String(o.option_id)===selectedOpt?'checked':''}>
            <span style="font-weight:800">${escapeHtml(o.label||o.option_id)}</span>
            ${o.blurb?`<span class="help" style="margin-left:6px">${escapeHtml(o.blurb)}</span>`:''}
          </label>
        `).join('')}
      </div>
    </div>` : '';

  byId('outlet').innerHTML = `
    <div class="pd-back">
      <span class="pd-breadcrumb"><a href="/shop" id="backLink">Shop</a> ‚Ä∫ ${escapeHtml(s.name||'')}</span>
    </div>
    <section class="pd-wrap">
      <div class="pd-hero">
        <div id="pdCarousel" style="position:relative">
          <img id="pdImg" src="${s.image_url||''}" alt="${escapeHtml(s.name||'')}" width="800" height="800" style="display:block;width:100%;height:100%;object-fit:cover;max-height:520px" fetchpriority="high" decoding="async">
          <button id="prevImg" class="icon-btn" aria-label="Previous image" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);display:none;opacity:.95">‚Äπ</button>
          <button id="nextImg" class="icon-btn" aria-label="Next image" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);display:none;opacity:.95">‚Ä∫</button>
          <div id="pdDots" style="position:absolute;left:0;right:0;bottom:8px;display:flex;gap:6px;justify-content:center"></div>
        </div>
      </div>
      <div class="pd-info">
        <div class="title">${s.name||''}</div>
        <div class="blurb">${s.blurb||''}</div>

        ${optionsUI}

        <div class="pd-box" id="buyBox">
          ${external ? `<div class="badge">This opens a separate checkout</div>`:''}
          ${qtyMin > 1 ? `
          <div style="background:#fff3cd;border:1px solid #ffc107;border-radius:10px;padding:10px 12px;margin-bottom:12px;display:flex;align-items:start;gap:8px;">
            <span style="font-size:20px;line-height:1;">‚ÑπÔ∏è</span>
            <div style="font-size:14px;color:#856404;line-height:1.4;">
              <strong>Minimum quantity:</strong> This item is sold in sets of ${qtyMin} or more${qtyMin === 2 ? ' (perfect for whole-home coverage)' : ''}.
            </div>
          </div>` : ''}
          ${!external ? `
          <div class="pd-qty">
            <div class="stepper">
              <button data-act="dec">‚àí</button>
              <input data-role="qty" type="number" value="${q0}" min="${qtyMin}" max="${qtyMax}">
              <button data-act="inc">+</button>
            </div>
            <div class="pd-unit"><span data-role="unit">${money(initialUnit)}</span> <span style="opacity:.75">/ each</span></div>
            <div class="pd-total" data-role="line">${money(initialUnit * q0)}</div>
          </div>
          <div id="volumePricingMsg"></div>`:''}
          <div class="pd-actions">
            ${external
              ? `<a class="btn azure" href="${s.external_url||'#'}" target="_blank" rel="noopener">Open checkout</a>`
              : `<button class="btn azure" id="addNow">Add to cart</button>`}
            <button class="btn ghost" id="backBtn">Back to Shop</button>
          </div>
        </div>

        <div class="long" id="pdLong">${longBase}</div>
      </div>
    </section>
  `;
  byId('backLink').onclick = (e)=>{ e.preventDefault(); navSet({p:null, opt:null}); };
  byId('backBtn').onclick  = ()=> navSet({p:null, opt:null});
  if(external) return;

  const qtyInp = byId('buyBox').querySelector('[data-role="qty"]');
  const unitEl = byId('buyBox').querySelector('[data-role="unit"]');
  const lineEl = byId('buyBox').querySelector('[data-role="line"]');
  const pdLong = byId('pdLong');

  // --- Carousel state/wiring ---
  let imgList = [];
  let imgIdx = 0;
  function imagesForSelection(){
    let urls = [];
    if(options.length){
      const opt = options.find(o => String(o.option_id)===selectedOpt);
      if(opt && opt.image_url) urls = splitUrls(opt.image_url);
    }
    if(!urls.length && s.image_url) urls = splitUrls(s.image_url);
    return urls;
  }
  function updateHeroUI(){
    const img  = byId('pdImg');
    const prev = byId('prevImg');
    const next = byId('nextImg');
    const dots = byId('pdDots');
    const n = imgList.length;

    if(img) img.src = n ? imgList[imgIdx] : (s.image_url||'');

    const showArrows = n > 1;
    if(prev) prev.style.display = showArrows ? '' : 'none';
    if(next) next.style.display = showArrows ? '' : 'none';

    if(dots){
      dots.innerHTML = showArrows
        ? imgList.map((_,i)=>`<span data-dot="${i}" style="width:8px;height:8px;border-radius:50%;display:inline-block;background:${i===imgIdx?'#1493ff':'#e7eaf0'}"></span>`).join('')
        : '';
      dots.querySelectorAll('[data-dot]').forEach(dot=>{
        dot.onclick = ()=>{ imgIdx = Number(dot.getAttribute('data-dot')); updateHeroUI(); };
      });
    }
  }
  function setImages(list){
    imgList = Array.isArray(list) ? list : [];
    imgIdx = 0;
    updateHeroUI();
  }
  const prevBtn = byId('prevImg'), nextBtn = byId('nextImg');
  if(prevBtn) prevBtn.onclick = ()=>{ if(imgList.length){ imgIdx = (imgIdx - 1 + imgList.length) % imgList.length; updateHeroUI(); } };
  if(nextBtn) nextBtn.onclick = ()=>{ if(imgList.length){ imgIdx = (imgIdx + 1) % imgList.length; updateHeroUI(); } };

  const repaint = ()=>{
    const qn = clamp(Number(qtyInp.value||qtyMin), qtyMin, qtyMax);
    qtyInp.value = qn;
    const tt = pickTier(s.service_id, qn, selectedOpt);
    const u = tt ? tt.unit : 0;
    unitEl.textContent = money(u);
    lineEl.textContent = money(u * qn);

    // Update volume pricing message
    const volumeMsg = byId('volumePricingMsg');
    if(volumeMsg){
      volumeMsg.innerHTML = getVolumePricingMessage(s.service_id, selectedOpt);
    }

    if(options.length){
      const opt = options.find(o=> String(o.option_id)===selectedOpt);
      if(opt){
        if(opt.description_md){ pdLong.innerHTML = mdHtml(opt.description_md); }
        else { pdLong.innerHTML = longBase; }
      }
    }
    setImages(imagesForSelection());
  };

  byId('buyBox').querySelector('[data-act="dec"]').onclick = ()=>{ 
    const newVal = Math.max(qtyMin, Number(qtyInp.value||qtyMin)-1); 
    if(newVal === qtyMin && qtyMin > 1){
      // Flash the minimum quantity message
      const minMsg = byId('buyBox').querySelector('[style*="fff3cd"]');
      if(minMsg){
        minMsg.style.animation = 'none';
        setTimeout(() => { minMsg.style.animation = 'pulse 0.5s ease-in-out'; }, 10);
      }
    }
    qtyInp.value = newVal; 
    repaint(); 
  };
  byId('buyBox').querySelector('[data-act="inc"]').onclick = ()=>{ qtyInp.value = Math.min(qtyMax, Number(qtyInp.value||qtyMin)+1); repaint(); };
  qtyInp.onchange = repaint;

  if(options.length){
    document.querySelectorAll('input[name="opt"]').forEach(r=>{
      r.onchange = ()=>{
        selectedOpt = r.value;
        navSet({ p: s.service_id, opt: selectedOpt });
      };
    });
  }

  byId('addNow').onclick = ()=> addToCart(s.service_id, Number(qtyInp.value||qtyMin), selectedOpt);

  // Track product view
  const tier = pickTier(s.service_id, q0, selectedOpt);
  h2sTrack('ViewContent', { 
    content_type: 'product',
    product_id: s.service_id,
    product_name: s.name,
    price: tier ? tier.unit : 0,
    currency: 'USD'
  });

  // initialize carousel + price box
  setImages(imagesForSelection());
  repaint();
}

// === MEMBERSHIP PAGE ===
function renderMembershipPage(membership_id){
  const m = (catalog.memberships||[]).find(x=> String(x.membership_id)===String(membership_id));
  if(!m){ byId('outlet').innerHTML = `<div class="empty">Membership not found.</div>`; return; }

  const prices = (catalog.membershipPrices||[]).filter(p=> String(p.membership_id)===String(membership_id));
  prices.sort((a,b)=> parseMoneyCell(b.unit_price) - parseMoneyCell(a.unit_price));

  const monthlyTop = prices.filter(p=> String(p.interval||'').toLowerCase()==='month')
                           .sort((a,b)=> parseMoneyCell(b.unit_price)-parseMoneyCell(a.unit_price))[0] || null;

  const hero = m.image_url || '';
  const title = m.name || ('Membership ' + membership_id);
  const blurb = m.tagline || m.blurb || '';
  const long = m.description_md ? mdHtml(m.description_md) : '';

  const priceRows = prices.length
    ? `<div class="pd-box" style="display:grid; gap:10px">
         <div style="font-weight:900">Plans & pricing</div>
         ${prices.map(p=>{
            const amt = money(parseMoneyCell(p.unit_price));
            const intv = (p.interval || 'month').toString();
            const lbl = `${amt} / ${intv}`;
            const serviceForPlan = findServiceForMembership(m);
            const cta = serviceForPlan
              ? `<button class="btn azure" data-plan-service="${serviceForPlan.service_id}">Get this plan</button>`
              : (m.external_url ? `<a class="btn azure" href="${m.external_url}" target="_blank" rel="noopener">Get this plan</a>`
                                : `<button class="btn azure" disabled title="Checkout not linked yet">Get this plan</button>`);
            return `<div style="display:flex; justify-content:space-between; align-items:center; border:1px solid #e7eaf0; border-radius:12px; padding:10px 12px">
                      <div style="font-weight:800">${escapeHtml(lbl)}</div>
                      ${cta}
                    </div>`;
          }).join('')}
       </div>`
    : `<div class="pd-box"><div class="help">No prices configured for this membership yet.</div></div>`;

  byId('outlet').innerHTML = `
    <div class="pd-back">
      <span class="pd-breadcrumb"><a href="/shop" id="backLink2">Shop</a> ‚Ä∫ ${escapeHtml(title)}</span>
    </div>
    <section class="pd-wrap">
      <div class="pd-hero"><img src="${hero}" alt="${escapeHtml(title)}" width="800" height="800" fetchpriority="high" decoding="async"></div>
      <div class="pd-info">
        <div class="title">${escapeHtml(title)}</div>
        <div class="blurb">${escapeHtml(blurb)}</div>
        ${monthlyTop ? `<div class="pd-box"><strong>Recommended:</strong> ${money(parseMoneyCell(monthlyTop.unit_price))}/mo</div>`:''}
        ${priceRows}
        <div class="long">${long}</div>
      </div>
    </section>
  `;

  byId('backLink2').onclick = (e)=>{ e.preventDefault(); navSet({m:null}); };

  document.querySelectorAll('[data-plan-service]').forEach(btn=>{
    const sid = btn.getAttribute('data-plan-service');
    btn.onclick = ()=> navigateToProduct(sid, null);
  });
}

// === AUTH VIEWS ===
function renderAuthGate(){
  hideLoader(); // Ensure loader is hidden when rendering auth gate
  
  byId('outlet').innerHTML = `
    <div class="auth-container">
      <div class="auth-card" style="min-height:480px;max-height:600px;">
        <div class="auth-header">
          <h2 class="auth-title">Welcome to Home2Smart</h2>
          <p class="auth-subtitle">Sign in to unlock rewards, faster checkout, and exclusive offers</p>
        </div>
        
        <div class="auth-benefits">
          <div class="benefit-item">
            <span class="benefit-text">Earn points on every purchase</span>
          </div>
          <div class="benefit-item">
            <span class="benefit-text">Fast, secure checkout</span>
          </div>
          <div class="benefit-item">
            <span class="benefit-text">Exclusive discounts & rewards</span>
          </div>
        </div>
        
        <div class="auth-actions">
          <button class="btn-auth btn-primary" id="goSignup">
            <span>Create free account</span>
            <span class="btn-arrow">‚Üí</span>
          </button>
          <button class="btn-auth btn-secondary" id="goSignin">
            <span>Sign in</span>
          </button>
        </div>
        
        <button class="link-back" id="goShop">‚Üê Back to shop</button>
      </div>
    </div>
  `;
  byId('goSignup').onclick = ()=> navSet({view:'signup'});
  byId('goSignin').onclick = ()=> navSet({view:'signin'});
  byId('goShop').onclick   = ()=> navSet({view:null});
}
function renderSignUp(){
  hideLoader(); // Ensure loader is hidden when rendering signup page
  
  const seed = user||{};
  // Check if there's a referral code in URL (?ref=CODE)
  const urlParams = new URLSearchParams(window.location.search);
  const refCode = urlParams.get('ref') || '';
  
  byId('outlet').innerHTML = `
    <div class="auth-container">
      <div class="auth-card" style="min-height:600px;max-height:800px;overflow-y:auto;">
        <div class="auth-header">
          <h2 class="auth-title">Create Your Account</h2>
          <p class="auth-subtitle">Join Home2Smart and start earning rewards on every purchase</p>
        </div>
        
        ${refCode ? `
        <div class="referral-promo-card">
          <div class="promo-content">
            <div class="promo-title">Special Welcome Offer!</div>
            <div class="promo-text">You're using code <strong>${escapeAttr(refCode)}</strong></div>
            <div class="promo-bonus">Get <strong>100 bonus points</strong> ($10 value) when you sign up!</div>
          </div>
        </div>
        ` : ''}
        
        <form class="auth-form" id="signupForm">
          <div class="form-group">
            <label for="suName" class="form-label">Full name</label>
            <div class="input-wrapper">
              <input class="form-input" id="suName" type="text" placeholder="John Smith" value="${escapeAttr(seed.name||'')}" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="suEmail" class="form-label">Email address</label>
            <div class="input-wrapper">
              <input class="form-input" id="suEmail" type="email" placeholder="you@example.com" value="${escapeAttr(seed.email||'')}" required>
            </div>
            <div class="form-hint" id="emailHint"></div>
          </div>
          
          <div class="form-group">
            <label for="suPhone" class="form-label">Phone number</label>
            <div class="input-wrapper">
              <input class="form-input" id="suPhone" type="tel" placeholder="(555) 123-4567" value="${escapeAttr(seed.phone||'')}" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="suPass" class="form-label">Password</label>
            <div class="input-wrapper">
              <input class="form-input" id="suPass" type="password" placeholder="Minimum 8 characters" required>
              <button type="button" class="toggle-password" id="togglePass1" aria-label="Show password">
                <span class="eye-icon">Show</span>
              </button>
            </div>
            <div class="password-strength" id="passStrength">
              <div class="strength-bar">
                <div class="strength-fill" id="strengthFill"></div>
              </div>
              <div class="strength-text" id="strengthText"></div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="suPass2" class="form-label">Confirm password</label>
            <div class="input-wrapper">
              <input class="form-input" id="suPass2" type="password" placeholder="Repeat your password" required>
              <button type="button" class="toggle-password" id="togglePass2" aria-label="Show password">
                <span class="eye-icon">Show</span>
              </button>
            </div>
          </div>
          
          <div class="form-group">
            <label for="suRefCode" class="form-label">
              Referral code <span class="label-optional">(optional)</span>
            </label>
            <div class="input-wrapper ${refCode ? 'input-highlighted' : ''}">
              <input class="form-input" id="suRefCode" type="text" placeholder="Enter code" value="${escapeAttr(refCode)}" style="text-transform:uppercase;" maxlength="12">
            </div>
            ${!refCode ? '<div class="form-hint">Have a friend\'s code? Get 100 bonus points!</div>' : ''}
          </div>
          
          <div id="suMsg" class="form-message"></div>
          
          <button type="submit" class="btn-auth btn-primary btn-loading" id="createAcct">
            <span class="btn-text" style="display:inline-flex;align-items:center;gap:8px;">Create account</span>
            <span class="btn-loader" style="display:none;align-items:center;gap:8px;">
              <span class="spinner"></span>
              Creating account...
            </span>
          </button>
        </form>
        
        <div class="auth-footer">
          Already have an account? 
          <button class="link-text" id="toSignin">Sign in</button>
        </div>
      </div>
    </div>
  `;
  // Password toggle functionality
  byId('togglePass1').onclick = ()=>{
    const passInput = byId('suPass');
    const eyeIcon = byId('togglePass1').querySelector('.eye-icon');
    const isPassword = passInput.type === 'password';
    passInput.type = isPassword ? 'text' : 'password';
    eyeIcon.textContent = isPassword ? 'Hide' : 'Show';
  };
  byId('togglePass2').onclick = ()=>{
    const passInput = byId('suPass2');
    const eyeIcon = byId('togglePass2').querySelector('.eye-icon');
    const isPassword = passInput.type === 'password';
    passInput.type = isPassword ? 'text' : 'password';
    eyeIcon.textContent = isPassword ? 'Hide' : 'Show';
  };
  
  // Password strength meter
  byId('suPass').oninput = (e)=>{
    const pw = e.target.value;
    const strengthFill = byId('strengthFill');
    const strengthText = byId('strengthText');
    let strength = 0;
    let label = '';
    let color = '';
    
    if(pw.length >= 8) strength++;
    if(/[a-z]/.test(pw) && /[A-Z]/.test(pw)) strength++;
    if(/\d/.test(pw)) strength++;
    if(/[^a-zA-Z0-9]/.test(pw)) strength++;
    
    if(pw.length === 0){
      strengthFill.style.width = '0%';
      strengthText.textContent = '';
    } else if(strength <= 1){
      label = 'Weak'; color = '#ff4757'; strengthFill.style.width = '25%';
    } else if(strength === 2){
      label = 'Fair'; color = '#ffa502'; strengthFill.style.width = '50%';
    } else if(strength === 3){
      label = 'Good'; color = '#1e90ff'; strengthFill.style.width = '75%';
    } else {
      label = 'Strong'; color = '#2ed573'; strengthFill.style.width = '100%';
    }
    strengthFill.style.backgroundColor = color;
    strengthText.textContent = label;
    strengthText.style.color = color;
  };
  
  // Email validation hint
  byId('suEmail').onblur = ()=>{
    const email = byId('suEmail').value.trim();
    const emailHint = byId('emailHint');
    if(email && !/.+@.+\..+/.test(email)){
      emailHint.textContent = 'Please enter a valid email address';
      emailHint.style.color = '#ff4757';
    } else {
      emailHint.textContent = '';
    }
  };
  
  byId('toSignin').onclick = ()=> navSet({view:'signin'});
  
  // Form submission
  const signupForm = byId('signupForm');
  let isSubmitting = false; // Prevent double submission
  
  signupForm.onsubmit = async (e)=>{
    e.preventDefault();
    
    if(isSubmitting) return; // Prevent double submission
    
    const btn = byId('createAcct');
    const btnText = btn.querySelector('.btn-text');
    const btnLoader = btn.querySelector('.btn-loader');
    
    const name  = byId('suName').value.trim();
    const email = byId('suEmail').value.trim();
    const phone = byId('suPhone').value.trim();
    const pw1   = byId('suPass').value;
    const pw2   = byId('suPass2').value;
    const referralCode = byId('suRefCode').value.trim().toUpperCase();
    
    // Validation
    if(!name){ return showMsg('suMsg','Please enter your full name.', 'error'); }
    if(!email || !/.+@.+\..+/.test(email)){ return showMsg('suMsg','Please enter a valid email address.', 'error'); }
    if(!phone){ return showMsg('suMsg','Please enter your phone number.', 'error'); }
    if(pw1.length < 8){ return showMsg('suMsg','Password must be at least 8 characters.', 'error'); }
    if(pw1 !== pw2){ return showMsg('suMsg','Passwords do not match.', 'error'); }
    
    // Show loading state (button only, no global loader)
    isSubmitting = true;
    btn.disabled = true;
    btnText.style.display = 'none';
    btnLoader.style.display = 'inline-flex';
    
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'create_user', user:{name,email,phone,password:pw1}})});
      const text = await resp.text();
      if(!resp.ok){ 
        showMsg('suMsg', text || ('Error ' + resp.status), 'error');
        return;
      }
      const data = JSON.parse(text);
      if(!data.ok){ 
        showMsg('suMsg', data.error||'Create failed', 'error');
        return;
      }
      user = {name:data.user.name||'', email:data.user.email, phone:data.user.phone||''};
      saveUser();
      
      // Apply referral code if provided
      if(referralCode){
        try{
          const refResp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'apply_referral_code', email:email, referral_code:referralCode})});
          const refData = await refResp.json();
          if(refData.ok){
            showMsg('suMsg', 'Referral code applied! You received ' + (refData.points_awarded || 100) + ' bonus points!', 'success');
          }
        }catch(refErr){ 
          console.error('Referral code error:', refErr); 
        }
      }
      
      // Track account creation
      h2sTrack('CompleteRegistration', {
        user_email: user.email,
        user_name: user.name
      });
      
      showMsg('suMsg', 'Account created successfully!', 'success');
      setTimeout(()=> navSet({view:'account'}), 1000);
    }catch(err){ 
      showMsg('suMsg', String(err), 'error'); 
    }
    finally{ 
      isSubmitting = false;
      btn.disabled = false;
      btnText.style.display = 'inline-flex';
      btnLoader.style.display = 'none';
    }
  };
}
function renderForgot(){
  byId('outlet').innerHTML = `
    <section class="form">
      <h2 style="margin:0 0 10px 0;font-weight:900">Forgot password</h2>
      <p class="help">Enter the email on your account and we‚Äôll send a reset link.</p>
      <input class="inp" id="fpEmail" type="email" placeholder="Email">
      <div style="display:flex; gap:10px; margin-top:6px; flex-wrap:wrap">
        <button class="btn azure" id="fpSend">Send reset link</button>
        <button class="btn ghost" id="fpBack">Back to sign in</button>
      </div>
      <div id="fpMsg" class="help"></div>
    </section>
  `;
  byId('fpBack').onclick = ()=> navSet({view:'signin'});
  byId('fpSend').onclick = async ()=>{
    const email = byId('fpEmail').value.trim();
    if(!email){ return showMsg('fpMsg','Enter your email.'); }
    showLoader();
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'request_password_reset', email})});
      const txt  = await resp.text();
      if(!resp.ok){ showMsg('fpMsg', txt || ('Error ' + resp.status)); return; }
      showMsg('fpMsg','If that email has an account, a reset link has been sent. Check your inbox.');
    }catch(err){ showMsg('fpMsg', String(err)); }
    finally{ hideLoader(); }
  };
}
function renderReset(token){
  byId('outlet').innerHTML = `
    <section class="form">
      <h2 style="margin:0 0 10px 0;font-weight:900">Reset password</h2>
      <input class="inp" id="rpToken" type="text" placeholder="Reset token" value="${escapeAttr(token||'')}">
      <input class="inp" id="rpNew1" type="password" placeholder="New password (min 8)">
      <input class="inp" id="rpNew2" type="password" placeholder="Confirm new password">
      <div style="display:flex; gap:10px; margin-top:6px; flex-wrap:wrap">
        <button class="btn azure" id="rpDo">Set new password</button>
        <button class="btn ghost" id="rpBack">Back to sign in</button>
      </div>
      <div id="rpMsg" class="help"></div>
    </section>
  `;
  byId('rpBack').onclick = ()=> navSet({view:'signin'});
  byId('rpDo').onclick = async ()=>{
    const tok = byId('rpToken').value.trim();
    const p1 = byId('rpNew1').value;
    const p2 = byId('rpNew2').value;
    if(!tok){ return showMsg('rpMsg','Missing reset token.'); }
    if(p1.length<8){ return showMsg('rpMsg','Password must be at least 8 characters.'); }
    if(p1!==p2){ return showMsg('rpMsg','Passwords do not match.'); }
    showLoader();
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'reset_password', token:tok, new_password:p1})});
      const txt  = await resp.text();
      if(!resp.ok){ showMsg('rpMsg', txt || ('Error ' + resp.status)); return; }
      const data = JSON.parse(txt);
      if(!data.ok){ showMsg('rpMsg', data.error||'Could not reset password'); return; }
      showMsg('rpMsg','Password updated. You can now sign in.');
      setTimeout(()=> navSet({view:'signin'}), 800);
    }catch(err){ showMsg('rpMsg', String(err)); }
    finally{ hideLoader(); }
  };
}
function renderSignIn(){
  hideLoader(); // Ensure loader is hidden when rendering signin page
  
  byId('outlet').innerHTML = `
    <div class="auth-container">
      <div class="auth-card" style="min-height:480px;max-height:600px;">
        <div class="auth-header">
          <h2 class="auth-title">Welcome Back!</h2>
          <p class="auth-subtitle">Sign in to access your account, rewards, and order history</p>
        </div>
        
        <form class="auth-form" id="signinForm">
          <div class="form-group">
            <label for="siEmail" class="form-label">Email address</label>
            <div class="input-wrapper">
              <input class="form-input" id="siEmail" type="email" placeholder="you@example.com" value="${escapeAttr(user?.email||'')}" required autofocus>
            </div>
          </div>
          
          <div class="form-group">
            <div class="form-label-row">
              <label for="siPass" class="form-label">Password</label>
              <button type="button" class="link-text-small" id="toForgot">Forgot password?</button>
            </div>
            <div class="input-wrapper">
              <input class="form-input" id="siPass" type="password" placeholder="Enter your password" required>
              <button type="button" class="toggle-password" id="togglePassSignin" aria-label="Show password">
                <span class="eye-icon">Show</span>
              </button>
            </div>
          </div>
          
          <div class="form-checkbox">
            <input type="checkbox" id="rememberMe" checked>
            <label for="rememberMe">Remember me for 30 days</label>
          </div>
          
          <div id="siMsg" class="form-message"></div>
          
          <button type="submit" class="btn-auth btn-primary btn-loading" id="signin">
            <span class="btn-text" style="display:inline-flex;align-items:center;gap:8px;">Sign in</span>
            <span class="btn-loader" style="display:none;align-items:center;gap:8px;">
              <span class="spinner"></span>
              Signing in...
            </span>
          </button>
        </form>
        
        <div class="auth-footer">
          New to Home2Smart? 
          <button class="link-text" id="toSignup">Create free account</button>
        </div>
      </div>
    </div>
  `;
  
  // Password toggle
  byId('togglePassSignin').onclick = ()=>{
    const passInput = byId('siPass');
    const eyeIcon = byId('togglePassSignin').querySelector('.eye-icon');
    const isPassword = passInput.type === 'password';
    passInput.type = isPassword ? 'text' : 'password';
    eyeIcon.textContent = isPassword ? 'Hide' : 'Show';
  };
  
  byId('toSignup').onclick = ()=> navSet({view:'signup'});
  byId('toForgot').onclick = ()=> navSet({view:'forgot'});
  
  // Form submission
  const signinForm = byId('signinForm');
  let isSubmitting = false; // Prevent double submission
  
  signinForm.onsubmit = async (e)=>{
    e.preventDefault();
    
    if(isSubmitting) return; // Prevent double submission
    
    const btn = byId('signin');
    const btnText = btn.querySelector('.btn-text');
    const btnLoader = btn.querySelector('.btn-loader');
    
    const email = byId('siEmail').value.trim();
    const pass  = byId('siPass').value;
    
    if(!email || !/.+@.+\..+/.test(email)){ return showMsg('siMsg','Please enter a valid email address.', 'error'); }
    if(!pass){ return showMsg('siMsg','Please enter your password.', 'error'); }
    
    // Show loading state (button only, no global loader)
    isSubmitting = true;
    btn.disabled = true;
    btnText.style.display = 'none';
    btnLoader.style.display = 'inline-flex';
    
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'signin', email, password:pass })});
      const text = await resp.text();
      if(!resp.ok){ 
        showMsg('siMsg', text || ('Error ' + resp.status), 'error'); 
        return; 
      }
      const data = JSON.parse(text);
      if(!data.ok){ 
        showMsg('siMsg', data.error||'Sign in failed', 'error'); 
        return; 
      }
      user = { name:data.user.name||'', email:data.user.email, phone:data.user.phone||'' };
      saveUser();
      
      // Track sign in
      h2sTrack('Login', {
        user_email: user.email
      });
      
      showMsg('siMsg', 'üëã Welcome back!', 'success');
      setTimeout(()=> navSet({view:'account'}), 800);
    }catch(err){ 
      showMsg('siMsg', String(err), 'error'); 
    }
    finally{ 
      isSubmitting = false;
      btn.disabled = false;
      btnText.style.display = 'inline-flex';
      btnLoader.style.display = 'none';
    }
  };
}

function renderAccount(){
  if(!user || !user.email){ navSet({view:'auth'}); return; }
  
  // Determine active tab from URL or default to 'account'
  const activeTab = new URLSearchParams(window.location.search).get('tab') || 'account';
  
  byId('outlet').innerHTML = `
    <div style="max-width:1400px; margin:0 auto; display:grid; grid-template-columns:240px 1fr; gap:0; min-height:calc(100vh - 200px);">
      
      <!-- Left Sidebar Navigation -->
      <nav style="background:#f8f9fb; border-right:1px solid #e3e8ef; padding:2rem 0;">
        <div style="padding:0 1.5rem 1.5rem 1.5rem; border-bottom:1px solid #e3e8ef;">
          <h2 style="margin:0; font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:#8993a4;">Settings</h2>
        </div>
        
        <div style="padding:1rem 0;">
          <button class="tab-nav ${activeTab==='account'?'active':''}" data-tab="account" style="width:100%; text-align:left; padding:0.75rem 1.5rem; border:none; background:${activeTab==='account'?'white':'transparent'}; border-left:3px solid ${activeTab==='account'?'var(--azure)':'transparent'}; font-weight:${activeTab==='account'?'700':'600'}; color:${activeTab==='account'?'var(--cobalt)':'#6b778c'}; cursor:pointer; display:flex; align-items:center; gap:0.75rem; font-size:0.9rem; transition:all 0.2s;">
            <span style="font-size:1.25rem;">üë§</span>
            <span>Account</span>
          </button>
          
          <button class="tab-nav ${activeTab==='security'?'active':''}" data-tab="security" style="width:100%; text-align:left; padding:0.75rem 1.5rem; border:none; background:${activeTab==='security'?'white':'transparent'}; border-left:3px solid ${activeTab==='security'?'var(--azure)':'transparent'}; font-weight:${activeTab==='security'?'700':'600'}; color:${activeTab==='security'?'var(--cobalt)':'#6b778c'}; cursor:pointer; display:flex; align-items:center; gap:0.75rem; font-size:0.9rem; transition:all 0.2s;">
            <span style="font-size:1.25rem;">üîê</span>
            <span>Security</span>
          </button>
          
          <button class="tab-nav ${activeTab==='orders'?'active':''}" data-tab="orders" style="width:100%; text-align:left; padding:0.75rem 1.5rem; border:none; background:${activeTab==='orders'?'white':'transparent'}; border-left:3px solid ${activeTab==='orders'?'var(--azure)':'transparent'}; font-weight:${activeTab==='orders'?'700':'600'}; color:${activeTab==='orders'?'var(--cobalt)':'#6b778c'}; cursor:pointer; display:flex; align-items:center; gap:0.75rem; font-size:0.9rem; transition:all 0.2s;">
            <span style="font-size:1.25rem;">üì¶</span>
            <span>Orders</span>
          </button>
          
          <button class="tab-nav ${activeTab==='subscriptions'?'active':''}" data-tab="subscriptions" style="width:100%; text-align:left; padding:0.75rem 1.5rem; border:none; background:${activeTab==='subscriptions'?'white':'transparent'}; border-left:3px solid ${activeTab==='subscriptions'?'var(--azure)':'transparent'}; font-weight:${activeTab==='subscriptions'?'700':'600'}; color:${activeTab==='subscriptions'?'var(--cobalt)':'#6b778c'}; cursor:pointer; display:flex; align-items:center; gap:0.75rem; font-size:0.9rem; transition:all 0.2s;">
            <span style="font-size:1.25rem;">üîÑ</span>
            <span>Subscriptions</span>
          </button>
          
          <button class="tab-nav ${activeTab==='rewards'?'active':''}" data-tab="rewards" style="width:100%; text-align:left; padding:0.75rem 1.5rem; border:none; background:${activeTab==='rewards'?'white':'transparent'}; border-left:3px solid ${activeTab==='rewards'?'var(--azure)':'transparent'}; font-weight:${activeTab==='rewards'?'700':'600'}; color:${activeTab==='rewards'?'var(--cobalt)':'#6b778c'}; cursor:pointer; display:flex; align-items:center; gap:0.75rem; font-size:0.9rem; transition:all 0.2s;">
            <span style="font-size:1.25rem;">üéÅ</span>
            <span>Rewards</span>
          </button>
        </div>
        
        <div style="padding:1rem 1.5rem; border-top:1px solid #e3e8ef; margin-top:1rem;">
          <button id="backShop" style="width:100%; padding:0.625rem; background:transparent; border:1px solid #d0d7de; border-radius:6px; font-weight:600; font-size:0.875rem; color:#6b778c; cursor:pointer; transition:all 0.2s;">
            ‚Üê Back to Shop
          </button>
          <button id="signOut" style="width:100%; padding:0.625rem; background:transparent; border:1px solid #d0d7de; border-radius:6px; font-weight:600; font-size:0.875rem; color:#cf222e; cursor:pointer; margin-top:0.5rem; transition:all 0.2s;">
            Sign Out
          </button>
        </div>
      </nav>

      <!-- Main Content Area -->
      <main style="background:white; padding:3rem; overflow-y:auto;">
        <div id="tabContent"></div>
      </main>
    </div>

    <style>
      .tab-nav:hover {
        background: ${activeTab!=='account'?'#f3f4f6':'white'} !important;
      }
      
      .section-panel {
        margin-bottom: 2.5rem;
        padding-bottom: 2.5rem;
        border-bottom: 1px solid #e3e8ef;
      }
      
      .section-panel:last-child {
        border-bottom: none;
      }
      
      .form-row {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 2rem;
        margin-bottom: 1.5rem;
        align-items: start;
      }
      
      .form-label-col {
        padding-top: 0.5rem;
      }
      
      .form-label-col label {
        font-weight: 600;
        font-size: 0.9rem;
        color: #1f2937;
        display: block;
        margin-bottom: 0.25rem;
      }
      
      .form-label-col .help-text {
        font-size: 0.8125rem;
        color: #6b778c;
        line-height: 1.4;
      }
      
      @media (max-width: 900px) {
        .form-row {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }
      }
    </style>
  `;

  // Render the appropriate tab content
  renderTab(activeTab);

  // Tab navigation
  document.querySelectorAll('.tab-nav').forEach(btn => {
    btn.onclick = () => {
      const tab = btn.dataset.tab;
      renderTab(tab);
      // Update URL without reload
      const url = new URL(window.location);
      url.searchParams.set('tab', tab);
      window.history.pushState({}, '', url);
    };
  });

  byId('backShop').onclick = ()=> navSet({view:null});
  byId('signOut').onclick = ()=>{ user = {}; saveUser(); navSet({view:'auth'}); };
}

function renderTab(tab) {
  const content = byId('tabContent');
  
  console.log('[Account] Rendering tab:', tab);
  console.log('[Account] Current user object:', {
    email: user?.email,
    name: user?.name,
    phone: user?.phone,
    points: user?.points,
    referral_code: user?.referral_code
  });
  
  switch(tab) {
    case 'account':
      content.innerHTML = `
        <div class="section-panel">
          <h1 style="margin:0 0 0.5rem 0; font-size:1.75rem; font-weight:700; color:#1f2937;">Account</h1>
          <p style="margin:0 0 2rem 0; color:#6b778c; font-size:0.9rem;">Manage your personal information and contact details.</p>
          
          <div class="form-row">
            <div class="form-label-col">
              <label>Full Name</label>
              <span class="help-text">Your full legal name</span>
            </div>
            <div>
              <input class="inp" id="acName" type="text" placeholder="Enter your name" value="${escapeAttr(user.name||'')}" style="width:100%; max-width:400px;">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-label-col">
              <label>Email Address</label>
              <span class="help-text">Your primary email for notifications</span>
            </div>
            <div>
              <input class="inp" id="acEmail" type="email" value="${escapeAttr(user.email||'')}" disabled style="width:100%; max-width:400px; background:#f5f7fb; cursor:not-allowed; opacity:0.7;">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-label-col">
              <label>Phone Number</label>
              <span class="help-text">For order updates and support</span>
            </div>
            <div>
              <input class="inp" id="acPhone" type="tel" placeholder="(555) 123-4567" value="${escapeAttr(user.phone||'')}" style="width:100%; max-width:400px;">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-label-col"></div>
            <div>
              <button class="btn azure" id="saveAcct" style="padding:0.625rem 1.5rem;">Save Changes</button>
              <div id="acMsg" class="help" style="margin-top:0.75rem;"></div>
            </div>
          </div>
        </div>
      `;
      
      byId('saveAcct').onclick = async ()=>{
        const name  = byId('acName').value.trim();
        const phone = byId('acPhone').value.trim();
        showLoader();
        try{
          const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'upsert_user', user:{name,phone,email:user.email}})});
          const text = await resp.text();
          if(!resp.ok){ showMsg('acMsg', text || ('Error ' + resp.status)); return; }
          const data = JSON.parse(text);
          if(!data.ok){ showMsg('acMsg', data.error||'Save failed'); return; }
          user = { ...user, name:data.user.name||'', phone:data.user.phone||'' };
          saveUser();
          showMsg('acMsg','Saved successfully.');
        }catch(err){ showMsg('acMsg', String(err)); }
        finally{ hideLoader(); }
      };
      break;
      
    case 'security':
      content.innerHTML = `
        <div class="section-panel">
          <h1 style="margin:0 0 0.5rem 0; font-size:1.75rem; font-weight:700; color:#1f2937;">Security</h1>
          <p style="margin:0 0 2rem 0; color:#6b778c; font-size:0.9rem;">Manage your password and security settings.</p>
          
          <div class="form-row">
            <div class="form-label-col">
              <label>Change Password</label>
              <span class="help-text">Update your account password</span>
            </div>
            <div style="max-width:400px;">
              <input class="inp" id="cpOld" type="password" placeholder="Current password" style="width:100%; margin-bottom:0.75rem;">
              <input class="inp" id="cpNew1" type="password" placeholder="New password (min 8 characters)" style="width:100%; margin-bottom:0.75rem;">
              <input class="inp" id="cpNew2" type="password" placeholder="Confirm new password" style="width:100%; margin-bottom:1rem;">
              <button class="btn azure" id="cpDo" style="padding:0.625rem 1.5rem;">Update Password</button>
              <div id="cpMsg" class="help" style="margin-top:0.75rem;"></div>
            </div>
          </div>
        </div>
      `;
      
      byId('cpDo').onclick = async ()=>{
        const oldp = byId('cpOld').value;
        const p1   = byId('cpNew1').value;
        const p2   = byId('cpNew2').value;
        if(!oldp){ return showMsg('cpMsg','Enter your current password.'); }
        if(p1.length < 8){ return showMsg('cpMsg','New password must be at least 8 characters.'); }
        if(p1 !== p2){ return showMsg('cpMsg','Passwords do not match.'); }
        showLoader();
        try{
          const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'change_password', email:user.email, oldPassword:oldp, newPassword:p1})});
          const text = await resp.text();
          if(!resp.ok){ showMsg('cpMsg', text || ('Error ' + resp.status)); return; }
          const data = JSON.parse(text);
          if(!data.ok){ showMsg('cpMsg', data.error||'Failed'); return; }
          showMsg('cpMsg','Password updated successfully.');
          byId('cpOld').value = '';
          byId('cpNew1').value = '';
          byId('cpNew2').value = '';
        }catch(err){ showMsg('cpMsg', String(err)); }
        finally{ hideLoader(); }
      };
      break;
      
    case 'orders':
      content.innerHTML = `
        <div class="section-panel">
          <h1 style="margin:0 0 0.5rem 0; font-size:1.75rem; font-weight:700; color:#1f2937;">Order History</h1>
          <p style="margin:0 0 2rem 0; color:#6b778c; font-size:0.9rem;">View and track your past orders.</p>
          
          <div id="ordersBox">
            <div style="text-align:center; padding:3rem; color:#6b778c;">
              <div style="font-size:3rem; margin-bottom:1rem;">üì¶</div>
              <div style="font-weight:600;">Loading orders...</div>
            </div>
          </div>
        </div>
      `;
      loadOrders();
      break;
      
    case 'subscriptions':
      content.innerHTML = `
        <div class="section-panel">
          <h1 style="margin:0 0 0.5rem 0; font-size:1.75rem; font-weight:700; color:#1f2937;">Subscriptions</h1>
          <p style="margin:0 0 2rem 0; color:#6b778c; font-size:0.9rem;">Manage your active subscriptions.</p>
          
          <div id="subsBox">
            <div style="text-align:center; padding:3rem; color:#6b778c;">
              <div style="font-size:3rem; margin-bottom:1rem;">üîÑ</div>
              <div style="font-weight:600;">Loading subscriptions...</div>
            </div>
          </div>
          <div id="upsellBox" style="margin-top:2rem;"></div>
        </div>
      `;
      loadSubs();
      break;
      
    case 'rewards':
      content.innerHTML = `
        <div class="section-panel">
          <div style="max-width:800px; margin:0 auto;">
            <h1 style="margin:0 0 0.5rem 0; font-size:1.75rem; font-weight:700; color:#1f2937;">Referral Rewards</h1>
            <p style="margin:0 0 2.5rem 0; color:#6b778c; font-size:0.9rem;">Earn points by sharing Home2Smart with friends and family. Every point = $0.10 off your next service.</p>
            
            <!-- Current Balance Card -->
            <div style="background:#fff; border:2px solid #e3e8ef; border-radius:8px; padding:2rem; margin-bottom:2rem; box-shadow:0 2px 8px rgba(0,0,0,0.04);">
              <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:2rem;">
                <div style="flex:1; min-width:200px;">
                  <div style="font-size:0.8125rem; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:#6b778c; margin-bottom:0.5rem;">Your Balance</div>
                  <div style="font-size:3rem; font-weight:900; color:var(--cobalt); line-height:1; font-family:Archivo,sans-serif;" id="pointsDisplay">
                    <div style="height:3rem; width:150px; background:#f8f9fb; border-radius:6px;"></div>
                  </div>
                  <div style="font-size:1rem; font-weight:600; margin-top:0.75rem; color:var(--azure);" id="pointsWorthDisplay">$0.00 credit</div>
                </div>
                
                <div style="flex:1; min-width:200px; text-align:right;">
                  <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; text-align:center;" id="rewardsStatsGrid">
                    <div>
                      <div style="font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:#6b778c; margin-bottom:0.25rem;">Referrals</div>
                      <div style="font-size:2rem; font-weight:900; color:var(--cobalt);">0</div>
                    </div>
                    <div>
                      <div style="font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:#6b778c; margin-bottom:0.25rem;">Earned</div>
                      <div style="font-size:2rem; font-weight:900; color:var(--cobalt);">0</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Tier Progress (shown for Tier 1 users) -->
              <div id="tierProgressSection" style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid #e3e8ef; display:none;">
                <!-- Dynamic tier progress inserted here -->
              </div>
            </div>
            
            <!-- AI Thought Sparks (Personalized Suggestions) -->
            <div id="aiThoughtSparks" style="display:none; margin-bottom:2rem;">
              <div style="background:linear-gradient(135deg,#f7fafc 0%,#edf2f7 100%);border-radius:8px;padding:1.5rem;border-left:4px solid #667eea">
                <div style="font-size:0.875rem;font-weight:700;color:#667eea;text-transform:uppercase;letter-spacing:1px;margin-bottom:1rem">üí° Thought sparks for you</div>
                <div id="aiSuggestions" style="display:flex;flex-direction:column;gap:0.75rem"></div>
              </div>
            </div>
            
            <!-- How It Works Section -->
            <div style="background:#f8f9fb; border-radius:8px; padding:2rem; margin-bottom:2rem;">
              <h2 style="margin:0 0 1.5rem 0; font-size:1.25rem; font-weight:700; color:#1f2937; text-align:center;">How Referral Rewards Work</h2>
              
              <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:1.5rem;">
                <div style="text-align:center;">
                  <div style="width:64px; height:64px; background:var(--azure); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1rem; font-size:2rem;">üì§</div>
                  <h3 style="margin:0 0 0.5rem 0; font-size:1rem; font-weight:700; color:#1f2937;">1. Share Your Link</h3>
                  <p style="margin:0; font-size:0.875rem; color:#6b778c; line-height:1.5;">Send your unique referral code to friends, family, or anyone who needs smart home services.</p>
                </div>
                
                <div style="text-align:center;">
                  <div style="width:64px; height:64px; background:var(--azure); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1rem; font-size:2rem;">üõí</div>
                  <h3 style="margin:0 0 0.5rem 0; font-size:1rem; font-weight:700; color:#1f2937;">2. They Book a Service</h3>
                  <p style="margin:0; font-size:0.875rem; color:#6b778c; line-height:1.5;">When someone uses your code to purchase any service, you both benefit from the referral.</p>
                </div>
                
                <div style="text-align:center;">
                  <div style="width:64px; height:64px; background:var(--azure); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1rem; font-size:2rem;">üéÅ</div>
                  <h3 style="margin:0 0 0.5rem 0; font-size:1rem; font-weight:700; color:#1f2937;">3. You Earn Points</h3>
                  <p style="margin:0; font-size:0.875rem; color:#6b778c; line-height:1.5;">Get <strong>100 points ($10 credit)</strong> for each successful referral. No limits on how much you can earn!</p>
                </div>
              </div>
            </div>
            
            <!-- Your Referral Code Section -->
            <div style="background:#fff; border:2px solid var(--azure); border-radius:8px; padding:2rem; margin-bottom:2rem;">
              <div style="text-align:center; margin-bottom:1.5rem;">
                <h2 style="margin:0 0 0.5rem 0; font-size:1.25rem; font-weight:700; color:#1f2937;">Your Referral Code</h2>
                <p style="margin:0; font-size:0.875rem; color:#6b778c;">Share this code with anyone who needs smart home services</p>
              </div>
              
              <div style="display:flex; gap:0.75rem; max-width:400px; margin:0 auto 1rem;">
                <input class="inp" id="refCodeInput" type="text" readonly value="" style="flex:1; text-align:center; font-weight:700; font-size:1.25rem; letter-spacing:2px; background:#f8f9fb; font-family:Archivo,monospace;">
                <button class="btn azure" id="copyCodeBtn" style="white-space:nowrap;">Copy Code</button>
              </div>
              
              <div style="text-align:center;">
                <button class="btn" id="shareReferralBtn" style="background:var(--cobalt); color:white; font-weight:600; padding:0.75rem 2rem;">
                  Share via Text/Email
                </button>
              </div>
            </div>
            
            <!-- Benefits & Why Section -->
            <div style="background:linear-gradient(135deg, var(--cobalt) 0%, var(--azure) 100%); border-radius:8px; padding:2rem; color:white; margin-bottom:2rem;">
              <h2 style="margin:0 0 1.5rem 0; font-size:1.25rem; font-weight:700; text-align:center;">Why Refer Home2Smart?</h2>
              
              <div style="display:grid; gap:1rem; max-width:600px; margin:0 auto;">
                <div style="display:flex; align-items:start; gap:0.75rem;">
                  <div style="font-size:1.5rem; flex-shrink:0;">‚úì</div>
                  <div>
                    <strong style="display:block; margin-bottom:0.25rem;">Help Friends Save Money</strong>
                    <span style="opacity:0.9; font-size:0.875rem;">Your friends get professional smart home services at competitive prices with your referral bonus.</span>
                  </div>
                </div>
                
                <div style="display:flex; align-items:start; gap:0.75rem;">
                  <div style="font-size:1.5rem; flex-shrink:0;">‚úì</div>
                  <div>
                    <strong style="display:block; margin-bottom:0.25rem;">Earn Unlimited Rewards</strong>
                    <span style="opacity:0.9; font-size:0.875rem;">No cap on earnings. Refer 10 people, get $100 in credits. Refer 100, get $1,000. It's that simple.</span>
                  </div>
                </div>
                
                <div style="display:flex; align-items:start; gap:0.75rem;">
                  <div style="font-size:1.5rem; flex-shrink:0;">‚úì</div>
                  <div>
                    <strong style="display:block; margin-bottom:0.25rem;">Support Quality Service</strong>
                    <span style="opacity:0.9; font-size:0.875rem;">Every referral helps us grow and continue providing top-tier smart home installations and support.</span>
                  </div>
                </div>
                
                <div style="display:flex; align-items:start; gap:0.75rem;">
                  <div style="font-size:1.5rem; flex-shrink:0;">‚úì</div>
                  <div>
                    <strong style="display:block; margin-bottom:0.25rem;">Points Never Expire</strong>
                    <span style="opacity:0.9; font-size:0.875rem;">Your points stay in your account forever. Save them up for bigger purchases or use them right away.</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Empty State (shown when user has 0 points/referrals) -->
            <div id="emptyRewardsState" style="display:none; background:#f8f9fb; border-radius:8px; padding:3rem 2rem; text-align:center;">
              <div style="font-size:3.5rem; margin-bottom:1rem;">üöÄ</div>
              <h3 style="margin:0 0 0.75rem 0; font-size:1.5rem; font-weight:700; color:#1f2937;">Start Earning Today</h3>
              <p style="margin:0 0 1.5rem 0; color:#6b778c; max-width:500px; margin-left:auto; margin-right:auto; line-height:1.6;">
                Share your referral code above and start earning $10 credit for every person who books a service. 
                The more you share, the more you save on your own smart home upgrades!
              </p>
            </div>
            
            <!-- FAQ Section -->
            <div style="margin-top:2.5rem; padding-top:2rem; border-top:2px solid #e3e8ef;">
              <h2 style="margin:0 0 1.5rem 0; font-size:1.25rem; font-weight:700; color:#1f2937;">Frequently Asked Questions</h2>
              
              <div style="display:grid; gap:1.5rem;">
                <div>
                  <h3 style="margin:0 0 0.5rem 0; font-size:1rem; font-weight:700; color:#1f2937;">How do I redeem my points?</h3>
                  <p style="margin:0; font-size:0.875rem; color:#6b778c; line-height:1.6;">Points are automatically applied as credit to your account. When you checkout, you'll see your available balance and can choose how much to use.</p>
                </div>
                
                <div>
                  <h3 style="margin:0 0 0.5rem 0; font-size:1rem; font-weight:700; color:#1f2937;">Is there a limit to how many people I can refer?</h3>
                  <p style="margin:0; font-size:0.875rem; color:#6b778c; line-height:1.6;">Nope! Refer as many people as you want. Each successful referral earns you 100 points ($10), with no maximum limit.</p>
                </div>
                
                <div>
                  <h3 style="margin:0 0 0.5rem 0; font-size:1rem; font-weight:700; color:#1f2937;">When will I receive my points?</h3>
                  <p style="margin:0; font-size:0.875rem; color:#6b778c; line-height:1.6;">Points are credited to your account immediately after your referral completes their first purchase and payment is confirmed.</p>
                </div>
                
                <div>
                  <h3 style="margin:0 0 0.5rem 0; font-size:1rem; font-weight:700; color:#1f2937;">Can I share my code on social media?</h3>
                  <p style="margin:0; font-size:0.875rem; color:#6b778c; line-height:1.6;">Absolutely! Share your code anywhere - Facebook, Instagram, Twitter, neighborhood groups, or directly via text and email. The more you share, the more you earn.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      loadRewardsData();
      break;
  }
}

async function loadRewardsData() {
  try {
    console.log('[Rewards] Fetching rewards data for:', user.email);
    const resp = await fetch(API + '?action=referral_ensure&email=' + encodeURIComponent(user.email));
    const data = await resp.json();
    
    console.log('[Rewards] API response:', data);
    
    if(data.ok && data.points_available !== undefined) {
      const points = data.points_available || 0;
      const tier = data.tier || 1;
      const totalReferrals = data.total_referrals || 0;
      const totalEarned = data.total_points_earned || points;
      const refCode = data.refCode || '';
      
      console.log('[Rewards] Parsed values:', {
        points,
        tier,
        totalReferrals,
        totalEarned,
        refCode
      });
      
      // Update main points display
      const pointsEl = byId('pointsDisplay');
      if(pointsEl) {
        pointsEl.textContent = points.toLocaleString();
        console.log('[Rewards] Updated points display to:', points);
      } else {
        console.error('[Rewards] Could not find pointsDisplay element');
      }
      
      const worthEl = byId('pointsWorthDisplay');
      if(worthEl) {
        worthEl.textContent = `$${(points / 10).toFixed(2)} credit`;
      }
      
      const codeEl = byId('refCodeInput');
      if(codeEl) {
        codeEl.value = refCode;
        console.log('[Rewards] Updated referral code to:', refCode);
      } else {
        console.error('[Rewards] Could not find refCodeInput element');
      }
      
      // Update user object
      user.points = points;
      user.referral_code = refCode;
      saveUser(user);
      
      // Show/hide empty state
      const emptyState = byId('emptyRewardsState');
      if(emptyState) {
        if(points === 0 && totalReferrals === 0) {
          emptyState.style.display = 'block';
          console.log('[Rewards] Showing empty state (no points or referrals)');
        } else {
          emptyState.style.display = 'none';
          console.log('[Rewards] Hiding empty state');
        }
      }
      
      // Update stats grid
      const statsGrid = byId('rewardsStatsGrid');
      if(statsGrid) {
        statsGrid.innerHTML = `
          <div>
            <div style="font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:#6b778c; margin-bottom:0.25rem;">Referrals</div>
            <div style="font-size:2rem; font-weight:900; color:var(--cobalt);">${totalReferrals}</div>
          </div>
          <div>
            <div style="font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:#6b778c; margin-bottom:0.25rem;">Earned</div>
            <div style="font-size:2rem; font-weight:900; color:var(--cobalt);">${totalEarned}</div>
          </div>
        `;
        console.log('[Rewards] Updated stats grid - Referrals:', totalReferrals, 'Earned:', totalEarned);
      } else {
        console.error('[Rewards] Could not find rewardsStatsGrid element');
      }
      
      // Show tier progress if tier 1
      const tierSection = byId('tierProgressSection');
      if(tier === 1 && totalReferrals < 5) {
        const remaining = 5 - totalReferrals;
        const progress = (totalReferrals / 5) * 100;
        tierSection.style.display = 'block';
        tierSection.innerHTML = `
          <div style="margin-bottom:0.75rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
              <span style="font-size:0.875rem; font-weight:600; color:#6b778c;">Progress to Power Referrer (Tier 2)</span>
              <span style="font-size:0.875rem; font-weight:700; color:var(--cobalt);">${totalReferrals}/5</span>
            </div>
            <div style="background:#e3e8ef; height:8px; border-radius:4px; overflow:hidden;">
              <div style="background:linear-gradient(90deg, var(--azure) 0%, var(--cobalt) 100%); height:100%; width:${progress}%; transition:width 0.5s ease-out;"></div>
            </div>
          </div>
          <p style="margin:0; font-size:0.875rem; color:#6b778c;">
            <strong style="color:var(--cobalt);">${remaining} more referral${remaining !== 1 ? 's' : ''}</strong> to unlock Power Referrer status with exclusive perks and bonus rewards!
          </p>
        `;
      } else if(tier === 2) {
        tierSection.style.display = 'block';
        tierSection.innerHTML = `
          <div style="background:linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border-radius:8px; padding:1rem; text-align:center;">
            <div style="font-size:1.25rem; margin-bottom:0.25rem;">‚≠ê Power Referrer Status ‚≠ê</div>
            <div style="font-size:0.875rem; font-weight:600; color:#fff;">You've reached elite status! Keep sharing to earn even more rewards.</div>
          </div>
        `;
      }
      
      // Copy code button handler
      const copyBtn = byId('copyCodeBtn');
      if(copyBtn) {
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(refCode).then(() => {
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
          });
        };
      }
      
      // Share button handler
      const shareBtn = byId('shareReferralBtn');
      if(shareBtn) {
        shareBtn.onclick = () => {
          const shareUrl = `${window.location.origin}/shop?ref=${refCode}`;
          const shareText = `I've been using Home2Smart for my smart home needs and they're awesome! Use my code ${refCode} when you book your first service and we'll both get rewarded! ${shareUrl}`;
          
          if(navigator.share) {
            navigator.share({ 
              title: 'Home2Smart Referral', 
              text: shareText
            }).catch(() => {}); // User cancelled
          } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(shareText).then(() => {
              const originalText = shareBtn.innerHTML;
              shareBtn.innerHTML = '‚úì Message Copied!';
              setTimeout(() => { shareBtn.innerHTML = originalText; }, 2500);
            });
          }
        };
      }
      
      console.log('[Rewards] Points loaded:', points);
      
      // Load AI thought sparks (async, doesn't block)
      loadAIThoughtSparks();
      
    } else {
      console.warn('[Rewards] No points data in response:', data);
      byId('pointsDisplay').textContent = '0';
      byId('emptyRewardsState').style.display = 'block';
    }
  } catch(err) {
    console.error('[Rewards] Failed to load:', err);
    byId('pointsDisplay').textContent = '0';
  }
}

async function loadOrders() {
  const box = byId('ordersBox');
  if(!box) return;
  
  try {
    const res = await fetch(API + '?action=orders&email=' + encodeURIComponent(user.email));
    const data = await res.json();
    const orders = Array.isArray(data.orders) ? data.orders : [];
    
    if(!orders.length) {
      box.innerHTML = `
        <div style="text-align:center; padding:3rem; background:#f8f9fb; border-radius:12px;">
          <div style="font-size:3rem; margin-bottom:1rem;">üì¶</div>
          <h3 style="margin:0 0 0.5rem 0; font-size:1.125rem; font-weight:700; color:#1f2937;">No orders yet</h3>
          <p style="margin:0; color:#6b778c;">Your order history will appear here.</p>
        </div>
      `;
      return;
    }
    
    // Sort newest first
    orders.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
    
    let html = '<div style="border:1px solid #e3e8ef; border-radius:8px; overflow:hidden;">';
    orders.forEach((o, idx) => {
      const oid = o.order_id || o.stripe_session_id || '‚Äî';
      const when = o.install_at ? new Date(o.install_at).toLocaleString() : (o.service_date || (o.created_at ? new Date(o.created_at).toLocaleDateString() : '‚Äî'));
      const summary = o.order_summary || '';
      const total = Number(o.order_total) || 0;
      
      html += `
        <div style="padding:1.25rem 1.5rem; border-bottom:1px solid #e3e8ef; ${idx % 2 === 0 ? 'background:#f8f9fb;' : ''}">
          <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:${summary ? '0.75rem' : '0'};">
            <div style="flex:1;">
              <div style="font-weight:700; font-size:0.9rem; color:#1f2937; margin-bottom:0.25rem;">Order #${escapeHtml(String(oid))}</div>
              <div style="font-size:0.8125rem; color:#6b778c;">${escapeHtml(when)}</div>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:700; font-size:1rem; color:#1f2937;">${money(total)}</div>
            </div>
          </div>
          ${summary ? `<div style="font-size:0.8125rem; color:#6b778c; padding-top:0.75rem; border-top:1px solid #e3e8ef;">${escapeHtml(summary)}</div>` : ''}
        </div>
      `;
    });
    html += '</div>';
    
    box.innerHTML = html;
  } catch(err) {
    box.innerHTML = `<div style="text-align:center; padding:2rem; color:#cf222e;">Could not load orders.</div>`;
  }
}

async function loadSubs() {
  const box = byId('subsBox');
  if(!box) return;
  
  try {
    const url = API + '?action=subscriptions&email=' + encodeURIComponent(user.email);
    const res = await fetch(url);
    const data = await res.json();
    const active = Array.isArray(data.active) ? data.active : [];
    
    if(!active.length) {
      byId('subsBox').innerHTML = `
        <div style="text-align:center; padding:3rem; background:#f8f9fb; border-radius:12px;">
          <div style="font-size:3rem; margin-bottom:1rem;">üîÑ</div>
          <h3 style="margin:0 0 0.5rem 0; font-size:1.125rem; font-weight:700; color:#1f2937;">No active subscriptions</h3>
          <p style="margin:0; color:#6b778c;">Subscribe to services for recurring benefits.</p>
        </div>
      `;
      return;
    }
    
    let html = '<div style="border:1px solid #e3e8ef; border-radius:8px; overflow:hidden;">';
    active.forEach((sub, idx) => {
      const membName = sub.membership_name || (sub.membership_id || '');
      const nextBill = sub.next_billing_at ? new Date(sub.next_billing_at).toLocaleDateString() : '‚Äî';
      const statusTxt = String(sub.status || 'active').toLowerCase();
      const amount = parseMoneyCell(sub.unit_price);
      const amtStr = isFinite(amount) && amount > 0 ? money(amount) : '‚Äî';
      
      html += `
        <div style="padding:1.25rem 1.5rem; border-bottom:1px solid #e3e8ef; ${idx % 2 === 0 ? 'background:#f8f9fb;' : ''}">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-weight:700; font-size:0.9rem; color:#1f2937; margin-bottom:0.25rem;">${escapeHtml(membName)}</div>
              <div style="font-size:0.8125rem; color:#6b778c;">Next billing: ${nextBill}</div>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:700; font-size:1rem; color:#1f2937; margin-bottom:0.25rem;">${amtStr}/mo</div>
              <div style="font-size:0.75rem; font-weight:600; color:${statusTxt === 'active' ? '#2da44e' : '#cf222e'}; text-transform:uppercase;">${statusTxt}</div>
            </div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    
    box.innerHTML = html;
  } catch(err) {
    box.innerHTML = `<div style="text-align:center; padding:2rem; color:#cf222e;">Could not load subscriptions.</div>`;
  }
}

function findServiceForMembership(m){
  if(!m) return null;
  const mid = String(m.membership_id||'').toLowerCase();
  const nm  = String(m.name||'').toLowerCase();
  return (catalog.services||[]).find(s=>{
    const sid = String(s.service_id||'').toLowerCase();
    const sn  = String(s.name||'').toLowerCase();
    return sid===mid || sn.includes(nm) || sn.includes(mid);
  }) || null;
}

function findServiceByNameContains(substr){
  const s = String(substr||'').toLowerCase();
  return (catalog.services||[]).find(x=> String(x.name||'').toLowerCase().includes(s));
}

// === CART ===
function wireCart(){
  byId('cartBtn').onclick = openCart;
  byId('closeCart').onclick = closeCart;
  byId('backdrop').onclick = closeCart;
  byId('checkout').onclick = checkout;
  const bsi = byId('bannerSignIn'); if(bsi){ bsi.onclick = ()=> navSet({view: user?.email ? 'account' : 'auth'}); }
  const bd = byId('bundleDismiss'); if(bd){ bd.onclick = ()=>{ const bb=byId('bundleBanner'); if(bb) bb.style.display='none'; }; }
  
  // Wire referral code input
  const refInput = byId('referralCodeInput');
  const refBtn = byId('applyReferralBtn');
  
  if(refInput && refBtn){
    // Auto-fill if we have a code
    if(referralCode) refInput.value = referralCode;
    
    // Apply on button click
    refBtn.onclick = async () => {
      const code = refInput.value.trim().toUpperCase();
      if(!code) return;
      
      refBtn.disabled = true;
      refBtn.textContent = 'Checking...';
      
      const result = await validateReferralCode(code);
      
      if(result && result.valid){
        referralCode = code;
        referralData = result;
        saveReferralCode(code);
        showReferralMessage('‚úì Code applied! You\'ll get a discount at checkout.', 'success');
        showReferralDiscount(result);
      } else {
        referralCode = null;
        referralData = null;
        saveReferralCode(null);
        showReferralMessage('Invalid code. Please check and try again.', 'error');
        hideReferralDiscount();
      }
      
      refBtn.disabled = false;
      refBtn.textContent = 'Apply';
    };
    
    // Apply on Enter key
    refInput.addEventListener('keypress', (e) => {
      if(e.key === 'Enter') refBtn.click();
    });
    
    // Auto-validate on page load if we have a saved code
    if(referralCode){
      setTimeout(async () => {
        const result = await validateReferralCode(referralCode);
        if(result && result.valid){
          referralData = result;
          showReferralDiscount(result);
        } else {
          // Code no longer valid, clear it
          referralCode = null;
          referralData = null;
          saveReferralCode(null);
          refInput.value = '';
        }
      }, 500);
    }
  }
  
  // Wire points redemption buttons
  const applyPointsBtn = byId('applyPointsBtn');
  const removePointsBtn = byId('removePointsBtn');
  
  if(applyPointsBtn){
    applyPointsBtn.onclick = applyPointsToCart;
  }
  
  if(removePointsBtn){
    removePointsBtn.onclick = removePointsFromCart;
  }
}

function showReferralMessage(text, type){
  const msg = byId('referralMessage');
  if(!msg) return;
  msg.textContent = text;
  msg.className = `referral-message ${type}`;
  msg.hidden = false;
  setTimeout(() => { msg.hidden = true; }, 5000);
}

function showReferralDiscount(data){
  const discount = byId('referralDiscount');
  const amount = byId('referralDiscountAmount');
  const savingsDiv = byId('referralSavingsAmount');
  const savingsValue = byId('savingsValue');
  
  if(!discount || !amount) return;
  
  // Show tier badge
  const tierLabel = data.tier === 'tier2' ? 'üåü VIP 20% OFF' : '‚ú® 10% OFF';
  amount.textContent = tierLabel;
  
  // Calculate and show estimated savings
  const subtotal = cartSubtotal();
  const percent = data.tier === 'tier2' ? 0.20 : 0.10;
  const savings = subtotal * percent;
  
  if(savingsDiv && savingsValue && savings > 0){
    savingsValue.textContent = '$' + savings.toFixed(2);
    savingsDiv.hidden = false;
  }
  
  discount.hidden = false;
  
  // Add confetti animation (visual feedback)
  triggerConfetti();
}

function triggerConfetti(){
  // Simple confetti effect
  const cart = byId('cartDrawer');
  if(!cart) return;
  
  for(let i = 0; i < 15; i++){
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.textContent = ['üéâ', '‚ú®', '‚≠ê', 'üí´'][Math.floor(Math.random() * 4)];
      confetti.style.cssText = `
        position:absolute;
        font-size:${16 + Math.random() * 12}px;
        left:${Math.random() * 100}%;
        top:20%;
        pointer-events:none;
        animation:confettiFall ${1 + Math.random()}s ease-out forwards;
        z-index:9999;
      `;
      cart.appendChild(confetti);
      setTimeout(() => confetti.remove(), 1500);
    }, i * 50);
  }
}

// Add confetti animation
const style = document.createElement('style');
style.textContent = `
  @keyframes confettiFall {
    to {
      transform: translateY(300px) rotate(360deg);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);

function hideReferralDiscount(){
  const discount = byId('referralDiscount');
  if(discount) discount.hidden = true;
}
function openCart(){ 
  byId('cartDrawer').classList.add('open'); 
  byId('backdrop').hidden=false; 
  paintCart(); 
  renderSigninState(); 
  
  // Refresh user points data when cart opens
  if (user && user.email) {
    refreshUserPoints();
  }
  
  // Track cart open
  h2sTrack('ViewCart', { cart_total: cartSubtotal(), currency: 'USD' });
}
function closeCart(){ byId('cartDrawer').classList.remove('open'); byId('backdrop').hidden=true; }

// === PRICING + OPTIONS HELPERS ===
function getOptionsForService(service_id){
  return (catalog.serviceOptions||[]).filter(o => String(o.service_id)===String(service_id) && o.active!==false)
                                     .sort((a,b)=>{
                                       const as = Number(a.sort), bs = Number(b.sort);
                                       const aHas = Number.isFinite(as), bHas = Number.isFinite(bs);
                                       if(aHas && bHas && as!==bs) return as-bs;
                                       if(aHas && !bHas) return -1;
                                       if(!aHas && bHas) return 1;
                                       return String(a.label||'').localeCompare(String(b.label||''));
                                     });
}

function pickTier(service_id, qty, optionId){
  const q = Number(qty||0);
  const tiers = (catalog.priceTiers||[])
    .filter(t => String(t.service_id)===String(service_id))
    .filter(t => optionId==null ? true : String(t.option_id||'').trim()===String(optionId).trim())
    .map(t=>({
      min: Number(t.min_qty||0),
      max: (t.max_qty===''||t.max_qty==null)? Infinity : Number(t.max_qty),
      unit: Number(parseMoneyCell(t.unit_price)||0),
      price_id: t.stripe_price_id
    }));
  const fits = tiers.filter(t=> q>=t.min && q<=t.max);
  fits.sort((a,b)=>(a.max-a.min)-(b.max-b.min));
  return fits[0] || null;
}

// Get all pricing tiers for a service to show volume discounts
function getAllTiers(service_id, optionId){
  const tiers = (catalog.priceTiers||[])
    .filter(t => String(t.service_id)===String(service_id))
    .filter(t => optionId==null ? true : String(t.option_id||'').trim()===String(optionId).trim())
    .map(t=>({
      min: Number(t.min_qty||0),
      max: (t.max_qty===''||t.max_qty==null)? Infinity : Number(t.max_qty),
      unit: Number(parseMoneyCell(t.unit_price)||0),
      price_id: t.stripe_price_id
    }))
    .sort((a,b) => a.min - b.min);
  return tiers;
}

// Generate volume pricing message if multiple tiers exist
function getVolumePricingMessage(service_id, optionId){
  const tiers = getAllTiers(service_id, optionId);
  if(tiers.length <= 1) return '';
  
  const ranges = tiers.map(t => {
    const maxStr = t.max === Infinity ? '+' : `-${t.max}`;
    const range = t.min === t.max ? `${t.min}` : `${t.min}${maxStr}`;
    return `${range}: ${money(t.unit)}/ea`;
  });
  
  return `<div style="margin-top:8px;padding:8px 10px;background:#e7f3ff;border:1px solid #b3d9ff;border-radius:8px;font-size:13px;color:#0a2a5a;">
    <strong>üí∞ Volume pricing:</strong> ${ranges.join(' ‚Ä¢ ')}
  </div>`;
}

function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
function money(n){ return (Number(n)||0).toLocaleString('en-US',{style:'currency',currency:'USD'}); }
function parseMoneyCell(v){ const m = String(v||'').match(/-?\d+(\.\d+)?/); return m ? Number(m[0]) : 0; }

// === CART MODEL ===
function addToCart(service_id, qty, option_id=null){
  const idx = cart.findIndex(l => !l.type && l.service_id===service_id && String(l.option_id||'')===String(option_id||''));
  if(idx>=0){ cart[idx].qty = Number(cart[idx].qty||0) + Number(qty||0); }
  else cart.push({ service_id, qty:Number(qty||1), option_id: option_id||null });
  saveCart();
  
  // Track add to cart
  const s = (catalog.services||[]).find(x => String(x.service_id) === String(service_id));
  const tier = pickTier(service_id, qty, option_id);
  if(s && tier){
    h2sTrack('AddToCart', {
      product_id: service_id,
      product_name: s.name,
      quantity: qty,
      price: tier.unit,
      currency: 'USD',
      option_id: option_id || null
    });
  }
  
  openCart();
}
function setQty(service_id, qty, option_id=null){
  const ln = cart.find(l => !l.type && l.service_id===service_id && String(l.option_id||'')===String(option_id||''));
  if(!ln) return;
  ln.qty = Math.max(0, Number(qty||0));
  if(ln.qty===0){
    cart = cart.filter(l => !( !l.type && l.service_id===service_id && String(l.option_id||'')===String(option_id||'')));
  }
  saveCart();
}
function removeLine(line){
  cart = cart.filter(l=>{
    if(line.type==='bundle') return !(l.type==='bundle' && l.bundle_id===line.bundle_id);
    return !( !l.type && l.service_id===line.service_id && String(l.option_id||'')===String(line.option_id||'') );
  });
  saveCart();
}
function saveCart(){ 
  localStorage.setItem('h2s_cart', JSON.stringify(cart)); 
  updateCartBadge(); 
  paintCart(); 
  syncCartToUrl();
}
function loadCart(){ try{ return JSON.parse(localStorage.getItem('h2s_cart')||'[]'); }catch(_){ return []; } }

// Encode cart to URL format: service:option*qty,service:option*qty
function encodeCartToUrl(cartItems = cart){
  if(!cartItems || !cartItems.length) return '';
  return cartItems.map(item => {
    if(item.type === 'bundle') return `bundle:${item.bundle_id}*${item.qty}`;
    const svc = item.service_id || '';
    const opt = item.option_id ? `:${item.option_id}` : '';
    return `${svc}${opt}*${item.qty}`;
  }).join(',');
}

// Decode URL cart parameter to cart array
function decodeCartFromUrl(cartParam){
  if(!cartParam) return [];
  const items = String(cartParam).split(',');
  return items.map(item => {
    const parts = item.split('*');
    const qty = Number(parts[1]) || 1;
    const servicePart = parts[0];
    
    if(servicePart.startsWith('bundle:')){
      return { type: 'bundle', bundle_id: servicePart.replace('bundle:', ''), qty };
    }
    
    const [service_id, option_id] = servicePart.split(':');
    return { service_id, qty, option_id: option_id || null };
  }).filter(item => item.service_id || item.bundle_id);
}

// Sync cart to URL without triggering navigation
function syncCartToUrl(){
  const url = new URL(location.href);
  if(cart.length){
    url.searchParams.set('cart', encodeCartToUrl());
  } else {
    url.searchParams.delete('cart');
  }
  history.replaceState({}, '', url.toString());
}
function saveUser(skipRender){ 
  localStorage.setItem('h2s_user', JSON.stringify(user||{})); 
  if(!skipRender) renderSigninState(); 
}
function loadUser(){ try{ return JSON.parse(localStorage.getItem('h2s_user')||'{}'); }catch(_){ return {}; } }

// === REFERRAL CODE FUNCTIONS ===
function saveReferralCode(code){
  if(!code) {
    localStorage.removeItem('h2s_referral_code');
    document.cookie = 'h2s_ref=; max-age=0; path=/';
    return;
  }
  localStorage.setItem('h2s_referral_code', code.toUpperCase());
  // Also save in cookie for 30 days (accessible across pages)
  const expires = new Date(Date.now() + 30*24*60*60*1000).toUTCString();
  document.cookie = `h2s_ref=${code.toUpperCase()}; expires=${expires}; path=/; SameSite=Lax`;
}

function loadReferralCode(){
  // Try localStorage first
  let code = localStorage.getItem('h2s_referral_code');
  if(code) return code.toUpperCase();
  
  // Try cookie
  const match = document.cookie.match(/h2s_ref=([^;]+)/);
  if(match) return match[1].toUpperCase();
  
  // Try URL param ?c=CODE or ?ref=CODE
  const params = new URLSearchParams(window.location.search);
  code = params.get('c') || params.get('ref');
  if(code){
    saveReferralCode(code); // Save for later
    return code.toUpperCase();
  }
  
  return null;
}

async function validateReferralCode(code){
  if(!code || code.trim().length === 0) return null;
  
  try {
    const resp = await fetch(`${API}?action=referral&c=${encodeURIComponent(code.toUpperCase())}`);
    if(!resp.ok) return null;
    
    const data = await resp.json();
    if(data.valid) {
      return {
        code: code.toUpperCase(),
        tier: data.tier,
        discount: data.discount,
        valid: true
      };
    }
    return null;
  } catch(err) {
    console.error('Referral validation error:', err);
    return null;
  }
}

// === POINTS REDEMPTION FUNCTIONS ===
async function refreshUserPoints() {
  if (!user || !user.email) return;
  
  try {
    const resp = await fetch(API + '?action=referral_ensure&email=' + encodeURIComponent(user.email));
    const data = await resp.json();
    
    if (data.ok) {
      // Update user object with latest points data
      user.points_available = data.points_available || 0;
      user.points = data.points_available || 0; // Backwards compat
      user.referral_points = data.total_points_earned || 0;
      user.points_claimed = (data.total_points_earned || 0) - (data.points_available || 0);
      user.refCode = data.refCode || user.refCode;
      
      // Save updated user object
      saveUser();
      
      // Update points display in cart
      updatePointsDisplay();
      
      console.log('[Points] Refreshed user points:', user.points_available);
    }
  } catch (err) {
    console.error('[Points] Failed to refresh user points:', err);
  }
}

function getUserPoints() {
  // Check multiple possible field names for backwards compatibility
  const points = Number(user?.points_available || user?.points || user?.referral_points || 0);
  return points;
}

function pointsToDollars(points) {
  // 10 points = $1.00
  return points / 10;
}

function dollarsToPoints(dollars) {
  // $1.00 = 10 points
  return Math.floor(dollars * 10);
}

function applyPointsToCart() {
  const availablePoints = getUserPoints();
  if (availablePoints <= 0) {
    showPointsMessage('You don\'t have any points to use.', 'error');
    return;
  }
  
  const subtotal = cartSubtotal();
  if (subtotal <= 0) {
    showPointsMessage('Add items to your cart first.', 'error');
    return;
  }
  
  // Calculate max points we can use (can't exceed cart total)
  const maxDollars = subtotal;
  const maxPoints = dollarsToPoints(maxDollars);
  const pointsToUse = Math.min(availablePoints, maxPoints);
  
  appliedPoints = pointsToUse;
  pointsDiscount = pointsToDollars(pointsToUse);
  
  updatePointsDisplay();
  showPointsMessage(`Applied ${pointsToUse} points ($${pointsDiscount.toFixed(2)} off)`, 'success');
  
  // Hide apply button, show applied state
  byId('applyPointsBtn').hidden = true;
  byId('pointsApplied').hidden = false;
  byId('pointsMessage').hidden = true;
  
  console.log('[Points] Applied:', appliedPoints, 'points =', pointsDiscount, 'dollars');
}

function removePointsFromCart() {
  appliedPoints = 0;
  pointsDiscount = 0;
  
  updatePointsDisplay();
  byId('applyPointsBtn').hidden = false;
  byId('pointsApplied').hidden = true;
  byId('pointsMessage').hidden = true;
  
  console.log('[Points] Removed points from cart');
}

function updatePointsDisplay() {
  const section = byId('pointsRedemptionSection');
  const availablePoints = getUserPoints();
  
  // Show/hide section based on whether user has points
  if (!user || !user.email || availablePoints <= 0) {
    section.style.display = 'none';
    // Hide points discount line in totals
    const discountLine = byId('pointsDiscountLine');
    if (discountLine) discountLine.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  byId('pointsBalanceDisplay').textContent = `${availablePoints} pts available`;
  byId('pointsValueDisplay').textContent = `Worth $${pointsToDollars(availablePoints).toFixed(2)} credit`;
  
  // Update applied state display
  if (appliedPoints > 0) {
    byId('appliedPointsText').textContent = `Using ${appliedPoints} points`;
    byId('appliedDiscountText').textContent = `-$${pointsDiscount.toFixed(2)}`;
    
    // Show points discount in totals section
    const discountLine = byId('pointsDiscountLine');
    const discountAmount = byId('pointsDiscountAmount');
    if (discountLine && discountAmount) {
      discountLine.style.display = '';
      discountAmount.textContent = `-$${pointsDiscount.toFixed(2)}`;
    }
  } else {
    // Hide points discount line when no points applied
    const discountLine = byId('pointsDiscountLine');
    if (discountLine) discountLine.style.display = 'none';
  }
}

function showPointsMessage(text, type) {
  const msg = byId('pointsMessage');
  if (!msg) return;
  msg.textContent = text;
  msg.className = `points-message ${type}`;
  msg.hidden = false;
  
  // Auto-hide success messages after 3 seconds
  if (type === 'success') {
    setTimeout(() => { msg.hidden = true; }, 3000);
  }
}

function updateCartBadge(){
  const count = cart.reduce((n,l)=> n + Number(l.qty||0), 0);
  byId('cartCount').textContent = count;
}
function cartSubtotal(lines=cart){
  return lines.reduce((sum, ln)=>{
    if(ln.type==='bundle'){
      const b = (catalog.bundles||[]).find(x=> x.bundle_id===ln.bundle_id);
      return sum + (parseMoneyCell(b?.bundle_price) * Number(ln.qty||1));
    } else {
      const tier = pickTier(ln.service_id, ln.qty, ln.option_id||null);
      const unit = tier ? tier.unit : 0;
      return sum + unit * Number(ln.qty||0);
    }
  }, 0);
}

// === BUNDLE RECOMMENDATIONS ===
function bundlesMatchingCart(){
  const rec = [];
  const bundles = (catalog.bundles||[]).filter(b => b.active!==false);
  for(const b of bundles){
    const plan = calcBundlePlan(b);
    if(plan && plan.savings > 0){ rec.push(plan); }
  }
  rec.sort((a,b)=> b.savings - a.savings);
  return rec;
}
function calcBundlePlan(bundle){
  const recipe = (catalog.bundleItems||[]).filter(it => String(it.bundle_id)===String(bundle.bundle_id));
  if(!recipe.length) return null;

  const use = {};
  for(const item of recipe){
    const need = Number(item.required_qty||0);
    const have = cart.find(l => !l.type && String(l.service_id)===String(item.service_id));
    if(!have || Number(have.qty||0) < need) return null;
    use[item.service_id] = need;
  }

  let requiredCost = 0;
  for(const item of recipe){
    const tier = pickTier(item.service_id, Number(item.required_qty||0), null) || pickTier(item.service_id, 1, null);
    const unit = tier ? Number(tier.unit||0) : 0;
    requiredCost += unit * Number(item.required_qty||0);
  }

  const bundlePrice = parseMoneyCell(bundle.bundle_price);
  const savings = Math.max(0, requiredCost - bundlePrice);

  const serviceMap = indexBy((catalog.services||[]), 'service_id');
  const lineList = recipe.map(r=>{
    const s = serviceMap[r.service_id];
    return `${Number(r.required_qty||0)} √ó ${(s && s.name) ? s.name : r.service_id}`;
  });

  return {
    bundle_id: bundle.bundle_id,
    name: bundle.name || bundle.bundle_id,
    image_url: bundle.image_url || '',
    savings,
    requiredCost,
    bundlePrice,
    use,
    recipeList: lineList
  };
}
function applyBundleSwap(bundle_id){
  const plan = bundlesMatchingCart().find(p=> p.bundle_id===bundle_id);
  if(!plan) return;
  Object.entries(plan.use).forEach(([sid, reqQty])=>{
    const ln = cart.find(l=> !l.type && l.service_id===sid);
    if(!ln) return;
    ln.qty = Math.max(0, Number(ln.qty||0) - Number(reqQty||0));
  });
  cart = cart.filter(l=> !( !l.type && Number(l.qty||0)===0 ));
  const existing = cart.find(l=> l.type==='bundle' && l.bundle_id===bundle_id);
  if(existing) existing.qty += 1; else cart.push({ type:'bundle', bundle_id, qty:1 });
  
  // Track bundle swap
  const b = (catalog.bundles||[]).find(x => x.bundle_id === bundle_id);
  if(b){
    h2sTrack('BundleSwap', {
      bundle_id: bundle_id,
      bundle_name: b.name,
      savings: plan.savings
    });
  }
  
  saveCart();
}

// === RULE-BASED RECOMMENDATIONS ===
function recommendationsMatchingCart(){
  const rules = (catalog.recommendations||[]).filter(r => r.active!==false);
  if(!rules.length) return [];

  const qtyByService = {};
  (cart||[]).forEach(l=>{
    if(l.type==='bundle') return;
    qtyByService[l.service_id] = (qtyByService[l.service_id]||0) + Number(l.qty||0);
  });

  const hits = [];
  const seen = new Set();

  rules.forEach(r=>{
    const trig = String(r.trigger_type||'').toLowerCase().replace('_','-');
    if(trig==='service-qty'){
      const sid = String(r.trigger_service_id||'').trim();
      const need = Number(r.min_qty||0);
      const have = Number(qtyByService[sid]||0);
      if(have >= need){
        const recSid = String(r.recommended_service_id||'').trim();
        if(!recSid) return;
        if(seen.has(recSid)) return;
        const already = Number(qtyByService[recSid]||0) > 0;
        if(already) return;

        seen.add(recSid);
        hits.push({ rule: r, service_id: recSid });
      }
    }
  });

  hits.sort((a,b)=>{
    const sa = Number(a.rule.sort||9999), sb = Number(b.rule.sort||9999);
    if(sa!==sb) return sa - sb;
    return String(a.rule.message||'').localeCompare(String(b.rule.message||''));
  });

  return hits;
}

/* === RECS: per-cart dismiss + cap @ 4 === */
const REC_DISMISS_PREFIX = 'h2s_rec_dismiss_';
function cartSignature(){
  const qtyByService = {};
  (cart||[]).forEach(l=>{
    if(l.type==='bundle') return;
    qtyByService[l.service_id] = (qtyByService[l.service_id]||0) + Number(l.qty||0);
  });
  const ids = Object.keys(qtyByService).sort();
  return ids.map(id=>id+':'+qtyByService[id]).join('|');
}
function getDismissedRecsForSig(sig){
  try{
    const raw = localStorage.getItem(REC_DISMISS_PREFIX + sig);
    const arr = JSON.parse(raw||'[]');
    return Array.isArray(arr) ? arr : [];
  }catch(_){ return []; }
}
function setDismissedRecsForSig(sig, list){
  try{ localStorage.setItem(REC_DISMISS_PREFIX + sig, JSON.stringify(Array.from(new Set(list)))); }catch(_){}
}
function dismissRec(service_id){
  const sig = cartSignature();
  const cur = getDismissedRecsForSig(sig);
  if(!cur.includes(service_id)){
    cur.push(service_id);
    setDismissedRecsForSig(sig, cur);
  }
  renderRecsPanel();
}

function renderRecsPanel(){
  const panel = byId('recsPanel');
  if(!panel) return;

  const sig = cartSignature();
  const dismissed = new Set(getDismissedRecsForSig(sig));

  const recs = recommendationsMatchingCart()
    .filter(({service_id})=> !dismissed.has(service_id));

  if(!recs.length){ panel.style.display='none'; panel.innerHTML=''; return; }

  const svcMap = indexBy(catalog.services||[], 'service_id');

  const visible = recs.slice(0, 4);

  panel.style.display='';
  panel.innerHTML = visible.map(({rule, service_id})=>{
    const svc = svcMap[service_id] || {};
    const external = String(svc.checkout_type||'cart')==='external';
    const unit = external ? null : (pickTier(service_id, Math.max(1, Number(svc.min_qty||1)), null)?.unit || 0);
    const pricePart = external ? '' : `<div class="r-price" style="font-weight:800">${money(unit)}</div>`;
    const img = rule.image_url || svc.image_url || '';
    const title = svc.name || service_id;
    const msg = rule.message || '';
    const cta = external
      ? `<a class="btn azure" href="${svc.external_url||'#'}" target="_blank" rel="noopener">Open</a>`
      : `<button class="btn azure" data-rec-add="${service_id}">Add</button>`;
    const dismiss = `<button class="rec-dismiss" data-rec-dismiss="${service_id}" aria-label="Dismiss ${escapeAttr(title)}">Dismiss</button>`;
    return `
      <div class="rec-card">
        <img src="${img}" alt="${escapeHtml(title)}" width="800" height="800" loading="lazy" decoding="async">
        <div class="r-text">
          <div class="r-title">${escapeHtml(title)}</div>
          <div class="r-msg">${escapeHtml(msg)}</div>
          ${dismiss}
        </div>
        <div style="display:grid; gap:6px; justify-items:end">
          ${pricePart}
          ${cta}
        </div>
      </div>
    `;
  }).join('');

  panel.querySelectorAll('[data-rec-add]').forEach(btn=>{
    btn.onclick = ()=> {
      const service_id = btn.getAttribute('data-rec-add');
      const svc = (catalog.services||[]).find(x => String(x.service_id) === String(service_id));
      
      // Track rule-based recommendation add
      if(svc){
        h2sTrack('AddRecommendation', {
          product_id: service_id,
          product_name: svc.name,
          recommendation_type: 'rule-based'
        });
      }
      
      addToCart(service_id, 1, null);
    };
  });
  panel.querySelectorAll('[data-rec-dismiss]').forEach(btn=>{
    btn.onclick = ()=> dismissRec(btn.getAttribute('data-rec-dismiss'));
  });
}

// === CART PAINT ===
function paintCart(){
  // Defer bundle/recs panel computation to idle time
  if('requestIdleCallback' in window){
    requestIdleCallback(() => {
      renderBundlePanel();
      renderRecsPanel();
    }, { timeout: 1000 });
  } else {
    setTimeout(() => {
      renderBundlePanel();
      renderRecsPanel();
    }, 200);
  }

  const wrap = byId('cartLines');
  if(!cart.length){
    wrap.innerHTML = `<div class="empty">Your cart is empty.</div>`;
    byId('subTotal').textContent = money(0);
    renderSigninState();
    return;
  }

  const html = cart.map(line=>{
    if(line.type==='bundle'){
      const b = (catalog.bundles||[]).find(x=> String(x.bundle_id)===String(line.bundle_id));
      const price = parseMoneyCell(b?.bundle_price);
      const total = price * Number(line.qty||1);
      return `
      <div class="line" data-type="bundle" data-id="${line.bundle_id}">
        <div>
          <div class="ln-title">${escapeHtml(b?.name||'Bundle')}</div>
          <div class="ln-sub">${money(price)} √ó ${Number(line.qty||1)}</div>
          <button class="remove" data-remove>Remove</button>
        </div>
        <div style="text-align:right">
          <div class="ln-total">${money(total)}</div>
        </div>
      </div>`;
    } else {
      const svc = (catalog.services||[]).find(s=> String(s.service_id)===String(line.service_id));
      const tier = pickTier(line.service_id, line.qty, line.option_id||null);
      const unit = tier ? Number(tier.unit||0) : 0;
      const total = unit * Number(line.qty||0);
      const title = escapeHtml(svc?.name||line.service_id);
      const optLabel = (catalog.serviceOptions||[]).find(o=> String(o.service_id)===String(line.service_id) && String(o.option_id||'')===String(line.option_id||''))?.label || '';
      const minQty = Number(svc?.min_qty||1);
      const minQtyBadge = minQty > 1 ? `<span style="font-size:11px;color:#856404;font-weight:600;"> (min ${minQty})</span>` : '';
      const subTxt = `${optLabel ? escapeHtml(optLabel)+' ‚Ä¢ ' : ''}${money(unit)} √ó ${Number(line.qty||0)}${minQtyBadge}`;
      return `
      <div class="line" data-type="svc" data-id="${line.service_id}" data-opt="${escapeAttr(line.option_id||'')}">
        <div>
          <div class="ln-title">
            <button class="link-btn" data-open="${line.service_id}" data-open-opt="${escapeAttr(line.option_id||'')}" aria-label="Open ${title}">
              ${title}
            </button>
          </div>
          <div class="ln-sub">${subTxt}</div>
          <div class="ln-qty">
            <div class="stepper">
              <button data-act="dec">‚àí</button>
              <input data-role="qty" type="number" min="0" value="${Number(line.qty||0)}">
              <button data-act="inc">+</button>
            </div>
            <button class="link-btn" data-open="${line.service_id}" data-open-opt="${escapeAttr(line.option_id||'')}">Open</button>
            <button class="remove" data-remove>Remove</button>
          </div>
        </div>
        <div style="text-align:right">
          <div class="ln-total">${money(total)}</div>
        </div>
      </div>`;
    }
  }).join('');

  wrap.innerHTML = html;

  wrap.querySelectorAll('.line').forEach(el=>{
    const type = el.getAttribute('data-type');
    if(type==='bundle'){
      el.querySelector('[data-remove]').onclick = ()=>{
        const id = el.getAttribute('data-id');
        removeLine({type:'bundle', bundle_id:id});
      };
    } else {
      const sid = el.getAttribute('data-id');
      const opt = el.getAttribute('data-opt') || null;
      const inp = el.querySelector('[data-role="qty"]');
      const dec = el.querySelector('[data-act="dec"]');
      const inc = el.querySelector('[data-act="inc"]');
      const rm  = el.querySelector('[data-remove]');

      dec.onclick = ()=>{ inp.value = Math.max(0, Number(inp.value||0)-1); setQty(sid, Number(inp.value||0), opt); };
      inc.onclick = ()=>{ inp.value = Number(inp.value||0)+1; setQty(sid, Number(inp.value||0), opt); };
      inp.onchange = ()=> setQty(sid, Number(inp.value||0), opt);
      rm.onclick   = ()=> removeLine({service_id:sid, option_id:opt});
    }
  });

  wrap.querySelectorAll('[data-open]').forEach(btn=>{
    btn.onclick = ()=>{
      const sid = btn.getAttribute('data-open');
      const opt = btn.getAttribute('data-open-opt') || null;
      closeCart();
      navigateToProduct(sid, opt);
    };
  });

  byId('subTotal').textContent = money(cartSubtotal());

  updatePointsDisplay();
  renderSigninState();
}

// === BUNDLE PANEL RENDER ===
function renderBundlePanel(){
  const panel = byId('bundlePanel');
  if(!panel) return;
  const suggestions = bundlesMatchingCart();
  if(!suggestions.length){ panel.style.display='none'; panel.innerHTML=''; return; }

  panel.style.display='';
  panel.innerHTML = suggestions.map(p=>`
    <div class="bundle-card">
      <div class="b-head">
        <div class="b-name">${escapeHtml(p.name)}</div>
        <div class="b-save">Save ${money(p.savings)}</div>
      </div>
      <div class="b-list">${p.recipeList.map(escapeHtml).join(' ‚Ä¢ ')}</div>
      <div class="b-actions">
        <button class="btn azure" data-apply="${p.bundle_id}">Swap & Save</button>
      </div>
    </div>
  `).join('');

  panel.querySelectorAll('[data-apply]').forEach(btn=>{
    btn.onclick = ()=> applyBundleSwap(btn.getAttribute('data-apply'));
  });
}

// === CHECKOUT (price-id aware) ===
async function checkout(){
  if(!cart.length) return;
  
  // If user not signed in, show inline guest checkout form
  if(!user || !user.email){
    showGuestCheckoutForm();
    return;
  }

  proceedToStripeCheckout(user);
}

// Show inline form to collect email/name/phone for guest checkout
function showGuestCheckoutForm(){
  const cartDrawer = byId('cartDrawer');
  const existingForm = byId('guestCheckoutForm');
  if(existingForm) existingForm.remove();
  
  const form = document.createElement('div');
  form.id = 'guestCheckoutForm';
  form.style.cssText = 'padding:16px;border-top:1px solid #e7eaf0;background:#fafcff;position:relative;';
  
  // Calculate cart summary for sticky header
  const itemCount = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
  const subtotal = cartSubtotal();
  
  form.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div style="font-weight:800;font-size:16px;">Continue as guest</div>
      <button id="hideGuestForm" class="link-btn" style="font-size:13px;color:#6b778c;">‚Üê Back to cart</button>
    </div>
    <div style="margin-bottom:10px;padding:10px;background:#f5f9ff;border:1px solid #d7eafc;border-radius:8px;font-size:13px;color:#0a2a5a;">
      <strong>${itemCount} item${itemCount !== 1 ? 's' : ''} ‚Ä¢ $${subtotal.toFixed(2)}</strong>
    </div>
    <div style="margin-bottom:10px;font-size:13px;color:#6b778c;">We'll email your receipt. <a href="#" id="switchToSignIn" style="color:var(--azure);text-decoration:underline;">Sign in instead</a></div>
    <input type="email" id="guestEmail" class="inp" placeholder="Email address" style="margin-bottom:8px;" required>
    <input type="text" id="guestName" class="inp" placeholder="Full name" style="margin-bottom:8px;">
    <input type="tel" id="guestPhone" class="inp" placeholder="Phone (optional)" style="margin-bottom:12px;">
    <button class="btn azure" id="continueAsGuest" style="width:100%;">Continue to payment</button>
    <div id="guestMsg" class="help" style="margin-top:8px;color:#d32f2f;"></div>
  `;
  
  const cartFoot = cartDrawer.querySelector('.cart-foot');
  cartFoot.insertBefore(form, cartFoot.firstChild);
  
  // Scroll to top of cart to show form
  const cartBody = cartDrawer.querySelector('.cart-body');
  if(cartBody) cartBody.scrollTop = 0;
  
  byId('hideGuestForm').onclick = (e) => {
    e.preventDefault();
    form.remove();
    // Refresh cart display
    paintCart();
  };
  
  byId('switchToSignIn').onclick = (e) => {
    e.preventDefault();
    closeCart();
    navSet({view:'signin'});
  };
  
  byId('continueAsGuest').onclick = async () => {
    const email = byId('guestEmail').value.trim().toLowerCase();
    const name = byId('guestName').value.trim();
    const phone = byId('guestPhone').value.trim();
    const msg = byId('guestMsg');
    const btn = byId('continueAsGuest');
    
    if(!email || !email.includes('@')){
      msg.textContent = 'Please enter a valid email address.';
      return;
    }
    
    msg.textContent = '';
    
    // Show loading state
    btn.disabled = true;
    btn.textContent = 'Creating checkout session...';
    
    try {
      // Use guest info for checkout (don't save to localStorage as 'user')
      const guestUser = { email, name, phone };
      await proceedToStripeCheckout(guestUser);
    } catch(err) {
      btn.disabled = false;
      btn.textContent = 'Continue to payment';
      msg.textContent = 'Checkout failed. Please try again.';
    }
  };
}

async function proceedToStripeCheckout(customer){
  // Save snapshot for success view/fallbacks
  localStorage.setItem('h2s_checkout_snapshot', JSON.stringify({
    cart: cart.slice(),
    user: { ...customer },
    subtotal: cartSubtotal(),
    currency: 'USD',
    source: '/shop',
    created_at: new Date().toISOString()
  }));

  // Build explicit Stripe line items with price IDs
  const svcMap = indexBy((catalog.services||[]), 'service_id');
  const lines = [];
  const missing = [];

  for(const l of cart){
    if(l.type === 'bundle'){
      lines.push({ type:'bundle', bundle_id:l.bundle_id, qty:Number(l.qty||1) });
      continue;
    }
    const qty = Number(l.qty||0);
    if(qty <= 0) continue;

    const tier = pickTier(l.service_id, qty, l.option_id||null);
    const price_id = tier?.price_id && String(tier.price_id).trim() ? String(tier.price_id).trim() : '';

    if(!price_id){
      const name = (svcMap[l.service_id]?.name || l.service_id);
      const optLabel = (catalog.serviceOptions||[]).find(o=> String(o.service_id)===String(l.service_id) && String(o.option_id||'')===String(l.option_id||''))?.label || '';
      missing.push(`${name}${optLabel ? ' ‚Äì '+optLabel : ''} (qty ${qty})`);
    }else{
      lines.push({ price_id, qty, service_id:l.service_id, option_id:l.option_id||null });
    }
  }

  if(missing.length){
    showError(
      "Missing Stripe Price IDs for: " +
      missing.join(", ") +
      ". Please contact support."
    );
    return;
  }

  const payload = {
    __action: 'create_session',
    customer: { name:customer.name||'', email:customer.email||'', phone:customer.phone||'' },
    // Back-compat payload:
    cart: cart.map(l => l.type==='bundle'
      ? ({type:'bundle', bundle_id:l.bundle_id, qty:l.qty})
      : ({service_id:l.service_id, qty:l.qty, option_id: l.option_id||null})),
    // New explicit lines:
    lines,
    source: '/shop',
    // Referral code if present
    referral_code: referralCode || null,
    // Points redemption
    applied_points: appliedPoints || 0
  };

  // Track checkout initiation
  h2sTrack('InitiateCheckout', {
    cart_total: cartSubtotal(),
    currency: 'USD',
    num_items: cart.reduce((n,l)=> n + Number(l.qty||0), 0)
  });

  hideError(); // Clear any previous errors
  showLoader();
  try{
    console.log('üõí Creating Stripe checkout session...', { cart, customer: customer.email });
    const resp = await fetch(API, { method:'POST', body: JSON.stringify(payload) });
    const txt  = await resp.text();
    
    if(!resp.ok){ 
      console.error('‚ùå Checkout API error:', resp.status, txt);
      // Try to parse error JSON
      let errorMsg = 'Checkout failed. Please try again.';
      try{
        const errData = JSON.parse(txt);
        errorMsg = errData?.error?.message || errData?.error || errData?.message || txt || errorMsg;
      }catch(_){
        errorMsg = txt || errorMsg;
      }
      showError(errorMsg);
      return;
    }
    
    let data = {}; 
    try{ data = JSON.parse(txt); }catch(_){}
    
    const url = data?.pay?.session_url;
    if(!url){
      console.error('‚ùå No checkout URL returned:', data);
      const msg = data?.error?.message || data?.error || data?.message || 'Could not create checkout session. Please contact support.';
      showError(msg);
      return;
    }
    
    console.log('‚úì Checkout session created, redirecting to Stripe...', { session_id: data?.pay?.id || 'unknown' });
    window.location = url;
  }catch(err){
    console.error('‚ùå Network error during checkout:', err);
    showError('Network error. Please check your connection and try again.');
  }finally{
    hideLoader();
  }
}

// === SHOP SUCCESS VIEW (embed calendar + hidden fields autofill) ===
async function renderShopSuccess(){
  const params = new URL(location.href).searchParams;
  const sessionId = params.get('session_id') || params.get('stripe_session_id') || '';

  let order = {
    order_id:           params.get('order_id') || '',
    stripe_session_id:  sessionId,
    order_created_at:   params.get('order_created_at') || new Date().toISOString(),
    order_source:       params.get('order_source') || '/shop',
    order_total:        params.get('order_total') || '',
    order_subtotal:     params.get('order_subtotal') || '',
    order_tax:          params.get('order_tax') || '',
    order_fees:         params.get('order_fees') || '',
    order_currency:     params.get('order_currency') || 'USD',
    order_discount_code:   params.get('order_discount_code') || '',
    order_discount_amount: params.get('order_discount_amount') || '',
    order_item_count:   params.get('order_item_count') || '',
    order_summary:      params.get('order_summary') || '',
    order_lines_json:   params.get('order_lines_json') || '',
    bundle_applied:     params.get('bundle_applied') || '',
    membership_plan:    params.get('membership_plan') || '',
    utm_source:   params.get('utm_source') || '',
    utm_medium:   params.get('utm_medium') || '',
    utm_campaign: params.get('utm_campaign') || '',
    utm_term:     params.get('utm_term') || '',
    utm_content:  params.get('utm_content') || ''
  };

  // PRIORITY 1: Mark session as success_redirect in backend
  if(sessionId){
    try{
      await fetch(API, {
        method: 'POST',
        body: JSON.stringify({
          __action: 'mark_session',
          session_id: sessionId,
          status: 'success_redirect',
          note: 'User returned from Stripe at ' + new Date().toISOString()
        })
      });
      console.log('‚úì Marked session as success_redirect:', sessionId);
    }catch(err){
      console.error('Failed to mark session:', err);
    }
  }

  // PRIORITY 2: Fetch authoritative order data from backend
  if(sessionId){
    try{
      const res = await fetch(`${API}?action=orderpack&session_id=${sessionId}`);
      const data = await res.json();
      if(data.ok && data.summary){
        console.log('‚úì Fetched order pack from backend:', data.summary.order_id);
        order.order_id = data.summary.order_id || sessionId;
        order.order_total = typeof data.summary.total === 'number' ? String(data.summary.total.toFixed(2)) : (data.summary.total || '');
        order.order_subtotal = typeof data.summary.subtotal === 'number' ? String(data.summary.subtotal.toFixed(2)) : (data.summary.subtotal || '');
        order.order_currency = data.summary.currency || 'USD';
        order.order_item_count = String(data.lines?.length || 0);
        order.order_created_at = data.summary.created_at || order.order_created_at;
        
        // Build summary from line items
        const svcMap = indexBy((catalog.services||[]), 'service_id');
        const parts = [];
        (data.lines||[]).forEach(l => {
          if(String(l.line_type||'') === 'bundle'){
            const b = (catalog.bundles||[]).find(x=> String(x.bundle_id)===String(l.bundle_id));
            parts.push(`${Number(l.qty||1)}√ó ${b?.name||'Bundle'}`);
          }else{
            const s = svcMap[l.service_id];
            const opt = (catalog.serviceOptions||[]).find(o=> String(o.service_id)===String(l.service_id) && String(o.option_id||'')===String(l.option_id||''))?.label || '';
            parts.push(`${Number(l.qty||0)}√ó ${s?.name||l.service_id}${opt ? ' ('+opt+')' : ''}`);
          }
        });
        order.order_summary = parts.join(' | ');
      }else{
        console.warn('Backend orderpack returned no data, falling back to localStorage');
      }
    }catch(err){
      console.error('Failed to fetch order pack:', err);
    }
  }

  // Fallback to snapshot if backend fetch failed
  if(!order.order_id || !order.order_summary){
    try{
      const snap = JSON.parse(localStorage.getItem('h2s_checkout_snapshot') || '{}');
      if(Array.isArray(snap.cart)){
        console.log('‚ö† Using localStorage fallback for order data');
        if(!order.order_item_count) order.order_item_count = String(snap.cart.reduce((n,l)=> n + Number(l.qty||0), 0));
        if(!order.order_subtotal) order.order_subtotal  = typeof snap.subtotal === 'number' ? String(snap.subtotal.toFixed(2)) : '';
        if(!order.order_currency) order.order_currency  = snap.currency || 'USD';
        
        if(!order.order_summary){
          const svcMap = indexBy((catalog.services||[]), 'service_id');
          const parts = [];
          snap.cart.forEach(l=>{
            if(l.type==='bundle'){
              const b = (catalog.bundles||[]).find(x=> String(x.bundle_id)===String(l.bundle_id));
              parts.push(`${Number(l.qty||1)}√ó ${b?.name||'Bundle'}`);
            }else{
              const s = svcMap[l.service_id];
              const opt = (catalog.serviceOptions||[]).find(o=> String(o.service_id)===String(l.service_id) && String(o.option_id||'')===String(l.option_id||''))?.label || '';
              parts.push(`${Number(l.qty||0)}√ó ${s?.name||l.service_id}${opt ? ' ('+opt+')' : ''}`);
            }
          });
          order.order_summary = parts.join(' | ');
        }
        
        if(!order.order_lines_json) order.order_lines_json = encodeURIComponent(JSON.stringify(snap.cart||[]));
        if(!order.order_created_at) order.order_created_at = snap.created_at || new Date().toISOString();
        if(!order.order_source) order.order_source = snap.source || '/shop';
        
        // If we never got an explicit order_id, at least set to session id
        if(!order.order_id){
          order.order_id = sessionId || '';
        }
      }
    }catch(err){
      console.error('Failed to parse localStorage snapshot:', err);
    }
  }

  // Prefill contact from local user or params
  const name  = (user?.name||params.get('name')||'').trim();
  const [first_name, ...rest] = name.split(' ');
  const last_name = rest.join(' ');
  const email = (user?.email||params.get('email')||'').trim();
  const phone = (user?.phone||params.get('phone')||'').trim();

  // Hidden fields for calendar form
  const q = new URLSearchParams();
  if(first_name) q.set('first_name', first_name);
  if(last_name)  q.set('last_name', last_name);
  if(email)      q.set('email', email);
  if(phone)      q.set('phone', phone);

  // Always pass a stable order id to the calendar
  const stableOrderId = order.order_id || order.stripe_session_id || '';
  if (stableOrderId) q.set('order_id', stableOrderId);

  [
    'stripe_session_id','order_created_at','order_source',
    'order_total','order_subtotal','order_tax','order_fees','order_currency',
    'order_discount_code','order_discount_amount',
    'order_item_count','order_summary','order_lines_json',
    'bundle_applied','membership_plan',
    'utm_source','utm_medium','utm_campaign','utm_term','utm_content'
  ].forEach(k=>{
    if(order[k]!==undefined && order[k]!==null && String(order[k]).length){
      q.set(k, String(order[k]));
    }
  });

  // If your calendar respects redirect_url from query, this will be used; otherwise set the Thank You URL in GHL to the same.
  q.set('redirect_url', 'https://home2smart.com/shop?view=apptreturn');

  const calSrc = CAL_FORM_URL + (CAL_FORM_URL.includes('?') ? '&' : '?') + q.toString();
  console.log('üìÖ Calendar URL built:', calSrc);

  // Define display variables BEFORE using them
  const prettyTotal = order.order_total ? money(Number(order.order_total)) : money(cartSubtotal());
  const displayOrderId = order.order_id || order.stripe_session_id || '‚Äî';

  // Clear cart & snapshot
  cart = [];
  saveCart();
  localStorage.removeItem('h2s_checkout_snapshot');

  // Track successful purchase
  h2sTrack('Purchase', {
    order_id: displayOrderId,
    value: order.order_total || order.order_subtotal || '0',
    currency: order.order_currency || 'USD',
    num_items: order.order_item_count || '0'
  });

  byId('outlet').innerHTML = `
    <section class="form">
      <h2 style="margin:0 0 10px 0;font-weight:900">Thanks! Your order is confirmed.</h2>
      <div class="pd-box details-grid">
        <div class="row"><div class="k">Order ID</div><div class="v">${escapeHtml(String(displayOrderId))}</div></div>
        <div class="row"><div class="k">Total</div><div class="v">${escapeHtml(prettyTotal + (order.order_currency ? ` ${order.order_currency}` : ''))}</div></div>
        <div class="row"><div class="k">Items</div><div class="v">${escapeHtml(order.order_summary || (order.order_item_count ? `${order.order_item_count} items` : '‚Äî'))}</div></div>
        ${order.order_discount_code ? `<div class="row"><div class="k">Promo code</div><div class="v">${escapeHtml(order.order_discount_code)}</div></div>`:''}
      </div>

      <p class="help">Next step: pick a date & time for your service (embedded below).</p>
      <div class="cal-embed">
        <iframe src="${calSrc}" title="Scheduler"></iframe>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn ghost" id="backToShop">Back to shop</button>
      </div>
      <div class="help" style="margin-top:8px">If the calendar doesn‚Äôt load, please refresh this page.</div>
    </section>
  `;

  byId('backToShop').onclick = ()=> navSet({view:null, p:null, m:null});
}

// === AI THOUGHT SPARKS (Post-Purchase Recommendations) ===
async function loadAIThoughtSparks(){
  if(!user || !user.email) return;
  
  try{
    const res = await fetch(`${API}?action=ai_sales&email=${encodeURIComponent(user.email)}&mode=recommendations`);
    const data = await res.json();
    
    if(!data.success || !data.ai_analysis || !data.ai_analysis.recommendations) return;
    
    const recs = data.ai_analysis.recommendations.slice(0, 3); // Top 3 only
    if(recs.length === 0) return;
    
    const html = recs.map(rec => `
      <div style="padding:10px;background:white;border-radius:6px;font-size:13px;color:#4a5568">
        <div style="font-weight:600;color:#2d3748;margin-bottom:4px">${escapeHtml(rec.service)}</div>
        <div style="font-style:italic;color:#718096">"${escapeHtml(rec.thought_spark || rec.reason)}"</div>
      </div>
    `).join('');
    
    const container = byId('aiSuggestions');
    const panel = byId('aiThoughtSparks');
    if(container && panel){
      container.innerHTML = html;
      panel.style.display = 'block';
    }
  }catch(err){
    console.error('Failed to load AI suggestions:', err);
  }
}

// === Calendar Redirect Capture
// Supports:
//   ‚Ä¢ /shop?view=calreturn&order_id=...&date=YYYY-MM-DD&time=HH:mm
//   ‚Ä¢ /shop?view=apptreturn&order_id=...&start=2025-10-22T14:30:00-05:00&end=...&tz=America/Chicago
async function handleCalReturn(){
  const order_id = getParam('order_id') || getParam('stripe_session_id') || getParam('session_id') || '';

  // New GHL format
  let startIso = getParam('start') || '';
  let endIso   = getParam('end')   || '';
  let tz       = getParam('tz')    || '';

  // Legacy fallback
  const date = getParam('date') || '';
  const time = getParam('time') || '';
  if(!startIso && date && time){
    startIso = new Date(`${date}T${time}:00`).toISOString();
  }

  byId('outlet').innerHTML = `
    <section class="form">
      <h2 style="margin:0 0 10px 0;font-weight:900">Saving your appointment‚Ä¶</h2>
      <div class="help">Just a moment.</div>
    </section>
  `;

  try{
    // PRIORITY 4: Validate required data BEFORE calling backend
    if(!user || !user.email){
      throw new Error('You must be signed in to save an appointment. Please sign in and try again.');
    }
    if(!startIso){
      throw new Error('Missing appointment time. Please select a time from the calendar and try again.');
    }
    
    // Order ID is optional - backend can match by email and recent timestamp if needed
    console.log('üìÖ Saving appointment:', { order_id: order_id || '(auto-match)', startIso, email: user.email });
    
    const res = await fetch(API, {
      method:'POST',
      body: JSON.stringify({
        __action: 'record_install_slot',
        email: user.email,
        order_id: order_id || '', // Empty string if not provided - backend will handle
        install_at: startIso || '',
        install_end_at: endIso || '',
        timezone: tz || '',
        date, time
      })
    });
    
    const data = await res.json();
    if(!data.ok){
      throw new Error(data.error || 'Failed to save appointment');
    }
    
    console.log('‚úì Appointment saved successfully:', data.saved ? 'Yes' : 'Unknown');
  }catch(err){
    // Show error instead of silently failing
    console.error('‚ùå Appointment save failed:', err);
    byId('outlet').innerHTML = `
      <section class="form">
        <h2 style="margin:0 0 10px 0;font-weight:900;color:#c00">Could not save appointment</h2>
        <div class="help" style="color:#d32f2f;margin-bottom:16px">${escapeHtml(err.message)}</div>
        ${order_id ? `<div class="help" style="margin-bottom:16px">Order ID: <strong>${escapeHtml(order_id)}</strong></div>` : ''}
        <div class="help" style="margin-bottom:20px">Please contact support or try again from your account page.</div>
        <button class="btn azure" onclick="navSet({view:'account'})">Go to My Account</button>
      </section>
    `;
    return; // Don't navigate away on error
  }

  // Go to account to show "Previous orders" with the service date
  navSet({view:'account'});
}

// === UI STATE HELPERS ===
let pointsFetchInProgress = false; // Prevent multiple simultaneous fetches

function renderSigninState(){
  const btn = byId('accountBtn');
  const rewardsBtn = byId('rewardsBtn'); // May not exist - button was removed
  const pointsBadge = byId('pointsBadge'); // May not exist
  
  if (btn){
    if (user && user.email) {
      // Fetch points if logged in via referral_ensure API
      // Only fetch if points is undefined (not 0, not null) AND we're not already fetching
      console.log('[Points] Current user.points value:', user.points, 'Type:', typeof user.points);
      console.log('[Points] Fetch in progress?', pointsFetchInProgress);
      
      if(user.points === undefined && !pointsFetchInProgress){
        pointsFetchInProgress = true;
        console.log('[Points] Fetching points for:', user.email);
        
        fetch(`${API}?action=referral_ensure&email=${encodeURIComponent(user.email)}`)
          .then(r => {
            console.log('[Points] Response status:', r.status);
            return r.json();
          })
          .then(data => {
            pointsFetchInProgress = false;
            console.log('[Points] API response:', data);
            console.log('[Points] data.ok:', data.ok);
            console.log('[Points] data.points_available:', data.points_available);
            
            if(data.ok){
              // Handle points_available (can be 0)
              user.points = data.points_available || 0;
              console.log('[Points] User points set to:', user.points);
              console.log('[Points] Saving user to localStorage...');
              saveUser(true); // Save to localStorage, skip re-render to avoid loop
              console.log('[Points] User saved successfully');
              
              // Only show badge if user has points
              if(user.points > 0){
                const dollarValue = (user.points / 10).toFixed(2);
                btn.innerHTML = `Account <span style="display:inline-block;margin-left:0.5rem;padding:0.25rem 0.5rem;background:linear-gradient(135deg,#0066FF,#00D9FF);border-radius:6px;font-size:0.75rem;font-weight:800;cursor:pointer;" title="$${dollarValue} in rewards available">${user.points}pts</span>`;
              } else {
                btn.textContent = 'Account';
              }
            } else {
              // API returned ok:false, set points to 0 to prevent infinite retries
              console.warn('[Points] API returned ok:false:', data.error || 'Unknown error');
              user.points = 0;
              btn.textContent = 'Account';
              saveUser(true); // Save to localStorage, skip re-render to avoid loop
            }
          })
          .catch(err => {
            pointsFetchInProgress = false;
            console.error('[Points] API call failed:', err);
            // On error, set points to 0 to prevent infinite retries
            user.points = 0;
            btn.textContent = 'Account';
            saveUser(true); // Save to localStorage, skip re-render to avoid loop
          });
      } else if(user.points !== undefined) {
        // Points already loaded - just update UI
        if(user.points > 0){
          const dollarValue = (user.points / 10).toFixed(2);
          btn.innerHTML = `Account <span style="display:inline-block;margin-left:0.5rem;padding:0.25rem 0.5rem;background:linear-gradient(135deg,#0066FF,#00D9FF);border-radius:6px;font-size:0.75rem;font-weight:800;cursor:pointer;" title="$${dollarValue} in rewards available">${user.points}pts</span>`;
        } else {
          btn.textContent = 'Account';
        }
      } else {
        // Fetch in progress, just show Account
        btn.textContent = 'Account';
      }
    } else {
      btn.textContent = 'Sign in';
      // Hide rewards button when not logged in
      if(rewardsBtn) rewardsBtn.style.display = 'none';
      if(pointsBadge) pointsBadge.style.display = 'none';
    }
  }
  const sb = byId('signinBanner');
  if (sb){
    const show = (!user || !user.email) && Array.isArray(cart) && cart.length > 0;
    sb.style.display = show ? '' : 'none';
  }
  
  // Show referral banner if user is logged in
  renderMyReferralBanner();
}

// Show user their own referral code banner
async function renderMyReferralBanner(){
  const banner = byId('myReferralBanner');
  if(!banner) return;
  
  // Only show if user is logged in
  if(!user || !user.email){
    banner.style.display = 'none';
    return;
  }
  
  // Fetch user's referral code from backend
  try {
    console.log('[Referral Banner] Fetching referral data for:', user.email);
    const resp = await fetch(`${API}?action=referral_ensure&email=${encodeURIComponent(user.email)}`);
    console.log('[Referral Banner] Response status:', resp.status);
    
    if(!resp.ok){
      console.warn('[Referral Banner] Response not OK');
      banner.style.display = 'none';
      return;
    }
    
    const data = await resp.json();
    console.log('[Referral Banner] API response:', data);
    if(!data.refCode){
      banner.style.display = 'none';
      return;
    }
    
    const code = data.refCode;
    const tier = data.tier || 1;
    const discount = (tier === 2 || tier === 'tier2') ? '20%' : '10%';
    
    // Update banner content
    byId('myReferralCode').textContent = code;
    byId('myReferralDiscount').textContent = discount + ' off';
    
    // Wire copy button
    const copyBtn = byId('copyReferralCode');
    const copyIcon = byId('copyIcon');
    if(copyBtn){
      copyBtn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(code);
          copyIcon.textContent = '‚úì';
          setTimeout(() => { copyIcon.textContent = 'üìã'; }, 2000);
        } catch(err) {
          // Fallback for older browsers
          const input = document.createElement('input');
          input.value = code;
          document.body.appendChild(input);
          input.select();
          document.execCommand('copy');
          document.body.removeChild(input);
          copyIcon.textContent = '‚úì';
          setTimeout(() => { copyIcon.textContent = 'üìã'; }, 2000);
        }
      };
    }
    
    // Wire share button
    const shareBtn = byId('shareReferralBtn');
    if(shareBtn){
      shareBtn.onclick = () => {
        const shareUrl = `${window.location.origin}${window.location.pathname}?c=${code}`;
        const shareText = `Get ${discount} off at Home2Smart! Use my referral code: ${code}`;
        
        // Use Web Share API if available
        if(navigator.share){
          navigator.share({
            title: 'Home2Smart Referral',
            text: shareText,
            url: shareUrl
          }).catch(() => {});
        } else {
          // Fallback: copy link to clipboard
          navigator.clipboard.writeText(shareUrl).then(() => {
            alert('Referral link copied! Share it with friends.');
          }).catch(() => {
            prompt('Copy this link to share:', shareUrl);
          });
        }
      };
    }
    
    banner.style.display = 'flex';
  } catch(err) {
    console.error('Failed to load referral banner:', err);
    banner.style.display = 'none';
  }
}

// === ERROR DISPLAY HELPERS ===
function showError(message){
  const container = byId('checkoutError');
  const msgEl = byId('checkoutErrorMsg');
  if(!container || !msgEl) return;
  
  msgEl.textContent = String(message || 'An error occurred. Please try again.');
  container.hidden = false;
  
  // Scroll error into view
  container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  
  // Wire dismiss button
  const dismissBtn = byId('dismissError');
  if(dismissBtn){
    dismissBtn.onclick = hideError;
  }
}

function hideError(){
  const container = byId('checkoutError');
  if(container) container.hidden = true;
}

// === UTILS ===
function byId(id){ return document.getElementById(id); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
function showMsg(id, msg, type){ 
  const el = byId(id); 
  if(el){ 
    el.textContent = String(msg); 
    if(type){
      el.className = 'form-message ' + type;
    }
  }
}
function splitUrls(s){ return String(s||'').split(',').map(u=>u.trim()).filter(Boolean); }
function mdHtml(md){
  let t = String(md||'');
  t = t.replace(/^### (.*)$/gm,'<h3>$1</h3>');
  t = t.replace(/^## (.*)$/gm,'<h2>$1</h2>');
  t = t.replace(/^\s*[-*]\s+(.*)$/gm,'<li>$1</li>');
  t = t.replace(/(<li>.*<\/li>)(?!\s*<\/ul>)/gs,'<ul>$1</ul>');
  t = t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  t = t.replace(/\*(.+?)\*/g,'<em>$1</em>');
  t = t.replace(/\n{2,}/g,'</p><p>');
  return `<p>${t}</p>`;
}
function indexBy(arr, key){
  const o = {}; (arr||[]).forEach(it => { if (it && it[key] != null) o[String(it[key])] = it; }); return o;
}

})();</script>
