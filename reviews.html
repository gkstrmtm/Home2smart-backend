<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Customer Reviews ‚Ä¢ Home2Smart ‚Ä¢ Rated 4.9/5</title>
<meta name="description" content="See why hundreds of customers trust Home2Smart for TV mounting, smart home installations, and security systems across North Carolina and South Carolina.">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --cobalt:#0a2a5a; --azure:#1493ff; --white:#fff; 
  --panel:#0e2f64; --panel2:#0b2654; --accent:#ffd24d;
  --gradient-bg:linear-gradient(135deg,#0a2a5a 0%,#08224a 50%,#0a2855 100%);
  --gradient-card:linear-gradient(135deg,#0e3168 0%,#0b2856 100%);
  --ease:cubic-bezier(.22,.8,.32,1);
  --shadow-sm:0 2px 8px rgba(0,0,0,.18),0 6px 20px rgba(0,0,0,.12);
  --shadow-lg:0 10px 30px rgba(0,0,0,.25),0 20px 60px rgba(0,0,0,.2);
  --glow:0 0 24px rgba(20,139,255,.4),0 0 48px rgba(20,139,255,.2);
}

*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
html,body{min-height:100dvh}
body{
  font-family:Archivo,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:var(--white);
  background:var(--cobalt);
  background:var(--gradient-bg) fixed;
  display:flex;flex-direction:column;
  line-height:1.6;
}

/* ===== HEADER ===== */
.header{
  position:sticky;top:0;z-index:100;
  background:linear-gradient(180deg,rgba(11,42,89,.96) 0%,rgba(10,40,85,.94) 100%);
  backdrop-filter:blur(12px);
  border-bottom:1px solid rgba(255,255,255,.08);
  box-shadow:var(--shadow-sm);
}
.header-inner{
  max-width:1400px;margin:0 auto;
  display:flex;align-items:center;justify-content:space-between;
  padding:14px clamp(16px,4vw,32px);gap:14px;
}
.header img{height:56px;width:auto;display:block;transition:transform .2s var(--ease)}
.header img:hover{transform:scale(1.05)}
.header .btn{
  background:#1493ff !important;border:2px solid #1493ff !important;color:#fff !important;
  font-weight:700;border-radius:12px;padding:.85rem 1.2rem;
  text-decoration:none;cursor:pointer;
  transition:all .25s var(--ease);
  box-shadow:var(--shadow-sm);
  white-space:nowrap;
}
.header .btn:hover{
  transform:translateY(-3px);
  box-shadow:var(--glow),var(--shadow-lg);
}

/* ===== HERO ===== */
.hero{
  text-align:center;
  padding:clamp(48px,8vw,96px) clamp(18px,5vw,40px) clamp(32px,6vw,64px);
  background:linear-gradient(180deg,transparent 0%,rgba(14,47,100,.18) 100%);
  border-bottom:1px solid rgba(255,255,255,.06);
}
.hero-badge{
  display:inline-flex;align-items:center;gap:10px;
  padding:10px 18px;border-radius:999px;
  background:rgba(20,139,255,.14);
  border:1px solid rgba(20,139,255,.3);
  font-weight:700;font-size:clamp(14px,1.2vw,16px);
  margin-bottom:18px;
  animation:fadeSlideDown .6s var(--ease) backwards;
}
.hero-badge .star{color:var(--accent);font-size:1.3em;filter:drop-shadow(0 2px 4px rgba(255,210,77,.4))}
.h1{
  font-weight:900;font-size:clamp(36px,7vw,68px);
  line-height:1.1;margin:0 0 18px;
  background:linear-gradient(135deg,#fff 0%,#c8e0ff 100%);
  -webkit-background-clip:text;background-clip:text;
  -webkit-text-fill-color:transparent;
  animation:fadeSlideDown .7s var(--ease) .15s backwards;
}
.hero-subtitle{
  font-size:clamp(16px,1.8vw,20px);
  color:rgba(255,255,255,.85);
  max-width:620px;margin:0 auto 32px;
  animation:fadeSlideDown .8s var(--ease) .3s backwards;
}
.hero-stats{
  display:flex;justify-content:center;gap:clamp(18px,4vw,40px);
  flex-wrap:wrap;margin-top:32px;
}
.stat{
  text-align:center;
  animation:fadeSlideDown .9s var(--ease) .45s backwards;
}
.stat-num{
  font-weight:900;font-size:clamp(32px,4.5vw,48px);
  color:var(--accent);
  text-shadow:0 2px 12px rgba(255,210,77,.3);
}
.stat-label{font-size:clamp(13px,1.2vw,15px);opacity:.9}

@keyframes fadeSlideDown{
  from{opacity:0;transform:translateY(-18px)}
  to{opacity:1;transform:translateY(0)}
}

/* ===== MAIN CONTENT ===== */
.main{flex:1;padding:clamp(24px,5vw,56px) 0}
.container{
  max-width:1200px;margin:0 auto;
  padding:0 clamp(16px,4vw,32px);
}

/* ===== PHOTO GALLERY ===== */
.gallery-section{
  background:var(--gradient-card);
  border:1px solid rgba(255,255,255,.08);
  border-radius:20px;
  box-shadow:var(--shadow-lg);
  padding:clamp(20px,3.5vw,32px);
  margin-bottom:clamp(28px,5vw,48px);
  overflow:hidden;
}
.gallery-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:18px;flex-wrap:wrap;gap:12px;
}
.gallery-title{
  font-weight:800;font-size:clamp(20px,2.2vw,26px);
  display:flex;align-items:center;gap:10px;
}
.gallery-title::before{content:'üì∏';font-size:1.3em}
.avg-badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 14px;border-radius:999px;
  background:rgba(255,210,77,.12);
  border:1px solid rgba(255,210,77,.28);
  font-weight:800;font-size:clamp(16px,1.5vw,20px);
  color:var(--accent);
}
.gallery-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:12px;
  max-height:480px;overflow:auto;
  padding:8px 4px;
  scrollbar-width:thin;
  scrollbar-color:rgba(255,255,255,.2) transparent;
}
.gallery-grid::-webkit-scrollbar{width:8px;height:8px}
.gallery-grid::-webkit-scrollbar-track{background:transparent}
.gallery-grid::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:4px}
.gallery-grid::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.3)}
.gallery-img{
  width:100%;aspect-ratio:1;
  border-radius:14px;object-fit:cover;
  border:1px solid rgba(255,255,255,.15);
  cursor:pointer;
  transition:all .3s var(--ease);
  box-shadow:0 4px 12px rgba(0,0,0,.2);
}
.gallery-img:hover{
  transform:scale(1.05) translateY(-4px);
  box-shadow:0 8px 24px rgba(20,139,255,.3),0 16px 48px rgba(0,0,0,.3);
  border-color:#1493ff !important;
}

/* ===== REVIEWS LIST ===== */
.reviews-section{
  background:var(--gradient-card);
  border:1px solid rgba(255,255,255,.08);
  border-radius:20px;
  box-shadow:var(--shadow-lg);
  padding:clamp(20px,3.5vw,32px);
}
.section-title{
  font-weight:800;font-size:clamp(22px,2.5vw,28px);
  margin-bottom:20px;
  display:flex;align-items:center;gap:10px;
}
.section-title::before{content:'‚≠ê';font-size:1.2em}
.reviews-grid{
  display:grid;gap:18px;
}
.review-card{
  background:linear-gradient(135deg,rgba(14,47,100,.5) 0%,rgba(11,38,84,.4) 100%);
  border:1px solid rgba(255,255,255,.1);
  border-radius:16px;
  padding:clamp(18px,2.5vw,24px);
  box-shadow:var(--shadow-sm);
  transition:all .35s var(--ease);
  opacity:0;
  animation:fadeIn .6s var(--ease) forwards;
}
.review-card:hover{
  transform:translateY(-6px);
  box-shadow:0 12px 32px rgba(20,139,255,.2),0 24px 64px rgba(0,0,0,.25);
  border-color:rgba(20,139,255,.3);
}
@keyframes fadeIn{
  to{opacity:1}
}
.review-header{
  display:flex;justify-content:space-between;align-items:start;
  margin-bottom:12px;gap:12px;flex-wrap:wrap;
}
.review-stars{
  color:var(--accent);
  font-size:clamp(18px,1.8vw,22px);
  letter-spacing:2px;
  filter:drop-shadow(0 2px 6px rgba(255,210,77,.3));
}
.review-meta{
  text-align:right;
}
.review-name{
  font-weight:700;font-size:clamp(15px,1.4vw,17px);
  margin-bottom:4px;
}
.review-date{
  font-size:clamp(13px,1.2vw,14px);
  opacity:.75;
}
.review-text{
  line-height:1.65;
  margin-bottom:12px;
  font-size:clamp(15px,1.3vw,16px);
  color:rgba(255,255,255,.95);
}
.review-services{
  display:flex;flex-wrap:wrap;gap:6px;
  margin-top:10px;
}
.service-tag{
  padding:5px 10px;border-radius:6px;
  background:rgba(20,139,255,.15);
  border:1px solid rgba(20,139,255,.25);
  font-size:clamp(12px,1.1vw,13px);
  font-weight:600;
  color:rgba(255,255,255,.9);
}
.review-photos{
  display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;
}
.review-photo{
  width:100px;height:100px;
  border-radius:12px;object-fit:cover;
  border:1px solid rgba(255,255,255,.18);
  cursor:pointer;
  transition:all .25s var(--ease);
}
.review-photo:hover{
  transform:scale(1.08);
  box-shadow:0 6px 18px rgba(20,139,255,.25);
  border-color:#1493ff !important;
}

/* ===== LOAD MORE ===== */
.load-more-wrap{
  display:flex;justify-content:center;
  margin-top:28px;
}
.btn-load{
  appearance:none;
  background:transparent;
  border:2px solid rgba(255,255,255,.3);
  color:rgba(255,255,255,.9);
  font-weight:700;border-radius:12px;
  padding:1rem 1.5rem;cursor:pointer;
  transition:all .3s var(--ease);
  font-size:clamp(14px,1.3vw,16px);
}
.btn-load:hover{
  background:rgba(20,139,255,.15);
  border-color:#1493ff !important;
  transform:translateY(-3px);
  box-shadow:var(--glow);
}

/* ===== EMPTY STATE ===== */
.empty{
  text-align:center;padding:3rem 1.5rem;
  opacity:.7;font-size:clamp(15px,1.4vw,17px);
}

/* ===== MODAL ===== */
.modal{
  position:fixed;inset:0;z-index:9999;
  display:none;place-items:center;
  background:rgba(10,42,90,.75);
  backdrop-filter:blur(8px);
  padding:16px;overflow:auto;
  overscroll-behavior:contain;
}
.modal[aria-hidden="false"]{display:grid}
.sheet{
  width:min(860px,96vw);
  background:var(--gradient-card);
  border:1px solid rgba(255,255,255,.12);
  border-radius:22px;
  box-shadow:var(--shadow-lg);
  padding:clamp(20px,3.5vw,32px);
  max-height:94dvh;overflow:auto;
  animation:modalSlideUp .4s var(--ease) backwards;
}
@keyframes modalSlideUp{
  from{opacity:0;transform:translateY(40px) scale(.95)}
  to{opacity:1;transform:translateY(0) scale(1)}
}
.step-nav{
  display:flex;gap:10px;align-items:center;
  margin-bottom:22px;flex-wrap:wrap;
}
.step-pill{
  padding:10px 14px;border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.15);
  font-weight:800;font-size:14px;
  opacity:.6;
  transition:all .3s var(--ease);
}
.step-pill.active{
  background:#1493ff !important;
  border-color:#1493ff !important;
  opacity:1;
  box-shadow:var(--glow);
}
.step-content{display:none}
.step-content[aria-hidden="false"]{display:block}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:640px){.form-grid{grid-template-columns:1fr}}
.form-group{margin-bottom:16px}
.label{
  display:block;font-weight:700;font-size:14px;
  margin-bottom:8px;
}
.input,.textarea{
  width:100%;
  border:1px solid rgba(255,255,255,.2);
  background:rgba(14,42,90,.5);
  color:rgba(255,255,255,.95);
  border-radius:12px;
  padding:14px 16px;
  font-size:16px;
  font-family:inherit;
  transition:all .25s var(--ease);
}
.input:focus,.textarea:focus{
  outline:none;
  border-color:#1493ff !important;
  box-shadow:0 0 0 3px rgba(20,139,255,.15);
}
.textarea{min-height:140px;resize:vertical}
.checkbox-wrap{
  display:flex;align-items:center;gap:10px;
  margin:14px 0;
}
.star-picker{
  display:flex;gap:8px;margin:14px 0;flex-wrap:wrap;
}
.star-btn{
  appearance:none;
  background:transparent;
  border:2px solid rgba(255,255,255,.25);
  color:rgba(255,255,255,.7);
  font-size:24px;
  width:56px;height:56px;
  border-radius:12px;
  cursor:pointer;
  transition:all .25s var(--ease);
}
.star-btn:hover{
  transform:scale(1.1);
  border-color:var(--accent);
}
.star-btn.selected{
  background:rgba(255,210,77,.15);
  border-color:var(--accent);
  color:var(--accent);
  box-shadow:0 4px 16px rgba(255,210,77,.3);
}
.chips{
  display:flex;gap:10px;flex-wrap:wrap;
  margin:14px 0;
}
.chip{
  padding:.7rem 1rem;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.2);
  color:rgba(255,255,255,.85);
  font-weight:700;cursor:pointer;
  transition:all .25s var(--ease);
  user-select:none;
}
.chip:hover{
  background:rgba(20,139,255,.15);
  border-color:#1493ff !important;
}
.chip.selected{
  background:#1493ff !important;
  border-color:#1493ff !important;
  color:#fff !important;
  box-shadow:0 4px 14px rgba(20,139,255,.4);
}
.file-input{
  display:block;width:100%;
  padding:12px;margin:8px 0;
}
.photo-preview{
  display:flex;gap:10px;margin:12px 0;flex-wrap:wrap;
}
.photo-preview img{
  width:90px;height:90px;
  border-radius:10px;object-fit:cover;
  border:1px solid rgba(255,255,255,.2);
}
.btn-row{
  display:flex;gap:12px;margin-top:20px;flex-wrap:wrap;
}
.btn{
  appearance:none;
  font-family:inherit;
  font-weight:700;
  border-radius:12px;
  padding:1rem 1.5rem;
  cursor:pointer;
  transition:all .3s var(--ease);
  border:2px solid transparent;
  font-size:clamp(14px,1.3vw,16px);
  min-height:50px;
}
.btn-primary{
  background:#1493ff !important;
  border-color:#1493ff !important;
  color:#fff !important;
  box-shadow:var(--shadow-sm);
}
.btn-primary:hover{
  transform:translateY(-3px);
  box-shadow:var(--glow),var(--shadow-lg);
}
.btn-secondary{
  background:transparent;
  border-color:rgba(255,255,255,.3);
  color:rgba(255,255,255,.9);
}
.btn-secondary:hover{
  background:rgba(255,255,255,.08);
  border-color:rgba(255,255,255,.5);
}
.btn-ghost{
  background:transparent;
  border-color:rgba(255,255,255,.2);
  color:rgba(255,255,255,.8);
}
.btn-ghost:hover{
  background:rgba(255,255,255,.05);
}
.alert{
  display:none;
  margin:16px 0;
  padding:12px 16px;
  border-radius:12px;
  font-size:15px;
}
.alert-error{
  background:rgba(220,38,38,.15);
  border:1px solid rgba(220,38,38,.3);
  color:#fca5a5;
}
.alert-success{
  background:rgba(34,197,94,.15);
  border:1px solid rgba(34,197,94,.3);
  color:#86efac;
}
.close-modal-btn{
  margin-left:auto;
}

/* ===== LIGHTBOX ===== */
.lightbox{
  position:fixed;inset:0;z-index:10000;
  background:rgba(0,0,0,.92);
  display:none;place-items:center;
  padding:20px;
  backdrop-filter:blur(6px);
}
.lightbox[aria-hidden="false"]{display:grid}
.lightbox img{
  max-width:94vw;max-height:94vh;
  border-radius:16px;
  box-shadow:0 20px 80px rgba(0,0,0,.5);
}
.lightbox-close{
  position:fixed;top:20px;right:20px;
  background:rgba(255,255,255,.15);
  border:2px solid rgba(255,255,255,.3);
  color:#fff;
  padding:.8rem 1.2rem;
  border-radius:12px;
  cursor:pointer;
  font-weight:700;
  backdrop-filter:blur(8px);
  transition:all .25s var(--ease);
}
.lightbox-close:hover{
  background:rgba(255,255,255,.25);
  transform:scale(1.05);
}

/* ===== LOADER ===== */
.loader{
  position:fixed;inset:0;z-index:9998;
  display:none;place-items:center;
  background:rgba(10,42,90,.65);
  backdrop-filter:blur(6px);
}
.spinner{
  width:64px;height:64px;
  border-radius:50%;
  border:6px solid rgba(255,255,255,.2);
  border-top-color:#1493ff !important;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== TOAST ===== */
.toast{
  position:fixed;left:50%;bottom:32px;
  transform:translateX(-50%);
  background:rgba(14,47,100,.95);
  color:#fff;
  border:1px solid rgba(255,255,255,.15);
  padding:14px 20px;
  border-radius:14px;
  box-shadow:var(--shadow-lg);
  backdrop-filter:blur(8px);
  display:none;z-index:9999;
  font-weight:600;
  animation:toastSlide .4s var(--ease) backwards;
}
@keyframes toastSlide{
  from{opacity:0;transform:translate(-50%,20px)}
  to{opacity:1;transform:translate(-50%,0)}
}

/* ===== FOOTER ===== */
footer{
  padding:24px clamp(16px,4vw,32px);
  border-top:1px solid rgba(255,255,255,.08);
  text-align:center;
  font-size:14px;opacity:.9;
  background:linear-gradient(180deg,transparent 0%,rgba(10,40,85,.3) 100%);
}
footer a{color:#9bc8ff;text-decoration:none;transition:color .2s}
footer a:hover{color:#1493ff !important}

/* ===== RESPONSIVE ===== */
@media (max-width:768px){
  .hero-stats{margin-top:24px}
  .gallery-grid{grid-template-columns:repeat(auto-fill,minmax(100px,1fr))}
  .review-header{flex-direction:column;align-items:start}
  .review-meta{text-align:left}
}
</style>
</head>
<body>
<style id="ghlForceBlue">
/* High-specificity + important overrides for GoHighLevel embedding */
html body#app div#app:not(.ghl-scope) body,& body, body.body, body[class], body#body, .page-wrapper body, .ghl-preview body {
  background:#0a2a5a !important;
  background-image:linear-gradient(135deg,#0a2a5a 0%,#08224a 50%,#0a2855 100%) !important;
  background-attachment:fixed !important;
  background-size:cover !important;
  background-repeat:no-repeat !important;
}
/* Also neutralize any GHL injected softness/filter */
body:before, body:after { filter:none !important; opacity:1 !important; }
/* Full-bleed fallback layer (added via script) */
#h2sBlueBg{position:fixed;inset:0;z-index:0;pointer-events:none;background:linear-gradient(135deg,#0a2a5a 0%,#08224a 50%,#0a2855 100%);background-attachment:fixed !important;background-size:cover !important;}
/* Ensure our main sections sit above the layer */
.header,.hero,.main,footer,.modal,.lightbox,#toast,#loader{position:relative;z-index:1;}
</style>
<script>
// Fallback: reassert background if GHL mutates after load
window.addEventListener('load', () => {
  setTimeout(() => {
    try {
      const cs = getComputedStyle(document.body);
      const bg = cs.backgroundImage + ' ' + cs.backgroundColor;
      if(/rgba\(\s*\d+\s*,\s*\d+\s*,\s*\d+/i.test(bg) || /linear-gradient\([^)]*white/i.test(bg)) {
        document.body.style.setProperty('background','#0a2a5a','important');
        document.body.style.setProperty('backgroundImage','linear-gradient(135deg,#0a2a5a 0%,#08224a 50%,#0a2855 100%)','important');
        document.body.style.setProperty('backgroundAttachment','fixed','important');
      }
      // Inject full-bleed layer if parent wrapper stays white
      if(!document.getElementById('h2sBlueBg')){
        const layer=document.createElement('div');
        layer.id='h2sBlueBg';
        document.body.prepend(layer);
      }
    } catch(e) {}
  }, 350);
});
</script>

<!-- Full-bleed gradient layer present from first paint (no JS) -->
<div id="h2sBlueBg" aria-hidden="true"></div>

<header class="header">
  <div class="header-inner">
    <a href="https://home2smart.com/home" aria-label="Home2Smart Home">
      <img src="https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68da0ce6f00445991d64a63f.png" alt="Home2Smart" width="96" height="96">
    </a>
    <button id="openModal" class="btn" type="button" style="background:#1493ff !important;border:2px solid #1493ff !important;color:#fff !important;font-weight:700 !important;">Share Your Experience</button>
  </div>
</header>

<section class="hero">
  <div class="hero-badge">
    <span class="star">‚òÖ</span>
    <span id="heroBadge">Trusted by customers across NC & SC</span>
  </div>
  <h1 class="h1">Real customers.<br>Real results.</h1>
  <p class="hero-subtitle">See why hundreds of homeowners trust Home2Smart for expert TV mounting, smart home installations, and security systems.</p>
  
  <div class="hero-stats">
    <div class="stat">
      <div class="stat-num" id="statRating">4.9</div>
      <div class="stat-label">Average Rating</div>
    </div>
    <div class="stat">
      <div class="stat-num" id="statPhotos">0</div>
      <div class="stat-label">Photos Shared</div>
    </div>
  </div>
</section>

<main class="main">
  <div class="container">
    
    <!-- Photo Gallery -->
    <section class="gallery-section">
      <div class="gallery-header">
        <h2 class="gallery-title">Customer Photos</h2>
        <div id="avgBadge" class="avg-badge" style="display:none"></div>
      </div>
      <div id="gallery" class="gallery-grid" role="list" aria-label="Customer photos"></div>
      <div id="gallery-empty" class="empty" style="display:none">No photos yet. Be the first to share!</div>
    </section>

    <!-- Reviews -->
    <section class="reviews-section">
      <h2 class="section-title">What Our Customers Say</h2>
      <div id="reviews" class="reviews-grid" role="list"></div>
      <div id="reviews-empty" class="empty" style="display:none">No reviews yet. Share your experience!</div>
      <div class="load-more-wrap">
        <button id="loadMore" class="btn-load" type="button" style="display:none">Load More Reviews</button>
      </div>
    </section>

  </div>
</main>

<footer>
  <div>&copy; 2025 Home2Smart &nbsp;‚Ä¢&nbsp; Serving NC & SC</div>
  <div style="margin-top:8px">
    <a href="mailto:contact@home2smart.com">contact@home2smart.com</a>
    &nbsp;‚Ä¢&nbsp;
    <a href="https://home2smart.com/privacy-policy">Privacy</a>
    &nbsp;‚Ä¢&nbsp;
    <a href="https://home2smart.com/terms">Terms</a>
  </div>
</footer>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-hidden="true" aria-labelledby="modalTitle">
  <div class="sheet">
    <h2 id="modalTitle" style="font-size:clamp(22px,2.5vw,28px);margin-bottom:18px">Share Your Experience</h2>
    
    <div class="step-nav">
      <div id="pill1" class="step-pill active">1. About You</div>
      <div id="pill2" class="step-pill">2. Your Review</div>
      <div id="pill3" class="step-pill">3. Details</div>
      <button id="closeModal" class="btn btn-ghost close-modal-btn" type="button">Close</button>
    </div>

    <!-- Step 1 -->
    <div id="step1" class="step-content" aria-hidden="false">
      <div class="form-grid">
        <div class="form-group">
          <label class="label" for="iName">Full Name</label>
          <input id="iName" class="input" type="text" placeholder="Jane Doe" autocomplete="name" required>
        </div>
        <div class="form-group">
          <label class="label" for="iEmail">Email</label>
          <input id="iEmail" class="input" type="email" placeholder="you@example.com" autocomplete="email" required>
        </div>
      </div>
      <div class="checkbox-wrap">
        <input id="iShare" type="checkbox">
        <label for="iShare">It's okay to display my name publicly</label>
      </div>
      <div class="btn-row">
        <button id="toStep2" class="btn btn-primary" type="button">Continue</button>
      </div>
    </div>

    <!-- Step 2 -->
    <div id="step2" class="step-content" aria-hidden="true">
      <div class="form-group">
        <label class="label">How would you rate your experience?</label>
        <div id="starPicker" class="star-picker" role="group" aria-label="Rating"></div>
      </div>
      <div class="form-group">
        <label class="label" for="iReview">Tell us about your experience <span style="opacity:.7">(optional)</span></label>
        <textarea id="iReview" class="textarea" placeholder="What stood out? Quality, speed, professionalism..."></textarea>
      </div>
      <div class="btn-row">
        <button id="backToStep1" class="btn btn-secondary" type="button">Back</button>
        <button id="toStep3" class="btn btn-primary" type="button">Continue</button>
      </div>
    </div>

    <!-- Step 3 -->
    <div id="step3" class="step-content" aria-hidden="true">
      <div class="form-group">
        <label class="label">Which services did you use?</label>
        <div id="serviceChips" class="chips"></div>
        <p style="font-size:13px;opacity:.8;margin-top:8px">Select all that apply</p>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label class="label" for="iCity">City <span style="opacity:.7">(optional)</span></label>
          <input id="iCity" class="input" type="text" placeholder="Charlotte">
        </div>
        <div class="form-group">
          <label class="label" for="iState">State <span style="opacity:.7">(optional)</span></label>
          <input id="iState" class="input" type="text" placeholder="NC">
        </div>
      </div>
      <div class="checkbox-wrap">
        <input id="iConsent" type="checkbox">
        <label for="iConsent">I'm okay with being contacted about my review</label>
      </div>
      <div class="form-group">
        <label class="label" for="iPhotos">Add Photos <span style="opacity:.7">(up to 3)</span></label>
        <input id="iPhotos" type="file" accept="image/*" multiple class="file-input">
        <div id="photoPreview" class="photo-preview"></div>
        <p style="font-size:13px;opacity:.8;margin-top:6px">Images are resized on your device for faster upload</p>
      </div>
      
      <div id="errorAlert" class="alert alert-error"></div>
      <div id="successAlert" class="alert alert-success"></div>
      
      <div class="btn-row">
        <button id="backToStep2" class="btn btn-secondary" type="button">Back</button>
        <button id="submitReview" class="btn btn-primary" type="button">Submit Review</button>
        <button id="clearForm" class="btn btn-ghost" type="button">Clear All</button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden form for POST submission -->
<iframe name="reviewSink" id="reviewSink" style="display:none" title="Form submission"></iframe>
<form id="reviewForm" action="https://script.google.com/macros/s/AKfycbwJzG7HNL1B53i6_Ryqvb5zEccD-CREbiVR01MRUEnhoaXSZusT8wVj9uJfDaqqMt3D/exec" method="POST" target="reviewSink" style="display:none">
  <input type="hidden" name="payload" id="payloadField">
</form>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" role="dialog" aria-hidden="true" aria-label="Image viewer">
  <img id="lightboxImg" alt="Full size photo">
  <button class="lightbox-close" id="closeLightbox" type="button">Close</button>
</div>

<!-- Loader -->
<div id="loader" class="loader" role="status" aria-live="polite">
  <div class="spinner" aria-label="Loading"></div>
</div>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
// ===== CONFIG =====
// Fast Vercel API base (relative path works when page served from same Vercel deployment)
const FAST_API_BASE = '/api';
// Legacy Google Apps Script fallback
const LEGACY_API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwJzG7HNL1B53i6_Ryqvb5zEccD-CREbiVR01MRUEnhoaXSZusT8wVj9uJfDaqqMt3D/exec';
const REVIEWS_PER_PAGE = 12;

// ===== UTILITIES =====
const $ = id => document.getElementById(id);
const esc = s => String(s || '').replace(/[<>&"']/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":"&#39;"}[c]));
const isEmail = s => /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(String(s || '').trim());

function toast(msg, duration = 1800) {
  const t = $('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', duration);
}

function showLoader(show = true) {
  $('loader').style.display = show ? 'grid' : 'none';
}

// ===== JSONP =====
let cbSeq = 0;
function jsonp(url, handler) {
  const name = `h2s_cb_${++cbSeq}`;
  window[name] = data => {
    try { handler(null, data); }
    finally { cleanup(); }
  };
  const script = document.createElement('script');
  script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + name;
  script.async = true;
  script.onerror = () => {
    cleanup();
    handler(new Error('Request failed'));
  };
  document.head.appendChild(script);
  function cleanup() {
    delete window[name];
    script.remove();
  }
}

// ===== STATE =====
let allServices = [];
let selectedServices = new Set();
let selectedRating = 0;
let reviewOffset = 0;
let photoFiles = [];
let allRatings = [];
let galleryPhotos = [];

// ===== PHOTO HELPERS =====
function normalizeDriveUrl(url) {
  if (!url) return '';
  const s = String(url).trim().replace(/^'/, '');
  if (/^data:image\//i.test(s)) return s;
  const idMatch = s.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
  if (idMatch) return `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
  const fileMatch = s.match(/\/file\/d\/([a-zA-Z0-9_-]{10,})\//);
  if (fileMatch) return `https://drive.google.com/uc?export=view&id=${fileMatch[1]}`;
  return s;
}

function extractPhotoUrls(review) {
  let out = [];
  const arr = Array.isArray(review.photos) ? review.photos
            : Array.isArray(review.photo_urls) ? review.photo_urls : null;
  if (arr) {
    arr.forEach(v => {
      if (!v) return;
      if (typeof v === 'string') out.push(v);
      else if (v.url) out.push(v.url);
      else if (v.data) out.push(v.data);
    });
  }
  ['photos', 'Photos', 'photo_urls', 'Photo_URLs'].forEach(k => {
    if (!out.length && typeof review[k] === 'string' && review[k].trim()) {
      out = review[k].trim().split(/\s+/);
    }
  });
  ['photo_url_1', 'photo_url_2', 'photo_url_3', 'Photo_URL_1', 'Photo_URL_2', 'Photo_URL_3'].forEach(k => {
    if (review[k]) out.push(review[k]);
  });
  const seen = new Set();
  return out.map(normalizeDriveUrl).filter(u => u && !seen.has(u) && seen.add(u));
}

function createImage(src, alt = '', className = '') {
  const img = document.createElement('img');
  img.loading = 'lazy';
  img.alt = alt;
  if (className) img.className = className;
  let tried = false;
  const setSrc = u => img.setAttribute('src', normalizeDriveUrl(u));
  setSrc(src);
  img.onerror = () => {
    if (tried) {
      img.remove();
      return;
    }
    tried = true;
    setSrc(img.src);
  };
  return img;
}

async function resizeImage(file, maxW = 1600, maxH = 1600, quality = 0.82) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let { width: w, height: h } = img;
        const scale = Math.min(maxW / w, maxH / h, 1);
        canvas.width = Math.round(w * scale);
        canvas.height = Math.round(h * scale);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.onerror = reject;
      img.src = reader.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// ===== MODAL =====
function openModal() {
  $('modal').style.display = 'grid';
  $('modal').setAttribute('aria-hidden', 'false');
  document.documentElement.style.overflow = 'hidden';
}

function closeModal() {
  $('modal').style.display = 'none';
  $('modal').setAttribute('aria-hidden', 'true');
  document.documentElement.style.overflow = '';
}

$('openModal').addEventListener('click', openModal);
$('closeModal').addEventListener('click', closeModal);
$('modal').addEventListener('click', e => {
  if (e.target === $('modal')) closeModal();
});

function goToStep(step) {
  ['pill1', 'pill2', 'pill3'].forEach((id, i) => {
    $(id).classList.toggle('active', i + 1 <= step);
  });
  ['step1', 'step2', 'step3'].forEach((id, i) => {
    $(id).setAttribute('aria-hidden', i + 1 !== step);
  });
}

$('toStep2').addEventListener('click', () => {
  const name = $('iName').value.trim();
  const email = $('iEmail').value.trim();
  if (!name || !isEmail(email)) {
    toast('Please enter your name and a valid email');
    return;
  }
  goToStep(2);
});

$('backToStep1').addEventListener('click', () => goToStep(1));

$('toStep3').addEventListener('click', () => {
  if (selectedRating < 1) {
    toast('Please select a rating');
    return;
  }
  goToStep(3);
});

$('backToStep2').addEventListener('click', () => goToStep(2));

$('clearForm').addEventListener('click', () => {
  $('iName').value = '';
  $('iEmail').value = '';
  $('iShare').checked = false;
  $('iReview').value = '';
  $('iCity').value = '';
  $('iState').value = '';
  $('iConsent').checked = false;
  selectedServices.clear();
  renderServiceChips();
  selectedRating = 0;
  renderStarPicker();
  photoFiles = [];
  $('photoPreview').innerHTML = '';
  $('iPhotos').value = '';
  $('errorAlert').style.display = 'none';
  $('successAlert').style.display = 'none';
});

// ===== STAR PICKER =====
function renderStarPicker() {
  const picker = $('starPicker');
  picker.innerHTML = '';
  for (let i = 1; i <= 5; i++) {
    const btn = document.createElement('button');
    btn.className = 'star-btn';
    btn.type = 'button';
    btn.textContent = '‚òÖ';
    btn.setAttribute('aria-label', `${i} stars`);
    btn.addEventListener('click', () => {
      selectedRating = i;
      renderStarPicker();
    });
    if (i <= selectedRating) btn.classList.add('selected');
    picker.appendChild(btn);
  }
}

// ===== SERVICE CHIPS =====
function renderServiceChips() {
  const container = $('serviceChips');
  container.innerHTML = '';
  allServices.forEach(service => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = service;
    if (selectedServices.has(service)) chip.classList.add('selected');
    chip.addEventListener('click', () => {
      if (selectedServices.has(service)) {
        selectedServices.delete(service);
        chip.classList.remove('selected');
      } else {
        selectedServices.add(service);
        chip.classList.add('selected');
      }
    });
    container.appendChild(chip);
  });
}

// ===== PHOTO UPLOAD =====
$('iPhotos').addEventListener('change', async e => {
  const files = Array.from(e.target.files || []).slice(0, 3);
  photoFiles = [];
  const preview = $('photoPreview');
  preview.innerHTML = '';
  showLoader(true);
  for (const file of files) {
    const dataUrl = await resizeImage(file);
    photoFiles.push({ data: dataUrl, name: file.name, type: file.type || 'image/jpeg' });
    preview.appendChild(createImage(dataUrl, 'Preview'));
  }
  showLoader(false);
});

// ===== GALLERY =====
function updateHeroStats() {
  const avg = allRatings.length ? (allRatings.reduce((a, b) => a + b, 0) / allRatings.length) : 0;
  if (avg) {
    $('statRating').textContent = avg.toFixed(1);
    $('heroBadge').textContent = `Rated ${avg.toFixed(1)}/5 ‚òÖ by customers`;
  }
  $('statReviews').textContent = allRatings.length;
  $('statPhotos').textContent = galleryPhotos.length;
  
  const badge = $('avgBadge');
  badge.textContent = avg ? `${avg.toFixed(1)} ‚òÖ Average` : '';
  badge.style.display = avg ? 'inline-flex' : 'none';
}

function renderGallery() {
  const gallery = $('gallery');
  const empty = $('gallery-empty');
  
  if (!galleryPhotos.length) {
    gallery.style.display = 'none';
    empty.style.display = 'block';
    return;
  }
  
  gallery.style.display = 'grid';
  empty.style.display = 'none';
  gallery.innerHTML = '';
  
  galleryPhotos.slice(0, 200).forEach((src, idx) => {
    const img = createImage(src, 'Customer photo', 'gallery-img');
    img.setAttribute('role', 'button');
    img.addEventListener('click', () => openLightbox(idx));
    img.style.animationDelay = `${Math.min(idx * 0.05, 1)}s`;
    gallery.appendChild(img);
  });
}

// ===== LIGHTBOX =====
function openLightbox(startIdx) {
  const lb = $('lightbox');
  const img = $('lightboxImg');
  let currentIdx = startIdx;
  
  const show = () => {
    img.src = galleryPhotos[currentIdx];
  };
  
  show();
  lb.setAttribute('aria-hidden', 'false');
  
  const close = () => lb.setAttribute('aria-hidden', 'true');
  
  $('closeLightbox').onclick = close;
  lb.addEventListener('click', e => {
    if (e.target === lb) close();
  }, { once: true });
  
  document.onkeydown = e => {
    if (lb.getAttribute('aria-hidden') === 'true') return;
    if (e.key === 'Escape') close();
    if (e.key === 'ArrowRight') {
      currentIdx = (currentIdx + 1) % galleryPhotos.length;
      show();
    }
    if (e.key === 'ArrowLeft') {
      currentIdx = (currentIdx - 1 + galleryPhotos.length) % galleryPhotos.length;
      show();
    }
  };
}

// ===== REVIEWS LIST =====
function formatDate(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  return isNaN(d) ? '' : d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
}

async function loadReviews(append = false) {
  showLoader(true);
  try {
    // Fast path: Vercel Supabase-backed API
    const fastResp = await fetch(`${FAST_API_BASE}/reviews?limit=${REVIEWS_PER_PAGE}&onlyVerified=false`);
    if (!fastResp.ok) throw new Error('Fast endpoint failed');
    const fastJson = await fastResp.json();
    if (!fastJson.ok) throw new Error('Fast endpoint error');
    renderReviews(fastJson.reviews || [], append);
  } catch (fastErr) {
    // Fallback: legacy JSONP endpoint
    jsonp(`${LEGACY_API_ENDPOINT}?action=public_list&limit=${REVIEWS_PER_PAGE}&offset=${reviewOffset}&onlyVerified=false`, (err, data) => {
      try {
        if (err || !data || data.ok !== true) throw new Error('Failed to load');
        renderReviews(data.items || [], append);
      } catch (e) {
        console.error(e);
        toast('Could not load reviews');
        showLoader(false);
      }
    });
  }
}

function renderReviews(items, append){
  const reviewsList = $('reviews');
  const empty = $('reviews-empty');
  if (!append) {
    reviewsList.innerHTML='';
    allRatings=[]; galleryPhotos=[];
  }
  if (!items.length && reviewOffset===0){
    reviewsList.style.display='none'; empty.style.display='block';
  } else { reviewsList.style.display='grid'; empty.style.display='none'; }
  items.forEach((review, idx)=>{
    const rating = Number(review.rating || 0);
    if (rating) allRatings.push(rating);
    const photos = extractPhotoUrls(review);
    photos.forEach(url=>{ if(!galleryPhotos.includes(url)) galleryPhotos.push(url); });
    const card = document.createElement('div');
    card.className='review-card';
    card.style.animationDelay = `${idx * 0.08}s`;
    const stars='‚òÖ'.repeat(rating);
    // Normalize field names from fast endpoint (name/text/date/service) OR legacy (display_name/review_text/timestamp_iso/services_selected)
    const displayName = review.display_name || review.name || 'Customer';
    const reviewText = review.review_text || review.text || '';
    const dateIso = review.timestamp_iso || review.date || '';
    const services = (review.services_selected || review.service || '').split(',').map(s=>s.trim()).filter(Boolean);
    let html = `
    <div class="review-header">
      <div class="review-stars">${esc(stars)}</div>
      <div class="review-meta">
        <div class="review-name">${esc(displayName)}</div>
        <div class="review-date">${esc(formatDate(dateIso))}</div>
      </div>
    </div>`;
    if (reviewText && reviewText.trim()) html += `<div class="review-text">${esc(reviewText)}</div>`;
    if (services.length){
      html += '<div class="review-services">' + services.map(s=>`<span class="service-tag">${esc(s)}</span>`).join('') + '</div>';
    }
    card.innerHTML = html;
    if (photos.length){
      const photoContainer = document.createElement('div');
      photoContainer.className='review-photos';
      photos.slice(0,3).forEach(url=>{
        const img=createImage(url,'Customer photo','review-photo');
        img.addEventListener('click',()=>{ const globalIdx=galleryPhotos.indexOf(url); if(globalIdx>=0) openLightbox(globalIdx); });
        photoContainer.appendChild(img);
      });
      card.appendChild(photoContainer);
    }
    reviewsList.appendChild(card);
  });
  updateHeroStats();
  renderGallery();
  reviewOffset += items.length;
  $('loadMore').style.display = items.length === REVIEWS_PER_PAGE ? 'inline-flex' : 'none';
  showLoader(false);
}

$('loadMore').addEventListener('click', () => loadReviews(true));

// ===== SERVICES =====
async function loadServices(){
  showLoader(true);
  try {
    // Attempt fast endpoint (could expose /api/services later). For now legacy only.
    jsonp(`${LEGACY_API_ENDPOINT}?action=services_list`, (err,data)=>{
      try {
        if (err || !data || data.ok !== true) throw new Error('Failed to load services');
        allServices = (data.services || []).map(s=>String(s)).filter(Boolean);
        renderServiceChips();
      } catch(e){ console.error(e); toast('Could not load services'); }
      finally { showLoader(false); }
    });
  } catch(e){ console.error(e); toast('Could not load services'); showLoader(false); }
}

// ===== SUBMIT =====
$('submitReview').addEventListener('click', async () => {
  const name = $('iName').value.trim();
  const email = $('iEmail').value.trim();
  const share = $('iShare').checked ? 'Yes' : 'No';
  const reviewText = $('iReview').value.trim();
  const city = $('iCity').value.trim();
  const state = $('iState').value.trim();
  const consent = $('iConsent').checked ? 'Yes' : 'No';
  const services = Array.from(selectedServices);
  
  $('errorAlert').style.display = 'none';
  $('successAlert').style.display = 'none';
  
  if (!name || !isEmail(email)) {
    $('errorAlert').textContent = 'Please enter your name and a valid email address.';
    $('errorAlert').style.display = 'block';
    return;
  }
  
  if (selectedRating < 1 || selectedRating > 5) {
    $('errorAlert').textContent = 'Please select a rating between 1 and 5 stars.';
    $('errorAlert').style.display = 'block';
    return;
  }
  
  const payload = {
    name,
    email,
    share_name: share,
    rating: selectedRating,
    review: reviewText,
    services,
    consent,
    city,
    state,
    source: 'Web',
    photos: photoFiles
  };
  
  try {
    showLoader(true);
    // Fast submission to Vercel API first
    const resp = await fetch(`${FAST_API_BASE}/reviews/submit`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!resp.ok) throw new Error('Fast submit failed');
    const j = await resp.json();
    if (!j.ok) throw new Error(j.error || 'Submit error');
    handleSubmitSuccess();
  } catch(errFast){
    // Fallback to legacy Google Sheets (hidden iframe method)
    try {
      $('payloadField').value = JSON.stringify(payload);
      $('reviewForm').submit();
      const sink = $('reviewSink');
      let resolved=false;
      const timeout = setTimeout(()=>{ if(!resolved) handleSubmitSuccess(); },2500);
      sink.onload=()=>{ if(!resolved){ resolved=true; clearTimeout(timeout); handleSubmitSuccess(); } };
    } catch(errLegacy){
      $('errorAlert').textContent = errLegacy.message || 'Submission failed';
      $('errorAlert').style.display='block';
      toast('Submission failed');
    }
  } finally {
    showLoader(false);
  }
});

function handleSubmitSuccess() {
  $('successAlert').textContent = 'Thank you! Your review has been submitted successfully.';
  $('successAlert').style.display = 'block';
  toast('Review submitted! Thank you.', 2200);
  
  // Reset and reload
  reviewOffset = 0;
  allRatings = [];
  galleryPhotos = [];
  loadReviews(false);
  
  setTimeout(() => {
    closeModal();
    $('clearForm').click();
  }, 1200);
}

// ===== INIT =====
(function init() {
  renderStarPicker();
  loadServices();
  loadReviews(false);
})();
</script>

<!-- ===== TRACKING CLIENT ===== -->
<script>
(function() {
    'use strict';
    
    const TRACK_API = 'https://h2s-backend.vercel.app/api/track';
    const VISITOR_KEY = 'h2s_visitor_id';
    const SESSION_KEY = 'h2s_session_id';
    
    function getVisitorId() {
        let vid = localStorage.getItem(VISITOR_KEY);
        if (!vid) {
            vid = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
            localStorage.setItem(VISITOR_KEY, vid);
        }
        return vid;
    }
    
    function getSessionId() {
        let sid = sessionStorage.getItem(SESSION_KEY);
        if (!sid) {
            sid = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
            sessionStorage.setItem(SESSION_KEY, sid);
        }
        return sid;
    }
    
    function extractUTM() {
        const params = new URLSearchParams(window.location.search);
        return {
            utm_source: params.get('utm_source') || null,
            utm_medium: params.get('utm_medium') || null,
            utm_campaign: params.get('utm_campaign') || null,
            utm_term: params.get('utm_term') || null,
            utm_content: params.get('utm_content') || null
        };
    }
    
    function sendEvent(payload, retries = 1) {
        const useBeacon = navigator.sendBeacon && retries === 1;
        
        if (useBeacon) {
            const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
            if (navigator.sendBeacon(TRACK_API, blob)) {
                return Promise.resolve();
            }
        }
        
        return fetch(TRACK_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            keepalive: true
        })
        .then(res => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        })
        .catch(err => {
            if (retries > 0) {
                return new Promise(resolve => {
                    setTimeout(() => {
                        sendEvent(payload, retries - 1).then(resolve).catch(() => resolve());
                    }, 500);
                });
            }
        });
    }
    
    function track(eventType, data = {}) {
        const payload = {
            event: eventType,
            event_type: eventType,
            occurred_at: new Date().toISOString(),
            visitor_id: getVisitorId(),
            session_id: getSessionId(),
            page_url: window.location.href,
            page_path: window.location.pathname,
            referrer: document.referrer || null,
            user_agent: navigator.userAgent,
            ...extractUTM(),
            ...data
        };
        
        if (data.element_id) payload.element_id = data.element_id;
        if (data.element_text) payload.element_text = data.element_text;
        if (data.metadata) payload.metadata = data.metadata;
        
        if (eventType === 'page_view') {
            if ('requestIdleCallback' in window) {
                requestIdleCallback(() => sendEvent(payload), { timeout: 2000 });
            } else {
                setTimeout(() => sendEvent(payload), 100);
            }
        } else {
            sendEvent(payload);
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            track('page_view');
        });
    } else {
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => track('page_view'), { timeout: 2000 });
        } else {
            setTimeout(() => track('page_view'), 100);
        }
    }
    
    document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-track]');
        if (target) {
            const eventType = target.getAttribute('data-track') || 'click';
            track(eventType, {
                element_id: target.id || target.getAttribute('data-track-id') || null,
                element_text: target.textContent?.trim().substring(0, 100) || null
            });
        }
    }, { passive: true });
    
    document.addEventListener('submit', function(e) {
        if (e.target.tagName === 'FORM') {
            track('form_submit', {
                element_id: e.target.id || 'unknown_form'
            });
        }
    }, { passive: true });
    
    document.addEventListener('click', function(e) {
        const link = e.target.closest('a[href]');
        if (link && link.hostname !== window.location.hostname) {
            track('outbound', {
                element_id: link.id || null,
                element_text: link.textContent?.trim().substring(0, 100) || null,
                metadata: { url: link.href }
            });
        }
    }, { passive: true });
    
    window.h2sTrack = track;
    
    window.addEventListener('beforeunload', function() {
        const payload = {
            event: 'page_unload',
            event_type: 'page_unload',
            occurred_at: new Date().toISOString(),
            visitor_id: getVisitorId(),
            session_id: getSessionId(),
            page_url: window.location.href,
            page_path: window.location.pathname
        };
        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        navigator.sendBeacon(TRACK_API, blob);
    });
})();
</script>

</body>
</html>
