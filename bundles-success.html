<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Order Confirmed ‚Ä¢ Home2Smart</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https://home2smart.com https://h2s-backend.vercel.app; script-src 'self' 'unsafe-inline' https://home2smart.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://home2smart.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' https: data:; connect-src 'self' https://h2s-backend.vercel.app https://home2smart.com; frame-src https://api.leadconnectorhq.com;">
<link rel="preconnect" href="https://api.leadconnectorhq.com">
<link rel="dns-prefetch" href="https://api.leadconnectorhq.com">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{--cobalt:#0a2a5a;--azure:#1493ff;--border:#e1e6ed;--muted:#6b778c}
  *{box-sizing:border-box}
  body{font-family:Archivo,system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#fff;color:#0b1420}
  .wrap{max-width:820px;margin:24px auto;padding:16px}
  .card{border:1px solid var(--border);border-radius:12px;padding:24px}
  h1{font-weight:900;letter-spacing:-.02em;color:var(--cobalt);margin:0 0 12px 0;font-size:28px}
  .help{color:var(--muted);margin-bottom:20px;font-size:15px;line-height:1.6}
  .grid{display:grid;gap:0;background:#f8f9fb;border-radius:10px;padding:16px;margin:20px 0}
  .row{display:grid;grid-template-columns:140px 1fr;gap:16px;padding:12px 0;border-bottom:1px solid #e5e7eb;align-items:center}
  .row:last-child{border-bottom:none;padding-bottom:0}
  .k{color:var(--muted);font-weight:600;font-size:14px}
  .v{font-weight:700;color:var(--cobalt);word-break:break-word;overflow-wrap:break-word;font-size:14px}
  .cal{margin-top:24px;border:1px solid var(--border);border-radius:12px;overflow:hidden;height:680px;contain:layout style paint;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
  .cal iframe{width:100%;height:100%;border:0}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 20px;border-radius:8px;border:2px solid var(--azure);background:#fff;color:var(--azure);font-weight:800;text-decoration:none;transition:all 0.2s ease;font-size:15px}
  .btn:hover{background:var(--azure);color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(20,147,255,0.25)}
  .center{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:20px}
</style>
</head>
<body>
  <div class="wrap">
    <div id="content" class="card">
      <h1>Loading‚Ä¶</h1>
      <div class="help">Preparing your confirmation.</div>
    </div>
  </div>
<script>
(function(){
  const API = 'https://h2s-backend.vercel.app/api/shop';
  const APIV1 = 'https://h2s-backend.vercel.app/api/book-appointment';
  const CAL_FORM_URL = 'https://api.leadconnectorhq.com/widget/booking/RjwOQacM3FAjRNCfm6uU';
  const $ = s=>document.querySelector(s);
  const qp = new URLSearchParams(location.search);
  const view = qp.get('view')||'';
  const sessionId = qp.get('session_id')||'';

  function money(n,c='USD'){ 
    try{ 
      const val = Number(n);
      return new Intl.NumberFormat('en-US',{style:'currency',currency:c}).format(val);
    }catch(_){ 
      return '$'+Number(n).toFixed(2);
    } 
  }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  async function saveAppointmentReturn(){
    const order_id = qp.get('order_id')||'';
    const startIso = qp.get('start')||'';
    const endIso = qp.get('end')||'';
    const tz = qp.get('tz')||qp.get('timezone')||'';
    const email = qp.get('email')||''; // scheduler may supply this

    $('#content').innerHTML = '<h1>Saving your appointment‚Ä¶</h1><div class="help">Just a moment.</div>';

    try{
      if(!email) throw new Error('Missing email');
      if(!startIso) throw new Error('Missing appointment time');
      await fetch(APIV1, { method:'POST', body: JSON.stringify({ __action:'record_install_slot', email, order_id, install_at:startIso, install_end_at:endIso, timezone:tz }) });
      $('#content').innerHTML = '<h1>Appointment saved</h1><div class="help">We\'ll see you then. You can close this page.</div>';
    }catch(err){
      $('#content').innerHTML = '<h1>Couldn\'t save appointment</h1><div class="help" style="color:#c33">'+esc(err.message||'Error')+'</div>';
    }
  }

  async function renderSuccess(){
    // Prefer URL params (simulation provides these)
    const order = {
      order_id: qp.get('order_id') || sessionId || '‚Äî',
      order_total: qp.get('order_total') || qp.get('order_subtotal') || '',
      order_subtotal: qp.get('order_subtotal') || '',
      order_currency: (qp.get('order_currency')||'USD').toUpperCase(),
      order_item_count: qp.get('order_item_count') || '',
      order_summary: qp.get('order_summary') || '',
      order_discount_code: qp.get('order_discount_code') || '',
      order_discount_amount: qp.get('order_discount_amount') || ''
    };

    const prettyTotal = order.order_total != null && order.order_total !== '' 
      ? money(Number(order.order_total), order.order_currency) 
      : (order.order_subtotal != null && order.order_subtotal !== '' 
        ? money(Number(order.order_subtotal), order.order_currency) 
        : '$0.00');

    $('#content').innerHTML = `
      <h1>Order Confirmed!</h1>
      <div class="help">Thank you for choosing Home2Smart. Your order details are below.</div>
      <div class="grid">
        <div class="row"><div class="k">Order ID</div><div class="v" style="font-family:monospace;font-size:12px">${esc(order.order_id)}</div></div>
        <div class="row"><div class="k">Total</div><div class="v" style="font-size:18px;font-weight:900">${esc(prettyTotal)}</div></div>
        <div class="row"><div class="k">Items</div><div class="v">${esc(order.order_summary || (order.order_item_count? (order.order_item_count+' item'+(order.order_item_count==='1'?'':'s')) : '‚Äî'))}</div></div>
        ${order.order_discount_code ? `<div class="row"><div class="k">Promo Code</div><div class="v" style="color:#059669;font-family:monospace">${esc(order.order_discount_code)}</div></div>` : ''}
      </div>
      <div class="help" style="margin-top:24px;background:#eff6ff;padding:16px;border-radius:8px;border:1px solid #93c5fd">
        <strong style="color:var(--cobalt);display:block;margin-bottom:8px">üìÖ Next Step: Schedule Your Installation</strong>
        Pick a convenient date and time below. We'll send you a confirmation email with all the details.
      </div>
      <div class="cal"><iframe id="calFrame" title="Scheduler"></iframe></div>
      <div class="center">
        <a class="btn" href="/bundles">‚Üê Back to Packages</a>
        <a class="btn" href="tel:864-528-1475" style="background:var(--cobalt);color:#fff;border-color:var(--cobalt)">üìû Call Support</a>
      </div>
    `;

    // Build calendar URL with known params
    const q = new URLSearchParams();
    ['first_name','last_name','email','phone','order_id','stripe_session_id','order_created_at','order_total','order_subtotal','order_currency','order_discount_code','order_discount_amount','order_item_count','order_summary','order_lines_json','utm_source','utm_medium','utm_campaign','utm_term','utm_content'].forEach(k=>{
      const v = qp.get(k);
      if(v!=null && String(v).length) q.set(k, v);
    });
    q.set('redirect_url', 'https://home2smart.com/success?view=apptreturn');

    const src = CAL_FORM_URL + (CAL_FORM_URL.includes('?') ? '&' : '?') + q.toString();
    const frame = document.getElementById('calFrame');
    
    // Defer iframe load slightly to prioritize page render
    requestAnimationFrame(() => {
      frame.src = src;
    });
  }

  (view === 'apptreturn') ? saveAppointmentReturn() : renderSuccess();
})();
</script>
</body>
</html>
