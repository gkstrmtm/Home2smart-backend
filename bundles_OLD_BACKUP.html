<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!-- Security -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://connect.facebook.net https://js.stripe.com https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' https: data:; connect-src 'self' https://connect.facebook.net https://www.facebook.com https://api.stripe.com https://h2s-backend.vercel.app; frame-src https://api.leadconnectorhq.com https://js.stripe.com;">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="referrer" content="strict-origin-when-cross-origin">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Smart Home Packages &bull; Home2Smart</title>
<meta name="description" content="TV mounting and security camera packages. Pick a package, we handle the rest. Done right, done once.">
<meta name="theme-color" content="#0a2a5a">

<!-- SEO: Open Graph -->
<meta property="og:title" content="Smart Home Installation Packages | Home2Smart">
<meta property="og:description" content="Professional TV mounting & security camera installation. Licensed, insured, same-day service available. 500+ homes served, 4.9&#9733; rating.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://home2smart.com/bundles">
<meta property="og:site_name" content="Home2Smart">

<!-- SEO: Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Smart Home Installation Packages | Home2Smart">
<meta name="twitter:description" content="Professional TV mounting & security camera installation. Licensed, insured, same-day service available.">

<!-- SEO: Canonical URL -->
<link rel="canonical" href="https://home2smart.com/bundles">

<!-- SEO: Robots -->
<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">

<!-- Performance: Critical Resource Hints -->
<link rel="preconnect" href="https://h2s-backend.vercel.app" crossorigin>
<link rel="dns-prefetch" href="https://h2s-backend.vercel.app">
<!-- Preload aggregated data to start fetch parallel to HTML parsing -->
<link rel="preload" href="https://h2s-backend.vercel.app/api/bundles-data" as="fetch" crossorigin>
<!-- Preload logo for faster LCP -->
<link rel="preload" href="https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68da0ce6f00445991d64a63f.png" as="image" fetchpriority="high">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="dns-prefetch" href="https://js.stripe.com">

<!-- Critical Fonts -->
<!-- Fonts loaded async to avoid render-blocking -->
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;800;900&display=swap" as="style" crossorigin onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;800;900&display=swap" rel="stylesheet" crossorigin></noscript>

<style>
@font-face {
  font-family: 'Archivo-fallback';
  src: local('Arial');
  size-adjust: 105%;
  ascent-override: 95%;
  descent-override: 25%;
}
</style>



<!-- Load remaining font weights async (non-blocking, low priority) -->
<style>
/* === CRITICAL CSS (INLINE) === */
:root {
  --cobalt: #0a2a5a;
  --azure: #1493ff;
  --ink: #0b1420;
  --bg: #ffffff;
  --border: #e1e6ed;
  --muted: #6b778c;
  --shadow-sm: 0 2px 8px rgba(11,20,32,.06);
  --shadow-md: 0 4px 16px rgba(11,20,32,.08);
  --shadow-lg: 0 8px 24px rgba(11,20,32,.12);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  scroll-behavior: smooth;
  background: var(--cobalt); /* Prevent white flash / overscroll raw area */
  overscroll-behavior-y: none; /* Clamp bounce */
}

body {
  /* Performance: Use system font first, upgrade to Archivo when it loads */
  font-family: Archivo, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, 'Archivo-fallback', Arial, sans-serif;
  background: var(--bg);
  color: var(--ink);
  line-height: 1.6;
  overflow-x: hidden;
  margin: 0;
  padding: 0;
  min-height: 100vh;
}

/* Prevent body scroll when modal is open */
body.modal-open {
  overflow: hidden;
  position: fixed;
  width: 100%;
  height: 100%;
}

#pageShell {
  background: #fff;
  min-height: 100vh;
  position: relative;
}

/* === URGENCY BANNER === */
.urgency-banner {
  position: fixed;
  bottom: 24px; /* Move to bottom to avoid header conflict and CLS */
  top: auto;
  left: 50%;
  right: auto;
  width: auto;
  min-width: 300px;
  max-width: 90%;
  transform: translateX(-50%) translateY(150%); /* Start hidden below */
  z-index: 1200;
  background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
  color: #fff;
  padding: 12px 24px;
  text-align: center;
  font-size: 14px;
  font-weight: 600;
  line-height: 1.3;
  box-shadow: 0 8px 24px rgba(247, 147, 30, 0.3);
  border-radius: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  height: auto;
  border: 1px solid rgba(255,255,255,0.2);
}

.urgency-banner.visible {
  transform: translateX(-50%) translateY(0);
}

.urgency-banner.dismissed {
  display: none;
}

.urgency-text {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
}

.urgency-text strong {
  font-weight: 800;
}

.urgency-separator {
  opacity: 0.6;
}

.urgency-close {
  background: rgba(255,255,255,.2);
  border: none;
  color: #fff;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  line-height: 1;
  transition: background 0.2s ease;
  padding: 0;
  margin-left: 8px;
}

.urgency-close:hover {
  background: rgba(255,255,255,.3);
}

@media (max-width: 768px) {
  .urgency-banner {
    bottom: 16px;
    padding: 10px 16px;
    font-size: 13px;
    width: 92%;
    border-radius: 12px;
  }
  
  .urgency-text {
    gap: 8px;
  }

  /* Mobile form improvements */
  .form {
    margin: 40px 16px;
    padding: 24px;
    max-width: 100%;
  }

  .form h2 {
    font-size: 24px;
  }

  .inp {
    font-size: 16px; /* Prevents iOS zoom */
  }

  .btn {
    min-height: 48px; /* Better touch targets */
  }

  .link-btn {
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Calendar Mobile Fix */
  .cal-day {
    padding: 6px !important;
    font-size: 13px !important;
  }
}

/* Calendar Desktop Default */
.cal-day {
  padding: 12px;
}


/* === HEADER (FULL BLEED) === */
.header {
  position: fixed; /* Clamp header */
  inset: 0 0 auto 0;
  height: 56px;
  z-index: 200;
  background: var(--cobalt);
  border-bottom: 1px solid rgba(255,255,255,.12);
  box-shadow: var(--shadow-md);
  width: 100%;
  will-change: transform;
  transition: top 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  top: 0;
}

.header-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 56px;
  padding: 0 16px;
  max-width: 1400px;
  margin: 0 auto;
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
  color: #fff;
  font-weight: 900;
  font-size: 18px;
  letter-spacing: -0.02em;
}

.logo-img {
  width: 36px;
  height: 36px;
  display: block;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.menu-btn,
.cart-btn,
#accountBtn {
  appearance: none;
  border: none;
  background: transparent;
  color: #fff;
  cursor: pointer;
  padding: 8px;
  border-radius: 6px;
  transition: background 0.15s ease;
  position: relative;
}

.menu-btn:hover,
.cart-btn:hover,
#accountBtn:hover {
  background: rgba(255,255,255,.1);
}

.menu-btn:focus-visible,
.cart-btn:focus-visible,
#accountBtn:focus-visible {
  outline: 2px solid rgba(255,255,255,.4);
  outline-offset: 2px;
}

.icon {
  width: 24px;
  height: 24px;
  stroke: currentColor;
  stroke-width: 2;
  fill: none;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.cart-badge {
  position: absolute;
  top: 4px;
  right: 4px;
  background: var(--azure);
  color: var(--cobalt);
  font-size: 11px;
  font-weight: 900;
  padding: 2px 5px;
  border-radius: 10px;
  line-height: 1;
  min-width: 18px;
  text-align: center;
}

/* === HERO === */
.hero {
  background-color: var(--cobalt);
  background-image: linear-gradient(160deg, var(--cobalt) 0%, #0b1420 100%);
  color: #fff;
  padding: 72px 16px 56px;
  text-align: center;
  position: relative;
  width: 100vw;
  margin-left: calc(50% - 50vw);
  margin-right: calc(50% - 50vw);
  box-sizing: border-box;
  transition: padding-top 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.hero-inner {
  max-width: 640px;
  margin: 0 auto;
}

.hero h1 {
  font-size: 32px;
  font-weight: 900;
  line-height: 1.1;
  letter-spacing: -0.03em;
  margin-bottom: 12px;
}

.hero p {
  font-size: 17px;
  opacity: 1; /* Remove faded look on initial paint */
  margin-bottom: 28px;
  line-height: 1.5;
}

.hero-ctas {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  max-width: 480px;
  margin: 0 auto 24px;
}

/* Ghost buttons on hero (dark background) need light styling */
.hero .btn-ghost {
  background: transparent;
  color: #fff;
  border: 2px solid rgba(255,255,255,0.5);
  font-weight: 600;
}

.hero .btn-ghost:hover {
  background: rgba(255,255,255,0.15);
  border-color: #fff;
  color: #fff;
  box-shadow: 0 2px 12px rgba(255,255,255,0.2);
}

.hero .btn-ghost:active {
  background: rgba(255,255,255,0.25);
}

/* === HERO REVIEW CAROUSEL === */
.hero-reviews {
  max-width: 500px;
  margin: 0 auto;
  padding: 16px 20px;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(12px);
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(10,42,90,0.12);
  border: 1px solid rgba(255,255,255,0.6);
  position: relative;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.2s ease;
  min-height: 120px; /* Prevent CLS when reviews load */
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.hero-reviews:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(10,42,90,0.18);
  border-color: rgba(20,147,255,0.3);
}

.hero-review-slide {
  display: none;
  animation: hero-review-fade 0.5s ease;
}

.hero-review-slide.active {
  display: block;
}

@keyframes hero-review-fade {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.hero-review-stars {
  display: flex;
  gap: 4px;
  justify-content: center;
  margin-bottom: 8px;
  font-size: 16px;
  color: #fbbf24;
}

.hero-review-text {
  font-size: 14px;
  line-height: 1.5;
  color: var(--ink);
  text-align: center;
  margin-bottom: 8px;
  font-style: italic;
  
  /* Clamp to 2 lines with ellipsis */
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  min-height: 42px; /* 14px * 1.5 * 2 lines = prevent layout shift */
  max-height: 42px;
}

.hero-review-text:empty {
  display: none; /* Hide if no text */
}

.hero-review-author {
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  text-align: center;
}

.hero-review-dots {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-top: 12px;
  padding-bottom: 4px;
}

.hero-review-dots::after {
  content: 'See all reviews \2192';
  position: absolute;
  bottom: 4px;
  right: 12px;
  font-size: 10px;
  color: var(--azure);
  font-weight: 600;
  opacity: 0;
  transition: opacity 0.2s ease;
  pointer-events: none;
}

.hero-reviews:hover .hero-review-dots::after {
  opacity: 0.7;
}

.hero-review-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--border);
  cursor: pointer;
  transition: all 0.3s ease;
}

.hero-review-dot.active {
  background: var(--azure);
  width: 20px;
  border-radius: 3px;
}

/* === BUTTONS === */
.btn {
  appearance: none;
  border: none;
  background: var(--azure);
  color: var(--cobalt);
  font-family: inherit;
  font-size: 16px;
  font-weight: 800;
  padding: 14px 20px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.18s cubic-bezier(0.4, 0, 0.2, 1);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  line-height: 1;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(20,147,255,.25);
}

.btn:active {
  transform: translateY(0);
}

.btn:focus-visible {
  outline: 3px solid rgba(20,147,255,.3);
  outline-offset: 2px;
}

.btn-ghost {
  background: transparent;
  color: var(--cobalt);
  border: 2px solid var(--azure);
  font-weight: 600;
}

.btn-ghost:hover {
  background: var(--azure);
  color: #fff;
  border-color: var(--azure);
  box-shadow: 0 2px 8px rgba(20,147,255,0.2);
}

.btn-ghost:active {
  background: #0c7fd9;
}

.btn-primary {
  background: var(--azure);
  color: #fff;
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(20,147,255,0.25);
  transition: all 0.2s ease;
}

.btn-primary:hover {
  background: #0c7fd9;
  box-shadow: 0 4px 12px rgba(20,147,255,0.35);
  transform: translateY(-1px);
}

.btn-primary:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(20,147,255,0.3);
}

.btn-secondary {
  background: var(--cobalt);
  color: #fff;
}

.btn-subtle {
  background: transparent;
  color: var(--muted);
  border: 1px solid var(--border);
  font-weight: 700;
  font-size: 14px;
  padding: 10px 16px;
}

.btn-subtle:hover {
  background: #f5f7fa;
  color: var(--cobalt);
  box-shadow: none;
}

/* === SECTION === */
.section {
  padding: 64px 16px;
  max-width: 1200px;
  margin: 0 auto;
  background: #fff;
  position: relative;
}

.section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 32px;
  background: linear-gradient(180deg, #f8f9fb 0%, transparent 100%);
  pointer-events: none;
}

.section-header {
  text-align: center;
  margin-bottom: 40px;
}

.section-header h2 {
  font-size: 28px;
  font-weight: 900;
  color: var(--cobalt);
  margin-bottom: 8px;
  letter-spacing: -0.02em;
}

.section-header p {
  font-size: 16px;
  color: var(--muted);
  max-width: 560px;
  margin: 0 auto;
}

/* === TRUST BAR === */
.trust-bar {
  background-color: var(--cobalt);
  background-image: linear-gradient(135deg, var(--cobalt) 0%, #0d3568 100%);
  padding: 24px 16px;
  position: relative;
  width: 100vw;
  margin-left: calc(50% - 50vw);
  margin-right: calc(50% - 50vw);
  box-sizing: border-box;
}

.trust-bar::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, rgba(20, 147, 255, 0.3) 50%, transparent 100%);
}

.trust-bar::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, rgba(20, 147, 255, 0.3) 50%, transparent 100%);
}

.trust-inner {
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}

@media (min-width: 768px) {
  .trust-inner {
    grid-template-columns: repeat(4, 1fr);
  }
}

.trust-item {
  text-align: center;
  color: #fff;
}

.trust-item strong {
  display: block;
  font-size: 24px;
  font-weight: 900;
  margin-bottom: 4px;
  color: var(--azure);
  letter-spacing: -0.02em;
}

.trust-item span {
  font-size: 13px;
  opacity: 0.9;
  font-weight: 500;
}

/* === REVIEW CAROUSEL === */
.review-carousel {
  position: relative;
  overflow: hidden;
  padding: 96px 0 104px; /* Increased vertical padding for breathability */
  background-color: #fafbfc;
  background-image: linear-gradient(180deg, #fafbfc 0%, #f5f7fa 50%, #ffffff 100%);
}

/* Track container to handle overflow properly */
.review-track-container {
  overflow: hidden;
  max-width: 1280px; /* Slightly wider to let cards breathe */
  margin: 0 auto;
  padding: 0 24px; /* Balanced outer padding */
}

/* Softer, subtle top fade instead of hard line */
.review-carousel::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 64px;
  background: linear-gradient(180deg, rgba(248, 249, 251, 1) 0%, rgba(248, 249, 251, 0) 100%);
  pointer-events: none;
  z-index: 10;
}

/* Softer bottom fade */
.review-carousel::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 64px;
  background: linear-gradient(0deg, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0) 100%);
  pointer-events: none;
  z-index: 10;
}

.review-carousel-header {
  text-align: center;
  margin-bottom: 56px; /* More space between header and cards */
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  padding: 0 16px;
  position: relative;
  z-index: 20;
}

.review-carousel-header h2 {
  font-size: 36px; /* Larger headline */
  font-weight: 900;
  color: var(--cobalt);
  margin-bottom: 16px;
  letter-spacing: -0.03em;
}

.review-carousel-header p {
  font-size: 18px;
  color: var(--muted);
  line-height: 1.6;
}

.review-track {
  display: flex;
  transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); /* Smoother ease-out */
  gap: 0;
  will-change: transform;
  width: 100%;
  padding-bottom: 40px; /* Space for shadows */
}

.review-card {
  flex: 0 0 calc(100% - 24px); /* Mobile: 1 card */
  background: #fff;
  border-radius: 24px; /* Softer corners */
  padding: 32px;
  box-shadow: 0 4px 20px rgba(10, 42, 90, 0.06); /* Cleaner shadow */
  border: 1px solid rgba(10, 42, 90, 0.06);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  display: flex;
  flex-direction: column;
  margin: 0 12px; /* 24px gap total */
  height: auto; /* Allow stretch */
  position: relative;
}

.review-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 32px rgba(10, 42, 90, 0.12);
  border-color: rgba(20, 147, 255, 0.3);
}

@media (min-width: 768px) {
  .review-card {
    flex: 0 0 calc(50% - 24px); /* Tablet: 2 cards */
  }
}

@media (min-width: 1024px) {
  .review-card {
    flex: 0 0 calc(33.333% - 24px); /* Desktop: 3 cards */
  }
}

.review-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.review-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--azure), var(--cobalt));
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-weight: 700;
  font-size: 18px;
}

.review-meta {
  flex: 1;
}

.review-name {
  font-weight: 700;
  color: var(--cobalt);
  margin-bottom: 2px;
  font-size: 15px;
}

.review-stars {
  color: #fbbf24;
  font-size: 14px;
  letter-spacing: 2px;
}

.review-time {
  font-size: 12px;
  color: #9ca3af;
  margin-top: 2px;
  font-weight: 500;
}

.review-text {
  color: #4b5563;
  line-height: 1.65;
  font-size: 15px;
  margin-bottom: 16px;
  flex-grow: 1;
  max-height: none; /* Allow natural height */
  position: relative;
}

/* Quote marks for authenticity */
.review-text::before {
  content: '"';
  position: absolute;
  top: -8px;
  left: -12px;
  font-size: 48px;
  font-weight: 900;
  color: rgba(20, 147, 255, 0.1);
  line-height: 1;
  font-family: Georgia, serif;
}

.review-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-top: auto;
  padding-top: 16px;
  border-top: 1px solid rgba(10, 42, 90, 0.06);
}

.review-service {
  font-size: 13px;
  color: var(--azure);
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.review-service::before {
  content: '\2192';
  font-weight: 900;
}

.review-verified {
  font-size: 11px;
  color: #10b981;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: rgba(16, 185, 129, 0.08);
  padding: 4px 8px;
  border-radius: 6px;
  white-space: nowrap;
}

.review-verified::before {
  content: '\2713';
  font-size: 13px;
  font-weight: 900;
}

.review-nav {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 24px;
}

.review-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #d1d5db;
  cursor: pointer;
  transition: all 0.3s ease;
}

.review-dot.active {
  background: var(--azure);
  width: 24px;
  border-radius: 4px;
}

/* === PACKAGE GRID === */
.package-grid {
  display: grid;
  gap: 16px;
  grid-template-columns: 1fr;
}

@media (min-width: 640px) {
  .package-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 1024px) {
  .package-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

/* === PACKAGE CARD === */
.package {
  background: #fff;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 24px 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  transition: all 0.2s ease;
  position: relative;
  /* Performance: Defer rendering of off-screen packages */
  content-visibility: auto;
  contain-intrinsic-size: 0 450px;
}

.package:hover {
  border-color: var(--azure);
  box-shadow: var(--shadow-lg);
  transform: translateY(-2px);
}

.package.featured {
  border-color: var(--azure);
  border-width: 2px;
  box-shadow: var(--shadow-md);
}

.package.featured::before {
  content: 'Recommended';
  position: absolute;
  top: 8px;
  right: 8px;
  left: auto;
  transform: none;
  background: var(--azure);
  color: #fff;
  font-size: 8px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  padding: 2px 5px;
  border-radius: 3px;
  box-shadow: 0 1px 2px rgba(10, 102, 194, 0.12);
  line-height: 1.2;
}

.package-header {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.package-name {
  font-size: 19px;
  font-weight: 900;
  color: var(--cobalt);
  line-height: 1.2;
}

.package-price {
  font-size: 15px;
  font-weight: 800;
  color: var(--azure);
}

.package-promise {
  font-size: 14px;
  color: var(--ink);
  opacity: 0.88;
  line-height: 1.5;
  flex-grow: 1;
}

.package-includes {
  background: #f8f9fb;
  border-radius: 8px;
  padding: 12px;
  font-size: 13px;
  line-height: 1.5;
  color: var(--cobalt);
}

.package-includes strong {
  display: block;
  font-weight: 800;
  margin-bottom: 6px;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  opacity: 0.7;
}

.package-includes ul {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.package-includes li::before {
  content: '\2713';
  color: var(--azure);
  font-weight: 900;
  margin-right: 6px;
}

.package .btn {
  width: 100%;
}

/* === DEFERRED CSS: Loaded after First Contentful Paint === */
/* Menu drawer, cart drawer, modals, backdrops - not needed for initial render */
</style>

<style media="print" onload="this.media='all'" id="deferred-ui-styles">
/* This CSS loads async - doesn't block render */

/* === MENU DRAWER === */
.menu-drawer {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  width: min(320px, 85vw);
  background: #fff;
  z-index: 1001; /* Above backdrop (1000) so it's not dimmed */
  transform: translateX(-100%);
  transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 4px 0 16px rgba(0,0,0,.1);
  display: flex;
  flex-direction: column;
}

.menu-drawer.open {
  transform: translateX(0);
}

.menu-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.menu-header h3 {
  font-size: 16px;
  font-weight: 900;
  color: var(--cobalt);
}

.menu-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

.menu-nav {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.menu-link {
  appearance: none;
  border: none;
  background: transparent;
  font-family: inherit;
  text-align: left;
  padding: 12px;
  font-size: 15px;
  font-weight: 600;
  color: var(--cobalt);
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.15s ease;
  text-decoration: none;
}

.menu-link:hover {
  background: #f5f7fa;
}

/* === CART DRAWER === */
.cart-drawer {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  width: min(420px, 92vw);
  background: #fff;
  z-index: 1001; /* Above backdrop (1000) so it's not dimmed */
  transform: translateX(100%);
  transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: -4px 0 16px rgba(0,0,0,.1);
  display: flex;
  flex-direction: column;
}

.cart-drawer.open {
  transform: translateX(0);
}

.cart-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.cart-title {
  font-size: 18px;
  font-weight: 900;
  color: var(--cobalt);
}

.cart-body {
  flex: 1;
  overflow-y: auto;
  padding: 0 20px;
  padding-bottom: 16px;
}

.cart-empty {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.cart-empty::before {
  content: "";
  display: block;
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.cart-empty p {
  font-size: 15px;
  color: var(--muted);
  margin: 0;
}

/* Bundle recommendations panel */
.bundle-panel {
  margin-bottom: 16px;
  padding: 12px;
  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
  border: 1px solid #ffd97d;
  border-radius: 12px;
}

.bundle-card {
  background: #fff;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
}

.bundle-card:last-child {
  margin-bottom: 0;
}

.b-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.b-name {
  font-weight: 800;
  color: var(--cobalt);
  font-size: 15px;
}

.b-save {
  font-weight: 800;
  color: #28a745;
  font-size: 14px;
}

.b-list {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 10px;
}

.b-actions button {
  width: 100%;
}

/* Sign-in banner */
.signin-banner {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border: 1px solid #90caf9;
  border-radius: 12px;
  margin-bottom: 16px;
  font-size: 13px;
  color: var(--cobalt);
}

.signin-banner strong {
  display: block;
  font-size: 14px;
  margin-bottom: 4px;
}

/* AI Recommendations Panel */
.ai-recs-panel {
  margin-bottom: 16px;
  padding: 14px;
  background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
  border: 1px solid #ce93d8;
  border-radius: 12px;
}

.ai-recs-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.ai-icon {
  font-size: 20px;
}

.ai-title {
  font-weight: 800;
  font-size: 15px;
  color: #6a1b9a;
}

.ai-recs-list {
  display: grid;
  gap: 10px;
}

.ai-rec-card {
  padding: 12px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.ai-rec-name {
  font-weight: 700;
  font-size: 14px;
  color: var(--ink);
  margin-bottom: 4px;
}

.ai-rec-reason {
  font-size: 12px;
  color: var(--muted);
  font-style: italic;
  line-height: 1.4;
}

.ai-rec-price {
  font-weight: 600;
  font-size: 13px;
  color: var(--cobalt);
}

/* Bundle Panel (smart swap suggestions) */
.bundle-panel {
  margin-bottom: 16px;
  display: grid;
  gap: 10px;
}

.bundle-card {
  padding: 14px;
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  border: 1px solid #ffb74d;
  border-radius: 12px;
}

.b-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.b-name {
  font-weight: 800;
  font-size: 15px;
  color: #e65100;
}

.b-save {
  font-weight: 700;
  font-size: 13px;
  color: #ff6f00;
  background: white;
  padding: 4px 8px;
  border-radius: 6px;
}

.b-list {
  font-size: 12px;
  color: #6d4c41;
  margin-bottom: 10px;
  line-height: 1.4;
}

.b-actions {
  display: flex;
  gap: 8px;
}

.b-actions .btn {
  flex: 1;
  padding: 8px 12px;
  font-size: 13px;
}

/* Rule-based Recommendations */
.recs-panel {
  margin-bottom: 16px;
  display: grid;
  gap: 10px;
}

.rec-card {
  display: grid;
  grid-template-columns: 60px 1fr auto;
  gap: 12px;
  padding: 12px;
  background: white;
  border: 1px solid var(--border);
  border-radius: 10px;
  align-items: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

.rec-card img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
}

.r-text {
  flex: 1;
}

.r-title {
  font-weight: 700;
  font-size: 14px;
  color: var(--ink);
  margin-bottom: 3px;
}

.r-msg {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
  line-height: 1.3;
}

.rec-dismiss {
  font-size: 11px;
  color: #999;
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  text-decoration: underline;
}

.rec-dismiss:hover {
  color: #666;
}

.r-price {
  font-weight: 800;
  font-size: 14px;
  color: var(--cobalt);
  margin-bottom: 6px;
  text-align: right;
}

.rec-card .btn {
  padding: 6px 12px;
  font-size: 12px;
  white-space: nowrap;
}

/* Cart lines */
.cart-lines {
  display: flex;
  flex-direction: column;
  gap: 0;
  padding-top: 16px;
}

.cart-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 20px 0;
  border-bottom: 1px solid var(--border);
  gap: 16px;
}

.cart-item:last-child {
  border-bottom: none;
}

.cart-item-info {
  flex: 1;
  min-width: 0;
}

.cart-item-name {
  font-weight: 800;
  font-size: 16px;
  color: var(--ink);
  margin-bottom: 6px;
  line-height: 1.3;
}

.cart-item-price {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 14px;
  font-weight: 500;
}

.cart-qty-controls {
  display: flex;
  align-items: center;
  gap: 10px;
}

.cart-qty-btn {
  width: 32px;
  height: 32px;
  border: 2px solid var(--cobalt);
  background: white;
  color: var(--cobalt);
  border-radius: 6px;
  cursor: pointer;
  font-size: 18px;
  font-weight: 800;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s ease;
  padding: 0;
  line-height: 1;
}

.cart-qty-btn:hover {
  background: var(--cobalt);
  color: white;
}

.cart-qty-btn:active {
  transform: scale(0.92);
}

.cart-qty-value {
  font-weight: 700;
  color: var(--cobalt);
  min-width: 20px;
  text-align: center;
  font-size: 14px;
}

.cart-item-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
}

.cart-item-total {
  font-weight: 900;
  font-size: 19px;
  color: var(--ink);
  white-space: nowrap;
  letter-spacing: -0.5px;
}

.cart-remove-btn {
  font-size: 13px;
  font-weight: 700;
  color: #dc3545;
  background: none;
  border: none;
  cursor: pointer;
  padding: 6px 0;
  text-decoration: none;
  transition: all 0.15s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.cart-remove-btn:hover {
  color: #c82333;
  text-decoration: underline;
}

.cart-foot {
  border-top: 1px solid var(--border);
  padding: 16px;
  background: #f8f9fb;
}

/* Error display */
.checkout-error {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  background: #fee;
  border: 1px solid #fcc;
  border-radius: 8px;
  margin-bottom: 12px;
  font-size: 13px;
  color: #c33;
}

.checkout-error[hidden] {
  display: none !important;
}

.error-dismiss {
  appearance: none;
  border: none;
  background: none;
  font-size: 20px;
  line-height: 1;
  color: #c33;
  cursor: pointer;
  padding: 0;
  width: 20px;
  height: 20px;
}

/* Totals */
.totals {
  margin-bottom: 16px;
  padding-top: 12px;
}

.kv {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  font-size: 15px;
  font-weight: 600;
  color: var(--ink);
}

.kv strong {
  font-weight: 900;
  color: var(--ink);
  font-size: 20px;
  letter-spacing: -0.5px;
}

.note {
  font-size: 12px;
  color: var(--muted);
  margin-top: 6px;
}

/* Footer actions */
.foot-actions {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}

.foot-actions .btn {
  font-weight: 700;
  padding: 14px 20px;
  font-size: 15px;
  border-radius: 8px;
}

.foot-actions .btn-ghost {
  flex: 0 0 auto;
  background: white;
  border: 2px solid var(--border);
  color: var(--cobalt);
}

.foot-actions .btn-ghost:hover {
  border-color: var(--cobalt);
  background: white;
}

.foot-actions .btn-primary {
  flex: 1;
  font-weight: 800;
  letter-spacing: 0.5px;
}

.cart-empty {
  text-align: center;
  color: var(--muted);
  padding: 40px 20px;
  font-size: 14px;
}

/* === BACKDROP === */
.backdrop {
  position: fixed;
  inset: 0;
  background: rgba(11,20,32,.4);
  /* raised so modals/backdrops sit under banner but above content */
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.28s ease;
}

.backdrop.show {
  opacity: 1;
  pointer-events: auto;
}

/* === MODAL === */
.modal {
  position: fixed;
  inset: 0;
  /* modal should sit under the urgency banner but above the dim backdrop */
  z-index: 1100;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.28s ease;
}

.modal.show {
  opacity: 1;
  pointer-events: auto;
}

.modal-content {
  background: #fff;
  border-radius: 16px 16px 0 0;
  width: 100%;
  max-width: 520px;
  max-height: 85vh;
  display: flex;
  flex-direction: column;
  transform: translateY(100%);
  transition: transform 0.32s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 -4px 24px rgba(0,0,0,.15);
}

/* modal input styling to match form styles */
.modal .inp,
.modal-content .inp,
.modal-content textarea {
  padding: 12px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 15px;
  width: 100%;
  box-sizing: border-box;
}
.modal .inp:focus,
.modal-content .inp:focus,
.modal-content textarea:focus {
  outline: none;
  border-color: var(--azure);
  box-shadow: 0 0 0 4px rgba(20,147,255,0.06);
}

/* Scrollbar styling (WebKit + modern) - Dark gunmetal theme */
::-webkit-scrollbar {
  width: 12px;
  height: 12px;
}
::-webkit-scrollbar-track {
  background: #1a1d23;
  border-radius: 10px;
}
::-webkit-scrollbar-thumb {
  background: #3a3f47;
  border-radius: 10px;
  border: 3px solid #1a1d23;
}
::-webkit-scrollbar-thumb:hover {
  background: #4a505a;
}
/* Firefox */
* { scrollbar-width: thin; scrollbar-color: #3a3f47 #1a1d23; }

.modal.show .modal-content {
  transform: translateY(0);
}

.modal-header {
  padding: 24px 20px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  font-size: 22px;
  font-weight: 900;
  color: var(--cobalt);
  margin-bottom: 6px;
}

.modal-header p {
  font-size: 14px;
  color: var(--muted);
  line-height: 1.5;
}

.close-btn {
  appearance: none;
  border: none;
  background: transparent;
  font-size: 32px;
  line-height: 1;
  color: var(--muted);
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.15s ease;
}

.close-btn:hover {
  color: var(--cobalt);
}

.modal-body {
  padding: 20px;
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  position: relative;
}

.modal-body::after {
  content: '';
  position: sticky;
  bottom: -20px;
  left: 0;
  right: 0;
  height: 20px;
  background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.95));
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
}

.modal-body.has-scroll::after {
  opacity: 1;
}

.modal-footer {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 10px;
  background: #fff;
  flex-shrink: 0;
  position: sticky;
  bottom: 0;
  z-index: 10;
}

/* === UTILITIES === */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0,0,0,0);
  white-space: nowrap;
  border: 0;
}

.hidden {
  display: none !important;
}

/* === LOADER === */
.h2s-loader {
  position: fixed;
  inset: 0;
  z-index: 99999;
  display: grid;
  place-items: center;
  background: rgba(255,255,255,0.98);
  backdrop-filter: blur(8px);
  pointer-events: auto;
  opacity: 1;
  transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.h2s-loader.hidden {
  opacity: 0;
  pointer-events: none;
}
.h2s-loader-stage {
  position: relative;
  width: min(72vw, 520px);
  aspect-ratio: 5/2;
}
.h2s-loader-slices {
  position: absolute;
  inset: 0;
}
.h2s-loader-slice {
  position: absolute;
  top: 0;
  bottom: 0;
  overflow: hidden;
  opacity: 0;
  transform: translateY(24px);
  will-change: transform, opacity;
  animation: h2s-split 2.2s cubic-bezier(.22,.8,.32,1) infinite;
  animation-delay: calc(var(--i) * 0.06s);
}
.h2s-loader-slice img {
  position: absolute;
  inset: 0 auto 0 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
}
@keyframes h2s-split {
  0% { opacity: 0; transform: translateY(24px); }
  36% { opacity: 1; transform: translateY(0); }
  68% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(-12px); }
}

/* === SKELETON LOADING STATES === */
.skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: skeleton-shimmer 1.5s ease-in-out infinite;
  border-radius: 8px;
}
@keyframes skeleton-shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
.skeleton-hero {
  height: 280px;
  margin-bottom: 24px;
}
.skeleton-trust {
  height: 80px;
  margin-bottom: 32px;
}
.skeleton-card {
  height: 420px;
  border-radius: 16px;
  margin-bottom: 16px;
}
.skeleton-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  padding: 0 16px;
  max-width: 1200px;
  margin: 0 auto;
}

/* === SMOOTH CONTENT REVEAL === */
.content-reveal {
  opacity: 0;
  transform: translateY(16px);
  animation: reveal-fade-in 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}
@keyframes reveal-fade-in {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.reveal-delay-1 { animation-delay: 0.05s; }
.reveal-delay-2 { animation-delay: 0.1s; }
.reveal-delay-3 { animation-delay: 0.15s; }
.reveal-delay-4 { animation-delay: 0.2s; }

/* Prevent layout shift */
#outlet {
  min-height: calc(100vh - 56px);
  /* contain: layout; REMOVED to allow hero full-bleed overflow */
}

/* Initial page load - hide content until ready */
/* OPTIMIZATION: Removed opacity:0 to allow immediate LCP paint of static content */
body:not(.app-ready) #outlet > * {
  /* opacity: 0; REMOVED */
}

body.app-ready #outlet > * {
  /* animation: initial-reveal 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; REMOVED */
}

@keyframes initial-reveal {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (prefers-reduced-motion: reduce) {
  .h2s-loader-slice,
  .content-reveal,
  .skeleton {
    animation: none !important;
  }
  .content-reveal {
    opacity: 1;
    transform: none;
  }
  .h2s-loader {
    transition: none;
  }
}

/* === DESKTOP TWEAKS === */
@media (min-width: 768px) {
  .hero {
    padding: 88px 32px 72px;
  }

  .hero h1 {
    font-size: 42px;
  }

  .hero p {
    font-size: 19px;
  }

  .trust-bar {
    padding: 32px 24px;
  }

  .section {
    padding: 80px 24px;
  }

  .section-header h2 {
    font-size: 36px;
  }

  .section-header p {
    font-size: 18px;
  }

  .review-carousel {
    padding: 64px 24px;
  }

  .modal-content {
    border-radius: 16px;
    max-height: 90vh;
  }
}

/* === AUTH FORMS & ACCOUNT === */
.form {
  max-width: 480px;
  margin: 80px auto 40px;
  padding: 32px;
  background: white;
  border-radius: 16px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-md);
}

.form h2 {
  text-align: center;
  color: var(--cobalt);
  margin: 0 0 24px 0;
  font-weight: 900;
  font-size: 28px;
}

.inp {
  display: block;
  width: 100%;
  padding: 14px 16px;
  margin-bottom: 14px;
  font-size: 16px;
  font-family: inherit;
  border: 2px solid var(--border);
  border-radius: 10px;
  background: white;
  color: var(--ink);
  transition: all 0.2s ease;
}

.inp:focus {
  outline: none;
  border-color: var(--azure);
  box-shadow: 0 0 0 3px rgba(20, 147, 255, 0.1);
}

.inp:disabled {
  background: #f5f5f5;
  color: var(--muted);
  cursor: not-allowed;
  border-color: #e0e0e0;
}

.form .help {
  font-size: 13px;
  color: var(--muted);
  margin: -6px 0 16px 0;
  text-align: center;
}

.form > div[style*="display:flex"] {
  justify-content: center;
  margin-top: 20px;
}

.pd-box {
  padding: 16px;
  background: #fafcff;
  border: 1px solid #e7eaf0;
  border-radius: 10px;
  margin-bottom: 16px;
}

.details-grid {
  display: grid;
  gap: 8px;
}

.details-grid .row {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 12px;
  padding: 8px 0;
  border-bottom: 1px solid #e7eaf0;
}

.details-grid .row:last-child {
  border-bottom: none;
}

.details-grid .k {
  font-weight: 600;
  color: var(--muted);
  font-size: 13px;
}

.details-grid .v {
  font-weight: 700;
  color: var(--cobalt);
  font-size: 14px;
}

.cal-embed {
  width: 100%;
  height: 680px;
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  margin: 20px 0;
}

.cal-embed iframe {
  width: 100%;
  height: 100%;
  border: none;
}

@media (max-width: 768px) {
  .form {
    margin: 20px;
    padding: 20px;
  }

  .details-grid .row {
    grid-template-columns: 1fr;
    gap: 4px;
  }

  .cal-embed {
    height: 600px;
  }
}

/* Critical: Instant page shell visibility */
#pageShell {
  opacity: 1 !important;
  visibility: visible !important;
  /* contain: content; REMOVED to allow hero full-bleed overflow */
}

/* Loading skeleton for better perceived performance */
.skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: loading 1.5s ease-in-out infinite;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.bundle-skeleton {
  height: 400px;
  border-radius: 12px;
  margin-bottom: 20px;
}

/* End deferred UI styles */
</style>

<!-- Performance: Remove API preload - catalog now loads in background -->

</head>
<body>

<!-- URGENCY BANNER -->
<div class="urgency-banner" id="urgencyBanner">
  <div class="urgency-text">
    <span><strong id="urgencyMessage">Loading...</strong></span>
    <span class="urgency-separator">|</span>
    <span>We're available 7 days/week</span>
  </div>
  <button class="urgency-close" onclick="dismissUrgencyBanner()" aria-label="Dismiss banner">?&mdash;</button>
</div>

<!-- HEADER -->
<header class="header">
  <div class="header-inner">
    <a href="#" class="logo" aria-label="Home2Smart home" onclick="navSet({view:'shop'}); return false;">
      <img src="https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68da0ce6f00445991d64a63f.png" alt="Home2Smart" class="logo-img" width="36" height="36" fetchpriority="high" decoding="async">
    </a>

    <div class="header-actions">
      <button class="menu-btn" onclick="toggleMenu()" aria-label="Open menu">
        <svg class="icon" viewBox="0 0 24 24">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>

      <button id="accountBtn" class="header-btn" aria-label="Account">
        <svg class="icon" viewBox="0 0 24 24">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </button>

      <button class="cart-btn" onclick="toggleCart()" aria-label="Open cart">
        <svg class="icon" viewBox="0 0 24 24">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        <span class="cart-badge" id="cartCount">0</span>
      </button>
    </div>
  </div>
</header>

<!-- Main Outlet for Dynamic Views -->
<main id="pageShell">
<div id="outlet">
<!-- HERO -->
<section class="hero">
  <div class="hero-inner">
    <h1>Expert Installation.<br>Done Right.</h1>
    <p>TV Mounting & Security Cameras. Pick a package, we handle the rest. Simple pricing, instant booking.</p>
    <div class="hero-ctas">
      <button class="btn btn-primary" onclick="scrollToSection('tv')">
        Shop TV Packages
      </button>
      <button class="btn btn-ghost" onclick="scrollToSection('security')">
        Shop Cameras
      </button>
    </div>
    
    <!-- Hero Review Carousel -->
    <div class="hero-reviews" id="heroReviews" style="min-height: 120px; contain: content;">
      <!-- OPTIMIZATION: Placeholder matches final structure to prevent CLS -->
      <div class="hero-review-slide active">
        <div class="hero-review-stars">&#9733;&#9733;&#9733;&#9733;&#9733;</div>
        <div class="hero-review-text">"Professional, on-time, and clean installation."</div>
        <div class="hero-review-author">&mdash; Recent Customer</div>
      </div>
      <div class="hero-review-dots">
        <div class="hero-review-dot active"></div>
        <div class="hero-review-dot"></div>
        <div class="hero-review-dot"></div>
        <div class="hero-review-dot"></div>
        <div class="hero-review-dot"></div>
      </div>
    </div>
  </div>
</section>

<!-- TRUST BAR -->
<section class="trust-bar content-reveal reveal-delay-1">
  <div class="trust-inner">
    <div class="trust-item">
      <strong>500+</strong>
      <span>Homes Served</span>
    </div>
    <div class="trust-item">
      <strong>4.9&#9733;</strong>
      <span>Average Rating</span>
    </div>
    <div class="trust-item">
      <strong>Licensed</strong>
      <span>& Insured</span>
    </div>
    <div class="trust-item">
      <strong>Same-Day</strong>
      <span>Service Available</span>
    </div>
  </div>
</section>

<!-- TV MOUNTING SECTION -->
<section class="section content-reveal reveal-delay-2" id="tv">
  <div class="section-header">
    <h2>How many TVs?</h2>
    <p>Clean installs, same-day setup. First TV $249, each additional discounted.</p>
  </div>

  <div class="package-grid">
    <!-- Single TV -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Single TV Mount</h3>
        <div class="package-price">$249</div>
      </div>
      <p class="package-promise">One TV mounted clean and ready to watch tonight.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>TV securely mounted</li>
          <li>All wires hidden</li>
          <li>Streaming setup</li>
          <li>Ready to go</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('tv_single', 'Single TV Mount', 249)">
        Add to Cart
      </button>
    </article>

    <!-- 2-TV Package (FEATURED) -->
    <article class="package featured">
      <div class="package-header">
        <h3 class="package-name">2-TV Package</h3>
        <div class="package-price">$428 <small style="opacity:.6">(save $70)</small></div>
      </div>
      <p class="package-promise">Two rooms, theater-ready. Same visit, better deal.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>Both TVs mounted</li>
          <li>All wiring concealed</li>
          <li>Streaming on both</li>
          <li>One appointment</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('tv_2pack', '2-TV Package', 428)">
        Add to Cart
      </button>
    </article>

    <!-- Multi-Room -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Multi-Room (3-4 TVs)</h3>
        <div class="package-price">$699-$899</div>
      </div>
      <p class="package-promise">Whole-home entertainment in one visit.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>3-4 TVs mounted</li>
          <li>All wiring concealed</li>
          <li>Streaming + soundbar</li>
          <li>Universal remote</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('tv_multi', 'Multi-Room Package', 699)">
        Add to Cart
      </button>
    </article>

    <!-- Custom -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">5+ TVs (Custom)</h3>
        <div class="package-price">Request Quote</div>
      </div>
      <p class="package-promise">Large properties or commercial setups&mdash;we'll design a plan.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>Site consultation</li>
          <li>Custom wiring plan</li>
          <li>Volume pricing</li>
          <li>Project manager</li>
        </ul>
      </div>
      <button class="btn btn-secondary" onclick="safeRequestQuote('tv_custom')">
        Request Quote
      </button>
    </article>
  </div>
</section>

<!-- SECURITY CAMERAS SECTION -->
<section class="section" id="security">
  <div class="section-header">
    <h2>How many cameras do you need?</h2>
    <p>Front door only, full perimeter, or something in betweenwe'll cover what matters. Great for homes, storefronts, warehouses, and offices.</p>
  </div>

  <div class="package-grid">
    <!-- Basic Coverage -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Basic Coverage</h3>
        <div class="package-price">$599</div>
      </div>
      <p class="package-promise">Front door secure. See who's there, every time.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>2 cameras + doorbell</li>
          <li>Mobile alerts</li>
          <li>7-day cloud storage</li>
          <li>App setup</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('cam_basic', 'Basic Coverage', 599)">
        Add to Cart
      </button>
    </article>

    <!-- Standard Coverage (FEATURED) -->
    <article class="package featured">
      <div class="package-header">
        <h3 class="package-name">Standard Coverage</h3>
        <div class="package-price">$1,199</div>
      </div>
      <p class="package-promise">Front, driveway, and backyard-full visibility where it matters.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>4 cameras + doorbell</li>
          <li>Mobile alerts</li>
          <li>30-day cloud storage</li>
          <li>App + pro setup</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('cam_standard', 'Standard Coverage', 1199)">
        Add to Cart
      </button>
    </article>

    <!-- Premium Coverage -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Premium Coverage</h3>
        <div class="package-price">$2,199</div>
      </div>
      <p class="package-promise">Full perimeter + NVR recording. Total property protection.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>8 cameras + doorbell</li>
          <li>Local NVR recording</li>
          <li>60-day cloud storage</li>
          <li>Dedicated support</li>
        </ul>
      </div>
      <button class="btn btn-primary" onclick="selectPackage('cam_premium', 'Premium Coverage', 2199)">
        Add to Cart
      </button>
    </article>

    <!-- Custom -->
    <article class="package">
      <div class="package-header">
        <h3 class="package-name">Custom Security</h3>
        <div class="package-price">Request Quote</div>
      </div>
      <p class="package-promise">Businesses, estates, unique needs-custom designs available.</p>
      <div class="package-includes">
        <strong>What's Included</strong>
        <ul>
          <li>Site survey</li>
          <li>Custom camera plan</li>
          <li>Volume pricing</li>
          <li>Ongoing support</li>
        </ul>
      </div>
      <button class="btn btn-secondary" onclick="safeRequestQuote('cam_custom')">
        Request Quote
      </button>
    </article>
  </div>
</section>
</div>
<!-- End Outlet -->
</main>

<!-- Global Loader Overlay -->
<div id="h2s-loader" class="h2s-loader" aria-hidden="true" style="display:none">
  <div class="h2s-loader-stage">
    <div id="h2sLoaderSlices" class="h2s-loader-slices"></div>
  </div>
</div>

<!-- MENU DRAWER -->
<aside class="menu-drawer" id="menuDrawer" style="content-visibility: auto;">
  <div class="menu-header">
    <h3>Menu</h3>
    <button class="btn-subtle" onclick="toggleMenu()" style="padding: 6px 10px; font-size: 13px;">Close</button>
  </div>
  <nav class="menu-body">
    <div class="menu-nav">
      <a href="/" class="menu-link">Home</a>
      <button class="menu-link" onclick="scrollToSection('tv'); toggleMenu();">TV Mounting</button>
      <button class="menu-link" onclick="scrollToSection('security'); toggleMenu();">Security Cameras</button>
      <button class="menu-link" onclick="openBooking(); toggleMenu();">Schedule Appointment</button>
      <a href="tel:864-528-1475" class="menu-link">Call: 864-528-1475</a>
    </div>
  </nav>
</aside>

<!-- CART DRAWER -->
<aside class="cart-drawer" id="cartDrawer" onclick="event.stopPropagation()" style="content-visibility: auto;">
  <div class="cart-header">
    <h3 class="cart-title">Your Cart</h3>
    <button class="btn-subtle" onclick="toggleCart()" style="padding: 6px 10px; font-size: 13px;">Close</button>
  </div>
  
  <!-- Scrollable body -->
  <div class="cart-body">
    <!-- AI Recommendations Panel -->
    <div id="aiRecommendationsPanel" class="ai-recs-panel" style="display:none;min-height:80px">
      <div class="ai-recs-header">
        <div class="ai-icon">&#10024;</div>
        <div class="ai-title">Recommended for you</div>
      </div>
      <div id="aiRecommendations" class="ai-recs-list"></div>
    </div>
    
    <!-- Bundle recommendations (smart swap suggestions) -->
    <div id="bundlePanel" class="bundle-panel" style="display:none;min-height:60px"></div>
    
    <!-- Rule-based Recommendations -->
    <div id="recsPanel" class="recs-panel" style="display:none;min-height:60px"></div>
    
    <!-- Empty state -->
    <div id="cartEmpty" class="cart-empty" hidden>
      <p>Your cart is empty</p>
      <p style="font-size: 13px; margin-top: 8px;">Pick a package to get started</p>
    </div>
    
    <!-- Cart items -->
    <div id="cartItems" class="cart-lines">
      <!-- Items rendered by paintCart() -->
    </div>
  </div>
  
  <!-- Footer -->
  <div class="cart-foot">
    <!-- Error display -->
    <div id="checkoutError" class="checkout-error" role="alert" aria-live="polite" hidden>
      <span id="checkoutErrorMsg"></span>
      <button id="dismissError" class="error-dismiss" aria-label="Dismiss error">?&mdash;</button>
    </div>

    <!-- Promo Code -->
    <div class="promo-section" style="margin-bottom: 16px;">
      <div style="display: flex; gap: 8px;">
        <input type="text" id="promoCode" class="inp" placeholder="Promo code" style="padding: 8px 12px; font-size: 14px; flex: 1;">
        <button id="applyPromo" class="btn ghost" style="padding: 8px 14px; font-size: 13px; white-space: nowrap;">Apply</button>
      </div>
      <div id="promoMsg" class="help" style="margin-top: 6px; font-size: 12px;"></div>
    </div>
    
    <!-- Totals -->
    <div class="totals">
      <div class="kv" style="font-size: 14px; color: var(--muted);">
        <span id="cartItemCount">0 items</span>
        <span></span>
      </div>
      <div class="kv" style="padding-top: 8px; border-top: 1px solid var(--border);">
        <span>Subtotal</span>
        <strong id="cartSubtotal">$0.00</strong>
      </div>
      <div class="kv" id="promoLine" style="display: none; color: #10b981; font-weight: 600;">
        <span id="promoLineLabel">Promo</span>
        <span id="promoAmount">-$0.00</span>
      </div>
      <div class="kv" id="grandTotalLine" style="display: none; padding-top: 8px; border-top: 2px solid var(--cobalt); font-size: 18px; font-weight: 700; color: var(--cobalt);">
        <span>Grand Total</span>
        <span id="grandTotal">$0.00</span>
      </div>
      <div class="note">Final tax and fees shown at checkout.</div>
    </div>
    
    <!-- Actions -->
    <div class="foot-actions">
      <button class="btn btn-ghost" onclick="window.location.href='tel:864-528-1475'">
        Need Help?
      </button>
      <button id="checkoutBtn" class="btn btn-primary">
        Checkout
      </button>
    </div>
  </div>
</aside>

<!-- BACKDROP -->
<div class="backdrop" id="backdrop" onclick="if(event.target === this) closeAll()"></div>

<!-- QUOTE REQUEST MODAL -->
<div class="modal" id="quoteModal" style="content-visibility: hidden;">
  <div class="modal-content" style="max-width: 520px;">
    <div class="modal-header">
      <h3 id="quoteModalTitle">Request Custom Quote</h3>
      <p id="quoteModalSubtitle">Tell us what you need and we'll get back to you fast</p>
    </div>
    <div class="modal-body" style="padding: 24px;">
      <div style="background: #f5f9ff; border: 1px solid #d7eafc; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
        <div style="font-weight: 600; color: var(--cobalt); margin-bottom: 8px;"> What to include:</div>
        <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #6b778c; line-height: 1.6;">
          <li>Number of TVs or cameras</li>
          <li>Room locations</li>
          <li>Any special requirements</li>
          <li>Preferred installation date</li>
        </ul>
      </div>
      
      <div style="display: grid; gap: 16px;">
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">Your Name *</label>
          <input type="text" id="quoteName" class="inp" placeholder="John Smith" style="width: 100%;" required>
        </div>
        
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">Email *</label>
          <input type="email" id="quoteEmail" class="inp" placeholder="john@example.com" style="width: 100%;" required>
        </div>
        
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">Phone *</label>
          <input type="tel" id="quotePhone" class="inp" placeholder="(864) 528-1475" style="width: 100%;" required>
        </div>
        
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px;">Project Details</label>
          <textarea id="quoteDetails" class="inp" placeholder="Tell us about your project..." style="width: 100%; min-height: 100px; resize: vertical; font-family: inherit;"></textarea>
        </div>
        
        <div id="quoteMessage" class="help" style="margin-top: 4px;"></div>
      </div>
      
      <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
        <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 12px;"> Prefer to call?</div>
        <a href="tel:864-528-1475" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: #f5f9ff; border: 1px solid #d7eafc; border-radius: 8px; text-decoration: none; color: var(--cobalt); font-weight: 600; transition: all 0.2s;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
          </svg>
          <span>(864) 528-1475</span>
        </a>
      </div>
    </div>
    <div class="modal-footer" style="gap: 8px;">
      <button class="btn btn-primary" id="submitQuoteBtn" onclick="submitQuoteRequest()" style="flex: 1;">
        Send Request
      </button>
      <button class="btn btn-subtle" id="cancelQuoteBtn" onclick="safeCloseQuoteModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Package Selected</h3>
      <p id="modalSubtitle">We'll finalize the details during your free consultation.</p>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Dynamic content -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="modalPrimaryCTA" onclick="addPackageToCart()">Add to Cart</button>
      <button class="btn btn-subtle" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- SEO: Structured Data (JSON-LD) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "name": "Home2Smart",
  "description": "Professional smart home installation services including TV mounting and security camera installation",
  "url": "https://home2smart.com",
  "telephone": "+1-864-528-1475",
  "priceRange": "$$",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.9",
    "reviewCount": "500"
  },
  "areaServed": {
    "@type": "State",
    "name": "South Carolina"
  },
  "hasOfferCatalog": {
    "@type": "OfferCatalog",
    "name": "Installation Services",
    "itemListElement": [
      {
        "@type": "Offer",
        "itemOffered": {
          "@type": "Service",
          "name": "TV Mounting Installation",
          "description": "Professional TV mounting with wire concealment"
        },
        "price": "249",
        "priceCurrency": "USD"
      },
      {
        "@type": "Offer",
        "itemOffered": {
          "@type": "Service",
          "name": "Security Camera Installation",
          "description": "Complete security camera system installation"
        },
        "price": "599",
        "priceCurrency": "USD"
      }
    ]
  }
}
</script>

<!-- Performance: Detect when Archivo font loads and apply it -->
<script>
// Font loading handled by CSS font-display: swap
</script>

<script>
// (IIFE removed)
'use strict';

// Production-safe logger - only logs in development
const isDev = window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1') || window.location.hostname.includes('vercel.app');
const logger = {
  log: isDev ? console.log.bind(console) : () => {},
  warn: isDev ? console.warn.bind(console) : () => {},
  error: console.error.bind(console) // Always log errors
};

logger.log('[BundlesJS] Script loaded and executing');

function byId(id){ return document.getElementById(id); }

// === UTILITY FUNCTIONS ===
function money(cents) {
  if(typeof cents === 'number') {
    return '$' + cents.toFixed(2);
  }
  return '$0.00';
}

function escapeHtml(text) {
  if(!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// === API CONFIG ===
// NEW: Single aggregated endpoint (eliminates waterfall loading)
const BUNDLES_DATA_API = 'https://h2s-backend.vercel.app/api/bundles-data';
const API = 'https://h2s-backend.vercel.app/api/shop';
// MIGRATED: Booking now goes to Vercel (native scheduling)
const APIV1 = 'https://h2s-backend.vercel.app/api/schedule-appointment';
// MIGRATED: Analytics now goes to Vercel (was GAS DASH_URL)
const DASH_URL = 'https://h2s-backend.vercel.app/api/track';
const CAL_FORM_URL = 'https://api.leadconnectorhq.com/widget/booking/RjwOQacM3FAjRNCfm6uU';
const PIXEL_ID = '2384221445259822';

// === PERFORMANCE: Start Data Fetch Immediately ===
// We start this request parallel to JS parsing/execution so data is ready when we need it.
const bundlesFetchPromise = fetch(BUNDLES_DATA_API, { 
  cache: 'default',
  headers: { 'Accept': 'application/json' },
  priority: 'high' // Hint to browser this is important
}).then(res => res.json()).catch(err => {
  logger.warn('[Bundles] Aggregated fetch failed, will fallback:', err);
  return null;
});

// Session ID for tracking
let SESSION_ID = sessionStorage.getItem('h2s_session_id');
if(!SESSION_ID){
  SESSION_ID = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
  sessionStorage.setItem('h2s_session_id', SESSION_ID);
}

// === STATE ===
let catalog = { services:[], serviceOptions:[], priceTiers:[], bundles:[], bundleItems:[], recommendations:[], memberships:[], membershipPrices:[] };
let cart = loadCart();
let user = loadUser();
let lastSearch = '';
let lastCat = '';

// === EXTRA DEFERRED LOADER (Recommendations) ===
// Defers rule-based recommendations parsing & rendering to shrink initial JS parse.
let _extraDeferredPromise = null;
function loadExtraDeferred(){
  if(_extraDeferredPromise) return _extraDeferredPromise;
  _extraDeferredPromise = new Promise((resolve, reject)=>{
    const s = document.createElement('script');
    s.src = 'bundles-extra-deferred.js'; // local deferred module
    s.onload = resolve;
    s.onerror = reject;
    document.body.appendChild(s);
  });
  return _extraDeferredPromise;
}

// === BUNDLES DEFERRED LOADER (Checkout, Success, Auth) ===
let _bundlesDeferredPromise = null;
function loadBundlesDeferred(){
  if(_bundlesDeferredPromise) return _bundlesDeferredPromise;
  _bundlesDeferredPromise = new Promise((resolve, reject)=>{
    const s = document.createElement('script');
    s.src = 'bundles-deferred.js';
    s.onload = resolve;
    s.onerror = reject;
    document.body.appendChild(s);
  });
  return _bundlesDeferredPromise;
}
function queueRenderRecsPanel(){
  if(window._queuedRecs) return; // collapse bursts
  window._queuedRecs = true;
  const invoke = ()=> loadExtraDeferred().then(()=>{
    if(window.renderRecsPanel) window.renderRecsPanel();
    window._queuedRecs = false;
  });
  if('requestIdleCallback' in window){
    requestIdleCallback(invoke, {timeout:3000});
  } else {
    setTimeout(invoke, 1500);
  }
}

// === LOADER ===
function buildLoader(){
  const slices = byId('h2sLoaderSlices');
  if(!slices) return;
  const c1 = '#1493ff', c2 = '#0a2a5a', c3 = '#6b778c';
  const colors = [c1, c2, c3, c1, c2, c3, c1, c2];
  slices.innerHTML = colors.map((col, i)=>`<div class="h2s-loader-slice" style="background:${col};animation-delay:${i*0.05}s"></div>`).join('');
}
function showLoader(){ 
  const el=byId('h2s-loader'); 
  if(el){ 
    el.classList.remove('hidden');
    el.style.display=''; 
  } 
}
function hideLoader(){ 
  const el=byId('h2s-loader'); 
  if(el){ 
    el.classList.add('hidden');
    // Remove from DOM after transition
    setTimeout(() => { if(el.classList.contains('hidden')) el.style.display='none'; }, 400);
  } 
}

// Show skeleton loading state while content loads
function showSkeleton(){
  byId('outlet').innerHTML = `
    <div class="skeleton skeleton-hero"></div>
    <div class="skeleton skeleton-trust"></div>
    <div class="skeleton-grid">
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
    </div>
  `;
}

// === META PIXEL + TRACKING ===
function h2sTrack(event, data={}){
  const payload = {
    event,
    timestamp: new Date().toISOString(),
    session_id: SESSION_ID,
    user_email: user?.email||'',
    url: location.href,
    ...data
  };
  
  // Send to Meta Pixel if loaded
  if(typeof fbq !== 'undefined'){
    const params = buildAdvancedParams();
    fbq('track', event, data, params);
  }
  
  // Send to dashboard webhook
  fetch(DASH_URL, {
    method:'POST',
    body: JSON.stringify(payload)
  }).catch(err => logger.warn('Dashboard track failed:', err));
}

async function sha256(text){
  if(!crypto || !crypto.subtle) return '';
  try{
    const encoder = new TextEncoder();
    const data = encoder.encode(text);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }catch(_){ return ''; }
}

function buildAdvancedParams(){
  const params = {};
  if(user && user.email){
    sha256(user.email.trim().toLowerCase()).then(h => { if(h) params.em = h; });
    if(user.phone){
      const digits = user.phone.replace(/\D/g,'');
      sha256(digits).then(h => { if(h) params.ph = h; });
    }
    if(user.name){
      const parts = user.name.trim().toLowerCase().split(' ');
      if(parts[0]) sha256(parts[0]).then(h => { if(h) params.fn = h; });
      if(parts[parts.length-1]) sha256(parts[parts.length-1]).then(h => { if(h) params.ln = h; });
    }
  }
  return params;
}

// === INIT ===
async function init(){
  // Keep init minimal and fast
  
  // CRITICAL: Attach checkout button event listener
  const checkoutBtn = byId('checkoutBtn');
  if(checkoutBtn) {
    checkoutBtn.addEventListener('click', function(e) {
      logger.log('[Checkout] Button clicked via event listener');
      e.preventDefault();
      e.stopPropagation();
      checkout();
    });
    logger.log('[Init] Checkout button event listener attached');
  } else {
    logger.error('[Init] Checkout button not found!');
  }
  
  try {
    // PHASE 1: INSTANT - Minimal critical setup
    // Mark page as ready immediately for static content
    document.body.classList.add('app-ready');
    
    // OPTIMIZATION: Capture static shop HTML to avoid duplication in JS
    const outlet = byId('outlet');
    if(outlet && outlet.querySelector('.hero')) {
      window.shopHTML = outlet.innerHTML;
    }
    
    // PHASE 2: Essential UI setup (synchronous for immediate render)
    wireCart();
    // Defer badge update - not visible above fold
    if('requestIdleCallback' in window){
      requestIdleCallback(() => updateCartBadge(), {timeout: 1000});
    } else {
      setTimeout(() => updateCartBadge(), 250);
    }
    
    // PHASE 3: DETERMINE VIEW - Quick routing decision
    const view = getParam('view');
    const isSpecialView = view && view !== 'shop';
    
    // PHASE 4: RENDER IMMEDIATELY - Don't wait for anything
    route(); // Shows static content instantly for shop view
    
    
    // PHASE 5: BACKGROUND LOADS - Use pre-started fetch
    // We use the promise started at the top of the script
    
    // Process immediately after route (no setTimeout) to minimize delays
    bundlesFetchPromise.then(data => {        if (data) {
          // === SUCCESS PATH ===
          if(data.catalog){
            catalog = data.catalog;
            // Re-render only if needed (not on shop view with static content)
            if (isSpecialView) route();
          }
          
          if(data.reviews){
            allReviews = data.reviews;
            reviewsLoadedFromAPI = true;
            
            // Populate heroReviews from allReviews
            heroReviews = allReviews.slice(0, 5).map(r => ({
              text: r.text && r.text.trim() ? r.text.trim() : '',
              author: r.name || 'Customer',
              stars: r.rating || 5
            })).filter(r => r.text.length > 0);

            // Initialize hero reviews immediately for real names/words
            if(!isSpecialView){
              try { initHeroReviews(); } catch(e) { logger.warn('initHeroReviews error', e); }
              // Defer renderReviews to idle to avoid blocking main thread
              if('requestIdleCallback' in window){
                requestIdleCallback(() => { try { renderReviews(); } catch(e) { logger.warn('renderReviews error', e); } }, {timeout: 2000});
              } else {
                setTimeout(() => { try { renderReviews(); } catch(e) { logger.warn('renderReviews error', e); } }, 1500);
              }
            }
          }
        } else {
          // === FALLBACK PATH ===
          logger.warn('[Bundles] Aggregated data missing, using fallback');
          fetch(API + '?action=catalog').then(r => r.json()).then(d => {
            if(d.ok) catalog = d.catalog || catalog;
          });
          // Also try to load reviews separately since aggregation failed
          try { initHeroReviews(); } catch(e) { logger.warn('initHeroReviews error', e); }
        }
      });
    
    // Handle cart from URL
    const urlCart = getParam('cart');
    if(urlCart){
      const decoded = decodeCartFromUrl(urlCart);
      if(decoded.length){
        cart = decoded;
        saveCart();
        updateCartBadge();
        paintCart();
      }
    }
    
    // Clean URL - remove cart parameter
    const url = new URL(location.href);
    if(url.searchParams.has('cart')){
      url.searchParams.delete('cart');
      history.replaceState({}, '', url.toString());
    }
    
    // PHASE 6: DEFERRED FEATURES - Load after page is interactive
    // AI recommendations (only if signed in)
    if(user && user.email){
      requestIdleCallback(() => loadAIRecommendations(), { timeout: 3000 });
    }
    
    // Meta Pixel (deferred, low priority)
    if('requestIdleCallback' in window){
      requestIdleCallback(() => {
        try {
          // Only load pixel if user interacts or after 5s
          const loadPixel = () => {
            if(window.fbq) return;
            const script = document.createElement('script');
            script.innerHTML = `
              !function(f,b,e,v,n,t,s)
              {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
              n.callMethod.apply(n,arguments):n.queue.push(arguments)};
              if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
              n.queue=[];t=b.createElement(e);t.async=!0;
              t.src=v;s=b.getElementsByTagName(e)[0];
              s.parentNode.insertBefore(t,s)}(window, document,'script',
              'https://connect.facebook.net/en_US/fbevents.js');
              fbq('init', '${PIXEL_ID}');
              fbq('track', 'PageView');
            `;
            document.head.appendChild(script);
            
            const noscript = document.createElement('noscript');
            noscript.innerHTML = `<img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=${PIXEL_ID}&ev=PageView&noscript=1"/>`;
            document.body.appendChild(noscript);
          };
          
          // Delay pixel load to ensure LCP is done
          setTimeout(loadPixel, 6000);
        } catch(e) { logger.warn('Pixel init failed', e); }
      }, { timeout: 8000 });
    }
    
    // PHASE 7: ANALYTICS - Track page view (lowest priority)
    if('requestIdleCallback' in window){
      requestIdleCallback(() => h2sTrack('PageView'), {timeout: 4000});
    } else {
      setTimeout(() => h2sTrack('PageView'), 2500);
    }
    
    performance.mark('init-end');
    performance.measure('Total Init Time', 'init-start', 'init-end');
  } catch (err) {
    // Fallback: show content anyway
    document.body.classList.add('app-ready');
  }
}

// Ensure init runs after DOM is ready
if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', () => { try{ init(); }catch(e){ logger.error('[Init] Failed:', e); } });
} else {
  try{ init(); }catch(e){ logger.error('[Init] Failed:', e); }
}

// Fetch latest catalog from backend. If cacheBust is true, append a timestamp to force bypass.
async function fetchCatalogFromAPI(cacheBust = false){
  try{
    const url = API + '?action=catalog' + (cacheBust ? '&cb=' + Date.now() : '');
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok){
      logger.warn('[Catalog] HTTP', res.status);
      return false;
    }
    const data = await res.json();
    if(data && data.ok && data.catalog){
      catalog = data.catalog;
      return true;
    }
    logger.warn('[Catalog] Unexpected response while fetching catalog', data);
    return false;
  }catch(err){
    logger.warn('[Catalog] Fetch failed:', err);
    return false;
  }
}

// === ROUTING ===
function route(){
  const view = getParam('view');
  logger.log('[ROUTE] View parameter:', view);
  
  // CRITICAL: If redirecting to success page, hide outlet immediately to prevent flicker
  if(view === 'shopsuccess'){
    const outlet = byId('outlet');
    if(outlet){
      outlet.style.opacity = '0';
      outlet.style.visibility = 'hidden';
    }
    logger.log('[ROUTE] Calling renderShopSuccess()'); 
    renderShopSuccess(); 
    return; 
  }
  
  // Close any open modals/drawers when navigating
  closeAll();
  
  if(view === 'signin'){ renderSignIn(); return; }
  if(view === 'signup'){ renderSignUp(); return; }
  if(view === 'account'){ renderAccount(); return; }
  if(view === 'forgot'){ renderForgot(); return; }
  if(view === 'reset'){ renderReset(getParam('token')); return; }
  if(view === 'calreturn' || view === 'apptreturn'){ handleCalReturn(); return; }
  
  // Default: show shop
  const outlet = byId('outlet');
  if (!outlet) return;
  
  const hasShopContent = outlet.querySelector('.hero');
  
  if (!hasShopContent) {
    renderShop();
  } else {
    // Static shop content already loaded, ensure it's visible
    outlet.style.opacity = '1';
    outlet.style.transition = '';
    document.body.classList.add('app-ready');
    
    // Re-initialize hero reviews if they haven't loaded
    const heroReviews = document.getElementById('heroReviews');
    if (heroReviews && !heroReviews.querySelector('.hero-review-slide')) {
      // Wait for BUNDLES_DATA_API to return
    }
  }
}

function renderShop(){
  // OPTIMIZATION: If static content exists, do not re-render
  const outlet = byId('outlet');
  if(!outlet) return;
  if(outlet.querySelector('.hero')) return;

  const isFirstRender = !window.__shopRenderedOnce;
  
  // OPTIMIZATION: Use captured static HTML instead of huge string
  let html = window.shopHTML || '';
  
  if(!html){
    logger.warn('[Shop] Static HTML missing, reloading...');
    location.reload();
    return;
  }

  if (isFirstRender) {
    // Render immediately without transition
    outlet.style.opacity = '';
    outlet.style.transition = '';
    outlet.innerHTML = html;
    document.body.classList.add('app-ready');
    
    // Initialize reviews immediately after DOM update
    try { initHeroReviews(); } catch(e) { logger.warn('initHeroReviews error', e); }
    
    // Scroll to top
    window.scrollTo(0, 0);
    window.__shopRenderedOnce = true;
    
    // Update signin state
    renderSigninState();
  } else {
    // Transition out, then render, then transition in
    outlet.style.opacity = '0';
    outlet.style.transition = 'opacity 0.3s ease';
    
    setTimeout(() => {
      outlet.innerHTML = html;
      
      // Fade back in
      requestAnimationFrame(() => {
        outlet.style.opacity = '1';
        document.body.classList.add('app-ready');
      });
      
      // Initialize reviews
      try { initHeroReviews(); } catch(e) { logger.warn('initHeroReviews error', e); }
      
      // Update signin state
      renderSigninState();
      
      // Scroll to top
      window.scrollTo(0, 0);
      window.__shopRenderedOnce = true;
    }, 300); // Wait for fade out
  }
}

function navSet(params){
  const u = new URL(location.href);
  Object.entries(params||{}).forEach(([k,v])=>{
    if(v==null) u.searchParams.delete(k); else u.searchParams.set(k,v);
  });
  history.pushState({}, '', u.toString());
  route();
}

function getParam(k){
  const u = new URL(location.href);
  return u.searchParams.get(k);
}

function wireCart(){
  const acctBtn = byId('accountBtn');
  if(acctBtn){
    acctBtn.onclick = ()=> {
      closeAll();
      if(user && user.email){
        navSet({view:'account'});
      } else {
        navSet({view:'signin'});
      }
    };
  }
  
  const bsi = byId('bannerSignIn');
  if(bsi){
    bsi.onclick = ()=> {
      closeAll();
      navSet({view: user?.email ? 'account' : 'signin'});
    };
  }
}

function renderSigninState(){
  const btn = byId('accountBtn');
  if(!btn) return;
  
  if(user && user.email){
    btn.textContent = 'Account';
  } else {
    btn.textContent = 'Sign in';
  }
}

function scrollToSection(id){
  const el = document.getElementById(id);
  if(el){
    // Scroll with offset to account for fixed header (56px)
    const headerHeight = 56;
    const elementPosition = el.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - headerHeight - 16; // 16px extra padding
    
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }
}

// Expose to window for onclick handlers
window.scrollToSection = scrollToSection;

// === MENU / CART / MODAL TOGGLES ===
function toggleMenu(){
  const menu = document.getElementById('menuDrawer');
  const backdrop = document.getElementById('backdrop');
  if(!menu || !backdrop) return;
  
  // OPTIMIZATION: content-visibility
  if(!menu.classList.contains('open')) menu.style.contentVisibility = 'visible';
  
  const isOpen = menu.classList.contains('open');
  
  if(isOpen){
    menu.classList.remove('open');
    backdrop.classList.remove('show');
    setTimeout(()=>{ if(!menu.classList.contains('open')) menu.style.contentVisibility = 'hidden'; }, 300);
  }else{
    closeAll();
    menu.classList.add('open');
    backdrop.classList.add('show');
  }
}

function toggleCart(){
  logger.log('[Cart] toggleCart() called');
  const drawer = document.getElementById('cartDrawer');
  const backdrop = document.getElementById('backdrop');
  
  // OPTIMIZATION: content-visibility
  if(!drawer.classList.contains('open')) drawer.style.contentVisibility = 'visible';

  const isOpen = drawer.classList.contains('open');
  
  if(isOpen){
    drawer.classList.remove('open');
    backdrop.classList.remove('show');
    setTimeout(()=>{ if(!drawer.classList.contains('open')) drawer.style.contentVisibility = 'hidden'; }, 300);
  }else{
    closeAll();
    drawer.classList.add('open');
    backdrop.classList.add('show');
    paintCart();
  }
}

// Expose to window for onclick handlers
window.toggleMenu = toggleMenu;
window.toggleCart = toggleCart;

function closeAll(){
  const menu = document.getElementById('menuDrawer');
  const cart = document.getElementById('cartDrawer');
  
  menu.classList.remove('open');
  cart.classList.remove('open');
  document.getElementById('backdrop').classList.remove('show');
  
  setTimeout(()=>{ 
    if(!menu.classList.contains('open')) menu.style.contentVisibility = 'hidden';
    if(!cart.classList.contains('open')) cart.style.contentVisibility = 'hidden';
  }, 300);

  closeModal();
  safeCloseQuoteModal();
  if(typeof closeTVSizeModal === 'function') closeTVSizeModal();
}

function showModal(){
  closeAll();
  const m = byId('modal');
  m.style.contentVisibility = 'visible';
  m.classList.add('show');
  byId('backdrop').classList.add('show');
}

function closeModal(){
  const m = byId('modal');
  m.classList.remove('show');
  setTimeout(()=>{ if(!m.classList.contains('show')) m.style.contentVisibility = 'hidden'; }, 300);

  if(!byId('menuDrawer').classList.contains('open') && !byId('cartDrawer').classList.contains('open')){
    byId('backdrop').classList.remove('show');
  }
}

// === SAFE WRAPPERS FOR DEFERRED FUNCTIONS ===
function safeRequestQuote(p){
  const m = byId('quoteModal');
  if(m) m.style.contentVisibility = 'visible';
  if(typeof window.requestQuote === 'function') window.requestQuote(p);
}

function safeCloseQuoteModal(){
  const m = byId('quoteModal');
  if(m) {
    m.classList.remove('show');
    setTimeout(() => { if(!m.classList.contains('show')) m.style.contentVisibility = 'hidden'; }, 300);
  }
  byId('backdrop').classList.remove('show');
  if(typeof window.closeQuoteModal === 'function') window.closeQuoteModal();
}

// === PACKAGE SELECTION ===
let currentPackage = null;

function selectPackage(id, name, price){
  // Check if this is a TV mounting package - if so, show TV size modal
  if (id.includes('tv_') || name.toLowerCase().includes('tv')) {
    showTVSizeModal(id, name, price);
    return;
  }
  
  // For non-TV packages, add directly to cart
  addPackageDirectToCart(id, name, price);
}

// Expose to window for onclick handlers
window.selectPackage = selectPackage;

function addPackageDirectToCart(id, name, price, metadata = {}){
  // OPTIMIZATION: Direct Add-to-Cart (Fast Path)
  // Ensure price is a number
  const numPrice = Number(price);
  
  const existing = cart.find(item => item.type === 'package' && item.id === id);
  if(existing){
    existing.qty++;
    // Merge metadata if provided
    if (Object.keys(metadata).length > 0) {
      existing.metadata = { ...existing.metadata, ...metadata };
    }
  }else{
    const newItem = { 
      type:'package', 
      id, 
      name, 
      price: numPrice, 
      qty:1,
      metadata: metadata // Store TV size, team requirements, etc.
    };
    cart.push(newItem);
  }
  
  // Track add to cart
  h2sTrack('AddToCart', {
    product_id: id,
    product_name: name,
    quantity: 1,
    price: numPrice,
    currency: 'USD',
    ...metadata
  });
  
  saveCart();
  
  // Force open cart to show success
  const drawer = byId('cartDrawer');
  logger.log('[Cart] Opening cart drawer. Currently open:', drawer?.classList.contains('open'));
  if(drawer && !drawer.classList.contains('open')) {
    toggleCart();
    logger.log('[Cart] Cart drawer toggled open');
  } else {
    logger.log('[Cart] Cart drawer already open');
  }
}

function showTVSizeModal(packageId, packageName, packagePrice) {
  // Determine TV count options based on package type
  let tvCountOptions = [];
  let autoSelectCount = null;
  let quantityLabel = 'How many TVs are you mounting?';
  
  if (packageId === 'tv_single') {
    autoSelectCount = 1; // Single TV Package: auto-configure 1 TV
  } else if (packageId === 'tv_2pack') {
    autoSelectCount = 2; // 2-TV Package: auto-configure 2 TVs
  } else if (packageId === 'tv_multi') {
    tvCountOptions = [3, 4]; // Multi-room package: choose 3 or 4 TVs
    quantityLabel = 'How many TVs? (Multi-room: 3-4 TVs)';
  } else {
    tvCountOptions = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; // Custom package: any quantity
    quantityLabel = 'How many TVs are you mounting?';
  }
  
  // Remove existing modal to rebuild with correct options
  let modal = byId('tvSizeModal');
  if (modal) {
    modal.remove();
  }
  
  // Create fresh modal with package-specific options
  modal = document.createElement('div');
  modal.id = 'tvSizeModal';
  modal.className = 'modal';
  modal.style.contentVisibility = 'hidden';
  
  const quantitySelectorHTML = autoSelectCount ? '' : `
    <!-- Number of TVs -->
    <div id="tvQuantitySelector" style="margin-bottom:24px;">
      <label style="display:block;font-weight:700;margin-bottom:12px;color:var(--cobalt);font-size:15px;">
        ${quantityLabel}
      </label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        ${tvCountOptions.map(num => `
          <button type="button" class="tv-count-btn" data-count="${num}" onclick="setTVCount(${num})" style="
            flex:${tvCountOptions.length <= 4 ? '1' : '0 0 calc(25% - 6px)'};
            min-width:60px;
            padding:12px;
            border:2px solid #e5e7eb;
            border-radius:8px;
            background:#f9fafb;
            font-weight:700;
            font-size:16px;
            cursor:pointer;
            transition:all 0.2s;
          ">${num} TV${num > 1 ? 's' : ''}</button>
        `).join('')}
      </div>
    </div>
  `;
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 style="margin:0;font-size:20px;font-weight:800;">Configure Your TV Installation</h3>
        <button class="close-btn" onclick="closeTVSizeModal()" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body" style="padding: 32px 24px;">
        
        <!-- STEP 1: Mount Provider Selection -->
        <div id="mountProviderSection" style="margin-bottom:24px;">
          <label style="display:block;font-weight:700;margin-bottom:12px;color:var(--cobalt);font-size:15px;">
            Do you already have TV mounts?
          </label>
          <div style="display:flex;gap:12px;margin-bottom:12px;">
            <button type="button" class="mount-provider-btn" data-provider="h2s" onclick="selectMountProvider('h2s')" style="
              flex:1;
              padding:16px;
              border:2px solid #e5e7eb;
              border-radius:8px;
              background:#f9fafb;
              font-weight:600;
              font-size:15px;
              cursor:pointer;
              transition:all 0.2s;
              text-align:left;
            ">
              <div style="font-weight:700;margin-bottom:4px;"> We'll Provide Mounts</div>
              <div style="font-size:12px;color:#6b7280;">Professional-grade mounts included</div>
            </button>
            <button type="button" class="mount-provider-btn" data-provider="customer" onclick="selectMountProvider('customer')" style="
              flex:1;
              padding:16px;
              border:2px solid #e5e7eb;
              border-radius:8px;
              background:#f9fafb;
              font-weight:600;
              font-size:15px;
              cursor:pointer;
              transition:all 0.2s;
              text-align:left;
            ">
              <div style="font-weight:700;margin-bottom:4px;"> I Have Mounts</div>
              <div style="font-size:12px;color:#6b7280;">Save on mount costs</div>
            </button>
          </div>
          <div style="padding:10px;background:#fef3c7;border-left:3px solid #f59e0b;border-radius:4px;font-size:12px;color:#92400e;">
             <strong>Important:</strong> Customer-provided mounts must be compatible with your TV size and wall type. We recommend professional-grade mounts for safety.
          </div>
        </div>
        
        <!-- Mount Type Guide (shown only if H2S provides) -->
        <div id="mountGuideSection" style="display:none;margin:0 0 16px 0;">
          <button type="button" onclick="toggleMountGuide()" style="
            width:100%;
            padding:12px;
            background:#f0f9ff;
            border:1px solid #bfdbfe;
            border-radius:8px;
            font-size:13px;
            font-weight:600;
            color:#1e40af;
            cursor:pointer;
            text-align:left;
            display:flex;
            align-items:center;
            justify-content:space-between;
            transition:all 0.2s;
          ">
            <span> Mount Selection Guide</span>
            <span id="guideToggleIcon" style="transition:transform 0.2s;"></span>
          </button>
          <div id="mountGuideContent" style="display:none;padding:12px 0 0 0;color:#4b5563;font-size:13px;line-height:1.6;">
            <ul style="margin:0;padding-left:20px;">
              <li style="margin-bottom:6px;"><strong>Fixed/Flat:</strong> Bedrooms, kids' rooms - sleek, low-profile</li>
              <li style="margin-bottom:6px;"><strong>Tilt:</strong> Above eye level - reduces glare, neck strain</li>
              <li style="margin-bottom:6px;"><strong>Full Motion:</strong> Living rooms, open spaces - adjust viewing angle from anywhere</li>
            </ul>
          </div>
        </div>
        
        ${quantitySelectorHTML}
        
        <!-- TV Configurations Container -->
        <div id="tvConfigsContainer" style="display:none;">
          <!-- Dynamically populated -->
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-primary" id="confirmTVSizeBtn" onclick="confirmTVSize()" disabled style="
          width:100%;
          font-size:16px;
          padding:16px;
          font-weight:700;
          background:linear-gradient(135deg, var(--cobalt) 0%, #1e40af 100%);
          border:none;
          border-radius:12px;
          box-shadow:0 4px 12px rgba(37, 99, 235, 0.25);
          transition:all 0.2s ease;
        ">
          <span id="confirmBtnText">Add to Cart</span>
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  // Add modal styles (only once globally)
  if (!document.getElementById('tvModalStyles')) {
    const style = document.createElement('style');
    style.id = 'tvModalStyles';
    style.textContent = `
      .tv-count-btn.active {
        background: var(--cobalt) !important;
        color: white !important;
        border-color: var(--cobalt) !important;
      }
      .tv-count-btn:hover {
        border-color: var(--cobalt);
        background: #f3f4f6;
      }
      .mount-provider-btn.active {
        background: var(--cobalt) !important;
        color: white !important;
        border-color: var(--cobalt) !important;
      }
      .mount-provider-btn:hover {
        border-color: var(--cobalt);
        background: #f3f4f6;
      }
      .tv-config-card {
        background: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
      }
      .tv-config-card select {
        width: 100%;
        font-size: 14px;
        padding: 12px 14px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%234b5563%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22%3e%3cpolyline points=%226 9 12 15 18 9%22%3e%3c/polyline%3e%3c/svg%3e');
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 18px;
        padding-right: 40px;
      }
      .tv-config-card select:hover {
        border-color: var(--cobalt);
      }
      .tv-config-card select:focus {
        outline: none;
        border-color: var(--cobalt);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      .mount-price-badge {
        display: inline-block;
        background: #22c96f;
        color: white;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 700;
        margin-left: 8px;
      }
      #confirmTVSizeBtn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35);
      }
      #confirmTVSizeBtn:active:not(:disabled) {
        transform: translateY(0);
      }
      #confirmTVSizeBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    `;
    document.head.appendChild(style);
  }

  // Store package info in modal dataset
  modal.dataset.packageId = packageId;
  modal.dataset.packageName = packageName;
  modal.dataset.packagePrice = packagePrice;
  modal.dataset.autoSelectCount = autoSelectCount || '';

  // Reset state
  modal.tvConfigs = [];
  modal.tvCount = 0;
  modal.mountProvider = null; // Will be set when customer selects

  // Show modal
  modal.style.contentVisibility = 'visible';
  modal.classList.add('show');
  byId('backdrop').classList.add('show');
  
  // Lock body scroll and save scroll position
  const scrollY = window.scrollY;
  document.body.style.top = `-${scrollY}px`;
  document.body.classList.add('modal-open');
  modal._savedScrollY = scrollY;
  
  // Hide quantity selector and config container initially (show after mount provider selection)
  const quantitySelector = byId('tvQuantitySelector');
  const configContainer = byId('tvConfigsContainer');
  if (quantitySelector && !autoSelectCount) {
    quantitySelector.style.display = 'none';
  }
  if (configContainer) {
    configContainer.style.display = 'none';
  }
  
  // Check if modal body needs scroll indicator
  setTimeout(() => checkModalScroll(), 100);
  
  // Keyboard-aware modal positioning for mobile
  if ('visualViewport' in window) {
    const adjustModalForKeyboard = () => {
      const modalContent = modal.querySelector('.modal-content');
      if (modalContent) {
        const viewportHeight = window.visualViewport.height;
        modalContent.style.maxHeight = `${viewportHeight * 0.85}px`;
      }
    };
    window.visualViewport.addEventListener('resize', adjustModalForKeyboard);
    modal._keyboardHandler = adjustModalForKeyboard;
  }
  
  // Allow closing with Escape key
  const escHandler = (e) => {
    if (e.key === 'Escape') {
      closeTVSizeModal();
      document.removeEventListener('keydown', escHandler);
    }
  };
  document.addEventListener('keydown', escHandler);
  
  // Allow closing by clicking backdrop
  const backdropClickHandler = (e) => {
    if (e.target.id === 'backdrop') {
      closeTVSizeModal();
      byId('backdrop').removeEventListener('click', backdropClickHandler);
    }
  };
  byId('backdrop').addEventListener('click', backdropClickHandler);
}

// Mount type pricing
const MOUNT_PRICING = {
  fixed: 0,
  tilt: 25,
  full_motion: 75
};

window.selectMountProvider = function(provider) {
  const modal = byId('tvSizeModal');
  modal.mountProvider = provider;
  
  // Update UI
  document.querySelectorAll('.mount-provider-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.provider === provider);
  });
  
  // Show/hide mount guide and enable next steps
  const mountGuide = byId('mountGuideSection');
  const quantitySelector = byId('tvQuantitySelector');
  
  if (provider === 'h2s') {
    if (mountGuide) mountGuide.style.display = 'block';
  } else {
    if (mountGuide) mountGuide.style.display = 'none';
  }
  
  // Auto-trigger TV count selection if predefined
  const autoSelectCount = modal.dataset.autoSelectCount;
  if (autoSelectCount) {
    setTimeout(() => setTVCount(parseInt(autoSelectCount)), 100);
  } else if (quantitySelector) {
    quantitySelector.style.display = 'block';
  }
};

window.setTVCount = function(count) {
  const modal = byId('tvSizeModal');
  modal.tvCount = count;
  
  // Initialize config with mount provider (STRICT: no defaults)
  const mountProvider = modal.mountProvider;
  if (!mountProvider) {
    logger.error('[TV Modal] setTVCount called before mount provider selected');
    return;
  }
  
  modal.tvConfigs = Array(count).fill(null).map(() => ({
    size: '',
    mountType: mountProvider === 'h2s' ? '' : 'customer_provided'
  }));
  
  // Update UI
  document.querySelectorAll('.tv-count-btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.count) === count);
  });
  
  // Show config container
  const container = byId('tvConfigsContainer');
  container.style.display = 'block';
  
  // Build TV config forms (using mountProvider from above)
  
  const tvCards = [];
  for (let idx = 0; idx < count; idx++) {
    const mountSection = mountProvider === 'h2s' ? 
      `<div>
        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:13px; color:#374151;">
          Mount Type <span style="font-weight:400; color:#6b7280;">(Choose based on room usage)</span>
        </label>
        <select id="tvMount_${idx}" onchange="updateTVConfig(${idx}, 'mountType', this.value)">
          <option value="">Select mount type...</option>
          <option value="fixed"> Fixed/Flat - Flush against wall (Bedrooms, kids' rooms)</option>
          <option value="tilt"> Tilt +$25 - Angle down to reduce glare (Above eye level)</option>
          <option value="full_motion"> Full Motion +$75 - Swivel & extend (Living room, open concept)</option>
        </select>
        <div style="margin-top:8px; padding:10px; background:#f0f9ff; border-left:3px solid var(--azure); border-radius:4px; font-size:12px; color:#1e40af;">
           <strong>Tip:</strong> Full motion mounts are perfect when you need to adjust viewing angles from different seating areas. Fixed/flat mounts work great for bedrooms where the TV faces one direction.
        </div>
      </div>` :
      `<div style="padding:12px; background:#d1fae5; border-left:3px solid #10b981; border-radius:4px; font-size:13px; color:#065f46;">
        ? <strong>Customer Providing Mount</strong> - Please ensure your mount is compatible with this TV size and rated for your wall type.
      </div>`;
    
    tvCards.push(`
      <div class="tv-config-card">
        <div style="font-weight:700; font-size:15px; color:var(--cobalt); margin-bottom:16px; display:flex; align-items:center; gap:8px;">
          <span>TV #${idx + 1}</span>
          <span style="font-weight:400; color:#6b7280; font-size:13px;"> Which room is this TV in?</span>
        </div>
        
        <div style="margin-bottom:${mountProvider === 'h2s' ? '12px' : '0'};">
          <label style="display:block; font-weight:600; margin-bottom:8px; font-size:13px; color:#374151;">
            Screen Size
          </label>
          <select id="tvSize_${idx}" onchange="updateTVConfig(${idx}, 'size', this.value)">
            <option value="">Select size...</option>
            <option value="32-43">32" - 43"</option>
            <option value="44-54">44" - 54"</option>
            <option value="55-64">55" - 64"</option>
            <option value="65-74">65" - 74"</option>
            <option value="75-85">75" - 85"</option>
            <option value="86+">86" and larger</option>
          </select>
        </div>
        
        ${mountSection}
      </div>
    `);
  }
  
  container.innerHTML = `
    <div style="margin-top:24px; margin-bottom:24px;">
      ${tvCards.join('')}
    </div>
  `;
  
  validateTVConfigs();
  
  // Check scroll indicator after adding TV configs
  setTimeout(() => checkModalScroll(), 50);
};

window.updateTVConfig = function(index, field, value) {
  const modal = byId('tvSizeModal');
  modal.tvConfigs[index][field] = value;
  validateTVConfigs();
};

function validateTVConfigs() {
  const modal = byId('tvSizeModal');
  const confirmBtn = byId('confirmTVSizeBtn');
  const btnText = byId('confirmBtnText');
  
  if (!modal.tvConfigs || modal.tvConfigs.length === 0) {
    confirmBtn.disabled = true;
    btnText.textContent = 'Add to Cart';
    return;
  }
  
  // Check if mount provider is selected
  const mountProvider = modal.mountProvider;
  if (!mountProvider) {
    confirmBtn.disabled = true;
    btnText.textContent = 'Select Mount Provider First';
    return;
  }
  
  // Check if all TVs are configured (size required, mountType required only if H2S providing)
  const allConfigured = modal.tvConfigs.every(config => {
    const sizeValid = config.size && config.size !== '';
    const mountValid = mountProvider === 'customer' ? true : (config.mountType && config.mountType !== '');
    return sizeValid && mountValid;
  });
  
  confirmBtn.disabled = !allConfigured;
  
  if (allConfigured) {
    // Get base price and apply tier pricing for Multi-Room
    const packageId = modal.dataset.packageId;
    let basePrice = parseFloat(modal.dataset.packagePrice);
    
    if (packageId === 'tv_multi') {
      if (modal.tvConfigs.length === 3) {
        basePrice = 699; // 3 TVs = $699
      } else if (modal.tvConfigs.length === 4) {
        basePrice = 899; // 4 TVs = $899
      }
    }
    
    // Calculate total price with mount upcharges (only if H2S providing)
    const mountUpcharges = mountProvider === 'h2s' 
      ? modal.tvConfigs.reduce((sum, config) => sum + (MOUNT_PRICING[config.mountType] || 0), 0)
      : 0;
    
    const totalPrice = basePrice + mountUpcharges;
    
    btnText.textContent = `Add to Cart - $${totalPrice}`;
  } else {
    btnText.textContent = 'Add to Cart';
  }
}

function closeTVSizeModal() {
  const modal = byId('tvSizeModal');
  if (modal) {
    modal.classList.remove('show');
    
    // Clean up keyboard listener
    if (modal._keyboardHandler && 'visualViewport' in window) {
      window.visualViewport.removeEventListener('resize', modal._keyboardHandler);
    }
    
    // Unlock body scroll and restore position
    const scrollY = modal._savedScrollY || 0;
    document.body.classList.remove('modal-open');
    document.body.style.top = '';
    window.scrollTo(0, scrollY);
    
    setTimeout(() => { if(!modal.classList.contains('show')) modal.style.contentVisibility = 'hidden'; }, 300);
  }
  
  // Only hide backdrop if no other modals are open
  if (!byId('modal')?.classList.contains('show') && 
      !byId('cartDrawer')?.classList.contains('open') &&
      !byId('menuDrawer')?.classList.contains('open')) {
    byId('backdrop').classList.remove('show');
  }
}

// Toggle mount guide visibility
window.toggleMountGuide = function() {
  const content = byId('mountGuideContent');
  const icon = byId('guideToggleIcon');
  if (content && icon) {
    const isHidden = content.style.display === 'none';
    content.style.display = isHidden ? 'block' : 'none';
    icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
  }
};

// Detect modal body scroll for indicator
window.checkModalScroll = function() {
  const modalBody = document.querySelector('#tvSizeModal .modal-body');
  if (modalBody) {
    const hasScroll = modalBody.scrollHeight > modalBody.clientHeight;
    modalBody.classList.toggle('has-scroll', hasScroll);
  }
};

function confirmTVSize() {
  const modal = byId('tvSizeModal');
  
  const packageId = modal.dataset.packageId;
  const packageName = modal.dataset.packageName;
  let basePrice = parseFloat(modal.dataset.packagePrice);
  const tvConfigs = modal.tvConfigs;
  const mountProvider = modal.mountProvider;
  
  // Validate mount provider is selected
  if (!mountProvider) {
    alert('Please select whether you have mounts or need us to provide them');
    return;
  }
  
  if (!tvConfigs || tvConfigs.length === 0) {
    alert('Please select number of TVs');
    return;
  }
  
  // Validate all configs
  const allValid = tvConfigs.every(c => {
    const sizeValid = c.size && c.size !== '';
    const mountValid = mountProvider === 'customer' ? true : (c.mountType && c.mountType !== '');
    return sizeValid && mountValid;
  });
  
  if (!allValid) {
    alert('Please configure all TVs (size' + (mountProvider === 'h2s' ? ' and mount type' : '') + ')');
    return;
  }
  
  // Apply tier pricing for Multi-Room package
  if (packageId === 'tv_multi') {
    if (tvConfigs.length === 3) {
      basePrice = 699; // 3 TVs = $699
    } else if (tvConfigs.length === 4) {
      basePrice = 899; // 4 TVs = $899
    }
  }
  
  // Calculate total price with mount upcharges (only if H2S providing)
  const mountUpcharges = mountProvider === 'h2s'
    ? tvConfigs.reduce((sum, config) => sum + (MOUNT_PRICING[config.mountType] || 0), 0)
    : 0;
  
  const totalPrice = basePrice + mountUpcharges;
  
  // Build items_json for backend (one item per TV)
  const items = tvConfigs.map((config, idx) => {
    // Determine team requirements
    let requiresTeam = false;
    let teamRecommended = false;
    let teamReason = '';
    
    if (config.size === '75-85' || config.size === '86+') {
      requiresTeam = true;
      teamReason = `Large TV (${config.size}) - safety requirement`;
    } else if (config.size === '65-74') {
      teamRecommended = true;
      teamReason = `Heavy TV (${config.size}) - team recommended`;
    }
    
    // Price per TV (base price divided by count + mount upcharge if H2S providing)
    const perTVBase = basePrice / tvConfigs.length;
    const mountUpcharge = mountProvider === 'h2s' ? (MOUNT_PRICING[config.mountType] || 0) : 0;
    const itemPrice = perTVBase + mountUpcharge;
    
    return {
      bundle_id: packageId,
      service_name: packageName,
      qty: 1,
      unit_price: itemPrice,
      line_total: itemPrice,
      metadata: {
        tv_size: config.size,
        mount_type: config.mountType || 'customer_provided',
        mount_provider: mountProvider,
        mount_upcharge: mountUpcharge,
        mounts_needed: mountProvider === 'h2s' ? 1 : 0,
        requires_team: requiresTeam,
        team_recommended: teamRecommended,
        team_reason: teamReason,
        min_team_size: requiresTeam ? 2 : 1,
        tv_number: idx + 1,
        total_tvs: tvConfigs.length
      }
    };
  });
  
  // Build consolidated metadata
  const metadata = {
    tv_count: tvConfigs.length,
    mount_provider: mountProvider,
    items_json: items,
    total_mount_upcharges: mountUpcharges,
    original_price: basePrice,
    final_price: totalPrice
  };
  
  logger.log('[TV Modal] Confirming', tvConfigs.length, 'TVs with mount provider:', mountProvider);
  logger.log('[TV Modal] Configs:', tvConfigs);
  logger.log('[TV Modal] Metadata:', metadata);
  logger.log('[TV Modal] Items:', items);
  
  // Close modal
  closeTVSizeModal();
  
  // Add to cart with updated price and metadata
  setTimeout(() => {
    addPackageDirectToCart(packageId, packageName, totalPrice, metadata);
  }, 100);
}

function addPackageToCart(){
  if(!currentPackage) return;
  
  const curKey = currentPackage.id || currentPackage.bundle_id;
  const existing = cart.find(item => {
    const itemKey = item.id || item.bundle_id;
    return item.type === 'package' && itemKey === curKey;
  });
  if(existing){
    existing.qty++;
  }else{
    const normalized = { ...currentPackage };
    if(!normalized.id && normalized.bundle_id) normalized.id = normalized.bundle_id;
    cart.push({ type:'package', ...normalized, qty:1 });
  }
  
  // Track add to cart
  h2sTrack('AddToCart', {
    product_id: currentPackage.id,
    product_name: currentPackage.name,
    quantity: 1,
    price: currentPackage.price,
    currency: 'USD'
  });
  
  saveCart();
  closeModal();
  toggleCart();
}

// === CART MODEL ===
function saveCart(){
  logger.log('[Cart] Saving cart with', cart.length, 'items:', cart);
  try {
    localStorage.setItem('h2s_cart', JSON.stringify(cart));
    logger.log('[Cart] Successfully saved to localStorage');
  } catch(err) {
    logger.warn('Failed to save cart to localStorage (may be in private mode):', err);
    // Cart still works in memory, just won't persist across page reloads
  }
  updateCartBadge();
  paintCart();
  syncCartToUrl();
}

function loadCart(){
  try{ 
    const raw = localStorage.getItem('h2s_cart');
    logger.log('[Cart] Raw localStorage data:', raw);
    if(!raw) return [];
    
    const loaded = JSON.parse(raw);
    logger.log('[Cart] Parsed cart data:', loaded);
    if(!Array.isArray(loaded)) {
      logger.warn('[Cart] Cart data is not an array, returning empty');
      return [];
    }
    
    // Clean up any stale/invalid items on load
    // NOTE: Be tolerant of missing price values &mdash; price is authoritative from server catalog.
    const cleaned = loaded.filter(item => {
      const hasValidQty = Number(item.qty || 0) > 0;
      const hasId = !!(item.id || item.service_id || item.bundle_id);
      if(!hasValidQty || !hasId){
        logger.warn('[Cart] Removing invalid item on load (bad qty or missing id):', item);
        return false;
      }
      return true;
    });
    
    // If we cleaned anything, save the cleaned cart
    if(cleaned.length !== loaded.length){
      localStorage.setItem('h2s_cart', JSON.stringify(cleaned));
    }
    
    return cleaned;
  }catch(_){ 
    return []; 
  }
}

function updateQuantity(idx, delta){
  if(!cart[idx]) return;
  
  const newQty = (Number(cart[idx].qty)||1) + delta;
  
  if(newQty <= 0){
    cart.splice(idx, 1);
  }else{
    cart[idx].qty = newQty;
  }
  
  saveCart();
}

// === HERO REVIEW CAROUSEL ===
let heroReviewInterval;
let currentHeroReviewIndex = 0;
// Initialize with fallback data IMMEDIATELY so LCP is fast
let heroReviews = [
    {
      text: "Professional, on-time, and clean installation.",
      author: "Recent Customer",
      stars: 5
    },
    {
      text: "Had 4 cameras installed. The app setup was seamless and now I have total peace of mind.",
      author: "Mike T.",
      stars: 5
    },
    {
      text: "Quick, clean, professional. They hid all the wires perfectly. Looks like it came with the house!",
      author: "Jennifer L.",
      stars: 5
    },
    {
      text: "Same-day service saved me! TV mounted and streaming setup done in under an hour.",
      author: "David R.",
      stars: 5
    },
    {
      text: "The whole-home security package was a game changer. Professional install, great support.",
      author: "Amanda K.",
      stars: 5
    }
];

// Fetch real reviews from Vercel endpoint (Background)
async function loadHeroReviews() {
  try {
    const reviewsUrl = API.replace('/shop', '/reviews') + '?limit=5&onlyVerified=true';
    // logger.log('[Hero Reviews] Fetching from:', reviewsUrl);
    
    const res = await fetch(reviewsUrl, {
      cache: 'default' // Use CDN cache
    });
    const data = await res.json();
    
    if (data.ok && data.reviews && data.reviews.length > 0) {
      const newReviews = data.reviews.slice(0, 5).map(r => ({
        text: r.text && r.text.trim() ? r.text.trim() : '',
        author: r.name || 'Customer',
        stars: r.rating || 5
      })).filter(r => r.text.length > 0);
      
      if(newReviews.length > 0){
          heroReviews = newReviews;
          // logger.log('[OK] Loaded', heroReviews.length, 'REAL hero reviews from API');
          renderHeroReviews(); // Re-render with real data
      }
    }
  } catch (err) {
    // logger.warn('[Hero Reviews] Background fetch failed, keeping fallbacks:', err);
  }
}

function renderHeroReviews(){
  const container = byId('heroReviews');
  if (!container || heroReviews.length === 0) return;
  
  // Build review slides HTML
  const reviewsHTML = heroReviews.map((review, index) => {
    const hasText = review.text && review.text.trim().length > 0;
    return `
    <div class="hero-review-slide ${index === currentHeroReviewIndex ? 'active' : ''}" data-index="${index}">
      <div class="hero-review-stars">${'&#9733;'.repeat(review.stars)}</div>
      ${hasText ? `<div class="hero-review-text">"${review.text}"</div>` : ''}
      <div class="hero-review-author">&mdash; ${review.author}</div>
    </div>
  `;
  }).join('');
  
  const dotsHTML = heroReviews.map((_, index) => `
    <div class="hero-review-dot ${index === currentHeroReviewIndex ? 'active' : ''}" data-index="${index}" onclick="goToHeroReview(${index})"></div>
  `).join('');
  
  container.innerHTML = reviewsHTML + `<div class="hero-review-dots">${dotsHTML}</div>`;
  
  container.onclick = () => {
    window.location.href = 'https://home2smart.com/reviews';
  };
}

function initHeroReviews() {
  // OPTIMIZATION: If static content is already present (Instant Paint), do not re-render
  const container = document.getElementById('heroReviews');
  const hasStaticContent = container && container.querySelector('.hero-review-slide.active');
  if (!hasStaticContent) renderHeroReviews();

  // Defer auto-rotation: start only after idle or first interaction
  const startRotation = () => {
    if (heroReviewInterval) clearInterval(heroReviewInterval);
    heroReviewInterval = setInterval(nextHeroReview, 5000);
  };
  const interactionHandler = () => { startRotation(); window.removeEventListener('pointerdown', interactionHandler, {passive:true}); };
  window.addEventListener('pointerdown', interactionHandler, {passive:true, once:true});
  if('requestIdleCallback' in window){
    requestIdleCallback(startRotation, {timeout:5000});
  } else {
    setTimeout(startRotation, 5000);
  }

  // Delay API fetch further (6s) to reduce network contention around LCP/TBT
  setTimeout(() => loadHeroReviews(), 6000);
}

function nextHeroReview() {
  currentHeroReviewIndex = (currentHeroReviewIndex + 1) % heroReviews.length;
  showHeroReview(currentHeroReviewIndex);
}

function goToHeroReview(index) {
  // Stop propagation so clicking dots doesn't navigate away
  event?.stopPropagation();
  
  currentHeroReviewIndex = index;
  showHeroReview(index);
  
  // Reset auto-rotate timer
  if (heroReviewInterval) clearInterval(heroReviewInterval);
  heroReviewInterval = setInterval(nextHeroReview, 5000);
}

function showHeroReview(index) {
  const slides = document.querySelectorAll('.hero-review-slide');
  const dots = document.querySelectorAll('.hero-review-dot');
  
  slides.forEach((slide, i) => {
    slide.classList.toggle('active', i === index);
  });
  
  dots.forEach((dot, i) => {
    dot.classList.toggle('active', i === index);
  });
}

function renderReviews() {
  const track = byId('reviewTrack');
  const nav = byId('reviewNav');
  
  if (!track || !nav) {
    // logger.error('[Reviews] Carousel DOM elements not found');
    return;
  }
  
  if (allReviews.length === 0) {
    track.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 40px;">No reviews available</p>';
    return;
  }
  
  track.innerHTML = allReviews.map((review, index) => {
    // ACTUAL API FIELD NAMES: display_name, review_text, services_selected, rating, timestamp_iso
    const displayName = review.display_name || 'Customer';
    const initials = displayName
      .split(' ')
      .map(n => n[0])
      .join('')
      .toUpperCase()
      .slice(0, 2);
    
    const rating = Number(review.rating || 5);
    const stars = '?'.repeat(rating);
    const greyStars = '?'.repeat(5 - rating);
    
    // Escape HTML to prevent XSS
    const escapedName = displayName.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const escapedText = (review.review_text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // services_selected is comma-separated string
    const services = review.services_selected ? review.services_selected.split(',')[0].trim() : 'Smart Home Service';
    const escapedService = services.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // Format date EXACTLY like reviews page: "Jan 15, 2025" format
    let formattedDate = '';
    if (review.timestamp_iso) {
      try {
        const date = new Date(review.timestamp_iso);
        formattedDate = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
      } catch(e) {
        formattedDate = '';
      }
    }
    
    return `
      <div class="review-card" data-index="${index}">
        <div class="review-header">
          <div class="review-avatar">${initials}</div>
          <div class="review-meta">
            <div class="review-name">${escapedName}</div>
            <div class="review-stars">${stars}${greyStars}</div>
            ${formattedDate ? `<div class="review-time">${formattedDate}</div>` : ''}
          </div>
        </div>
        <p class="review-text">${escapedText}</p>
        <div class="review-footer">
          <div class="review-service">${escapedService}</div>
          ${review.verified ? '<div class="review-verified">Verified Customer</div>' : ''}
        </div>
      </div>
    `;
  }).join('');
  
  // Create dots for pages, not individual reviews
  const slidesPerView = window.innerWidth >= 1024 ? 3 : window.innerWidth >= 768 ? 2 : 1;
  const totalPages = Math.ceil(allReviews.length / slidesPerView);
  
  nav.innerHTML = Array.from({length: totalPages}, (_, i) => 
    `<div class="review-dot ${i === 0 ? 'active' : ''}" onclick="goToReview(${i})" aria-label="Go to page ${i + 1}"></div>`
  ).join('');
  
  // (reviews rendered log stripped)
}

function startCarousel() {
  if (reviewInterval) clearInterval(reviewInterval);
  
  // Only auto-rotate if we have multiple pages of reviews
  const slidesPerView = window.innerWidth >= 1024 ? 3 : window.innerWidth >= 768 ? 2 : 1;
  const totalPages = Math.ceil(allReviews.length / slidesPerView);
  
  if (totalPages <= 1) return;
  
  reviewInterval = setInterval(() => {
    // Move to next page (group of 3)
    reviewIndex++;
    if (reviewIndex >= totalPages) {
      reviewIndex = 0;
    }
    updateCarousel();
  }, 5000);
  
  // Pause on hover
  const carousel = document.querySelector('.review-carousel');
  if (carousel) {
    carousel.addEventListener('mouseenter', () => {
      if (reviewInterval) clearInterval(reviewInterval);
    });
    carousel.addEventListener('mouseleave', () => {
      startCarousel();
    });
  }
}

function goToReview(pageIndex) {
  reviewIndex = pageIndex;
  updateCarousel();
  startCarousel(); // Reset timer
}

function updateCarousel() {
  const track = byId('reviewTrack');
  if (!track || allReviews.length === 0) return;
  // Batch DOM writes in rAF to avoid layout thrashing
  const vw = window.innerWidth;
  const slidesPerView = vw >= 1024 ? 3 : vw >= 768 ? 2 : 1;
  const totalPages = Math.ceil(allReviews.length / slidesPerView);
  const safeIndex = Math.min(reviewIndex, totalPages - 1);
  const offset = -safeIndex * 100;
  requestAnimationFrame(() => {
    track.style.transform = `translateX(${offset}%)`;
    const dots = document.querySelectorAll('.review-dot');
    dots.forEach((dot, i) => {
      const active = (i === safeIndex);
      if (active !== dot.classList.contains('active')) {
        dot.classList.toggle('active', active);
      }
    });
  });
}

// Debounced resize handler for carousel
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    if (allReviews.length > 0) updateCarousel();
  }, 100);
});

// Extended reviews disabled for performance; hero section links to full reviews page.

function encodeCartToUrl(cartItems = cart){
  if(!cartItems || !cartItems.length) return '';
  return cartItems.map(item => {
    if(item.type === 'package') return `pkg:${item.id}*${item.qty}`;
   
    const svc = item.service_id || '';
    const opt = item.option_id ? `:${item.option_id}` : '';
    return `${svc}${opt}*${item.qty}`;
  }).join(',');
}

function decodeCartFromUrl(cartParam){
  if(!cartParam) return [];
  const items = String(cartParam).split(',');
  return items.map(item => {
    const parts = item.split('*');
    const qty = Number(parts[1]) || 1;
    const servicePart = parts[0];
    
    if(servicePart.startsWith('pkg:')){
      const bundle_id = servicePart.replace('pkg:', '');
      
      // Look up actual bundle from catalog to get real price
      const bundle = catalog.bundles?.find(b => b.bundle_id === bundle_id);
      
      if(!bundle){
        logger.warn('[Cart] Bundle not found in catalog:', bundle_id);
        return null;
      }
      
      return { 
        type: 'package', 
        id: bundle_id, 
        name: bundle.name || bundle_id,
        price: Number(bundle.bundle_price || 0),
        qty 
      };
    }
    
    const [service_id, option_id] = servicePart.split(':');
    return { service_id, qty, option_id: option_id || null };
  }).filter(item => item !== null && (item.service_id || item.id));
}

function syncCartToUrl(){
  // DISABLED: Cart persistence via URL causes issues on refresh
  // Cart is saved to localStorage which is more reliable
  // If you need shareable cart links, use a different approach
  return;
  
  /* OLD CODE:
  const url = new URL(location.href);
  if(cart.length){
    url.searchParams.set('cart', encodeCartToUrl());
  }else{
    url.searchParams.delete('cart');
  }
  history.replaceState({}, '', url.toString());
  */
}

function saveUser(){
  try {
    localStorage.setItem('h2s_user', JSON.stringify(user||{}));
  } catch(err) {
    logger.warn('Failed to save user to localStorage:', err);
  }
  renderSigninState();
}

function loadUser(){
  try{ return JSON.parse(localStorage.getItem('h2s_user')||'{}'); }catch(_){ return {}; }
}

function updateCartBadge(){
  const count = cart.reduce((n,l)=> n + Number(l.qty||0), 0);
  byId('cartCount').textContent = count;
}

function cartSubtotal(lines=cart){
  return lines.reduce((sum, ln)=>{
    if(ln.type === 'package'){
      return sum + (Number(ln.price||0) * Number(ln.qty||1));
    }
    // For future service items
    return sum;
  }, 0);
}

// === CART PAINT ===
function paintCart(){
  const items = byId('cartItems');
  const emptyState = byId('cartEmpty');
  const subtotal = byId('cartSubtotal');
  const itemCount = byId('cartItemCount');
  // (log stripped)
  
  if(!items || !emptyState || !subtotal) return;
  
  // SAFETY CHECK
  if(!cart || !Array.isArray(cart)) cart = [];
  
  if(!cart.length){
    logger.log('[Cart] Cart is empty, showing empty state');
    emptyState.hidden = false;
    items.innerHTML = '';
    subtotal.textContent = '$0.00';
    if(itemCount) itemCount.textContent = '0 items';
    return;
  }
  
  logger.log('[Cart] Rendering', cart.length, 'items');
  emptyState.hidden = true;
  
  let cartSubtotalVal = 0;
  let totalQty = 0;
  
  items.innerHTML = cart.map((item, idx) => {
    const qty = Number(item.qty||1);
    // For packages with dynamic pricing (TV packages with mount upcharges), 
    // ALWAYS use the cart item's stored price, not the catalog base price
    const isDynamic = ['tv_multi', 'tv_single', 'tv_2pack'].includes(item.id);
    
    let itemPrice = Number(item.price||0);
    if(item.type === 'package' && !isDynamic){
      // Only lookup catalog price for non-dynamic packages (cameras, etc.)
      const bundle = catalog.bundles?.find(b => b.bundle_id === item.id);
      if(bundle && bundle.bundle_price !== undefined && bundle.bundle_price !== null){
        itemPrice = Number(bundle.bundle_price || itemPrice || 0);
      }
    }
    const itemTotal = itemPrice * qty;
    logger.log('[Cart] Rendering item:', item.name, 'qty:', qty, 'price:', itemPrice, 'total:', itemTotal);
    
    cartSubtotalVal += itemTotal;
    totalQty += qty;
    
    // Build detailed metadata display
    const metadata = item.metadata || {};
    let metadataHTML = '';
    
    // Check if this is a multi-TV configuration with items_json
    if (metadata.items_json && Array.isArray(metadata.items_json) && metadata.items_json.length > 0) {
      // MULTI-TV DETAILED BREAKDOWN
      const tvCount = metadata.tv_count || metadata.items_json.length;
      const mountProvider = metadata.items_json[0]?.metadata?.mount_provider || 'h2s';
      const totalUpcharges = metadata.total_mount_upcharges || 0;
      
      // Use the metadata's original_price (tier-adjusted base) or calculate from final price
      const basePrice = metadata.original_price || (itemPrice - totalUpcharges);
      
      metadataHTML = `
        <div style="margin-top:12px;padding:12px;background:#f8f9fb;border-radius:8px;border-left:3px solid var(--cobalt);">
          <div style="font-weight:700;color:var(--cobalt);margin-bottom:8px;display:flex;align-items:center;gap:8px;">
            <span>${tvCount} TV Installation${tvCount > 1 ? 's' : ''}</span>
            ${mountProvider === 'customer' ? '<span style="background:#10b981;color:white;padding:2px 8px;border-radius:4px;font-size:11px;">Customer Mounts</span>' : ''}
          </div>
          
          ${metadata.items_json.map((tvItem, tvIdx) => {
            const tvMeta = tvItem.metadata || {};
            const tvSize = tvMeta.tv_size || 'Unknown';
            const mountType = tvMeta.mount_type || 'fixed';
            const mountUpcharge = tvMeta.mount_upcharge || 0;
            const tvNumber = tvMeta.tv_number || (tvIdx + 1);
            
            const mountTypeLabels = {
              fixed: 'Fixed/Flat',
              tilt: 'Tilt',
              full_motion: 'Full Motion'
            };
            const mountLabel = mountTypeLabels[mountType] || mountType;
            
            return `
              <div style="padding:8px;background:white;border-radius:6px;margin-bottom:6px;border:1px solid #e5e7eb;">
                <div style="display:flex;justify-content:space-between;align-items:start;">
                  <div>
                    <div style="font-weight:600;font-size:13px;color:#111;">TV #${tvNumber}</div>
                    <div style="font-size:12px;color:#6b7280;margin-top:2px;">Size: ${tvSize}"</div>
                    ${mountProvider === 'h2s' ? `<div style="font-size:12px;color:#6b7280;">Mount: ${mountLabel}</div>` : ''}
                    ${tvMeta.requires_team ? `<div style="font-size:11px;color:#dc2626;font-weight:600;margin-top:4px;">Two-tech required (${tvMeta.team_reason || 'Large TV'})</div>` : ''}
                  </div>
                  ${mountProvider === 'h2s' && mountUpcharge > 0 ? `
                    <div style="text-align:right;">
                      <div style="font-size:11px;color:#6b7280;">Mount upgrade</div>
                      <div style="font-weight:600;color:var(--cobalt);font-size:13px;">+$${mountUpcharge}</div>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('')}
          
          <div style="margin-top:12px;padding-top:10px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;font-size:12px;">
            <div style="color:#6b7280;">
              ${mountProvider === 'h2s' ? `
                <div>Base Package: $${basePrice.toFixed(2)}</div>
                ${totalUpcharges > 0 ? `<div>Mount Upgrades: +$${totalUpcharges.toFixed(2)}</div>` : ''}
              ` : `<div>Installation Only (customer mounts)</div>`}
            </div>
            <div style="font-weight:700;color:var(--cobalt);">Total: $${itemPrice.toFixed(2)}</div>
          </div>
        </div>
      `;
    } else if (metadata.tv_size || metadata.mount_type || metadata.requires_team) {
      // SINGLE TV OR SIMPLE METADATA
      metadataHTML = '<div style="margin-top:8px;padding:10px;background:#f8f9fb;border-radius:6px;border-left:3px solid var(--azure);font-size:12px;">';
      
      if (metadata.tv_size) {
        metadataHTML += `<div style="color:var(--cobalt);font-weight:600;margin-bottom:4px;">TV Size: ${escapeHtml(metadata.tv_size)}"</div>`;
      }
      
      if (metadata.mount_type) {
        const mountTypeLabels = {
          fixed: 'Fixed/Flat Mount',
          tilt: 'Tilt Mount',
          full_motion: 'Full Motion Mount'
        };
        const mountLabel = mountTypeLabels[metadata.mount_type] || metadata.mount_type;
        const mountUpcharge = metadata.mount_upcharge || 0;
        
        metadataHTML += `<div style="color:#374151;font-weight:500;">${mountLabel}${mountUpcharge > 0 ? ` <span style="color:var(--cobalt);font-weight:700;">(+$${mountUpcharge})</span>` : ''}</div>`;
      }
      
      if (metadata.mount_provider === 'customer') {
        metadataHTML += `<div style="color:#10b981;font-weight:600;margin-top:4px;">Customer-provided mount</div>`;
      }
      
      if (metadata.requires_team) {
        metadataHTML += `<div style="color:#dc2626;font-weight:700;margin-top:6px;padding-top:6px;border-top:1px solid #e5e7eb;">Two-Tech Service Required</div>`;
        if (metadata.team_reason) {
          metadataHTML += `<div style="color:#dc2626;font-size:11px;margin-top:2px;">${escapeHtml(metadata.team_reason)}</div>`;
        }
      } else if (metadata.team_recommended) {
        metadataHTML += `<div style="color:#2563eb;font-weight:600;margin-top:4px;">Two techs recommended</div>`;
      }
      
      metadataHTML += '</div>';
    }
    
    return `
      <div class="cart-item">
        <div class="cart-item-info">
          <div class="cart-item-name">${escapeHtml(item.name||item.id||'Item')}</div>
          <div class="cart-item-price">${money(itemPrice)} each</div>
          ${metadataHTML}
          
          <div class="cart-qty-controls">
            <button 
              class="cart-qty-btn"
              onclick="updateQuantity(${idx}, -1)"
              aria-label="Decrease quantity"
            >&minus;</button>
            
            <span class="cart-qty-value">${qty}</span>
            
            <button 
              class="cart-qty-btn"
              onclick="updateQuantity(${idx}, 1)"
              aria-label="Increase quantity"
            >+</button>
          </div>
        </div>
        
        <div class="cart-item-right">
          <div class="cart-item-total">${money(itemTotal)}</div>
          <button 
            class="cart-remove-btn"
            onclick="removeFromCart(${idx})"
          >Remove</button>
        </div>
      </div>
    `;
  }).join('');
  
  // (log stripped)
  
  subtotal.textContent = money(cartSubtotalVal);
  if(itemCount) itemCount.textContent = `${totalQty} item${totalQty === 1 ? '' : 's'}`;
  
  renderSigninState();

  // Promo code wiring (validate via backend and persist)
  try{
    const promoInput = byId('promoCode');
    const promoBtn = byId('applyPromo');
    const promoMsg = byId('promoMsg');
    if(promoInput && promoMsg){
      const saved = localStorage.getItem('h2s_promo_code') || '';
      if(saved && !promoInput.value){
        promoInput.value = saved;
        promoMsg.textContent = 'Saved code will be applied at checkout.';
        promoMsg.style.color = '#0b6e0b';
      }
    }
    if(promoBtn){
      promoBtn.onclick = async () => {
        const code = (byId('promoCode')?.value || '').trim();
        if(!code){
          if(promoMsg){ promoMsg.textContent = 'Enter a promo code'; promoMsg.style.color = '#c33'; }
          return;
        }
        const prev = promoBtn.textContent;
        promoBtn.disabled = true; promoBtn.textContent = 'Checking';
        try{
          // First validate code generically
          const baseUrl = API.replace('/api/shop','/api/promo_validate') + '?code=' + encodeURIComponent(code);
          const resp = await fetch(baseUrl);
          const data = await resp.json();
          if(!(data && data.ok && data.valid)){
            localStorage.removeItem('h2s_promo_code');
            if(promoMsg){ promoMsg.textContent = 'Invalid or expired code'; promoMsg.style.color = '#c33'; }
          } else {
            // Save and then check applicability against current cart
            localStorage.setItem('h2s_promo_code', (data.promo?.code||code));
            if(promoMsg){
              const c = data.promo?.coupon||{};
              let desc = '';
              if(c.percent_off){ desc = `${c.percent_off}% off`; }
              else if(c.amount_off){ desc = `${money((c.amount_off||0)/100)} off`; }
              promoMsg.textContent = `? Code recognized${desc?`: ${desc}`:''}. Checking cart`;
              promoMsg.style.color = '#0b6e0b';
            }
            await updatePromoEstimate();
          }
        }catch(e){
          if(promoMsg){ promoMsg.textContent = 'Could not validate code. Try again.'; promoMsg.style.color = '#c33'; }
        }finally{
          promoBtn.disabled = false; promoBtn.textContent = prev;
        }
      };
    }
  }catch(_){ /* ignore promo wiring errors */ }
  
  // Update recommendation panels
  renderBundlePanel();
  queueRenderRecsPanel();

  // Update promo estimate whenever cart repaints
  Promise.resolve().then(()=>{ try{ updatePromoEstimate(); }catch(_){} });
}

async function updatePromoEstimate(){
  try{
    const promoLine = byId('promoLine');
    const promoAmount = byId('promoAmount');
    const promoMsg = byId('promoMsg');
    if(!promoLine || !promoAmount) return;
    const code = localStorage.getItem('h2s_promo_code') || '';
    if(!code){ promoLine.style.display = 'none'; return; }

    // Build line_items from current cart (packages only for now)
    const line_items = (cart||[]).map(item => {
      // FIX: Accept both 'package' and 'bundle' types
      if(item.type !== 'package' && item.type !== 'bundle') return null;
      
      const bundle = (catalog?.bundles||[]).find(b => b.bundle_id === (item.bundle_id || item.id));
      
      // FIX: Allow items without stripe_price_id if they have a price (for custom/legacy items)
      const priceId = bundle?.stripe_price_id || 'custom';
      
      // Calculate unit amount (cents)
      let unitAmount = 0;
      
      // FIX: Check for dynamic pricing override (use cart price instead of catalog price)
      const isDynamic = ['tv_multi', 'cam_basic', 'cam_standard', 'cam_premium'].includes(item.id || item.bundle_id);
      
      if(!isDynamic && bundle && bundle.bundle_price !== undefined && bundle.bundle_price !== null) {
        unitAmount = Math.round(Number(bundle.bundle_price) * 100);
      } else {
        unitAmount = Math.round(Number(item.price || 0) * 100);
      }
      
      if(!priceId && !unitAmount) return null;
      
      return { price: priceId, unit_amount: unitAmount, quantity: item.qty || 1 };
    }).filter(Boolean);
    if(!line_items.length){ promoLine.style.display = 'none'; return; }

    const resp = await fetch(API, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ __action:'promo_check_cart', promotion_code: code, line_items })});
    const data = await resp.json();
    if(data && data.ok && data.applicable && data.estimate){
      const cents = Number(data.estimate.savings_cents||0);
      const savingsAmount = cents/100;
      promoAmount.textContent = '-' + money(savingsAmount);
      const label = byId('promoLineLabel');
      if(label) label.textContent = `Promo (${(data.promotion_code||code).toUpperCase()})`;
      promoLine.style.display = '';
      
      // Calculate and display grand total
      const grandTotalLine = byId('grandTotalLine');
      const grandTotal = byId('grandTotal');
      const subtotalEl = byId('cartSubtotal');
      if(grandTotal && grandTotalLine && subtotalEl) {
        const subtotalText = subtotalEl.textContent || '$0.00';
        const subtotalValue = parseFloat(subtotalText.replace(/[^0-9.]/g, ''));
        const finalTotal = Math.max(0, subtotalValue - savingsAmount);
        
        grandTotal.textContent = money(finalTotal);
        grandTotalLine.style.display = '';
        
        // Highlight 100% off
        if(finalTotal === 0) {
          grandTotal.style.color = '#10b981';
          grandTotal.style.fontSize = '20px';
        } else {
          grandTotal.style.color = 'var(--cobalt)';
          grandTotal.style.fontSize = '18px';
        }
      }
      
      if(promoMsg){ promoMsg.textContent = ' Code will apply at checkout.'; promoMsg.style.color = '#0b6e0b'; }
    } else {
      promoLine.style.display = 'none';
      const grandTotalLine = byId('grandTotalLine');
      if(grandTotalLine) grandTotalLine.style.display = 'none';
      if(promoMsg){ promoMsg.textContent = 'This code does not apply to your current items.'; promoMsg.style.color = '#c33'; }
    }
  }catch(_){
    const promoLine = byId('promoLine'); 
    const grandTotalLine = byId('grandTotalLine');
    if(promoLine) promoLine.style.display = 'none';
    if(grandTotalLine) grandTotalLine.style.display = 'none';
  }
}

function removeFromCart(idx){
  logger.log('[Cart] Removing item at index:', idx);
  try {
    cart.splice(idx, 1);
    saveCart();
  } catch(e) {
    logger.error('[Cart] Error removing item:', e);
  }
}

// === AI RECOMMENDATIONS ===
async function loadAIRecommendations(){
  if(!user || !user.email) return;
  
  try{
    const res = await fetch(`${API}?action=ai_sales&email=${encodeURIComponent(user.email)}&mode=recommendations`);
    const data = await res.json();
    
    if(!data.success || !data.ai_analysis || !data.ai_analysis.recommendations) return;
    
    const recs = data.ai_analysis.recommendations.slice(0, 3);
    if(recs.length === 0) return;
    
    renderAIRecommendations(recs);
  }catch(err){
    logger.error('Failed to load AI recommendations:', err);
  }
}

function renderAIRecommendations(recs){
  const panel = byId('aiRecommendationsPanel');
  const container = byId('aiRecommendations');
  if(!panel || !container) return;
  
  const html = recs.map(rec => {
    const service = rec.service || rec.title || 'Recommended Service';
    const reason = rec.thought_spark || rec.reason || '';
    const price = rec.price || 0;
    
    return `
      <div class="ai-rec-card">
        <div class="ai-rec-name">${escapeHtml(service)}</div>
        <div class="ai-rec-reason">"${escapeHtml(reason)}"</div>
        ${price > 0 ? `<div class="ai-rec-price" style="margin-top:8px;font-size:14px;color:var(--muted);">Starting at ${money(price)}</div>` : ''}
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
  panel.style.display = 'block';
}

// === BUNDLE RECOMMENDATIONS (Smart Swap) ===
function bundlesMatchingCart(){
  const rec = [];
  const bundles = (catalog.bundles||[]).filter(b => b.active!==false);
  
  for(const b of bundles){
    const plan = calcBundlePlan(b);
    if(plan && plan.savings > 0) rec.push(plan);
  }
  
  rec.sort((a,b)=> b.savings - a.savings);
  return rec;
}

function calcBundlePlan(bundle){
  const recipe = (catalog.bundleItems||[]).filter(it => String(it.bundle_id)===String(bundle.bundle_id));
  if(!recipe.length) return null;

  const use = {};
  for(const item of recipe){
    const need = Number(item.required_qty||0);
    const have = cart.find(l => !l.type && String(l.service_id)===String(item.service_id));
    if(!have || Number(have.qty||0) < need) return null;
    use[item.service_id] = need;
  }

  let requiredCost = 0;
  for(const item of recipe){
    const tier = pickTier(item.service_id, Number(item.required_qty||0), null) || pickTier(item.service_id, 1, null);
    const unit = tier ? Number(tier.unit||0) : 0;
    requiredCost += unit * Number(item.required_qty||0);
  }

  const bundlePrice = Number(bundle.bundle_price||0);
  const savings = Math.max(0, requiredCost - bundlePrice);

  const serviceMap = indexBy((catalog.services||[]), 'service_id');
  const lineList = recipe.map(r=>{
    const s = serviceMap[r.service_id];
    return `${Number(r.required_qty||0)} ?&mdash; ${(s && s.name) ? s.name : r.service_id}`;
  });

  return {
    bundle_id: bundle.bundle_id,
    name: bundle.name || bundle.bundle_id,
    image_url: bundle.image_url || '',
    savings,
    requiredCost,
    bundlePrice,
    use,
    recipeList: lineList
  };
}

function applyBundleSwap(bundle_id){
  const plan = bundlesMatchingCart().find(p=> p.bundle_id===bundle_id);
  if(!plan) return;
  
  Object.entries(plan.use).forEach(([sid, reqQty])=>{
    const ln = cart.find(l=> !l.type && l.service_id===sid);
    if(!ln) return;
    ln.qty = Math.max(0, Number(ln.qty||0) - Number(reqQty||0));
  });
  
  cart = cart.filter(l=> !( !l.type && Number(l.qty||0)===0 ));
  const existing = cart.find(l=> l.type==='bundle' && l.bundle_id===bundle_id);
  if(existing) existing.qty += 1;
  else cart.push({ type:'bundle', bundle_id, qty:1 });
  
  saveCart();
}

function renderBundlePanel(){
  const panel = byId('bundlePanel');
  if(!panel) return;
  
  const suggestions = bundlesMatchingCart();
  if(!suggestions.length){ 
    panel.style.display='none'; 
    panel.innerHTML=''; 
    return; 
  }

  panel.style.display='';
  panel.innerHTML = suggestions.map(p=>`
    <div class="bundle-card">
      <div class="b-head">
        <div class="b-name">${escapeHtml(p.name)}</div>
        <div class="b-save">Save ${money(p.savings)}</div>
      </div>
      <div class="b-list">${p.recipeList.map(escapeHtml).join(' &bull; ')}</div>
      <div class="b-actions">
        <button class="btn btn-primary" data-apply="${p.bundle_id}">Swap & Save</button>
      </div>
    </div>
  `).join('');

  panel.querySelectorAll('[data-apply]').forEach(btn=>{
    btn.onclick = ()=> applyBundleSwap(btn.getAttribute('data-apply'));
  });
}

// (Rule-based recommendations moved to bundles-extra-deferred.js)

// === CHECKOUT ===
function showCheckoutError(msg){
  const errorDiv = byId('checkoutError');
  const errorMsg = byId('checkoutErrorMsg');
  const dismissBtn = byId('dismissError');
  
  if(errorDiv && errorMsg){
    errorMsg.textContent = msg;
    errorDiv.hidden = false;
    
    if(dismissBtn){
      dismissBtn.onclick = ()=> errorDiv.hidden = true;
    }
    
    // Auto-hide after 8 seconds
    setTimeout(()=> errorDiv.hidden = true, 8000);
  }
}


// === DEFERRED HEAVY LOGIC ===
// Loaded only when needed (Account, Checkout, Auth)

// === UTILITY FUNCTIONS FOR DEFERRED BUNDLE ===
function escapeAttr(text) {
  if(!text) return '';
  return String(text).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

function showMsg(elId, txt, isError = true) {
  const el = document.getElementById(elId);
  if(el) {
    el.textContent = txt;
    el.style.color = isError ? '#d32f2f' : '#2e7d32';
  }
}

// === CHECKOUT (Deferred) ===
// Load checkout modal logic on demand
window.checkout = function() {
  logger.log('[Checkout] Starting checkout flow...');
  
  // 1. Validate Cart
  if (!cart || cart.length === 0) {
    alert('Your cart is empty.');
    return;
  }

  // 2. Show Checkout Modal to collect/confirm details
  showCheckoutModal();
};

function showCheckoutModal() {
  const modal = document.getElementById('modal');
  const backdrop = document.getElementById('backdrop');
  if (!modal || !backdrop) {
    logger.error('Modal elements missing!');
    return;
  }

  // Ensure visibility
  modal.style.contentVisibility = 'visible';
  modal.style.display = 'flex'; // Force flex display
  
  // Pre-fill data
  const preName = user?.name || '';
  const preEmail = user?.email || '';
  const prePhone = user?.phone || '';
  
  let preAddress = '', preCity = '', preZip = '';
  try {
    const pending = JSON.parse(sessionStorage.getItem('h2s_pending_account') || '{}');
    if(pending.address) preAddress = pending.address;
    if(pending.city) preCity = pending.city;
    if(pending.zip) preZip = pending.zip;
  } catch(e){}

  const html = `
    <div style="padding: 24px; max-width: 500px; margin: 0 auto;">
      <h2 style="margin-top:0; color:var(--cobalt); font-weight:900; font-size:24px;">Complete Your Order</h2>
      <p style="color:var(--muted); margin-bottom:20px; font-size:14px;">Enter your details to finalize checkout and schedule installation.</p>
      
      <form id="checkoutForm" onsubmit="handleCheckoutSubmit(event)">
        <div style="margin-bottom:12px;">
          <label style="display:block; font-weight:600; font-size:14px; margin-bottom:4px; color:var(--ink);">Full Name</label>
          <input type="text" id="coName" class="inp" required value="${escapeAttr(preName)}" placeholder="Jane Doe" style="width:100%">
        </div>
        
        <div style="margin-bottom:12px;">
          <label style="display:block; font-weight:600; font-size:14px; margin-bottom:4px; color:var(--ink);">Email Address</label>
          <input type="email" id="coEmail" class="inp" required value="${escapeAttr(preEmail)}" placeholder="jane@example.com" style="width:100%">
        </div>
        
        <div style="margin-bottom:12px;">
          <label style="display:block; font-weight:600; font-size:14px; margin-bottom:4px; color:var(--ink);">Phone Number</label>
          <input type="tel" id="coPhone" class="inp" required value="${escapeAttr(prePhone)}" placeholder="(864) 528-1475" style="width:100%">
        </div>
        
        <div style="margin-bottom:12px;">
          <label style="display:block; font-weight:600; font-size:14px; margin-bottom:4px; color:var(--ink);">Service Address</label>
          <input type="text" id="coAddress" class="inp" required value="${escapeAttr(preAddress)}" placeholder="123 Main St" style="width:100%">
        </div>
        
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:12px; margin-bottom:20px;">
          <div>
            <label style="display:block; font-weight:600; font-size:14px; margin-bottom:4px; color:var(--ink);">City</label>
            <input type="text" id="coCity" class="inp" required value="${escapeAttr(preCity)}" placeholder="Greenville" style="width:100%">
          </div>
          <div>
            <label style="display:block; font-weight:600; font-size:14px; margin-bottom:4px; color:var(--ink);">Zip</label>
            <input type="text" id="coZip" class="inp" required value="${escapeAttr(preZip)}" placeholder="29601" style="width:100%">
          </div>
        </div>

        <div id="coError" style="color:#d32f2f; font-size:14px; margin-bottom:12px; display:none; background:#fee; padding:8px; border-radius:4px;"></div>

        <div style="display:flex; gap:10px;">
          <button type="button" class="btn btn-ghost" onclick="closeModal()" style="flex:1;">Cancel</button>
          <button type="submit" class="btn btn-primary" id="coSubmitBtn" style="flex:2;">Proceed to Payment</button>
        </div>
      </form>
    </div>
  `;

  // Replace modal content
  const modalContent = modal.querySelector('.modal-content');
  if(modalContent) {
    modalContent.innerHTML = html;
  } else {
    modal.innerHTML = `<div class="modal-content">${html}</div>`;
  }

  modal.classList.add('show');
  backdrop.classList.add('show');
  
  // Focus first empty field
  setTimeout(() => {
    if(!document.getElementById('coName').value) document.getElementById('coName').focus();
    else if(!document.getElementById('coAddress').value) document.getElementById('coAddress').focus();
  }, 100);
}

window.handleCheckoutSubmit = async function(e) {
  e.preventDefault();
  
  const btn = document.getElementById('coSubmitBtn');
  const errEl = document.getElementById('coError');
  
  // Gather data
  const name = document.getElementById('coName').value.trim();
  const email = document.getElementById('coEmail').value.trim();
  const phone = document.getElementById('coPhone').value.trim();
  const address = document.getElementById('coAddress').value.trim();
  const city = document.getElementById('coCity').value.trim();
  const zip = document.getElementById('coZip').value.trim();

  if(!name || !email || !phone || !address || !city || !zip) {
    if(errEl) { errEl.textContent = 'Please fill in all fields.'; errEl.style.display = 'block'; }
    return;
  }

  // UI Loading state
  if(btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Processing...'; }
  if(errEl) errEl.style.display = 'none';

  try {
    // Promo Code
    const promoCode = localStorage.getItem('h2s_promo_code');

    // Build cart_items for metadata (includes TV configurations)
    const cart_items = cart.map(item => ({
      name: item.name || item.service_name || item.id,
      qty: item.qty || 1,
      price: Math.round((item.price || item.unit_price || 0) * 100), // Convert to cents
      metadata: item.metadata || {} // Preserve TV size, mount type, etc.
    }));

    // Payload - Use cart-based checkout for metadata preservation
    const payload = {
      __action: 'create_checkout_session',
      customer: {
        name: name,
        email: email,
        phone: phone
      },
      cart: cart, // Send full cart with metadata
      source: 'shop_rebuilt',
      success_url: 'https://home2smart.com/bundles?view=shopsuccess&session_id={CHECKOUT_SESSION_ID}',
      cancel_url: window.location.href,
      metadata: {
        customer_name: name,
        customer_phone: phone,
        customer_email: email,
        service_address: address,
        service_city: city,
        service_zip: zip,
        source: 'shop_rebuilt',
        cart_items: JSON.stringify(cart_items) // Include for webhook processing
      }
    };

    if(promoCode) payload.promotion_code = promoCode;

    logger.log('[Checkout] Sending payload:', payload);

    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    
    if(!data.ok) {
      throw new Error(data.error || 'Server returned error');
    }

    if(data.pay && data.pay.session_url) {
      // Save user data for next time
      try {
        localStorage.setItem('h2s_guest_checkout', JSON.stringify({ name, email, phone, address, city, zip }));
        if(!user.email) {
          // Update local user object if guest
          user = { name, email, phone };
          saveUser();
        }
      } catch(e){}

      // Success! Redirect.
      window.location.href = data.pay.session_url;
    } else {
      throw new Error('No session URL in response');
    }

  } catch (err) {
    logger.error('[Checkout] Error:', err);
    if(errEl) {
      errEl.textContent = 'Checkout failed: ' + err.message;
      errEl.style.display = 'block';
    }
    if(btn) { btn.disabled = false; btn.textContent = 'Proceed to Payment'; }
  }
};

// Diagnostics: run a dry checkout to identify failures
window.__runDiagnoseCheckout = async function(){
  const errEl = document.getElementById('coError') || document.getElementById('cartMsg');
  const showErr = (msg) => {
    if(errEl){ errEl.textContent = msg; errEl.style.display = 'block'; }
    logger.error('[Diagnose] ' + msg);
  };

  if(!Array.isArray(cart) || cart.length===0){
    return showErr('Cart is empty. Add at least one item.');
  }

  try{
    const line_items = cart.map(item => {
      let priceId = item.stripe_price_id;
      if(!priceId && (item.type === 'package' || item.type === 'bundle')){
        const id = item.id || item.bundle_id;
        const b = catalog?.bundles?.find(x => x.bundle_id === id);
        if(b) priceId = b.stripe_price_id;
      }
      if(!priceId && item.service_id && catalog?.priceTiers){
        const qty = Number(item.qty || 1);
        const tiers = catalog.priceTiers.filter(t => t.service_id === item.service_id);
        const tier = tiers.find(t => {
          const min = Number(t.min_qty || 0);
          const max = (t.max_qty === '' || t.max_qty == null) ? Infinity : Number(t.max_qty);
          return qty >= min && qty <= max;
        });
        if(tier) priceId = tier.stripe_price_id;
      }
      if(!priceId){
        logger.warn('[Diagnose] Missing price ID for item:', item);
        return null;
      }
      return { price: priceId, quantity: item.qty || 1 };
    }).filter(Boolean);

    if(line_items.length===0){
      return showErr('No valid Stripe price IDs found for cart items.');
    }

    const payload = {
      __action: 'create_checkout_session',
      line_items,
      customer_email: user?.email || 'guest@example.com',
      success_url: 'https://home2smart.com/bundles?view=shopsuccess&session_id={CHECKOUT_SESSION_ID}',
      cancel_url: window.location.href,
      metadata: { source: 'shop_rebuilt_diagnose' },
      diagnose: true
    };

    logger.log('[Diagnose] Payload preview:', payload);
    const res = await fetch(API, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const text = await res.text();
    let data = {};
    try { data = JSON.parse(text); } catch(e){ logger.warn('[Diagnose] Non-JSON response:', text); }

    logger.log('[Diagnose] Response status:', res.status);
    logger.log('[Diagnose] Response body:', data.ok ? data : text);

    if(!res.ok){
      return showErr('Backend HTTP error ' + res.status + '. Body: ' + (text||''));
    }
    if(!data.ok){
      return showErr('Backend returned error: ' + (data.error||'Unknown error'));
    }
    if(!(data.pay && data.pay.session_url)){
      return showErr('No session_url from backend. Check Stripe session creation.');
    }
    logger.log('? Diagnose OK. session_url:', data.pay.session_url);
    if(errEl){ errEl.style.display = 'none'; }
  }catch(err){
    showErr('Diagnose failed: ' + err.message);
  }
};

function showCheckoutError(msg){
  const el = document.getElementById('cartMsg');
  const btn = document.getElementById('checkoutBtn');
  if(el) {
    el.textContent = msg;
    el.style.color = '#d32f2f';
  }
  if(btn) {
    btn.disabled = false;
    btn.textContent = 'Checkout';
  }
  alert(msg);
}

// === SHOP SUCCESS ===
window.renderShopSuccess = async function(){
  logger.log('[renderShopSuccess] Function called');
  const params = new URL(location.href).searchParams;
  const sessionId = params.get('session_id') || params.get('stripe_session_id') || '';
  logger.log('[renderShopSuccess] Session ID:', sessionId);

  let order = {
    order_id:           params.get('order_id') || '',
    stripe_session_id:  sessionId,
    order_created_at:   params.get('order_created_at') || new Date().toISOString(),
    order_source:       params.get('order_source') || '/shop',
    order_total:        params.get('order_total') || '',
    order_subtotal:     params.get('order_subtotal') || '',
    order_tax:          params.get('order_tax') || '',
    order_fees:         params.get('order_fees') || '',
    order_currency:     params.get('order_currency') || 'USD',
    order_discount_code:   params.get('order_discount_code') || '',
    order_discount_amount: params.get('order_discount_amount') || '',
    order_item_count:   params.get('order_item_count') || '',
    order_summary:      params.get('order_summary') || '',
    order_lines_json:   params.get('order_lines_json') || '',
    bundle_applied:     params.get('bundle_applied') || '',
    membership_plan:    params.get('membership_plan') || '',
    utm_source:   params.get('utm_source') || '',
    utm_medium:   params.get('utm_medium') || '',
    utm_campaign: params.get('utm_campaign') || '',
    utm_term:     params.get('utm_term') || '',
    utm_content:  params.get('utm_content') || ''
  };

  // PRIORITY 1: Mark session as success_redirect in backend
  if(sessionId){
    try{
      await fetch(API, {
        method: 'POST',
        body: JSON.stringify({
          __action: 'mark_session',
          session_id: sessionId,
          status: 'success_redirect',
          note: 'User returned from Stripe at ' + new Date().toISOString()
        })
      });
      logger.log('? Marked session as success_redirect:', sessionId);
    }catch(err){
      logger.error('Failed to mark session:', err);
    }
  }

  // PRIORITY 2: Fetch authoritative order data from backend
  if(sessionId){
    try{
      const res = await fetch(`${API}?action=orderpack&session_id=${sessionId}`);
      const data = await res.json();
      if(data.ok && data.summary){
        logger.log('? Fetched order pack from backend:', data.summary.order_id);
        order.order_id = data.summary.order_id || sessionId;
        order.order_total = typeof data.summary.total === 'number' ? String(data.summary.total.toFixed(2)) : (data.summary.total || '');
        order.order_subtotal = typeof data.summary.subtotal === 'number' ? String(data.summary.subtotal.toFixed(2)) : (data.summary.subtotal || '');
        order.order_currency = data.summary.currency || 'USD';
        order.order_item_count = String(data.lines?.length || 0);
        order.order_created_at = data.summary.created_at || order.order_created_at;
        order.order_discount_code = data.summary.discount_code || '';
        order.order_discount_amount = data.summary.discount_amount || '';
        
        // Build summary from line items
        const parts = [];
        (data.lines||[]).forEach(l => {
          if(String(l.line_type||'') === 'bundle'){
            const bundleName = l.bundle_id || 'Bundle';
            parts.push(`${Number(l.qty||1)} ${bundleName}`);
          }else{
            const serviceName = l.service_id || 'Service';
            parts.push(`${Number(l.qty||0)} ${serviceName}`);
          }
        });
        order.order_summary = parts.join(' | ');
      }
    }catch(err){
      logger.error('Failed to fetch order pack:', err);
    }
  }

  // Fallback to snapshot if backend fetch failed
  if(!order.order_id || !order.order_summary){
    try{
      const snap = JSON.parse(localStorage.getItem('h2s_checkout_snapshot') || '{}');
      if(Array.isArray(snap.cart)){
        logger.log('? Using localStorage fallback for order data');
        if(!order.order_item_count) order.order_item_count = String(snap.cart.reduce((n,l)=> n + Number(l.qty||0), 0));
        if(!order.order_subtotal) order.order_subtotal = typeof snap.subtotal === 'number' ? String(snap.subtotal.toFixed(2)) : '';
        if(!order.order_currency) order.order_currency = snap.currency || 'USD';
        
        if(!order.order_summary){
          const parts = [];
          snap.cart.forEach(l=>{
            if(l.type==='package'){
              parts.push(`${Number(l.qty||1)} ${l.name||'Package'}`);
            }else{
              parts.push(`${Number(l.qty||0)} ${l.service_id||'Service'}`);
            }
          });
          order.order_summary = parts.join(' | ');
        }
        
        if(!order.order_lines_json) order.order_lines_json = encodeURIComponent(JSON.stringify(snap.cart||[]));
        if(!order.order_created_at) order.order_created_at = snap.created_at || new Date().toISOString();
        if(!order.order_source) order.order_source = snap.source || '/shop';
        
        if(!order.order_id){
          order.order_id = sessionId || '';
        }
      }
    }catch(err){
      logger.error('Failed to parse localStorage snapshot:', err);
    }
  }

  const prettyTotal = order.order_total ? money(Number(order.order_total)) : '$0.00';
  const displayOrderId = order.order_id || sessionId || 'N/A';
  const shortOrderId = displayOrderId.length > 20 ? displayOrderId.substring(0, 20) + '...' : displayOrderId;

  cart = [];
  saveCart();
  localStorage.removeItem('h2s_checkout_snapshot');

  h2sTrack('Purchase', {
    order_id: displayOrderId,
    value: order.order_total || order.order_subtotal || '0',
    currency: order.order_currency || 'USD',
    num_items: order.order_item_count || '0'
  });

  const outlet = byId('outlet');
  outlet.innerHTML = `
    <section class="form" style="max-width: 720px; margin: 60px auto 40px;">
      <!-- Success Header -->
      <div style="text-align: center; margin-bottom: 32px;">
        <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <h2 style="margin: 0 0 8px 0; font-weight: 900; font-size: 28px; color: var(--cobalt);">Order Confirmed!</h2>
        <p style="margin: 0; color: var(--muted); font-size: 15px;">Thank you for choosing Home2Smart</p>
      </div>

      <!-- Order Details Card -->
      <div style="background: #f8f9fb; border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 800; color: var(--cobalt); text-transform: uppercase; letter-spacing: 0.5px;">Order Details</h3>
        
        <div class="details-grid" style="display: grid; gap: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
            <span style="font-weight: 600; color: var(--muted); font-size: 14px;">Order ID</span>
            <span style="font-family: monospace; font-size: 13px; color: var(--cobalt); font-weight: 700; word-break: break-all; max-width: 60%; text-align: right;" title="${escapeHtml(displayOrderId)}">${escapeHtml(shortOrderId)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
            <span style="font-weight: 600; color: var(--muted); font-size: 14px;">Items</span>
            <span style="font-weight: 700; color: var(--ink); font-size: 14px;">${escapeHtml(order.order_summary || (order.order_item_count ? `${order.order_item_count} item${order.order_item_count === '1' ? '' : 's'}` : 'Processing...'))}</span>
          </div>
          
          ${order.order_discount_code ? `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
            <span style="font-weight: 600; color: var(--muted); font-size: 14px;">Promo Applied</span>
            <span style="font-weight: 700; color: #059669; font-size: 14px; font-family: monospace;">${escapeHtml(order.order_discount_code)}</span>
          </div>
          ` : ''}
          
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0 0 0;">
            <span style="font-weight: 800; color: var(--ink); font-size: 16px;">Total Paid</span>
            <span style="font-weight: 900; color: var(--cobalt); font-size: 22px;">${escapeHtml(prettyTotal)} <span style="font-size: 14px; font-weight: 600; color: var(--muted);">${escapeHtml(order.order_currency?.toUpperCase() || 'USD')}</span></span>
          </div>
        </div>
      </div>

      <!-- Next Step: Native Scheduling -->
      <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid #93c5fd; border-radius: 12px; padding: 16px; margin-bottom: 24px; box-sizing: border-box; overflow: hidden;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div style="width: 32px; height: 32px; background: var(--cobalt); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </div>
          <h3 style="margin: 0; font-size: 17px; font-weight: 800; color: var(--cobalt);">Schedule Your Installation</h3>
        </div>
        <p style="margin: 0; color: #1e3a8a; font-size: 14px; line-height: 1.6;">Pick a date from the calendar, then choose your preferred time window.</p>
        
        <!-- Calendar Grid -->
        <div id="calendarWidget" style="background: white; border-radius: 8px; padding: 12px; margin: 16px auto 0; max-width: 100%; width: 100%; box-sizing: border-box; overflow-x: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);"></div>
        
        <!-- Time Window Selection (appears after date selected) -->
        <div id="timeWindowSection" style="display:none; margin-top:16px;">
          <label style="display:block; font-weight:600; font-size:14px; margin-bottom:8px; color:var(--ink);">Select Time Window</label>
          <div style="display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:8px; max-width: 100%; overflow: hidden;">
            <button class="time-slot-btn" data-window="9:00 AM - 12:00 PM" style="padding:10px 8px; border:2px solid var(--border); border-radius:8px; background:white; cursor:pointer; font-weight:600; font-size:13px; transition: all 0.2s; min-width:0; box-sizing:border-box;">9AM - 12PM</button>
            <button class="time-slot-btn" data-window="12:00 PM - 3:00 PM" style="padding:10px 8px; border:2px solid var(--border); border-radius:8px; background:white; cursor:pointer; font-weight:600; font-size:13px; transition: all 0.2s; min-width:0; box-sizing:border-box;">12PM - 3PM</button>
            <button class="time-slot-btn" data-window="3:00 PM - 6:00 PM" style="padding:10px 8px; border:2px solid var(--border); border-radius:8px; background:white; cursor:pointer; font-weight:600; font-size:13px; transition: all 0.2s; min-width:0; box-sizing:border-box;">3PM - 6PM</button>
          </div>
        </div>
        
        <div style="display:flex; gap:12px; margin-top:16px; justify-content: center;">
          <button class="btn btn-primary" id="confirmApptBtn" style="width: 100%; max-width: 300px; opacity: 0.5; pointer-events: none;">Confirm Appointment</button>
        </div>
        <div id="schedMsg" class="help" style="margin-top:8px;"></div>
      </div>

      <!-- Footer Actions -->
      <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
        <button class="btn btn-ghost" id="backToShop" style="min-width: 160px;">Back to Shop</button>
        <a href="tel:864-528-1475" class="btn btn-secondary" style="min-width: 160px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center;">Call Support</a>
      </div>
    </section>
  `;
  
  // Show outlet now that content is rendered
  outlet.style.opacity = '1';
  outlet.style.visibility = 'visible';

  byId('backToShop').onclick = ()=> navSet({view:null});
  
  // Build visual calendar
  let selectedDate = null;
  let selectedWindow = null;
  
  function renderCalendar() {
    const cal = byId('calendarWidget');
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const today = now.getDate();
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    
    let html = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h4 style="margin:0; font-size:16px; font-weight:800; color:var(--cobalt);">${monthNames[currentMonth]} ${currentYear}</h4>
      </div>
      <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:4px; text-align:center;">
        <div style="font-size:12px; font-weight:700; color:var(--muted); padding:8px 0;">Sun</div>
        <div style="font-size:12px; font-weight:700; color:var(--muted); padding:8px 0;">Mon</div>
        <div style="font-size:12px; font-weight:700; color:var(--muted); padding:8px 0;">Tue</div>
        <div style="font-size:12px; font-weight:700; color:var(--muted); padding:8px 0;">Wed</div>
        <div style="font-size:12px; font-weight:700; color:var(--muted); padding:8px 0;">Thu</div>
        <div style="font-size:12px; font-weight:700; color:var(--muted); padding:8px 0;">Fri</div>
        <div style="font-size:12px; font-weight:700; color:var(--muted); padding:8px 0;">Sat</div>
    `;
    
    // Empty cells before first day
    for(let i = 0; i < firstDay; i++) {
      html += `<div></div>`;
    }
    
    // Days of month
    for(let day = 1; day <= daysInMonth; day++) {
      const isPast = day < today;
      const isToday = day === today;
      const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      
      if(isPast) {
        html += `<div style="padding:12px; color:#ccc; font-size:14px;">${day}</div>`;
      } else {
        const style = isToday 
          ? 'border:2px solid var(--cobalt); border-radius:8px; cursor:pointer; font-weight:700; font-size:14px; color:var(--cobalt); transition: all 0.2s;'
          : 'border:2px solid transparent; border-radius:8px; cursor:pointer; font-size:14px; transition: all 0.2s; hover:border-color:var(--azure);';
        html += `<div class="cal-day" data-date="${dateStr}" style="${style}" onmouseover="this.style.borderColor='var(--azure)'; this.style.background='#f0f9ff';" onmouseout="if(!this.classList.contains('selected')) { this.style.borderColor='transparent'; this.style.background='white'; }">${day}</div>`;
      }
    }
    
    html += `</div>`;
    cal.innerHTML = html;
    
    // Click handlers
    document.querySelectorAll('.cal-day').forEach(dayEl => {
      dayEl.onclick = () => {
        selectedDate = dayEl.getAttribute('data-date');
        document.querySelectorAll('.cal-day').forEach(d => {
          d.classList.remove('selected');
          d.style.background = 'white';
          d.style.borderColor = 'transparent';
          d.style.color = 'inherit';
        });
        dayEl.classList.add('selected');
        dayEl.style.background = 'var(--azure)';
        dayEl.style.borderColor = 'var(--azure)';
        dayEl.style.color = 'white';
        
        byId('timeWindowSection').style.display = 'block';
        selectedWindow = null;
        document.querySelectorAll('.time-slot-btn').forEach(b => {
          b.style.borderColor = 'var(--border)';
          b.style.background = 'white';
          b.style.color = 'inherit';
        });
        byId('confirmApptBtn').style.opacity = '0.5';
        byId('confirmApptBtn').style.pointerEvents = 'none';
      };
    });
  }
  
  renderCalendar();
  
  // Time slot selection
  document.querySelectorAll('.time-slot-btn').forEach(btn => {
    btn.onclick = () => {
      selectedWindow = btn.getAttribute('data-window');
      document.querySelectorAll('.time-slot-btn').forEach(b => {
        b.style.borderColor = 'var(--border)';
        b.style.background = 'white';
        b.style.color = 'inherit';
      });
      btn.style.borderColor = 'var(--azure)';
      btn.style.background = 'var(--azure)';
      btn.style.color = 'white';
      
      const confirmBtn = byId('confirmApptBtn');
      confirmBtn.style.opacity = '1';
      confirmBtn.style.pointerEvents = 'auto';
    };
  });
  
  const confirmBtn = byId('confirmApptBtn');
  const schedMsg = byId('schedMsg');
  if(confirmBtn){
    confirmBtn.onclick = async ()=>{
      if(!selectedDate || !selectedWindow){
        if(schedMsg){ schedMsg.style.color = '#c33'; schedMsg.textContent = 'Select a date and time window.'; }
        return;
      }
      confirmBtn.disabled = true; const prev = confirmBtn.textContent; confirmBtn.textContent = 'Saving';
      try{
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/New_York';
        // Always use Stripe checkout session_id for backend lookup
        const params = new URL(location.href).searchParams;
        const sessionId = params.get('session_id') || params.get('stripe_session_id') || '';
        const stableId = sessionId || displayOrderId;
        const [startLabel, endLabel] = selectedWindow.split(' - ');
        const toIso = (label)=>{
          const d = new Date(`${selectedDate} ${label}`);
          return d.toISOString();
        };
        const startIso = toIso(startLabel);
        const endIso   = toIso(endLabel);
        logger.log('[Schedule] Sending payload', { order_id: stableId, delivery_date: selectedDate, delivery_time: selectedWindow, start_iso: startIso, end_iso: endIso, timezone: tz });
        const resp = await fetch(APIV1, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ order_id: stableId, delivery_date: selectedDate, delivery_time: selectedWindow, start_iso: startIso, end_iso: endIso, timezone: tz })
        });
        const data = await resp.json();
        if(!resp.ok || !data.ok){ throw new Error(data.error||('HTTP '+resp.status)); }
        if(schedMsg){ schedMsg.style.color = '#0b6e0b'; schedMsg.textContent = '? Appointment scheduled. Check your email for confirmation.'; }
      }catch(err){
        if(schedMsg){ schedMsg.style.color = '#c33'; schedMsg.textContent = 'Failed to schedule: ' + err.message; }
        logger.error('[Schedule] Failed to schedule', err);
      }finally{
        confirmBtn.disabled = false; confirmBtn.textContent = prev;
      }
    };
  }
};

window.handleCalReturn = async function(){
  const order_id = getParam('order_id') || '';
  const startIso = getParam('start') || '';

  byId('outlet').innerHTML = `
    <section class="form">
      <h2 style="margin:0 0 10px 0;font-weight:900">Saving your appointment</h2>
      <div class="help">Just a moment.</div>
    </section>
  `;

  try{
    // Get customer email from signed-in user, URL params, or guest checkout data
    let email = user?.email || getParam('email') || '';
    
    if(!email){
      try{
        const guestData = JSON.parse(localStorage.getItem('h2s_guest_checkout') || '{}');
        email = guestData.email || '';
      }catch(e){}
    }
    
    if(!email){
      throw new Error('Missing customer email. Please sign in or complete checkout.');
    }
    
    if(!startIso){
      throw new Error('Missing appointment time.');
    }

    // Validate date (Must be at least tomorrow)
    const apptDate = new Date(startIso);
    const today = new Date();
    
    // Normalize to midnight for date-only comparison
    apptDate.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);

    if (apptDate <= today) {
      throw new Error('Appointments must be scheduled at least 1 day in advance. Please choose a later date.');
    }
    
    const res = await fetch(APIV1, {
      method:'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        order_id: order_id || '',
        email: email,
        install_at: startIso || '',
        install_end_at: getParam('end') || '',
        timezone: getParam('tz') || ''
      })
    });
    
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || 'Failed to save appointment');
    
    logger.log('? Appointment saved, job creation triggered');
    logger.log('Job ID:', data.job_id);
    
    // Clear guest checkout data after successful booking
    localStorage.removeItem('h2s_guest_checkout');
    
    // Show success message
    byId('outlet').innerHTML = `
      <section class="form" style="text-align: center;">
        <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <h2 style="margin:0 0 10px 0;font-weight:900; color: var(--cobalt);">All Set!</h2>
        <p class="help" style="color: var(--muted);">Your appointment has been confirmed. We'll send you a reminder before your scheduled time.</p>
        <button class="btn btn-primary" onclick="navSet({view:null})" style="margin-top: 24px;">Back to Shop</button>
      </section>
    `;
    
  }catch(err){
    logger.error('? Appointment save failed:', err);
    
    // If we have an order ID, allow retrying the schedule
    const orderId = getParam('order_id') || getParam('session_id');
    const retryBtn = orderId 
      ? `<button class="btn btn-primary" onclick="navSet({view:'shopsuccess', order_id:'${escapeAttr(orderId)}'})" style="margin-top: 24px;">Pick a Different Date</button>`
      : `<button class="btn btn-primary" onclick="navSet({view:null})" style="margin-top: 24px;">Back to Shop</button>`;

    byId('outlet').innerHTML = `
      <section class="form" style="text-align: center;">
        <h2 style="margin:0 0 10px 0;font-weight:900; color: #d32f2f;">Booking Failed</h2>
        <p class="help" style="color: var(--muted);">${escapeHtml(err.message)}</p>
        ${retryBtn}
      </section>
    `;
  }
};

window.renderSignIn = function(){
  const outlet = byId('outlet');
  outlet.innerHTML = `
    <section class="form">
      <div style="text-align:center; margin-bottom:24px;">
        <a href="#" onclick="navSet({view:'shop'}); return false;" class="link-btn" style="font-size:14px; color:var(--azure); font-weight:600;">
          Back to shop
        </a>
      </div>
      <h2>Sign in to your account</h2>
      <p class="help" style="text-align:center; color:var(--text-muted); margin-bottom:20px;">Access your dashboard, track orders, and manage your account.</p>
      <input class="inp" id="siEmail" type="email" placeholder="Email address" value="${escapeAttr(user?.email||'')}" autocomplete="email">
      <input class="inp" id="siPass"  type="password" placeholder="Password" autocomplete="current-password">
      <div style="display:flex; gap:12px; margin-top:24px; flex-direction:column;">
        <button class="btn btn-primary" id="signin" style="width:100%;">Sign in</button>
        <button class="btn btn-ghost" id="toSignup" style="width:100%;">Create account</button>
        <button class="btn btn-subtle" id="toForgot" style="padding:10px; margin-top:8px;">Forgot password?</button>
      </div>
      <div id="siMsg" class="help" style="margin-top:16px; color:#d32f2f;"></div>
    </section>
  `;
  
  outlet.style.opacity = '1';
  outlet.style.transition = '';
  document.body.classList.add('app-ready');
  
  byId('toSignup').onclick = ()=> navSet({view:'signup'});
  byId('toForgot').onclick = ()=> navSet({view:'forgot'});
  byId('signin').onclick = async ()=>{
    const email = byId('siEmail').value.trim();
    const pass  = byId('siPass').value;
    if(!email){ return showMsg('siMsg','Enter your email.'); }
    if(!pass){ return showMsg('siMsg','Enter your password.'); }
    showLoader();
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'signin', email, password:pass })});
      const text = await resp.text();
      if(!resp.ok){ showMsg('siMsg', text || ('Error ' + resp.status)); return; }
      const data = JSON.parse(text);
      if(!data.ok){ showMsg('siMsg', data.error||'Sign in failed'); return; }
      user = { 
        name: data.user.name||'', 
        email: data.user.email, 
        phone: data.user.phone||'',
        referral_code: data.user.referral_code||'',
        credits: data.user.credits||0,
        total_spent: data.user.total_spent||0
      };
      saveUser();
      loadAIRecommendations();
      h2sTrack('Login', { user_email: user.email });
      navSet({view:'account'});
    }catch(err){ showMsg('siMsg', String(err)); }
    finally{ hideLoader(); }
  };
};

window.renderSignUp = function(){
  const seed = user||{};
  const outlet = byId('outlet');
  outlet.innerHTML = `
    <section class="form">
      <div style="text-align:center; margin-bottom:24px;">
        <a href="#" onclick="navSet({view:'shop'}); return false;" class="link-btn" style="font-size:14px; color:var(--azure); font-weight:600;">
          Back to shop
        </a>
      </div>
      <h2>Create your account</h2>
      <p class="help" style="text-align:center; color:var(--text-muted); margin-bottom:20px;">Get exclusive discounts, earn credits, and track your installations.</p>
      <input class="inp" id="suName"  type="text"  placeholder="Full name" value="${escapeAttr(seed.name||'')}" autocomplete="name">
      <input class="inp" id="suEmail" type="email" placeholder="Email address" value="${escapeAttr(seed.email||'')}" autocomplete="email">
      <input class="inp" id="suPhone" type="tel"   placeholder="Phone number" value="${escapeAttr(seed.phone||'')}" autocomplete="tel">
      <input class="inp" id="suPass"  type="password" placeholder="Password (min 8 characters)" autocomplete="new-password">
      <input class="inp" id="suPass2" type="password" placeholder="Confirm password" autocomplete="new-password">
      <div class="help" style="text-align:center; color:var(--text-muted); margin-top:8px;">Secure checkout, order tracking, and rewards</div>
      <div style="display:flex; gap:12px; margin-top:24px; flex-direction:column;">
        <button class="btn btn-primary" id="createAcct" style="width:100%;">Create account</button>
        <button class="btn btn-ghost" id="toSignin" style="width:100%;">Already have an account? Sign in</button>
      </div>
      <div id="suMsg" class="help" style="margin-top:16px;"></div>
    </section>
  `;
  
  outlet.style.opacity = '1';
  outlet.style.transition = '';
  document.body.classList.add('app-ready');
  
  byId('toSignin').onclick = ()=> navSet({view:'signin'});
  byId('createAcct').onclick = async ()=>{
    const name  = byId('suName').value.trim();
    const email = byId('suEmail').value.trim();
    const phone = byId('suPhone').value.trim();
    const pw1   = byId('suPass').value;
    const pw2   = byId('suPass2').value;
    const msg   = byId('suMsg');
    const btn   = byId('createAcct');
    
    if(!email){ return showMsg('suMsg','Enter your email.'); }
    if(pw1.length < 8){ return showMsg('suMsg','Password must be at least 8 characters.'); }
    if(pw1 !== pw2){ return showMsg('suMsg','Passwords do not match.'); }
    showLoader();
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'create_user', user:{name,email,phone,password:pw1}})});
      const text = await resp.text();
      if(!resp.ok){ showMsg('suMsg', text || ('Error ' + resp.status)); return; }
      const data = JSON.parse(text);
      if(!data.ok){ showMsg('suMsg', data.error||'Create failed'); return; }
      user = { 
        name: data.user.name||'', 
        email: data.user.email, 
        phone: data.user.phone||'',
        referral_code: data.user.referral_code||'',
        credits: data.user.credits||0,
        total_spent: data.user.total_spent||0
      };
      saveUser();
      loadAIRecommendations();
      h2sTrack('CompleteRegistration', { user_email: user.email, user_name: user.name });
      
      if(msg && btn){
        msg.style.color = '#2e7d32';
        msg.textContent = '? Account created! Welcome to Home2Smart.';
        btn.textContent = 'Success!';
        btn.disabled = true;
      }
      
      setTimeout(() => {
        navSet({view:'account'});
      }, 1200);
    }catch(err){ showMsg('suMsg', String(err)); }
    finally{ hideLoader(); }
  };
};

window.renderForgot = function(){
  const outlet = byId('outlet');
  outlet.innerHTML = `
    <section class="form">
      <div style="text-align:center; margin-bottom:24px;">
        <a href="#" onclick="navSet({view:'shop'}); return false;" class="link-btn" style="font-size:14px; color:var(--azure); font-weight:600;">
          Back to shop
        </a>
      </div>
      <h2>Forgot password</h2>
      <p class="help" style="text-align:center; color:var(--text-muted); margin-bottom:20px;">Enter your email and we'll send you a reset link.</p>
      <input class="inp" id="fpEmail" type="email" placeholder="Email address" autocomplete="email">
      <div style="display:flex; gap:12px; margin-top:24px; flex-direction:column;">
        <button class="btn btn-primary" id="fpSend" style="width:100%;">Send reset link</button>
        <button class="btn btn-ghost" id="fpBack" style="width:100%;">Back to sign in</button>
      </div>
      <div id="fpMsg" class="help" style="margin-top:16px; color:#d32f2f;"></div>
    </section>
  `;
  
  outlet.style.opacity = '1';
  outlet.style.transition = '';
  document.body.classList.add('app-ready');
  
  byId('fpBack').onclick = ()=> navSet({view:'signin'});
  byId('fpSend').onclick = async ()=>{
    const email = byId('fpEmail').value.trim();
    if(!email){ return showMsg('fpMsg','Enter your email.'); }
    showLoader();
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'request_password_reset', email})});
      const txt  = await resp.text();
      if(!resp.ok){ showMsg('fpMsg', txt || ('Error ' + resp.status)); return; }
      showMsg('fpMsg','If that email has an account, a reset link has been sent. Check your inbox.');
    }catch(err){ showMsg('fpMsg', String(err)); }
    finally{ hideLoader(); }
  };
};

window.renderReset = function(token){
  const outlet = byId('outlet');
  outlet.innerHTML = `
    <section class="form">
      <h2 style="margin:0 0 10px 0;font-weight:900">Reset password</h2>
      <input class="inp" id="rpToken" type="text" placeholder="Reset token" value="${escapeAttr(token||'')}">
      <input class="inp" id="rpNew1" type="password" placeholder="New password (min 8)">
      <input class="inp" id="rpNew2" type="password" placeholder="Confirm new password">
      <div style="display:flex; gap:10px; margin-top:6px; flex-wrap:wrap">
        <button class="btn azure" id="rpDo">Set new password</button>
        <button class="btn ghost" id="rpBack">Back to sign in</button>
      </div>
      <div id="rpMsg" class="help"></div>
    </section>
  `;
  
  outlet.style.opacity = '1';
  outlet.style.transition = '';
  document.body.classList.add('app-ready');
  
  byId('rpBack').onclick = ()=> navSet({view:'signin'});
  byId('rpDo').onclick = async ()=>{
    const tok = byId('rpToken').value.trim();
    const p1   = byId('rpNew1').value;
    const p2   = byId('rpNew2').value;
    if(!tok){ return showMsg('rpMsg','Missing reset token.'); }
    if(p1.length<8){ return showMsg('rpMsg','Password must be at least 8 characters.'); }
    if(p1!==p2){ return showMsg('rpMsg','Passwords do not match.'); }
    showLoader();
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'reset_password', token:tok, new_password:p1})});
      const txt  = await resp.text();
      if(!resp.ok){ showMsg('rpMsg', txt || ('Error ' + resp.status)); return; }
      const data = JSON.parse(txt);
      if(!data.ok){ showMsg('rpMsg', data.error||'Could not reset password'); return; }
      showMsg('rpMsg','Password updated. You can now sign in.');
      setTimeout(()=> navSet({view:'signin'}), 800);
    }catch(err){ showMsg('rpMsg', String(err)); }
    finally{ hideLoader(); }
  };
};

window.renderAccount = function(){
  if(!user || !user.email){ navSet({view:'signin'}); return; }

  if(!user.referral_code && !window._userRefreshing){
    window._userRefreshing = true;
    fetch(API + '?action=user&email=' + encodeURIComponent(user.email))
      .then(r=>r.json())
      .then(d=>{
        window._userRefreshing = false;
        if(d.ok && d.user){
          user = { ...user, ...d.user };
          saveUser();
          renderAccount();
        }
      }).catch(()=> window._userRefreshing = false);
  }

  const outlet = byId('outlet');
  outlet.innerHTML = `
    <section class="form">
      <div style="text-align:center; margin-bottom:24px;">
        <a href="#" onclick="navSet({view:null}); return false;" class="link-btn" style="font-size:14px; color:var(--azure); font-weight:600;">
          Back to shop
        </a>
      </div>
      <h2 style="margin:0 0 10px 0;font-weight:900">Your account</h2>
      <p class="help" style="text-align:center; color:var(--text-muted); margin-bottom:20px;">Manage your profile, view orders, and track your rewards.</p>
      <input class="inp" id="acName"  type="text"  placeholder="Full name" value="${escapeAttr(user.name||'')}">
      <input class="inp" id="acEmail" type="email" placeholder="Email" value="${escapeAttr(user.email||'')}" disabled>
      <input class="inp" id="acPhone" type="tel"   placeholder="Phone" value="${escapeAttr(user.phone||'')}">
      <div style="display:flex; gap:12px; margin-top:24px; flex-direction:column;">
        <button class="btn btn-primary" id="saveAcct" style="width:100%;">Save changes</button>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-ghost" id="signOut" style="flex:1;">Sign out</button>
        </div>
      </div>
      <div id="acMsg" class="help" style="margin-top:16px;"></div>
    </section>

    <section class="form" style="margin-top:24px">
      <h3 style="margin:0 0 10px 0;font-weight:900">Rewards & Credits</h3>
      <div class="pd-box" style="background:#f0f9ff; border-color:#bae6fd;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
          <div style="font-weight:800; color:#0284c7;">Available Credits</div>
          <div style="font-weight:900; font-size:18px; color:#0284c7;">${money(user.credits||0)}</div>
        </div>
        <div style="margin-top:12px; padding-top:12px; border-top:1px solid #bae6fd;">
          <div style="font-weight:800; color:#0284c7; margin-bottom:4px;">Your Referral Code</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <div style="font-family:monospace; font-weight:900; font-size:18px; letter-spacing:1px; background:#fff; padding:8px 12px; border-radius:6px; border:1px dashed #0284c7; color:#0284c7;">
              ${escapeHtml(user.referral_code || 'Loading...')}
            </div>
            <button class="btn btn-primary" style="padding:8px 16px; font-size:13px;" onclick="navigator.clipboard.writeText('${escapeHtml(user.referral_code||'')}').then(()=>this.textContent='Copied!')">Copy Code</button>
          </div>
          <div style="font-size:13px; color:#0369a1; margin-top:8px;">Share this code. Friends get discount, you get credit.</div>
        </div>
      </div>
    </section>

    <section class="form" style="margin-top:24px">
      <button class="btn ghost" id="cpToggle" aria-expanded="false">Change password</button>
      <div id="cpPanel" class="pd-box" style="display:none; margin-top:10px">
        <h3 style="margin:0 0 10px 0;font-weight:900">Change password</h3>
        <input class="inp" id="cpOld" type="password" placeholder="Current password">
        <input class="inp" id="cpNew1" type="password" placeholder="New password (min 8)">
        <input class="inp" id="cpNew2" type="password" placeholder="Confirm new password">
        <div style="display:flex; gap:10px; margin-top:6px; flex-wrap:wrap">
          <button class="btn azure" id="cpDo">Update password</button>
        </div>
        <div id="cpMsg" class="help"></div>
      </div>
    </section>

    <section class="form" style="margin-top:24px">
      <h3 style="margin:0 0 10px 0;font-weight:900">Previous orders</h3>
      <div id="ordersBox" class="pd-box"><div class="help">Loading</div></div>
    </section>
  `;

  byId('saveAcct').onclick = async ()=>{
    const name  = byId('acName').value.trim();
    const phone = byId('acPhone').value.trim();
    showLoader();
    try{
      const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'upsert_user', user:{name,phone,email:user.email}})});
      const text = await resp.text();
      if(!resp.ok){ showMsg('acMsg', text || ('Error ' + resp.status)); return; }
      const data = JSON.parse(text);
      if(!data.ok){ showMsg('acMsg', data.error||'Save failed'); return; }
      user = { ...user, ...data.user };
      saveUser();
      showMsg('acMsg','? Saved successfully.');
    }catch(err){ showMsg('acMsg', String(err)); }
    finally{ hideLoader(); }
  };
  byId('signOut').onclick = ()=>{ user = {}; saveUser(); navSet({view:null}); };

  outlet.style.opacity = '1';
  outlet.style.transition = '';
  document.body.classList.add('app-ready');

  const cpToggle = byId('cpToggle');
  const cpPanel  = byId('cpPanel');
  if(cpToggle && cpPanel){
    cpToggle.onclick = ()=>{
      const open = cpPanel.style.display !== 'none';
      cpPanel.style.display = open ? 'none' : '';
      cpToggle.setAttribute('aria-expanded', String(!open));
    };
  }

  const cpDo = byId('cpDo');
  if(cpDo){
    cpDo.onclick = async ()=>{
      const oldp = byId('cpOld').value;
      const p1   = byId('cpNew1').value;
      const p2   = byId('cpNew2').value;
      if(!oldp){ return showMsg('cpMsg','Enter your current password.'); }
      if(p1.length<8){ return showMsg('cpMsg','New password must be at least 8 characters.'); }
      if(p1!==p2){ return showMsg('cpMsg','Passwords do not match.'); }
      showLoader();
      try{
        const resp = await fetch(API, { method:'POST', body: JSON.stringify({__action:'change_password', email:user.email, old_password:oldp, new_password:p1})});
        const txt  = await resp.text();
        if(!resp.ok){ showMsg('cpMsg', txt || ('Error ' + resp.status)); return; }
        const data = JSON.parse(txt);
        if(!data.ok){ showMsg('cpMsg', data.error||'Could not change password'); return; }
        showMsg('cpMsg','Password updated.');
        byId('cpOld').value = byId('cpNew1').value = byId('cpNew2').value = '';
      }catch(err){ showMsg('cpMsg', String(err)); }
      finally{ hideLoader(); }
    };
  }

  loadOrders();
};

async function loadOrders(){
  const box = byId('ordersBox');
  if(!box) return;
  try{
    const res = await fetch(API + '?action=orders&email=' + encodeURIComponent(user.email));
    const data = await res.json();
    const orders = Array.isArray(data.orders) ? data.orders : [];
    if(!orders.length){
      box.innerHTML = `<div class="help">No orders yet.</div>`;
      return;
    }
    orders.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
    box.innerHTML = orders.map(o=>{
      const oid = o.order_id || o.stripe_session_id || '';
      const when = o.install_at ? new Date(o.install_at).toLocaleString() : (o.service_date||'');
      const summary = o.order_summary || '';
      const total = (Number(o.order_total)||0);
      return `
        <div class="pd-box" style="margin-bottom:10px">
          <div class="details-grid">
            <div class="row"><div class="k">Order ID</div><div class="v">${escapeHtml(String(oid))}</div></div>
            <div class="row"><div class="k">Total</div><div class="v">${money(total)}</div></div>
            <div class="row"><div class="k">Items</div><div class="v">${escapeHtml(summary||'')}</div></div>
            <div class="row"><div class="k">Service date</div><div class="v">${escapeHtml(when||'')}</div></div>
          </div>
        </div>
      `;
    }).join('');
  }catch(e){
    box.innerHTML = `<div class="help">Could not load orders.</div>`;
  }
}

window.requestQuote = function(packageId){
  const modal = document.getElementById('quoteModal');
  const backdrop = document.getElementById('backdrop');
  const titleEl = document.getElementById('quoteModalTitle');
  
  if (!modal || !backdrop) return;
  
  if (packageId === 'tv_custom') {
    titleEl.textContent = 'Custom TV Mounting Quote';
  } else if (packageId === 'cam_custom') {
    titleEl.textContent = 'Custom Security Camera Quote';
  } else {
    titleEl.textContent = 'Request Custom Quote';
  }
  
  const detailsField = document.getElementById('quoteDetails');
  if (detailsField) {
    const projectType = packageId === 'tv_custom' ? 'TV mounting' : 'security camera installation';
    detailsField.placeholder = `I need a custom ${projectType} package for...`;
  }
  
  modal.dataset.packageId = packageId;

  try{
    modal.dataset.prevFocus = document.activeElement?.id || '';
  }catch(e){ modal.dataset.prevFocus = ''; }
  
  modal.classList.add('show');
  backdrop.classList.add('show');
  document.body.style.overflow = 'hidden';
  
  setTimeout(() => {
    const nameInput = document.getElementById('quoteName');
    if (nameInput) nameInput.focus();
  }, 100);
};

window.closeQuoteModal = function(){
  const modal = document.getElementById('quoteModal');
  const backdrop = document.getElementById('backdrop');
  
  if (modal) modal.classList.remove('show');
  
  const menuOpen = document.getElementById('menuDrawer')?.classList.contains('open');
  const cartOpen = document.getElementById('cartDrawer')?.classList.contains('open');
  const mainModalOpen = document.getElementById('modal')?.classList.contains('show');
  
  if (!menuOpen && !cartOpen && !mainModalOpen && backdrop) {
    backdrop.classList.remove('show');
  }
  
  document.body.style.overflow = '';
  
  ['quoteName', 'quoteEmail', 'quotePhone', 'quoteDetails'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  
  const msg = document.getElementById('quoteMessage');
  if (msg) msg.textContent = '';

  try{
    const prevId = modal?.dataset?.prevFocus;
    if(prevId){
      const prevEl = document.getElementById(prevId);
      if(prevEl && typeof prevEl.focus === 'function') prevEl.focus();
    } else {
      const outlet = document.getElementById('outlet');
      if(outlet && typeof outlet.focus === 'function') outlet.focus();
    }
    if(modal && modal.dataset) modal.dataset.prevFocus = '';
  }catch(e){ }
};

window.submitQuoteRequest = async function(){
  const name = document.getElementById('quoteName')?.value.trim() || '';
  const email = document.getElementById('quoteEmail')?.value.trim() || '';
  const phone = document.getElementById('quotePhone')?.value.trim() || '';
  const details = document.getElementById('quoteDetails')?.value.trim() || '';
  const msg = document.getElementById('quoteMessage');
  const btn = document.getElementById('submitQuoteBtn');
  const modal = document.getElementById('quoteModal');
  const packageId = modal?.dataset.packageId || 'unknown';
  
  if (!msg || !btn) return;
  
  if (!name) {
    msg.style.color = '#d32f2f';
    msg.textContent = 'Please enter your name';
    return;
  }
  
  if (!email || !email.includes('@')) {
    msg.style.color = '#d32f2f';
    msg.textContent = 'Please enter a valid email address';
    return;
  }
  
  if (!phone) {
    msg.style.color = '#d32f2f';
    msg.textContent = 'Please enter your phone number';
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Sending...';
  msg.textContent = '';
  
  try {
    const quoteEndpoint = API.replace('/api/shop', '/api/quote');
    
    const response = await fetch(quoteEndpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name,
        email,
        phone,
        details,
        package_type: packageId,
        source: '/shop',
        timestamp: new Date().toISOString()
      })
    });
    
    const data = await response.json();
    
    if (response.ok && data.ok) {
      msg.style.color = '#2e7d32';
      msg.textContent = '? Request sent! We\'ll contact you within 1 hour.';
      
      h2sTrack('QuoteRequested', {
        package_type: packageId,
        customer_email: email,
        quote_id: data.quote_id
      });
      
      setTimeout(() => {
        closeQuoteModal();
      }, 2000);
    } else {
      throw new Error(data.error || 'Server error');
    }
  } catch (error) {
    logger.error('Quote request failed:', error);
    msg.style.color = '#d32f2f';
    msg.textContent = 'Failed to send. Please call us at (864) 528-1475';
    btn.disabled = false;
    btn.textContent = 'Send Request';
  }
};

logger.log('? Deferred logic loaded');
</script>

<!-- Performance metrics moved to deferred module to avoid main-thread work affecting LCP -->
</body>
</html>





