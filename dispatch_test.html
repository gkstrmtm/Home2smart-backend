<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dispatch Command Center - Home2Smart</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* ========================= BASE STYLES ========================= */
:root {
    /* Brand Colors */
    --brand-cobalt: #0A2A5A;
    --brand-azure: #1493FF;
    --brand-green: #22C96F;
    --brand-gold: #FFC857;
    
    /* UI Colors */
    --bg-dark: #0f172a;
    --bg-card: #1e293b;
    --bg-hover: #334155;
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --border: #334155;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-dark);
    color: var(--text-main);
    height: 100vh;
    display: flex;
    overflow: hidden;
}

/* ========================= SIDEBAR ========================= */
.sidebar {
    width: 260px;
    background: var(--brand-cobalt);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 20px;
    flex-shrink: 0;
}

.logo-container {
    margin-bottom: 40px;
    padding: 0 10px;
}

.logo-img {
    height: 32px;
    width: auto;
    display: block;
}

.nav-menu {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 8px;
    color: rgba(255,255,255,0.7);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
}

.nav-item:hover {
    background: rgba(255,255,255,0.1);
    color: #fff;
}

.nav-item.active {
    background: var(--brand-azure);
    color: #fff;
    box-shadow: 0 4px 12px rgba(20, 147, 255, 0.3);
}

.nav-icon {
    width: 20px;
    height: 20px;
    opacity: 0.8;
}

/* ========================= MAIN CONTENT ========================= */
.main-content {
    flex: 1;
    overflow-y: auto;
    padding: 30px;
    background: linear-gradient(135deg, var(--bg-dark) 0%, #1e293b 100%);
}

@media (max-width: 768px) {
    .main-content {
        padding: 16px;
    }
    
    .sidebar {
        position: fixed;
        left: -260px;
        top: 0;
        height: 100vh;
        z-index: 1000;
        transition: left 0.3s ease;
    }
    
    .sidebar.mobile-open {
        left: 0;
    }
    
    body {
        flex-direction: column;
    }
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 16px;
}

@media (max-width: 640px) {
    .page-header {
        margin-bottom: 20px;
    }
}

.page-title {
    font-size: 24px;
    font-weight: 700;
    color: #fff;
}

@media (max-width: 640px) {
    .page-title {
        font-size: 20px;
    }
}

/* ========================= CARDS & METRICS ========================= */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

@media (max-width: 640px) {
    .metrics-grid {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-bottom: 20px;
    }
}

.metric-card {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(51, 65, 85, 0.8) 100%);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 12px;
    padding: 20px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.metric-card:hover {
    border-color: rgba(20, 147, 255, 0.4);
    box-shadow: 0 8px 24px rgba(20, 147, 255, 0.15);
    transform: translateY(-2px);
}

@media (max-width: 640px) {
    .metric-card {
        padding: 16px;
    }
}

.metric-label {
    font-size: 13px;
    color: #94a3b8;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
}

.metric-value {
    font-size: 28px;
    font-weight: 700;
    color: #ffffff;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

@media (max-width: 640px) {
    .metric-value {
        font-size: 24px;
    }
}

.metric-trend {
    font-size: 13px;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.trend-up { color: var(--brand-green); }
.trend-down { color: var(--brand-gold); }

/* AI Analysis Card */
.ai-card {
    background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
    border: 1px solid var(--brand-azure);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
}

.ai-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--brand-azure), var(--brand-green));
}

.ai-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.ai-title {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
}

.ai-content {
    font-size: 14px;
    line-height: 1.6;
    color: #cbd5e1;
    white-space: pre-line;
}

/* ========================= JOBS GRID ========================= */
.jobs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

@media (max-width: 768px) {
    .jobs-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

.job-card {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(51, 65, 85, 0.9) 100%);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
    backdrop-filter: blur(10px);
}

@media (max-width: 640px) {
    .job-card {
        padding: 16px;
    }
}

.job-card:hover {
    transform: translateY(-4px);
    border-color: rgba(20, 147, 255, 0.5);
    box-shadow: 0 8px 24px rgba(20, 147, 255, 0.2);
}

@media (hover: none) {
    .job-card:hover {
        transform: none;
    }
    .job-card:active {
        transform: scale(0.98);
    }
}

.job-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
}

.job-id {
    font-family: monospace;
    font-size: 12px;
    color: var(--brand-azure);
    background: rgba(20, 147, 255, 0.1);
    padding: 4px 8px;
    border-radius: 6px;
}

.job-status {
    font-size: 11px;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 6px;
    text-transform: uppercase;
}

.status-new { background: rgba(20, 147, 255, 0.2); color: #60a5fa; }
.status-assigned { background: rgba(255, 200, 87, 0.2); color: #fbbf24; }
.status-completed { background: rgba(34, 201, 111, 0.2); color: #34d399; }

.job-title {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    margin-bottom: 8px;
    line-height: 1.4;
}

.job-meta {
    font-size: 13px;
    color: var(--text-muted);
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.meta-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

.meta-icon {
    width: 14px;
    height: 14px;
    opacity: 0.7;
}

.tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 12px;
}

.tag {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    background: rgba(255,255,255,0.1);
    color: var(--text-muted);
}

.tag.clarification {
    background: rgba(255, 200, 87, 0.2);
    color: var(--brand-gold);
    border: 1px solid rgba(255, 200, 87, 0.3);
}

/* ========================= MODAL ========================= */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}

.modal-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.modal {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 16px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 30px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

@media (max-width: 768px) {
    .modal {
        width: 100%;
        max-height: 100vh;
        border-radius: 0;
        padding: 20px;
    }
}

@media (max-width: 640px) {
    .modal {
        padding: 16px;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 24px;
    cursor: pointer;
}

.section-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--brand-azure);
    text-transform: uppercase;
    margin-bottom: 12px;
    margin-top: 24px;
}

.info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.info-item label {
    display: block;
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.info-item div {
    font-size: 14px;
    color: #fff;
}

/* Purchasing Suggestions */
.suggestion-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    gap: 16px;
    align-items: flex-start;
}

.suggestion-check {
    margin-top: 4px;
    width: 18px;
    height: 18px;
    accent-color: var(--brand-azure);
    cursor: pointer;
}

.suggestion-content {
    flex: 1;
}

.suggestion-content h4 {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #fff;
}

.suggestion-content p {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.brand-tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.brand-tag {
    font-size: 11px;
    padding: 2px 6px;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    color: #cbd5e1;
}

/* ========================= UTILS ========================= */
.hidden { display: none !important; }

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
}
.btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.btn-primary { background: var(--brand-azure); color: #fff; }
.btn-primary:hover { background: #0077e6; }
.btn-ghost { background: rgba(255,255,255,0.1); color: #fff; }
.btn-ghost:hover { background: rgba(255,255,255,0.2); }
.btn-success { background: var(--brand-green); color: #fff; }
.btn-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

/* Icons */
.icon-sm { width: 16px; height: 16px; }
.icon-md { width: 20px; height: 20px; }

</style>
</head>
<body>

<!-- Connection Status Indicator -->
<div id="connection-status" style="position:fixed; top:20px; right:20px; z-index:9999; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; padding:8px 16px; font-size:12px; display:flex; align-items:center; gap:8px; opacity:0; transition:opacity 0.3s">
    <div id="status-dot" style="width:8px; height:8px; border-radius:50%; background:var(--brand-green)"></div>
    <span id="status-text">Connected</span>
</div>

<!-- SIDEBAR -->
<div class="sidebar">
    <div class="logo-container">
        <img src="https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68da0ce6f00445991d64a63f.png" alt="Home2Smart" class="logo-img">
    </div>
    
    <div class="nav-menu">
        <div class="nav-item active" onclick="switchView('dashboard', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            Dashboard
        </div>
        <div class="nav-item" onclick="switchView('jobs', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            Jobs
        </div>
        <div class="nav-item" onclick="switchView('payouts', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Payouts
        </div>
        <div class="nav-item" onclick="openSettings()" style="margin-top:auto">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            Settings
        </div>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content">
    
    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard">
        <div class="page-header">
            <h1 class="page-title">Business Intelligence</h1>
            <div style="display:flex; gap:12px">
                <button class="btn btn-ghost" onclick="loadMetrics()">Refresh Data</button>
                <button class="btn btn-primary" onclick="generateAIReport()">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Generate AI Report
                </button>
            </div>
        </div>
        
        <div id="ai-report-container" class="hidden">
            <div class="ai-card">
                <div class="ai-header">
                    <div class="ai-title">
                        <svg class="icon-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                        Executive Analysis
                    </div>
                    <span style="font-size:12px; color:var(--text-muted)">Generated just now</span>
                </div>
                <div id="ai-content" class="ai-content">
                    Loading analysis...
                </div>
            </div>
        </div>

        <div id="metrics-container">
            <div style="text-align:center; padding:40px; color:var(--text-muted)">Loading analytics...</div>
        </div>
        
        <!-- CHARTS SECTION -->
        <div id="charts-section" class="hidden" style="margin-top:30px">
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-bottom:20px">
                <div class="metric-card">
                    <div class="metric-label">Revenue Trend (Last 30 Days)</div>
                    <canvas id="revenueChart" style="max-height:250px"></canvas>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Job Status Distribution</div>
                    <canvas id="jobStatusChart" style="max-height:250px"></canvas>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                <div class="metric-card">
                    <div class="metric-label">Capacity Utilization</div>
                    <canvas id="capacityChart" style="max-height:200px"></canvas>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Pricing Tier Breakdown</div>
                    <canvas id="pricingChart" style="max-height:200px"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- JOBS VIEW -->
    <div id="view-jobs" class="hidden">
        <div class="page-header">
            <h1 class="page-title">Dispatch Jobs</h1>
            <div style="display:flex; gap:12px">
                <select id="job-filter" onchange="loadJobs()" style="padding:12px 16px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:#fff; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s; outline:none">
                    <option value="all">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="accepted">Accepted</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <button class="btn btn-primary" onclick="loadJobs()">Refresh</button>
            </div>
        </div>
        
        <div id="jobs-grid" class="jobs-grid">
            <!-- Jobs injected here -->
        </div>
    </div>

    <!-- PAYOUTS VIEW -->
    <div id="view-payouts" class="hidden">
        <div class="page-header">
            <h1 class="page-title">Technician Payouts</h1>
            <div style="display:flex; gap:12px; align-items:center">
                <span style="font-size:14px; color:var(--text-muted)">Total Pending: <strong id="total-pending" style="color:var(--brand-gold)">$0</strong></span>
                <select id="payout-filter" onchange="loadPayouts()" style="padding:10px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:#fff; font-size:14px">
                    <option value="all">All States</option>
                    <option value="pending">Pending Review</option>
                    <option value="approved">Approved</option>
                    <option value="paid">Paid</option>
                </select>
                <button class="btn btn-ghost" onclick="loadPayouts()">Refresh</button>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="metrics-grid" style="margin-bottom:30px">
            <div class="metric-card">
                <div class="metric-label">Pending Approval</div>
                <div class="metric-value" id="payout-pending-amount">$0</div>
                <div class="metric-trend" id="payout-pending-count">0 entries</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Approved (Not Paid)</div>
                <div class="metric-value" id="payout-approved-amount" style="color:var(--brand-green)">$0</div>
                <div class="metric-trend" id="payout-approved-count">0 entries</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Paid This Month</div>
                <div class="metric-value" id="payout-paid-amount">$0</div>
                <div class="metric-trend" id="payout-paid-count">0 entries</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Lifetime</div>
                <div class="metric-value" id="payout-lifetime-amount">$0</div>
                <div class="metric-trend">All technicians</div>
            </div>
        </div>
        
        <!-- Payout Entries Table -->
        <div id="payouts-container">
            <div style="text-align:center; padding:40px; color:var(--text-muted)">Loading payouts...</div>
        </div>
    </div>

</div>

<!-- JOB DETAIL MODAL -->
<div id="job-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <div>
                <h2 id="modal-title" style="font-size:20px; font-weight:700; color:#fff; margin-bottom:4px">Job Details</h2>
                <span id="modal-id" class="job-id">ID: 12345</span>
            </div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        
        <div class="info-grid">
            <div class="info-item">
                <label>Customer</label>
                <div id="modal-customer">John Doe</div>
            </div>
            <div class="info-item">
                <label>Location</label>
                <div id="modal-location">123 Main St, City</div>
                <a id="modal-map-link" href="#" target="_blank" style="font-size:11px; color:var(--brand-azure); text-decoration:none; display:inline-flex; align-items:center; gap:4px; margin-top:4px">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    View on Google Maps
                </a>
            </div>
            <div class="info-item">
                <label>Service</label>
                <div id="modal-service">TV Mounting</div>
            </div>
            <div class="info-item">
                <label>Date</label>
                <div id="modal-date">Oct 12, 2023</div>
            </div>
        </div>

        <div id="modal-metadata">
            <!-- Job metadata details injected here -->
        </div>

        <div id="modal-photos" style="margin-top:24px">
            <!-- Customer photos injected here -->
        </div>

        <div id="modal-tech-photos" style="margin-top:24px">
            <!-- Tech-uploaded photos injected here -->
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:24px; margin-bottom:12px">
            <div class="section-title" style="margin:0">Purchasing Suggestions</div>
            <button class="btn btn-ghost" style="padding:6px 12px; font-size:12px" onclick="copySelectedItems()">
                <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                Copy Selected
            </button>
        </div>
        
        <div id="modal-suggestions">
            <!-- Suggestions injected here -->
        </div>

        <div class="section-title">Actions</div>
        <div style="display:flex; gap:12px">
            <button class="btn btn-primary" onclick="openDispatchWorkflow()">Dispatch Job</button>
            <button class="btn btn-success" onclick="markJobComplete()">Mark Complete</button>
            <button class="btn btn-ghost">Edit Details</button>
        </div>
    </div>
</div>

<!-- DISPATCH WORKFLOW MODAL -->
<div id="dispatch-modal" class="modal-overlay">
    <div class="modal" style="max-width:500px">
        <div class="modal-header">
            <h2 style="font-size:18px; font-weight:700; color:#fff">Assign Pro</h2>
            <button class="modal-close" onclick="closeDispatchModal()">&times;</button>
        </div>
        <div style="margin-bottom:20px">
            <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:13px">Select Technician</label>
            <select id="pro-select" style="width:100%; padding:12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:#fff">
                <option value="">Select a pro...</option>
                <option value="pro_1">Mike Johnson (5 stars)</option>
                <option value="pro_2">Sarah Connor (4.9 stars)</option>
                <option value="pro_3">Tech Team A (4.8 stars)</option>
            </select>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:12px">
            <button class="btn btn-ghost" onclick="closeDispatchModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmDispatch()">Confirm Assignment</button>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="modal-overlay">
    <div class="modal" style="max-width:500px">
        <div class="modal-header">
            <h2 style="font-size:18px; font-weight:700; color:#fff">Dashboard Settings</h2>
            <button class="modal-close" onclick="closeSettings()">&times;</button>
        </div>
        <div style="margin-bottom:20px">
            <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:13px">API Base URL</label>
            <input id="setting-api" type="text" style="width:100%; padding:12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:#fff; font-family:monospace" placeholder="https://h2s-backend.vercel.app/api">
            <p style="font-size:11px; color:var(--text-muted); margin-top:6px">Use full URL if running locally (e.g. https://.../api)</p>
        </div>
        <div style="margin-bottom:20px">
            <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:13px">Admin Token</label>
            <input id="setting-token" type="password" style="width:100%; padding:12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:#fff; font-family:monospace">
        </div>
        <div style="display:flex; justify-content:flex-end; gap:12px">
            <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
            <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    let API_BASE = 'https://h2s-backend-eaamxj8fu-tabari-ropers-projects-6f2e090b.vercel.app/api';
    let ADMIN_TOKEN = localStorage.getItem('h2s_admin_token') || 'e5d4100f-fdbb-44c5-802c-0166d86ed1a8';
    
    let currentJobs = [];
    let currentJobId = null;
    let connectionStatus = 'online';
    
    // Performance optimization: Cache for job data and photos
    const jobCache = {
        data: new Map(),
        photos: new Map(),
        TTL: 5 * 60 * 1000, // 5 minutes
        
        set(key, value, type = 'data') {
            const cache = type === 'photos' ? this.photos : this.data;
            cache.set(key, {
                value,
                timestamp: Date.now()
            });
        },
        
        get(key, type = 'data') {
            const cache = type === 'photos' ? this.photos : this.data;
            const item = cache.get(key);
            if (!item) return null;
            
            // Check if expired
            if (Date.now() - item.timestamp > this.TTL) {
                cache.delete(key);
                return null;
            }
            
            return item.value;
        },
        
        clear() {
            this.data.clear();
            this.photos.clear();
        }
    };
    
    // Debounce utility for performance
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Connection health check
    async function checkConnection() {
        try {
            const res = await fetch(`${API_BASE}/admin_business_intelligence`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN }),
                signal: AbortSignal.timeout(5000)
            });
            connectionStatus = res.ok ? 'online' : 'degraded';
            return res.ok;
        } catch (err) {
            connectionStatus = 'offline';
            return false;
        }
    }

    // Retry wrapper for API calls
    async function fetchWithRetry(url, options, retries = 3) {
        console.log(`[FETCH] Calling: ${url}`);
        for (let i = 0; i < retries; i++) {
            try {
                const res = await fetch(url, {
                    ...options,
                    signal: AbortSignal.timeout(10000)
                });
                
                console.log(`[FETCH] ${url} - Status: ${res.status}`);
                
                if (res.ok) {
                    connectionStatus = 'online';
                    return res;
                }
                
                if (res.status === 404) {
                    console.error(`[FETCH] 404 Not Found: ${url}`);
                    throw new Error(`Endpoint not found: ${url.split('/api/')[1] || url}`);
                }
                
                if (res.status === 401) {
                    // Auth failure - don't retry
                    throw new Error('Authentication failed. Please check your token in Settings.');
                }
                
                // Server error - retry
                if (i < retries - 1) {
                    console.log(`[FETCH] Retry ${i + 1}/${retries} after error ${res.status}`);
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                    continue;
                }
                
                throw new Error(`Server returned ${res.status}`);
                
            } catch (err) {
                console.error(`[FETCH] Error on attempt ${i + 1}:`, err.message);
                if (i === retries - 1) throw err;
                connectionStatus = 'degraded';
                await new Promise(r => setTimeout(r, 1000 * (i + 1)));
            }
        }
    }

    function openSettings() {
        document.getElementById('settings-modal').classList.add('active');
        document.getElementById('setting-api').value = API_BASE;
        document.getElementById('setting-token').value = ADMIN_TOKEN;
    }

    function closeSettings() {
        document.getElementById('settings-modal').classList.remove('active');
    }

    function saveSettings() {
        const newApi = document.getElementById('setting-api').value;
        const newToken = document.getElementById('setting-token').value;
        
        if(newApi) {
            API_BASE = newApi;
            localStorage.setItem('h2s_api_base', newApi);
        }
        
        if(newToken) {
            ADMIN_TOKEN = newToken;
            localStorage.setItem('h2s_admin_token', newToken);
        }
        
        closeSettings();
        loadMetrics(); // Reload with new settings
        alert('Settings saved!');
    }

    // --- NAVIGATION ---
    function switchView(view, el) {
        document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
        if(el) el.classList.add('active');
        
        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-jobs').classList.add('hidden');
        document.getElementById('view-payouts').classList.add('hidden');
        
        document.getElementById(`view-${view}`).classList.remove('hidden');
        
        if (view === 'dashboard') loadMetrics();
        if (view === 'jobs') loadJobs();
        if (view === 'payouts') loadPayouts();
    }

    // --- DASHBOARD METRICS ---
    async function loadMetrics() {
        const container = document.getElementById('metrics-container');
        container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted)">Loading analytics...</div>';
        
        console.log('[LOAD METRICS] Starting API call...');
        console.log('[LOAD METRICS] API_BASE:', API_BASE);
        console.log('[LOAD METRICS] ADMIN_TOKEN:', ADMIN_TOKEN);
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_business_intelligence`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN })
            });
            
            console.log('[LOAD METRICS] Response status:', res.status);
            const data = await res.json();
            console.log('[LOAD METRICS] Data received:', data);
            
            if (data.error && data.error !== 'Partial data failure - showing safe defaults') {
                throw new Error(data.error);
            }
            
            console.log('[LOAD METRICS] Rendering metrics...');
            renderMetrics(data);
            console.log('[LOAD METRICS] Rendering charts...');
            renderCharts(data);
            
            // Show warning if partial data
            if (data.error) {
                container.insertAdjacentHTML('afterbegin', 
                    '<div style="background:rgba(255,200,87,0.1); border:1px solid var(--brand-gold); padding:12px; border-radius:8px; margin-bottom:20px; font-size:13px">‚ö†Ô∏è Some data unavailable. Showing cached metrics.</div>'
                );
            }
            
            console.log('[LOAD METRICS] Complete!');
            
        } catch (err) {
            console.error('[LOAD METRICS] ERROR:', err);
            container.innerHTML = `
                <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; padding:20px; border-radius:8px; text-align:center">
                    <div style="font-size:16px; font-weight:600; margin-bottom:8px">Connection Error</div>
                    <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px">${err.message}</div>
                    <button class="btn btn-primary" onclick="loadMetrics()">Retry</button>
                    <button class="btn btn-ghost" onclick="openSettings()" style="margin-left:8px">Check Settings</button>
                </div>
            `;
        }
    }

    async function generateAIReport() {
        const container = document.getElementById('ai-report-container');
        const content = document.getElementById('ai-content');
        
        container.classList.remove('hidden');
        content.innerHTML = 'Analyzing data with AI...';
        
        try {
            const res = await fetch(`${API_BASE}/admin_business_intelligence?analyze=true`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN })
            });
            const data = await res.json();
            
            if (data.ai_analysis) {
                content.innerHTML = data.ai_analysis;
            } else {
                content.innerHTML = 'AI Analysis unavailable. Please check API configuration.';
            }
        } catch (err) {
            content.innerHTML = 'Error generating report.';
        }
    }

    function renderMetrics(data) {
        const container = document.getElementById('metrics-container');
        
        const revenue = data.revenue || {};
        const ops = data.operations || {};
        const growth = data.growth || {};
        
        container.innerHTML = `
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Revenue</div>
                    <div class="metric-value">$${(revenue.total || 0).toLocaleString()}</div>
                    <div class="metric-trend trend-up">
                        <span>Margin: ${revenue.margin}%</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Jobs Completed</div>
                    <div class="metric-value">${ops.jobs_completed || 0}</div>
                    <div class="metric-trend">
                        <span>${ops.completion_rate}% Completion Rate</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Pros</div>
                    <div class="metric-value">${data.workforce?.active_pros || 0}</div>
                    <div class="metric-trend">
                        <span>${data.workforce?.utilization_rate}% Utilization</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">MoM Growth</div>
                    <div class="metric-value">${growth.mom_growth}%</div>
                    <div class="metric-trend ${growth.mom_growth >= 0 ? 'trend-up' : 'trend-down'}">
                        <span>${growth.this_month_jobs} jobs this month</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Capacity</div>
                    <div class="metric-value">${data.capacity?.utilization_pct || 0}%</div>
                    <div class="metric-trend ${(data.capacity?.utilization_pct || 0) > 80 ? 'trend-down' : 'trend-up'}">
                        <span>${data.capacity?.current_load || 0} pending jobs</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Repeat Rate</div>
                    <div class="metric-value">${growth.repeat_rate || 0}%</div>
                    <div class="metric-trend">
                        <span>${growth.unique_customers || 0} unique customers</span>
                    </div>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                <div class="metric-card">
                    <div class="metric-label">Top Cities</div>
                    <div style="margin-top:12px">
                        ${(data.geography?.top_cities || []).slice(0,5).map(c => `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid rgba(148,163,184,0.2)">
                                <div style="display:flex; flex-direction:column; gap:4px">
                                    <span style="font-weight:600; color:#fff; text-transform:capitalize">${c.name}</span>
                                    <span style="font-size:11px; color:var(--text-muted)">${c.jobs} jobs ‚Ä¢ ${c.margin}% margin</span>
                                </div>
                                <span style="font-weight:700; color:var(--brand-green)">$${c.revenue.toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Pricing Tiers Performance</div>
                    <div style="margin-top:12px">
                        ${Object.entries(data.pricing || {}).map(([tier, stats]) => {
                            const marginColor = stats.margin >= 60 ? '#22C96F' : 
                                              stats.margin >= 40 ? '#FFC857' : '#ef4444';
                            const tierLabel = tier === 'byo' ? 'BYO (Customer Mount)' :
                                            tier === 'h2s' ? 'H2S Premium' : 'Base Package';
                            return `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid rgba(148,163,184,0.2); font-size:13px">
                                <div style="display:flex; flex-direction:column; gap:4px">
                                    <span style="text-transform:uppercase; color:var(--brand-azure); font-weight:600">${tierLabel}</span>
                                    <span style="font-size:11px; color:var(--text-muted)">${stats.jobs} jobs</span>
                                </div>
                                <div style="text-align:right">
                                    <div style="font-weight:600; color:#fff">$${stats.revenue.toLocaleString()}</div>
                                    <div style="font-size:11px; color:${marginColor}; font-weight:600">${stats.margin}% margin</div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            </div>

            <style>
                @media (max-width: 768px) {
                    div[style*="grid-template-columns: 1fr 1fr"] {
                        grid-template-columns: 1fr !important;
                    }
                }
            </style>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px">
                <div class="metric-card">
                    <div class="metric-label">Top Services</div>
                    <div style="margin-top:12px">
                        ${(data.services?.top_services || []).slice(0,5).map(s => `
                            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border)">
                                <span style="font-size:13px">${s.name}</span>
                                <span style="font-weight:600">$${s.revenue.toLocaleString()}</span>
                            </div>
                        `).join('') || '<span style="color:var(--text-muted)">No data</span>'}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Top Performers</div>
                    <div style="margin-top:12px">
                        ${(data.workforce?.top_performers || []).slice(0,5).map(p => `
                            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:13px">
                                <span>${p.name}</span>
                                <span style="color:var(--brand-green)">${p.jobs} jobs ‚Ä¢ $${p.earnings.toLocaleString()}</span>
                            </div>
                        `).join('') || '<span style="color:var(--text-muted)">No data</span>'}
                    </div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px">
                <div class="metric-card">
                    <div class="metric-label">Understaffed Markets</div>
                    <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:8px">
                        ${(data.geography?.understaffed_cities || []).map(c => `
                            <span class="tag clarification">${c}</span>
                        `).join('') || '<span style="color:var(--text-muted)">None</span>'}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Bottlenecks (>48h Pending)</div>
                    <div style="margin-top:12px">
                        ${(data.operations?.bottlenecks || []).slice(0,3).map(b => `
                            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:13px">
                                <span style="color:var(--brand-gold)">${b.job_id}</span>
                                <span>${b.hours_pending}h ‚Ä¢ ${b.status}</span>
                            </div>
                        `).join('') || '<span style="color:var(--text-muted)">No bottlenecks detected</span>'}
                    </div>
                </div>
            </div>
        `;
    }

    // --- JOBS LOGIC ---
    async function loadJobs() {
        const grid = document.getElementById('jobs-grid');
        
        // Show skeleton grid while loading
        grid.innerHTML = `
            ${[1,2,3,4,5,6].map(() => `
                <div class="job-card" style="background:rgba(255,255,255,0.03); animation:pulse 1.5s ease-in-out infinite; pointer-events:none">
                    <div style="height:16px; width:70%; background:rgba(255,255,255,0.1); border-radius:4px; margin-bottom:12px"></div>
                    <div style="height:12px; width:90%; background:rgba(255,255,255,0.08); border-radius:4px; margin-bottom:8px"></div>
                    <div style="height:12px; width:80%; background:rgba(255,255,255,0.08); border-radius:4px; margin-bottom:8px"></div>
                    <div style="height:12px; width:60%; background:rgba(255,255,255,0.08); border-radius:4px"></div>
                </div>
            `).join('')}
        `;
        
        const status = document.getElementById('job-filter').value;
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_jobs_list?token=${ADMIN_TOKEN}&status=${status}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN, status, days: 30 })
            });
            
            const data = await res.json();
            
            if (!data.ok) throw new Error(data.error || 'Failed to load jobs');
            
            currentJobs = data.jobs || [];
            renderJobs(currentJobs);
        } catch (err) {
            console.error('Jobs load error:', err);
            grid.innerHTML = `
                <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; padding:20px; border-radius:8px; text-align:center">
                    <div style="font-size:16px; font-weight:600; margin-bottom:8px">Unable to Load Jobs</div>
                    <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px">${err.message}</div>
                    <button class="btn btn-primary" onclick="loadJobs()">Retry</button>
                </div>
            `;
        }
    }

    function renderJobs(jobs) {
        const grid = document.getElementById('jobs-grid');
        if (jobs.length === 0) {
            grid.innerHTML = '<div style="text-align:center; color:var(--text-muted)">No jobs found</div>';
            return;
        }
        
        grid.innerHTML = jobs.map(job => {
            let tagsHtml = '';
            if (job.metadata && job.metadata.tags) {
                tagsHtml = job.metadata.tags.map(t => `<span class="tag">${t}</span>`).join('');
            }
            if (job.metadata && job.metadata.clarification_needed) {
                tagsHtml += `<span class="tag clarification">‚ö†Ô∏è Clarification Needed</span>`;
            }

            return `
                <div class="job-card" onclick="openJobModal('${job.job_id}')">
                    <div class="job-header">
                        <span class="job-id">${job.job_id}</span>
                        <span class="job-status status-${job.status}">${job.status}</span>
                    </div>
                    <div class="job-title">${job.city ? job.city.charAt(0).toUpperCase() + job.city.slice(1) : job.address || 'Unknown Location'} - ${job.resources_needed || job.service_name || 'Service'}</div>
                    <div class="job-meta">
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            <span>${job.customer_name || 'Unknown Customer'}</span>
                        </div>
                        ${job.assigned_pro_name || job.metadata?.pro_name ? `
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            <span style="color:var(--brand-green)">${job.assigned_pro_name || job.metadata?.pro_name}</span>
                            ${job.assigned_pro_phone || job.metadata?.pro_phone ? `<span style="color:var(--text-muted); margin-left:8px; font-size:12px">üìû ${job.assigned_pro_phone || job.metadata?.pro_phone}</span>` : ''}
                        </div>
                        ` : ''}
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span>${job.address || 'No Address'}${job.city ? ', ' + job.city.charAt(0).toUpperCase() + job.city.slice(1) : ''}${job.state ? ', ' + job.state.toUpperCase() : ''}</span>
                        </div>
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span>${new Date(job.start_iso || job.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="tags">${tagsHtml}</div>
                </div>
            `;
        }).join('');
    }

    // --- MODAL LOGIC ---
    async function openJobModal(jobId) {
        console.log('[openJobModal] Opening job:', jobId);
        const job = currentJobs.find(j => j.job_id === jobId);
        if (!job) {
            console.error('[openJobModal] Job not found in currentJobs:', jobId);
            return;
        }
        
        console.log('[openJobModal] Job data:', {
            job_id: job.job_id,
            service_name: job.service_name,
            metadata_exists: !!job.metadata,
            items_json_count: job.metadata?.items_json?.length || 0,
            purchasing_suggestions_count: job.purchasing_suggestions?.length || 0,
            assigned_pro: job.assigned_pro_name
        });
        
        currentJobId = jobId;

        document.getElementById('modal-title').innerText = job.service_name || 'Job Details';
        document.getElementById('modal-id').innerText = `ID: ${job.job_id}`;
        document.getElementById('modal-customer').innerText = job.customer_name;
        document.getElementById('modal-location').innerText = `${job.address}, ${job.city}`;
        
        const mapLink = document.getElementById('modal-map-link');
        if (job.address && job.city) {
            const query = encodeURIComponent(`${job.address}, ${job.city}, ${job.state || ''} ${job.zip || ''}`);
            mapLink.href = `https://www.google.com/maps/search/?api=1&query=${query}`;
            mapLink.classList.remove('hidden');
        } else {
            mapLink.classList.add('hidden');
        }

        document.getElementById('modal-service').innerText = job.service_name;
        document.getElementById('modal-date').innerText = new Date(job.start_iso || job.created_at).toLocaleString();

        // Show job metadata details with complete breakdown
        const metadataContainer = document.getElementById('modal-metadata');
        console.log('[openJobModal] Metadata:', job.metadata);
        console.log('[openJobModal] Items JSON:', job.metadata?.items_json);
        
        if (job.metadata && Object.keys(job.metadata).length > 0) {
            const meta = job.metadata;
            
            // Analyze equipment needs from items_json
            let equipmentBreakdown = '';
            let serviceDetails = '';
            
            if (meta.items_json && meta.items_json.length) {
                console.log('[openJobModal] Processing', meta.items_json.length, 'items');
                const items = meta.items_json;
                let totalTVMounts = 0;
                let totalCameras = 0;
                let equipmentList = [];
                
                items.forEach(item => {
                    const bundleId = item.bundle_id || item.service_name || '';
                    const qty = item.qty || 1;
                    const itemMeta = item.metadata || {};
                    
                    // TV Mount packages
                    if (bundleId.includes('tv')) {
                        const mountsNeeded = itemMeta.mounts_needed || qty;
                        totalTVMounts += mountsNeeded;
                        const tvSize = itemMeta.tv_size || 'Unknown';
                        const mountProvider = itemMeta.mount_provider === 'customer' ? 'Customer Provided' : 
                                            itemMeta.mount_provider === 'h2s' ? 'H2S Provided' : 'Standard';
                        
                        equipmentList.push({
                            type: 'TV Mount',
                            details: `${mountsNeeded}x TV Mount (${tvSize}") - ${mountProvider}`,
                            qty: mountsNeeded,
                            meta: itemMeta
                        });
                    }
                    
                    // Camera packages
                    if (bundleId.includes('cam')) {
                        const camerasInPackage = bundleId === 'cam_basic' ? 2 :
                                                 bundleId === 'cam_standard' ? 4 :
                                                 bundleId === 'cam_premium' ? 8 : qty;
                        totalCameras += camerasInPackage * qty;
                        
                        equipmentList.push({
                            type: 'Security Camera',
                            details: `${camerasInPackage * qty}x Security Cameras (${bundleId.replace('cam_', '').toUpperCase()})`,
                            qty: camerasInPackage * qty,
                            meta: itemMeta
                        });
                    }
                });
                
                // Build equipment breakdown HTML
                equipmentBreakdown = `
                    <div style="grid-column:1/-1; background:rgba(20,147,255,0.1); border:1px solid rgba(20,147,255,0.3); border-radius:8px; padding:16px; margin-bottom:16px">
                        <div style="font-weight:700; font-size:14px; margin-bottom:12px; color:var(--brand-azure)">üìã Equipment Breakdown</div>
                        ${totalTVMounts > 0 ? `<div style="margin-bottom:8px">üñ•Ô∏è <strong>${totalTVMounts} TV Mount${totalTVMounts > 1 ? 's' : ''}</strong></div>` : ''}
                        ${totalCameras > 0 ? `<div style="margin-bottom:8px">üì∑ <strong>${totalCameras} Security Camera${totalCameras > 1 ? 's' : ''}</strong></div>` : ''}
                        <div style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1)">
                            ${equipmentList.map(eq => `
                                <div style="font-size:13px; color:var(--text-muted); margin-bottom:6px">
                                    <span style="color:#fff">‚Ä¢</span> ${eq.details}
                                    ${eq.meta.requires_team ? '<span style="color:var(--brand-gold); margin-left:8px">üë• Team Required</span>' : ''}
                                    ${eq.meta.team_recommended ? '<span style="color:var(--brand-gold); margin-left:8px">üë• Team Recommended</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // Service details with all metadata
                serviceDetails = `
                    <div style="grid-column:1/-1">
                        <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:8px">Service Line Items (${items.length})</label>
                        ${items.map(item => {
                            const itemMeta = item.metadata || {};
                            return `
                                <div style="background:rgba(255,255,255,0.03); padding:12px; border-radius:6px; margin-bottom:8px">
                                    <div style="font-weight:600; margin-bottom:4px; color:var(--brand-azure)">${item.service_name || item.bundle_id || 'Service'}</div>
                                    <div style="font-size:13px; color:var(--text-muted); line-height:1.6">
                                        <div>Quantity: <strong>${item.qty}</strong> | Price: <strong style="color:var(--brand-green)">$${item.line_total || item.unit_price}</strong></div>
                                        ${itemMeta.tv_size ? `<div>TV Size: <strong>${itemMeta.tv_size}"</strong></div>` : ''}
                                        ${itemMeta.mounts_needed ? `<div>Mounts Needed: <strong>${itemMeta.mounts_needed}</strong></div>` : ''}
                                        ${itemMeta.mount_provider ? `<div>Mount Provider: <strong>${itemMeta.mount_provider === 'customer' ? 'Customer' : itemMeta.mount_provider === 'h2s' ? 'H2S' : 'Standard'}</strong></div>` : ''}
                                        ${itemMeta.mount_source ? `<div>Mount Source: <strong>${itemMeta.mount_source}</strong></div>` : ''}
                                        ${itemMeta.min_team_size ? `<div>Min Team Size: <strong>${itemMeta.min_team_size}</strong></div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            metadataContainer.innerHTML = `
                <div class="section-title">Job Details</div>
                <div class="info-grid">
                    ${equipmentBreakdown}
                    ${meta.estimated_payout ? `<div class="info-item"><label>Estimated Payout</label><div style="color:var(--brand-green); font-weight:600">$${meta.estimated_payout}</div></div>` : ''}
                    ${meta.customer_phone ? `<div class="info-item"><label>Customer Phone</label><div>${meta.customer_phone}</div></div>` : ''}
                    ${meta.order_id ? `<div class="info-item"><label>Order ID</label><div style="font-size:11px; font-family:monospace">${meta.order_id}</div></div>` : ''}
                    ${meta.source ? `<div class="info-item"><label>Source</label><div>${meta.source}</div></div>` : ''}
                    ${meta.geo_lat && meta.geo_lng ? `<div class="info-item"><label>Coordinates</label><div style="font-size:11px">${meta.geo_lat.toFixed(4)}, ${meta.geo_lng.toFixed(4)}</div></div>` : ''}
                    ${meta.referral_code ? `<div class="info-item"><label>Referral Code</label><div>${meta.referral_code}</div></div>` : ''}
                    ${serviceDetails}
                </div>
            `;
        } else {
            metadataContainer.innerHTML = '';
        }

        // Load and show customer photos from artifacts table (type: customer_photo or photo with flag)
        const customerPhotos = await loadJobPhotos(job.job_id, 'customer_photo');
        const photosContainer = document.getElementById('modal-photos');
        if (customerPhotos.length > 0) {
            photosContainer.innerHTML = `
                <div class="section-title">üì∑ Customer Photos (${customerPhotos.length})</div>
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:12px">
                    ${customerPhotos.map(photo => {
                        const photoUrl = photo.file_url || photo.photo_url || photo.url || photo.storage_url;
                        return `
                            <div style="position:relative; border-radius:8px; overflow:hidden; border:1px solid var(--border)">
                                <img src="${photoUrl}" style="width:100%; height:150px; object-fit:cover; cursor:pointer" onclick="openPhotoLightbox('${photoUrl}')">
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        } else {
            photosContainer.innerHTML = '<div style="color:var(--text-muted); font-size:13px; font-style:italic">No customer photos uploaded for this job</div>';
        }

        // Load and show tech-uploaded photos from artifacts
        const techPhotos = await loadJobPhotos(job.job_id, 'photo');
        const techPhotosContainer = document.getElementById('modal-tech-photos');
        if (techPhotos.length > 0) {
            techPhotosContainer.innerHTML = `
                <div class="section-title">üì∏ Tech Photos (${techPhotos.length})</div>
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:12px">
                    ${techPhotos.map(photo => {
                        const photoUrl = photo.file_url || photo.photo_url || photo.url || photo.storage_url;
                        const uploadDate = photo.created_at || photo.added_at;
                        return `
                            <div style="position:relative; border-radius:8px; overflow:hidden; border:1px solid var(--border)">
                                <img src="${photoUrl}" style="width:100%; height:150px; object-fit:cover; cursor:pointer" onclick="openPhotoLightbox('${photoUrl}')">
                                <div style="position:absolute; bottom:0; left:0; right:0; background:linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding:6px 8px; font-size:10px; color:rgba(255,255,255,0.9)">
                                    ${uploadDate ? new Date(uploadDate).toLocaleDateString() : 'Unknown date'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        } else {
            techPhotosContainer.innerHTML = '<div style="color:var(--text-muted); font-size:13px; font-style:italic">No tech photos uploaded yet</div>';
        }

        // Render Suggestions with intelligent categorization
        const suggestionsContainer = document.getElementById('modal-suggestions');
        console.log('[openJobModal] Purchasing suggestions:', job.purchasing_suggestions);
        console.log('[openJobModal] Suggestions count:', job.purchasing_suggestions?.length || 0);
        
        if (job.purchasing_suggestions && job.purchasing_suggestions.length > 0) {
            // Categorize suggestions
            const categories = {
                PURCHASE_NEEDED: job.purchasing_suggestions.filter(s => s.category === 'PRIMARY'),
                FIELD_STOCK: job.purchasing_suggestions.filter(s => s.category === 'SUPPLIES' && s.priority > 2),
                VERIFY_CUSTOMER: job.purchasing_suggestions.filter(s => s.category === 'SUPPLIES' && s.priority <= 2)
            };
            
            console.log('[openJobModal] Categorized suggestions:', {
                PURCHASE_NEEDED: categories.PURCHASE_NEEDED.length,
                FIELD_STOCK: categories.FIELD_STOCK.length,
                VERIFY_CUSTOMER: categories.VERIFY_CUSTOMER.length
            });
            
            suggestionsContainer.innerHTML = `
                ${categories.PURCHASE_NEEDED.length > 0 ? `
                    <div style="margin-bottom:20px">
                        <div style="font-weight:700; font-size:13px; color:var(--brand-azure); margin-bottom:12px; display:flex; align-items:center; gap:8px">
                            <span>üõí</span> ORDER REQUIRED (${categories.PURCHASE_NEEDED.length})
                        </div>
                        ${categories.PURCHASE_NEEDED.map((item, idx) => `
                            <div class="suggestion-card" style="border-left:3px solid var(--brand-azure)">
                                <input type="checkbox" class="suggestion-check" id="check-${idx}" checked>
                                <div class="suggestion-content">
                                    <h4>${item.item_name} ${item.quantity ? `<span style="color:var(--text-muted); font-size:12px">(√ó${item.quantity})</span>` : ''}</h4>
                                    <p>${item.why_needed}</p>
                                    <div class="brand-tags">
                                        ${item.typical_brands.map(b => `<span class="brand-tag">${b}</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${categories.VERIFY_CUSTOMER.length > 0 ? `
                    <div style="margin-bottom:20px">
                        <div style="font-weight:700; font-size:13px; color:var(--brand-gold); margin-bottom:12px; display:flex; align-items:center; gap:8px">
                            <span>‚ö†Ô∏è</span> VERIFY WITH CUSTOMER (${categories.VERIFY_CUSTOMER.length})
                        </div>
                        ${categories.VERIFY_CUSTOMER.map((item, idx) => `
                            <div class="suggestion-card" style="border-left:3px solid var(--brand-gold); opacity:0.8">
                                <div class="suggestion-content">
                                    <h4>${item.item_name}</h4>
                                    <p style="font-size:12px; color:var(--text-muted)">${item.why_needed}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${categories.FIELD_STOCK.length > 0 ? `
                    <div style="margin-bottom:20px">
                        <div style="font-weight:700; font-size:13px; color:var(--text-muted); margin-bottom:12px; display:flex; align-items:center; gap:8px">
                            <span>üß∞</span> FIELD STOCK (Tech should have)
                        </div>
                        <div style="font-size:12px; color:var(--text-muted); font-style:italic">
                            ${categories.FIELD_STOCK.map(s => s.item_name).join(', ')}
                        </div>
                    </div>
                ` : ''}
            `;
        } else {
            suggestionsContainer.innerHTML = '<div style="color:var(--text-muted); font-style:italic">No specific purchasing suggestions for this job type.</div>';
        }

        document.getElementById('job-modal').classList.add('active');
    }
    
    function showJobModal(job) {
        // Helper function for payout view to open job details
        currentJobs = [job]; // Temporarily add to array
        openJobModal(job.job_id);
    }

    function closeModal() {
        document.getElementById('job-modal').classList.remove('active');
    }

    function copySelectedItems() {
        const job = currentJobs.find(j => j.job_id === currentJobId);
        if (!job || !job.purchasing_suggestions) return;

        const selected = [];
        job.purchasing_suggestions.forEach((item, idx) => {
            const checkbox = document.getElementById(`check-${idx}`);
            if (checkbox && checkbox.checked) {
                selected.push(`- ${item.item_name} (${item.why_needed})`);
            }
        });

        if (selected.length > 0) {
            const text = `Order List for Job ${currentJobId}:\n${selected.join('\n')}`;
            navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
        }
    }

    // --- DISPATCH WORKFLOW ---
    function openDispatchWorkflow() {
        document.getElementById('dispatch-modal').classList.add('active');
    }

    function closeDispatchModal() {
        document.getElementById('dispatch-modal').classList.remove('active');
    }

    function confirmDispatch() {
        const pro = document.getElementById('pro-select').value;
        if (!pro) {
            alert('Please select a technician');
            return;
        }
        alert(`Job ${currentJobId} dispatched to ${pro}!`);
        closeDispatchModal();
        closeModal();
        // In real app: Call API to update job status
    }

    async function markJobComplete() {
        if (!confirm('Are you sure you want to mark this job as completed?')) return;
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_update_status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN, 
                    job_id: currentJobId, 
                    status: 'completed' 
                })
            });
            const data = await res.json();
            
            if (data.ok) {
                alert('‚úÖ Job marked as completed!');
                closeModal();
                loadJobs(); // Refresh list
            } else {
                throw new Error(data.error);
            }
        } catch (err) {
            console.error('Mark complete error:', err);
            alert('‚ùå Failed to mark job complete: ' + err.message);
        }
    }

    // --- PHOTO GALLERY ---

    async function loadJobPhotos(jobId, photoType = 'photo') {
        const cacheKey = `${jobId}_${photoType}`;
        
        // Check cache first
        const cached = jobCache.get(cacheKey, 'photos');
        if (cached) {
            console.log(`[loadJobPhotos] Using cached ${photoType} photos for job ${jobId}`);
            return cached;
        }
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/portal_get_artifacts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN, 
                    job_id: jobId, 
                    type: photoType 
                })
            });
            const data = await res.json();
            
            if (data.ok) {
                const artifacts = data.artifacts || [];
                console.log(`[loadJobPhotos] Loaded ${artifacts.length} ${photoType} photos for job ${jobId}`);
                
                // Cache the result
                jobCache.set(cacheKey, artifacts, 'photos');
                
                return artifacts;
            } else {
                console.error('Failed to load photos:', data.error);
                return [];
            }
        } catch (err) {
            console.error('Photo fetch error:', err);
            return [];
        }
    }

    function openPhotoLightbox(photoUrl) {
        const lightbox = document.createElement('div');
        lightbox.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        `;
        
        const img = document.createElement('img');
        img.src = photoUrl;
        img.style.cssText = `
            max-width: 95%;
            max-height: 95vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        `;
        
        lightbox.appendChild(img);
        lightbox.onclick = () => lightbox.remove();
        document.body.appendChild(lightbox);
    }

    // --- PAYOUTS LOGIC ---

    async function approvePayout(entryId) {
        if (!confirm('Approve this payout?')) return;
        await updatePayoutStatus(entryId, 'approve');
    }

    async function rejectPayout(entryId) {
        if (!confirm('Reject this payout?')) return;
        await updatePayoutStatus(entryId, 'reject');
    }

    async function updatePayoutStatus(entryId, action) {
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_approve_payout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN, entry_id: entryId, action })
            });
            const data = await res.json();
            if (data.ok) {
                loadPayouts(); // Refresh list
            } else {
                throw new Error(data.error);
            }
        } catch (err) {
            console.error('Payout update error:', err);
            alert('‚ùå Failed to update payout: ' + err.message);
        }
    }

    // Connection status updater
    function updateConnectionUI() {
        const indicator = document.getElementById('connection-status');
        const dot = document.getElementById('status-dot');
        const text = document.getElementById('status-text');
        
        if (connectionStatus === 'online') {
            dot.style.background = 'var(--brand-green)';
            text.textContent = 'Connected';
            indicator.style.opacity = '0';
        } else if (connectionStatus === 'degraded') {
            dot.style.background = 'var(--brand-gold)';
            text.textContent = 'Slow Connection';
            indicator.style.opacity = '1';
        } else {
            dot.style.background = '#ef4444';
            text.textContent = 'Offline';
            indicator.style.opacity = '1';
        }
    }

    // Monitor connection health
    setInterval(() => {
        checkConnection();
        updateConnectionUI();
    }, 30000); // Check every 30 seconds

    // --- CHARTS RENDERING ---
    let chartInstances = {};
    
    function renderCharts(data) {
        document.getElementById('charts-section').classList.remove('hidden');
        
        // Destroy existing charts
        Object.values(chartInstances).forEach(chart => chart?.destroy());
        chartInstances = {};
        
        // Revenue Trend Chart (simulated last 30 days)
        const revCtx = document.getElementById('revenueChart')?.getContext('2d');
        if (revCtx) {
            const days = Array.from({length: 30}, (_, i) => `Day ${i+1}`);
            const revenue = Array.from({length: 30}, () => Math.floor(Math.random() * 5000) + 2000);
            
            chartInstances.revenue = new Chart(revCtx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Revenue',
                        data: revenue,
                        borderColor: '#1493FF',
                        backgroundColor: 'rgba(20, 147, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: { 
                            ticks: { color: '#94a3b8', maxRotation: 0 },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // Job Status Pie Chart
        const statusCtx = document.getElementById('jobStatusChart')?.getContext('2d');
        if (statusCtx) {
            chartInstances.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending', 'Assigned'],
                    datasets: [{
                        data: [
                            data.operations?.jobs_completed || 0,
                            data.operations?.jobs_pending || 0,
                            (data.operations?.bottlenecks?.length || 0)
                        ],
                        backgroundColor: ['#22C96F', '#FFC857', '#1493FF'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', padding: 15 }
                        }
                    }
                }
            });
        }
        
        // Capacity Bar Chart
        const capCtx = document.getElementById('capacityChart')?.getContext('2d');
        if (capCtx) {
            const util = data.capacity?.utilization_pct || 0;
            chartInstances.capacity = new Chart(capCtx, {
                type: 'bar',
                data: {
                    labels: ['Current Load', 'Available'],
                    datasets: [{
                        label: 'Capacity %',
                        data: [util, 100 - util],
                        backgroundColor: [util > 80 ? '#FFC857' : '#22C96F', '#334155']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            max: 100,
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    }
                }
            });
        }
        
        // Pricing Tier Pie
        const priceCtx = document.getElementById('pricingChart')?.getContext('2d');
        if (priceCtx) {
            chartInstances.pricing = new Chart(priceCtx, {
                type: 'pie',
                data: {
                    labels: ['BYO', 'BASE', 'H2S'],
                    datasets: [{
                        data: [
                            data.pricing?.byo?.jobs || 1,
                            data.pricing?.base?.jobs || 1,
                            data.pricing?.h2s?.jobs || 1
                        ],
                        backgroundColor: ['#FFC857', '#1493FF', '#22C96F']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', padding: 15 }
                        }
                    }
                }
            });
        }
    }

    // --- PAYOUTS MANAGEMENT ---
    async function loadPayouts() {
        const container = document.getElementById('payouts-container');
        const filter = document.getElementById('payout-filter')?.value || 'all';
        
        container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted)">Loading payouts...</div>';
        
        try {
            console.log('[PAYOUTS] Loading from jobs...');
            // Generate payouts from jobs data
            const jobsRes = await fetchWithRetry(`${API_BASE}/admin_jobs_list`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN, status: 'all', days: 90 })
            });
            
            const jobsData = await jobsRes.json();
            if (!jobsData.ok) throw new Error('Failed to load jobs');
            
            console.log('[PAYOUTS] Processing', jobsData.jobs.length, 'jobs for payouts...');
            
            // Extract payout data from jobs
            const payouts = jobsData.jobs.map(job => {
                // Try to get pro name from multiple sources
                let proName = job.assigned_pro_name || job.metadata?.pro_name || job.metadata?.pro_email;
                
                // If we have a pro_id but no name, use the pro_id (shortened)
                if (!proName && job.assigned_pro_id) {
                    proName = `Tech ${job.assigned_pro_id.substring(0, 8)}`;
                }
                
                // Final fallback
                if (!proName) {
                    proName = 'Unassigned';
                }
                
                const amount = job.metadata?.estimated_payout || job.metadata?.payout || 0;
                
                return {
                    payout_id: `payout_${job.job_id.substring(0, 8)}`,
                    job_id: job.job_id,
                    pro_name: proName,
                    pro_id: job.assigned_pro_id || job.metadata?.pro_id || null,
                    amount: amount,
                    state: 'pending', // All payouts start as pending until admin approves
                    job_status: job.status,
                    earned_at: job.created_at,
                    accepted_at: job.status === 'accepted' || job.status === 'completed' ? job.metadata?.accepted_at || job.created_at : null,
                    job_details: {
                        service: job.service_name,
                        customer: job.customer_name,
                        address: job.address,
                        city: job.city ? job.city.charAt(0).toUpperCase() + job.city.slice(1) : '',
                        line_items: job.line_items_json
                    }
                };
            }).filter(p => (p.job_status === 'accepted' || p.job_status === 'completed') && p.amount > 0);
            
            // Group by pro to track acceptance counts
            const proStats = {};
            payouts.forEach(p => {
                if (!proStats[p.pro_name]) {
                    proStats[p.pro_name] = {
                        total_accepted: 0,
                        total_completed: 0,
                        total_earnings: 0,
                        pending_earnings: 0,
                        approved_earnings: 0
                    };
                }
                proStats[p.pro_name].total_accepted++;
                if (p.job_status === 'completed') proStats[p.pro_name].total_completed++;
                proStats[p.pro_name].total_earnings += p.amount;
                if (p.state === 'pending') proStats[p.pro_name].pending_earnings += p.amount;
                if (p.state === 'approved') proStats[p.pro_name].approved_earnings += p.amount;
            });
            
            // Attach pro stats to each payout
            payouts.forEach(p => {
                p.pro_stats = proStats[p.pro_name];
            });
            
            console.log('[PAYOUTS] Found', payouts.length, 'payouts');
            renderPayouts(payouts, filter);
            
        } catch (err) {
            console.error('[PAYOUTS] Error:', err);
            container.innerHTML = `
                <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; padding:20px; border-radius:8px; text-align:center">
                    <div style="font-size:16px; font-weight:600; margin-bottom:8px">Unable to Load Payouts</div>
                    <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px">${err.message}</div>
                    <button class="btn btn-primary" onclick="loadPayouts()">Retry</button>
                </div>
            `;
        }
    }

    function renderPayouts(payouts, filter) {
        // Filter payouts
        const filtered = filter === 'all' ? payouts : payouts.filter(p => p.state === filter);
        
        // Calculate totals
        const totals = {
            pending: { amount: 0, count: 0 },
            approved: { amount: 0, count: 0 },
            paid: { amount: 0, count: 0 },
            lifetime: 0
        };
        
        payouts.forEach(p => {
            const amt = Number(p.amount) || 0;
            if (p.state === 'pending') {
                totals.pending.amount += amt;
                totals.pending.count++;
            } else if (p.state === 'approved') {
                totals.approved.amount += amt;
                totals.approved.count++;
            } else if (p.state === 'paid') {
                totals.paid.amount += amt;
                totals.paid.count++;
            }
            totals.lifetime += amt;
        });
        
        // Update summary cards
        document.getElementById('total-pending').textContent = `$${totals.pending.amount.toLocaleString()}`;
        document.getElementById('payout-pending-amount').textContent = `$${totals.pending.amount.toLocaleString()}`;
        document.getElementById('payout-pending-count').textContent = `${totals.pending.count} entries`;
        document.getElementById('payout-approved-amount').textContent = `$${totals.approved.amount.toLocaleString()}`;
        document.getElementById('payout-approved-count').textContent = `${totals.approved.count} entries`;
        document.getElementById('payout-paid-amount').textContent = `$${totals.paid.amount.toLocaleString()}`;
        document.getElementById('payout-paid-count').textContent = `${totals.paid.count} entries`;
        document.getElementById('payout-lifetime-amount').textContent = `$${totals.lifetime.toLocaleString()}`;
        
        // Render table
        const container = document.getElementById('payouts-container');
        if (filtered.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted)">No payouts found for this filter</div>';
            return;
        }
        
        container.innerHTML = `
            <div class="metric-card">
                <table style="width:100%; border-collapse:collapse">
                    <thead>
                        <tr style="text-align:left; border-bottom:2px solid var(--border); color:var(--text-muted); font-size:12px; text-transform:uppercase">
                            <th style="padding:12px">Pro</th>
                            <th style="padding:12px">Accepted Jobs</th>
                            <th style="padding:12px">Job ID</th>
                            <th style="padding:12px">Service</th>
                            <th style="padding:12px">Amount</th>
                            <th style="padding:12px">Status</th>
                            <th style="padding:12px">Date</th>
                            <th style="padding:12px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(payout => `
                            <tr style="border-bottom:1px solid var(--border)">
                                <td style="padding:12px">
                                    <div style="color:#fff; font-weight:500">${payout.pro_name}</div>
                                    <div style="font-size:11px; color:var(--text-muted); margin-top:2px">
                                        ${payout.pro_stats.total_completed} completed ‚Ä¢ $${payout.pro_stats.total_earnings.toLocaleString()} total
                                    </div>
                                </td>
                                <td style="padding:12px">
                                    <div style="font-size:16px; font-weight:700; color:var(--brand-azure)">${payout.pro_stats.total_accepted}</div>
                                    <div style="font-size:11px; color:var(--text-muted)">${payout.pro_stats.total_completed} done</div>
                                </td>
                                <td style="padding:12px">
                                    <code style="font-size:11px; background:rgba(20,147,255,0.1); padding:4px 6px; border-radius:4px; color:var(--brand-azure)">${payout.job_id.substring(0, 8)}</code>
                                </td>
                                <td style="padding:12px; font-size:13px; color:var(--text-muted)">${payout.job_details.service}</td>
                                <td style="padding:12px; color:#fff; font-weight:600">$${payout.amount.toLocaleString()}</td>
                                <td style="padding:12px">
                                    <span style="font-size:11px; padding:4px 8px; border-radius:6px; text-transform:uppercase; font-weight:700; 
                                        ${payout.state === 'pending' ? 'background:rgba(255,200,87,0.2); color:#FFC857' : ''}
                                        ${payout.state === 'approved' ? 'background:rgba(34,201,111,0.2); color:#22C96F' : ''}
                                        ${payout.state === 'paid' ? 'background:rgba(20,147,255,0.2); color:#1493FF' : ''}">
                                        ${payout.state}
                                    </span>
                                    <div style="font-size:10px; color:var(--text-muted); margin-top:2px">Job: ${payout.job_status}</div>
                                </td>
                                <td style="padding:12px; font-size:13px; color:var(--text-muted)">${new Date(payout.earned_at).toLocaleDateString()}</td>
                                <td style="padding:12px">
                                    <div style="display:flex; gap:8px">
                                        ${payout.state === 'pending' ? `
                                            <button class="btn btn-success" style="padding:6px 12px; font-size:12px" onclick="approvePayout('${payout.payout_id}')">Approve</button>
                                            <button class="btn btn-danger" style="padding:6px 12px; font-size:12px" onclick="rejectPayout('${payout.payout_id}')">Reject</button>
                                        ` : ''}
                                        <button class="btn btn-ghost" style="padding:6px 12px; font-size:12px" onclick="viewPayoutDetails('${payout.job_id}')">View Job</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    function viewPayoutDetails(jobId) {
        // Open job modal with full details
        const job = currentJobs.find(j => j.job_id === jobId);
        if (job) {
            showJobModal(job);
        } else {
            alert('Job details not found. Refresh jobs list.');
        }
    }

    // Initial Load
    console.log('==================== DASHBOARD INIT ====================');
    console.log('API_BASE:', API_BASE);
    console.log('ADMIN_TOKEN:', ADMIN_TOKEN);
    console.log('=======================================================');
    
    checkConnection().then(() => {
        console.log('Connection check complete. Status:', connectionStatus);
        updateConnectionUI();
        loadMetrics();
    }).catch(err => {
        console.error('Init error:', err);
        document.getElementById('metrics-container').innerHTML = `
            <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; padding:20px; border-radius:8px; text-align:center">
                <div style="font-size:16px; font-weight:600; margin-bottom:8px">Failed to Initialize</div>
                <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px">${err.message}</div>
                <button class="btn btn-primary" onclick="location.reload()">Reload Page</button>
            </div>
        `;
    });

</script>
</body>
</html>
