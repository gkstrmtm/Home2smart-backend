<!-- Home2Smart • TV Mounting Wizard (Stripe Checkout + BYO/H2S) -->

<!-- Performance: Preload critical resources -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://connect.facebook.net" crossorigin>
<link rel="preconnect" href="https://script.google.com" crossorigin>
<link rel="preconnect" href="https://storage.googleapis.com" crossorigin>
<link rel="dns-prefetch" href="https://www.facebook.com">

<!-- Google Fonts - optimized strategy: display=swap reduces blocking -->
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;800;900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;800;900&display=swap" rel="stylesheet"></noscript>

<!-- Meta Pixel - Deferred for faster initial load -->
<script>
window.addEventListener('load', function() {
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}
  (window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
  fbq('init','2384221445259822');
  fbq('track','PageView');
  fbq('track','ViewContent',{
    content_name:'TV Mount Service Page',
    content_category:'service_page',
    page_type:'tvmount',
    page_path:'/tvmount',
    page_title:'TV Mounting Wizard | Home2Smart'
  });
});
</script>
<noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=2384221445259822&ev=PageView&noscript=1" alt=""/></noscript>

<div id="h2s-root" class="h2s-root">
  <!-- Progress -->
  <div class="h2s-progress"><div id="h2s-progress-bar" class="h2s-progress-bar"></div></div>

  <!-- Brand logo -->
  <a id="h2s-brand" class="brand" href="https://home2smart.com/home" aria-label="Home2Smart">
    <img src="https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68da0ce6f00445991d64a63f.png" alt="Home2Smart logo">
  </a>

  <!-- App -->
  <div id="h2s" class="h2s">
    <div id="h2s-step"></div>
  </div>

  <!-- Transparent SVG loader (centered) -->
  <div id="h2s-loader" class="h2s-loader" aria-hidden="true" style="display:none">
    <div class="h2s-loader-stage">
      <div class="h2s-loader-slices" id="h2sLoaderSlices"></div>
    </div>
  </div>
</div>

<style>
  :root{
    --blue:#0a2a5a;
    --azure:#1493ff;
    --white:#ffffff;
    --blue-ghost: rgba(20,147,255,.12);
    --btn-fill: rgba(10,42,90,.28);
    --btn-fill-hover: rgba(10,42,90,.40);

    --brand-h-mobile: 64px;
    --brand-h-desktop: 64px;
    --brand-gap: 10px;
  }

  #h2s-root, #h2s-root * {
    font-family: "Archivo", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
    letter-spacing: .2px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  html, body { height:100%; }
  #h2s-root.h2s-root{
    position:relative;
    background:var(--blue); color:var(--white);
    width:100vw; margin-left:calc(50% - 50vw);
    min-height:100vh; display:flex; flex-direction:column;
  }

  .h2s-progress{ height:12px; width:100vw; margin-left:calc(50% - 50vw); background:rgba(255,255,255,.15) }
  .h2s-progress-bar{ height:100%; width:0%; background:var(--azure); transition:width .25s ease }

  .brand{
    position:absolute;
    top: calc(10px + env(safe-area-inset-top, 0px));
    z-index:5; display:block;
    padding:0; line-height:0;
  }
  .brand img{ height: var(--brand-h-mobile); width:auto; display:block; filter: drop-shadow(0 2px 12px rgba(0,0,0,.25)) }
  .brand.center{ left:50%; transform:translateX(-50%); }
  .brand.right{ right:16px; }

  .h2s{
    padding-top: calc(var(--brand-h-mobile) + var(--brand-gap) + env(safe-area-inset-top, 0px));
    flex:1; display:flex; align-items:center; justify-content:center; padding-left:18px; padding-right:18px; padding-bottom:24px;
  }
  .stage{ width:100%; max-width:1600px; margin-left:auto; margin-right:auto; }

  h1{
    font-weight: 900;
    text-align:center; margin:0 0 16px 0;
    font-size: clamp(36px, 6vw, 68px);
    letter-spacing: 0; line-height: 1.05;
  }
  .subhead{ font-weight:800; margin:14px 0 8px 0; font-size:18px; letter-spacing:.2px; }

  .chev-row{ display:flex; align-items:center; justify-content:center; gap:22px }
  .chev{ width:64px; height:64px; border-radius:50%; border:2px solid var(--azure); background:transparent; display:grid; place-items:center; cursor:pointer }
  .chev svg{ width:28px; height:28px; fill:var(--azure) }
  .flip svg{ transform: scaleX(-1) }
  .big-num{ font-size: clamp(52px, 8vw, 92px); font-weight:900; letter-spacing:1px; min-width:160px; text-align:center }
  .sub{ margin-top:12px; opacity:.95; font-size:14px; text-align:center }

  .row-actions{ display:flex; justify-content:center; gap:10px; margin-top:18px; flex-wrap:wrap }
  .btn{ 
    appearance:none; border:1px solid transparent; color:var(--white); 
    padding:12px 18px; border-radius:14px; font-weight:800; cursor:pointer; 
    background:var(--btn-fill); letter-spacing:.3px;
    transition: all 0.2s ease;
    transform: translateZ(0); /* GPU acceleration */
  }
  .btn:hover{ background:var(--btn-fill-hover); transform: translateY(-1px) translateZ(0); }
  .btn:active{ transform: translateY(0) translateZ(0); }
  .btn.azure{ background:var(--azure); color:#001428 }
  .btn.azure:hover{ filter:brightness(1.05); transform: translateY(-1px) translateZ(0); }
  .btn.white{ background:var(--white); color:var(--blue); border-color:var(--white) }
  .btn.white:hover{ filter:brightness(0.98); transform: translateY(-1px) translateZ(0); }

  .grid{ display:grid; gap:16px; margin-top:8px }
  @media (min-width:760px){ .grid{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
  .tile{ 
    border:3px solid transparent; border-radius:16px; overflow:hidden; 
    background:rgba(255,255,255,.06); cursor:pointer;
    transition: all 0.25s ease;
    transform: translateZ(0); /* GPU acceleration */
  }
  .tile:hover{ transform: translateY(-4px) translateZ(0); box-shadow: 0 8px 24px rgba(0,0,0,.3); }
  .tile .img{ height:220px; width:100%; object-fit:cover; display:block }
  .tile .cap{ padding:12px 14px; font-weight:800; color:var(--white) }
  .tile[aria-pressed="true"]{ 
    border-color:var(--azure); 
    box-shadow:0 0 0 4px var(--blue-ghost);
    transform: translateY(-2px) translateZ(0);
  }
  .tile .img[loading="lazy"] { background: rgba(255,255,255,.04); } /* Placeholder while lazy loading */

  /* Mount step: white option cards, centered */
  .mount-options{ display:flex; align-items:center; justify-content:center; gap:16px; margin-top:14px; flex-wrap:wrap }
  .mount-card{
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    min-width:240px; padding:16px 18px; border-radius:16px; background:var(--white); color:#0a2a5a;
    border:3px solid transparent; cursor:pointer; text-align:center;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateZ(0); /* GPU acceleration */
  }
  .mount-card:hover{ 
    transform: translateY(-4px) translateZ(0); 
    box-shadow: 0 8px 24px rgba(0,0,0,.2);
  }
  .mount-card .title{ font-weight:900; font-size:18px; }
  .mount-card .desc{ font-weight:600; font-size:13px; opacity:.8; margin-top:6px }
  .mount-card[aria-pressed="true"]{ 
    border-color:var(--azure); 
    box-shadow:0 0 0 4px var(--blue-ghost);
    transform: translateY(-2px) translateZ(0);
  }

  .frame16x9{
    position:relative; width:100%;
    height:62vh; max-height:920px; aspect-ratio:16/9; max-width:96vw;
    border-radius:18px; overflow:hidden; background:rgba(0,0,0,.25); border:3px solid transparent; cursor:pointer;
  }
  .frame16x9[aria-selected="true"], .outline{ border-color:var(--azure); box-shadow:0 0 0 4px var(--blue-ghost) }
  .bg-img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover }

  .caro-chev{ position:absolute; top:50%; transform:translateY(-50%); width:76px; height:76px; border-radius:50%; border:2px solid var(--azure); background:rgba(10,42,90,.22); display:grid; place-items:center; cursor:pointer }
  .caro-chev svg{ width:34px; height:34px; fill:var(--azure) }
  .left{ left:12px } .right{ right:12px }
  .caro-label{ font-weight:800; margin-top:10px; text-align:center }

  .tv{ position:absolute; filter: drop-shadow(0 12px 26px rgba(0,0,0,.55)); pointer-events:none }

  .rev{ display:grid; gap:18px; margin-top:12px }
  @media (min-width:1024px){ .rev{ grid-template-columns:1.2fr 1fr } }
  .kv{ display:grid; grid-template-columns: 140px 1fr; gap:10px; font-size:15px }
  .k{ opacity:.85 }

  .form{ display:grid; gap:10px; margin-top:12px }
  .inp{ border:1px solid rgba(255,255,255,.35); background:rgba(255,255,255,.08); color:var(--white); border-radius:12px; padding:12px 14px; font-size:14px; width:100% }
  .inp::placeholder{ color:rgba(255,255,255,.8) }

  .alert{ padding:10px 12px; border-radius:10px; background:#fdf2f2; color:#991b1b; border:1px solid #fecaca; font-size:13px; margin-top:8px }
  .stripe-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }

  /* Mobile */
  @media (max-width: 767px){
    .frame16x9{ width:94vw; aspect-ratio:16/9; height:auto; max-height:62vh; margin-left:auto; margin-right:auto; }
    .caro-chev{ width:56px; height:56px; } .caro-chev svg{ width:26px; height:26px; }
    .h2s{ padding-top: calc(var(--brand-h-mobile) + var(--brand-gap) + env(safe-area-inset-top, 0px)); }
  }
  @media (min-width: 1024px){
    .brand img{ height: var(--brand-h-desktop); }
    .h2s{ padding-top: calc(var(--brand-h-desktop) + 16px); }
  }

  /* Loader - optimized for 60fps */
  .h2s-loader{
    position:fixed; inset:0; z-index:99999; display:grid; place-items:center;
    background:transparent; pointer-events:auto;
    transition: opacity 0.2s ease-out;
  }
  .h2s-loader.hidden{ 
    pointer-events:none; 
    opacity: 0;
  }
  .h2s-loader-stage{ position:relative; width:min(72vw,520px); aspect-ratio:5/2 }
  .h2s-loader-slices{ position:absolute; inset:0 }
  .h2s-loader-slice{
    position:absolute; top:0; bottom:0; overflow:hidden; opacity:0; 
    transform:translateY(24px) translateZ(0); /* GPU acceleration */
    will-change:transform,opacity; 
    animation:h2s-split 2.2s cubic-bezier(.22,.8,.32,1) infinite;
    animation-delay:calc(var(--i)*0.06s);
    backface-visibility: hidden; /* Smoother animation */
  }
  .h2s-loader-slice img{ 
    position:absolute; inset:0 auto 0 0; width:100%; height:100%; object-fit:contain;
    transform: translateZ(0); /* GPU layer */
  }
  @keyframes h2s-split{
    0%{opacity:0;transform:translateY(24px) translateZ(0)}
    36%{opacity:1;transform:translateY(0) translateZ(0)}
    68%{opacity:1;transform:translateY(0) translateZ(0)}
    100%{opacity:0;transform:translateY(-12px) translateZ(0)}
  }
  @media (prefers-reduced-motion: reduce){
    .h2s-loader-slice{ animation:none; opacity:1; transform:none }
  }
</style>

<script>
(()=> {
  // === UPDATE THIS TO YOUR LIVE WEB-APP URL ===
  const API = "https://script.google.com/macros/s/AKfycbxPFW052KrxOvfiY9wRWJsmdP6Af2dyitAlPZSUrghurrAD_OQKVxBTWS1IEMRu5poZ/exec";
  // ============================================

  const LOADER_SVG = "https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68e164b2554f6a7ab7e50837.svg";

  /* flow: mount moved right after count */
  const flow = ['count','mount','room','wall','size','height','review'];
  let stepIdx = 0, tvCount = 1, tvIndex = 0, picks = [], CH = null;

  const stepEl = document.getElementById('h2s-step');
  const pbar = document.getElementById('h2s-progress-bar');
  const brand = document.getElementById('h2s-brand');

  // Loader refs
  const loader = document.getElementById('h2s-loader');
  const loaderTray = document.getElementById('h2sLoaderSlices');

  /* ---------- Loader ---------- */
  function buildLoader(svgSrc, slices=8){
    loaderTray.innerHTML = "";
    for(let i=0;i<slices;i++){
      const w = 100/slices;
      const s = document.createElement('div');
      s.className = 'h2s-loader-slice';
      s.style.left = (i*w) + '%';
      s.style.width = w + '%';
      s.style.setProperty('--i', i);
      const img = document.createElement('img');
      img.alt = 'Home2Smart'; img.src = svgSrc;
      img.style.width = (slices*100) + '%';
      img.style.height = '100%';
      img.style.left = (-i*100) + '%';
      s.appendChild(img);
      loaderTray.appendChild(s);
    }
  }
  function showLoader(){ loader.style.display = "grid"; }
  function hideLoader(){
    loader.classList.add('hidden');
    setTimeout(()=>{ loader.style.display="none"; loader.classList.remove('hidden'); }, 200);
  }

  const st = () => picks[tvIndex] || (picks[tvIndex] = { tv_index: tvIndex+1 });
  const html = (s)=> s.trim();

  function setProgress(){ pbar.style.width = (((stepIdx+1)/flow.length)*100) + "%"; }
  function setBrandPos(){ brand.classList.remove('center','right'); if(flow[stepIdx]==='count'){ brand.classList.add('center'); } else { brand.classList.add('right'); } }

  async function loadChoices(){
    buildLoader(LOADER_SVG, 8); showLoader();
    try{
      const res = await fetch(API + "?action=choices");
      const data = await res.json();
      if(!res.ok || !data?.ok) throw new Error('Failed to load options');
      CH = data;
    } finally {
      hideLoader();
    }
  }

  /* =========================
     PS PATCH: pricing helpers
     ========================= */
  /* PS PATCH: choose dollars by BYO/H2S with fallback to legacy price_usd */
  function priceFor(sizeEntry, mountChoice){
    if (!sizeEntry) return 0;
    const m = String(mountChoice||'BYO').toUpperCase();
    if (m === 'H2S') {
      const v = Number(sizeEntry.price_usd_h2s);
      return Number.isFinite(v) ? v : Number(sizeEntry.price_usd||0);
    } else {
      const v = Number(sizeEntry.price_usd_byo);
      return Number.isFinite(v) ? v : Number(sizeEntry.price_usd||0);
    }
  }

  function render(){
    setProgress(); setBrandPos();
    const step = flow[stepIdx];
    if(step==='count') return renderCount();
    if(step==='mount') return renderMount();
    if(step==='room') return renderRoom();
    if(step==='wall') return renderWall();
    if(step==='size') return renderSize();
    if(step==='height') return renderHeight();
    if(step==='review') return renderReview();
  }

  /* COUNT */
  function renderCount(){
    stepEl.innerHTML = html(`
      <div class="stage">
        <h1>How many TVs do you want mounted?</h1>
        <div class="chev-row">
          <button class="chev" id="dec" aria-label="decrease">${chev()}</button>
          <div class="big-num" id="countNum">${tvCount}</div>
          <button class="chev flip" id="inc" aria-label="increase">${chev()}</button>
        </div>
        <div class="sub">You can edit the count later.</div>
        <div class="row-actions">
          <button class="btn azure" id="next">Next</button>
        </div>
      </div>
    `);
    const num = stepEl.querySelector('#countNum');
    stepEl.querySelector('#inc').onclick = ()=>{ tvCount = tvCount >= 15 ? 1 : tvCount+1; picks = Array.from({length: tvCount}, (_,i)=> picks[i] || { tv_index:i+1 }); num.textContent = tvCount; };
    stepEl.querySelector('#dec').onclick = ()=>{ tvCount = tvCount <= 1 ? 15 : tvCount-1; picks = Array.from({length: tvCount}, (_,i)=> picks[i] || { tv_index:i+1 }); num.textContent = tvCount; };
    stepEl.querySelector('#next').onclick = ()=>{ stepIdx=1; render(); };
  }

  /* MOUNT (BYO vs H2S) — centered white cards */
  function renderMount(){
    const s = st();
    const tvLabel = tvCount > 1 ? ` (TV ${tvIndex + 1} of ${tvCount})` : '';
    stepEl.innerHTML = html(`
      <div class="stage">
        <h1>Do you have a mount?${tvLabel}</h1>
        <div class="mount-options">
          <button class="mount-card" data-choice="BYO" aria-pressed="${s.mount_choice==='BYO'}">
            <div class="title">Yes, I have a mount</div>
            <div class="desc">I'll provide my own (new in box)</div>
          </button>
          <button class="mount-card" data-choice="H2S" aria-pressed="${s.mount_choice==='H2S'}">
            <div class="title">No, please provide one</div>
            <div class="desc">Include a mount with installation</div>
          </button>
        </div>
        <div class="row-actions">
          <button class="btn white" id="back">Back</button>
          <button class="btn azure" id="next">Next</button>
        </div>
      </div>
    `);
    stepEl.querySelectorAll('.mount-card').forEach(btn=>{
      btn.onclick = ()=>{
        stepEl.querySelectorAll('.mount-card').forEach(x=>x.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        s.mount_choice = btn.dataset.choice;

        /* PS PATCH: if size was already picked, refresh stored price for estimate */
        if (s.size_id) {
          const sz = (CH.sizes||[]).find(z=> z.size_id===s.size_id);
          s.price_usd = priceFor(sz, s.mount_choice);
        }
      };
    });
    stepEl.querySelector('#back').onclick = ()=>{ stepIdx=0; render(); };
    stepEl.querySelector('#next').onclick = ()=>{ if(!s.mount_choice) s.mount_choice='BYO'; stepIdx=2; render(); };
  }

  /* ROOM */
  function renderRoom(){
    const s = st(); const rooms = CH.rooms||[];
    const tvLabel = tvCount > 1 ? ` (TV ${tvIndex + 1} of ${tvCount})` : '';
    stepEl.innerHTML = html(`
      <div class="stage">
        <h1>Pick your ROOM${tvLabel}</h1>
        <div class="grid">
          ${rooms.map(r=>`
            <button class="tile" data-id="${r.room_id}" aria-pressed="${String(s.room_id)===String(r.room_id)}">
              <img class="img" loading="lazy" src="${r.image_url||''}" alt=""><div class="cap">${r.label||''}</div>
            </button>`).join('')}
        </div>
        <div class="row-actions">
          <button class="btn white" id="back">Back</button>
          <button class="btn azure" id="next">Next</button>
        </div>
      </div>
    `);
    stepEl.querySelectorAll('.tile').forEach(btn=>{
      btn.onclick = ()=>{ stepEl.querySelectorAll('.tile').forEach(x=>x.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); s.room_id = btn.dataset.id; s.wall_id = null; };
    });
    stepEl.querySelector('#back').onclick = ()=>{ stepIdx=1; render(); };
    stepEl.querySelector('#next').onclick = ()=>{ if(!s.room_id) s.room_id = rooms[0]?.room_id; stepIdx=3; render(); };
  }

  /* WALL */
  function renderWall(){
    const s = st(); if(!s.room_id){ stepIdx=2; return render(); }
    const walls = allowedWalls(s.room_id);
    let idx = Math.max(0, walls.findIndex(w=> w.wall_id===s.wall_id)); if(idx<0) idx=0;
    const tvLabel = tvCount > 1 ? ` (TV ${tvIndex + 1} of ${tvCount})` : '';

    stepEl.innerHTML = html(`
      <div class="stage">
        <h1>Pick your WALL${tvLabel}</h1>
        <div class="frame16x9 ${s.wall_id?'outline':''}" id="frame" aria-selected="${Boolean(s.wall_id)}">
          <img class="bg-img" id="wallImg" src="${walls[idx]?.image_url||''}" alt="">
          <button class="caro-chev left" id="prev" aria-label="previous">${chev()}</button>
          <button class="caro-chev right flip" id="nextImg" aria-label="next">${chev()}</button>
        </div>
        <div class="caro-label" id="wallLabel">${walls[idx]?.label||''}</div>
        <div class="row-actions">
          <button class="btn white" id="back">Back</button>
          <button class="btn azure" id="next">Next</button>
        </div>
      </div>
    `);
    const img = stepEl.querySelector('#wallImg');
    const lab = stepEl.querySelector('#wallLabel');
    const frame = stepEl.querySelector('#frame');

    function paint(){ img.src = walls[idx]?.image_url||''; lab.textContent = walls[idx]?.label||''; }
    stepEl.querySelector('#prev').onclick = ()=>{ idx = (idx-1+walls.length)%walls.length; paint(); };
    stepEl.querySelector('#nextImg').onclick = ()=>{ idx = (idx+1)%walls.length; paint(); };
    frame.addEventListener('click', ()=>{ s.wall_id = walls[idx]?.wall_id; frame.classList.add('outline'); frame.setAttribute('aria-selected','true'); });

    stepEl.querySelector('#back').onclick = ()=>{ stepIdx=2; render(); };
    stepEl.querySelector('#next').onclick = ()=>{ if(!s.wall_id) s.wall_id = walls[idx]?.wall_id; stepIdx=4; render(); };
  }

  /* SIZE */
  function renderSize(){
    const s = st(); if(!s.wall_id){ stepIdx=3; return render(); }
    const wall = (CH.walls||[]).find(w=> w.wall_id===s.wall_id);
    const sizes = CH.sizes||[];
    let idx = Math.max(0, sizes.findIndex(z=> z.size_id===s.size_id)); if(idx<0) idx=0;
    const tvLabel = tvCount > 1 ? ` (TV ${tvIndex + 1} of ${tvCount})` : '';

    stepEl.innerHTML = html(`
      <div class="stage">
        <h1>Pick your SIZE${tvLabel}</h1>
        <div class="frame16x9 outline" id="sizeFrame" aria-selected="true">
          <img class="bg-img" id="sizeBg" src="${wall?.image_url||''}" alt="">
          <img class="tv" id="sizeTv" src="${CH.config.tv_image_url||''}" alt="">
          <button class="caro-chev left" id="prev" aria-label="previous">${chev()}</button>
          <button class="caro-chev right flip" id="nextImg" aria-label="next">${chev()}</button>
        </div>
        <div class="caro-label" id="sizeLabel">${sizes[idx]?.label||''}</div>
        <div class="row-actions">
          <button class="btn white" id="back">Back</button>
          <button class="btn azure" id="next">Next</button>
        </div>
      </div>
    `);

    const lab = stepEl.querySelector('#sizeLabel');
    const tv = stepEl.querySelector('#sizeTv');
    function draw(){ lab.textContent = sizes[idx]?.label || ''; drawTV(tv, sizes[idx]); }

    stepEl.querySelector('#prev').onclick = ()=>{ idx = (idx-1+sizes.length)%sizes.length; draw(); };
    stepEl.querySelector('#nextImg').onclick = ()=>{ idx = (idx+1)%sizes.length; draw(); };

    /* PS PATCH: store mount-aware price when picking size */
    stepEl.querySelector('#sizeFrame').addEventListener('click', ()=>{
      const b = sizes[idx];
      s.size_id = b?.size_id;
      s.price_usd = priceFor(b, s.mount_choice || 'BYO');
    });

    stepEl.querySelector('#back').onclick = ()=>{ stepIdx=3; render(); };
    stepEl.querySelector('#next').onclick = ()=>{
      if(!s.size_id){
        const b = sizes[idx];
        s.size_id = b?.size_id;
        s.price_usd = priceFor(b, s.mount_choice || 'BYO');
      }
      stepIdx=5; render();
    };
    draw();
  }

  /* HEIGHT */
  function renderHeight(){
    const s = st(); if(!s.size_id){ stepIdx=4; return render(); }
    const wall = (CH.walls||[]).find(w=> w.wall_id===s.wall_id);
    const sizes = CH.sizes||[];
    const sizeBucket = sizes.find(z=> z.size_id===s.size_id);
    const heights = CH.heights||[];
    let idx = Math.max(0, heights.findIndex(h=> h.height_id===s.height_id)); if(idx<0) idx=0;
    const tvLabel = tvCount > 1 ? ` (TV ${tvIndex + 1} of ${tvCount})` : '';

    stepEl.innerHTML = html(`
      <div class="stage">
        <h1>Place your TV${tvLabel}</h1>
        <div class="frame16x9 outline" id="heightFrame">
          <img class="bg-img" src="${wall?.image_url||''}" alt="">
          <img class="tv" id="heightTv" src="${CH.config.tv_image_url||''}" alt="">
          <button class="caro-chev left" id="prev" aria-label="previous">${chev()}</button>
          <button class="caro-chev right flip" id="nextImg" aria-label="next">${chev()}</button>
        </div>
        <div class="caro-label" id="heightLabel">${heights[idx]?.label||''}</div>
        <div class="row-actions">
          <button class="btn white" id="back">Back</button>
          <button class="btn azure" id="next">Next</button>
        </div>
      </div>
    `);

    const tv = stepEl.querySelector('#heightTv');
    const lab = stepEl.querySelector('#heightLabel');
    function draw(){ lab.textContent = heights[idx]?.label || ''; drawTV(tv, sizeBucket, heights[idx]); }
    stepEl.querySelector('#prev').onclick = ()=>{ idx = (idx-1+heights.length)%heights.length; draw(); };
    stepEl.querySelector('#nextImg').onclick = ()=>{ idx = (idx+1)%heights.length; draw(); };
    stepEl.querySelector('#heightFrame').addEventListener('click', ()=>{ s.height_id = heights[idx]?.height_id; });

    stepEl.querySelector('#back').onclick = ()=>{ stepIdx=4; render(); };
    stepEl.querySelector('#next').onclick = ()=>{
      if(!s.height_id) s.height_id = heights[idx]?.height_id;
      if(tvIndex < tvCount-1){ tvIndex++; stepIdx=1; render(); return; }
      stepIdx=6; render();
    };
    draw();
  }

  /* REVIEW */
  function renderReview(){
    const active = picks.slice(0, tvCount);

    /* PS PATCH: mount-aware estimate total */
    let total = 0;
    active.forEach(p=>{
      const sz=(CH.sizes||[]).find(z=> z.size_id===p.size_id);
      total += priceFor(sz, p.mount_choice || 'BYO');
    });

    const p0 = active[0]||{};
    const wall = (CH.walls||[]).find(w=> w.wall_id===p0.wall_id);
    const sizeBucket = (CH.sizes||[]).find(z=> z.size_id===p0.size_id);
    const heightPreset = (CH.heights||[]).find(h=> h.height_id===p0.height_id);

    stepEl.innerHTML = html(`
      <div class="stage">
        <h1>REVIEW ORDER</h1>
        <div class="rev">
          <div>
            <div class="frame16x9 outline">
              <img class="bg-img" src="${wall?.image_url||''}" alt="">
              <img class="tv" id="revTv" src="${CH.config.tv_image_url||''}" alt="">
            </div>

            <div class="subhead">Contact information</div>
            <div class="form">
              <input id="c_name" class="inp" type="text" placeholder="Full name">
              <input id="c_email" class="inp" type="email" placeholder="Email">
              <input id="c_phone" class="inp" type="tel" placeholder="Phone">
            </div>

            <div id="err" class="alert" style="display:none"></div>
          </div>

          <div>
            ${active.map((p,i)=>{
              const r = (CH.rooms||[]).find(x=> x.room_id===p.room_id)?.label || '-';
              const w = (CH.walls||[]).find(x=> x.wall_id===p.wall_id)?.label || '-';
              const s = (CH.sizes||[]).find(x=> x.size_id===p.size_id)?.label || '-';
              const h = (CH.heights||[]).find(x=> x.height_id===p.height_id)?.label || '-';
              const m = (p.mount_choice==='H2S') ? 'Provided by Home2Smart' : 'Customer provided';
              return `
                <div style="margin-bottom:14px; font-weight:800">TV ${i+1}</div>
                <div class="kv">
                  <div class="k">Room</div><div>${r}</div>
                  <div class="k">Wall</div><div>${w}</div>
                  <div class="k">Size</div><div>${s}</div>
                  <div class="k">Height</div><div>${h}</div>
                  <div class="k">Mount</div><div>${m}</div>
                </div>
                <div class="row-actions" style="justify-content:flex-start; margin-top:10px">
                  <button class="btn white" data-edit="${i}">Edit this TV</button>
                </div>
                ${i<active.length-1?'<hr style="border:none;border-top:1px solid rgba(255,255,255,.2);margin:16px 0">':''}
              `;
            }).join('')}
            <div class="sub" style="margin-top:8px">Total shown is an estimate. Final pricing is on the Stripe checkout.</div>
            <div style="margin-top:6px; font-weight:900; font-size:18px">Estimated Total: $${total.toFixed(2)}</div>

            <div class="row-actions" style="justify-content:flex-start; margin-top:14px">
              <button class="btn white" id="back">Back</button>
              <button class="btn azure" id="submit">Continue to Checkout</button>
            </div>
          </div>
        </div>
      </div>
    `);

    drawTV(document.getElementById('revTv'), sizeBucket, heightPreset);

    stepEl.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick = ()=>{ tvIndex = Number(b.getAttribute('data-edit')); stepIdx=1; render(); };
    });
    stepEl.querySelector('#back').onclick = ()=>{ stepIdx=5; render(); };

    // Create Stripe Checkout session and redirect (simple POST: no header)
    stepEl.querySelector('#submit').onclick = async ()=>{
      const customerName = document.getElementById('c_name')?.value || '';
      const customerEmail = document.getElementById('c_email')?.value || '';
      const customerPhone = document.getElementById('c_phone')?.value || '';
      
      const orderPayload = {
        __action: 'create_session',
        order: {
          customer_name: customerName,
          customer_email: customerEmail,
          customer_phone: customerPhone,
          num_tvs: tvCount, notes:''
        },
        items: picks.slice(0,tvCount).map((p,i)=>({
          tv_index:i+1,
          room_id:p.room_id, wall_id:p.wall_id, size_id:p.size_id, height_id:p.height_id,
          mount_choice: p.mount_choice || 'BYO',
          declared_tv_inches: p.declared_tv_inches || '',
          asset_image_urls:''
        }))
      };
      const err = document.getElementById('err');

      // Track checkout initiation with customer data (advanced matching)
      if (window.trackCheckoutInit) {
        await window.trackCheckoutInit({
          name: customerName,
          email: customerEmail,
          phone: customerPhone
        }, total, tvCount);
      }

      buildLoader(LOADER_SVG, 8); showLoader();
      err.style.display='none';

      try{
        // IMPORTANT: no Content-Type header (avoids preflight)
        const resp = await fetch(API, { method:'POST', body: JSON.stringify(orderPayload) });
        const text = await resp.text();
        if(!resp.ok){ err.textContent = text || ('Submit failed ' + resp.status); err.style.display='block'; return; }
        const data = JSON.parse(text);
        const url = data?.pay?.session_url;
        if (!url){ err.textContent = 'Could not create checkout session. Check Stripe price IDs in Sizes.'; err.style.display='block'; return; }
        window.location = url; // redirect to Stripe
      }catch(e){
        err.textContent = String(e); err.style.display='block';
      } finally {
        hideLoader();
      }
    };
  }

  /* Helpers */
  function allowedWalls(room_id){
    const ok = new Set((CH.rules||[]).filter(r=> r.room_id===room_id && r.allowed).map(r=> r.wall_id));
    return (CH.walls||[]).filter(w=> ok.has(w.wall_id));
  }

  function drawTV(tvEl, sizeBucket, heightPreset){
    if(!tvEl) return;
    const box = tvEl.parentElement;
    const ch = box.clientHeight;
    const cw = box.clientWidth;
    const pct = Number(sizeBucket?.visual_scale_pct || 0.22);
    const tvH = Math.max(70, Math.min(ch * pct, ch*0.92));
    const tvW = tvH * (16/9);
    const offset = Number(heightPreset?.visual_offset_px || 0);
    const left = (cw - tvW)/2;
    const top = Math.max(8, Math.min((ch - tvH) - 8, (ch - tvH)/2 + offset));
    Object.assign(tvEl.style, { width: tvW+'px', height: tvH+'px', left:left+'px', top:top+'px' });
  }

  function chev(){ return `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>`; }

  (async ()=> {
    try{
      buildLoader(LOADER_SVG, 8); showLoader();
      picks = [{ tv_index:1 }];
      await loadChoices();
      render();
    } catch(e){
      document.getElementById('h2s').innerHTML = `<div class="stage"><h1>Couldn’t load options</h1><div class="sub">${String(e)}</div></div>`;
    } finally {
      hideLoader();
    }
  })();
})();

/* ===== H2S TRACKING SYSTEM (Unified for all pages) ===== */
window.H2S_DASH_URL = 'https://script.google.com/macros/s/AKfycbxVsGP8EeAZmfRcW9LjY3fm1F9iWvXMO7RlT4VP7Tj1BV0BOkeBi6GAkASQhEZJ7h9Y/exec';

(function(){
  // Generate or retrieve session and user IDs
  function generateId(prefix){
    return prefix + '_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
  }
  
  // Session ID: Per browsing session (sessionStorage)
  let sessionId = sessionStorage.getItem('h2s_session_id');
  if (!sessionId) {
    sessionId = generateId('sess');
    sessionStorage.setItem('h2s_session_id', sessionId);
  }
  
  // User ID: Persistent across sessions (localStorage)
  let userId = localStorage.getItem('h2s_user_id');
  if (!userId) {
    userId = generateId('user');
    localStorage.setItem('h2s_user_id', userId);
  }
  
  // Initialize tracking object
  window.H2S_TRACKING = {
    enabled: true,
    sessionId: sessionId,
    userId: userId,
    pageStartTime: Date.now()
  };
  
  console.log('✅ H2S Tracking Active - Session:', sessionId.substring(0, 20) + '...');
  
  // Tracking URL helper
  function getTrackingURL(){
    return window.H2S_FORM_URL || window.H2S_DASH_URL || 
      'https://script.google.com/macros/s/AKfycbxVsGP8EeAZmfRcW9LjY3fm1F9iWvXMO7RlT4VP7Tj1BV0BOkeBi6GAkASQhEZJ7h9Y/exec';
  }
  
  // Send tracking event to backend
  window.sendTrackingEvent = function(eventData){
    if (!window.H2S_TRACKING.enabled) return;
    
    // Enrich event data
    eventData.session_id = window.H2S_TRACKING.sessionId;
    eventData.user_id = window.H2S_TRACKING.userId;
    eventData.timestamp = new Date().toISOString();
    eventData.page_path = window.location.pathname;
    eventData.page_url = window.location.href;
    eventData.page_title = document.title;
    eventData.referrer = document.referrer;
    eventData.user_agent = navigator.userAgent;
    
    var url = getTrackingURL() + '?action=tracking_event';
    
    // Use sendBeacon (text/plain to AVOID preflight) with fallback simple fetch
    try {
      var payloadStr = JSON.stringify(eventData);
      if (navigator.sendBeacon) {
        var blob = new Blob([payloadStr], { type: 'text/plain' });
        var sent = navigator.sendBeacon(url, blob);
        if(!sent){
          fetch(url, { method:'POST', keepalive:true, body: payloadStr })
            .catch(function(err){ console.warn('Tracking fetch fallback error:', err); });
        }
      } else {
        fetch(url, { method:'POST', keepalive:true, body: payloadStr })
          .catch(function(err){ console.warn('Tracking fetch error:', err); });
      }
    } catch(err){ console.warn('Tracking beacon error:', err); }
  };
  
  // Send Meta Pixel event to backend (mirrors fbq calls)
  window.sendMetaPixelEvent = function(eventName, eventParams, eventId){
    var payload = {
      event_name: eventName,
      event_id: eventId || '',
      session_id: window.H2S_TRACKING.sessionId,
      user_id: window.H2S_TRACKING.userId,
      event_source_url: window.location.href,
      referrer: document.referrer,
      user_agent: navigator.userAgent,
      event_time: Math.floor(Date.now() / 1000),
      action_source: 'website'
    };
    
    // Merge any event parameters
    if (eventParams) {
      Object.keys(eventParams).forEach(function(key){
        payload[key] = eventParams[key];
      });
    }
    
    var url = getTrackingURL() + '?action=meta_pixel_event';
    
    try {
      var mpStr = JSON.stringify(payload);
      if (navigator.sendBeacon) {
        var mpBlob = new Blob([mpStr], { type: 'text/plain' });
        var sent = navigator.sendBeacon(url, mpBlob);
        if(!sent){
          fetch(url, { method:'POST', keepalive:true, body: mpStr })
            .catch(function(err){ console.warn('Meta pixel fetch fallback error:', err); });
        }
      } else {
        fetch(url, { method:'POST', keepalive:true, body: mpStr })
          .catch(function(err){ console.warn('Meta pixel fetch error:', err); });
      }
    } catch(mpErr){ console.warn('Meta pixel beacon error:', mpErr); }
  };
  
  // Auto-track PageView on load
  sendTrackingEvent({
    event_type: 'page_view',
    event_name: 'PageView',
    page_title: 'TV Mounting Wizard'
  });
  
  // Track time on page (send on exit)
  window.addEventListener('beforeunload', function(){
    var timeOnPage = Math.floor((Date.now() - window.H2S_TRACKING.pageStartTime) / 1000);
    sendTrackingEvent({
      event_type: 'page_exit',
      event_name: 'TimeOnPage',
      time_on_page: timeOnPage
    });
  });
  
  // Track scroll depth at milestones (25%, 50%, 75%, 100%)
  var scrollMilestones = [25, 50, 75, 100];
  var trackedMilestones = [];
  
  window.addEventListener('scroll', function(){
    var docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    var scrollPercent = Math.floor((window.scrollY / docHeight) * 100);
    
    scrollMilestones.forEach(function(milestone){
      if (scrollPercent >= milestone && !trackedMilestones.includes(milestone)) {
        trackedMilestones.push(milestone);
        sendTrackingEvent({
          event_type: 'scroll',
          event_name: 'Scroll' + milestone,
          scroll_depth: milestone
        });
      }
    });
  }, {passive: true});
  
  // Intercept fbq() calls and mirror to backend
  if (typeof fbq !== 'undefined') {
    var originalFbq = fbq;
    window.fbq = function(){
      // Call original fbq
      originalFbq.apply(this, arguments);
      
      // Mirror 'track' events to backend
      if (arguments[0] === 'track' || arguments[0] === 'trackCustom') {
        var eventName = arguments[1];
        var eventParams = arguments[2] || {};
        var eventId = eventParams.event_id || '';
        
        sendMetaPixelEvent(eventName, eventParams, eventId);
      }
    };
  }
  
  // Track wizard step changes
  var wizardObserver = new MutationObserver(function(){
    var stepEl = document.getElementById('h2s-step');
    if (stepEl && stepEl.querySelector('h1')) {
      var stepTitle = stepEl.querySelector('h1').textContent;
      sendTrackingEvent({
        event_type: 'wizard_step',
        event_name: 'WizardStep',
        cta_label: stepTitle,
        custom_data: stepTitle
      });
    }
  });
  
  var stepElement = document.getElementById('h2s-step');
  if (stepElement) {
    wizardObserver.observe(stepElement, { childList: true, subtree: true });
  }
  
  // Track button clicks in wizard
  document.addEventListener('click', function(e){
    var btn = e.target.closest('.btn, button');
    if (btn && btn.textContent) {
      sendTrackingEvent({
        event_type: 'click',
        event_name: 'WizardButtonClick',
        cta_label: btn.textContent.trim(),
        element_class: btn.className
      });
    }
  });
  
  // Track checkout initiation
  window.trackCheckoutInit = function(customerData, orderTotal, numTvs) {
    sendTrackingEvent({
      event_type: 'checkout',
      event_name: 'InitiateCheckout',
      custom_data: JSON.stringify({
        value: orderTotal,
        currency: 'USD',
        num_items: numTvs,
        customer_name: customerData.name || '',
        customer_email: customerData.email || '',
        customer_phone: customerData.phone || ''
      })
    });
  };
})();
</script>

<!-- ===== TRACKING CLIENT ===== -->
<script>
(function() {
    'use strict';
    
    const TRACK_API = 'https://h2s-backend.vercel.app/api/track';
    const VISITOR_KEY = 'h2s_visitor_id';
    const SESSION_KEY = 'h2s_session_id';
    
    function getVisitorId() {
        let vid = localStorage.getItem(VISITOR_KEY);
        if (!vid) {
            vid = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
            localStorage.setItem(VISITOR_KEY, vid);
        }
        return vid;
    }
    
    function getSessionId() {
        let sid = sessionStorage.getItem(SESSION_KEY);
        if (!sid) {
            sid = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
            sessionStorage.setItem(SESSION_KEY, sid);
        }
        return sid;
    }
    
    function extractUTM() {
        const params = new URLSearchParams(window.location.search);
        return {
            utm_source: params.get('utm_source') || null,
            utm_medium: params.get('utm_medium') || null,
            utm_campaign: params.get('utm_campaign') || null,
            utm_term: params.get('utm_term') || null,
            utm_content: params.get('utm_content') || null
        };
    }
    
    function sendEvent(payload, retries = 1) {
        const useBeacon = navigator.sendBeacon && retries === 1;
        
        if (useBeacon) {
            const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
            if (navigator.sendBeacon(TRACK_API, blob)) {
                return Promise.resolve();
            }
        }
        
        return fetch(TRACK_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            keepalive: true
        })
        .then(res => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        })
        .catch(err => {
            if (retries > 0) {
                return new Promise(resolve => {
                    setTimeout(() => {
                        sendEvent(payload, retries - 1).then(resolve).catch(() => resolve());
                    }, 500);
                });
            }
        });
    }
    
    function track(eventType, data = {}) {
        const payload = {
            event: eventType,
            event_type: eventType,
            occurred_at: new Date().toISOString(),
            visitor_id: getVisitorId(),
            session_id: getSessionId(),
            page_url: window.location.href,
            page_path: window.location.pathname,
            referrer: document.referrer || null,
            user_agent: navigator.userAgent,
            ...extractUTM(),
            ...data
        };
        
        if (data.element_id) payload.element_id = data.element_id;
        if (data.element_text) payload.element_text = data.element_text;
        if (data.metadata) payload.metadata = data.metadata;
        
        if (eventType === 'page_view') {
            if ('requestIdleCallback' in window) {
                requestIdleCallback(() => sendEvent(payload), { timeout: 2000 });
            } else {
                setTimeout(() => sendEvent(payload), 100);
            }
        } else {
            sendEvent(payload);
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            track('page_view');
        });
    } else {
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => track('page_view'), { timeout: 2000 });
        } else {
            setTimeout(() => track('page_view'), 100);
        }
    }
    
    document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-track]');
        if (target) {
            const eventType = target.getAttribute('data-track') || 'click';
            track(eventType, {
                element_id: target.id || target.getAttribute('data-track-id') || null,
                element_text: target.textContent?.trim().substring(0, 100) || null
            });
        }
    }, { passive: true });
    
    document.addEventListener('submit', function(e) {
        if (e.target.tagName === 'FORM') {
            track('form_submit', {
                element_id: e.target.id || 'unknown_form'
            });
        }
    }, { passive: true });
    
    document.addEventListener('click', function(e) {
        const link = e.target.closest('a[href]');
        if (link && link.hostname !== window.location.hostname) {
            track('outbound', {
                element_id: link.id || null,
                element_text: link.textContent?.trim().substring(0, 100) || null,
                metadata: { url: link.href }
            });
        }
    }, { passive: true });
    
    window.h2sTrack = track;
    
    window.addEventListener('beforeunload', function() {
        const payload = {
            event: 'page_unload',
            event_type: 'page_unload',
            occurred_at: new Date().toISOString(),
            visitor_id: getVisitorId(),
            session_id: getSessionId(),
            page_url: window.location.href,
            page_path: window.location.pathname
        };
        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        navigator.sendBeacon(TRACK_API, blob);
    });
})();
</script>
