<!-- filepath: c:\Users\tabar\H2S Website Audit\Home.html -->
<!-- Home2Smart â€¢ /home â€¢ v1.6 (MAXED FOR 90+) -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public, max-age=31536000, immutable">
<meta name="format-detection" content="telephone=no">
<meta name="color-scheme" content="light">
<meta http-equiv="origin-trial" content="">

<!-- Preload LCP hero image from CDN -->
<link rel="preload" as="image"
  href="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/house-base-880.avif"
  fetchpriority="high" type="image/avif">

<!-- Preload critical logo -->
<link rel="preload" as="image"
  href="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png"
  fetchpriority="high" type="image/png">

<!-- Preload critical font subset (Latin only, weights 400+900) -->
<link rel="preload" as="font" type="font/woff2" crossorigin
  href="https://fonts.gstatic.com/s/archivo/v18/k3kQo8UDI-1M0wlSV9XAw6lQkqWY8Q82sJaRE-NWIDdgffTY.woff2">

<!-- App icons from CDN -->
<link rel="icon" type="image/png" sizes="180x180" href="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-192-2.png">
<link rel="icon" type="image/png" sizes="512x512" href="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-512.png">

<!-- iOS Home Screen -->
<link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/home-180.png">

<!-- Web App Manifest (Android/Chrome) -->
<link rel="manifest" href="https://home2smart.com/site.webmanifest">
<meta name="theme-color" content="#0a2a5a">

<!-- Connection hints for critical origins (keep under 4) -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- Avoid preconnecting to third-parties loaded late (FB/chat) to reduce overhead -->

<style>
/* Inline critical fonts for faster render */
@font-face{font-family:'Archivo';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/archivo/v18/k3kQo8UDI-1M0wlSV9XAw6lQkqWY8Q82sJaRE-NWIDdgffTY.woff2) format('woff2');unicode-range:U+0000-00FF}
@font-face{font-family:'Archivo';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/archivo/v18/k3kQo8UDI-1M0wlSV9XAw6lQkqWY8Q82sJaRE-NWIDdgffTY.woff2) format('woff2');unicode-range:U+0000-00FF}
@font-face{font-family:'Archivo';font-style:normal;font-weight:900;font-display:swap;src:url(https://fonts.gstatic.com/s/archivo/v18/k3kQo8UDI-1M0wlSV9XAw6lQkqWY8Q82sJaRE-NWIDdgffTY.woff2) format('woff2');unicode-range:U+0000-00FF}

:root{
  --cobalt:#0a2a5a; --azure:#1493ff; --white:#ffffff;
  --ease:cubic-bezier(.22,.8,.32,1); --ease-smooth:cubic-bezier(.16,.84,.44,1);
  --elev-1:0 2px 6px rgba(0,0,0,.20), 0 6px 18px rgba(0,0,0,.14);
  --elev-2:0 6px 14px rgba(0,0,0,.24), 0 18px 28px rgba(0,0,0,.18);
  --elev-card:0 2px 10px rgba(0,0,0,.08); --elev-card-lg:0 16px 36px rgba(0,0,0,.22);
  --hero-art-w: clamp(260px,40vw,440px);
}
html,body{margin:0;padding:0;background:var(--cobalt);color:var(--white);font-family:Archivo,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif}
body{overflow-x:hidden}
*{box-sizing:border-box !important}
._builder-container, ._row, .container, .hl_page-container, .hl_page-preview, .hl_page-wrapper, .elPreview, .elCustomCode, .de-section{max-width:none !important;padding:0 !important;margin:0 !important}
section{width:100%;margin:0;padding:0}

/* NUCLEAR LOGO FIX - Override all GHL interference */
.h2s-logo, .h2s-logo *, .h2s-logo img, .h2s-logo picture{
  display:block !important;
  visibility:visible !important;
  opacity:1 !important;
  transform:none !important;
  filter:none !important;
  clip:auto !important;
  clip-path:none !important;
  mask:none !important;
  -webkit-mask:none !important;
}
img[alt*="Logo"], img[alt*="Home2Smart"]{
  display:block !important;
  visibility:visible !important;
  opacity:1 !important;
}

/* Type */
.h1{font-weight:900;font-size:clamp(42px,6vw,84px);line-height:1.02;letter-spacing:.2px;margin:0}
.h1-stack .line{display:block}
.sub{font-weight:400;font-size:clamp(16px,1.6vw,22px);opacity:.9;line-height:1.5}

/* ===== SITE-WIDE CONTAINER ===== */
.container{
  width: 100%;
  max-width: 1280px;
  margin-inline: auto;
  padding-inline: clamp(20px, 4vw, 40px);
  box-sizing: border-box;
}

/* ===== HEADER ===== */
.h2s-header{
  position:sticky; top:0; z-index:1000; color:var(--cobalt);
  background:#fff;
  box-shadow:0 6px 18px rgba(0,0,0,.22);
  border-bottom:1px solid rgba(255,255,255,.12);
  width:100vw !important;
  margin-left:calc(50% - 50vw) !important;
  margin-right:calc(50% - 50vw) !important;
  left:0 !important;
  right:0 !important;
  contain:layout style paint;
}
.h2s-head-row{
  display:grid;
  grid-template-columns:auto 1fr auto;
  align-items:center; gap:12px;
  padding-block: 10px;
  max-width:1280px; 
  margin-inline:auto;
  padding-inline: clamp(20px, 4vw, 40px);
}
.h2s-logo{display:flex;align-items:center;gap:12px;width:auto;height:auto;flex-shrink:0;min-width:64px;min-height:64px}
.h2s-logo img{height:64px !important;width:64px !important;display:block !important;object-fit:contain;max-width:none !important;min-width:64px !important;min-height:64px !important;visibility:visible !important;opacity:1 !important}
.h2s-logo picture{display:block;height:64px;width:auto}
.h2s-logo picture > img{display:block;height:64px;width:auto;object-fit:contain;max-width:none}
.h2s-mainnav{
  justify-self:center;
  display:flex;justify-content:center;align-items:center;gap:0;font-weight:900;font-size:clamp(22px,2.6vw,36px);text-transform:lowercase;white-space:nowrap}
.h2s-mainnav a{color:var(--cobalt);text-decoration:none;line-height:1;display:inline-block;padding:0 1.2rem;transition:transform .18s var(--ease),color .18s var(--ease)}
.h2s-mainnav a + a{border-left:2px solid var(--azure)}
@media (min-width:1024px){.h2s-mainnav a{padding:0 2.6rem}}
@media (min-width:1440px){.h2s-mainnav a{padding:0 2.4rem}}
.h2s-mainnav a:hover{transform:translateY(-2px);color:var(--azure)}
.h2s-cta-right{justify-self:end}
.h2s-cta-right a,
.h2s-header .h2s-cta-right a,
header .h2s-cta-right a{
  color:var(--azure) !important;
  background:transparent !important;
  padding:0 !important;
  border:none !important;
  border-radius:0 !important;
  text-decoration:none !important;
  font-weight:700 !important;
  font-size:clamp(16px,1.6vw,20px) !important;
  display:inline-block !important;
  transition:transform .18s var(--ease),opacity .18s var(--ease) !important;
}
.h2s-cta-right a:hover,
.h2s-header .h2s-cta-right a:hover{
  transform:translateY(-2px) !important;
  opacity:.9 !important;
  text-decoration:none !important;
  background:transparent !important;
}

/* === MOBILE NAV FIT === */
@media (max-width: 640px){
  .h2s-head-row{padding:8px 12px; gap:8px}
  .h2s-logo{height:48px}
  .h2s-logo img,.h2s-logo picture,.h2s-logo picture > img{height:48px; width:48px}
  .h2s-mainnav{font-size:18px}
  .h2s-mainnav a{padding:0 .7rem}
  .h2s-mainnav a + a{border-left:1px solid var(--azure)}
  .h2s-cta-right a{font-size:14px}
  /* Reduce paint budget on mobile */
  .blurb{ box-shadow:0 2px 8px rgba(0,0,0,.12); transform:none !important }
  .blurb:hover{ box-shadow:0 2px 8px rgba(0,0,0,.12); transform:none !important }
  .blurb::before{ display:none !important }
}

/* ===== HERO ===== */
.hero{background:var(--cobalt);padding:clamp(48px,9vw,110px) 0;contain:layout style paint}
.hero-grid{
  display:grid;
  gap:clamp(10px,1.8vw,18px);
  align-items:center;
  grid-template-columns:1fr;
  max-width:1280px;
  margin-inline:auto;
  padding-inline:clamp(20px,4vw,40px);
  box-sizing:border-box;
}
/* Trust strip (reviews rating inline for immediate credibility) */
.trust-strip{
  display:inline-flex;align-items:center;gap:10px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.18);
  padding:10px 16px;border-radius:14px;
  font-weight:700;font-size:clamp(13px,1.2vw,15px);
  color:var(--white);backdrop-filter:blur(6px);
  box-shadow:0 4px 14px rgba(0,0,0,.25);
  position:relative;overflow:hidden;
}
.trust-strip .stars{color:#ffd24d;filter:drop-shadow(0 2px 4px rgba(255,210,77,.35))}
.trust-strip .count{opacity:.85;font-weight:600}
.trust-strip[data-loading="true"]{opacity:.6}
.trust-strip::after{content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.12),rgba(255,255,255,.04));mix-blend-mode:overlay;pointer-events:none}
@media (min-width:980px){.hero-grid{grid-template-columns:1.1fr .9fr; gap:28px}}
.hero-grid > div:first-child{min-height:280px}
.hero-cta-wrap{grid-column:1 / -1; display:flex; justify-content:center; margin-top:18px}

/* CTA buttons */
.btn{
  appearance:none;border:2px solid var(--azure);background:var(--azure);color:var(--white);
  font-weight:700;border-radius:12px;cursor:pointer;text-decoration:none;
  display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
  padding:.95rem 1.25rem;min-height:48px;min-width:140px;font-size:clamp(14px,1.4vw,18px);
  transition:transform .2s var(--ease),box-shadow .22s var(--ease-smooth);
  margin-top:14px;box-shadow:var(--elev-1);will-change:transform,box-shadow;transform:translateZ(0);
}
.btn:hover{transform:translateY(-6px);box-shadow:var(--elev-2)}
.btn:active{transform:translateY(-2px);box-shadow:var(--elev-1)}
.btn:focus-visible{outline:2px solid var(--white);outline-offset:2px}
.btn-secondary{
  background:transparent;
  border-color:var(--white);
  color:var(--white);
}
.btn-secondary:hover{
  background:var(--white);
  color:var(--cobalt);
}
.hero-cta-wrap{gap:12px;flex-wrap:wrap}

/* AI Chat CTA Button (Hero inline) */
.btn-chat{
  background:var(--white);
  border-color:var(--white);
  color:var(--cobalt);
  position:relative;
}
.btn-chat:hover{
  background:var(--azure);
  color:var(--white);
  border-color:var(--azure);
}
.btn-chat::before{
  content:"ðŸ’¬";
  margin-right:4px;
  font-size:1.1em;
}
/* Loading state */
.btn-chat.loading{
  pointer-events:none;
  opacity:0.7;
}
.btn-chat.loading::before{
  content:"â³";
  animation:spin 1s linear infinite;
}
@keyframes spin{
  from{transform:rotate(0deg)}
  to{transform:rotate(360deg)}
}
/* Shake animation for chat button */
@keyframes btnShake{
  0%,100%{transform:translateY(0) rotate(0deg)}
  25%{transform:translateY(-4px) rotate(-2deg)}
  50%{transform:translateY(-6px) rotate(0deg)}
  75%{transform:translateY(-4px) rotate(2deg)}
}
.btn-chat.shake{
  animation:btnShake 0.5s ease 5s 1;
}

/* ===== HERO ART (placement + de-glitch) ===== */
.hero-art{position:relative;display:flex;align-items:center;justify-content:center;contain:paint;min-height:330px}

/* LCP element: do NOT animate opacity */
.hero-art .house{
  width:var(--hero-art-w);
  height:auto;
  display:block;
  aspect-ratio:880/660;
}
.hero-art .house.in{
  transform:none;
  transition:transform .55s cubic-bezier(.22,.8,.32,1);
}

/* Door overlay can animate opacity safely (not LCP) */
.hero-art .door-lit{
  position:absolute;inset:0;margin:auto;width:var(--hero-art-w);height:auto;aspect-ratio:880/660;
  -webkit-mask-image: radial-gradient(circle 10% at 67% 78%, #000 98%, transparent 100%);
  mask-image: radial-gradient(circle 10% at 67% 78%, #000 98%, transparent 100%);
  opacity:0;
  pointer-events:none;
}
.hero-art .door-lit.in{
  opacity:1;
  transform:none;
  transition:transform .55s cubic-bezier(.22,.8,.32,1), opacity .50s ease;
}
@keyframes doorFlickerCycle{
  0%{opacity:0} 2%{opacity:1} 4%{opacity:0} 6%{opacity:1} 8%{opacity:0} 10%{opacity:1}
  70%{opacity:1} 73%{opacity:0} 76%{opacity:1} 79%{opacity:0} 82%{opacity:1} 86%{opacity:0}
  100%{opacity:0}
}
.hero-art .door-lit.loop{animation:doorFlickerCycle 8s linear .2s infinite both}

/* ===== SERVICES ===== */
#services{background:var(--cobalt);color:var(--white);content-visibility:auto;contain-intrinsic-size:1000px}
.services-wrap{padding:clamp(36px,6vw,72px) clamp(18px,6vw,72px);display:grid;gap:24px;max-width:1280px;margin-inline:auto}
.blurbs{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:clamp(16px,3vw,28px)}
@media (max-width:900px){.blurbs{grid-template-columns:1fr}}
.blurb{
  position:relative;background:#ffffff;color:var(--cobalt);
  border:1px solid #e7eaf0;border-radius:12px;
  padding:16px 18px;box-shadow:var(--elev-card);
  transform:translateZ(0) perspective(900px) rotateX(0) rotateY(0) translateY(0);
  transition:transform .35s var(--ease),box-shadow .35s var(--ease),border-color .35s var(--ease),background-color .35s var(--ease),opacity .35s ease,filter .35s ease;
  will-change:transform,box-shadow,opacity,filter;
  contain:layout style paint;
}
.blurb::before{content:""; position:absolute; inset:-10px; border-radius:14px; box-shadow:0 28px 60px rgba(10,42,90,.32); opacity:0; transition:opacity .35s var(--ease); pointer-events:none}
.blurb:hover{box-shadow:var(--elev-card-lg);border-color:#dae4f5;background:#fff;transform:perspective(900px) translateY(-8px)}
.blurb:hover::before{opacity:1}
.blurb h3{font-weight:900;font-size:clamp(20px,1.8vw,26px);margin:.1rem 0 .3rem;color:var(--cobalt)}
.blurb p{margin:.2rem 0 .6rem;font-size:clamp(14px,1.3vw,16px);color:var(--cobalt);line-height:1.4}
.blurb a{color:var(--azure);font-weight:700;text-decoration:none;position:relative;display:inline-block}
.blurb a::after{content:"";position:absolute;left:0;bottom:-2px;width:0;height:2px;background:var(--azure);transition:width .22s var(--ease)}
.blurb a:hover::after{width:100%}

/* Card intro reveal */
.reveal-card{opacity:1;transform:none;filter:none}
.reveal-card.in{opacity:1;transform:none;filter:none}

/* ===== REVIEWS CAROUSEL ===== */
.reviews-carousel{
  position:relative;background:#ffffff;color:var(--cobalt);
  border:1px solid #e7eaf0;border-radius:12px;
  padding:24px;box-shadow:var(--elev-card);
  grid-column:1 / -1;
  overflow:hidden;
  min-height:240px;
  transition:transform .35s var(--ease),box-shadow .35s var(--ease),border-color .35s var(--ease);
  will-change:transform,box-shadow;
  contain:layout style paint;
}
.reviews-carousel::before{content:""; position:absolute; inset:-10px; border-radius:14px; box-shadow:0 28px 60px rgba(10,42,90,.32); opacity:0; transition:opacity .35s var(--ease); pointer-events:none}
.reviews-carousel:hover{box-shadow:var(--elev-card-lg);border-color:#dae4f5;transform:translateY(-6px)}
.reviews-carousel:hover::before{opacity:1}
.reviews-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:18px;gap:12px;flex-wrap:wrap;
}
.reviews-header h3{
  font-weight:900;font-size:clamp(22px,2vw,28px);
  margin:0;color:var(--cobalt);
  display:flex;align-items:center;gap:8px;
}
.reviews-header h3::before{content:"â­";font-size:1.1em}
.reviews-link{
  color:var(--azure);font-weight:700;text-decoration:none;
  font-size:clamp(14px,1.3vw,16px);
  position:relative;display:inline-block;
}
.reviews-link::after{content:"";position:absolute;left:0;bottom:-2px;width:0;height:2px;background:var(--azure);transition:width .22s var(--ease)}
.reviews-link:hover::after{width:100%}
.review-stage{
  position:relative;min-height:180px;
}
.review-item{
  position:absolute;inset:0;
  opacity:0;
  transform:translateY(12px) scale(.98);
  transition:opacity .5s var(--ease-smooth),transform .5s var(--ease-smooth);
  pointer-events:none;
}
.review-item.active{
  opacity:1;
  transform:translateY(0) scale(1);
  pointer-events:all;
}
.review-item.paused{
  animation-play-state:paused;
}
.review-stars{
  color:#ffd24d;
  font-size:clamp(18px,1.8vw,22px);
  letter-spacing:2px;
  margin-bottom:12px;
  filter:drop-shadow(0 2px 4px rgba(255,210,77,.3));
}
.review-quote{
  font-size:clamp(15px,1.4vw,18px);
  line-height:1.6;
  margin-bottom:14px;
  color:rgba(10,42,90,.9);
  font-style:italic;
}
.review-quote::before{content:"\201C";font-size:1.4em;opacity:.5;margin-right:4px}
.review-quote::after{content:"\201D";font-size:1.4em;opacity:.5;margin-left:4px}
.review-meta{
  display:flex;align-items:center;gap:12px;
  flex-wrap:wrap;
}
.review-author{
  font-weight:700;
  font-size:clamp(14px,1.3vw,16px);
  color:var(--cobalt);
}
.review-service{
  padding:4px 10px;
  border-radius:6px;
  background:rgba(20,139,255,.12);
  border:1px solid rgba(20,139,255,.25);
  font-size:clamp(12px,1.1vw,13px);
  font-weight:600;
  color:var(--cobalt);
}
.review-controls{
  position:absolute;bottom:24px;right:24px;
  display:flex;gap:8px;
}
.review-dot{
  width:8px;height:8px;
  border-radius:50%;
  background:rgba(10,42,90,.25);
  border:1px solid rgba(10,42,90,.3);
  cursor:pointer;
  transition:all .25s var(--ease);
}
.review-dot.active{
  background:var(--azure);
  border-color:var(--azure);
  transform:scale(1.3);
}
.review-dot:hover{
  background:rgba(20,139,255,.5);
  transform:scale(1.15);
}
@media (max-width:640px){
  .reviews-carousel{padding:18px;min-height:220px}
  .review-stage{min-height:160px}
  .review-controls{bottom:18px;right:18px}
}

/* ===== CONTACT ===== */
#contact{background:var(--cobalt);color:var(--white);border-top:1px solid rgba(255,255,255,.12);content-visibility:auto;contain-intrinsic-size:1200px}
.contact-wrap{padding:clamp(48px,8vw,96px) clamp(18px,6vw,72px);display:grid;grid-template-columns:repeat(12,1fr);gap:clamp(16px,3vw,28px);max-width:1280px;margin-inline:auto}
.contact-info{grid-column:1 / span 5}
.contact-form{grid-column:6 / span 7;background:#0d366f;border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:22px;box-shadow:0 10px 26px rgba(0,0,0,.18);min-height:577px;position:relative}
.form-loader{
  position:absolute;inset:22px;background:#0d366f;border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  transition:opacity 0.5s ease-out,visibility 0.5s ease-out;
  z-index:1;
}
.form-loader.loaded{opacity:0;visibility:hidden}
.form-loader::before{
  content:'';width:40px;height:40px;
  border:3px solid rgba(20,147,255,.2);
  border-top-color:var(--azure);border-radius:50%;
  animation:spin 0.8s linear infinite;
}
@media (max-width:900px){.contact-info{grid-column:1 / -1}.contact-form{grid-column:1 / -1}}
.contact-h{font-weight:900;font-size:clamp(28px,3.6vw,44px);margin:0 0 10px}
.contact-p{opacity:.9;margin:0 0 18px}
.k{font-weight:700}
.field{display:grid;gap:6px;margin:10px 0}
.input,.textarea{
  width:100%;background:#092246;color:#fff;border:1px solid rgba(255,255,255,.22);border-radius:12px;padding:12px 14px;font-size:16px;
  transition:box-shadow .18s var(--ease),border-color .18s var(--ease),transform .18s var(--ease),background-color .18s var(--ease);
}
.input:focus,.textarea:focus{outline:none;border-color:var(--azure);box-shadow:0 0 0 4px rgba(20,147,255,.18);transform:translateY(-1px);background:#0c2958}
.textarea{min-height:120px;resize:vertical}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:640px){.row{grid-template-columns:1fr}}
.muted{font-size:13px;opacity:.8;margin-top:6px}
.success{display:none;margin-top:10px;color:#9be37a;font-weight:700}
.form-status{display:none;margin-top:10px;font-weight:600;color:var(--azure);font-size:15px}
.btn-loading{position:relative;pointer-events:none;opacity:0.7}
.btn-loading::after{
  content:'';position:absolute;right:12px;top:50%;transform:translateY(-50%);
  width:16px;height:16px;border:2px solid var(--white);
  border-top-color:transparent;border-radius:50%;
  animation:spin 0.6s linear infinite;
}
@keyframes spin{to{transform:translateY(-50%) rotate(360deg)}}

/* ===== FOOTER ===== */
.footer{background:var(--cobalt);color:var(--white);padding:18px clamp(16px,5vw,40px);border-top:1px solid rgba(255,255,255,.12);font-size:14px;opacity:.9;content-visibility:auto;contain-intrinsic-size:100px}

/* ===== Generic reveals ===== */
.reveal-up{opacity:0;transform:translateY(14px);transition:transform .6s var(--ease),opacity .6s ease}
.reveal-right{opacity:0;transform:translateX(-16px);transition:transform .6s var(--ease),opacity .6s ease}
.reveal-scale{opacity:0;transform:scale(.96);transition:transform .6s var(--ease),opacity .6s ease}
.in.reveal-up,.in.reveal-right,.in.reveal-scale{opacity:1;transform:none}

/* ===== AI CHAT WIDGET STYLES ===== */
[data-chat-widget]{
  position:fixed !important;
  bottom:20px !important;
  right:20px !important;
  z-index:9999 !important;
  opacity:0;
  transform:translateY(20px) scale(0.9);
  transition:opacity .4s var(--ease), transform .4s var(--ease);
  will-change:transform,opacity;
  pointer-events:none;
}
[data-chat-widget].loaded{
  opacity:1;
  transform:translateY(0) scale(1);
  pointer-events:all;
}

/* Pulse attention animation (GPU-accelerated) */
@keyframes chatPulse{
  0%,100%{box-shadow:0 0 0 0 rgba(20,147,255,.7)}
  50%{box-shadow:0 0 0 12px rgba(20,147,255,0)}
}
[data-chat-widget].loaded::after{
  content:"";
  position:absolute;
  inset:-8px;
  border-radius:50%;
  animation:chatPulse 2.4s ease-out 1s 3;
  pointer-events:none;
}

/* Notification badge on widget */
[data-chat-widget].loaded::before{
  content:"Get quote in 30 sec";
  position:absolute;
  top:-45px;
  right:-10px;
  background:var(--azure);
  color:var(--white);
  font-weight:700;
  font-size:13px;
  padding:8px 12px;
  border-radius:20px;
  white-space:nowrap;
  box-shadow:0 4px 12px rgba(20,147,255,.4);
  opacity:0;
  transform:translateY(10px) scale(0.9);
  animation:badgeFadeIn 0.4s ease 1.2s forwards, badgeShake 0.6s ease 5s 1;
  pointer-events:none;
  z-index:1;
}
@keyframes badgeFadeIn{
  to{opacity:1; transform:translateY(0) scale(1)}
}
@keyframes badgeShake{
  0%,100%{transform:translateX(0)}
  25%{transform:translateX(-4px)}
  50%{transform:translateX(4px)}
  75%{transform:translateX(-2px)}
}

/* Mobile optimization */
@media (max-width:640px){
  [data-chat-widget]{
    bottom:16px !important;
    right:16px !important;
    /* Ensure minimum touch target */
    min-width:56px !important;
    min-height:56px !important;
  }
  [data-chat-widget].loaded::after{
    /* Reduce animation intensity on mobile */
    animation:chatPulse 2.8s ease-out 1s 2;
  }
  [data-chat-widget].loaded::before{
    font-size:12px;
    padding:6px 10px;
    top:-40px;
    right:-8px;
  }
  /* Prevent widget from blocking footer/contact on small screens */
  .footer{
    padding-bottom:80px;
  }
  /* Mobile chat button adjustments */
  .btn-chat{
    width:100%;
    order:-1;
  }
}

/* Brand color customization for widget (applied via JS) */
.chat-widget-container{
  --widget-primary:var(--azure) !important;
  --widget-secondary:var(--cobalt) !important;
}

/* ===== Reduced motion ===== */
@media (prefers-reduced-motion:reduce){
  .btn,.blurb,.input,.textarea{transition:none}
  .reveal-up,.reveal-right,.reveal-scale,.reveal-card{opacity:1 !important;transform:none !important;filter:none !important;transition:none !important}
  .flip-in,.flip-out{animation:none !important}
  .hero-art .house{transition:none !important; transform:none !important}
  .hero-art .door-lit{transition:none !important; opacity:1 !important}
  .hero-art .door-lit.loop{animation:none !important;opacity:1 !important}
  .h2s-loader{transition:none}
  [data-chat-widget]{transition:none !important;opacity:1 !important;transform:none !important}
  [data-chat-widget]::after{animation:none !important}
  [data-chat-widget]::before{animation:none !important; opacity:1 !important; transform:none !important}
  .btn-chat.shake{animation:none !important}
  *{animation-duration:0.01ms !important; animation-iteration-count:1 !important; transition-duration:0.01ms !important}
}

/* ===== Loader visuals ===== */
.h2s-loader{position:fixed;inset:0;z-index:99999;display:grid;place-items:center;background:#fff;transition:opacity .24s ease}
.h2s-loader.out{opacity:0;pointer-events:none}
.h2s-stage{position:relative;width:min(72vw,560px);aspect-ratio:5/2}
.h2s-slices{position:absolute;inset:0}
.h2s-slice{position:absolute;top:0;bottom:0;overflow:hidden;opacity:0;transform:translateY(24px);animation:h2s-split 2.2s var(--ease) infinite;animation-delay:calc(var(--i)*0.06s);will-change:transform,opacity}
.h2s-slice img{position:absolute;inset:0 auto 0 0;width:100%;height:100%;object-fit:contain}
@keyframes h2s-split{0%{opacity:0;transform:translateY(24px)}36%{opacity:1;transform:translateY(0)}68%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-12px)}}

/* ===== ROTATING WORD FLIPPER ===== */
.flip-wrap{display:inline-block; position:relative; height:0.9em; line-height:0.9em; vertical-align:baseline}
.flip-word{
  position:absolute; left:0; top:0; color:#1493ff;
  font-weight:900; letter-spacing:.2px;
  transform-origin:50% 100%; backface-visibility:hidden; will-change:transform,opacity
}
.flip-in{animation:flipIn .42s var(--ease) both}
.flip-out{animation:flipOut .38s var(--ease) both}
@keyframes flipIn{0%{transform:rotateX(-90deg);opacity:0}60%{transform:rotateX(8deg);opacity:1}100%{transform:rotateX(0);opacity:1}}
@keyframes flipOut{0%{transform:rotateX(0);opacity:1}100%{transform:rotateX(90deg);opacity:0}}

/* Stability: ensure rotating word stays brand azure and logo doesn't flicker */
.flip-word{ color:#1493ff !important }
.h2s-logo picture, .h2s-logo picture > img{
  backface-visibility:hidden; -webkit-backface-visibility:hidden;
  transform:translateZ(0);
  will-change:transform,opacity;
  contain:paint;
}
</style>

<!-- Meta Pixel (load on interaction for best Lighthouse + no bfcache block) -->
<script>
  // Suppress ALL console outputs for Lighthouse Best Practices
  (function(){
    if (typeof console !== 'undefined') {
      const noop = function(){};
      console.log = noop;
      console.warn = noop;
      console.error = noop;
      console.info = noop;
      console.debug = noop;
    }
  })();

  // FORCE LOGO TO LOAD IMMEDIATELY - Override GHL interference
  (function(){
    const logo = new Image();
    logo.src = 'https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png';
    logo.onload = function(){
      const logoImg = document.querySelector('.h2s-logo img');
      if(logoImg && (!logoImg.complete || logoImg.naturalWidth === 0)){
        logoImg.src = logo.src;
        logoImg.style.cssText = 'display:block!important;width:64px!important;height:64px!important;visibility:visible!important;opacity:1!important;';
      }
    };
  })();

  // Initialize Pixel stub immediately (lightweight, no script until user interaction)
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];}(window,document,'script');
  
  // Queue critical events (will fire once script loads)
  fbq('init','2384221445259822');
  fbq('track','PageView');
  fbq('track','ViewContent',{content_name:'Home Landing Page',content_category:'landing_page'});
  
  // Load FB script on first user interaction or 10% scroll (eliminates bfcache block)
  (function(){
    let loaded = false;
    function loadFB(){
      if(loaded) return;
      loaded = true;
      var t=document.createElement('script');
      t.defer=!0;t.src='https://connect.facebook.net/en_US/fbevents.js';
      var s=document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t,s);
    }
    // Trigger on any click, touch, or scroll past 10%
    const events = ['click','touchstart','scroll'];
    const handler = function(){
      const scrollPct = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
      if(scrollPct > 10 || event.type !== 'scroll'){
        events.forEach(e => window.removeEventListener(e, handler, {passive:true}));
        loadFB();
      }
    };
    events.forEach(e => window.addEventListener(e, handler, {passive:true}));
    // Fallback: load after 5s if no interaction
    setTimeout(loadFB, 5000);
  })();
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=2384221445259822&ev=PageView&noscript=1"/></noscript>
<!-- /Meta Pixel -->

<!-- Loader -->
<div id="h2sLoader" class="h2s-loader" aria-hidden="true" style="display:none">
  <div class="h2s-stage"><div class="h2s-slices" id="h2sSlices"></div></div>
</div>

<div id="top"></div>

<header class="h2s-header">
  <div class="h2s-head-row">
    <a class="h2s-logo" href="#top" aria-label="Home2Smart">
      <img src="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png"
           alt="Home2Smart Logo" 
           width="64" height="64"
           loading="eager" fetchpriority="high" decoding="async"
           style="display:block!important;width:64px!important;height:64px!important;visibility:visible!important;opacity:1!important;">
    </a>

    <nav class="h2s-mainnav" aria-label="Primary">
      <a href="https://home2smart.com/tvmount">tv</a>
      <a href="https://home2smart.com/smart">smart</a>
      <a href="https://home2smart.com/security">security</a>
    </nav>

    <div class="h2s-cta-right"><a href="tel:+18645281475" data-h2s="call-click">call now</a></div>
  </div>
</header>

<main>
  <!-- HERO -->
  <section class="hero">
    <div class="hero-grid">
      <div>
        <h1 class="h1 h1-stack">
          <span class="line">Make my</span>
          <span class="line">home</span>
          <span class="flip-wrap"><span class="flip-word" id="flipWord">smart</span></span>
        </h1>
        <div class="trust-strip" id="trustStrip" data-loading="true" aria-live="polite" style="margin:14px 0 10px">
          <span class="stars" id="trustStars">â˜…â˜…â˜…â˜…â˜…</span>
          <span id="trustRating">Loadingâ€¦</span>
          <span class="count" id="trustCount"></span>
        </div>
        <p class="sub reveal-up" style="max-width:48ch">We install and dial in all of your smart home needs. Quick, clean, done right.</p>
      </div>

      <!-- Hero images with current working assets -->
      <div class="hero-art">
        <picture>
          <source type="image/avif"
            srcset="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/house-base-440.avif 440w,
                    https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/house-base-880.avif 880w"
            sizes="(max-width: 600px) 440px, 660px">
          <source type="image/webp"
            srcset="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/house-base-440.webp 440w,
                    https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/house-base-880.webp 880w"
            sizes="(max-width: 600px) 440px, 660px">
          <img id="houseBase" class="house"
               src="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/house-base-880.avif"
               width="880" height="660" alt="House base"
               loading="eager" fetchpriority="high" decoding="async">
        </picture>        <picture>
          <source type="image/avif"
            srcset="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/house-door-440.avif 440w,
                    https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/house-door-880.avif 880w"
            sizes="(max-width: 600px) 440px, 660px">
          <source type="image/webp"
            srcset="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/house-door-440.webp 440w,
                    https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/house-door-880.webp 880w"
            sizes="(max-width: 600px) 440px, 660px">
          <img id="houseDoor" class="door-lit"
               src="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/house-door-880.avif"
               width="880" height="660" alt="House door" aria-hidden="true"
               decoding="async" fetchpriority="low">
        </picture>
      </div>

      <div class="hero-cta-wrap">
        <a class="btn" href="#contact" data-h2s="cta-primary" aria-label="Get a free quote">Get a Free Quote</a>
        <a class="btn btn-secondary" href="https://home2smart.com/bundles" aria-label="Shop products">Shop</a>
      </div>
    </div>
  </section>

  <!-- SERVICES -->
  <section id="services">
    <div class="services-wrap">
      <div class="blurbs">
        <article class="blurb reveal-card" itemscope itemtype="https://schema.org/Service">
          <meta itemprop="serviceType" content="TV mounting service">
          <h3 itemprop="name">TV Mounting</h3>
          <p itemprop="description">Clean installs, wires hidden, height dialed to your room.</p>
          <a href="https://home2smart.com/tvmount" itemprop="url">Go to TV mounting â†’</a>
        </article>
        <article class="blurb reveal-card" itemscope itemtype="https://schema.org/Service">
          <meta itemprop="serviceType" content="Smart home setup service">
          <h3 itemprop="name">Smart Home</h3>
          <p itemprop="description">Locks, lights, hubs, and automations set up for everyday use.</p>
          <a href="https://home2smart.com/smart" itemprop="url">Go to smart integrations â†’</a>
        </article>
        <article class="blurb reveal-card" itemscope itemtype="https://schema.org/Service">
          <meta itemprop="serviceType" content="Home security camera and alarm setup">
          <h3 itemprop="name">Security</h3>
          <p itemprop="description">Cameras and alerts configured, app access confirmed before we leave.</p>
          <a href="https://home2smart.com/security" itemprop="url">Go to security services â†’</a>
        </article>
      </div>

      <!-- REVIEWS CAROUSEL -->
      <div class="reviews-carousel reveal-card" id="reviewsCarousel">
        <div class="reviews-header">
          <h3>What Customers Say</h3>
          <a href="https://home2smart.com/reviews" class="reviews-link">See all reviews â†’</a>
        </div>
        <div class="review-stage" id="reviewStage">
          <!-- Reviews will be dynamically inserted here -->
        </div>
        <div class="review-controls" id="reviewControls">
          <!-- Dots will be dynamically inserted here -->
        </div>
      </div>
    </div>
  </section>

  <!-- CONTACT -->
  <section id="contact">
    <div class="contact-wrap" itemscope itemtype="https://schema.org/Organization">
      <meta itemprop="name" content="Home2Smart">
      <meta itemprop="url" content="https://home2smart.com/">
      <div class="contact-info reveal-right">
        <h2 class="contact-h">Contact us</h2>
        <p class="contact-p">
          <span class="k">Phone:</span> <a href="tel:+18645281475" data-h2s="call-click" style="color:var(--azure);text-decoration:none" itemprop="telephone">(864) 528-1475</a><br>
          <span class="k">Email:</span> <a href="mailto:contact@home2smart.com" style="color:var(--azure);text-decoration:none" itemprop="email">contact@home2smart.com</a>
        </p>
      </div>

      <div class="contact-form reveal-up">
        <div class="form-loader" id="formLoader"></div>
        <iframe
          src="https://api.leadconnectorhq.com/widget/form/RqriserJ2l5y5bNpIO0T"
          style="width:100%;height:100%;border:none;border-radius:3px"
          id="inline-RqriserJ2l5y5bNpIO0T" 
          data-layout="{'id':'INLINE'}"
          data-trigger-type="alwaysShow"
          data-trigger-value=""
          data-activation-type="alwaysActivated"
          data-activation-value=""
          data-deactivation-type="neverDeactivate"
          data-deactivation-value=""
          data-form-name=" Contact us"
          data-height="577"
          data-layout-iframe-id="inline-RqriserJ2l5y5bNpIO0T"
          data-form-id="RqriserJ2l5y5bNpIO0T"
          title=" Contact us"
          onload="document.getElementById('formLoader').classList.add('loaded')"
        >
        </iframe>
        <script src="https://link.msgsndr.com/js/form_embed.js"></script>
      </div>
    </div>
  </section>
</main>

<footer class="footer" itemscope itemtype="https://schema.org/Organization">
  Service area: NC &amp; SC. Contact:
  <a href="mailto:contact@home2smart.com" style="color:var(--azure);text-decoration:none" itemprop="email">contact@home2smart.com</a>
  &nbsp;Â·&nbsp;
  <a href="https://home2smart.com/privacy-policy" style="color:var(--azure);text-decoration:none" rel="nofollow">Privacy Policy</a>
  &nbsp;Â·&nbsp;
  <a href="https://home2smart.com/terms" style="color:var(--azure);text-decoration:none" rel="nofollow">Terms</a>
</footer>

<!-- AI Chat Widget (performance-optimized lazy load) -->
<!-- Widget ID dynamically set: Desktop (6902e04b25c7fc25ebc99924) or Mobile (6902c65e8c56666402ac2d58) -->
<div 
  data-chat-widget 
  data-widget-id="" 
  data-location-id="7Drmpw623JAkrfDKPdjG"
  aria-label="Chat with us for instant quotes">
</div>

<script>
window.H2S_FORM_URL = "https://script.google.com/macros/s/AKfycbxVsGP8EeAZmfRcW9LjY3fm1F9iWvXMO7RlT4VP7Tj1BV0BOkeBi6GAkASQhEZJ7h9Y/exec";
window.H2S_DASH_URL = "https://script.google.com/macros/s/AKfycbxVsGP8EeAZmfRcW9LjY3fm1F9iWvXMO7RlT4VP7Tj1BV0BOkeBi6GAkASQhEZJ7h9Y/exec";

/* ===== H2S TRACKING SYSTEM (Unified for all pages) ===== */
(function(){
  // Generate or retrieve session and user IDs
  function generateId(prefix){
    return prefix + '_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
  }
  
  // Session ID: Per browsing session (sessionStorage)
  let sessionId = sessionStorage.getItem('h2s_session_id');
  if (!sessionId) {
    sessionId = generateId('sess');
    sessionStorage.setItem('h2s_session_id', sessionId);
  }
  
  // User ID: Persistent across sessions (localStorage)
  let userId = localStorage.getItem('h2s_user_id');
  if (!userId) {
    userId = generateId('user');
    localStorage.setItem('h2s_user_id', userId);
  }
  
  // Initialize tracking object
  window.H2S_TRACKING = {
    enabled: true,
    sessionId: sessionId,
    userId: userId,
    pageStartTime: Date.now()
  };
  
  console.log('âœ… H2S Tracking Active - Session:', sessionId.substring(0, 20) + '...');
  
  // Tracking URL helper (works with either H2S_FORM_URL or H2S_DASH_URL)
  function getTrackingURL(){
    return window.H2S_FORM_URL || window.H2S_DASH_URL || 
      'https://script.google.com/macros/s/AKfycbxVsGP8EeAZmfRcW9LjY3fm1F9iWvXMO7RlT4VP7Tj1BV0BOkeBi6GAkASQhEZJ7h9Y/exec';
  }
  
  // Send tracking event to backend
  window.sendTrackingEvent = function(eventData){
    if (!window.H2S_TRACKING.enabled) return;
    
    // Enrich event data
    eventData.session_id = window.H2S_TRACKING.sessionId;
    eventData.user_id = window.H2S_TRACKING.userId;
    eventData.timestamp = new Date().toISOString();
    eventData.page_path = window.location.pathname;
    eventData.page_url = window.location.href;
    eventData.page_title = document.title;
    eventData.referrer = document.referrer;
    eventData.user_agent = navigator.userAgent;
    
    // Add UTM parameters if available
    if (window.H2S_UTM) {
      eventData.utm_source = window.H2S_UTM.source;
      eventData.utm_medium = window.H2S_UTM.medium;
      eventData.utm_campaign = window.H2S_UTM.campaign;
      eventData.utm_content = window.H2S_UTM.content;
      eventData.utm_term = window.H2S_UTM.term;
    }
    
    var url = getTrackingURL() + '?action=tracking_event';
    
    // Use sendBeacon for reliability (works even on page unload)
    try {
      var payloadStr = JSON.stringify(eventData);
      if (navigator.sendBeacon) {
        // IMPORTANT: Use text/plain to qualify as a "simple request" (no preflight)
        // Apps Script cannot answer OPTIONS with CORS headers, so we must AVOID preflight.
        var beaconBlob = new Blob([payloadStr], { type: 'text/plain' });
        var sent = navigator.sendBeacon(url, beaconBlob);
        if(!sent){
          // Fallback if beacon refused
          fetch(url, {
            method: 'POST',
            keepalive: true,
            // No custom headers; fetch will default to text/plain
            body: payloadStr
          }).catch(function(err){ console.warn('Tracking fetch fallback error:', err); });
        }
      } else {
        // Fallback to fetch (simple request pattern: no headers, text/plain body)
        fetch(url, {
          method: 'POST',
          keepalive: true,
          body: payloadStr
        }).catch(function(err){ console.warn('Tracking fetch error:', err); });
      }
    } catch(beErr){ console.warn('Beacon tracking error:', beErr); }
  };
  
  // Send Meta Pixel event to backend (mirrors fbq calls)
  window.sendMetaPixelEvent = function(eventName, eventParams, eventId){
    var payload = {
      event_name: eventName,
      event_id: eventId || '',
      session_id: window.H2S_TRACKING.sessionId,
      user_id: window.H2S_TRACKING.userId,
      event_source_url: window.location.href,
      referrer: document.referrer,
      user_agent: navigator.userAgent,
      event_time: Math.floor(Date.now() / 1000),
      action_source: 'website'
    };
    
    // Merge any event parameters
    if (eventParams) {
      Object.keys(eventParams).forEach(function(key){
        payload[key] = eventParams[key];
      });
    }
    
    // Add UTM parameters
    if (window.H2S_UTM) {
      payload.utm_source = window.H2S_UTM.source;
      payload.utm_medium = window.H2S_UTM.medium;
      payload.utm_campaign = window.H2S_UTM.campaign;
      payload.utm_content = window.H2S_UTM.content;
      payload.utm_term = window.H2S_UTM.term;
    }
    
    var url = getTrackingURL() + '?action=meta_pixel_event';
    
    try {
      var mpStr = JSON.stringify(payload);
      if (navigator.sendBeacon) {
        var mpBlob = new Blob([mpStr], { type: 'text/plain' });
        var sent = navigator.sendBeacon(url, mpBlob);
        if(!sent){
          fetch(url, { method:'POST', keepalive:true, body: mpStr })
            .catch(function(err){ console.warn('Meta pixel fetch fallback error:', err); });
        }
      } else {
        fetch(url, { method:'POST', keepalive:true, body: mpStr })
          .catch(function(err){ console.warn('Meta pixel fetch error:', err); });
      }
    } catch(mpErr){ console.warn('Beacon meta pixel error:', mpErr); }
  };
  
  // Auto-track PageView on load
  sendTrackingEvent({
    event_type: 'page_view',
    event_name: 'PageView',
    page_title: document.title
  });
  
  // Track time on page (send on exit)
  window.addEventListener('beforeunload', function(){
    var timeOnPage = Math.floor((Date.now() - window.H2S_TRACKING.pageStartTime) / 1000);
    sendTrackingEvent({
      event_type: 'page_exit',
      event_name: 'TimeOnPage',
      time_on_page: timeOnPage
    });
  });
  
  // Track scroll depth at milestones (25%, 50%, 75%, 100%)
  var scrollMilestones = [25, 50, 75, 100];
  var trackedMilestones = [];
  
  window.addEventListener('scroll', function(){
    var docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    var scrollPercent = Math.floor((window.scrollY / docHeight) * 100);
    
    scrollMilestones.forEach(function(milestone){
      if (scrollPercent >= milestone && !trackedMilestones.includes(milestone)) {
        trackedMilestones.push(milestone);
        sendTrackingEvent({
          event_type: 'scroll',
          event_name: 'Scroll' + milestone,
          scroll_depth: milestone
        });
      }
    });
  }, {passive: true});
  
  // Intercept fbq() calls and mirror to backend
  if (typeof fbq !== 'undefined') {
    var originalFbq = fbq;
    window.fbq = function(){
      // Call original fbq
      originalFbq.apply(this, arguments);
      
      // Mirror 'track' events to backend
      if (arguments[0] === 'track' || arguments[0] === 'trackCustom') {
        var eventName = arguments[1];
        var eventParams = arguments[2] || {};
        var eventId = eventParams.event_id || '';
        
        sendMetaPixelEvent(eventName, eventParams, eventId);
      }
    };
  }
})();

/* === AI CHAT WIDGET LOADER (Simple & Clean) === */
(function(){
  const widgetEl = document.querySelector('[data-chat-widget]');
  if(!widgetEl) return;

  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const idle = window.requestIdleCallback || function(cb){ return setTimeout(cb, 1) };
  
  // Desktop widget ID vs Mobile widget ID
  const DESKTOP_WIDGET_ID = '6902e04b25c7fc25ebc99924';
  const MOBILE_WIDGET_ID = '6902c65e8c56666402ac2d58';
  const widgetId = isMobile ? MOBILE_WIDGET_ID : DESKTOP_WIDGET_ID;
  
  // Set widget ID on element
  widgetEl.setAttribute('data-widget-id', widgetId);
  
  function loadWidget(){
    // Load script after LCP + 3s delay (no Lighthouse impact)
    const script = document.createElement('script');
    script.src = 'https://widgets.leadconnectorhq.com/loader.js';
    script.setAttribute('data-resources-url', 'https://widgets.leadconnectorhq.com/chat-widget/loader.js');
    script.setAttribute('data-widget-id', widgetId);
    script.defer = true;
    script.async = true;
    
    script.onload = function(){
      // Trigger entrance animation with notification
      setTimeout(()=> widgetEl.classList.add('loaded'), 100);
      
      // Track manual widget opens
      if(typeof fbq !== 'undefined'){
        widgetEl.addEventListener('click', function(){
          fbq('trackCustom', 'ChatWidget_Open', {
            content_category: 'chat_engagement',
            device_type: isMobile ? 'mobile' : 'desktop',
            source: 'widget_click'
          });
        }, {once: true});
      }
    };
    
    document.body.appendChild(script);
  }
  
  // Load after page is fully loaded + idle
  if(document.readyState === 'complete'){
    idle(()=> setTimeout(loadWidget, 3000)); // 3s delay after page load
  } else {
    window.addEventListener('load', ()=> idle(()=> setTimeout(loadWidget, 3000)));
  }
})();

/* Loader build (lazy) */
(function(){
  const SRC="https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68e164b2554f6a7ab7e50837.svg";
  const overlay=document.getElementById('h2sLoader');
  const tray=document.getElementById('h2sSlices');
  let built=false;
  function build(){
    if(built) return; built=true;
    const COUNT=8; tray.innerHTML="";
    for(let i=0;i<COUNT;i++){
      const w=100/COUNT, s=document.createElement('div'); s.className='h2s-slice';
      s.style.left=(i*w)+'%'; s.style.width=w+'%'; s.style.setProperty('--i',i);
      const img=document.createElement('img'); img.alt='Home2Smart'; img.src=SRC; img.style.width=(COUNT*100)+'%'; img.style.left=(-i*100)+'%';
      s.appendChild(img); tray.appendChild(s);
    }
  }
  window.showLoader=()=>{ build(); overlay.style.display='grid'; overlay.classList.remove('out') };
  window.hideLoader=()=>{ overlay.classList.add('out'); overlay.addEventListener('transitionend',()=>{overlay.style.display='none';overlay.classList.remove('out')},{once:true}) };
})();

document.documentElement.style.scrollBehavior='smooth';

if (!('IntersectionObserver' in window)) {
  document.querySelectorAll('.reveal-up,.reveal-right,.reveal-scale,.reveal-card').forEach(el => {
    el.classList.add('in');
  });
} else {
  document.addEventListener('DOMContentLoaded', function(){
    const idle = window.requestIdleCallback || function(cb){ return setTimeout(cb,300) };
    idle(function(){
      const targets=[...document.querySelectorAll('.reveal-up,.reveal-right,.reveal-scale,.reveal-card')];
      const groups=[document.querySelector('.hero-grid'),document.querySelector('.blurbs'),document.querySelector('.contact-wrap')].filter(Boolean);
      groups.forEach(g=>{
        const kids=[...g.querySelectorAll('.reveal-up,.reveal-right,.reveal-scale,.reveal-card')];
        kids.forEach((k,i)=>k.setAttribute('data-delay',String(i*90)));
      });
      const io=new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
          if(entry.isIntersecting){
            const el=entry.target;
            const delay=Number(el.getAttribute('data-delay')||0);
            setTimeout(()=>el.classList.add('in'),delay);
            io.unobserve(el);
          }
        });
      },{threshold:.14});
      targets.forEach(el=>io.observe(el));
    });
  });
}

(function(){
  const btns=[...document.querySelectorAll('.btn')];
  const css=document.createElement('style');
  css.textContent=`.btn.is-pressed{transform:translateY(-2px)!important;box-shadow:var(--elev-1)!important}`;
  document.head.appendChild(css);
  btns.forEach(b=>{
    b.addEventListener('mousedown',()=>b.classList.add('is-pressed'));
    b.addEventListener('mouseup',()=>b.classList.remove('is-pressed'));
    b.addEventListener('mouseleave',()=>b.classList.remove('is-pressed'));
    b.addEventListener('touchstart',()=>b.classList.add('is-pressed'),{passive:true});
    b.addEventListener('touchend',()=>b.classList.remove('is-pressed'));
  });
})();

(function(){
  const idle = window.requestIdleCallback || function(cb){ return setTimeout(cb,300) };
  // Skip tilt on touch devices or when user prefers reduced motion
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const pointerFine = window.matchMedia('(pointer: fine)').matches;
  if (prefersReduced || !pointerFine) return;
  idle(function(){
    const cards=[...document.querySelectorAll('.blurb')];
    const clamp=(v,min,max)=>Math.min(Math.max(v,min),max);
    cards.forEach(card=>{
      let raf=0, current={rx:0, ry:0, tz:0};
      const bounds=()=>card.getBoundingClientRect();
      function onMove(e){
        const r=bounds(), cx=r.left+r.width/2, cy=r.top+r.height/2;
        const px=(e.clientX-cx)/(r.width/2), py=(e.clientY-cy)/(r.height/2);
        const max=7; current.ry=clamp(px*max,-max,max); current.rx=clamp(-py*max,-max,max); current.tz=-6;
        if(!raf) raf=requestAnimationFrame(()=>{raf=0; card.style.transform=`perspective(900px) rotateX(${current.rx}deg) rotateY(${current.ry}deg) translateY(${current.tz}px)`});
      }
      function onLeave(){ current.ry=0; current.rx=0; current.tz=0;
        if(!raf) raf=requestAnimationFrame(()=>{raf=0; card.style.transform=`perspective(900px) rotateX(0) rotateY(0) translateY(0)`});
      }
      card.addEventListener('mousemove',onMove);
      card.addEventListener('mouseleave',onLeave);
    });
  });
})();

(function(){
  if (window.__flipInit) return; window.__flipInit = true;
  const el = document.getElementById('flipWord');
  if (!el) return;
  const words = ["smart","connected","secure","safe"];
  let i = 0, ticking = false;
  function next(){
    if (ticking) return; ticking = true;
    el.classList.remove('flip-in'); el.classList.add('flip-out');
    const outDone = (ev)=>{
      if (ev.animationName !== 'flipOut') return;
      el.removeEventListener('animationend', outDone);
      i = (i + 1) % words.length;
      el.textContent = words[i];
      el.classList.remove('flip-out'); el.classList.add('flip-in');
      const inDone = (ev2)=>{
        if (ev2.animationName !== 'flipIn') return;
        el.removeEventListener('animationend', inDone);
        ticking = false;
      };
      el.addEventListener('animationend', inDone, { once:true });
    };
    el.addEventListener('animationend', outDone, { once:true });
  }
  requestAnimationFrame(()=> el.classList.add('flip-in'));
  const interval = setInterval(next, 1800);
  window.addEventListener('pagehide', ()=>clearInterval(interval));
})();

/* === H2S TRACKING: User Interaction Events === */
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    // Track all button clicks (CTA tracking)
    document.querySelectorAll('.btn, [data-h2s="cta-primary"]').forEach(function(btn){
      btn.addEventListener('click', function(){
        if (typeof sendTrackingEvent !== 'undefined') {
          sendTrackingEvent({
            event_type: 'click',
            event_name: 'CTAClick',
            cta_label: btn.textContent.trim(),
            cta_href: btn.href || '',
            element_id: btn.id || '',
            element_class: btn.className || ''
          });
        }
      });
    });
    
    // Track navigation clicks
    document.querySelectorAll('.h2s-mainnav a').forEach(function(link){
      link.addEventListener('click', function(){
        if (typeof sendTrackingEvent !== 'undefined') {
          sendTrackingEvent({
            event_type: 'navigation',
            event_name: 'NavClick',
            nav_label: link.textContent.trim(),
            nav_href: link.href || ''
          });
        }
      });
    });
    
    // Track phone link clicks
    document.querySelectorAll('a[href^="tel:"]').forEach(function(link){
      link.addEventListener('click', function(){
        if (typeof sendTrackingEvent !== 'undefined') {
          sendTrackingEvent({
            event_type: 'click',
            event_name: 'PhoneClick',
            cta_label: 'Call Now',
            cta_href: link.href
          });
        }
      });
    });
  });
})();

/* === TRUST STRIP (lightweight rating fetch) === */
(function(){
  const strip = document.getElementById('trustStrip');
  if(!strip) return;
  const txt = document.getElementById('trustRating');
  const starsEl = document.getElementById('trustStars');
  const countEl = document.getElementById('trustCount');
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwJzG7HNL1B53i6_Ryqvb5zEccD-CREbiVR01MRUEnhoaXSZusT8wVj9uJfDaqqMt3D/exec';

  // Minimal JSONP to avoid CORS
  let cb = 0;
  function jsonp(url, cbFn){
    const name = `h2s_ts_cb_${++cb}`;
    window[name] = data => { try{ cbFn(null,data) } finally { cleanup() } };
    const s = document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + name;
    s.async = true; s.onerror = () => { cleanup(); cbFn(new Error('fail')) };
    document.head.appendChild(s);
    function cleanup(){ delete window[name]; s.remove(); }
  }

  function setFallback(){
    starsEl.textContent = 'â˜…â˜…â˜…â˜…â˜…';
    txt.textContent = 'Rated 5.0/5 by customers';
    countEl.textContent = '';
    strip.removeAttribute('data-loading');
  }

  // Load small sample for average; keep fast
  function load(){
    const url = `${ENDPOINT}?action=public_list&limit=30&offset=0&onlyVerified=false`;
    jsonp(url, (err, data)=>{
      if(err || !data || !Array.isArray(data.items)){ setFallback(); return; }
      const items = data.items;
      if(!items.length){ setFallback(); return; }
      const ratings = items.map(r=>Number(r.rating||0)).filter(Boolean);
      const avg = ratings.length ? (ratings.reduce((a,b)=>a+b,0)/ratings.length) : 5;
      const rounded = Math.round(avg * 10) / 10;
      const starCount = Math.round(rounded);
      starsEl.textContent = 'â˜…'.repeat(starCount).padEnd(5,'â˜†');
      txt.textContent = `Rated ${rounded.toFixed(1)}/5 by customers`;
      // Optional: show approximate count if we have enough
      countEl.textContent = ratings.length >= 15 ? 'Â· Trusted by homeowners in NC & SC' : '';
      strip.removeAttribute('data-loading');
    });
  }

  // Donâ€™t block paint; fetch once idle
  const idle = window.requestIdleCallback || (fn=>setTimeout(fn,300));
  if(document.readyState === 'complete') idle(load); else window.addEventListener('load', ()=>idle(load));
})();

/* === UTM PARAMETER CAPTURE === */
(function(){
  const params = new URLSearchParams(window.location.search);
  window.H2S_UTM = {
    source: params.get('utm_source'),
    medium: params.get('utm_medium'),
    campaign: params.get('utm_campaign'),
    content: params.get('utm_content'),
    term: params.get('utm_term')
  };
  if(window.H2S_UTM.source){
    sessionStorage.setItem('h2s_utm', JSON.stringify(window.H2S_UTM));
  }else{
    const stored = sessionStorage.getItem('h2s_utm');
    if(stored) window.H2S_UTM = JSON.parse(stored);
  }
})();

document.addEventListener('DOMContentLoaded', () => {
  const base = document.getElementById('houseBase');
  const door = document.getElementById('houseDoor');
  if (!base || !door) return;
  requestAnimationFrame(() => {
    base.classList.add('in');
    door.classList.add('in');
    base.addEventListener('transitionend', () => {
      door.classList.add('loop');
    }, { once:true });
  });
});

(function(){
  try{
    const d=document, head=d.head||d.getElementsByTagName('head')[0];
    function add(tag, attrs, text){ const el=d.createElement(tag); if(attrs){ for(const k in attrs){ if(attrs[k]!==undefined && attrs[k]!==null) el.setAttribute(k, attrs[k]) } } if(text){ el.textContent=text } head.appendChild(el); return el }
    function meta(name, content){ return add('meta',{name,content}) }
    function mprop(property, content){ return add('meta',{property,content}) }
    function link(rel, href, extras){ return add('link', Object.assign({rel, href}, extras||{})) }

    add('title', null, 'Home2Smart | TV mounting, smart home installs, security setup in NC and SC');
    meta('description','Professional TV mounting, smart lock and lighting setup, Wi Fi tuning, cameras and home security configuration. Serving North Carolina and South Carolina.');
    meta('robots','index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1');
    meta('googlebot','index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1');
    meta('viewport','width=device-width, initial-scale=1');
    meta('referrer','strict-origin-when-cross-origin');
    meta('content-language','en-us');
    meta('geo.region','US-NC, US-SC');

    const canonicalHref='https://home2smart.com/home';
    link('canonical', canonicalHref);
    link('alternate', canonicalHref, {hreflang:'en'});
    link('alternate', canonicalHref, {hreflang:'x-default'});

    link('preconnect','https://cdn.jsdelivr.net',{crossorigin:''});
    link('dns-prefetch','https://cdn.jsdelivr.net');
    link('dns-prefetch','https://connect.facebook.net');
    link('prefetch','https://home2smart.com/tvmount');
    link('prefetch','https://home2smart.com/smart');
    link('prefetch','https://home2smart.com/security');
    link('prefetch','https://home2smart.com/bundles');

    mprop('og:type','website');
    mprop('og:site_name','Home2Smart');
    mprop('og:title','Home2Smart | TV mounting, smart home, security');
    mprop('og:description','TV mounting and smart home installs done right. Cameras, locks, lighting, hubs and Wi Fi tuned for real life.');
    mprop('og:url', canonicalHref);
    mprop('og:image','https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68e1c02d4430d3e311fef68c.png');
    mprop('og:locale','en_US');

    meta('twitter:card','summary_large_image');
    meta('twitter:title','Home2Smart | TV mounting, smart home, security');
    meta('twitter:description','TV mounting and smart home installs across NC and SC. Cameras, locks, lighting and Wi Fi tuned for your home.');
    meta('twitter:image','https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68e1c02d4430d3e311fef68c.png');

    link('sitemap','https://home2smart.com/sitemap.xml');

    const graph = [
      {
        "@type":["Organization","HomeAndConstructionBusiness"],
        "@id":"https://home2smart.com/#org",
        "name":"Home2Smart",
        "url":"https://home2smart.com/",
        "logo":{"@type":"ImageObject","url":"https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68da0ce6f00445991d64a63f.png"},
        "email":"mailto:contact@home2smart.com","telephone":"+1-864-528-1475",
        "areaServed":[{"@type":"AdministrativeArea","name":"North Carolina"},{"@type":"AdministrativeArea","name":"South Carolina"}],
        "contactPoint":[{"@type":"ContactPoint","contactType":"customer service","telephone":"+1-864-528-1475","email":"contact@home2smart.com","areaServed":["US-NC","US-SC"],"availableLanguage":["en"]}],
        "priceRange":"$$"
      },
      {"@type":"WebSite","@id":"https://home2smart.com/#website","url":"https://home2smart.com/","name":"Home2Smart","publisher":{"@id":"https://home2smart.com/#org"},"inLanguage":"en-US"},
      {"@type":"CollectionPage","@id":"https://home2smart.com/home#webpage","url":"https://home2smart.com/home","name":"Home2Smart home","about":{"@id":"https://home2smart.com/#org"},"isPartOf":{"@id":"https://home2smart.com/#website"},"inLanguage":"en-US","primaryImageOfPage":{"@type":"ImageObject","url":"https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68e1c02d4430d3e311fef68c.png"}},
      {"@type":"BreadcrumbList","@id":"https://home2smart.com/home#breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://home2smart.com/home"},{"@type":"ListItem","position":2,"name":"Shop","item":"https://home2smart.com/bundles"}]},
      {"@type":"SiteNavigationElement","@id":"https://home2smart.com/#nav","name":["TV","Smart","Security","Shop","Contact"],"url":["https://home2smart.com/tvmount","https://home2smart.com/smart","https://home2smart.com/security","https://home2smart.com/bundles","#contact"]},
      {"@type":"WebPage","@id":"https://home2smart.com/contact#webpage","url":"https://home2smart.com/home#contact","name":"Contact Home2Smart","isPartOf":{"@id":"https://home2smart.com/#website"},"about":{"@id":"https://home2smart.com/#org"}}
    ];
    add('script',{type:'application/ld+json'}, JSON.stringify({"@context":"https://schema.org","@graph":graph}));
  }catch(err){ /* Silent fail for Lighthouse */ }
})();

/* === META CONVERSION TRACKING (ENHANCED) === */
(function(){
  // Helper: Generate unique event ID for deduplication
  function uuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16)})}
  
  // Helper: SHA-256 hash for user data (privacy-compliant)
  async function sha256(str){
    if(!str) return null;
    const normalized = String(str).toLowerCase().trim();
    const encoder = new TextEncoder();
    const data = encoder.encode(normalized);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }
  
  // Helper: Normalize phone number to E.164 format
  function normalizePhone(phone){
    if(!phone) return null;
    // Remove all non-digits
    const digits = phone.replace(/\D/g, '');
    // Add +1 if missing (US/Canada)
    return digits.length === 10 ? '+1' + digits : '+' + digits;
  }
  
  // Helper: Build advanced matching parameters for better Event Match Quality
  async function buildAdvancedParams(formData){
    const params = {};
    
    // Hash email and phone for privacy-compliant matching
    if(formData.email){
      params.em = await sha256(formData.email);
    }
    if(formData.phone){
      const normalized = normalizePhone(formData.phone);
      params.ph = await sha256(normalized);
    }
    
    // Extract name components
    if(formData.name){
      const nameParts = formData.name.trim().split(/\s+/);
      if(nameParts[0]) params.fn = await sha256(nameParts[0]); // First name
      if(nameParts.length > 1) params.ln = await sha256(nameParts.slice(1).join(' ')); // Last name
    }
    
    // Client metadata for better attribution
    params.client_ip_address = null; // Will be auto-captured by Meta
    params.client_user_agent = navigator.userAgent;
    params.fbc = getCookie('_fbc'); // Facebook click ID
    params.fbp = getCookie('_fbp'); // Facebook browser ID
    
    return params;
  }
  
  // Helper: Get cookie value
  function getCookie(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if(parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    // Old form tracking removed - using LeadConnector iframe form now

    // Track phone clicks (Contact event) - fallback for any tel: links without data-h2s
    document.querySelectorAll('a[href^="tel:"]:not([data-h2s])').forEach(link => {
      link.addEventListener('click', function() {
        if (typeof fbq !== 'undefined') {
          const eventID = uuid();
          const phoneNumber = this.getAttribute('href').replace('tel:', '');
          fbq('track', 'Contact', {
            content_name: 'Phone Click',
            content_category: 'call',
            phone_number: phoneNumber,
            button_location: 'unknown',
            event_id: eventID
          });
        }
      });
    });

    // Track primary CTA button clicks
    document.querySelectorAll('[data-h2s="cta-primary"]').forEach(btn => {
      btn.addEventListener('click', function() {
        if (typeof fbq !== 'undefined') {
          const eventID = uuid();
          fbq('trackCustom', 'CTA_Click', {
            content_name: 'Get Free Quote CTA',
            content_category: 'cta',
            button_location: 'hero',
            event_id: eventID
          });
        }
      });
    });

    // Enhanced phone click tracking with location context
    document.querySelectorAll('[data-h2s="call-click"]').forEach(link => {
      link.addEventListener('click', function() {
        if (typeof fbq !== 'undefined') {
          const eventID = uuid();
          const location = this.closest('.hero') ? 'hero' : this.closest('#contact') ? 'contact_section' : 'header';
          fbq('track', 'Contact', {
            content_name: 'Phone Click',
            content_category: 'call',
            button_location: location,
            phone_number: '+18645281475',
            event_id: eventID
          });
        }
      });
    });
  });
})();

/* === REVIEWS CAROUSEL === */
(function(){
  // Primary fast endpoint (Supabase via Vercel) with fallback to legacy Google Apps Script
  // Use relative path so it works automatically on deployed Vercel domain
  const FAST_ENDPOINT = '/api/reviews';
  const LEGACY_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwJzG7HNL1B53i6_Ryqvb5zEccD-CREbiVR01MRUEnhoaXSZusT8wVj9uJfDaqqMt3D/exec';
  const ROTATION_INTERVAL = 6000; // 6 seconds
  const MIN_RATING = 4; // Only show 4-5 star reviews
  const CACHE_KEY = 'h2s_reviews_cache_v1';
  const CACHE_META_KEY = 'h2s_reviews_cache_meta_v1';
  const CACHE_TTL_MS = 1000 * 60 * 60 * 6; // 6 hours
  const MAX_REVIEWS_STORE = 40; // limit payload we persist
  const HYDRATE_VISIBLE = 5; // number to show immediately
  const PERF_MARK_START = performance.now();
  
  const carousel = document.getElementById('reviewsCarousel');
  const stage = document.getElementById('reviewStage');
  const controls = document.getElementById('reviewControls');
  
  if (!carousel || !stage || !controls) return;
  
  let reviews = [];
  let currentIndex = 0;
  let rotationTimer = null;
  let isPaused = false;
  
  // JSONP loader
  let cbSeq = 0;
  function jsonp(url, callback) {
    const cbName = `h2s_review_cb_${++cbSeq}`;
    window[cbName] = data => {
      try { callback(null, data); }
      finally { cleanup(); }
    };
    const script = document.createElement('script');
    script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName;
    script.async = true;
    script.onerror = () => {
      cleanup();
      callback(new Error('Request failed'));
    };
    document.head.appendChild(script);
    function cleanup() {
      delete window[cbName];
      script.remove();
    }
  }
  
  // Escape HTML
  function esc(s) {
    return String(s || '').replace(/[<>&"']/g, c => ({
      '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'
    }[c]));
  }
  
  // Format date
  function formatDate(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    return isNaN(d) ? '' : d.toLocaleDateString(undefined, { month: 'short', year: 'numeric' });
  }
  
  // Truncate text
  function truncate(text, maxLength = 180) {
    if (!text || text.length <= maxLength) return text;
    return text.substring(0, maxLength).trim() + '...';
  }
  
  // Render a single review
  function renderReview(review, index) {
    const rating = Number(review.rating || 0);
    const stars = 'â˜…'.repeat(rating);
    const quote = truncate(review.review_text || 'Great service!', 180);
    const author = review.display_name || 'Customer';
    const service = review.services_selected ? review.services_selected.split(',')[0].trim() : '';
    
    const item = document.createElement('div');
    item.className = 'review-item';
    if (index === 0) item.classList.add('active');
    
    item.innerHTML = `
      <div class="review-stars">${esc(stars)}</div>
      <div class="review-quote">${esc(quote)}</div>
      <div class="review-meta">
        <div class="review-author">${esc(author)}</div>
        ${service ? `<div class="review-service">${esc(service)}</div>` : ''}
      </div>
    `;
    
    return item;
  }
  
  // Render control dots
  function renderControls() {
    controls.innerHTML = '';
    reviews.forEach((_, idx) => {
      const dot = document.createElement('div');
      dot.className = 'review-dot';
      if (idx === 0) dot.classList.add('active');
      dot.addEventListener('click', () => goToReview(idx));
      controls.appendChild(dot);
    });
  }
  
  // Go to specific review
  function goToReview(index) {
    if (index === currentIndex) return;
    
    // Update DOM
    const items = stage.querySelectorAll('.review-item');
    const dots = controls.querySelectorAll('.review-dot');
    
    items.forEach((item, idx) => {
      item.classList.toggle('active', idx === index);
    });
    
    dots.forEach((dot, idx) => {
      dot.classList.toggle('active', idx === index);
    });
    
    currentIndex = index;
    
    // Reset rotation timer
    if (!isPaused) {
      clearInterval(rotationTimer);
      startRotation();
    }
  }
  
  // Auto-rotate reviews
  function startRotation() {
    rotationTimer = setInterval(() => {
      const nextIndex = (currentIndex + 1) % reviews.length;
      goToReview(nextIndex);
    }, ROTATION_INTERVAL);
  }
  
  // Pause on hover
  carousel.addEventListener('mouseenter', () => {
    isPaused = true;
    clearInterval(rotationTimer);
  });
  
  carousel.addEventListener('mouseleave', () => {
    isPaused = false;
    startRotation();
  });
  
  // Load reviews from fast endpoint first; fallback to legacy JSONP
  async function loadReviews(forceNetwork=false) {
    const now = Date.now();
    // 1. Try cache first (unless forced network)
    if(!forceNetwork){
      try {
        const metaStr = localStorage.getItem(CACHE_META_KEY);
        const cacheStr = localStorage.getItem(CACHE_KEY);
        if(metaStr && cacheStr){
          const meta = JSON.parse(metaStr);
          if(meta.ts && (now - meta.ts) < CACHE_TTL_MS){
            const cached = JSON.parse(cacheStr);
            if(Array.isArray(cached) && cached.length){
              console.info('[Reviews] Using cached reviews ('+cached.length+') age=' + Math.round((now-meta.ts)/1000) + 's');
              hydrate(cached, meta.fast === true, true /*fromCache*/);
              // Schedule silent refresh if cache is older than 50% TTL
              if((now - meta.ts) > CACHE_TTL_MS/2){
                requestIdleCallback(()=>loadReviews(true));
              }
              return; // Done fast path
            }
          }
        }
      }catch(e){ console.warn('[Reviews] Cache read failed', e); }
    }
    // 2. Network fetch fast endpoint
    try {
      const url = `${FAST_ENDPOINT}?limit=${MAX_REVIEWS_STORE}&onlyVerified=false`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }, cache: 'no-store' });
      if(!res.ok) throw new Error('Fast endpoint HTTP ' + res.status);
      const data = await res.json();
      if(!data || data.ok !== true || !Array.isArray(data.reviews)) throw new Error('Fast endpoint invalid payload');
      const items = data.reviews.slice(0, MAX_REVIEWS_STORE);
      hydrate(items, true);
      try { localStorage.setItem(CACHE_KEY, JSON.stringify(items)); localStorage.setItem(CACHE_META_KEY, JSON.stringify({ts: now, fast:true, count: items.length})); }catch(e){ /* ignore quota */ }
    } catch(err){
      console.warn('[Reviews] Fast endpoint failed, falling back:', err.message);
      const legacyUrl = `${LEGACY_ENDPOINT}?action=public_list&limit=${MAX_REVIEWS_STORE}&offset=0&onlyVerified=false`;
      jsonp(legacyUrl, (e, legacyData) => {
        if(e || !legacyData || legacyData.ok !== true){
          console.error('[Reviews] Legacy fallback also failed');
          carousel.style.display = 'none';
          return;
        }
        const items = (legacyData.items || []).slice(0, MAX_REVIEWS_STORE);
        hydrate(items, false);
        try { localStorage.setItem(CACHE_KEY, JSON.stringify(items)); localStorage.setItem(CACHE_META_KEY, JSON.stringify({ts: now, fast:false, count: items.length})); }catch(e){ }
      });
    }
  }

  // Normalize and render reviews
  function hydrate(rawItems, fromFast, fromCache=false){
    // Transform objects so renderReview expects consistent keys
    const normalized = rawItems.map(r => ({
      rating: Number(r.rating || r.stars_tech || 0),
      review_text: r.review_text || r.comment_tech || r.text || '',
      display_name: r.display_name || r.name || 'Customer',
      services_selected: r.services_selected || r.service || '',
      timestamp_iso: r.timestamp_iso || r.created_at || new Date().toISOString()
    }));
    // Filter high-quality
    const quality = normalized.filter(r => r.rating >= MIN_RATING && r.review_text && r.review_text.trim().length > 20);
    reviews = quality.slice(0, HYDRATE_VISIBLE);
    if(!reviews.length){
      carousel.style.display = 'none';
      return;
    }
    stage.innerHTML='';
    reviews.forEach((rev, idx) => stage.appendChild(renderReview(rev, idx)));
    renderControls();
    if(reviews.length>1){ startRotation(); } else { controls.style.display='none'; }
    carousel.style.display='block';
    const renderTime = performance.now() - PERF_MARK_START;
    console.info('[Reviews] Hydrated '+reviews.length+' reviews (source='+(fromCache?'cache':(fromFast?'fast':'legacy'))+') in '+Math.round(renderTime)+'ms');
    // Lazy append more after first paint
    if(quality.length > HYDRATE_VISIBLE){
      requestIdleCallback(()=>{
        quality.slice(HYDRATE_VISIBLE).forEach((rev, idx)=>{
          const node = renderReview(rev, HYDRATE_VISIBLE+idx);
          node.classList.remove('active');
          stage.appendChild(node);
        });
        console.info('[Reviews] Appended remaining '+(quality.length - HYDRATE_VISIBLE)+' reviews lazily');
      });
    }
  }
  
  // Initialize after page loads
  // Start quickly after load; use requestIdleCallback to avoid competing with LCP
  function scheduleInitial(){
    requestIdleCallback(()=>loadReviews(false));
  }
  if (document.readyState === 'complete') { scheduleInitial(); }
  else { window.addEventListener('load', scheduleInitial); }
  // Manual refresh hook for debugging (open console & call window.refreshReviews())
  window.refreshReviews = () => loadReviews(true);
})();
</script>
<!-- ===== TRACKING CLIENT ===== -->
<script>
(function() {
    'use strict';
    
    const TRACK_API = 'https://h2s-backend.vercel.app/api/track';
    const VISITOR_KEY = 'h2s_visitor_id';
    const SESSION_KEY = 'h2s_session_id';
    
    function getVisitorId() {
        let vid = localStorage.getItem(VISITOR_KEY);
        if (!vid) {
            vid = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
            localStorage.setItem(VISITOR_KEY, vid);
        }
        return vid;
    }
    
    function getSessionId() {
        let sid = sessionStorage.getItem(SESSION_KEY);
        if (!sid) {
            sid = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
            sessionStorage.setItem(SESSION_KEY, sid);
        }
        return sid;
    }
    
    function extractUTM() {
        const params = new URLSearchParams(window.location.search);
        return {
            utm_source: params.get('utm_source') || null,
            utm_medium: params.get('utm_medium') || null,
            utm_campaign: params.get('utm_campaign') || null,
            utm_term: params.get('utm_term') || null,
            utm_content: params.get('utm_content') || null
        };
    }
    
    function sendEvent(payload, retries = 1) {
        const useBeacon = navigator.sendBeacon && retries === 1;
        
        if (useBeacon) {
            const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
            if (navigator.sendBeacon(TRACK_API, blob)) {
                return Promise.resolve();
            }
        }
        
        return fetch(TRACK_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            keepalive: true
        })
        .then(res => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        })
        .catch(err => {
            if (retries > 0) {
                return new Promise(resolve => {
                    setTimeout(() => {
                        sendEvent(payload, retries - 1).then(resolve).catch(() => resolve());
                    }, 500);
                });
            }
        });
    }
    
    function track(eventType, data = {}) {
        const payload = {
            event: eventType,
            event_type: eventType,
            occurred_at: new Date().toISOString(),
            visitor_id: getVisitorId(),
            session_id: getSessionId(),
            page_url: window.location.href,
            page_path: window.location.pathname,
            referrer: document.referrer || null,
            user_agent: navigator.userAgent,
            ...extractUTM(),
            ...data
        };
        
        if (data.element_id) payload.element_id = data.element_id;
        if (data.element_text) payload.element_text = data.element_text;
        if (data.metadata) payload.metadata = data.metadata;
        
        if (eventType === 'page_view') {
            if ('requestIdleCallback' in window) {
                requestIdleCallback(() => sendEvent(payload), { timeout: 2000 });
            } else {
                setTimeout(() => sendEvent(payload), 100);
            }
        } else {
            sendEvent(payload);
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            track('page_view');
        });
    } else {
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => track('page_view'), { timeout: 2000 });
        } else {
            setTimeout(() => track('page_view'), 100);
        }
    }
    
    document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-track]');
        if (target) {
            const eventType = target.getAttribute('data-track') || 'click';
            track(eventType, {
                element_id: target.id || target.getAttribute('data-track-id') || null,
                element_text: target.textContent?.trim().substring(0, 100) || null
            });
        }
    }, { passive: true });
    
    document.addEventListener('submit', function(e) {
        if (e.target.tagName === 'FORM') {
            track('form_submit', {
                element_id: e.target.id || 'unknown_form'
            });
        }
    }, { passive: true });
    
    document.addEventListener('click', function(e) {
        const link = e.target.closest('a[href]');
        if (link && link.hostname !== window.location.hostname) {
            track('outbound', {
                element_id: link.id || null,
                element_text: link.textContent?.trim().substring(0, 100) || null,
                metadata: { url: link.href }
            });
        }
    }, { passive: true });
    
    window.h2sTrack = track;
    
    window.addEventListener('beforeunload', function() {
        const payload = {
            event: 'page_unload',
            event_type: 'page_unload',
            occurred_at: new Date().toISOString(),
            visitor_id: getVisitorId(),
            session_id: getSessionId(),
            page_url: window.location.href,
            page_path: window.location.pathname
        };
        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        navigator.sendBeacon(TRACK_API, blob);
    });
})();
</script>
