<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Order Confirmed • Home2Smart</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https://home2smart.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' https: data:; connect-src 'self' https://h2s-backend.vercel.app https://home2smart.com; frame-src 'self' https://api.leadconnectorhq.com;">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{--cobalt:#0a2a5a;--azure:#1493ff;--border:#e1e6ed;--muted:#6b778c}
  *{box-sizing:border-box}
  body{font-family:Archivo,system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#fff;color:#0b1420}
  .wrap{max-width:820px;margin:24px auto;padding:16px}
  .card{border:1px solid var(--border);border-radius:12px;padding:20px}
  h1{font-weight:900;letter-spacing:-.02em;color:var(--cobalt);margin:0 0 6px 0}
  .help{color:var(--muted);margin-bottom:16px}
  .grid{display:grid;gap:10px}
  .row{display:grid;grid-template-columns:160px 1fr;gap:12px;padding:8px 0;border-bottom:1px solid var(--border)}
  .row:last-child{border-bottom:none}
  .k{color:var(--muted);font-weight:600}
  .v{font-weight:700}
  .cal{margin-top:18px;border:1px solid var(--border);border-radius:12px;overflow:hidden;height:680px}
  .cal iframe{width:100%;height:100%;border:0}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:8px;border:2px solid var(--border);background:#fff;color:var(--cobalt);font-weight:800;text-decoration:none}
  .center{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
  <div class="wrap">
    <div id="content" class="card">
      <h1>Loading…</h1>
      <div class="help">Preparing your confirmation.</div>
    </div>
  </div>
<script>
(function(){
  const API = 'https://h2s-backend.vercel.app/api/shop';
  const APIV1 = 'https://h2s-backend.vercel.app/api/book-appointment';
  const CAL_FORM_URL = 'https://api.leadconnectorhq.com/widget/booking/RjwOQacM3FAjRNCfm6uU';
  const SITE_URL = 'https://home2smart.com';
  const SUCCESS_URL = 'https://home2smart.com/checkout-success'; // Update this to your actual GHL page URL
  
  const $ = s=>document.querySelector(s);
  const qp = new URLSearchParams(location.search);
  const view = qp.get('view')||'';
  const sessionId = qp.get('session_id')||'';

  function money(n,c='USD'){ try{ return (n==null? '—' : new Intl.NumberFormat('en-US',{style:'currency',currency:c}).format(Number(n))); }catch(_){ return '$'+Number(n).toFixed(2);} }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  async function saveAppointmentReturn(){
    const order_id = qp.get('order_id')||'';
    const startIso = qp.get('start')||'';
    const endIso = qp.get('end')||'';
    const tz = qp.get('tz')||qp.get('timezone')||'';
    const email = qp.get('email')||''; // scheduler may supply this

    $('#content').innerHTML = '<h1>Saving your appointment…</h1><div class="help">Just a moment.</div>';

    try{
      if(!email) throw new Error('Missing email');
      if(!startIso) throw new Error('Missing appointment time');
      await fetch(APIV1, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ __action:'record_install_slot', email, order_id, install_at:startIso, install_end_at:endIso, timezone:tz }) });
      $('#content').innerHTML = '<h1>Appointment saved</h1><div class="help">We\'ll see you then. You can close this page.</div>';
    }catch(err){
      $('#content').innerHTML = '<h1>Couldn\'t save appointment</h1><div class="help" style="color:#c33">'+esc(err.message||'Error')+'</div>';
    }
  }

  async function renderSuccess(){
    // Prefer URL params (simulation provides these)
    const order = {
      order_id: qp.get('order_id') || sessionId || '—',
      order_total: qp.get('order_total') || qp.get('order_subtotal') || '',
      order_subtotal: qp.get('order_subtotal') || '',
      order_currency: (qp.get('order_currency')||'USD').toUpperCase(),
      order_item_count: qp.get('order_item_count') || '',
      order_summary: qp.get('order_summary') || '',
      order_discount_code: qp.get('order_discount_code') || '',
      order_discount_amount: qp.get('order_discount_amount') || ''
    };

    const prettyTotal = order.order_total ? money(Number(order.order_total), order.order_currency) : (order.order_subtotal? money(Number(order.order_subtotal), order.order_currency):'—');

    $('#content').innerHTML = `
      <h1>Thanks! Your order is confirmed.</h1>
      <div class="grid" style="margin:12px 0 6px 0">
        <div class="row"><div class="k">Order ID</div><div class="v">${esc(order.order_id)}</div></div>
        <div class="row"><div class="k">Total</div><div class="v">${esc(prettyTotal)} ${esc(order.order_currency||'')}</div></div>
        <div class="row"><div class="k">Items</div><div class="v">${esc(order.order_summary || (order.order_item_count? (order.order_item_count+' items') : '—'))}</div></div>
        ${order.order_discount_code ? `<div class="row"><div class="k">Promo code</div><div class="v">${esc(order.order_discount_code)}</div></div>` : ''}
      </div>
      <div class="help">Next step: pick a date & time for your service.</div>
      <div class="cal"><iframe id="calFrame" title="Scheduler"></iframe></div>
      <div class="center" style="margin-top:12px">
        <a class="btn" href="${SITE_URL}/bundles">Back to packages</a>
      </div>
    `;

    // Build calendar URL with known params
    const q = new URLSearchParams();
    ['first_name','last_name','email','phone','order_id','stripe_session_id','order_created_at','order_total','order_subtotal','order_currency','order_discount_code','order_discount_amount','order_item_count','order_summary','order_lines_json','utm_source','utm_medium','utm_campaign','utm_term','utm_content'].forEach(k=>{
      const v = qp.get(k);
      if(v!=null && String(v).length) q.set(k, v);
    });
    q.set('redirect_url', SUCCESS_URL + '?view=apptreturn');

    const src = CAL_FORM_URL + (CAL_FORM_URL.includes('?') ? '&' : '?') + q.toString();
    const frame = document.getElementById('calFrame');
    frame.src = src;
  }

  (view === 'apptreturn') ? saveAppointmentReturn() : renderSuccess();
})();
</script>
</body>
</html>
