<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dispatch Command Center - Home2Smart</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* ========================= BASE STYLES ========================= */
:root {
    /* Brand Colors */
    --brand-cobalt: #0A2A5A;
    --brand-azure: #1493FF;
    --brand-green: #22C96F;
    --brand-gold: #FFC857;
    
    /* UI Colors */
    --bg-dark: #0f172a;
    --bg-card: #1e293b;
    --bg-hover: #334155;
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --border: #334155;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-dark);
    color: var(--text-main);
    height: 100vh;
    display: flex;
    overflow: hidden;
}

/* ========================= SIDEBAR ========================= */
.sidebar {
    width: 260px;
    background: var(--brand-cobalt);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 20px;
    flex-shrink: 0;
}

.logo-container {
    margin-bottom: 40px;
    padding: 0 10px;
}

.logo-img {
    height: 32px;
    width: auto;
    display: block;
}

.nav-menu {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 8px;
    color: rgba(255,255,255,0.7);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
}

.nav-item:hover {
    background: rgba(255,255,255,0.1);
    color: #fff;
}

.nav-item.active {
    background: var(--brand-azure);
    color: #fff;
    box-shadow: 0 4px 12px rgba(20, 147, 255, 0.3);
}

.nav-icon {
    width: 20px;
    height: 20px;
    opacity: 0.8;
}

/* ========================= MAIN CONTENT ========================= */
.main-content {
    flex: 1;
    overflow-y: auto;
    padding: 30px;
    background: linear-gradient(135deg, var(--bg-dark) 0%, #1e293b 100%);
}

@media (max-width: 768px) {
    .main-content {
        padding: 16px;
    }
    
    .sidebar {
        position: fixed;
        left: -260px;
        top: 0;
        height: 100vh;
        z-index: 1000;
        transition: left 0.3s ease;
    }
    
    .sidebar.mobile-open {
        left: 0;
    }
    
    body {
        flex-direction: column;
    }
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 16px;
}

@media (max-width: 640px) {
    .page-header {
        margin-bottom: 20px;
    }
}

.page-title {
    font-size: 24px;
    font-weight: 700;
    color: #fff;
}

@media (max-width: 640px) {
    .page-title {
        font-size: 20px;
    }
}

/* ========================= CARDS & METRICS ========================= */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

@media (max-width: 640px) {
    .metrics-grid {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-bottom: 20px;
    }
}

.metric-card {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(51, 65, 85, 0.8) 100%);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 12px;
    padding: 20px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.metric-card:hover {
    border-color: rgba(20, 147, 255, 0.4);
    box-shadow: 0 8px 24px rgba(20, 147, 255, 0.15);
    transform: translateY(-2px);
}

@media (max-width: 640px) {
    .metric-card {
        padding: 16px;
    }
}

.metric-label {
    font-size: 13px;
    color: #94a3b8;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
}

.metric-value {
    font-size: 28px;
    font-weight: 700;
    color: #ffffff;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

@media (max-width: 640px) {
    .metric-value {
        font-size: 24px;
    }
}

.metric-trend {
    font-size: 13px;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.trend-up { color: var(--brand-green); }
.trend-down { color: var(--brand-gold); }

/* AI Analysis Card */
.ai-card {
    background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
    border: 1px solid var(--brand-azure);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
}

.ai-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--brand-azure), var(--brand-green));
}

.ai-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.ai-title {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
}

.ai-content {
    font-size: 14px;
    line-height: 1.6;
    color: #cbd5e1;
    white-space: pre-line;
}

/* ========================= JOBS GRID ========================= */
.jobs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

@media (max-width: 768px) {
    .jobs-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

.job-card {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(51, 65, 85, 0.9) 100%);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
    backdrop-filter: blur(10px);
}

@media (max-width: 640px) {
    .job-card {
        padding: 16px;
    }
}

.job-card:hover {
    transform: translateY(-4px);
    border-color: rgba(20, 147, 255, 0.5);
    box-shadow: 0 8px 24px rgba(20, 147, 255, 0.2);
}

@media (hover: none) {
    .job-card:hover {
        transform: none;
    }
    .job-card:active {
        transform: scale(0.98);
    }
}

.job-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
}

.job-id {
    font-family: monospace;
    font-size: 12px;
    color: var(--brand-azure);
    background: rgba(20, 147, 255, 0.1);
    padding: 4px 8px;
    border-radius: 6px;
}

.job-status {
    font-size: 11px;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 6px;
    text-transform: uppercase;
}

.status-new { background: rgba(20, 147, 255, 0.2); color: #60a5fa; }
.status-assigned { background: rgba(255, 200, 87, 0.2); color: #fbbf24; }
.status-completed { background: rgba(34, 201, 111, 0.2); color: #34d399; }

.job-title {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    margin-bottom: 8px;
    line-height: 1.4;
}

.job-meta {
    font-size: 13px;
    color: var(--text-muted);
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.meta-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

.meta-icon {
    width: 14px;
    height: 14px;
    opacity: 0.7;
}

.tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 12px;
}

.tag {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    background: rgba(255,255,255,0.1);
    color: var(--text-muted);
}

.tag.clarification {
    background: rgba(255, 200, 87, 0.2);
    color: var(--brand-gold);
    border: 1px solid rgba(255, 200, 87, 0.3);
}

/* ========================= MODAL ========================= */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}

.modal-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.modal {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 16px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 30px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

@media (max-width: 768px) {
    .modal {
        width: 100%;
        max-height: 100vh;
        border-radius: 0;
        padding: 20px;
    }
}

@media (max-width: 640px) {
    .modal {
        padding: 16px;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 24px;
    cursor: pointer;
}

.section-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--brand-azure);
    text-transform: uppercase;
    margin-bottom: 12px;
    margin-top: 24px;
}

.info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.info-item label {
    display: block;
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.info-item div {
    font-size: 14px;
    color: #fff;
}

/* Purchasing Suggestions */
.suggestion-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    gap: 16px;
    align-items: flex-start;
}

.suggestion-check {
    margin-top: 4px;
    width: 18px;
    height: 18px;
    accent-color: var(--brand-azure);
    cursor: pointer;
}

.suggestion-content {
    flex: 1;
}

.suggestion-content h4 {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #fff;
}

.suggestion-content p {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.brand-tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.brand-tag {
    font-size: 11px;
    padding: 2px 6px;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    color: #cbd5e1;
}

/* ========================= UTILS ========================= */
.hidden { display: none !important; }

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
}

@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.btn-primary { background: var(--brand-azure); color: #fff; }
.btn-primary:hover { background: #0077e6; }
.btn-ghost { background: rgba(255,255,255,0.1); color: #fff; }
.btn-ghost:hover { background: rgba(255,255,255,0.2); }
.btn-success { background: var(--brand-green); color: #fff; }
.btn-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

/* Icons */
.icon-sm { width: 16px; height: 16px; }
.icon-md { width: 20px; height: 20px; }

/* Pagination & Tabs */
.tabs-container {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    overflow-x: auto;
    padding-bottom: 4px;
}
.tab-btn {
    padding: 8px 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid transparent;
    border-radius: 20px;
    color: var(--text-muted);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
}
.tab-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
.tab-btn.active {
    background: rgba(20, 147, 255, 0.15);
    color: var(--brand-azure);
    border-color: rgba(20, 147, 255, 0.3);
}
.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
}
.page-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
}
.page-btn:hover:not(:disabled) {
    background: var(--brand-azure);
    color: #fff;
    border-color: var(--brand-azure);
}
.page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

</style>
</head>
<body>

<!-- Connection Status Indicator -->
<div id="connection-status" style="position:fixed; top:20px; right:20px; z-index:9999; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; padding:8px 16px; font-size:12px; display:flex; align-items:center; gap:8px; opacity:0; transition:opacity 0.3s">
    <div id="status-dot" style="width:8px; height:8px; border-radius:50%; background:var(--brand-green)"></div>
    <span id="status-text">Connected</span>
</div>

<!-- SIDEBAR -->
<div class="sidebar">
    <div class="logo-container">
        <img src="https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68da0ce6f00445991d64a63f.png" alt="Home2Smart" class="logo-img">
    </div>
    
    <div class="nav-menu">
        <div class="nav-item active" onclick="switchView('dashboard', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            Dashboard
        </div>
        <div class="nav-item" onclick="switchView('jobs', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            Jobs
        </div>
        <div class="nav-item" onclick="switchView('payouts', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Payouts
        </div>
        <div class="nav-item" onclick="openSettings()" style="margin-top:auto">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            Settings
        </div>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content">
    
    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard">
        <div class="page-header">
            <h1 class="page-title">Business Intelligence</h1>
            <div style="display:flex; gap:12px">
                <button class="btn btn-ghost" onclick="loadMetrics()">Refresh Data</button>
                <button class="btn btn-primary" onclick="generateAIReport()">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Generate AI Report
                </button>
            </div>
        </div>
        
        <div id="ai-report-container" class="hidden">
            <div class="ai-card">
                <div class="ai-header">
                    <div class="ai-title">
                        <svg class="icon-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                        Executive Analysis
                    </div>
                    <span style="font-size:12px; color:var(--text-muted)">Generated just now</span>
                </div>
                <div id="ai-content" class="ai-content">
                    Loading analysis...
                </div>
            </div>
        </div>

        <div id="metrics-container">
            <div style="text-align:center; padding:40px; color:var(--text-muted)">Loading analytics...</div>
        </div>
        
        <!-- CHARTS SECTION -->
        <div id="charts-section" class="hidden" style="margin-top:30px">
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-bottom:20px">
                <div class="metric-card">
                    <div class="metric-label">Revenue Trend (Last 30 Days)</div>
                    <canvas id="revenueChart" style="max-height:250px"></canvas>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Job Status Distribution</div>
                    <canvas id="jobStatusChart" style="max-height:250px"></canvas>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                <div class="metric-card">
                    <div class="metric-label">Capacity Utilization</div>
                    <canvas id="capacityChart" style="max-height:200px"></canvas>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Pricing Tier Breakdown</div>
                    <canvas id="pricingChart" style="max-height:200px"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- JOBS VIEW -->
    <div id="view-jobs" class="hidden">
        <div class="page-header">
            <h1 class="page-title">Dispatch Jobs</h1>
            <div style="display:flex; gap:12px">
                <button class="btn btn-primary" onclick="loadJobs()">Refresh List</button>
            </div>
        </div>
        
        <!-- Status Tabs -->
        <div class="tabs-container" id="job-tabs">
            <button class="tab-btn active" onclick="filterJobsByTab('all')">All Jobs</button>
            <button class="tab-btn" onclick="filterJobsByTab('pending')">Pending</button>
            <button class="tab-btn" onclick="filterJobsByTab('accepted')">Scheduled</button>
            <button class="tab-btn" onclick="filterJobsByTab('in_progress')">In Progress</button>
            <button class="tab-btn" onclick="filterJobsByTab('completed')">Completed</button>
            <button class="tab-btn" onclick="filterJobsByTab('cancelled')">Cancelled</button>
        </div>
        
        <div id="jobs-grid" class="jobs-grid">
            <!-- Jobs injected here -->
        </div>

        <!-- Pagination Controls -->
        <div id="jobs-pagination" class="pagination-controls hidden">
            <button class="page-btn" id="prev-page" onclick="changePage(-1)">
                <svg style="width:20px;height:20px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <span id="page-info" style="color:var(--text-muted); font-size:14px; font-weight:500">Page 1 of 1</span>
            <button class="page-btn" id="next-page" onclick="changePage(1)">
                <svg style="width:20px;height:20px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </div>

    <!-- PAYOUTS VIEW -->
    <div id="view-payouts" class="hidden">
        <div class="page-header">
            <h1 class="page-title">Technician Payouts</h1>
            <div style="display:flex; gap:12px; align-items:center">
                <span style="font-size:14px; color:var(--text-muted)">Total Pending: <strong id="total-pending" style="color:var(--brand-gold)">$0</strong></span>
                <select id="payout-filter" onchange="loadPayouts()" style="padding:10px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:#fff; font-size:14px">
                    <option value="all">All States</option>
                    <option value="pending">Pending Review</option>
                    <option value="approved">Approved</option>
                    <option value="paid">Paid</option>
                </select>
                <button class="btn btn-ghost" onclick="loadPayouts()">Refresh</button>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="metrics-grid" style="margin-bottom:30px">
            <div class="metric-card">
                <div class="metric-label">Pending Approval</div>
                <div class="metric-value" id="payout-pending-amount">$0</div>
                <div class="metric-trend" id="payout-pending-count">0 entries</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Approved (Not Paid)</div>
                <div class="metric-value" id="payout-approved-amount" style="color:var(--brand-green)">$0</div>
                <div class="metric-trend" id="payout-approved-count">0 entries</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Paid This Month</div>
                <div class="metric-value" id="payout-paid-amount">$0</div>
                <div class="metric-trend" id="payout-paid-count">0 entries</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Lifetime</div>
                <div class="metric-value" id="payout-lifetime-amount">$0</div>
                <div class="metric-trend">All technicians</div>
            </div>
        </div>
        
        <!-- Payout Entries Table -->
        <div id="payouts-container">
            <div style="text-align:center; padding:40px; color:var(--text-muted)">Loading payouts...</div>
        </div>
    </div>

</div>

<!-- JOB DETAIL MODAL -->
<div id="job-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <div>
                <h2 id="modal-title" style="font-size:20px; font-weight:700; color:#fff; margin-bottom:4px">Job Details</h2>
                <span id="modal-id" class="job-id">ID: 12345</span>
            </div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        
        <div class="info-grid">
            <div class="info-item">
                <label>Customer</label>
                <div id="modal-customer">John Doe</div>
            </div>
            <div class="info-item">
                <label>Location</label>
                <div id="modal-location">123 Main St, City</div>
                <a id="modal-map-link" href="#" target="_blank" style="font-size:11px; color:var(--brand-azure); text-decoration:none; display:inline-flex; align-items:center; gap:4px; margin-top:4px">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    View on Google Maps
                </a>
            </div>
            <div class="info-item">
                <label>Service</label>
                <div id="modal-service">TV Mounting</div>
            </div>
            <div class="info-item">
                <label>Date</label>
                <div id="modal-date">Oct 12, 2023</div>
            </div>
        </div>

        <div id="modal-metadata">
            <!-- Job metadata details injected here -->
        </div>

        <div id="modal-photos" style="margin-top:24px">
            <!-- Customer photos injected here -->
        </div>

        <div id="modal-tech-photos" style="margin-top:24px">
            <!-- Tech-uploaded photos injected here -->
        </div>

        <div id="suggestions-header" style="display:flex; justify-content:space-between; align-items:center; margin-top:24px; margin-bottom:12px">
            <div class="section-title" style="margin:0">Purchasing Suggestions</div>
            <button class="btn btn-ghost" style="padding:6px 12px; font-size:12px" onclick="copySelectedItems()">
                <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                Copy Selected
            </button>
        </div>
        
        <div id="modal-suggestions">
            <!-- Suggestions injected here -->
        </div>

        <div class="section-title">Actions</div>
        <div style="display:flex; gap:12px">
            <button class="btn btn-primary" onclick="openDispatchWorkflow()">Dispatch Job</button>
            <button class="btn btn-success" onclick="markJobComplete()">Mark Complete</button>
            <button class="btn btn-ghost">Edit Details</button>
        </div>
    </div>
</div>

<!-- DISPATCH WORKFLOW MODAL -->
<div id="dispatch-modal" class="modal-overlay">
    <div class="modal" style="max-width:500px">
        <div class="modal-header">
            <h2 style="font-size:18px; font-weight:700; color:#fff">Assign Pro</h2>
            <button class="modal-close" onclick="closeDispatchModal()">&times;</button>
        </div>
        <div style="margin-bottom:20px">
            <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:13px">Select Technician</label>
            <select id="pro-select" style="width:100%; padding:12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:#fff">
                <option value="">Select a pro...</option>
                <option value="pro_1">Mike Johnson (5 stars)</option>
                <option value="pro_2">Sarah Connor (4.9 stars)</option>
                <option value="pro_3">Tech Team A (4.8 stars)</option>
            </select>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:12px">
            <button class="btn btn-ghost" onclick="closeDispatchModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmDispatch()">Confirm Assignment</button>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="modal-overlay">
    <div class="modal" style="max-width:500px">
        <div class="modal-header">
            <h2 style="font-size:18px; font-weight:700; color:#fff">Dashboard Settings</h2>
            <button class="modal-close" onclick="closeSettings()">&times;</button>
        </div>
        <div style="margin-bottom:20px">
            <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:13px">API Base URL</label>
            <input id="setting-api" type="text" style="width:100%; padding:12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:#fff; font-family:monospace" placeholder="https://h2s-backend.vercel.app/api">
            <p style="font-size:11px; color:var(--text-muted); margin-top:6px">Use full URL if running locally (e.g. https://.../api)</p>
        </div>
        <div style="margin-bottom:20px">
            <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:13px">Admin Token</label>
            <input id="setting-token" type="password" style="width:100%; padding:12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:#fff; font-family:monospace">
        </div>
        <div style="display:flex; justify-content:flex-end; gap:12px">
            <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
            <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    let API_BASE = 'https://h2s-backend.vercel.app/api';
    let ADMIN_TOKEN = localStorage.getItem('h2s_admin_token') || 'e5d4100f-fdbb-44c5-802c-0166d86ed1a8';
    
    let currentJobs = [];
    let currentPayouts = []; // Store enriched payout data
    let currentJobId = null;
    let connectionStatus = 'online';
    
    // Pagination & Filtering State
    let currentPage = 1;
    let itemsPerPage = 12;
    let currentStatusFilter = 'all';
    
    // Performance optimization: Cache for job data and photos
    const jobCache = {
        data: new Map(),
        photos: new Map(),
        TTL: 5 * 60 * 1000, // 5 minutes
        
        set(key, value, type = 'data') {
            const cache = type === 'photos' ? this.photos : this.data;
            cache.set(key, {
                value,
                timestamp: Date.now()
            });
        },
        
        get(key, type = 'data') {
            const cache = type === 'photos' ? this.photos : this.data;
            const item = cache.get(key);
            if (!item) return null;
            
            // Check if expired
            if (Date.now() - item.timestamp > this.TTL) {
                cache.delete(key);
                return null;
            }
            
            return item.value;
        },
        
        clear() {
            this.data.clear();
            this.photos.clear();
        }
    };
    
    // Debounce utility for performance
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Connection health check
    async function checkConnection() {
        try {
            const res = await fetch(`${API_BASE}/admin_business_intelligence`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN }),
                signal: AbortSignal.timeout(5000)
            });
            connectionStatus = res.ok ? 'online' : 'degraded';
            return res.ok;
        } catch (err) {
            connectionStatus = 'offline';
            return false;
        }
    }

    // Retry wrapper for API calls
    async function fetchWithRetry(url, options, retries = 3) {
        console.log(`[FETCH] Calling: ${url}`);
        for (let i = 0; i < retries; i++) {
            try {
                const res = await fetch(url, {
                    ...options,
                    signal: AbortSignal.timeout(10000)
                });
                
                console.log(`[FETCH] ${url} - Status: ${res.status}`);
                
                if (res.ok) {
                    connectionStatus = 'online';
                    return res;
                }
                
                if (res.status === 404) {
                    console.error(`[FETCH] 404 Not Found: ${url}`);
                    throw new Error(`Endpoint not found: ${url.split('/api/')[1] || url}`);
                }
                
                if (res.status === 401) {
                    // Auth failure - don't retry
                    throw new Error('Authentication failed. Please check your token in Settings.');
                }
                
                // Server error - retry
                if (i < retries - 1) {
                    console.log(`[FETCH] Retry ${i + 1}/${retries} after error ${res.status}`);
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                    continue;
                }
                
                throw new Error(`Server returned ${res.status}`);
                
            } catch (err) {
                console.error(`[FETCH] Error on attempt ${i + 1}:`, err.message);
                if (i === retries - 1) throw err;
                connectionStatus = 'degraded';
                await new Promise(r => setTimeout(r, 1000 * (i + 1)));
            }
        }
    }

    function openSettings() {
        document.getElementById('settings-modal').classList.add('active');
        document.getElementById('setting-api').value = API_BASE;
        document.getElementById('setting-token').value = ADMIN_TOKEN;
    }

    function closeSettings() {
        document.getElementById('settings-modal').classList.remove('active');
    }

    function saveSettings() {
        const newApi = document.getElementById('setting-api').value;
        const newToken = document.getElementById('setting-token').value;
        
        if(newApi) {
            API_BASE = newApi;
            localStorage.setItem('h2s_api_base', newApi);
        }
        
        if(newToken) {
            ADMIN_TOKEN = newToken;
            localStorage.setItem('h2s_admin_token', newToken);
        }
        
        closeSettings();
        loadMetrics(); // Reload with new settings
        alert('Settings saved!');
    }

    // --- NAVIGATION ---
    function switchView(view, el) {
        document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
        if(el) el.classList.add('active');
        
        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-jobs').classList.add('hidden');
        document.getElementById('view-payouts').classList.add('hidden');
        
        document.getElementById(`view-${view}`).classList.remove('hidden');
        
        if (view === 'dashboard') loadMetrics();
        if (view === 'jobs') loadJobs();
        if (view === 'payouts') loadPayouts();
    }

    // --- DASHBOARD METRICS ---
    async function loadMetrics() {
        const container = document.getElementById('metrics-container');
        container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted)">Loading analytics...</div>';
        
        console.log('[LOAD METRICS] Starting API call...');
        console.log('[LOAD METRICS] API_BASE:', API_BASE);
        console.log('[LOAD METRICS] ADMIN_TOKEN:', ADMIN_TOKEN);
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_business_intelligence`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN })
            });
            
            console.log('[LOAD METRICS] Response status:', res.status);
            const data = await res.json();
            console.log('[LOAD METRICS] Data received:', data);
            
            if (data.error && data.error !== 'Partial data failure - showing safe defaults') {
                throw new Error(data.error);
            }
            
            console.log('[LOAD METRICS] Rendering metrics...');
            renderMetrics(data);
            console.log('[LOAD METRICS] Rendering charts...');
            renderCharts(data);
            
            // Show warning if partial data
            if (data.error) {
                container.insertAdjacentHTML('afterbegin', 
                    '<div style="background:rgba(255,200,87,0.1); border:1px solid var(--brand-gold); padding:12px; border-radius:8px; margin-bottom:20px; font-size:13px">⚠️ Some data unavailable. Showing cached metrics.</div>'
                );
            }
            
            console.log('[LOAD METRICS] Complete!');
            
        } catch (err) {
            console.error('[LOAD METRICS] ERROR:', err);
            container.innerHTML = `
                <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; padding:20px; border-radius:8px; text-align:center">
                    <div style="font-size:16px; font-weight:600; margin-bottom:8px">Connection Error</div>
                    <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px">${err.message}</div>
                    <button class="btn btn-primary" onclick="loadMetrics()">Retry</button>
                    <button class="btn btn-ghost" onclick="openSettings()" style="margin-left:8px">Check Settings</button>
                </div>
            `;
        }
    }

    async function generateAIReport() {
        const container = document.getElementById('ai-report-container');
        const content = document.getElementById('ai-content');
        
        container.classList.remove('hidden');
        content.innerHTML = 'Analyzing data with AI...';
        
        try {
            const res = await fetch(`${API_BASE}/admin_business_intelligence?analyze=true`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN })
            });
            const data = await res.json();
            
            if (data.ai_analysis) {
                content.innerHTML = data.ai_analysis;
            } else {
                content.innerHTML = 'AI Analysis unavailable. Please check API configuration.';
            }
        } catch (err) {
            content.innerHTML = 'Error generating report.';
        }
    }

    function renderMetrics(data) {
        const container = document.getElementById('metrics-container');
        
        const revenue = data.revenue || {};
        const ops = data.operations || {};
        const growth = data.growth || {};
        
        container.innerHTML = `
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Revenue</div>
                    <div class="metric-value">$${(revenue.total || 0).toLocaleString()}</div>
                    <div class="metric-trend trend-up">
                        <span>Margin: ${revenue.margin}%</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Jobs Completed</div>
                    <div class="metric-value">${ops.jobs_completed || 0}</div>
                    <div class="metric-trend">
                        <span>${ops.completion_rate}% Completion Rate</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Pros</div>
                    <div class="metric-value">${data.workforce?.active_pros || 0}</div>
                    <div class="metric-trend">
                        <span>${data.workforce?.utilization_rate}% Utilization</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">MoM Growth</div>
                    <div class="metric-value">${growth.mom_growth}%</div>
                    <div class="metric-trend ${growth.mom_growth >= 0 ? 'trend-up' : 'trend-down'}">
                        <span>${growth.this_month_jobs} jobs this month</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Capacity</div>
                    <div class="metric-value">${data.capacity?.utilization_pct || 0}%</div>
                    <div class="metric-trend ${(data.capacity?.utilization_pct || 0) > 80 ? 'trend-down' : 'trend-up'}">
                        <span>${data.capacity?.current_load || 0} pending jobs</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Repeat Rate</div>
                    <div class="metric-value">${growth.repeat_rate || 0}%</div>
                    <div class="metric-trend">
                        <span>${growth.unique_customers || 0} unique customers</span>
                    </div>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                <div class="metric-card">
                    <div class="metric-label">Top Cities</div>
                    <div style="margin-top:12px">
                        ${(data.geography?.top_cities || []).slice(0,5).map(c => `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid rgba(148,163,184,0.2)">
                                <div style="display:flex; flex-direction:column; gap:4px">
                                    <span style="font-weight:600; color:#fff; text-transform:capitalize">${c.name}</span>
                                    <span style="font-size:11px; color:var(--text-muted)">${c.jobs} jobs • ${c.margin}% margin</span>
                                </div>
                                <span style="font-weight:700; color:var(--brand-green)">$${c.revenue.toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Pricing Tiers Performance</div>
                    <div style="margin-top:12px">
                        ${Object.entries(data.pricing || {}).map(([tier, stats]) => {
                            const marginColor = stats.margin >= 60 ? '#22C96F' : 
                                              stats.margin >= 40 ? '#FFC857' : '#ef4444';
                            const tierLabel = tier === 'byo' ? 'BYO (Customer Mount)' :
                                            tier === 'h2s' ? 'H2S Premium' : 'Base Package';
                            return `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid rgba(148,163,184,0.2); font-size:13px">
                                <div style="display:flex; flex-direction:column; gap:4px">
                                    <span style="text-transform:uppercase; color:var(--brand-azure); font-weight:600">${tierLabel}</span>
                                    <span style="font-size:11px; color:var(--text-muted)">${stats.jobs} jobs</span>
                                </div>
                                <div style="text-align:right">
                                    <div style="font-weight:600; color:#fff">$${stats.revenue.toLocaleString()}</div>
                                    <div style="font-size:11px; color:${marginColor}; font-weight:600">${stats.margin}% margin</div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            </div>

            <style>
                @media (max-width: 768px) {
                    div[style*="grid-template-columns: 1fr 1fr"] {
                        grid-template-columns: 1fr !important;
                    }
                }
            </style>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px">
                <div class="metric-card">
                    <div class="metric-label">Top Services</div>
                    <div style="margin-top:12px">
                        ${(data.services?.top_services || []).slice(0,5).map(s => `
                            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border)">
                                <span style="font-size:13px">${s.name}</span>
                                <span style="font-weight:600">$${s.revenue.toLocaleString()}</span>
                            </div>
                        `).join('') || '<span style="color:var(--text-muted)">No data</span>'}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Top Performers</div>
                    <div style="margin-top:12px">
                        ${(data.workforce?.top_performers || []).slice(0,5).map(p => `
                            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:13px">
                                <span>${p.name}</span>
                                <span style="color:var(--brand-green)">${p.jobs} jobs • $${p.earnings.toLocaleString()}</span>
                            </div>
                        `).join('') || '<span style="color:var(--text-muted)">No data</span>'}
                    </div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px">
                <div class="metric-card">
                    <div class="metric-label">Understaffed Markets</div>
                    <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:8px">
                        ${(data.geography?.understaffed_cities || []).map(c => `
                            <span class="tag clarification">${c}</span>
                        `).join('') || '<span style="color:var(--text-muted)">None</span>'}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Bottlenecks (>48h Pending)</div>
                    <div style="margin-top:12px">
                        ${(data.operations?.bottlenecks || []).slice(0,3).map(b => `
                            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:13px">
                                <span style="color:var(--brand-gold)">${b.job_id}</span>
                                <span>${b.hours_pending}h • ${b.status}</span>
                            </div>
                        `).join('') || '<span style="color:var(--text-muted)">No bottlenecks detected</span>'}
                    </div>
                </div>
            </div>
        `;
    }

    // --- JOBS LOGIC ---
    async function loadJobs() {
        const grid = document.getElementById('jobs-grid');
        
        // Show skeleton grid while loading
        grid.innerHTML = `
            ${[1,2,3,4,5,6].map(() => `
                <div class="job-card" style="background:rgba(255,255,255,0.03); animation:pulse 1.5s ease-in-out infinite; pointer-events:none">
                    <div style="height:16px; width:70%; background:rgba(255,255,255,0.1); border-radius:4px; margin-bottom:12px"></div>
                    <div style="height:12px; width:90%; background:rgba(255,255,255,0.08); border-radius:4px; margin-bottom:8px"></div>
                    <div style="height:12px; width:80%; background:rgba(255,255,255,0.08); border-radius:4px; margin-bottom:8px"></div>
                    <div style="height:12px; width:60%; background:rgba(255,255,255,0.08); border-radius:4px"></div>
                </div>
            `).join('')}
        `;
        
        // Always fetch ALL jobs to allow client-side filtering
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_jobs_list`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN, status: 'all', days: 30 })
            });
            
            const data = await res.json();
            
            if (!data.ok) throw new Error(data.error || 'Failed to load jobs');
            
            currentJobs = data.jobs || [];
            
            // Reset to page 1 on new load
            currentPage = 1;
            
            // UPDATE JOB CACHE: Single source of truth for all job lookups
            currentJobs.forEach(job => {
                jobCache.set(job.job_id, job, 'data');
            });
            
            renderJobs(currentJobs);
            
            // PRE-FETCH: Load photos for pending payment jobs in background for instant modal access
            const pendingPaymentJobs = currentJobs.filter(j => 
                j.status === 'completed' || j.status === 'pending_payment'
            );
            
            if (pendingPaymentJobs.length > 0) {
                console.log(`[PRE-FETCH] Loading photos for ${pendingPaymentJobs.length} completed jobs...`);
                
                // Pre-fetch first 3 completed jobs (most likely to be viewed)
                pendingPaymentJobs.slice(0, 3).forEach(job => {
                    Promise.all([
                        loadJobPhotos(job.job_id, 'customer_photo'),
                        loadJobPhotos(job.job_id, 'photo')
                    ]).then(() => {
                        console.log(`[PRE-FETCH] ✓ Photos cached for job ${job.job_id}`);
                    }).catch(() => {
                        // Silent fail - photos will load on demand
                    });
                });
            }
        } catch (err) {
            console.error('Jobs load error:', err);
            grid.innerHTML = `
                <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; padding:20px; border-radius:8px; text-align:center">
                    <div style="font-size:16px; font-weight:600; margin-bottom:8px">Unable to Load Jobs</div>
                    <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px">${err.message}</div>
                    <button class="btn btn-primary" onclick="loadJobs()">Retry</button>
                </div>
            `;
        }
    }

    // --- PAGINATION & FILTERING ---
    function filterJobsByTab(status) {
        currentStatusFilter = status;
        currentPage = 1; // Reset to first page
        
        // Update active tab UI
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.toLowerCase().includes(status.replace('_', ' ')) || 
                (status === 'all' && btn.textContent === 'All Jobs')) {
                btn.classList.add('active');
            }
        });
        
        renderJobs(currentJobs);
    }

    function changePage(delta) {
        currentPage += delta;
        renderJobs(currentJobs);
        // Scroll to top of grid
        document.getElementById('view-jobs').scrollTo({ top: 0, behavior: 'smooth' });
    }

    function renderJobs(allJobs) {
        const grid = document.getElementById('jobs-grid');
        const pagination = document.getElementById('jobs-pagination');
        
        // 1. Filter by Status
        let filteredJobs = allJobs;
        if (currentStatusFilter !== 'all') {
            filteredJobs = allJobs.filter(j => {
                if (currentStatusFilter === 'completed') {
                    return j.status === 'completed' || j.status === 'pending_payment' || j.status === 'paid';
                }
                return j.status === currentStatusFilter;
            });
        }
        
        if (filteredJobs.length === 0) {
            grid.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:40px">No jobs found for this status</div>';
            pagination.classList.add('hidden');
            return;
        }
        
        // 2. Sort (Newest First)
        filteredJobs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        // 3. Paginate
        const totalPages = Math.ceil(filteredJobs.length / itemsPerPage);
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageJobs = filteredJobs.slice(start, end);
        
        // 4. Render Grid
        grid.innerHTML = pageJobs.map(job => {
            let tagsHtml = '';
            if (job.metadata && job.metadata.tags) {
                tagsHtml = job.metadata.tags.map(t => `<span class="tag">${t}</span>`).join('');
            }
            if (job.metadata && job.metadata.clarification_needed) {
                tagsHtml += `<span class="tag clarification">⚠️ Clarification Needed</span>`;
            }

            return `
                <div class="job-card" onclick="openJobModal('${job.job_id}')">
                    <div class="job-header">
                        <span class="job-id">${job.job_id}</span>
                        <span class="job-status status-${job.status}">${job.status}</span>
                    </div>
                    <div class="job-title">${job.city ? job.city.charAt(0).toUpperCase() + job.city.slice(1) : job.address || 'Unknown Location'} - ${job.resources_needed || job.service_name || 'Service'}</div>
                    <div class="job-meta">
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            <span>${job.customer_name || 'Unknown Customer'}</span>
                        </div>
                        ${job.assigned_pro_name || job.metadata?.pro_name ? `
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            <span style="color:var(--brand-green)">${job.assigned_pro_name || job.metadata?.pro_name}</span>
                            ${job.assigned_pro_phone || job.metadata?.pro_phone ? `<span style="color:var(--text-muted); margin-left:8px; font-size:12px">📞 ${job.assigned_pro_phone || job.metadata?.pro_phone}</span>` : ''}
                        </div>
                        ` : ''}
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span>${job.address || 'No Address'}${job.city ? ', ' + job.city.charAt(0).toUpperCase() + job.city.slice(1) : ''}${job.state ? ', ' + job.state.toUpperCase() : ''}</span>
                        </div>
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span>${new Date(job.start_iso || job.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="tags">${tagsHtml}</div>
                </div>
            `;
        }).join('');
        
        // 5. Update Pagination Controls
        pagination.classList.remove('hidden');
        document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage === totalPages;
    }

    // --- MODAL LOGIC ---
    async function openJobModal(jobId) {
        const startTime = performance.now();
        console.log('[openJobModal] Opening job:', jobId);
        
        const job = currentJobs.find(j => j.job_id === jobId);
        if (!job) {
            console.error('[openJobModal] Job not found in currentJobs:', jobId);
            return;
        }
        
        // INSTANT DISPLAY: Show modal immediately with skeleton loaders
        document.getElementById('job-modal').classList.add('active');
        
        console.log('[openJobModal] Job data:', {
            job_id: job.job_id,
            service_name: job.service_name,
            metadata_exists: !!job.metadata,
            items_json_count: job.metadata?.items_json?.length || 0,
            purchasing_suggestions_count: job.purchasing_suggestions?.length || 0,
            assigned_pro: job.assigned_pro_name
        });
        
        currentJobId = jobId;
        
        const renderStart = performance.now();
        console.log(`[PERF] Modal opened in ${Math.round(renderStart - startTime)}ms`);

        // --- SMART DATA RESOLUTION ---
        
        // 1. Service Name Builder
        const buildServiceDescription = (itemsInput) => {
            let items = itemsInput;
            if (typeof items === 'string') {
                try { items = JSON.parse(items); } catch (e) { return null; }
            }
            if (!items || !Array.isArray(items) || items.length === 0) return null;
            
            const descriptions = [];
            items.forEach(item => {
                if (!item || item.type === 'product') return;
                const meta = item.metadata || {};
                let desc = '';
                if (item.bundle_id === 'tv_multi' || item.service_name === 'tv_multi') {
                    const tvCount = meta.mounts_needed || item.qty || 1;
                    const tvSize = meta.tv_size || '';
                    const sizeText = tvSize ? tvSize.replace('-', '"-') + '"' : '';
                    const mountSource = meta.mount_provider === 'customer' ? 'BYO Mount' : 'H2S Mount';
                    desc = `${tvCount}x ${sizeText} TV Installation (${mountSource})`.trim();
                } else if (item.bundle_id === 'cam_premium' || item.service_name === 'cam_premium') {
                    desc = 'Premium Security Camera Installation';
                } else if (item.bundle_id === 'cam_basic' || item.service_name === 'cam_basic') {
                    desc = 'Basic Security Camera Installation';
                } else if (item.bundle_id === 'tv_single' || item.service_name === 'tv_single') {
                    const tvSize = meta.tv_size || '';
                    const sizeText = tvSize ? tvSize.replace('-', '"-') + '"' : '';
                    desc = `${sizeText} TV Mount Installation`.trim();
                } else if (item.bundle_id === 'soundbar' || item.service_name === 'soundbar') {
                    desc = 'Soundbar Installation';
                } else {
                    const rawName = item.service_name || item.bundle_id || item.service_id || '';
                    desc = rawName.replace(/_/g, ' ').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                }
                if (desc) descriptions.push(desc);
            });
            return descriptions.length > 0 ? descriptions.join(' + ') : null;
        };

        // PRIORITY: Use formatted name if passed (e.g. from Payouts view), otherwise build it
        let serviceName = job.formatted_service_name || buildServiceDescription(job.metadata?.items_json || job.line_items_json);
        
        // Fallback: Clean up the raw service name
        if (!serviceName) {
            const raw = job.service_name || 'Service Order';
            if (raw === 'svc_maintenance') {
                serviceName = 'Maintenance / Service Call';
            } else {
                serviceName = raw.replace(/_/g, ' ').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
        }

        // 2. Customer Name
        let customerName = job.customer_name || job.metadata?.customer_name || job.metadata?.shipping_name || job.metadata?.billing_name || job.customer_email?.split('@')[0] || 'Customer';
        if (customerName && customerName !== 'Customer') {
            customerName = customerName.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
        }

        // 3. Address - Aggressive Lookup
        const address = job.address || job.service_address || job.metadata?.service_address || job.metadata?.address || job.location || job.metadata?.location || '';
        const city = job.city || job.service_city || job.metadata?.service_city || job.metadata?.city || '';
        const state = job.state || job.service_state || job.metadata?.service_state || job.metadata?.state || '';
        const zip = job.zip || job.service_zip || job.metadata?.service_zip || job.metadata?.zip || '';
        
        let fullAddress = 'No address provided';
        if (address) {
            fullAddress = city ? `${address}, ${city}` : address;
        } else if (city) {
            fullAddress = city;
        }
        
        // DEBUG: If address is missing, log all keys to help debug
        if (fullAddress === 'No address provided') {
            console.warn('[openJobModal] Address missing! Job keys:', Object.keys(job));
            console.warn('[openJobModal] Metadata keys:', job.metadata ? Object.keys(job.metadata) : 'null');
        }

        document.getElementById('modal-title').innerText = serviceName;
        document.getElementById('modal-id').innerText = `ID: ${job.job_id}`;
        document.getElementById('modal-customer').innerText = customerName;
        document.getElementById('modal-location').innerText = fullAddress;
        
        const mapLink = document.getElementById('modal-map-link');
        if (address || city) {
            const query = encodeURIComponent(`${address}, ${city}, ${state} ${zip}`);
            mapLink.href = `https://www.google.com/maps/search/?api=1&query=${query}`;
            mapLink.classList.remove('hidden');
        } else {
            mapLink.classList.add('hidden');
        }

        document.getElementById('modal-service').innerText = serviceName;
        document.getElementById('modal-date').innerText = new Date(job.start_iso || job.created_at).toLocaleString();

        // Show job metadata details with complete breakdown
        const metadataContainer = document.getElementById('modal-metadata');
        console.log('[openJobModal] Metadata:', job.metadata);
        console.log('[openJobModal] Items JSON:', job.metadata?.items_json);
        
        if (job.metadata && Object.keys(job.metadata).length > 0) {
            const meta = job.metadata;
            
            // Analyze equipment needs from items_json
            let equipmentBreakdown = '';
            let serviceDetails = '';
            
            if (meta.items_json && meta.items_json.length) {
                console.log('[openJobModal] Processing', meta.items_json.length, 'items');
                const items = meta.items_json;
                let totalTVMounts = 0;
                let totalCameras = 0;
                let equipmentList = [];
                
                items.forEach(item => {
                    const bundleId = item.bundle_id || item.service_name || '';
                    const qty = item.qty || 1;
                    const itemMeta = item.metadata || {};
                    
                    // TV Mount packages
                    if (bundleId.includes('tv')) {
                        const mountsNeeded = itemMeta.mounts_needed || qty;
                        totalTVMounts += mountsNeeded;
                        const tvSize = itemMeta.tv_size || 'Unknown';
                        const mountType = itemMeta.mount_type === 'full_motion' ? 'Full Motion' :
                                        itemMeta.mount_type === 'tilt' ? 'Tilt' :
                                        itemMeta.mount_type === 'fixed' ? 'Fixed' : '';
                        const mountProvider = itemMeta.mount_provider === 'customer' ? 'Customer Provided' : 
                                            itemMeta.mount_provider === 'h2s' ? 'H2S Provided' : 'Standard';
                        
                        equipmentList.push({
                            type: 'TV Mount',
                            details: `${mountsNeeded}x TV Mount (${tvSize}")${mountType ? ` - ${mountType}` : ''} - ${mountProvider}`,
                            qty: mountsNeeded,
                            meta: itemMeta
                        });
                    }
                    
                    // Camera packages
                    if (bundleId.includes('cam')) {
                        const camerasInPackage = bundleId === 'cam_basic' ? 2 :
                                                 bundleId === 'cam_standard' ? 4 :
                                                 bundleId === 'cam_premium' ? 8 : qty;
                        totalCameras += camerasInPackage * qty;
                        
                        equipmentList.push({
                            type: 'Security Camera',
                            details: `${camerasInPackage * qty}x Security Cameras (${bundleId.replace('cam_', '').toUpperCase()})`,
                            qty: camerasInPackage * qty,
                            meta: itemMeta
                        });
                    }
                });
                
                // Build equipment breakdown HTML
                equipmentBreakdown = `
                    <div style="grid-column:1/-1; background:rgba(20,147,255,0.1); border:1px solid rgba(20,147,255,0.3); border-radius:8px; padding:16px; margin-bottom:16px">
                        <div style="font-weight:700; font-size:14px; margin-bottom:12px; color:var(--brand-azure)">📋 Equipment Breakdown</div>
                        ${totalTVMounts > 0 ? `<div style="margin-bottom:8px">🖥️ <strong>${totalTVMounts} TV Mount${totalTVMounts > 1 ? 's' : ''}</strong></div>` : ''}
                        ${totalCameras > 0 ? `<div style="margin-bottom:8px">📷 <strong>${totalCameras} Security Camera${totalCameras > 1 ? 's' : ''}</strong></div>` : ''}
                        <div style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1)">
                            ${equipmentList.map(eq => `
                                <div style="font-size:13px; color:var(--text-muted); margin-bottom:6px">
                                    <span style="color:#fff">•</span> ${eq.details}
                                    ${eq.meta.requires_team ? '<span style="color:var(--brand-gold); margin-left:8px">👥 Team Required</span>' : ''}
                                    ${eq.meta.team_recommended ? '<span style="color:var(--brand-gold); margin-left:8px">👥 Team Recommended</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // Service details with all metadata
                serviceDetails = `
                    <div style="grid-column:1/-1">
                        <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:8px">Service Line Items (${items.length})</label>
                        ${items.map(item => {
                            const itemMeta = item.metadata || {};
                            return `
                                <div style="background:rgba(255,255,255,0.03); padding:12px; border-radius:6px; margin-bottom:8px">
                                    <div style="font-weight:600; margin-bottom:4px; color:var(--brand-azure)">${item.service_name || item.bundle_id || 'Service'}</div>
                                    <div style="font-size:13px; color:var(--text-muted); line-height:1.6">
                                        <div>Quantity: <strong>${item.qty}</strong> | Price: <strong style="color:var(--brand-green)">$${item.line_total || item.unit_price}</strong></div>
                                        ${itemMeta.tv_size ? `<div>TV Size: <strong>${itemMeta.tv_size}"</strong></div>` : ''}
                                        ${itemMeta.mount_type ? `<div>Mount Type: <strong style="color:var(--brand-azure)">${itemMeta.mount_type === 'full_motion' ? 'Full Motion' : itemMeta.mount_type === 'tilt' ? 'Tilt' : itemMeta.mount_type === 'fixed' ? 'Fixed/Flat' : itemMeta.mount_type}</strong></div>` : ''}
                                        ${itemMeta.mounts_needed ? `<div>Mounts Needed: <strong>${itemMeta.mounts_needed}</strong></div>` : ''}
                                        ${itemMeta.mount_provider ? `<div>Mount Provider: <strong>${itemMeta.mount_provider === 'customer' ? 'Customer' : itemMeta.mount_provider === 'h2s' ? 'H2S' : 'Standard'}</strong></div>` : ''}
                                        ${itemMeta.mount_source ? `<div>Mount Source: <strong>${itemMeta.mount_source}</strong></div>` : ''}
                                        ${itemMeta.min_team_size ? `<div>Min Team Size: <strong>${itemMeta.min_team_size}</strong></div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            metadataContainer.innerHTML = `
                <div class="section-title">Job Details</div>
                <div class="info-grid">
                    ${equipmentBreakdown}
                    ${meta.estimated_payout ? `<div class="info-item"><label>Estimated Payout</label><div style="color:var(--brand-green); font-weight:600">$${meta.estimated_payout}</div></div>` : ''}
                    ${meta.customer_phone ? `<div class="info-item"><label>Customer Phone</label><div>${meta.customer_phone}</div></div>` : ''}
                    ${meta.order_id ? `<div class="info-item"><label>Order ID</label><div style="font-size:11px; font-family:monospace">${meta.order_id}</div></div>` : ''}
                    ${meta.source ? `<div class="info-item"><label>Source</label><div>${meta.source}</div></div>` : ''}
                    ${meta.geo_lat && meta.geo_lng ? `<div class="info-item"><label>Coordinates</label><div style="font-size:11px">${meta.geo_lat.toFixed(4)}, ${meta.geo_lng.toFixed(4)}</div></div>` : ''}
                    ${meta.referral_code ? `<div class="info-item"><label>Referral Code</label><div>${meta.referral_code}</div></div>` : ''}
                    ${serviceDetails}
                </div>
            `;
        } else {
            metadataContainer.innerHTML = '';
        }

        // PARALLEL LOADING: Load both photo types simultaneously for faster modal open
        const photosContainer = document.getElementById('modal-photos');
        const techPhotosContainer = document.getElementById('modal-tech-photos');
        
        // Show loading skeletons immediately
        photosContainer.innerHTML = '<div class="skeleton-pulse" style="height:150px; border-radius:8px"></div>';
        techPhotosContainer.innerHTML = '<div class="skeleton-pulse" style="height:150px; border-radius:8px"></div>';
        
        // Load both photo types in parallel (saves ~70-100ms)
        const [customerPhotos, techPhotos] = await Promise.all([
            loadJobPhotos(job.job_id, 'customer_photo'),
            loadJobPhotos(job.job_id, 'photo')
        ]);
        
        // Render customer photos (only show for completed jobs)
        if (customerPhotos.length > 0) {
            photosContainer.innerHTML = `
                <div class="section-title">📷 Customer Photos (${customerPhotos.length})</div>
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:12px">
                    ${customerPhotos.map(photo => {
                        const photoUrl = photo.file_url || photo.photo_url || photo.url || photo.storage_url;
                        return `
                            <div style="position:relative; border-radius:8px; overflow:hidden; border:1px solid var(--border)">
                                <img src="${photoUrl}" style="width:100%; height:150px; object-fit:cover; cursor:pointer" loading="lazy" onclick="openPhotoLightbox('${photoUrl}')">
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        } else if (job.status === 'completed' || job.status === 'pending_payment') {
            // Only show placeholder for completed jobs (where photos are expected)
            photosContainer.innerHTML = '<div style="color:var(--text-muted); font-size:13px; font-style:italic">No customer photos uploaded for this job</div>';
        } else {
            // For accepted/pending jobs, hide the section entirely
            photosContainer.innerHTML = '';
        }

        // Render tech photos
        if (techPhotos.length > 0) {
            techPhotosContainer.innerHTML = `
                <div class="section-title">📸 Tech Photos (${techPhotos.length})</div>
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:12px">
                    ${techPhotos.map(photo => {
                        const photoUrl = photo.file_url || photo.photo_url || photo.url || photo.storage_url;
                        const uploadDate = photo.created_at || photo.added_at;
                        return `
                            <div style="position:relative; border-radius:8px; overflow:hidden; border:1px solid var(--border)">
                                <img src="${photoUrl}" style="width:100%; height:150px; object-fit:cover; cursor:pointer" onclick="openPhotoLightbox('${photoUrl}')">
                                <div style="position:absolute; bottom:0; left:0; right:0; background:linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding:6px 8px; font-size:10px; color:rgba(255,255,255,0.9)">
                                    ${uploadDate ? new Date(uploadDate).toLocaleDateString() : 'Unknown date'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        } else {
            techPhotosContainer.innerHTML = '<div style="color:var(--text-muted); font-size:13px; font-style:italic">No tech photos uploaded yet</div>';
        }

        // Render Suggestions with intelligent categorization
        const suggestionsContainer = document.getElementById('modal-suggestions');
        const suggestionsHeader = document.getElementById('suggestions-header');
        
        console.log('[openJobModal] Purchasing suggestions:', job.purchasing_suggestions);
        console.log('[openJobModal] Suggestions count:', job.purchasing_suggestions?.length || 0);
        
        if (job.purchasing_suggestions && job.purchasing_suggestions.length > 0) {
            suggestionsHeader.classList.remove('hidden');
            suggestionsContainer.classList.remove('hidden');
            
            // Categorize suggestions
            const categories = {
                PURCHASE_NEEDED: job.purchasing_suggestions.filter(s => s.category === 'PRIMARY'),
                FIELD_STOCK: job.purchasing_suggestions.filter(s => s.category === 'SUPPLIES' && s.priority > 2),
                VERIFY_CUSTOMER: job.purchasing_suggestions.filter(s => s.category === 'SUPPLIES' && s.priority <= 2)
            };
            
            // Check if there are multiple TV mounts with different specs
            const tvMounts = categories.PURCHASE_NEEDED.filter(s => s.suggested_id?.includes('TV_MOUNT'));
            const hasMultipleTVMounts = tvMounts.length > 1;
            
            console.log('[openJobModal] Categorized suggestions:', {
                PURCHASE_NEEDED: categories.PURCHASE_NEEDED.length,
                FIELD_STOCK: categories.FIELD_STOCK.length,
                VERIFY_CUSTOMER: categories.VERIFY_CUSTOMER.length,
                TV_MOUNTS: tvMounts.length
            });
            
            suggestionsContainer.innerHTML = `
                ${hasMultipleTVMounts ? `
                    <div style="background:rgba(34,201,111,0.1); border:1px solid rgba(34,201,111,0.3); border-radius:8px; padding:12px; margin-bottom:16px">
                        <div style="font-weight:700; font-size:12px; color:var(--brand-green); margin-bottom:8px">📊 MULTIPLE TV INSTALLATION</div>
                        <div style="font-size:12px; color:var(--text-muted); line-height:1.6">
                            This job requires <strong style="color:#fff">${tvMounts.length} different TV mounts</strong>:
                            ${tvMounts.map(m => `<div style="margin-top:4px">• ${m.tv_size}" TV - ${m.mount_type === 'full_motion' ? 'Full Motion' : m.mount_type === 'tilt' ? 'Tilt' : 'Fixed'}</div>`).join('')}
                        </div>
                    </div>
                ` : ''}
                ${categories.PURCHASE_NEEDED.length > 0 ? `
                    <div style="margin-bottom:20px">
                        <div style="font-weight:700; font-size:13px; color:var(--brand-azure); margin-bottom:12px; display:flex; align-items:center; gap:8px">
                            <span>🛒</span> ORDER REQUIRED (${categories.PURCHASE_NEEDED.length} item${categories.PURCHASE_NEEDED.length > 1 ? 's' : ''})
                        </div>
                        ${categories.PURCHASE_NEEDED.map((item, idx) => `
                            <div class="suggestion-card" style="border-left:3px solid var(--brand-azure)">
                                <input type="checkbox" class="suggestion-check" id="check-${idx}" checked>
                                <div class="suggestion-content">
                                    <h4>
                                        ${item.item_name} 
                                        ${item.quantity ? `<span style="color:var(--text-muted); font-size:12px; font-weight:normal">(Qty: ${item.quantity})</span>` : ''}
                                    </h4>
                                    <p style="margin:6px 0">${item.why_needed}</p>
                                    ${item.mount_type || item.tv_size ? `
                                        <div style="font-size:11px; color:var(--brand-azure); margin-bottom:8px">
                                            ${item.tv_size ? `📺 ${item.tv_size}" TV` : ''}
                                            ${item.mount_type ? ` | ${item.mount_type === 'full_motion' ? '🔄 Full Motion' : item.mount_type === 'tilt' ? '⬇️ Tilt' : '📍 Fixed'}` : ''}
                                        </div>
                                    ` : ''}
                                    <div class="brand-tags">
                                        ${item.typical_brands.map(b => `<span class="brand-tag">${b}</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${categories.VERIFY_CUSTOMER.length > 0 ? `
                    <div style="margin-bottom:20px">
                        <div style="font-weight:700; font-size:13px; color:var(--brand-gold); margin-bottom:12px; display:flex; align-items:center; gap:8px">
                            <span>⚠️</span> VERIFY WITH CUSTOMER (${categories.VERIFY_CUSTOMER.length})
                        </div>
                        ${categories.VERIFY_CUSTOMER.map((item, idx) => `
                            <div class="suggestion-card" style="border-left:3px solid var(--brand-gold); opacity:0.8">
                                <div class="suggestion-content">
                                    <h4>${item.item_name}</h4>
                                    <p style="font-size:12px; color:var(--text-muted)">${item.why_needed}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${categories.FIELD_STOCK.length > 0 ? `
                    <div style="margin-bottom:20px">
                        <div style="font-weight:700; font-size:13px; color:var(--text-muted); margin-bottom:12px; display:flex; align-items:center; gap:8px">
                            <span>🧰</span> FIELD STOCK (Tech should have)
                        </div>
                        <div style="font-size:12px; color:var(--text-muted); font-style:italic">
                            ${categories.FIELD_STOCK.map(s => s.item_name).join(', ')}
                        </div>
                    </div>
                ` : ''}
            `;
        } else {
            suggestionsHeader.classList.add('hidden');
            suggestionsContainer.classList.add('hidden');
            suggestionsContainer.innerHTML = '';
        }
        
        const endTime = performance.now();
        const totalTime = Math.round(endTime - startTime);
        const renderTime = Math.round(endTime - renderStart);
        
        console.log(`[PERF] ✓ Modal fully rendered in ${totalTime}ms (render: ${renderTime}ms)`);
        
        if (totalTime > 500) {
            console.warn(`[PERF] ⚠️ Modal took ${totalTime}ms (target: <500ms)`);
        }
    }
    
    function showJobModal(job) {
        // Helper function for payout view to open job details
        currentJobs = [job]; // Temporarily add to array
        openJobModal(job.job_id);
    }

    function closeModal() {
        document.getElementById('job-modal').classList.remove('active');
    }

    function copySelectedItems() {
        const job = currentJobs.find(j => j.job_id === currentJobId);
        if (!job || !job.purchasing_suggestions) return;

        const selected = [];
        job.purchasing_suggestions.forEach((item, idx) => {
            const checkbox = document.getElementById(`check-${idx}`);
            if (checkbox && checkbox.checked) {
                selected.push(`- ${item.item_name} (${item.why_needed})`);
            }
        });

        if (selected.length > 0) {
            const text = `Order List for Job ${currentJobId}:\n${selected.join('\n')}`;
            navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
        }
    }

    // --- DISPATCH WORKFLOW ---
    async function openDispatchWorkflow() {
        const modal = document.getElementById('dispatch-modal');
        const select = document.getElementById('pro-select');
        
        modal.classList.add('active');
        select.innerHTML = '<option value="">Loading pros...</option>';
        
        try {
            // Fetch all pros for manual assignment
            const res = await fetchWithRetry(`${API_BASE}/admin_pros_list`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN })
            });
            
            const data = await res.json();
            if (data.ok && data.pros) {
                select.innerHTML = '<option value="">Select a Pro...</option>' + 
                    data.pros.map(pro => `
                        <option value="${pro.pro_id}" data-name="${pro.name || pro.pro_name}">
                            ${pro.name || pro.pro_name} ${pro.status ? `(${pro.status})` : ''}
                        </option>
                    `).join('');
            } else {
                select.innerHTML = '<option value="">Failed to load pros</option>';
            }
        } catch (e) {
            console.error('Failed to load pros:', e);
            select.innerHTML = '<option value="">Error loading pros</option>';
        }
    }

    function closeDispatchModal() {
        document.getElementById('dispatch-modal').classList.remove('active');
    }

    async function confirmDispatch() {
        const select = document.getElementById('pro-select');
        const proId = select.value;
        const proName = select.options[select.selectedIndex]?.dataset.name || 'Unknown Pro';
        
        if (!proId) {
            alert('Please select a Pro');
            return;
        }
        
        const btn = document.querySelector('#dispatch-modal .btn-primary');
        const originalText = btn.innerText;
        btn.innerText = 'Assigning...';
        btn.disabled = true;
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_dispatch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN,
                    job_id: currentJobId,
                    action: 'assign',
                    pro_id: proId,
                    pro_name: proName
                })
            });
            
            const data = await res.json();
            if (data.ok) {
                alert(`Job ${currentJobId} assigned to ${proName}!`);
                closeDispatchModal();
                closeModal();
                loadJobs(); // Refresh list
            } else {
                throw new Error(data.error || 'Assignment failed');
            }
        } catch (e) {
            alert('Failed to assign job: ' + e.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function markJobComplete() {
        if (!confirm('Are you sure you want to mark this job as completed?')) return;
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_update_status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN, 
                    job_id: currentJobId, 
                    status: 'completed' 
                })
            });
            const data = await res.json();
            
            if (data.ok) {
                alert('✅ Job marked as completed!');
                closeModal();
                loadJobs(); // Refresh list
            } else {
                throw new Error(data.error);
            }
        } catch (err) {
            console.error('Mark complete error:', err);
            alert('❌ Failed to mark job complete: ' + err.message);
        }
    }

    // --- PHOTO GALLERY ---

    async function loadJobPhotos(jobId, photoType = 'photo') {
        const cacheKey = `${jobId}_${photoType}`;
        
        // Check cache first
        const cached = jobCache.get(cacheKey, 'photos');
        if (cached) {
            console.log(`[loadJobPhotos] Using cached ${photoType} photos for job ${jobId}`);
            return cached;
        }
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/portal_get_artifacts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN, 
                    job_id: jobId, 
                    type: photoType 
                })
            });
            const data = await res.json();
            
            if (data.ok) {
                const artifacts = data.artifacts || [];
                console.log(`[loadJobPhotos] Loaded ${artifacts.length} ${photoType} photos for job ${jobId}`);
                
                // Cache the result
                jobCache.set(cacheKey, artifacts, 'photos');
                
                return artifacts;
            } else {
                console.error('Failed to load photos:', data.error);
                return [];
            }
        } catch (err) {
            console.error('Photo fetch error:', err);
            return [];
        }
    }

    function openPhotoLightbox(photoUrl) {
        const lightbox = document.createElement('div');
        lightbox.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        `;
        
        const img = document.createElement('img');
        img.src = photoUrl;
        img.style.cssText = `
            max-width: 95%;
            max-height: 95vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        `;
        
        lightbox.appendChild(img);
        lightbox.onclick = () => lightbox.remove();
        document.body.appendChild(lightbox);
    }

    // --- PAYOUTS LOGIC ---

    async function approvePayout(entryId) {
        if (!confirm('Approve this payout?')) return;
        await updatePayoutStatus(entryId, 'approve');
    }

    async function rejectPayout(entryId) {
        if (!confirm('Reject this payout?')) return;
        await updatePayoutStatus(entryId, 'reject');
    }

    async function updatePayoutStatus(entryId, action) {
        try {
            console.log(`[PAYOUT] Updating ${entryId} to ${action}...`);
            const res = await fetchWithRetry(`${API_BASE}/admin_approve_payout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN, entry_id: entryId, action })
            });
            const data = await res.json();
            if (data.ok) {
                console.log('[PAYOUT] Success:', data.message || 'Updated');
                
                // Show success feedback
                const actionText = action === 'approve' ? 'approved' : 'rejected';
                showToast(`✅ Payout ${actionText} successfully`, 'success');
                
                // Refresh both payouts list and metrics (to update top performers)
                await Promise.all([
                    loadPayouts(),
                    loadMetrics()
                ]);
            } else {
                throw new Error(data.error);
            }
        } catch (err) {
            console.error('Payout update error:', err);
            alert('❌ Failed to update payout: ' + err.message);
        }
    }

    // Toast notification helper
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: ${type === 'success' ? 'var(--brand-green)' : 'var(--brand-red)'};
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            font-weight: 600;
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Load payout preview image
    async function loadPayoutPreview(jobId) {
        const container = document.getElementById(`payout-preview-${jobId}`);
        container.innerHTML = '<div style="font-size:9px">Loading...</div>';
        
        try {
            const photos = await loadJobPhotos(jobId, 'photo');
            if (photos && photos.length > 0) {
                container.innerHTML = `<img src="${photos[0]}" style="width:100%; height:100%; object-fit:cover; border-radius:6px" alt="Job photo">`;
            } else {
                container.innerHTML = '<div style="font-size:9px; color:var(--text-muted)">No photos</div>';
            }
        } catch (e) {
            container.innerHTML = '<div style="font-size:9px; color:#ef4444">Failed</div>';
        }
    }

    // Connection status updater
    function updateConnectionUI() {
        const indicator = document.getElementById('connection-status');
        const dot = document.getElementById('status-dot');
        const text = document.getElementById('status-text');
        
        if (connectionStatus === 'online') {
            dot.style.background = 'var(--brand-green)';
            text.textContent = 'Connected';
            indicator.style.opacity = '0';
        } else if (connectionStatus === 'degraded') {
            dot.style.background = 'var(--brand-gold)';
            text.textContent = 'Slow Connection';
            indicator.style.opacity = '1';
        } else {
            dot.style.background = '#ef4444';
            text.textContent = 'Offline';
            indicator.style.opacity = '1';
        }
    }

    // Monitor connection health
    setInterval(() => {
        checkConnection();
        updateConnectionUI();
    }, 30000); // Check every 30 seconds

    // --- CHARTS RENDERING ---
    let chartInstances = {};
    
    function renderCharts(data) {
        document.getElementById('charts-section').classList.remove('hidden');
        
        // Destroy existing charts
        Object.values(chartInstances).forEach(chart => chart?.destroy());
        chartInstances = {};
        
        // Revenue Trend Chart (simulated last 30 days)
        const revCtx = document.getElementById('revenueChart')?.getContext('2d');
        if (revCtx) {
            const days = Array.from({length: 30}, (_, i) => `Day ${i+1}`);
            const revenue = Array.from({length: 30}, () => Math.floor(Math.random() * 5000) + 2000);
            
            chartInstances.revenue = new Chart(revCtx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Revenue',
                        data: revenue,
                        borderColor: '#1493FF',
                        backgroundColor: 'rgba(20, 147, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: { 
                            ticks: { color: '#94a3b8', maxRotation: 0 },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // Job Status Pie Chart
        const statusCtx = document.getElementById('jobStatusChart')?.getContext('2d');
        if (statusCtx) {
            chartInstances.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending', 'Assigned'],
                    datasets: [{
                        data: [
                            data.operations?.jobs_completed || 0,
                            data.operations?.jobs_pending || 0,
                            (data.operations?.bottlenecks?.length || 0)
                        ],
                        backgroundColor: ['#22C96F', '#FFC857', '#1493FF'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', padding: 15 }
                        }
                    }
                }
            });
        }
        
        // Capacity Bar Chart
        const capCtx = document.getElementById('capacityChart')?.getContext('2d');
        if (capCtx) {
            const util = data.capacity?.utilization_pct || 0;
            chartInstances.capacity = new Chart(capCtx, {
                type: 'bar',
                data: {
                    labels: ['Current Load', 'Available'],
                    datasets: [{
                        label: 'Capacity %',
                        data: [util, 100 - util],
                        backgroundColor: [util > 80 ? '#FFC857' : '#22C96F', '#334155']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            max: 100,
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    }
                }
            });
        }
        
        // Pricing Tier Pie (BYO vs H2S Premium only)
        const priceCtx = document.getElementById('pricingChart')?.getContext('2d');
        if (priceCtx) {
            chartInstances.pricing = new Chart(priceCtx, {
                type: 'pie',
                data: {
                    labels: ['BYO (Bring Your Own)', 'H2S Premium'],
                    datasets: [{
                        data: [
                            data.pricing?.byo?.jobs || 1,
                            data.pricing?.h2s?.jobs || 1
                        ],
                        backgroundColor: ['#FFC857', '#22C96F']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', padding: 15 }
                        }
                    }
                }
            });
        }
    }

    // --- PAYOUTS MANAGEMENT ---
    async function loadPayouts() {
        const container = document.getElementById('payouts-container');
        const filter = document.getElementById('payout-filter')?.value || 'all';
        
        container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted)">Loading payouts...</div>';
        
        try {
            console.log('[PAYOUTS] Loading from ledger...');
            
            // Fetch payouts and jobs in parallel (removed pros_list - not needed)
            const [payoutsResult, jobsResult] = await Promise.allSettled([
                fetchWithRetry(`${API_BASE}/admin_payouts_overview`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: ADMIN_TOKEN, status: filter === 'all' ? undefined : filter })
                }),
                fetchWithRetry(`${API_BASE}/admin_jobs_list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: ADMIN_TOKEN, status: 'all', days: 90 })
                })
            ]);
            
            // Handle Payouts Response
            let payoutsData = { rows: [] };
            if (payoutsResult.status === 'fulfilled') {
                try {
                    payoutsData = await payoutsResult.value.json();
                    if (!payoutsData.ok) {
                        throw new Error(payoutsData.error || 'Payouts API returned error');
                    }
                } catch (e) {
                    console.error('[PAYOUTS] Failed to parse payouts response:', e);
                    throw new Error('Failed to load payouts ledger');
                }
            } else {
                console.error('[PAYOUTS] Failed to fetch payouts:', payoutsResult.reason);
                throw new Error('Failed to load payouts ledger');
            }
            
            // Handle Jobs Response
            let jobsMap = {};
            if (jobsResult.status === 'fulfilled') {
                try {
                    const jobsData = await jobsResult.value.json();
                    if (jobsData.ok && jobsData.jobs) {
                        jobsData.jobs.forEach(j => {
                            jobsMap[j.job_id] = j;
                            // CACHE: Store in global cache for consistency with Jobs tab
                            jobCache.set(j.job_id, j, 'data');
                        });
                        
                        // DEBUG: Check what data we have for the first job
                        const sampleJob = jobsData.jobs[0];
                        if (sampleJob) {
                            console.log('[PAYOUTS] Sample job data:', {
                                job_id: sampleJob.job_id,
                                customer_name: sampleJob.customer_name,
                                service_address: sampleJob.service_address || sampleJob.address,
                                service_city: sampleJob.service_city || sampleJob.city,
                                metadata_exists: !!sampleJob.metadata,
                                metadata_items: sampleJob.metadata?.items_json?.length || 0
                            });
                        }
                    }
                } catch (e) { 
                    console.warn('[PAYOUTS] Failed to parse jobs data:', e);
                }
            } else {
                console.warn('[PAYOUTS] Failed to load jobs list:', jobsResult.reason);
            }
            
            // SERVICE NAME BUILDER: Extract ALL relevant details from items_json
            const buildServiceDescription = (itemsInput) => {
                let items = itemsInput;
                
                // Parse if string (fixes "Service Order" placeholder issue)
                if (typeof items === 'string') {
                    try {
                        items = JSON.parse(items);
                    } catch (e) {
                        return 'Service Order';
                    }
                }

                if (!items || !Array.isArray(items) || items.length === 0) return 'Service Order';
                
                const descriptions = [];
                
                items.forEach(item => {
                    if (!item || item.type === 'product') return; // Skip product line items (mount hardware)
                    
                    const meta = item.metadata || {};
                    let desc = '';
                    
                    // TV Multi Package
                    if (item.bundle_id === 'tv_multi' || item.service_name === 'tv_multi') {
                        const tvCount = meta.mounts_needed || item.qty || 1;
                        const tvSize = meta.tv_size || '';
                        const sizeText = tvSize ? tvSize.replace('-', '"-') + '"' : '';
                        const mountSource = meta.mount_provider === 'customer' ? 'BYO Mount' : 'H2S Mount';
                        desc = `${tvCount}x ${sizeText} TV Installation (${mountSource})`.trim();
                    }
                    // Security Camera Packages
                    else if (item.bundle_id === 'cam_premium' || item.service_name === 'cam_premium') {
                        desc = 'Premium Security Camera Installation';
                    }
                    else if (item.bundle_id === 'cam_basic' || item.service_name === 'cam_basic') {
                        desc = 'Basic Security Camera Installation';
                    }
                    // Single TV
                    else if (item.bundle_id === 'tv_single' || item.service_name === 'tv_single') {
                        const tvSize = meta.tv_size || '';
                        const sizeText = tvSize ? tvSize.replace('-', '"-') + '"' : '';
                        desc = `${sizeText} TV Mount Installation`.trim();
                    }
                    // Soundbar
                    else if (item.bundle_id === 'soundbar' || item.service_name === 'soundbar') {
                        desc = 'Soundbar Installation';
                    }
                    // Fallback: Clean up the raw name
                    else {
                        const rawName = item.service_name || item.bundle_id || item.service_id || '';
                        desc = rawName.replace(/_/g, ' ').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    }
                    
                    if (desc) descriptions.push(desc);
                });
                
                return descriptions.length > 0 ? descriptions.join(' + ') : 'Service Order';
            };
            
            // Merge data with pro name resolution from job assignments
            const payouts = (payoutsData.rows || []).map(p => {
                // Try to find job in current map, or fallback to global cache
                const job = jobsMap[p.job_id] || jobCache.get(p.job_id, 'data');
                
                // PRO NAME: Use job assignment data (already fetched by admin_jobs_list)
                let proName = job?.assigned_pro_name || job?.metadata?.pro_name || job?.metadata?.technician_name;
                
                // Final fallback
                if (!proName && p.pro_id) {
                    proName = `Technician ${String(p.pro_id).substring(0, 8)}`;
                } else if (!proName) {
                    proName = 'Pending Assignment';
                }
                
                // SERVICE NAME: Build detailed description from items_json
                const serviceName = buildServiceDescription(job?.metadata?.items_json || p.job_metadata?.items_json);
                
                // CUSTOMER NAME: ALWAYS extract from job or order data
                let customerName = job?.customer_name || job?.metadata?.customer_name || job?.customer_email?.split('@')[0] || p.customer_name || p.customer || 'Customer';
                if (customerName && customerName !== 'Customer') {
                    customerName = customerName.split(' ').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                    ).join(' ');
                }
                
                return {
                    payout_id: p.payout_id,
                    job_id: p.job_id,
                    pro_name: proName,
                    pro_id: p.pro_id,
                    amount: Number(p.amount || p.total_amount || 0),
                    state: p.state || 'pending',
                    job_status: job?.status || 'unknown',
                    earned_at: p.created_at || p.earned_at || new Date().toISOString(),
                    job_details: {
                        service: serviceName,
                        customer: customerName,
                        address: job?.address || job?.metadata?.service_address || p.address || p.service_address || '',
                        city: job?.city || job?.metadata?.service_city || p.city || p.service_city || '',
                        state: job?.state || job?.metadata?.service_state || p.service_state || '',
                        zip: job?.zip || job?.metadata?.service_zip || p.zip || p.service_zip || '',
                        line_items: job?.metadata?.items_json || job?.line_items_json || p.job_metadata?.items_json || [],
                        metadata: job?.metadata || p.job_metadata || {}
                    }
                };
            });
            
            // Calculate pro stats for the UI
            const proStats = {};
            payouts.forEach(p => {
                if (!proStats[p.pro_name]) {
                    proStats[p.pro_name] = {
                        total_accepted: 0, 
                        total_completed: 0,
                        total_earnings: 0,
                        pending_earnings: 0,
                        approved_earnings: 0
                    };
                }
                proStats[p.pro_name].total_accepted++; 
                proStats[p.pro_name].total_completed++;
                proStats[p.pro_name].total_earnings += p.amount;
                if (p.state === 'pending') proStats[p.pro_name].pending_earnings += p.amount;
                if (p.state === 'approved') proStats[p.pro_name].approved_earnings += p.amount;
            });
            
            // Attach pro stats
            payouts.forEach(p => {
                p.pro_stats = proStats[p.pro_name];
            });
            
            console.log('[PAYOUTS] Found', payouts.length, 'payouts ready for approval');
            currentPayouts = payouts; // Store globally for modal access
            renderPayouts(payouts, filter);
            
        } catch (err) {
            console.error('[PAYOUTS] Error:', err);
            container.innerHTML = `
                <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; padding:20px; border-radius:8px; text-align:center">
                    <div style="font-size:16px; font-weight:600; margin-bottom:8px">Unable to Load Payouts</div>
                    <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px">${err.message}</div>
                    <button class="btn btn-primary" onclick="loadPayouts()">Retry</button>
                </div>
            `;
        }
    }

    function renderPayouts(payouts, filter) {
        // Filter payouts
        const filtered = filter === 'all' ? payouts : payouts.filter(p => p.state === filter);
        
        // Calculate totals
        const totals = {
            pending: { amount: 0, count: 0 },
            approved: { amount: 0, count: 0 },
            paid: { amount: 0, count: 0 },
            lifetime: 0
        };
        
        payouts.forEach(p => {
            const amt = Number(p.amount) || 0;
            if (p.state === 'pending') {
                totals.pending.amount += amt;
                totals.pending.count++;
            } else if (p.state === 'approved') {
                totals.approved.amount += amt;
                totals.approved.count++;
            } else if (p.state === 'paid') {
                totals.paid.amount += amt;
                totals.paid.count++;
            }
            totals.lifetime += amt;
        });
        
        // Update summary cards
        document.getElementById('total-pending').textContent = `$${totals.pending.amount.toLocaleString()}`;
        document.getElementById('payout-pending-amount').textContent = `$${totals.pending.amount.toLocaleString()}`;
        document.getElementById('payout-pending-count').textContent = `${totals.pending.count} entries`;
        document.getElementById('payout-approved-amount').textContent = `$${totals.approved.amount.toLocaleString()}`;
        document.getElementById('payout-approved-count').textContent = `${totals.approved.count} entries`;
        document.getElementById('payout-paid-amount').textContent = `$${totals.paid.amount.toLocaleString()}`;
        document.getElementById('payout-paid-count').textContent = `${totals.paid.count} entries`;
        document.getElementById('payout-lifetime-amount').textContent = `$${totals.lifetime.toLocaleString()}`;
        
        // Render table
        const container = document.getElementById('payouts-container');
        if (filtered.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted)">No payouts found for this filter</div>';
            return;
        }
        
        container.innerHTML = `
            <div class="metric-card" style="padding:0; overflow:hidden;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:linear-gradient(135deg, rgba(20,147,255,0.08) 0%, rgba(34,201,111,0.08) 100%); border-bottom:2px solid rgba(20,147,255,0.3);">
                            <th style="padding:16px 20px; text-align:left; color:#60a5fa; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">PRO</th>
                            <th style="padding:16px 20px; text-align:left; color:#60a5fa; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">JOB ID</th>
                            <th style="padding:16px 20px; text-align:left; color:#60a5fa; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">SERVICE</th>
                            <th style="padding:16px 20px; text-align:right; color:#60a5fa; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">AMOUNT</th>
                            <th style="padding:16px 20px; text-align:center; color:#60a5fa; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">STATUS</th>
                            <th style="padding:16px 20px; text-align:left; color:#60a5fa; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">DATE</th>
                            <th style="padding:16px 20px; text-align:right; color:#60a5fa; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map((payout, index) => {
                            const isEven = index % 2 === 0;
                            const rowBg = isEven ? 'rgba(15,23,42,0.4)' : 'rgba(15,23,42,0.6)';
                            
                            return `
                            <tr style="background:${rowBg}; border-bottom:1px solid rgba(71,85,105,0.2); transition:all 0.2s ease;" 
                                onmouseenter="this.style.background='rgba(20,147,255,0.08)'; this.style.borderLeftColor='#1493FF';" 
                                onmouseleave="this.style.background='${rowBg}'; this.style.borderLeftColor='transparent';">
                                <td style="padding:16px 20px; border-left:3px solid transparent; transition:all 0.2s ease;">
                                    <div style="color:#f1f5f9; font-weight:600; font-size:15px; margin-bottom:4px;">${payout.pro_name}</div>
                                    <div style="font-size:12px; color:#94a3b8;">
                                        ${payout.pro_stats.total_completed} jobs • $${payout.pro_stats.total_earnings.toLocaleString()}
                                    </div>
                                </td>
                                <td style="padding:16px 20px;">
                                    <code style="font-family:'Monaco', 'Consolas', monospace; font-size:12px; background:rgba(96,165,250,0.15); color:#60a5fa; padding:6px 10px; border-radius:6px; border:1px solid rgba(96,165,250,0.3); font-weight:500;">
                                        ${payout.job_id.substring(0, 8)}
                                    </code>
                                </td>
                                <td style="padding:16px 20px;">
                                    <div style="font-size:14px; color:#f8fafc; font-weight:500; margin-bottom:3px;">${payout.job_details.service}</div>
                                    <div style="font-size:12px; color:#cbd5e1;">${payout.job_details.customer}</div>
                                    ${payout.job_details.city ? `<div style="font-size:11px; color:#64748b; margin-top:2px;">${payout.job_details.city}${payout.job_details.state ? ', ' + payout.job_details.state : ''}</div>` : ''}
                                </td>
                                <td style="padding:16px 20px; text-align:right;">
                                    <div style="color:#22C96F; font-weight:700; font-size:18px;">$${payout.amount.toLocaleString()}</div>
                                </td>
                                <td style="padding:16px 20px; text-align:center;">
                                    <span style="font-size:12px; padding:8px 16px; border-radius:8px; text-transform:uppercase; font-weight:700; letter-spacing:0.5px; display:inline-block;
                                        ${payout.state === 'pending' ? 'background:linear-gradient(135deg, rgba(255,200,87,0.25) 0%, rgba(255,200,87,0.15) 100%); color:#FFC857; border:1px solid rgba(255,200,87,0.4); box-shadow:0 2px 8px rgba(255,200,87,0.15);' : ''}
                                        ${payout.state === 'approved' ? 'background:linear-gradient(135deg, rgba(34,201,111,0.25) 0%, rgba(34,201,111,0.15) 100%); color:#22C96F; border:1px solid rgba(34,201,111,0.4); box-shadow:0 2px 8px rgba(34,201,111,0.15);' : ''}
                                        ${payout.state === 'paid' ? 'background:linear-gradient(135deg, rgba(20,147,255,0.25) 0%, rgba(20,147,255,0.15) 100%); color:#1493FF; border:1px solid rgba(20,147,255,0.4); box-shadow:0 2px 8px rgba(20,147,255,0.15);' : ''}">
                                        ${payout.state}
                                    </span>
                                </td>
                                <td style="padding:16px 20px;">
                                    <div style="font-size:13px; color:#cbd5e1; font-weight:500;">${new Date(payout.earned_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                                </td>
                                <td style="padding:16px 20px; text-align:right;">
                                    <div style="display:flex; gap:8px; justify-content:flex-end;">
                                        ${payout.state === 'pending' ? `
                                            <button class="btn btn-success" style="padding:8px 16px; font-size:13px; font-weight:600; background:linear-gradient(135deg, #22C96F 0%, #1ea05f 100%); border:none; box-shadow:0 4px 12px rgba(34,201,111,0.3);" onclick="approvePayout('${payout.payout_id}')">
                                                Approve
                                            </button>
                                            <button class="btn btn-danger" style="padding:8px 16px; font-size:13px; font-weight:600; background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border:none; box-shadow:0 4px 12px rgba(239,68,68,0.3); color:#ffffff;" onclick="rejectPayout('${payout.payout_id}')">
                                                Reject
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-ghost" style="padding:8px 16px; font-size:13px; font-weight:600; border:1px solid rgba(96,165,250,0.3); color:#60a5fa;" onclick="viewPayoutDetails('${payout.job_id}')">
                                            View Job
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    async function viewPayoutDetails(jobId) {
        console.log('[PAYOUT] Opening job details for:', jobId);
        
        // PRIORITY 1: Check currentPayouts for enriched data (contains address/customer from manual join)
        const payout = currentPayouts.find(p => p.job_id === jobId);
        if (payout && payout.job_details) {
            console.log('[PAYOUT] Found enriched data in payouts list');
            
            // Get cached job to merge with (if any)
            const cachedJob = jobCache.get(jobId, 'data') || {};
            
            // Construct job object from payout details, prioritizing enriched data
            const enrichedJob = {
                ...cachedJob, // Start with cache
                job_id: jobId,
                // Overwrite with enriched fields
                customer_name: payout.job_details.customer,
                service_name: payout.job_details.service,
                formatted_service_name: payout.job_details.service, // Pass explicitly to bypass re-parsing
                address: payout.job_details.address,
                city: payout.job_details.city,
                state: payout.job_details.state,
                zip: payout.job_details.zip,
                // Ensure metadata has the right fields
                metadata: {
                    ...(cachedJob.metadata || {}),
                    ...(payout.job_details.metadata || {}),
                    items_json: payout.job_details.line_items,
                    service_address: payout.job_details.address,
                    service_city: payout.job_details.city,
                    service_state: payout.job_details.state,
                    service_zip: payout.job_details.zip,
                    customer_name: payout.job_details.customer
                }
            };
            
            showJobModal(enrichedJob);
            return;
        }
        
        // CONSISTENCY CHECK: Use jobCache as single source of truth
        let job = jobCache.get(jobId, 'data');
        
        // Fallback 1: Check currentJobs array
        if (!job) {
            job = currentJobs.find(j => j.job_id === jobId);
            if (job) {
                console.log('[PAYOUT] Found in currentJobs, caching...');
                jobCache.set(jobId, job, 'data');
            }
        }
        
        // Fallback 2: Fetch from API if still not found
        if (!job) {
            console.log('[PAYOUT] Job not in cache, fetching from API:', jobId);
            try {
                const res = await fetchWithRetry(`${API_BASE}/admin_jobs_list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: ADMIN_TOKEN, status: 'all', days: 90 })
                });
                
                const data = await res.json();
                if (data.ok && data.jobs) {
                    job = data.jobs.find(j => j.job_id === jobId);
                    if (job) {
                        console.log('[PAYOUT] Fetched and caching job');
                        jobCache.set(jobId, job, 'data');
                    }
                }
            } catch (err) {
                console.error('[PAYOUT] Failed to fetch job:', err);
                alert('Failed to load job details. Please try again.');
                return;
            }
        }
        
        if (job) {
            showJobModal(job);
        } else {
            alert('Job details not found. The job may have been deleted.');
        }
    }

    // Initial Load
    console.log('==================== DASHBOARD INIT ====================');
    console.log('API_BASE:', API_BASE);
    console.log('ADMIN_TOKEN:', ADMIN_TOKEN);
    console.log('=======================================================');
    
    checkConnection().then(() => {
        console.log('Connection check complete. Status:', connectionStatus);
        updateConnectionUI();
        loadMetrics();
    }).catch(err => {
        console.error('Init error:', err);
        document.getElementById('metrics-container').innerHTML = `
            <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; padding:20px; border-radius:8px; text-align:center">
                <div style="font-size:16px; font-weight:600; margin-bottom:8px">Failed to Initialize</div>
                <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px">${err.message}</div>
                <button class="btn btn-primary" onclick="location.reload()">Reload Page</button>
            </div>
        `;
    });

</script>
</body>
</html>
